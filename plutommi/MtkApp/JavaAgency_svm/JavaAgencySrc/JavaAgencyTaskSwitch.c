/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE.
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/
/*******************************************************************************
 * Filename:
 * ---------
 * JavaAgencyTaskSwitch.c
 *
 * Project:
 * --------
 *   MAUI
 *
 * Description:
 * ------------
 *
 * Author:
 * -------
 * -------
 * -------
 * -------
 *
 *==============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *==============================================================================
 *******************************************************************************/

/*************************************************************************
 * Include header files
 *************************************************************************/

/*************************************************************************
 * Include header files
 *************************************************************************/
#ifdef __J2ME__
#include "MMI_include.h"

/*************************************************************************
 * Plutommi include header files
 *************************************************************************/

#include "j2me_custom_option.h"
#include "j2me_trace.h"
#include "jam_msg_handler.h"            /* J2ME_SUPPORT_PAUSE*/
#include "jvm_adaptor.h"
#include "jam_internal.h"
#include "JavaAgencyDef.h"
#include "JavaAgencyProt.h"
#include "CommonScreens.h"              /* DisplayConfirm */
//#include "SimDetectionDef.h"            /* SCR_SIM_INSERTION*/
#include "SettingProfile.h"             /* WARNING_TONE */
#include "IdleAppDef.h"                 /* IDLE_SCREEN_ID */
#include "jam_mvm_manager.h"
#if defined(__COSMOS_MMI_PACKAGE__) && defined(__GADGET_SUPPORT__) && !defined(__VM_CONCURRENCE__)
#include "notificationgprot.h"
#include "MRESrvGProt.h"
#endif
#ifdef __COSMOS_MMI_PACKAGE__
#include "vapp_java_srv.h"
#endif

/*************************************************************************
 * extern function and variable
 *************************************************************************/
static kal_wchar *asking_string_buffer = NULL;
static MMI_BOOL mmi_java_go_to_idle_after_terminated = MMI_FALSE;
MMI_BOOL mmi_java_resume_pending_flag = MMI_FALSE;
extern kal_int32 g_mmi_java_current_selected_vm_id;
MMI_BOOL g_mmi_java_scrn_delete_callback_exe = MMI_FALSE;


/*****************************************************************************
 * FUNCTION
 *  format_asking_string
 * DESCRIPTION
 *  Add mid_name and "?" into string.
 * PARAMETERS
 *  string_id       [IN]        String ID
 * RETURNS
 *
 *****************************************************************************/
static PU8 format_asking_string(U16 string_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_int32 string_len = 0;
    kal_wchar *mid_name = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    string_len = mmi_ucs2strlen(GetString(string_id));
    mid_name = jam_mvm_get_vm_mid_name(g_mmi_java_current_selected_vm_id);
    if (mid_name == NULL)
    {
        mid_name = (kal_wchar*) GetString(STR_SCR_JAVA_CAPTION);
    }
    if (asking_string_buffer != NULL)
    {
        free_ctrl_buffer(asking_string_buffer);
    }
    asking_string_buffer = (kal_wchar*) get_ctrl_buffer((string_len + mmi_ucs2strlen((S8*) mid_name) + 2) << 1);
    mmi_ucs2cpy((S8*) asking_string_buffer, GetString(string_id));
    mmi_ucs2cpy((S8*) (asking_string_buffer + string_len), (S8*) mid_name);
    string_len += mmi_ucs2strlen((S8*) mid_name);
    asking_string_buffer[string_len] = 0;
    return (PU8) asking_string_buffer;
}


/*****************************************************************************
 * FUNCTION
 *  free_asking_string
 * DESCRIPTION
 *  Free the memory of asking string
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void free_asking_string(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (asking_string_buffer != NULL)
    {
        free_ctrl_buffer(asking_string_buffer);
    }
    asking_string_buffer = NULL;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_highlight_handler
 * DESCRIPTION
 *  Handle Function: revoked when selected item changed
 * PARAMETERS
 *  index       [IN]        Index of selected item
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_java_highlight_index;

static void mmi_java_highlight_handler(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_java_highlight_index = index;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_terminate_dialog_exit
 * DESCRIPTION
 *
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_entry_terminate_dialog_exit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    free_asking_string();
}
#ifdef J2ME_SUPPORT_BACKGROUND

/*****************************************************************************
 * FUNCTION
 *  mmi_java_terminate_dialog_yes_hdlr
 * DESCRIPTION
 *  Handler Function:   revoked when select "YES" in "TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_terminate_dialog_without_pause_yes_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_java_highlight_index == 0)  /* minimize */
    {
        jam_enter_minimize_mode(g_mmi_java_current_selected_vm_id,KAL_FALSE);
        g_mmi_java_current_selected_vm_id = -1;
        mmi_frm_group_close(GRP_ID_JAVA_APP);
        #if (MAX_VM_INSTANCE_NUM == 1) 
        mmi_frm_group_close(APP_JAVA);
        #endif /*MAX_VM_INSTANCE_NUM == 1*/
    }
    else
    {
        jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
        g_mmi_java_current_selected_vm_id = -1;
        #if (MAX_VM_INSTANCE_NUM == 1) 
        mmi_java_entry_terminating(MMI_FALSE);
        #endif /*MAX_VM_INSTANCE_NUM == 1*/
    }
    mmi_frm_group_close(GRP_ID_JAVA_TASK_SWITCH);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_terminate_dialog_no_hdlr
 * DESCRIPTION
 *  Handler Function:   revoked when select "NO" in "TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_terminate_dialog_without_pause_no_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_mmi_java_current_selected_vm_id = -1;
    mmi_frm_scrn_close_active_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_terminate_dialog_without_pause_ext
 * DESCRIPTION
 *  The entry function to ask user if they want to terminate/Pause Java
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_terminate_dialog_without_pause_ext(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;
    U8 *icon_items[2];
    U8 *text_items[2];
     /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!mmi_frm_scrn_enter(
        GRP_ID_JAVA_TASK_SWITCH,
        SCR_JAVA_TERMINATE_DIALOG,
        mmi_java_entry_terminate_dialog_exit,
        mmi_java_entry_terminate_dialog_without_pause_ext,
        MMI_FRM_FULL_SCRN))
        {
            return;
        }
    guiBuffer = mmi_frm_scrn_get_gui_buf(GRP_ID_JAVA_TASK_SWITCH,SCR_JAVA_TERMINATE_DIALOG);
    RegisterHighlightHandler(mmi_java_highlight_handler);

    memset(icon_items, 0, sizeof(icon_items));

    text_items[0] = (PU8) GetString(STR_JAVA_MINIMIZE);
    text_items[1] = (PU8) GetString(STR_JAVA_TERMINATE);

    ShowCategory32Screen(
        format_asking_string(STR_JAVA_CHANGE_STATE_TITLE),
        NULL,
        (PU8) GetString(STR_GLOBAL_OK),
        (PU8) GetImage(IMG_GLOBAL_OK),
        (PU8) GetString(STR_GLOBAL_BACK),
        (PU8) GetImage(IMG_GLOBAL_BACK),
        2,
        text_items,
        icon_items,
        0,
        0,
        guiBuffer);
    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetLeftSoftkeyFunction(mmi_java_terminate_dialog_without_pause_yes_hdlr, KEY_EVENT_UP);
    SetCenterSoftkeyFunction(mmi_java_terminate_dialog_without_pause_yes_hdlr, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_java_terminate_dialog_without_pause_no_hdlr, KEY_EVENT_UP);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_terminate_dialog
 * DESCRIPTION
 *  The entry function to ask user if they want to terminate/Pause Java
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_terminate_dialog_without_pause(void)  /* called by JAVA adaptor, also in mmi task */
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_create_ex(
        GRP_ID_ROOT,
        GRP_ID_JAVA_TASK_SWITCH,
        NULL,
        NULL,
        MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_java_entry_terminate_dialog_without_pause_ext();
}
#endif


#if defined(J2ME_SUPPORT_PAUSE) || defined(J2ME_SUPPORT_BACKGROUND)
/*****************************************************************************
 * FUNCTION
 *  mmi_java_terminate_dialog_yes_hdlr
 * DESCRIPTION
 *  Handler Function:   revoked when select "YES" in "TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_terminate_dialog_yes_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef J2ME_SUPPORT_BACKGROUND
#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)

    if(!jvm_util_OP01_is_Keep_Background(g_mmi_java_current_selected_vm_id))
	{
#endif   
        if (mmi_java_highlight_index == 0)  /* minimize */
        {
            jam_enter_minimize_mode(g_mmi_java_current_selected_vm_id,KAL_FALSE);
            g_mmi_java_current_selected_vm_id = -1;
            mmi_frm_group_close(GRP_ID_JAVA_APP);
            #if (MAX_VM_INSTANCE_NUM == 1) 
            mmi_frm_group_close(APP_JAVA);
            #endif /*MAX_VM_INSTANCE_NUM == 1*/           
        }
        else if( mmi_java_highlight_index == 1)   /* pause */
        {
            jam_enter_pause_mode(g_mmi_java_current_selected_vm_id);
            g_mmi_java_current_selected_vm_id = -1;
            mmi_frm_group_close(GRP_ID_JAVA_APP);
            #if (MAX_VM_INSTANCE_NUM == 1)
            mmi_frm_group_close(APP_JAVA);
            #endif /*MAX_VM_INSTANCE_NUM == 1*/ 

        }
        else
        {
            jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
            g_mmi_java_current_selected_vm_id = -1;
            #if (MAX_VM_INSTANCE_NUM == 1)
            mmi_java_entry_terminating(MMI_FALSE);
            #endif /*MAX_VM_INSTANCE_NUM == 1*/
        }
#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)
    }
    else
	{	
        if (mmi_java_highlight_index == 0)  /* minimize */
        {
            jam_enter_minimize_mode(g_mmi_java_current_selected_vm_id,,KAL_FALSE);
            g_mmi_java_current_selected_vm_id = -1;
            mmi_frm_group_close(GRP_ID_JAVA_APP);
            #if (MAX_VM_INSTANCE_NUM == 1) 
            mmi_frm_group_close(APP_JAVA);
            #endif
        }
        else /* terminate */
        {
            jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
            g_mmi_java_current_selected_vm_id =-1;
            mmi_java_entry_terminating(MMI_FALSE);
        }	
    }
#endif          

#else

#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)

    if(!jvm_util_OP01_is_Keep_Background(g_mmi_java_current_selected_vm_id))
	{
#endif   
        if (mmi_java_highlight_index == 0)  /* pause */
        {
            jam_enter_pause_mode(g_mmi_java_current_selected_vm_id);
            g_mmi_java_current_selected_vm_id = -1;
            mmi_frm_group_close(GRP_ID_JAVA_APP);
            #if (MAX_VM_INSTANCE_NUM == 1)
            mmi_frm_group_close(APP_JAVA);
            #endif /*MAX_VM_INSTANCE_NUM == 1*/
        }
        else /* terminate */
        {
            jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
            g_mmi_java_current_selected_vm_id = -1;
            mmi_java_entry_terminating(MMI_FALSE);
        }
#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)
    }
    else
	{	
        jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
        g_mmi_java_current_selected_vm_id = -1;
        mmi_java_entry_terminating(MMI_FALSE);
    }
    
#endif           
#endif
    mmi_frm_group_close(GRP_ID_JAVA_TASK_SWITCH);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_terminate_dialog_no_hdlr
 * DESCRIPTION
 *  Handler Function:   revoked when select "NO" in "TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_terminate_dialog_no_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_mmi_java_current_selected_vm_id = -1;
    mmi_frm_scrn_close_active_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_terminate_dialog_ext
 * DESCRIPTION
 *  The entry function to ask user if they want to terminate/Pause Java
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_terminate_dialog_ext(void)
{   
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;
    U8 *icon_items[3];
    U8 *text_items[3];
    U8 item_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!mmi_frm_scrn_enter(
            GRP_ID_JAVA_TASK_SWITCH,
            SCR_JAVA_TERMINATE_DIALOG,
            mmi_java_entry_terminate_dialog_exit,
            mmi_java_entry_terminate_dialog_ext,
            MMI_FRM_FULL_SCRN))
        {
            return;
        }

    guiBuffer = mmi_frm_scrn_get_gui_buf(GRP_ID_JAVA_TASK_SWITCH, SCR_JAVA_TERMINATE_DIALOG);
    RegisterHighlightHandler(mmi_java_highlight_handler);

    memset(icon_items, 0, sizeof(icon_items));

#ifdef J2ME_SUPPORT_BACKGROUND
    text_items[0] = (PU8) GetString(STR_JAVA_MINIMIZE);

#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)

    if(!jvm_util_OP01_is_Keep_Background(g_mmi_java_current_selected_vm_id))
	{
#endif
		text_items[1] = (PU8) GetString(STR_GLOBAL_PAUSE);
		text_items[2] = (PU8) GetString(STR_JAVA_TERMINATE);
		item_num = 3;

#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)
	}
	else
	{
		text_items[1] = (PU8) GetString(STR_JAVA_TERMINATE);
		item_num = 2;
	}
#endif

    
#else
#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)

    if(!jvm_util_OP01_is_Keep_Background(g_mmi_java_current_selected_vm_id))
	{
#endif
		text_items[0] = (PU8) GetString(STR_GLOBAL_PAUSE);
		text_items[1] = (PU8) GetString(STR_JAVA_TERMINATE);
		item_num = 2;

#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)
	}
	else
	{
		text_items[0] = (PU8) GetString(STR_JAVA_TERMINATE);
		item_num = 1;
	}
#endif

#endif

    ShowCategory32Screen(
        format_asking_string(STR_JAVA_CHANGE_STATE_TITLE),
        NULL,
        (PU8) GetString(STR_GLOBAL_OK),
        (PU8) GetImage(IMG_GLOBAL_OK),
        (PU8) GetString(STR_GLOBAL_BACK),
        (PU8) GetImage(IMG_GLOBAL_BACK),
		item_num,
        text_items,
        icon_items,
        0,
        0,
        guiBuffer);

    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetLeftSoftkeyFunction(mmi_java_terminate_dialog_yes_hdlr, KEY_EVENT_UP);
    SetCenterSoftkeyFunction(mmi_java_terminate_dialog_yes_hdlr, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_java_terminate_dialog_no_hdlr, KEY_EVENT_UP);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_terminate_dialog
 * DESCRIPTION
 *  The entry function to ask user if they want to terminate/Pause Java
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_terminate_dialog(void)  /* called by JAVA adaptor, also in mmi task */
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_create_ex(
        GRP_ID_ROOT,
        GRP_ID_JAVA_TASK_SWITCH,
        NULL,
        NULL,
        MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_java_entry_terminate_dialog_ext();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_resume_dialog_exit
 * DESCRIPTION
 *
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_resume_dialog_exit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    free_asking_string();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_java_resume_dialog_yes_hdlr
 * DESCRIPTION
 *  Handle Function: revoked when select "YES" in "RESUME" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_resume_dialog_yes_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    // TODO: hope we can update wap profile in java task , not in MMI task
    if (mmi_java_highlight_index == 0)  /* resume */
    {
        /*try to update the mids runtime information*/        
        mmi_java_update_mids_runtime_info_req(g_mmi_java_current_selected_vm_id);
        mmi_java_load_setting();
        jam_resume_screen();
        mmi_frm_group_close(GRP_ID_JAVA_TASK_SWITCH);
    }
    else    /* terminate */
    {
        jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
        g_mmi_java_current_selected_vm_id = -1;
        mmi_frm_group_close(GRP_ID_JAVA_TASK_SWITCH);
        #if(MAX_VM_INSTANCE_NUM > 1)       
        if(mmi_frm_group_get_active_id()!= GRP_ID_ROOT)
        #endif /*MAX_VM_INSTANCE_NUM == 1*/ 
        {
            mmi_java_entry_terminating(MMI_FALSE);
        }
    }
}
void mmi_java_resume_dialog_execute_resume(void)
{
    mmi_java_highlight_index = 0;
    mmi_java_resume_dialog_yes_hdlr();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_java_resume_dialog_no_hdlr
 * DESCRIPTION
 *  Handle Function: revoked when select "NO" in "RESUME" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_resume_dialog_no_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_mmi_java_current_selected_vm_id = -1;
    mmi_frm_scrn_close_active_id();
}

void mmi_java_entry_resume_dialog_ext(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;
    U8 *icon_items[2];
    U8 *text_items[2];
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (!mmi_frm_scrn_enter(
        GRP_ID_JAVA_TASK_SWITCH, 
        SCR_JAVA_RESUME_DIALOG, 
        mmi_java_entry_resume_dialog_exit, 
        mmi_java_entry_resume_dialog_ext, 
        MMI_FRM_FULL_SCRN))    
    {   
        return;
    }
    guiBuffer = mmi_frm_scrn_get_gui_buf(GRP_ID_JAVA_TASK_SWITCH, SCR_JAVA_RESUME_DIALOG);
    RegisterHighlightHandler(mmi_java_highlight_handler);

    memset(icon_items, 0, sizeof(icon_items));
    text_items[0] = (PU8) GetString(STR_GLOBAL_RESUME);
    text_items[1] = (PU8) GetString(STR_JAVA_TERMINATE);

    ShowCategory32Screen(
        format_asking_string(STR_JAVA_CHANGE_STATE_TITLE),
        NULL,
        (PU8) GetString(STR_GLOBAL_OK),
        (PU8) GetImage(IMG_GLOBAL_OK),
        (PU8) GetString(STR_GLOBAL_BACK),
        (PU8) GetImage(IMG_GLOBAL_BACK),
        2,
        text_items,
        icon_items,
        0,
        0,
        guiBuffer);
    
    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetLeftSoftkeyFunction(mmi_java_resume_dialog_yes_hdlr, KEY_EVENT_UP);
    SetCenterSoftkeyFunction(mmi_java_resume_dialog_yes_hdlr, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_java_resume_dialog_no_hdlr, KEY_EVENT_UP);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_resume_dialog
 * DESCRIPTION
 *  The entry function to ask if user want to resume Java or terminate java.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_resume_dialog(U32 parent) /* called by MMI */
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_create_ex(
        parent,
        GRP_ID_JAVA_TASK_SWITCH,
        NULL,
        NULL,
        MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_java_entry_resume_dialog_ext();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_force_terminate_dialog_yes_hdlr
 * DESCRIPTION
 *  Handle Function: revoked when select "YES" in "FORCE TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_force_terminate_dialog_yes_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
    g_mmi_java_current_selected_vm_id = -1;

    mmi_java_entry_terminating(MMI_FALSE);

    mmi_frm_group_close(GRP_ID_JAVA_TASK_SWITCH);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_force_terminate_dialog_no_hdlr
 * DESCRIPTION
 *  Handle Function: revoked when select "NO" in "FORCE TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_force_terminate_dialog_no_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_mmi_java_current_selected_vm_id = -1;
    mmi_frm_scrn_close_active_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_force_terminate_dialog_ext
 * DESCRIPTION
 *  The entry function to ask if user real want to terminate java? (can not pause)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_force_terminate_dialog_ext(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!mmi_frm_scrn_enter(
        GRP_ID_JAVA_TASK_SWITCH,
        SCR_JAVA_FORCE_TERMINATE_DIALOG,
        NULL,
        mmi_java_entry_force_terminate_dialog_ext,
        MMI_FRM_FULL_SCRN))
        {
            return;
        }
    guiBuffer = mmi_frm_scrn_get_gui_buf(GRP_ID_JAVA_TASK_SWITCH, SCR_JAVA_FORCE_TERMINATE_DIALOG);
    ShowCategory74Screen(
        STR_JAVA_TERMINATE,
        mmi_java_get_install_title_icon(),
        STR_GLOBAL_YES,
        IMG_GLOBAL_YES,
        STR_GLOBAL_NO,
        IMG_GLOBAL_NO,
        (PU8) GetString(STR_JAVA_FORCE_TERMINATE),
        mmi_ucs2strlen(GetString(STR_JAVA_FORCE_TERMINATE)),
        guiBuffer);
    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetCenterSoftkeyFunction(mmi_java_force_terminate_dialog_yes_hdlr, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_java_force_terminate_dialog_yes_hdlr, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_java_force_terminate_dialog_no_hdlr, KEY_EVENT_UP);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_force_terminate_dialog
 * DESCRIPTION
 *  The entry function to ask if user real want to terminate java? (can not pause)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_force_terminate_dialog(void)    /* called by JAVA adaptor, also in mmi task */
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_create_ex(
        GRP_ID_ROOT,
        GRP_ID_JAVA_TASK_SWITCH,
        NULL,
        NULL,
        MMI_FRM_NODE_SMART_CLOSE_FLAG);
    
    mmi_java_entry_force_terminate_dialog_ext();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_recv_pause_ind
 * DESCRIPTION
 *  The handler to handle MSG_ID_MMI_JAVA_PAUSE_IND
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/

void mmi_java_recv_pause_ind(void *MsgStruct)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_int32 vm_id = 0;
    mmi_java_pause_ind_struct* msg = (mmi_java_pause_ind_struct*)MsgStruct;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    vm_id = msg->vm_id;
    #ifdef __PLUTO_MMI_PACKAGE__
    if (jam_is_own_screen() || jam_mvm_is_minimize_mode(vm_id))
    {
        mmi_frm_group_create_ex(
            GRP_ID_ROOT,
            GRP_ID_JAVA_TASK_SWITCH,
            NULL,
            NULL,
            MMI_FRM_NODE_SMART_CLOSE_FLAG); 
    }
    #endif
    if (jam_mvm_is_minimize_mode(vm_id))
    {
        jam_enter_minimize_mode(vm_id,KAL_TRUE);
    }
    else
    {
        if (jam_vm_canbe_minimize(vm_id))
        {
            if (!mmi_java_need_block_msg())
            {
            #ifdef __PLUTO_MMI_PACKAGE__
                do {
                mmi_confirm_property_struct arg;
                mmi_confirm_property_init(&arg, CNFM_TYPE_USER_DEFINE);
                arg.softkey[0].str = (WCHAR *)((UI_string_type)get_string(STR_GLOBAL_OK));
                arg.callback = (mmi_proc_func)NULL;
                arg.parent_id = GRP_ID_JAVA_TASK_SWITCH;
                mmi_confirm_display_ext(STR_JAVA_MINIMIZE_NOTIFY, MMI_EVENT_QUERY, &arg);
                } while(0);    
                SetLeftSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
                #elif defined (__COSMOS_MMI_PACKAGE__)
            	mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT,
            	                     MMI_EVENT_INFO_BALLOON,
            	                     MMI_NMGR_BALLOON_TYPE_INFO,
            	                     (WCHAR *)((UI_string_type)get_string(STR_JAVA_MINIMIZE_NOTIFY)));                
                #endif
            }

            jam_enter_minimize_mode(vm_id,KAL_TRUE);
            mmi_frm_group_close(GRP_ID_JAVA_APP);
#if (MAX_VM_INSTANCE_NUM == 1) 
            mmi_frm_group_close(APP_JAVA);
#endif /*MAX_VM_INSTANCE_NUM == 1*/
            mmi_frm_scrn_close(APP_JAVA,SCR_JAVA_CATEGORY_SCREEN);
        }
        else if (jam_vm_canbe_paused(vm_id))
        {
            if( !mmi_java_need_block_msg())
            {
             #ifdef __PLUTO_MMI_PACKAGE__
                do {
                mmi_confirm_property_struct arg;
                mmi_confirm_property_init(&arg, CNFM_TYPE_USER_DEFINE);
                arg.softkey[0].str = (WCHAR *)((UI_string_type)get_string(STR_GLOBAL_OK));
                arg.callback = (mmi_proc_func)NULL;
                arg.parent_id = GRP_ID_JAVA_TASK_SWITCH;
                mmi_confirm_display_ext(STR_JAVA_PAUSE_NOTIFY, MMI_EVENT_QUERY, &arg);
                } while(0);    
                SetLeftSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
                #elif defined (__COSMOS_MMI_PACKAGE__)
                vapp_java_display_popup(STR_JAVA_MINIMIZE_NOTIFY,VJAVA_POPUP_QUESTION,VAPP_JAVA_ENTRY_CLOSE_MIDLET_SCREEN);
                #endif
            }

            jam_enter_pause_mode(vm_id);
            mmi_frm_group_close(GRP_ID_JAVA_APP);
#if (MAX_VM_INSTANCE_NUM == 1) 
            mmi_frm_group_close(APP_JAVA);
#endif /*MAX_VM_INSTANCE_NUM == 1*/
            mmi_frm_scrn_close(APP_JAVA,SCR_JAVA_CATEGORY_SCREEN);
        }
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_java_force_resume_dialog_yes_hdlr
 * DESCRIPTION
 *
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_force_resume_dialog_yes_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_java_highlight_index = 0;
    mmi_java_resume_dialog_yes_hdlr();
}
/*****************************************************************************
 * FUNCTION
 *  mmi_java_force_resume_dialog_yes_hdlr
 * DESCRIPTION
 *
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_force_resume_dialog_no_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(g_mmi_java_current_selected_vm_id != -1)
    {
        jam_mvm_set_vm_resume_ind(g_mmi_java_current_selected_vm_id, KAL_FALSE);
        g_mmi_java_current_selected_vm_id = -1;
    }
    mmi_frm_scrn_close_active_id();
}
/*****************************************************************************
 * FUNCTION
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
U8 mmi_java_force_resume_dialog_del_cb(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    if(g_mmi_java_current_selected_vm_id != -1)
    {
        jam_mvm_set_vm_resume_ind(g_mmi_java_current_selected_vm_id, KAL_FALSE);
        g_mmi_java_current_selected_vm_id = -1;
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_force_resume_dialog_int
 * DESCRIPTION
 *  The entry function to ask if user want to resume Java or terminate java.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_force_resume_dialog_int(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;
    U8 *str;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!mmi_frm_scrn_enter(
        GRP_ID_JAVA_TASK_SWITCH,
        SCR_JAVA_RESUME_NOTIFY,
        NULL,
        mmi_java_entry_force_resume_dialog_int,
        MMI_FRM_FULL_SCRN))
        {
            return;
        }
    guiBuffer = mmi_frm_scrn_get_gui_buf(GRP_ID_JAVA_TASK_SWITCH, SCR_JAVA_RESUME_NOTIFY);
    str = (U8*) GetString(STR_JAVA_RESUME_NOTIFY);
    ShowCategory74Screen(
        STR_GLOBAL_RESUME,
        mmi_java_get_install_title_icon(),
        STR_GLOBAL_YES,
        IMG_GLOBAL_YES,
        STR_GLOBAL_NO,
        IMG_GLOBAL_NO,
        (PU8) str,
        mmi_ucs2strlen((PS8) str),
        guiBuffer);
    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetCenterSoftkeyFunction(mmi_java_force_resume_dialog_yes_hdlr, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_java_force_resume_dialog_yes_hdlr, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_java_force_resume_dialog_no_hdlr, KEY_EVENT_UP);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_entry_force_resume_dialog
 * DESCRIPTION
 *  The entry function to ask if user want to resume Java or terminate java.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_force_resume_dialog(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_create_ex(
        GRP_ID_ROOT,
        GRP_ID_JAVA_TASK_SWITCH,
        NULL,
        NULL,
        MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_java_entry_force_resume_dialog_int();
}

extern MMI_BOOL g_mmi_java_is_launching_midlet;
/*****************************************************************************
 * FUNCTION
 *  mmi_java_recv_resume_ind
 * DESCRIPTION
 *  The handler to handle MSG_ID_MMI_JAVA_RESUME_IND
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_recv_resume_ind(void *MsgStruct)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_int32 vm_id = 0;
    mmi_java_resume_ind_struct* msg = (mmi_java_resume_ind_struct*)MsgStruct;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    vm_id = msg->vm_id;
    if (jam_mvm_is_minimize_mode(vm_id) &&
        !jam_mvm_has_fg_running_vm()&&
        mmi_frm_scrn_get_active_id() != SCR_JAVA_RESUME_NOTIFY &&
        jam_mvm_get_vm_state(vm_id) != JVM_TERMINATE_STATE &&
        jam_mvm_get_vm_state(vm_id) != JVM_TERMINATING_STATE &&
        !mmi_java_is_busy() &&
        mmi_java_is_allow_to_popup_screen()&&
        mmi_frm_scrn_get_active_id() !=SCR_JAVA_RESUME_DIALOG
    )
    {
        g_mmi_java_current_selected_vm_id = vm_id;
#ifdef __PLUTO_MMI_PACKAGE__
        mmi_java_entry_force_resume_dialog();
#elif defined (__COSMOS_MMI_PACKAGE__)
if(!vapp_java_is_in_task_manager())
{
    mmi_frm_nmgr_notify_by_app(
            MMI_SCENARIO_ID_DEFAULT, 
            MMI_EVENT_NON_TONE,
            vapp_java_entry_force_resume_dialog_nmgr,
            NULL);
}
#endif
    }
    else
    {
        jam_mvm_set_vm_resume_ind(vm_id,KAL_FALSE);
    }
}

#endif /* J2ME_SUPPORT_PAUSE */ /* #ifdef J2ME_SUPPORT_PAUSE */

/*****************************************************************************
 * FUNCTION
 *  jvm_terminating_time_out_hdlr
 * DESCRIPTION
 *  Check if VM is real terminated
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_terminating_time_out_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    kal_trace(TRACE_GROUP_1, MMI_JAVA_TERMINATEING_TIMEOUT, jam_vm_is_busy());
    /*ClearDelScrnIDCallbackHandler(SCR_JAVA_VM_TERMINATING, NULL);*/
    mmi_java_set_screen_delete_callback_flag(MMI_FALSE);

    if(mmi_java_go_to_idle_after_terminated)
    {
        mmi_java_go_to_idle_after_terminated = MMI_FALSE;
        mmi_idle_display();
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_app_screen_proc
 * DESCRIPTION
 *  Proc function of SCR_JAVA_APP
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_java_app_screen_proc(mmi_event_struct*evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_ret ret = MMI_RET_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_DEINIT:
            if(g_mmi_java_scrn_delete_callback_exe)
                mmi_java_screen_delete_hdlr(NULL);
            break;
        case EVT_ID_WGUI_RSK_CLICK:
            ret = MMI_RET_KEY_HANDLED;
            break;
    }
    kal_trace(JAM_JAVAAGENCY_GROUP, MMI_JAVA_APP_SCREEN_PROC);
    return ret;
}



/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_processing_generic
 * DESCRIPTION
 *  Entry MSG generic processing screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/

U8 mmi_java_screen_delete_hdlr(void *in_param)
{
    kal_int32 vm_id = 0;
    if (!jam_is_in_fg_screen())
    {
#if defined( __COSMOS_MMI_PACKAGE__) && defined(__GADGET_SUPPORT__) && !defined(__VM_CONCURRENCE__)
        if (srv_mre_get_bg_app_num() > 0)
        {
            mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT,
                                 MMI_EVENT_INFO_BALLOON,
                                 MMI_NMGR_BALLOON_TYPE_INFO,
                                 (WCHAR *)GetString(STR_JAVA_FORCE_TERMINATE_BALLOON));
        }
#endif

        jam_delete_screen_notify(vm_id);

        mmi_java_go_to_idle_after_terminated = MMI_TRUE;

#if defined(__OP01__ ) && defined(__IJET_VM__) && defined(J2ME_SUPPORT_BACKGROUND)
    if(jvm_util_OP01_is_Keep_Background(vm_id))
    {
        mmi_java_go_to_idle_after_terminated = MMI_FALSE;		    
        return MMI_FALSE;
    }
#endif 
    }
    else
    {
        EXT_ASSERT(0,0,0,0);
    }
    return MMI_FALSE;
}

/*****************************************************************************
 * FUNCTION
 *  jvm_entry_terminating(void)
 * DESCRIPTION
 *  Entry terminating screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_terminating_internal(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __PLUTO_MMI_PACKAGE__
    mmi_frm_group_create_ex(
        GRP_ID_ROOT,
        GRP_ID_JAVA_BUSY,
        mmi_java_busy_sg_proc,
        NULL,
        MMI_FRM_NODE_SMART_CLOSE_FLAG);
    if(mmi_frm_scrn_enter(
        GRP_ID_JAVA_BUSY, 
        SCR_JAVA_VM_TERMINATING,
        NULL, 
        mmi_java_entry_terminating_internal, 
        MMI_FRM_FULL_SCRN))
    {
       mmi_java_set_screen_delete_callback_flag(MMI_TRUE);
        mmi_frm_scrn_set_leave_proc(GRP_ID_JAVA_BUSY,SCR_JAVA_VM_TERMINATING,mmi_java_app_screen_proc);
    ShowCategory8Screen(
        STR_JAVA_VM_TERMINATING,
        mmi_java_get_install_title_icon(),
        0,
        0,
        0,
        0,
        STR_GLOBAL_PLEASE_WAIT,
        mmi_get_event_based_image(MMI_EVENT_PROGRESS),
        NULL);

    ClearAllKeyHandler();
    ClearKeyHandler(KEY_END, KEY_EVENT_UP);
    ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
    ClearKeyHandler(KEY_END, KEY_LONG_PRESS);
    ClearKeyHandler(KEY_END, KEY_REPEAT);
        }
#endif
}

/*****************************************************************************
 * FUNCTION
 *  jvm_entry_terminating(void)
 * DESCRIPTION
 *  Entry terminating screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_entry_terminating(MMI_BOOL idle)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_java_go_to_idle_after_terminated = idle;
    mmi_java_entry_terminating_internal();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_java_recv_terminate_ind
 * DESCRIPTION
 *  The handler to handle MSG_ID_MMI_JAVA_TERMINATE_IND
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_recv_terminate_ind(void *MsgStruct)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_java_terminate_ind_struct *msg = (mmi_java_terminate_ind_struct *)MsgStruct;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (jam_is_own_screen())
    {
        mmi_java_entry_terminating(MMI_FALSE);
    }
    else
    {
        jam_mvm_set_vm_terminate_ind(msg->vm_id,KAL_FALSE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_recv_terminating_ind
 * DESCRIPTION
 *  The handler to handle MSG_ID_MMI_JAVA_TERMINATE_IND
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_java_recv_terminating_ind(void * MsgStruct) //20110221
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_java_terminate_ind_struct* msg = (mmi_java_terminate_ind_struct*)MsgStruct;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(jam_is_own_java_screen() || jam_is_own_mmi_screen())
    {
        jam_enter_terminating_mode(msg->vm_id);
        mmi_frm_group_close(GRP_ID_JAVA_APP);
    }
}



static U16* cb_terminate_string = NULL;
static mmi_java_terminate_hdlr cb_terminate_hdlr = NULL;
static U8 cb_del_scr_hdlr = 0;
/*****************************************************************************
 * FUNCTION
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_java_terminate_cb(MMI_BOOL is_terminate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(cb_terminate_hdlr)
    {

        (*cb_terminate_hdlr)(is_terminate);
        cb_terminate_hdlr = NULL;
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_java_force_terminate_dialog_yes_hdlr
 * DESCRIPTION
 *  Handle Function: revoked when select "YES" in "FORCE TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_cb_terminate_dialog_yes_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_java_terminate_cb(MMI_TRUE);
    mmi_frm_group_close(GRP_ID_JAVA_TERMINATE_CB);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_java_force_terminate_dialog_no_hdlr
 * DESCRIPTION
 *  Handle Function: revoked when select "NO" in "FORCE TERMINATE" dialog
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_java_cb_terminate_dialog_no_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_java_terminate_cb(MMI_FALSE);
    if (cb_del_scr_hdlr)
    {
         mmi_frm_scrn_set_leave_proc(GRP_ID_JAVA_TERMINATE_CB,SCR_JAVA_TERMINATE_DIALOG2,NULL);
    }
    mmi_frm_group_close(GRP_ID_JAVA_TERMINATE_CB);
}

/*****************************************************************************
 * FUNCTION
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
U8 mmi_java_cb_terminate_dialog_del_cb_hdlr(mmi_event_struct * evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */    
    mmi_java_cb_terminate_dialog_no_hdlr();
    return MMI_FALSE;
}

void mmi_java_entry_cb_terminate_dialog_internal_exit_hdlr(void)
{
    mmi_frm_end_scenario(MMI_SCENARIO_ID_HIGH_SCRN);
}

void mmi_java_entry_cb_terminate_dialog_internal_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(mmi_frm_scrn_enter(GRP_ID_JAVA_TERMINATE_CB,SCR_JAVA_TERMINATE_DIALOG2,NULL,mmi_java_entry_cb_terminate_dialog_internal_entry,MMI_FRM_FULL_SCRN))
    /* Block JPUSH */
    {
        guiBuffer = mmi_frm_scrn_get_gui_buf(GRP_ID_JAVA_TERMINATE_CB,SCR_JAVA_TERMINATE_DIALOG2);
        ShowCategory74Screen(
            STR_SCR_JAVA_CAPTION,
            mmi_java_get_install_title_icon(),
            STR_GLOBAL_YES,
            IMG_GLOBAL_YES,
            STR_GLOBAL_NO,
            IMG_GLOBAL_NO,
            (PU8) cb_terminate_string,
            mmi_ucs2strlen((PS8) cb_terminate_string),
            guiBuffer);

        if (cb_del_scr_hdlr)
        {
            mmi_frm_scrn_set_leave_proc(GRP_ID_JAVA_TERMINATE_CB,SCR_JAVA_TERMINATE_DIALOG2,mmi_java_cb_terminate_dialog_del_cb_hdlr);
        }
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_java_cb_terminate_dialog_yes_hdlr, KEY_EVENT_UP);
        SetLeftSoftkeyFunction(mmi_java_cb_terminate_dialog_yes_hdlr, KEY_EVENT_UP);
        SetRightSoftkeyFunction(mmi_java_cb_terminate_dialog_no_hdlr, KEY_EVENT_UP);
    }
}


/*****************************************************************************
 * FUNCTION
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
void mmi_java_entry_cb_terminate_dialog_internal(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_ID gid = GRP_ID_JAVA_TERMINATE_CB;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //mmi_frm_start_scenario(MMI_SCENARIO_ID_HIGH_SCRN);
    if(!mmi_frm_group_is_present(GRP_ID_JAVA_TERMINATE_CB))
    {
        gid = mmi_frm_group_create_ex(
                    GRP_ID_ROOT,
                    GRP_ID_JAVA_TERMINATE_CB,
                    mmi_java_sg_proc,
                    NULL,
                    MMI_FRM_NODE_SMART_CLOSE_FLAG);
    }
    mmi_java_entry_cb_terminate_dialog_internal_entry();
}


/*****************************************************************************
 * FUNCTION
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
void mmi_java_entry_cb_terminate_dialog(mmi_java_terminate_hdlr fp, U16* str, U8 del_scr_hdlr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    cb_terminate_hdlr = fp;
    cb_terminate_string = str;
    cb_del_scr_hdlr = del_scr_hdlr;
    if (mmi_frm_scrn_get_active_id() == SCR_JAVA_TERMINATE_DIALOG2)
    {
        mmi_frm_scrn_close_active_id();
    }
    mmi_java_entry_cb_terminate_dialog_internal();
}


/*****************************************************************************
 * FUNCTION
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
void mmi_java_set_screen_delete_callback_flag(MMI_BOOL is_exe)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_mmi_java_scrn_delete_callback_exe = is_exe;
}


#endif /* __J2ME__ */ /* #ifdef __J2ME__ */

