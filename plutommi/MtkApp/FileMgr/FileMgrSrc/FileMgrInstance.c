/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE.
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/
/*****************************************************************************
 *
 * Filename:
 * ---------
 *
 *
 * Project:
 * --------
 *  MAUI
 *
 * Description:
 * ------------
 *
 *
 * Author:
 * -------
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#define _FMGR_INTERNAL_SOURCE_C_
/****************************************************************************
* Include Files                                                                
*****************************************************************************/
#include "MMI_features.h"

#if defined (__MMI_FILE_MANAGER__)
#include "FileMgrGProt.h"
#include "FileMgrProt.h"
#include "FileMgrInstance.h"

#include "FileMgrResDef.h"

#include "FileMgrMain.h"
#include "FileMgrService.h"
#include "FileMgrFSData.h"
#include "FileMgrGUI.h"

#ifdef __DRM_SUPPORT__                
#include "RightsMgrGProt.h"
#endif

#include "USBSrvGprot.h"

#include "Conversions.h"
#include "PhoneSetupGprots.h"

#ifdef __MMI_VUI_MEDIAWALL__
#include "MediaWall\vadp_mediawall.h"
#endif /* __MMI_VUI_MEDIAWALL__ */

#include "MMIDataType.h"
#include "kal_general_types.h"
#include "string.h"
#include "MMI_common_app_trc.h"
#include "DebugInitDef_Int.h"
#include "kal_trace.h"
#include "mmi_common_app_trc.h"
#include "kal_public_api.h"
#include "mmi_res_range_def.h"
#include "mmi_frm_scenario_gprot.h"
#include "mmi_frm_mem_gprot.h"
#include "wgui_categories_fmgr.h"
#include "mmi_rp_file_type_def.h"
#include "mmi_rp_app_filemanager_def.h"
#include "fs_errcode.h"
#include "Unicodexdcl.h"
#include "FileMgrSrvGProt.h"
#include "gui_typedef.h"
#include "wgui_include.h"
#include "wgui_categories_util.h"
#include "GlobalResDef.h"
#include "wgui_touch_screen.h"
#include "wgui_categories.h"
#include "mmi_frm_history_gprot.h"
#include "fs_type.h"
#include "GlobalConstants.h"
#include "mmi_frm_input_gprot.h"
#include "mmi_frm_events_gprot.h"
#include "CommonScreensResDef.h"
#include "wgui_categories_list.h"
#include "fs_func.h"
#include "mmi_rp_srv_filemanager_def.h"
#include "FileMgrType.h"
#include "AlertScreen.h"
#include "ScreenRotationGprot.h"
#include "CustDataRes.h"
#include "gui_data_types.h"
#ifdef __MMI_NCENTER_SUPPORT__
#include "vapp_ncenter_gprot.h"
#endif
/****************************************************************************
* Define
*****************************************************************************/

/****************************************************************************
* Global Variable
*****************************************************************************/

extern mmi_fmgr_context_struct* fmgr_p;

extern const mmi_fmgri_instance_callback_table_struct cui_storage_selector_handler_table;
extern const mmi_fmgri_instance_callback_table_struct cui_file_selector_handler_table;
extern const mmi_fmgri_instance_callback_table_struct cui_folder_selector_handler_table;
extern const mmi_fmgri_instance_callback_table_struct cui_folder_browser_handler_table;
#ifdef __FMGR_FILE_OPTION_CUI__
extern const mmi_fmgri_instance_callback_table_struct cui_file_option_handler_table;
#endif
/****************************************************************************
* Static Variable
*****************************************************************************/

const static mmi_fmgri_instance_callback_table_struct* fmgr_instance_type_table[MMI_FMGR_TYPE_NUM] = 
{
    NULL
    ,&mmi_fmgri_main_table
#ifdef __FMGR_STORAGE_SELECTOR_CUI__
    ,&cui_storage_selector_handler_table
#endif
    ,&cui_file_selector_handler_table
    ,&cui_folder_selector_handler_table
    ,&cui_folder_browser_handler_table
#ifdef __FMGR_FILE_OPTION_CUI__
    ,&cui_file_option_handler_table
#endif
#ifdef __DRM_V02__
    ,&mmi_fmgri_serv_archive_table      /* Archive viewer */
#endif /* __DRM_V02__ */
#ifdef __MMI_FMGR_MULTI_SELECT_SUPPORT__
    ,&mmi_fmgri_serv_multi_select_table /* Multi select */
#endif /* __MMI_FMGR_MULTI_SELECT_SUPPORT__ */

};

/****************************************************************************
* Function Forward Declaration
*****************************************************************************/

static mmi_ret fmgr_explorer_group_proc(mmi_event_struct *param);

static void fmgr_general_highlight_hdlr(S32 index);
static MMI_BOOL fmgr_general_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event, U32 data);
static void fmgr_general_register_key_hdlr(mmi_fmgr_instance_struct *instance);
static void fmgr_general_refresh(mmi_fmgr_instance_struct* instance, S32 new_index);

static S32  fmgr_general_find_file_index(mmi_fmgr_instance_struct* instance, S8* filename);

static void fmgr_general_entry_explorer_internel(mmi_fmgr_instance_struct *instance, U8 *guiBuffer, BOOL small_screen);

#define END_OF_FUNCTION_DECLARATION

/****************************************************************************
* Function Body
*****************************************************************************/

void mmi_fmgri_instance_init(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    fmgr_p->instance_num = 0;
    memset(&(fmgr_p->instance_list), 0, sizeof(fmgr_p->instance_list));
#if defined(__DRM_V02__) || defined __MMI_FMGR_MULTI_SELECT_SUPPORT__ 
    fmgr_p->id_mark_counter = 0;
#endif
}

mmi_fmgr_instance_struct* mmi_fmgri_instance_create(mmi_id owner, mmi_fmgri_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgri_instance_notify_creation_struct notify;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* notify created */
    notify.owner = owner;
    notify.type = type;
    mmi_fmgri_instance_notify_all(FMGRI_EVENT_INSTANCE_CREATING, (U32)&notify);
    return mmi_fmgri_instance_create_ex(owner, type);
}

mmi_fmgr_instance_struct* mmi_fmgri_instance_create_ex(mmi_id owner, mmi_fmgri_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
    mmi_id grp_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(fmgr_p->instance_num == MMI_FMGR_INSTANCE_MAX_NUM)
    {
        FMGR_TRACE0(TRC_MMI_FMGR_E01C58A093D94C22AAA53DE8B8272472, "Fmgr > Instance > Create fail, no free slot!\n");
        // no more instance
#if (MMI_FMGR_INSTANCE_MAX_NUM == 1)
        /* if MAX == 1, means re-entry is not suppoted 
         *  Can re-entry not supported in NEW design????
         */
        // TODO: If re-entry is not suppored, maybe we need to remove previous FMGR
        return NULL;
#else
        return NULL;
#endif
    }

    for(i=0; i<MMI_FMGR_INSTANCE_MAX_NUM; i++)
    {
        if(fmgr_p->instance_list[i].id == 0)
        {
            break;
        }
    }

    if(i == MMI_FMGR_INSTANCE_MAX_NUM)
    {
        FMGR_ASSERT(0);  // Instance list & num are out of sync.
        return NULL;
    }
#if defined(__DRM_V02__) || defined __MMI_FMGR_MULTI_SELECT_SUPPORT__ 
    fmgr_p->instance_id_mark[i] = fmgr_p->id_mark_counter+1;
    fmgr_p->id_mark_counter++;
    if(fmgr_p->id_mark_counter == 0)
        fmgr_p->id_mark_counter++;
#endif

    memset(&(fmgr_p->instance_list[i]), 0, sizeof(fmgr_p->instance_list[i]));
    fmgr_p->instance_list[i].id = i+1;
    fmgr_p->instance_list[i].type = type;
    fmgr_p->instance_list[i].app_id = APP_FILEMANAGER;
    fmgr_p->instance_num++;
#if defined(__DRM_V02__) || defined __MMI_FMGR_MULTI_SELECT_SUPPORT__
    FMGR_TRACE3(TRC_MMI_FMGR_715EFB6379E54817B0A39935A997767C, "Fmgr > Instance > Create ok, id=%d(%d), type=%d\n", i+1, fmgr_p->instance_id_mark[i], type);
#else
    FMGR_TRACE3(TRC_MMI_FMGR_715EFB6379E54817B0A39935A997767C, "Fmgr > Instance > Create ok, id=%d(%d), type=%d\n", i+1, 0, type);
#endif
    /* create group here */
    grp_id = mmi_fmgri_instance_get_screen_id((U8)(i+1));
    ASSERT(!mmi_frm_group_is_present(grp_id) && mmi_frm_group_get_active_id() != grp_id);
    
    grp_id = mmi_frm_group_create(owner, grp_id, 
        fmgr_explorer_group_proc, (void*)&(fmgr_p->instance_list[i]));

    /* set caller automatically */
    mmi_frm_group_set_caller(grp_id, owner);

    return &(fmgr_p->instance_list[i]);
}

void mmi_fmgri_instance_release(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(!instance || 
        instance->id == 0 ||
        instance->id > MMI_FMGR_INSTANCE_MAX_NUM ||
        instance != &(fmgr_p->instance_list[instance->id-1]))
    {
        FMGR_ASSERT(0);
    }

    // clean up
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
    if(instance->delay_event)
    {
        OslMfree(instance->delay_event);
        instance->delay_event = NULL;
    }

    if(fmgr_p->search_instance_id == instance->id)
    {
        SET_UCS2STR_EMPTY(fmgr_p->search_filename);
        fmgr_p->search_instance_id = 0;
    }

    FMGR_TRACE2(TRC_MMI_FMGR_B0655D893877438081E6058B30DC76FC, "Fmgr > Instance > Release ok, id=%d, type=%d\n", instance->id, instance->type);
#if defined(__DRM_V02__) || defined __MMI_FMGR_MULTI_SELECT_SUPPORT__
    fmgr_p->instance_id_mark[instance->id-1] = 0;
#endif
    instance->id = 0;
    fmgr_p->instance_num--;
    
}

MMI_BOOL mmi_fmgri_is_instance_id_valid(U8 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((id == 0) || 
        (id > MMI_FMGR_INSTANCE_MAX_NUM) ||
        (fmgr_p->instance_list[id-1].id == 0))
    {
        return MMI_FALSE;
    }
    return MMI_TRUE;
}

MMI_BOOL mmi_fmgri_is_screen_id_valid(U16 screen_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (screen_id < SCR_ID_FMGR_EXPLORER_BASE || screen_id > SCR_ID_FMGR_EXPLORER_END)
    {
        return MMI_FALSE;
    }
    return mmi_fmgri_is_instance_id_valid((U8)(screen_id + 1 - SCR_ID_FMGR_EXPLORER_BASE));
}

static mmi_fmgr_instance_struct* fmgr_get_instance_by_id(S32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    FMGR_ASSERT(mmi_fmgri_is_instance_id_valid((U8)id));
    return &(fmgr_p->instance_list[id-1]);
}

void mmi_fmgri_instance_get_filepath_and_filter(U8 instance_id, S8 **filepath_pp, FMGR_FILTER *filter_p)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = fmgr_get_instance_by_id(instance_id);

    if (filepath_pp)
    {
        *filepath_pp = instance->file_path;
    }

    if (filter_p)
    {
        *filter_p = instance->filter_type;
    }
}

#ifndef __MMI_SLIM_FILE_MANAGER__
U8 mmi_fmgri_instance_get_arrow_type(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_get_instance_by_id(instance_id);
    return instance->arrow_type;
}
#endif
S32  mmi_fmgri_instance_get_cur_index(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    return fmgr_get_instance_by_id(instance_id)->cur_index;
}

BOOL mmi_fmgri_instance_get_title_info(U8 instance_id, U16* string_id, U16* icon_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Default value */
    if (string_id)
    {
        *string_id = 0;
    }

    if (icon_id)
    {
        *icon_id = 0;
    }

    instance = fmgr_get_instance_by_id(instance_id);

    /* Use (app_id) setting */
    mmi_fmgr_get_app_title_info(instance->app_id, string_id, icon_id, instance->file_path);

    /* Use (special) setting */
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    if (instance->flag & FMGR_IFLAG_CUSTOM_ROOT)
    {
        mmi_fmgr_get_app_title_info(APP_MYFAVORITE, string_id, icon_id, instance->file_path);
    }
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */

#ifdef FMGR_TAB_SUPPORT
    if (instance->tab_id && string_id)
    {
        *string_id = mmi_fmgri_table_tab_get_title(instance->tab_id, 
        mmi_fmgri_table_tab_get_index(instance->tab_id, (WCHAR*)instance->file_path));
    }
#endif /* FMGR_TAB_SUPPORT */

    /* Use (instance) setting */
    if (string_id && instance->title_str_id)
    {
        *string_id = instance->title_str_id;
    }

    if (icon_id && instance->title_icon_id)
    {
        *icon_id = instance->title_icon_id;
    }

    /* Final default value */
    if (string_id && *string_id == 0)
    {
        *string_id = STR_FMGR_TITLE;
    }    

    return MMI_FALSE;
}

U16  mmi_fmgri_instance_get_list_style(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_get_instance_by_id(instance_id);

    return instance->display_type;
}

U16  mmi_fmgri_instance_get_screen_id(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    return SCR_ID_FMGR_EXPLORER_BASE + instance_id-1;
}

#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__
S32  mmi_fmgri_instance_get_display_str(U8 instance_id, S8 *display_str_buff, S32 buff_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;
    S8* filename;
    S32 len;
    FMGR_FILE_INFO_STRUCT   file_info;
    S8                      do_chset;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = mmi_fmgri_get_instance_by_id(instance_id);

    display_str_buff[0] = display_str_buff[1] = 0;

    /* hardcode: Only FMGR has display string */
    if(instance->type != MMI_FMGR_TYPE_APP)
        return FS_INVALID_FILENAME;
    
    if(mmi_ucs2strlen(instance->file_path)==3)
    {
        srv_fmgr_drv_get_name(instance->file_path[0], (WCHAR*)display_str_buff, (U8)buff_len);
    }
    else
    {
        filename = (S8*)srv_fmgr_path_get_filename_ptr((WCHAR*)instance->file_path);
        if(filename)
        {
            /* check if this is short name */
            do_chset = FALSE;
            len = mmi_ucs2strlen(filename);
            if(len <= 12)
            {
                mmi_fmgr_get_file_info_by_path(instance->file_path, &file_info);
                if(file_info.is_short)
                    do_chset = TRUE;
            }

            if(do_chset)
            {
                memset(display_str_buff, 0, buff_len * ENCODING_LENGTH);
                mmi_chset_mixed_text_to_ucs2_str(
                    (U8*) display_str_buff,
                    (S16)((buff_len - 1) * ENCODING_LENGTH),
                    (U8*) filename,
                    (mmi_chset_enum)PhnsetGetDefEncodingType());                
            }
            else
            {
                mmi_ucs2ncpy(display_str_buff, filename, (U32)buff_len);
            }
            
            len = mmi_ucs2strlen(display_str_buff) - 1;
            if(display_str_buff[len*ENCODING_LENGTH] == '\\' &&
                display_str_buff[len*ENCODING_LENGTH+1] == 0)
            {
                display_str_buff[len*ENCODING_LENGTH] = 0;
            }
        }        
        else
            return FS_INVALID_FILENAME;
    }
    
    return FS_NO_ERROR;
}
#endif  /* __MMI_ULTRA_SLIM_FILE_MANAGER__ */
#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__
MMI_BOOL mmi_fmgri_instance_accept_empty_folder()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    return MMI_TRUE;
}
#endif
U8 mmi_fmgri_get_active_instance_id(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    i = mmi_fmgri_get_active_instance();
    if (i)
    {
        return i->id;
    }
    return 0;
}

mmi_fmgr_instance_struct* mmi_fmgri_get_active_instance(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id grp_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    grp_id = mmi_frm_group_get_active_id();
    FMGR_ASSERT(mmi_fmgri_is_screen_id_valid(grp_id));
    
    return (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(grp_id);
}

mmi_fmgr_instance_struct* mmi_fmgri_get_instance_by_id(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_get_instance_by_id(instance_id);
}


#if defined(__DRM_V02__) || defined __MMI_FMGR_MULTI_SELECT_SUPPORT__
U32 mmi_fmgri_instance_get_export_id(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    FMGR_ASSERT(fmgr_p->instance_id_mark[instance->id-1]);

    return ((U32)fmgr_p->instance_id_mark[instance->id-1] << 8) | (U32)instance->id;
}

//mick todo
mmi_fmgr_instance_struct* mmi_fmgri_instance_get_instance_by_export_id(U32 exported_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 id, mark;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    id = exported_id & 0xFF;
    mark = (exported_id >> 8) & 0xFFFF;
    if (mmi_fmgri_is_instance_id_valid((U8)id) && mark == fmgr_p->instance_id_mark[id-1])
    {
        return fmgr_get_instance_by_id(id);
    }
    return NULL;
}
#endif     /* #if defined(__DRM_V02__) || defined __MMI_FMGR_MULTI_SELECT_SUPPORT__ */


#ifdef __FMGR_HYPERLINK_SUPPORT__
S32  mmi_fmgri_instance_get_hyperlink_count(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S32 count;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (instance_id == 0)
    {
        return 0;
    }

    instance = fmgr_get_instance_by_id(instance_id);

    if ((fmgr_instance_type_table[instance->type]) &&
        (fmgr_instance_type_table[instance->type]->hyperlink_cb) &&
        (fmgr_instance_type_table[instance->type]->hyperlink_cb(instance, FMGR_HYPERLINK_GET_COUNT, 0, &count)))
    {
        return count;
    }
    else
    {
        return 0;
    }
}

MMI_BOOL mmi_fmgri_instance_get_hyperlink_info(U8 instance_id, S32 index, mmi_fmgr_hyperlink_info_struct* info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (instance_id == 0)
    {
        return MMI_FALSE;
    }

    instance = fmgr_get_instance_by_id(instance_id);

    if ((fmgr_instance_type_table[instance->type]) &&
        (fmgr_instance_type_table[instance->type]->hyperlink_cb) &&
        (fmgr_instance_type_table[instance->type]->hyperlink_cb(instance, FMGR_HYPERLINK_GET_INFO, index, (S32*)info)))
    {
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}

void mmi_fmgri_instance_prepare_hyperlink(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(instance_id == 0)
        return;
    instance = fmgr_get_instance_by_id(instance_id);

    if(fmgr_instance_type_table[instance->type] &&
        fmgr_instance_type_table[instance->type]->hyperlink_cb)
    {
        fmgr_instance_type_table[instance->type]->hyperlink_cb(instance, FMGR_HYPERLINK_PREPARE, 0, NULL);
    }

}
#endif

mmi_ret mmi_fmgr_notify_hdlr(mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgri_instance_notify_app_info_struct app_notify;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (param->evt_id == EVT_ID_SRV_FMGR_NOTIFICATION_ADV_ACTION)
    {
        app_notify.notify_flag = param->evt_id;
        app_notify.notify_data = param;
        if (!mmi_fmgri_instance_notify_all(FMGRI_EVENT_APP_NOTIFY, (U32)&app_notify))
        {
            return MMI_RET_ERR;
        }
    }
    else if (param->evt_id == EVT_ID_SRV_FMGR_NOTIFICATION_DEV_PLUG_OUT)
    {
        mmi_fmgri_instance_notify_all(FMGRI_EVENT_DRIVE_UNMOUNT, (U32)param);
    }
    else if (param->evt_id == EVT_ID_SRV_FMGR_NOTIFICATION_DEV_PLUG_IN)
    {
        mmi_fmgri_instance_notify_all(FMGRI_EVENT_DRIVE_MOUNT, (U32)param);
    }

    return MMI_RET_OK;
}

MMI_BOOL mmi_fmgri_instance_notify_all(mmi_fmgri_instance_notify_event_enum event, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
    MMI_BOOL b_ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    b_ret = MMI_TRUE;
    for (i = 0; i < MMI_FMGR_INSTANCE_MAX_NUM; i++)
    {
        if (fmgr_p->instance_list[i].id)
        {
            if (fmgr_general_notify_event_hdlr(&(fmgr_p->instance_list[i]), (S32)event, data) == MMI_FALSE)
            {
                b_ret = MMI_FALSE;
            }
        }
    }
    return b_ret;
}

extern MMI_BOOL mmi_fmgri_instance_execute_command(U8 instance_id, S32 cmd, S32 para, void* data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct    *instance;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = mmi_fmgri_get_instance_by_id(instance_id);

    if (fmgr_instance_type_table[instance->type] &&
        fmgr_instance_type_table[instance->type]->cust_cmd_cb)
    {
        return (MMI_BOOL)fmgr_instance_type_table[instance->type]->cust_cmd_cb(instance, cmd, para, data);
    }
    return MMI_FALSE;
}

#define GENERAL_API

static void fmgr_general_highlight_hdlr(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id grp_id;    
    mmi_fmgr_instance_struct    *instance;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* First we need to know which instance we are at. */
    grp_id = mmi_frm_group_get_active_id();
    if (mmi_fmgri_is_screen_id_valid(grp_id))
    {
        instance = mmi_fmgri_get_active_instance();

        /* Change current index */
        instance->cur_index = index;

        if(fmgr_instance_type_table[instance->type] &&
            fmgr_instance_type_table[instance->type]->highlight_cb)
        {
            fmgr_instance_type_table[instance->type]->highlight_cb(instance, index);
        }
#ifndef __MMI_WGUI_DISABLE_CSK__
#ifdef __FMGR_KEY_RULE__
        if (!(instance->key_binding & MMI_FMGRI_KEY_CSK) &&
            !get_softkey_label(MMI_CENTER_SOFTKEY) &&
            !get_softkey_icon(MMI_CENTER_SOFTKEY) &&
            get_softkey_label(MMI_LEFT_SOFTKEY))
        {
            ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        }
#endif /* __FMGR_KEY_RULE__ */
#endif

        /* Re-register keys */
        fmgr_general_register_key_hdlr(instance);
    }
}

static void fmgr_general_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event, S32 param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 translated_event;
    mmi_ret result;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    translated_event = event;
    
    switch(event)
    {
#ifdef __MMI_TOUCH_SCREEN__
    case FMGRI_EVENT_TOUCH_CLICK:
        if(instance->key_binding & MMI_FMGRI_KEY_TOUCH) /* no translate */
            break;
        
#ifdef __FMGR_FTE_MENU_INTERACT_SUPPORT__
        if(param == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
            translated_event = FMGRI_EVENT_DEF_CMD;
        else
            return;
#else
        translated_event = FMGRI_EVENT_LSK;
#endif
        break;
#endif

    case FMGRI_EVENT_CSK:
        if(instance->key_binding & MMI_FMGRI_KEY_CSK)   /* no translate */
            break;

#ifdef __FMGR_KEY_RULE__
        translated_event = FMGRI_EVENT_DEF_CMD;
#else
        translated_event = FMGRI_EVENT_LSK;
#endif
        break;
    }
    
    switch(translated_event)
    {
    case FMGRI_EVENT_LSK:
    case FMGRI_EVENT_LEFT_ARROW:
        /* if LSK has no label, means the keys is auto-disabled */
        if(!get_softkey_label(MMI_LEFT_SOFTKEY))
        {
            return;
        }
        break;
    }

    FMGR_TRACE2(TRC_MMI_FMGR_BF071504A65643039188C76B4FF45EE8, "Fmgr > General > Key > id=%d, ev=0x%08X\n", instance->id, translated_event);
    
    if(fmgr_instance_type_table[instance->type] &&
        fmgr_instance_type_table[instance->type]->key_event_cb)
    {
        FMGR_PERF_START(fmgr_general_key_event_hdlr, translated_event);
        result = fmgr_instance_type_table[instance->type]->key_event_cb(instance, translated_event);
        FMGR_PERF_END(fmgr_general_key_event_hdlr);

#ifdef __FMGR_FTE_MENU_INTERACT_SUPPORT__
        if( result != MMI_RET_OK && 
            event == FMGRI_EVENT_TOUCH_CLICK && 
            translated_event == FMGRI_EVENT_DEF_CMD && 
            wgui_category_if_pop_option_menu())
        {
            /* special case, for FTE intuitive cmd is disabled, display options instead */
            fmgr_general_key_event_hdlr(instance, FMGRI_EVENT_LSK, 0);
        }
#endif        
#ifdef __FMGR_KEY_RULE__
        if (result != MMI_RET_OK && 
            event == FMGRI_EVENT_CSK && 
            translated_event == FMGRI_EVENT_DEF_CMD)
        {
            fmgr_general_key_event_hdlr(instance, FMGRI_EVENT_LSK, 0);
        }
#endif
    }
    
}

static MMI_BOOL fmgr_general_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	MMI_BOOL									end_is_slash = MMI_FALSE;
    mmi_fmgri_instance_notify_app_info_struct   *app_notify;
    srv_fmgr_notification_adv_action_event_struct *srv_fmgr_event;
    srv_fmgr_notification_action_enum           action;
    const S8                                    *path;
    S32                                         pathlen;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    FMGR_TRACE3(TRC_MMI_FMGR_1AD330868A114A5D8B608F66C9F7A6A3, 
        "Fmgr > General > Notify > id=%d, ev=0x%08X, data=%d\n", instance->id, event, data);

    switch (event)
    {
        case FMGRI_EVENT_SCREEN_DELETING:
            /* The API will be phased out by FW team, so to remove it here */
            break;

        case FMGRI_EVENT_APP_NOTIFY:
            /* MMI_FMGR_NOTIFY_PRE_MOVE and MMI_FMGR_NOTIFY_PRE_DELETE are removed */
#if 0            
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif            
            app_notify = (mmi_fmgri_instance_notify_app_info_struct*)data;
            if (app_notify->notify_flag == EVT_ID_SRV_FMGR_NOTIFICATION_ADV_ACTION)
            {
                srv_fmgr_event = (srv_fmgr_notification_adv_action_event_struct*)app_notify->notify_data;
                action = srv_fmgr_event->action;                
                if (srv_fmgr_event->state == SRV_FMGR_NOTIFICATION_STATE_QUERY &&
                    action != SRV_FMGR_NOTIFICATION_ACTION_COPY &&
                    action != SRV_FMGR_NOTIFICATION_ACTION_CREATE_FOLDER)
                {
                    path = (const S8*)srv_fmgr_event->src_filepath;
                    pathlen = mmi_ucs2strlen(path);
                    if ((path[(pathlen-1)*ENCODING_LENGTH] == '\\') &&
                        (path[(pathlen-1)*ENCODING_LENGTH+1] == 0))
                    {
						end_is_slash = MMI_TRUE;
                        pathlen--;
                    }

                    if (action == SRV_FMGR_NOTIFICATION_ACTION_DELETE_ALL)
                    {
                        if ((mmi_ucs2ncmp(instance->file_path, path, pathlen) == 0) &&
                            (instance->file_path[pathlen*ENCODING_LENGTH] == '\\') &&
                            (instance->file_path[pathlen*ENCODING_LENGTH+1] == 0))
                        {
                            if (end_is_slash)
							{
								pathlen++;
								end_is_slash = MMI_FALSE;
							}
							
                            if (mmi_ucs2strlen(instance->file_path) > pathlen)
                            {
                                return MMI_FALSE;
                            }
                        }
                    }
                    else
                    {
                        S8* buffer = mmi_fmgri_get_and_lock_buffer();
                        S8* buffer2 = mmi_fmgri_get_and_lock_buffer(); 
                        mmi_ucs2ncpy(buffer, instance->file_path, SRV_FMGR_PATH_MAX_LEN + 1);
                        mmi_ucs2lwr(buffer);
                        mmi_ucs2ncpy(buffer2, path, SRV_FMGR_PATH_MAX_LEN + 1);
                        mmi_ucs2lwr(buffer2);
                        if ((mmi_ucs2ncmp(buffer, buffer2, pathlen) == 0) &&
                            (instance->file_path[pathlen*ENCODING_LENGTH] == '\\') &&
                            (instance->file_path[pathlen*ENCODING_LENGTH+1] == 0))
                        {
                            mmi_fmgri_free_and_unlock_buffer(buffer);
                            mmi_fmgri_free_and_unlock_buffer(buffer2);
                            return MMI_FALSE;
                        }

                        mmi_fmgri_free_and_unlock_buffer(buffer);
                        mmi_fmgri_free_and_unlock_buffer(buffer2);
#if defined (__MMI_FMGR_FOLDER_COPY_SUPPORT__)
                        /* If user would like to delete a folder which user selected to copy/move */
                        if (instance->type == MMI_FMGR_TYPE_APP
#ifdef __MMI_FMGR_MULTI_SELECT_SUPPORT__
							|| instance->type == MMI_FMGR_TYPE_SEL_FILE_MUlTI
#endif
							)
                        {
                            if (!mmi_fmgri_main_can_modify_folder(instance, path))
                            {
                                return MMI_FALSE;
                            }
                        }
#endif                        
                    }
                }
            }
            break;
    }
    
    if ((fmgr_instance_type_table[instance->type]) &&
        (fmgr_instance_type_table[instance->type]->notify_event_cb))
    {
        fmgr_instance_type_table[instance->type]->notify_event_cb(instance, event, data);
    }

    switch (event)
    {
        case FMGRI_EVENT_SCREEN_DELETING:
            /* Cancel sorting */
            mmi_fmgri_fsdata_instance_release_load(instance->id);
            /* Free instance */
            mmi_fmgri_instance_release(instance);
            break;
    }

    return MMI_TRUE;
}


static BOOL fmgr_general_error_handler(mmi_fmgr_instance_struct *instance, S32 error)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    FMGR_TRACE2(TRC_MMI_FMGR_5C377CEA4AAD41D793471C0965495ADC, "Fmgr > General > Error > id=%d, err=%d\n", instance->id, error);

    if(fmgr_instance_type_table[instance->type] &&
        fmgr_instance_type_table[instance->type]->error_cb)
    {
        return fmgr_instance_type_table[instance->type]->error_cb(instance, error);
    }
    
    return TRUE;
}

static void fmgr_general_lsk_hdlr(void)         { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_LSK, 0); }
static void fmgr_general_rsk_hdlr(void)         { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_RSK, 0); }
#ifndef __FMGR_KEY_RULE__    
static void fmgr_general_right_key_hdlr(void)   { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_RIGHT_ARROW, 0); }
static void fmgr_general_left_key_hdlr(void)    { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_LEFT_ARROW, 0); }
#endif
#ifdef __MMI_TOUCH_SCREEN__
#ifdef __MMI_FTE_SUPPORT__
static void fmgr_general_tap_hdlr(mmi_tap_type_enum tap_type,S32 index)       { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_TOUCH_CLICK, tap_type); }
#else
static void fmgr_general_click_hdlr(void)       { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_TOUCH_CLICK, 0); }
#endif
#endif
static void fmgr_general_csk_hdlr(void)         { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_CSK, 0); }
static void fmgr_general_send_key_hdlr(void)    { fmgr_general_key_event_hdlr(mmi_fmgri_get_active_instance(), FMGRI_EVENT_SEND_KEY, 0); }

static void fmgr_general_register_key_hdlr(mmi_fmgr_instance_struct *instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifndef __FMGR_KEY_RULE__ 
    U8  key_binding;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    SetLeftSoftkeyFunction(fmgr_general_lsk_hdlr, KEY_EVENT_UP);
    SetRightSoftkeyFunction(fmgr_general_rsk_hdlr, KEY_EVENT_UP);

#ifdef __MMI_TOUCH_SCREEN__
#ifdef __MMI_FTE_SUPPORT__
    wgui_register_tap_callback(fmgr_general_tap_hdlr);
#else
    wgui_register_list_item_selected_callback(fmgr_general_click_hdlr);
#endif
#endif

#ifndef __FMGR_KEY_RULE__    
#ifdef FMGR_TAB_SUPPORT
    if(!instance->tab_id)
#endif
    {
        key_binding = mmi_fmgri_gui_query_display_type_key(instance->display_type);
        if(!(key_binding & CAT213_ARROW_LEFT))
            SetKeyHandler(fmgr_general_left_key_hdlr, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
        if(!(key_binding & CAT213_ARROW_RIGHT))
            SetKeyHandler(fmgr_general_right_key_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    }
#endif

#ifdef __FMGR_KEY_RULE__    
    SetCenterSoftkeyFunction(fmgr_general_csk_hdlr, KEY_EVENT_UP);
    register_center_softkey_to_enter_key();
#else
    if(instance->key_binding & MMI_FMGRI_KEY_CSK)
    {
        SetKeyHandler(fmgr_general_csk_hdlr, KEY_ENTER, KEY_EVENT_UP);
        if(get_softkey_label(MMI_CENTER_SOFTKEY) || get_softkey_icon(MMI_CENTER_SOFTKEY))
        {
            SetCenterSoftkeyFunction(fmgr_general_csk_hdlr, KEY_EVENT_UP);
            register_center_softkey_to_enter_key();
        }
    }
    else
    {
        ClearKeyHandler(KEY_ENTER, KEY_EVENT_UP);
        ClearKeyHandler(KEY_ENTER, KEY_EVENT_DOWN);
    }
#endif    

    if(instance->key_binding & MMI_FMGRI_KEY_SEND)
    {
        SetKeyDownHandler(fmgr_general_send_key_hdlr, KEY_SEND);
    }
}

static S32 fmgr_async_load_rsp_callback(U8 instance_id, S32 result, S32 search_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = mmi_fmgri_get_instance_by_id(instance_id);

    if (mmi_frm_group_get_active_id() != mmi_fmgri_instance_get_screen_id(instance->id))
    {
        if(result <= 0)
        {
            mmi_fmgri_fsdata_instance_release_load(instance->id);
        }
        return 0;
    }

    if(result < 0)
    {
        /* Error case */
#ifdef FMGR_TAB_SUPPORT
		if (result == FS_FILE_NOT_FOUND)
		{
			mmi_fmgri_fsdata_instance_release_load(instance->id);
            mmi_fmgri_fsdata_instance_load_empty_data(instance->id);
            mmi_fmgri_instance_general_refresh(instance);
		}
		else
#endif
        if(fmgr_general_error_handler(instance, result))
        {
            mmi_fmgri_fsdata_instance_release_load(instance->id);
            mmi_fmgri_fsdata_instance_load_empty_data(instance->id);
            mmi_fmgri_instance_general_refresh(instance);
        }
        return 0;
    }

    /* Enter real explorer */
    if (search_index != -1)
    {
        fmgr_general_refresh(instance, search_index);
    }
    else
    {
        mmi_fmgri_instance_general_refresh(instance);
    }
    return 0;

}

static S32 fmgr_async_load_progress_callback(U8 instance_id, S32 total_count, S32 progress_count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = mmi_fmgri_get_instance_by_id(instance_id);

    if (mmi_frm_group_get_active_id() != mmi_fmgri_instance_get_screen_id(instance->id))
    {
        return 0;
    }

    /* Update progress bar */
    mmi_fmgri_gui_update_progress(instance->id, (U32)progress_count, (U32)total_count);

    return 0;
}

static void fmgr_async_load_cancel_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    fmgr_general_error_handler(mmi_fmgri_get_active_instance(), MMI_FMGR_ERROR_LOADING_CANCEL);
    
    /* Stop repeatedly cancel case */
    ClearKeyEvents();
}

static void fmgr_general_refresh(mmi_fmgr_instance_struct* instance, S32 new_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    FMGR_TRACE3(TRC_MMI_FMGR_F3C49440FE8D4257AA68EDAF99823BEC, "Fmgr > General > Refresh > id=%d, new_idx=%d, path=<%S>\n",
        instance->id, new_index, instance->file_path);
    
    if (new_index >= 0)
    {
        instance->dirty_level |= FMGRI_DIRTY_CHANGE_INDEX;
        instance->cur_index = new_index;
    }
    else if (new_index == FMGRI_INSTANCE_INDEX_TO_FIRST_POS)
    {
        instance->dirty_level |= (FMGRI_DIRTY_CHANGE_INDEX | FMGRI_DIRTY_RESET_TO_FIRST_INDEX);
        instance->cur_index = 0;
    }

    if (mmi_frm_group_get_active_id() == mmi_fmgri_instance_get_screen_id(instance->id) &&
        mmi_frm_scrn_get_active_id() == mmi_fmgri_instance_get_screen_id(instance->id))
    {
        mmi_frm_scrn_enter(mmi_fmgri_instance_get_screen_id(instance->id), SCR_ID_FMGR_GENERAL_DUMMY, NULL, (FuncPtr)mmi_frm_display_dummy_screen_ex, MMI_FRM_FG_ONLY_SCRN);
        mmi_frm_scrn_close(mmi_fmgri_instance_get_screen_id(instance->id), SCR_ID_FMGR_GENERAL_DUMMY);
    }
}

static mmi_ret fmgr_explorer_group_proc(mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;
    mmi_ret result;
    mmi_event_struct* delay_event;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = (mmi_fmgr_instance_struct*)param->user_data;

    if (fmgr_instance_type_table[instance->type] &&
        fmgr_instance_type_table[instance->type]->event_proc_cb)
    {
        result = fmgr_instance_type_table[instance->type]->event_proc_cb(instance, param);
        if (result != MMI_RET_OK)
        {
            return result;
        }
    }
    
    switch (param->evt_id)
    {
        case EVT_ID_GROUP_ACTIVE:
            break;
        case EVT_ID_GROUP_INACTIVE:
            FMGR_TRACE1(TRC_MMI_FMGR_90DC41707E094229959ABFA55404ABB1, "Fmgr > General > Explorer (%d) > Exit + Add history\n", instance->id);
            break;
        case EVT_ID_GROUP_DEINIT:
            fmgr_general_notify_event_hdlr(instance, FMGRI_EVENT_SCREEN_DELETING, 0);
            break;

        /* Popup handler */
        case EVT_ID_POPUP_QUIT:
            if (instance->flag & FMGR_IFLAG_WAIT_POPUP)
            {
                instance->flag &= ~FMGR_IFLAG_WAIT_POPUP;

                /* Post and clear delayed event */
                if (instance->delay_event)
                {
                    delay_event = instance->delay_event;
                    instance->delay_event = NULL;

                    mmi_frm_group_send_to_caller(mmi_fmgri_instance_get_screen_id(instance->id), 
                        (mmi_group_event_struct*)delay_event);

                    /* Instance may be free after send event */
                    OslMfree(delay_event);
                }
            }
            break;
    #ifdef __MMI_NCENTER_SUPPORT__
        case EVT_ID_VAPP_NCENTER_DRAG:
    	  {
              MMI_ASSERT(instance != NULL);
    	      if (instance->is_disable_ncenter)
    	      {
    	      	 return MMI_RET_ERR;
    	      }
    	  }
		  break;
    #endif
    }

    return MMI_RET_OK;
}

#ifdef FMGR_TAB_SUPPORT

static void fmgr_tab_page_exit(mmi_scrn_essential_struct* scr_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    FMGR_ASSERT(mmi_fmgri_is_screen_id_valid(scr_info->group_id));

    instance = mmi_frm_group_get_user_data(scr_info->group_id);

    if (instance)
    {
        fmgr_general_notify_event_hdlr(instance, FMGRI_EVENT_SCREEN_EXIT, 0);
    }
}

static void fmgr_tab_page_entry(mmi_scrn_essential_struct* scr_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S32 curr_tab_index, new_tab_index;
    S32 fs_ret;
    S8  *buffer;
    BOOL small_screen_flag;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    FMGR_TRACE3(TRC_MMI_FMGR_COMMON_3,
        "[MMIFMGR] > %d > %d > %d\n", __LINE__, scr_info->group_id, scr_info->scrn_id);

    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(scr_info->group_id);
    new_tab_index = (S32)scr_info->scrn_id - SCR_ID_FMGR_TAB_BASE;

    FMGR_ASSERT(instance->tab_id);

    curr_tab_index = mmi_fmgri_table_tab_get_index(instance->tab_id, (WCHAR*)instance->file_path);

    if (curr_tab_index != new_tab_index)
    {
        buffer = mmi_fmgri_get_and_lock_buffer();
        mmi_fmgri_table_tab_get_path(instance->tab_id, new_tab_index, (WCHAR*)buffer, (SRV_FMGR_PATH_MAX_LEN + 1) * ENCODING_LENGTH);
        fs_ret = srv_fmgr_fs_create_folder((const WCHAR*)buffer);   
        
        mmi_fmgri_instance_general_update_path(instance, buffer);
        mmi_fmgri_free_and_unlock_buffer(buffer);
        mmi_fmgri_fsdata_instance_release_load(instance->id);
        mmi_fmgri_instance_general_refresh(instance);
        
    }
    else
    {
        small_screen_flag = (BOOL)mmi_is_redrawing_bk_screens();
    
        mmi_frm_scrn_enter(scr_info->group_id, (mmi_id)(SCR_ID_FMGR_TAB_BASE + new_tab_index), 
            (FuncPtr)fmgr_tab_page_exit, (FuncPtr)fmgr_tab_page_entry, MMI_FRM_TAB_PAGE);

        SetKeyHandler(mmi_frm_general_tab_l_arrow_key_hdlr, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
        SetKeyHandler(mmi_frm_general_tab_r_arrow_key_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
        
        fmgr_general_entry_explorer_internel(instance, 
            mmi_frm_scrn_tab_page_get_active_gui_buf(),
            small_screen_flag);
    }
}
#endif

static void fmgr_general_exit_explorer(mmi_scrn_essential_struct* info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(info->group_id);
    fmgr_general_notify_event_hdlr(instance, FMGRI_EVENT_SCREEN_EXIT, 0);
}

static void fmgr_general_entry_explorer(mmi_scrn_essential_struct* info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    U16 explorer_id;
    BOOL small_screen_flag;
#ifdef FMGR_TAB_SUPPORT
    mmi_frm_tab_struct *tab_ptr;
    mmi_frm_tab_struct tab_pages_info[FMGR_MAX_TAB_COUNT];
    S32 i, tab_count;
#endif /* FMGR_TAB_SUPPORT */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    FMGR_PERF_START(fmgr_general_entry_explorer, 0);

    /* First we need to know which instance we focus now */
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(info->group_id);
	
    explorer_id = info->group_id;
    
    FMGR_TRACE2(TRC_MMI_FMGR_9840D8A9CCD24E5F8CE0AE0F24482CF7, "Fmgr > General > Explorer (%d) > Entry path<%S>\n", instance->id, instance->file_path);

    small_screen_flag = (BOOL)mmi_is_redrawing_bk_screens();

#ifdef FMGR_TAB_SUPPORT
    if (instance->tab_id)
    {
        tab_count = mmi_fmgri_table_tab_get_count(instance->tab_id);

        FMGR_ASSERT(tab_count <= FMGR_MAX_TAB_COUNT);

        for (i = 0; i < tab_count; i++)
        {
            tab_ptr = &tab_pages_info[i];
            tab_ptr->screen_id = SCR_ID_FMGR_TAB_BASE + i;
            tab_ptr->tab_entry_func = (FuncPtr)fmgr_tab_page_entry;
            tab_ptr->tab_icon = get_image(mmi_fmgri_table_tab_get_icon(instance->tab_id, i));
            tab_ptr->tab_string = NULL;
        }

        i = mmi_fmgri_table_tab_get_index(instance->tab_id, (WCHAR*)instance->file_path);

        mmi_frm_scrn_tab_change_page_items(explorer_id, explorer_id, tab_pages_info, (U8)tab_count);

        FMGR_TRACE3(TRC_MMI_FMGR_COMMON_3, "[MMIFMGR] > %d > %d > %d\n", __LINE__, explorer_id, i);

        mmi_frm_scrn_tab_enter(explorer_id, explorer_id, NULL, (FuncPtr)fmgr_general_entry_explorer, tab_pages_info, (U8)tab_count, (U8)i);

        FMGR_TRACE3(TRC_MMI_FMGR_COMMON_3, "[MMIFMGR] > %d > %d > %d\n", __LINE__, explorer_id, i);

        return;
    }
    else
#endif /* FMGR_TAB_SUPPORT */
    {
        /* Entry screen */
        if(!mmi_frm_scrn_enter(explorer_id, explorer_id, (FuncPtr)fmgr_general_exit_explorer, (FuncPtr)fmgr_general_entry_explorer, MMI_FRM_UNKNOW_SCRN))
        {			              
            return;
        }

        fmgr_general_entry_explorer_internel(instance, mmi_frm_scrn_get_active_gui_buf(), small_screen_flag);
    }

}

static void fmgr_general_entry_explorer_internel(mmi_fmgr_instance_struct *instance, U8 *guiBuffer, BOOL small_screen)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result, idx;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Dead, act as dummy */
    if (instance->flag & FMGR_IFLAG_DEAD)
    {
        FMGR_TRACE2(TRC_MMI_FMGR_5C377CEA4AAD41D793471C0965495ADC, 
            "Fmgr > General > Error > id=%d, err=%d\n", instance->id, __LINE__);
        return;
    }

    /* Highlight handler */
    RegisterHighlightHandler(fmgr_general_highlight_hdlr);

#ifdef __USB_IN_NORMAL_MODE__
    /* Check is in mass storage mode */
    if (srv_usb_is_in_mass_storage_mode())
    {
        if (!fmgr_general_error_handler(instance, MMI_FMGR_ERROR_USB_MODE))
        {
            FMGR_PERF_END(fmgr_general_entry_explorer);
            return;
        }
    }
#endif /* __USB_IN_NORMAL_MODE__ */

#ifdef __FMGR_HYPERLINK_SUPPORT__
    /* Prepare hyperlink data */
    mmi_fmgri_instance_prepare_hyperlink(instance->id);
#endif /* __FMGR_HYPERLINK_SUPPORT__ */

    /* Reload data */
    result = mmi_fmgri_fsdata_instance_load_data_async(instance->id,
        fmgr_async_load_rsp_callback,
        fmgr_async_load_progress_callback,
        (fmgr_p->search_instance_id == instance->id && 
        (fmgr_p->search_filename[0]||fmgr_p->search_filename[1])) ? fmgr_p->search_filename : NULL);

    /* Reset search */
    if (fmgr_p->search_instance_id == instance->id)
    {
        if (result > 0 && !CHECK_UCS2STR_EMPTY(fmgr_p->search_filename))
        {
            idx = fmgr_general_find_file_index(instance, fmgr_p->search_filename);
            if (idx >= 0)
            {
                instance->cur_index = idx;
                guiBuffer = NULL;
            }
        }
        
        SET_UCS2STR_EMPTY(fmgr_p->search_filename);
        fmgr_p->search_instance_id = 0;
    }

    if (result == SRV_FMGR_FILELIST_ERROR_FILE_NOT_READY)
    {
        /* Show please wait screen */
        mmi_fmgri_gui_display_progress(instance->id, guiBuffer);
    #ifdef FMGR_TAB_SUPPORT
        if (instance->tab_id)
        {
            ClearKeyHandler(KEY_LEFT_ARROW, KEY_EVENT_DOWN);
            ClearKeyHandler(KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
        }
    #endif /* FMGR_TAB_SUPPORT */
        SetRightSoftkeyFunction(fmgr_async_load_cancel_hdlr, KEY_EVENT_UP);
        FMGR_PERF_END(fmgr_general_entry_explorer);
        return;
    }
    else if (result < 0)
    {
        /* FS error */
        if (!fmgr_general_error_handler(instance, result))
        {
            FMGR_PERF_END(fmgr_general_entry_explorer);
            return;
        }
        result = 0;
    }
    else if (result == 0)
    {
        /* Empty case */
        if (!fmgr_general_error_handler(instance, MMI_FMGR_ERROR_EMPTY))
        {
            FMGR_PERF_END(fmgr_general_entry_explorer);
            return;
        }
    }

    /* Double check current index */
    if (result > 0)
    {
        if (instance->cur_index >= result)   /* Out of range */
        {
            instance->cur_index = result - 1;
            guiBuffer = NULL;
        }
        else if (instance->cur_index < 0)   /* No highlight */
        {
            instance->cur_index = 0;
            guiBuffer = NULL;
        }
    }
    else
    {
        instance->cur_index = -1;           /* Empty */
        guiBuffer = NULL;
    }

    if (instance->dirty_level & FMGRI_DIRTY_RESET_TO_FIRST_INDEX)
    {
        if (instance->cur_index == 0)
        {
        #ifdef __FMGR_HYPERLINK_SUPPORT__
            if (instance->type == MMI_FMGR_TYPE_APP)
            {
                /* Shift hyperlink count */
                instance->cur_index = mmi_fmgri_instance_get_hyperlink_count(instance->id);
                if (instance->cur_index >= result)
                {
                    instance->cur_index = 0;
                }
            }
        #endif /* __FMGR_HYPERLINK_SUPPORT__ */
        }
        instance->dirty_level &= ~FMGRI_DIRTY_RESET_TO_FIRST_INDEX;
    }

    /* GUI init */
    mmi_fmgri_gui_init();
    
    /* Notify screen entry */
    fmgr_general_notify_event_hdlr(instance, FMGRI_EVENT_SCREEN_ENTRY, result);

    /* Reset guiBuffer if necessary */
    if(instance->dirty_level & FMGRI_DIRTY_CHANGE_INDEX)
    {
        guiBuffer = NULL;
        instance->dirty_level &= ~FMGRI_DIRTY_CHANGE_INDEX;
    }

    /* ShowCategory */
    mmi_fmgri_gui_display_list(instance->id, result, guiBuffer);

    /* Empty case */
    if (result == 0)
    {
        fmgr_general_highlight_hdlr(-1);
    }

    /* Key event handler */
    fmgr_general_register_key_hdlr(instance);
    FMGR_PERF_END(fmgr_general_entry_explorer);
}

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#ifdef __MMI_SHOW_FILE_EXT__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#else
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
/* under construction !*/
/* under construction !*/
#endif

static S32 fmgr_general_find_file_index(mmi_fmgr_instance_struct* instance, S8* filename)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 index;
    SRV_FMGR_DRVLIST_HANDLE drvlist_hdl;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
    {
    #ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
        if (instance->flag & FMGR_IFLAG_CUSTOM_ROOT)
        {
            index = mmi_fmgri_table_cr_get_index((U16*)filename,
                    (S8)(instance->type == MMI_FMGR_TYPE_APP ? MMI_FALSE : MMI_TRUE),
                    MMI_TRUE, instance->drv_type);
            if (index >= 0)
            {
                return index;
            }
        }
    #endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */

        drvlist_hdl = srv_fmgr_drivelist_create((srv_fmgr_drivelist_type_enum)instance->drv_type);
        index = srv_fmgr_drivelist_get_index_by_drv_letter(drvlist_hdl, (U8)filename[0]);
        srv_fmgr_drivelist_destroy(drvlist_hdl);

        if (index != -1)
        {
            return index;
        }
    }

    return FMGRI_INSTANCE_INDEX_NOT_CHANGE; /* Not found */
}

#define EXPORT_API

void mmi_fmgri_instance_general_entry_explorer(mmi_fmgr_instance_struct* instance, S8* default_highlight_filename)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 explorer_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_frm_group_enter(mmi_fmgri_instance_get_screen_id(instance->id), MMI_FRM_NODE_SMART_CLOSE_FLAG);

    /* Special display type */
    if(instance->display_type == FMGRI_DISPLAY_TYPE_NO_LIST)
    {
        return;
    }
	
    if(default_highlight_filename)
    {
        mmi_fmgri_instance_general_set_search_filename(instance, default_highlight_filename);
    }

    explorer_id = mmi_fmgri_instance_get_screen_id(instance->id);

    mmi_frm_scrn_first_enter(explorer_id, explorer_id, (FuncPtr)fmgr_general_entry_explorer, (void*)instance->id);
}

MMI_BOOL mmi_fmgri_instance_general_enter_folder(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 old_index;
    FMGR_FILE_INFO_STRUCT file_info;
    S32 length;
    fmgr_drive_info_struct *drv_info;
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    S32 fs_ret;
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */
#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__    
    FMGR_FILTER filter;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    old_index = instance->cur_index;
    length = mmi_ucs2strlen(instance->file_path);
    
    /* retrieve current file information */
    mmi_fmgri_fsdata_instance_get_file_info(instance->id, old_index, &file_info);
    
    if (mmi_ucs2cmp((S8*)SRV_FMGR_PATH_ROOT, instance->file_path) == 0)
    {
        drv_info = (fmgr_drive_info_struct*)&file_info;

    #ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
        if (drv_info->drv_type == FMGR_LINK_FOLDER)
        {
            fs_ret = srv_fmgr_fs_create_folder((WCHAR *)drv_info->drv_path);
            if (fs_ret < 0 && (FS_GetDevStatus(drv_info->drv_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR))
            {
                FMGR_DisplayPopup(srv_fmgr_fs_error_get_string(fs_ret), MMI_EVENT_FAILURE);
                return MMI_FALSE;
            }
        }
    #endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */

        mmi_ucs2cpy(instance->file_path, (S8*)drv_info->drv_path);
    #ifdef FMGR_TAB_SUPPORT
        instance->tab_id = drv_info->tab_id;
    #endif /* FMGR_TAB_SUPPORT */
#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__ 
        /* If it is empty folder, back to root */
        FMGR_FILTER_INIT(&filter);
        FMGR_FILTER_SET_ALL(&filter);
        if ((mmi_fmgri_instance_accept_empty_folder() == MMI_FALSE)
            && (srv_fmgr_fs_path_is_not_empty((WCHAR *)instance->file_path, &filter) == 0)
        #ifdef __FMGR_HYPERLINK_SUPPORT__
            && (mmi_fmgri_instance_get_hyperlink_count(instance->id) == 0)
        #endif /* __FMGR_HYPERLINK_SUPPORT__ */
            )
        {
            FMGR2_DisplayPopup(instance, STR_GLOBAL_EMPTY, MMI_EVENT_FAILURE);
            mmi_ucs2cpy(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT);
        #ifdef FMGR_TAB_SUPPORT
            instance->tab_id = 0;
        #endif /* FMGR_TAB_SUPPORT */
            return MMI_FALSE;
        }
#endif
    }
    else
    {
        /* Folder changed, prepare for new path */
        if (mmi_fmgri_filepath_compose((S8*)instance->file_path,
                (SRV_FMGR_PATH_MAX_LEN + 1),
                (S8*)instance->file_path,
                &file_info,
                MMI_TRUE) == MMI_FALSE)
        {
            FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
            return MMI_FALSE;
        }
#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__         
        /* If it is empty folder, back to upper level */
        FMGR_FILTER_INIT(&filter);
        FMGR_FILTER_SET_ALL(&filter);
        if ((srv_fmgr_fs_path_is_not_empty((WCHAR *)instance->file_path, &filter) == 0) &&
        #ifdef __FMGR_HYPERLINK_SUPPORT__
            (mmi_fmgri_instance_get_hyperlink_count(instance->id) == 0) &&
        #endif /* __FMGR_HYPERLINK_SUPPORT__ */
            (mmi_fmgri_instance_accept_empty_folder() == MMI_FALSE))
        {
            FMGR2_DisplayPopup(instance, STR_GLOBAL_EMPTY, MMI_EVENT_FAILURE);
            mmi_fmgri_filepath_go_up_level(instance->file_path);
            return MMI_FALSE;
        }
#endif  
    }
    
    FMGR_TRACE3(TRC_MMI_FMGR_0FA1B539B9E34AACAE21B7004CC090AB,
        "[MMIFMGR] > Instance > Enter folder > old_len=%d, new_len=%d, old_index=%d\n", length, mmi_ucs2strlen(instance->file_path), old_index);

    /* Release fsdata */
    mmi_fmgri_fsdata_instance_release_load(instance->id);
    
    /* Refresh screen */
    fmgr_general_refresh(instance, FMGRI_INSTANCE_INDEX_TO_FIRST_POS);
    return MMI_TRUE;
}

MMI_BOOL mmi_fmgri_instance_general_leave_folder(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 new_index, length;
    S8  *ptr;
    U16 *filename; 
    MMI_BOOL ret = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Retrieve current file information */
    new_index = FMGRI_INSTANCE_INDEX_NOT_CHANGE;
    filename = NULL;

#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    if (instance->flag & FMGR_IFLAG_CUSTOM_ROOT)
    {
    #ifdef FMGR_TAB_SUPPORT
        if (instance->tab_id)
        {
            new_index = mmi_fmgri_table_tab_get_root_index(instance->tab_id,
                            (WCHAR*)instance->file_path,
                            instance->drv_type,
                            (S8)(instance->type == MMI_FMGR_TYPE_APP ? MMI_FALSE : MMI_TRUE),
                            MMI_TRUE);
            if (new_index < 0)
            {
                new_index = FMGRI_INSTANCE_INDEX_NOT_CHANGE;
            }
        }
    #endif /* FMGR_TAB_SUPPORT */

        if (new_index == FMGRI_INSTANCE_INDEX_NOT_CHANGE)
        {
            new_index = mmi_fmgri_table_cr_get_index((U16*)instance->file_path,
                            (S8)(instance->type == MMI_FMGR_TYPE_APP ? MMI_FALSE : MMI_TRUE),
                            MMI_TRUE, instance->drv_type);
            if (new_index < 0)
            {
                new_index = FMGRI_INSTANCE_INDEX_NOT_CHANGE;
            }
        }
        
        if (new_index != FMGRI_INSTANCE_INDEX_NOT_CHANGE)
        {
            /* Found, back to root */
            length = mmi_ucs2strlen(instance->file_path);
            mmi_fmgri_instance_general_update_path(instance, (S8*)SRV_FMGR_PATH_ROOT);

            FMGR_TRACE3(TRC_MMI_FMGR_FCC22F0274674271A80A65DA1140B08B,
                "[MMIFMGR] > Instance > Leave folder > old_len=%d, new_len=%d, new_index=%d\n", length, mmi_ucs2strlen(instance->file_path), new_index);

            mmi_fmgri_fsdata_instance_release_load(instance->id);
            fmgr_general_refresh(instance, new_index);
            return MMI_TRUE;
        }
    }
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */

    /* Store the file_name to query later */
    ptr = (S8 *)srv_fmgr_path_get_filename_ptr((WCHAR *)instance->file_path);
    if (!ptr)
    {
        ptr = instance->file_path;
    }

    length = mmi_ucs2strlen(ptr);
    filename = OslMalloc((length + 1) * ENCODING_LENGTH);
    mmi_ucs2cpy((S8*)filename, ptr);

    /* Remove slash */
    srv_fmgr_path_remove_slash(filename);

    length = mmi_ucs2strlen(instance->file_path);

    if (mmi_fmgri_filepath_go_up_level(instance->file_path))
    {
        new_index = fmgr_general_find_file_index(instance, (S8*)filename);

        /* Still cannot find, we have to find it when loading */
        if (new_index == FMGRI_INSTANCE_INDEX_NOT_CHANGE)
        {
            mmi_fmgri_instance_general_set_search_filename(instance, (S8*)filename);
            new_index = FMGRI_INSTANCE_INDEX_TO_FIRST_POS;
        }
        
        FMGR_TRACE3(TRC_MMI_FMGR_FCC22F0274674271A80A65DA1140B08B,
            "[MMIFMGR] > Instance > Leave folder > old_len=%d, new_len=%d, new_index=%d\n", length, mmi_ucs2strlen(instance->file_path), new_index);

        /* Release fsdata */
        mmi_fmgri_fsdata_instance_release_load(instance->id);
        
        /* Refresh screen */
        fmgr_general_refresh(instance, new_index);
        ret = MMI_TRUE;
        
    }
    else
    {
        FMGR_TRACE3(TRC_MMI_FMGR_FCC22F0274674271A80A65DA1140B08B,
            "[MMIFMGR] > Instance > Leave folder > old_len=%d, new_len=%d, new_index=%d\n", length, mmi_ucs2strlen(instance->file_path), new_index);
    }

    /* Free memory */
    OslMfree(filename);
    return ret;
}

void mmi_fmgri_instance_general_update_path(mmi_fmgr_instance_struct* instance, const S8* new_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef FMGR_TAB_SUPPORT
    if(mmi_ucs2cmp(new_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
    {
        instance->tab_id = 0;
    }
#endif /* FMGR_TAB_SUPPORT */

    mmi_ucs2ncpy(instance->file_path, new_path, SRV_FMGR_PATH_MAX_LEN);
    mmi_fmgri_instance_general_reset_index(instance);
}

void mmi_fmgri_instance_general_back_to_root(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 index, new_index;
    SRV_FMGR_DRVLIST_HANDLE drvlist_hdl;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
    {
        return;
    }

    new_index = FMGRI_INSTANCE_INDEX_NOT_CHANGE;

#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    if (instance->flag & FMGR_IFLAG_CUSTOM_ROOT)
    {
    #ifdef FMGR_TAB_SUPPORT
        if(instance->tab_id)
        {
            new_index = mmi_fmgri_table_tab_get_root_index(instance->tab_id, 
                                    (WCHAR*)instance->file_path,
                                    instance->drv_type,
                                    (S8)(instance->type == MMI_FMGR_TYPE_APP ? MMI_FALSE : MMI_TRUE),
                                    MMI_TRUE);
            if (new_index < 0)
            {
                new_index = FMGRI_INSTANCE_INDEX_NOT_CHANGE;
            }
        }
    #endif /* FMGR_TAB_SUPPORT */
        if (new_index == FMGRI_INSTANCE_INDEX_NOT_CHANGE)
        {
            new_index = mmi_fmgri_table_cr_get_index((U16*)instance->file_path,
                                    (S8)(instance->type == MMI_FMGR_TYPE_APP ? MMI_FALSE : MMI_TRUE),
                                    MMI_FALSE, instance->drv_type);
            if(new_index < 0)
            {
                new_index = FMGRI_INSTANCE_INDEX_NOT_CHANGE;
            }
        }
    }
    else
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */
    {
        drvlist_hdl = srv_fmgr_drivelist_create((srv_fmgr_drivelist_type_enum)instance->drv_type);
        index = srv_fmgr_drivelist_get_index_by_drv_letter(drvlist_hdl, (U8)instance->file_path[0]);
        srv_fmgr_drivelist_destroy(drvlist_hdl);

        if (index != -1)
        {
            new_index = index;
        }
    }

#ifdef FMGR_TAB_SUPPORT
    instance->tab_id = 0;
#endif /* FMGR_TAB_SUPPORT */
    mmi_ucs2cpy(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT);
    fmgr_general_refresh(instance, new_index);

}

void mmi_fmgri_instance_general_reset_index(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Move selection to first */
    instance->cur_index = 0;
    instance->dirty_level |= (FMGRI_DIRTY_CHANGE_INDEX | FMGRI_DIRTY_RESET_TO_FIRST_INDEX);
}

void mmi_fmgri_instance_general_refresh(mmi_fmgr_instance_struct* instance)
{
    fmgr_general_refresh(instance, FMGRI_INSTANCE_INDEX_NOT_CHANGE);
}

void mmi_fmgri_instance_general_refresh_by_id(U8 instance_id, S32 index)
{
    if(mmi_fmgri_is_instance_id_valid(instance_id))
    {
        fmgr_general_refresh(mmi_fmgri_get_instance_by_id(instance_id), index);
    }
}

S32 mmi_fmgri_instance_general_option_handler(U16 opt_menu_id, U16 menu_id, U32 data, U16 keyCode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;
    FMGR_FILE_INFO_STRUCT file_info;
    mmi_fmgr_filetype_enum file_type;
    S8 *buffer;
    S32 fwd_menu_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (menu_id == 0)
    {
        return -1;
    }

    instance = mmi_fmgri_get_instance_by_id((U8)data);
    mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &file_info);

    switch (menu_id)
    {
        case MENU_ID_FMGR_GEN_OPTION_FORWARD_USE:
        case MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND:
            buffer = mmi_fmgri_get_and_lock_buffer();
            if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1),
                      instance->file_path, &file_info, MMI_FALSE))
            {
                FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
                mmi_fmgri_free_and_unlock_buffer(buffer);
                break;
            }

            file_type = srv_fmgr_types_get_main_type(&file_info.file_type);

            if (menu_id == MENU_ID_FMGR_GEN_OPTION_FORWARD_USE)
            {
                fwd_menu_id = srv_fmgr_types_get_use_option_menu(file_type, (WCHAR*)buffer);
            }
            else
            {
                fwd_menu_id = srv_fmgr_types_get_send_option_menu(file_type, (WCHAR*)buffer);
            }

            mmi_fmgri_free_and_unlock_buffer(buffer);
        
            if (fwd_menu_id == 0)
            {
                FMGR2_DisplayPopup(instance, STR_ID_FMGR_NO_FORWARD_OPTION, MMI_EVENT_FAILURE);
                break;
            }
            else if (fwd_menu_id < 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fwd_menu_id), MMI_EVENT_FAILURE);
                break;
            }
            return fwd_menu_id;
	
        case MENU_ID_FMGR_GEN_OPTION_DETAIL:
            mmi_fmgri_main_detail(instance);
            mmi_fmgri_close_option(opt_menu_id, instance->id);
            break;
        case MENU_ID_FMGR_GEN_OPTION_RENAME:
            mmi_fmgri_main_rename(instance);
            mmi_fmgri_close_option(opt_menu_id, instance->id);
            break;
        case MENU_ID_FMGR_GEN_OPTION_DELETE:
            mmi_fmgri_main_delete_single(instance);            
            mmi_fmgri_close_option(opt_menu_id, instance->id);
            break;
#ifndef __MMI_SLIM_FILE_MANAGER__
        case MENU_ID_FMGR_GEN_OPTION_DELETE_ALL:
            mmi_fmgri_main_delete_all(instance);
            mmi_fmgri_close_option(opt_menu_id, instance->id);
            break;
#endif
        case MENU_ID_FMGR_GEN_OPTION_COPY:
            mmi_fmgri_main_copy(instance);
            mmi_fmgri_close_option(opt_menu_id, instance->id);
            break;
        case MENU_ID_FMGR_GEN_OPTION_MOVE:
            mmi_fmgri_main_move(instance);
            mmi_fmgri_close_option(opt_menu_id, instance->id);
            break;
    #ifdef __FS_SORT_SUPPORT__
        case MENU_ID_FMGR_GEN_OPTION_SORT:
            break;
    #endif /* __FS_SORT_SUPPORT__ */
	#if 0
    #ifdef __MMI_FMGR_MULTI_SELECT_SUPPORT__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
    #endif /* __MMI_FMGR_MULTI_SELECT_SUPPORT__ */
	#endif
    default:
        return -1;
    }

    return 0;
}

void mmi_fmgri_instance_general_set_search_filename(mmi_fmgr_instance_struct* instance, S8* search_name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 len;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Multi search may cause highlight wrong, but not fatal */
    if ((fmgr_p->search_instance_id) && (fmgr_p->search_instance_id != instance->id))
    {
        FMGR_TRACE2(TRC_MMI_FMGR_1FAF6A25FBF74982BACF2505BA889C76,   
            "[MMIFMGR] > Instance > mmi_fmgri_instance_general_set_search_filename > %d ow by %d\n",
            fmgr_p->search_instance_id, instance->id);
    }

    if (search_name)
    {
        len = mmi_ucs2strlen(search_name);
        if (len)
        {
            mmi_ucs2ncpy(fmgr_p->search_filename, (S8*)search_name, SRV_FMGR_PATH_MAX_FILE_NAME_LEN);
            len--;

            if ((fmgr_p->search_filename[len * ENCODING_LENGTH] == '\\') &&
                (fmgr_p->search_filename[len * ENCODING_LENGTH + 1] == 0))
            {
                fmgr_p->search_filename[len*ENCODING_LENGTH] = 0;
            }

            fmgr_p->search_instance_id = instance->id;
        }
    }
}

void mmi_fmgri_instance_general_close(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(mmi_fmgri_is_instance_id_valid(instance->id))
        mmi_frm_group_close(mmi_fmgri_instance_get_screen_id(instance->id));
}

#ifdef __DM_LAWMO_SUPPORT__	
void mmi_fmgri_instance_general_close_by_id(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(mmi_fmgri_is_instance_id_valid(instance_id))
        mmi_frm_group_close(mmi_fmgri_instance_get_screen_id(instance_id));
}
#endif

#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__

S32 mmi_fmgri_instance_cr_get_count(U8 instance_id, SRV_FMGR_DRVLIST_HANDLE drvlist_hdl)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S8 exclude_item;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_get_instance_by_id(instance_id);
    if (!(instance->flag & FMGR_IFLAG_CUSTOM_ROOT))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    exclude_item = (instance->type == MMI_FMGR_TYPE_APP) ? MMI_FALSE : MMI_TRUE;
    return mmi_fmgri_table_cr_get_count(drvlist_hdl, exclude_item);
}

S32 mmi_fmgri_instance_cr_get_info(U8 instance_id, SRV_FMGR_DRVLIST_HANDLE drvlist_hdl, S32 index, fmgr_drive_info_struct* info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S8 exclude_item;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = fmgr_get_instance_by_id(instance_id);

    if(!(instance->flag & FMGR_IFLAG_CUSTOM_ROOT))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }

    exclude_item = (instance->type == MMI_FMGR_TYPE_APP) ? FALSE : TRUE;
    
    if(mmi_fmgri_table_cr_get_info(drvlist_hdl, index, info, exclude_item))
    {
        return 0;
    }

    return MMI_FMGR_ERROR_INVALID_PARAM;
}

#ifdef FMGR_TAB_SUPPORT

S32  mmi_fmgri_instance_cr_tab_get_index(U8 instance_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct    *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = fmgr_get_instance_by_id(instance_id);

    if (!instance->tab_id)
    {
        return -1;
    }

    return mmi_fmgri_table_tab_get_index(instance->tab_id, (WCHAR*)instance->file_path);
}

#endif // FMGR_TAB_SUPPORT


#endif // __FMGR_CUSTOM_ROOT_SUPPORT__

void mmi_fmgr_close_option_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id                      grp_id;
    mmi_fmgr_instance_struct    *instance;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    for(grp_id = SCR_ID_FMGR_EXPLORER_BASE;
        grp_id < SCR_ID_FMGR_EXPLORER_END;
        grp_id ++)
    {
        instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(grp_id);
        if(!instance)
            continue;
        if(instance->display_type == FMGRI_DISPLAY_TYPE_NO_LIST)
            continue;

        mmi_fmgri_close_options(instance->id);
    }
}

static MMI_BOOL mmi_fmgri_instance_prepare_popup_arg(mmi_fmgr_instance_struct* instance, mmi_popup_property_struct *arg)
{
    if (instance->flag & FMGR_IFLAG_WAIT_POPUP)
    {
        return MMI_FALSE;
    }

    mmi_popup_property_init(arg);
    arg->parent_id = mmi_fmgri_instance_get_screen_id(instance->id);
    arg->callback = NULL;
    arg->user_tag = NULL;	

#ifdef __MMI_VUI_MEDIAWALL__
    /* Set popup rotation type */
    if (vapp_mediawall_get_direction() == VADP_MEDIAWALL_LANDSCAPE)
    {
        if (mmi_fmgri_instance_get_list_style(instance->id) == FMGR_DISPLAY_TYPE_MATRIX)
        {
            arg->rotation = MMI_FRM_SCREEN_ROTATE_270;
        }
    }
    else
    {
        arg->rotation = MMI_FRM_SCREEN_ROTATE_0;
    }
#endif

    return MMI_TRUE;
}

MMI_BOOL mmi_fmgri_instance_display_popup(mmi_fmgr_instance_struct* instance, U16 string_id, mmi_event_notify_enum popup_type, U16 parent_id, MMI_BOOL is_pop_with_cb, S32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_popup_property_struct arg;
    MMI_ID ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    FMGR_TRACE3(TRC_MMI_FMGR_DB003BC7CA7E4FB392E536175D1F39C2, "Fmgr > Popup > id=%d at <%d>:%d \n", string_id, 0, line);

    //mmi_fmgri_instance_display_popup_str(instance, GetString(string_id), popup_type, line);
    if(instance)
    {
        if (!mmi_fmgri_instance_prepare_popup_arg(instance, &arg))
        {
            return MMI_FALSE;
        }
    }
    else
    {
        mmi_popup_property_init(&arg);
        arg.parent_id = parent_id;
        arg.callback = NULL;
        arg.user_tag = NULL;
    }

    ret = mmi_popup_display((WCHAR*)GetString(string_id), popup_type, &arg);

    if(is_pop_with_cb)
    {
        if (ret != GRP_ID_INVALID)
        {
            instance->flag |= FMGR_IFLAG_WAIT_POPUP;
            return MMI_TRUE;
        }
        return MMI_FALSE;
    }
    return MMI_TRUE;
}

#ifdef __MMI_FMGR_MULTI_SELECT_SUPPORT__
MMI_BOOL mmi_fmgri_instance_display_popup_str(mmi_fmgr_instance_struct* instance, S8* string_ptr, mmi_event_notify_enum popup_type, S32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_popup_property_struct arg;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    FMGR_TRACE3(TRC_MMI_FMGR_DB003BC7CA7E4FB392E536175D1F39C2, "Fmgr > Popup > id=%d at <%d>:%d \n", 0, 0, line);

    if (!mmi_fmgri_instance_prepare_popup_arg(instance, &arg))
    {
        return MMI_FALSE;
    }    

    mmi_popup_display((WCHAR*)string_ptr, popup_type, &arg);

    return MMI_TRUE;
}
#endif
#if 0 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif

void mmi_fmgri_instance_post_event(mmi_fmgr_instance_struct* instance, mmi_event_struct* event_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (instance->flag & FMGR_IFLAG_WAIT_POPUP)
    {
        FMGR_ASSERT(!instance->delay_event);
        instance->delay_event = OslMalloc(event_ptr->size);
        memcpy(instance->delay_event, event_ptr, event_ptr->size);
    }
    else
    {
        mmi_frm_group_post_to_caller(mmi_fmgri_instance_get_screen_id(instance->id), (mmi_group_event_struct*)event_ptr);
    }
}

#ifdef __FS_CARD2_SUPPORT__
MMI_BOOL mmi_fmgri_is_drv_card_2_type_by_path(const S8 *file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_FALSE;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    do {
        if (!file_path || file_path[0] == 0)
        {
            break;
        }

		if (mmi_ucs2cmp((PS8)file_path, (PS8)SRV_FMGR_PATH_ROOT) == 0)
		{
			/* This is root */
			break;
		}

        if (srv_fmgr_drv_get_type(file_path[0]) == SRV_FMGR_DRV_CARD_2_TYPE)
        {			
            result = MMI_TRUE;
            break;
        }
    } while(0);
    return result;
}
#endif
#endif // defined (__MMI_FILE_MANAGER__)
