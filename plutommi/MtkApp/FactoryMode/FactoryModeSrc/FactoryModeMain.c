/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 * FactoryModeMain.c
 *
 * Project:
 * --------
 *   MAUI
 *
 * Description:
 * ------------
 *   This file is Factory Mode entry, menu cui, and so on.
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#include "MMI_features.h"

#ifdef __MMI_FACTORY_MODE__


#if defined(__DCM_WITH_COMPRESSION_MMI_POOL_A__)
#include "dcmgr.h"
#elif defined (__DCM_WITH_COMPRESSION_MMI_AP__) && defined(__MTK_TARGET__)
#include "MMI_ap_dcm_config.h"  
#endif /* __DCM_WITH_COMPRESSION_MMI_POOL_A__ */

#if defined(__MMI_AP_DCM_FM__)
#pragma arm section rodata = "DYNAMIC_CODE_FM_RODATA" , code = "DYNAMIC_CODE_FM_ROCODE"
#elif defined(__DCM_WITH_COMPRESSION_MMI_POOL_A__)
#pragma arm section rodata = "DYNAMIC_CODE_COSMOS_FM_RODATA" , code = "DYNAMIC_CODE_COSMOS_FM_ROCODE"
#endif /* #ifdef __MMI_AP_DCM_FM__ */ 

/*------------------- Header Files ---------------------------*/
#include "MMIDataType.h"
#include "kal_general_types.h"
#include "gdi_datatype.h"
#include "gui_data_types.h"
#include "GlobalConstants.h"
#include "ps_public_struct.h"
#include "stack_config.h"
#include "mmi_frm_input_gprot.h"
#include "stack_msgs.h"
#include "mmi_frm_events_gprot.h"
#include "GpioSrvGprot.h"
#include "gpiosrvgprot.h"
#include "Unicodexdcl.h"
#include "stdio.h"
#include "CustDataRes.h"
#include "GlobalResDef.h"

#include "TimerEvents.h"
#include "mmi_frm_timer_gprot.h"
#include "wgui_categories_util.h"
#include "kal_public_api.h"
#include "mmi_frm_history_gprot.h"
#include "CustMenuRes.h"
#include "GlobalMenuItems.h"
#include "wgui_categories_list.h"
#include "gui_typedef.h"
#include "wgui_include.h"
#include "string.h"
#include "mmi_frm_nvram_gprot.h"
#include "wgui_categories_text_viewer.h"
#include "nvram_defs.h"
#include "gui.h"
#include "FontRes.h"
#include "gdi_include.h"
#include "wgui_categories.h"
#include "custom_mmi_default_value.h"
#include "wgui.h"
#include "mmi_frm_scenario_gprot.h"
#include "mmi_msg_struct.h"
#include "AlarmFrameworkProt.h"
#include "mmi_res_range_def.h"
#include "mmi_frm_queue_gprot.h"
#include "app_ltlcom.h"
#include "wgui_touch_screen.h"
#include "gui_config.h"
#include "SensorSrvGport.h"
#include "ProtocolEvents.h"
#include "CommonScreens.h"
#include "PixcomFontEngine.h"
#include "resource_audio.h"
#include "IdleAppDef.h"
#include "EngineerModeUtil.h"
#include "EngineerModeGprot.h"
#include "mdi_datatype.h"
#include "mdi_include.h"
#include "mdi_audio.h"
#include "CommonScreens.h"
#include "fmt_struct.h"
#include "mmi_rp_srv_gpio_def.h"
#include "wgui_categories.h"
#ifdef __MMI_FM_DUAL_MIC_ECHO_LOOP__
#include "l1audio.h"
#endif

#include "dcl.h"
#include "init.h"
#include "device.h"
#include "custom_em.h"
#include "custom_equipment.h"
//#include "custom_hw_default.h"
#include "nvram_data_items.h"
#include "nvram_interface.h"
#include "lcd_sw_inc.h"
#include "resource_verno.h"

#ifdef __MTK_TARGET__
#include "l1audio.h"
#else 
#define L1SP_Tones kal_uint16
#endif 

#include "datetimetype.h"
#include "app_datetime.h"


#include "adc_channel.h"
#include "ShutdownSrvGprot.h"

#include "mmi_rp_app_factorymode_def.h"
#include "MenuCuiGprot.h"
#include "FactoryModeGProt.h"

#ifdef __GADGET_SUPPORT__
#include "WgtMgrSrvGprot.h"
#endif 

#include "PowerOnChargerProt.h"
#include "aud_main.h"
#include "FactoryModeConfig.h"
#include "FactoryModeProt.h"
#include "FactoryModeUtil.h"

/***************************************************************************** 
* global val / function
*****************************************************************************/
extern U8 gCurrentMode;  /* For GPIO */

MMI_ID g_fm_gourp_id = 0; /*global value for FM group id*/

mmi_fm_item_cntxt_struct *g_fm_contxt = NULL;  /*global value for FM context, it whill be reference by other files*/

extern void drv_sec_init(void);
extern void gui_touch_feedback_disable_tone_internal(void);
extern void gui_touch_feedback_disable_vibrate_internal(void);
extern void mmi_fm_cam_tc01_init(void);
extern void FM_SendStopAudioReq(U8 index);
extern void FM_SetGpioReq(U8 type, U8 level);
extern void gui_touch_feedback_enable_tone_internal(void);
extern void gui_touch_feedback_enable_vibrate_internal(void);
extern void FM_SetGpioVirbateReq(U8 level);
extern MMI_BOOL g_fm_echoloop2_need_close;
 
/*------------------------ static function ------------------------------*/
static void mmi_fm_init_fm_setting(void);
static void mmi_fm_main_menu_init_and_entry(void);
static void mmi_fm_pre_enter_fm_menu(void);
static U8 mmi_fm_get_test_item(mmi_menu_id id);
static U8 mmi_fm_get_entry_test_item(mmi_menu_id id);
static void mmi_fm_exit(void);
static MMI_RET mmi_fm_enter_main_menu_proc(mmi_event_struct *evt);
static void mmi_fm_set_lsk_null(cui_menu_event_struct *evt);
static void mmi_fm_default_func(cui_menu_event_struct *evt);
static void mmi_fm_avoid_audio_conflict(void);


/***************************************************************************** 
*  const table
* This table is used for FactoryMode menu cui. If you want to add menu item,
* Please add function handler in this table
*****************************************************************************/
/*Select and Highlight table*/
const mmi_fm_test_item_struct g_fm_test_item_tab[] =
{
    /* FM Menu Root */
    {MENU_ID_FM_ROOT,                   NULL,                                NULL },
#ifndef __MMI_FM_PLUTO_6261_SLIM__
    /* Version */
    {MENU_ID_FM_SW_SUMMARY,             (mmi_fm_select_func)mmi_fm_select_version_summary_menu, mmi_fm_version_menu_item_highlight},    
    {MENU_ID_FM_SW_VER,                 mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},
#ifdef __MMI_FM_MELODY_VERSION__
    {MENU_ID_FM_MELODY_VER,             mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},
#endif /*__MMI_FM_MELODY_VERSION__*/
    {MENU_ID_FM_ISN,                    mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},
    {MENU_ID_FM_BBCHIP_VER,             mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},
    {MENU_ID_FM_DSPCODE_VER,            mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},
    {MENU_ID_FM_DSPATCH_VER,            mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},
    {MENU_ID_FM_HW_VER,                 mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},
    {MENU_ID_FM_BUILD_TIME,             mmi_fm_set_lsk_null,                mmi_fm_version_menu_item_highlight},

#ifdef __MMI_FM_RES_BIN__
    /* Resource Bin */
    {MENU_ID_FM_RESOURCE_LANGPACK,      mmi_fm_set_lsk_null,                mmi_fm_res_bin_show_hint},
    {MENU_ID_FM_RESOURCE_CUSTPACK,      mmi_fm_set_lsk_null,                mmi_fm_res_bin_show_hint},
#endif

    /* Eachloop */
    {MENU_ID_FM_EACHLOOP,               (mmi_fm_select_func)mmi_fm_select_echo_loop,            (mmi_fm_highlight_func)mmi_fm_echo_loop_highlight},

#ifdef __ACOUSTIC_LOOPBACK_SUPPORT__
    {MENU_ID_FM_ACOUSTIC_LOOPBACK,      (mmi_fm_select_func)mmi_fm_select_acoustic_loopback,    (mmi_fm_highlight_func)mmi_fm_highlight_acoustic_loopback},
#endif

#ifdef __MMI_FM_DUAL_MIC_ECHO_LOOP__    
    {MENU_ID_FM_EACHLOOP2,              (mmi_fm_select_func)mmi_fm_select_echo_loop2,           (mmi_fm_highlight_func)mmi_fm_highlight_echo_loop2},
    {MENU_ID_FM_2MICNR_TEST,            (mmi_fm_select_func)mmi_fm_select_2micnr_test,          (mmi_fm_highlight_func)mmi_fm_highlight_2micnr_test},
    {MENU_ID_FM_DISABLE_2_MIC_NR_TEST,  (mmi_fm_select_func)mmi_fm_select_disable_2micnr_test,  (mmi_fm_highlight_func)mmi_fm_highlight_disable_2micnr_test},
#endif

      /* Keypad */
#ifdef __MMI_FM_KEYPAD_TEST__
     {MENU_ID_FM_KEYPAD,                (mmi_fm_select_func)mmi_fm_select_keypad_test,          mmi_fm_default_func},
#endif

    /* Vibrator */
    {MENU_ID_FM_VIBRATOR,               mmi_fm_select_vibrator,             (mmi_fm_highlight_func)mmi_fm_vibrator_highlight},

    /* Loud spk */
    {MENU_ID_FM_LOUDSPK,                (mmi_fm_select_func)mmi_fm_select_loud_spk,             (mmi_fm_highlight_func)mmi_fm_loud_spk_highlight},

    /* Ringtone */
    {MENU_ID_FM_RINGTONE,               (mmi_fm_select_func)mmi_fm_select_ring_tone,            (mmi_fm_highlight_func)mmi_fm_ring_tone_highlight},
#ifdef __SUPPORT_LED_FEATURE__
    /* LED */
    {MENU_ID_FM_LED_MAIN,               mmi_fm_select_led,                  mmi_fm_led_highlight},

#ifdef __MMI_SUBLCD__ 
    {MENU_ID_FM_LED_SUB,                mmi_fm_select_led,                  mmi_fm_led_highlight},
#endif
    {MENU_ID_FM_LED_KEYPAD,             mmi_fm_select_led,                  mmi_fm_led_highlight},
#ifndef __MMI_HIDE_STATUS_LED_R__  
    {MENU_ID_FM_LED_STATUS_R,           mmi_fm_select_led,                  mmi_fm_led_highlight},
#endif
#ifndef __MMI_HIDE_STATUS_LED_G_
    {MENU_ID_FM_LED_STATUS_G,           mmi_fm_select_led,                  mmi_fm_led_highlight},           
#endif
#ifndef __MMI_HIDE_STATUS_LED_B__  
    {MENU_ID_FM_LED_STATUS_B,           mmi_fm_select_led,                  mmi_fm_led_highlight},
#endif
#endif /* __SUPPORT_LED_FEATURE__ */

    /* LCD */
#ifndef __MMI_MAINLCD_96X64__
    {MENU_ID_FM_LCD,                    mmi_fm_default_func,                (mmi_fm_highlight_func)mmi_fm_lcd_highlight},
    {MENU_ID_FM_LCD_AUTO,               mmi_fm_select_certain_lcd_test,     mmi_fm_default_func},
    {MENU_ID_FM_LCD_R,                  mmi_fm_select_certain_lcd_test,     mmi_fm_default_func},
    {MENU_ID_FM_LCD_G,                  mmi_fm_select_certain_lcd_test,     mmi_fm_default_func},
    {MENU_ID_FM_LCD_B,                  mmi_fm_select_certain_lcd_test,     mmi_fm_default_func},
    {MENU_ID_FM_LCD_W,                  mmi_fm_select_certain_lcd_test,     mmi_fm_default_func},
    {MENU_ID_FM_LCD_BLACK,              mmi_fm_select_certain_lcd_test,     mmi_fm_default_func},
#endif

    /* Receiver */
    {MENU_ID_FM_RECEIVER,               (mmi_fm_select_func)mmi_fm_select_receiver_hdlr,        (mmi_fm_highlight_func)mmi_fm_highlight_receiver_hdlr},
#endif /* __MMI_FM_PLUTO_6261_SLIM__ */

    /* ADC */
    {MENU_ID_FM_ADC,                    (mmi_fm_select_func)mmi_fm_select_adc_menu,             mmi_fm_default_func},

#ifndef __MMI_FM_PLUTO_6261_SLIM__
    /*Headset*/
    {MENU_ID_FM_HEADSET,                (mmi_fm_select_func)mmi_fm_select_headset,              (mmi_fm_highlight_func)mmi_fm_highlight_headset},
#endif /* __MMI_FM_PLUTO_6261_SLIM__ */
    /* RTC */
    {MENU_ID_FM_RTC,                    (mmi_fm_select_func)mmi_fm_select_rtc,                  mmi_fm_default_func},
#ifndef __MMI_FM_PLUTO_6261_SLIM__
#ifdef __MMI_FM_MTBF__
    /* MTBF*/
    {MENU_ID_FM_MTBF,                   (mmi_fm_select_func)mmi_fm_select_mtbf,                 mmi_fm_default_func},
#endif /*__MMI_FM_MTBF__*/

/* Memory card */
#if (defined(__MSDC_MS__) || defined(__MSDC_SD_MMC__) || defined(__MSDC_MSPRO__))   
    {MENU_ID_FM_MEMORY_CARD,            (mmi_fm_select_func)mmi_fm_select_memory_card,          mmi_fm_default_func},
#endif

    /* Nand flash */
#if (defined(NAND_SUPPORT))
    {MENU_ID_FM_NAND_FLASH,             (mmi_fm_select_func)mmi_fm_select_nand_flash,           mmi_fm_default_func},
#endif

    /* FM-camera LGE */
#if defined(__MMI_FM_TC01_CAMERA_TEST__)
    {MENU_ID_FM_CAMERA_TEST,            (mmi_fm_select_func)mmi_fm_camera_test_entry_cam_test,  mmi_fm_default_func},
#endif

#if defined(__MMI_FM_CAMERA_PREVIEW__)
    /* Camera */
    {MENU_ID_FM_CAMERA,                 (mmi_fm_select_func)mmi_fm_camera_entry_preview_screen, mmi_fm_default_func},
#endif

    /* parallel line test & NxM point test*/
#if defined(__MMI_TOUCH_SCREEN__)
    {MENU_ID_FM_PARALLEL_LINE,          (mmi_fm_select_func)mmi_fm_select_pen_parallel_test,    mmi_fm_default_func},
    {MENU_ID_FM_N_CROSS_M,              (mmi_fm_select_func)mmi_fm_select_pen_n_cross_test,     mmi_fm_default_func},
#endif

    /* FM Radio */
#ifdef __MMI_FM_RADIO__
    {MENU_ID_FM_FMRADIO_CHANNEL_1,      mmi_fm_select_radio_test,           (mmi_fm_highlight_func)mmi_fm_highlight_radio_menu},
#ifdef __MMI_FM_FMRADIO_PHASE_OUT__
    {MENU_ID_FM_FMRADIO_CHANNEL_2,      mmi_fm_select_radio_test,           (mmi_fm_highlight_func)mmi_fm_highlight_radio_menu},
    {MENU_ID_FM_FMRADIO_CHANNEL_3,      mmi_fm_select_radio_test,           (mmi_fm_highlight_func)mmi_fm_highlight_radio_menu},
#endif
#endif

#ifdef __ATV_SUPPORT__
     {MENU_ID_FM_MATV,                  (mmi_fm_select_func)mmi_fm_select_atv,                  (mmi_fm_highlight_func)mmi_fm_highlight_atv},
#endif

    /* Touch panel */
#ifdef  __MMI_FM_TOUCH_PANEL_ACCURACY_TEST__
    {MENU_ID_FM_TOUCH_PANEL,            (mmi_fm_select_func)mmi_fm_touch_panel_entry,           mmi_fm_default_func},
#endif
#if defined(__TOUCH_PANEL_MULTITOUCH__)
    {MENU_ID_FM_DUAL_TOUCH_CALIBRATION, (mmi_fm_select_func)mmi_fm_dual_touch_calibr_entry,           mmi_fm_default_func},
#endif

    /* PXS sensor */
#ifdef __MMI_FM_PXS_SENSOR__
    {MENU_ID_FM_PXS_SENSOR,             (mmi_fm_select_func)mmi_fm_enter_pxs,                   mmi_fm_default_func},
#endif

#endif /* __MMI_FM_PLUTO_6261_SLIM__ */
    /* AUTO test setting */
#ifdef __MMI_FM_AUTO_TEST__
     {MENU_ID_FM_MISC_AUTO_TEST_SETTING,  (mmi_fm_select_func)mmi_fm_select_auto_test_setting,  mmi_fm_default_func},
#endif /*__MMI_FM_AUTO_TEST__*/

#ifndef __MMI_FM_PLUTO_6261_SLIM__
    /* UART */ 
#ifdef __MMI_FM_UART_TEST__
    {MENU_ID_FM_UART,                   (mmi_fm_select_func)mmi_fm_select_uart,                 mmi_fm_default_func},
#endif /*__MMI_ID_FM_UART__*/

#ifdef __MMI_FM_NFC_SUPPORT__
     {MENU_ID_FM_NFC,                   (mmi_fm_select_func)mmi_fm_nfc_entry, mmi_fm_default_func},
#endif /*__MMI_FM_NFC_SUPPORT__*/


#ifdef __MOTION_SENSOR_ADVANCED_GESTURE__
	 {MENU_ID_FM_MOTION_SENSOR_CALI,    mmi_fm_motion_sensor_cali,    mmi_fm_default_func },
#endif
#endif /* __MMI_FM_PLUTO_6261_SLIM__ */
};

/*Entry EVT table*/
const mmi_fm_entry_test_item_struct g_fm_entry_test_item_tab[] = 
{
     /* FM Menu Root */
#ifdef __MMI_FM_UART_TEST__
    {MENU_ID_FM_ROOT,       mmi_fm_pre_uart_hint},
#endif /*__MMI_FM_UART_TEST__*/
    /* Version */
    {MENU_ID_FM_VERSION,    mmi_fm_version_pre_hint}

};

#define UTIL_FUNC

void mmi_fm_set_lsk_null(cui_menu_event_struct *evt)
{
    change_left_softkey(0, 0);     /*set lsk NULL*/
    redraw_left_softkey();
    return;    
}

void mmi_fm_default_func(cui_menu_event_struct *evt)
{
    change_left_softkey(STR_GLOBAL_OK, 0);     /*set lsk OK*/
    redraw_left_softkey();
    return;
}



#define  MMI_FM_MAIN_MENU

/***************************************************************************** 
* Internal function
*****************************************************************************/

static void mmi_fm_comm_mem_em_stop_callback(void)
{
    mmi_fm_exit();
    applib_mem_ap_notify_stop_finished(APPLIB_MEM_AP_ID_FM_COMM_MEM, MMI_TRUE);
}

/*****************************************************************************
* FUNCTION
*  mmi_fm_init_mem_contxt
* DESCRIPTION
*  Initiate memory context
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
extern void mmi_fm_init_mem_contxt(void)
{  
#if defined(__MMI_TOUCH_SCREEN__)   
    mmi_fm_parallelline_NxMpoint_struct *parallelline_NxMpoint_contxt;
#endif /*__MMI_TOUCH_SCREEN__*/

    mmi_fm_mtbf_struct *mtbf_contxt;

    mtbf_contxt = &(g_fm_contxt->mtbf_contxt);
   
   g_fm_contxt->common_contxt.NeedExitFunc = MMI_TRUE;
   mtbf_contxt->MTBF_state_LCD = FM_MTBF_LCD_START;
   mtbf_contxt->MTBF_state_LED = FM_MTBF_LED_START;
   mtbf_contxt->MTBF_state_VIB = FM_MTBF_VIB_START;
   mtbf_contxt->AUD_TEST_ON = FM_MTBF_AUD_START;

#if defined(__MMI_TOUCH_SCREEN__)
   parallelline_NxMpoint_contxt = &(g_fm_contxt->parallelline_NxMpoint_contxt);
   parallelline_NxMpoint_contxt->gFMPenLineColor.r = 0;
   parallelline_NxMpoint_contxt->gFMPenLineColor.g = 0;
   parallelline_NxMpoint_contxt->gFMPenLineColor.b = 0;
   parallelline_NxMpoint_contxt->gFMPenLineColor.alpha = 100;
   parallelline_NxMpoint_contxt->gFMPenParallel_test_type = PARALLEL_TEST_1;
#endif /*__MMI_TOUCH_SCREEN__*/

   g_fm_contxt->eachloop_contxt.g_FM_AUDIO_TEST_STATUS = FM_AUDIO_TEST_STAT_NONE;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_fm_init_fm_setting
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_fm_init_fm_setting(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gCurrentMode = FACTORY_MODE;    /*For GPIO*/
    mdi_audio_suspend_background_play();
    mdi_audio_stop_all();
    srv_gpio_play_pattern((srv_gpio_pattern_id_enum)srv_led_pattern_get_bg_pattern(), SRV_GPIO_PATN_PLAY_STOP);

	/* Disable tone internal */
	gui_touch_feedback_disable_tone_internal();
	gui_touch_feedback_disable_vibrate_internal();
}


/*****************************************************************************
* FUNCTION
*  mmi_fm_main_menu_init_and_entry
* DESCRIPTION
*  Initiate for FM
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_fm_main_menu_init_and_entry(void)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/
	MMI_ID menu_id;
	
	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
	if (g_fm_contxt != NULL)
	{
		memset(g_fm_contxt, 0, sizeof(mmi_fm_item_cntxt_struct));
		mmi_fm_init_mem_contxt();
	}

	g_fm_gourp_id = mmi_frm_group_create(GRP_ID_ROOT,
					   GRP_ID_AUTO_GEN, mmi_fm_enter_main_menu_proc, NULL);
	mmi_frm_group_enter(g_fm_gourp_id, MMI_FRM_NODE_SMART_CLOSE_CAUSED_BY_CLOSE_FLAG);
	menu_id = cui_menu_create(g_fm_gourp_id, CUI_MENU_SRC_TYPE_RESOURCE, CUI_MENU_TYPE_APPSUB,
						MENU_ID_FM_ROOT,
						MMI_TRUE, NULL);
	cui_menu_run(menu_id);
	mmi_fm_init_fm_setting();
}

/*****************************************************************************
* FUNCTION
*  mmi_em_pre_entry_engineermode_menu
* DESCRIPTION
*  Init ASM before entering EM main menu
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_fm_pre_enter_fm_menu(void)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/
	
	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
	
	/*  Abnormal entry */
	if (g_fm_gourp_id != NULL)
	{
		DisplayPopup((PU8) GetString(STR_GLOBAL_ERROR), NULL, 0, 1000, 0);
        MMI_FM_DCM_POST_UNLOAD();
        return ;
	}

	/*Alloc ASM for FactoryMode*/
	g_fm_contxt = applib_mem_ap_alloc(APPLIB_MEM_AP_ID_FM_COMM_MEM,sizeof(mmi_fm_item_cntxt_struct));
	
	if (g_fm_contxt == NULL)
	{
		DisplayPopup((PU8) GetString(STR_GLOBAL_INSUFFICIENT_MEMORY), NULL, 0, 1000, 0);
        MMI_FM_DCM_POST_UNLOAD();
		return;
	}
	mmi_fm_main_menu_init_and_entry();
}

/*****************************************************************************
 * FUNCTION
 *  DummyFMCBHandler
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void DummyFMCBHandler(void* param)
{
    return;
}


/*****************************************************************************
 * FUNCTION
 *	InitFactoryModeEvent
 * DESCRIPTION
 *	
 * PARAMETERS
 *	void
 * RETURNS
 *	void
 *****************************************************************************/
extern void DeinitFactoryModeEvent(void)
{
    /*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/
    const U16 eventFMIDs[] ={          
	                MSG_ID_MMI_EM_KEYPAD_EVENT_ACT_IND
                #ifndef __MMI_MAINLCD_96X64__ 
	                , MSG_ID_MMI_EM_LCM_TEST_IND
	                , MSG_ID_MMI_EM_RGB_TEST_REQ_IND
	            #endif
                    };
    U16 eventNum = (sizeof(eventFMIDs)/sizeof(U16));
    U16 index = 0;
  
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for(index = 0; index < eventNum; ++index)
    {
        mmi_frm_set_single_protocol_event_handler(eventFMIDs[index], 
	                                    (PsIntFuncPtr)DummyFMCBHandler);
    }
}


/*****************************************************************************
 * FUNCTION
 *	InitFactoryModeEvent
 * DESCRIPTION
 *	
 * PARAMETERS
 *	void
 * RETURNS
 *	void
 *****************************************************************************/
void InitFactoryModeEvent(void)
{
    /*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/

	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
    /* Set protocol event handler */	
	mmi_frm_set_single_protocol_event_handler(MSG_ID_MMI_EM_KEYPAD_EVENT_ACT_IND, 
	                                    (PsIntFuncPtr)mmi_fm_at_keypad_test_hdlr);
    #ifndef __MMI_MAINLCD_96X64__
	mmi_frm_set_single_protocol_event_handler(MSG_ID_MMI_EM_LCM_TEST_IND, 
	                                    (PsIntFuncPtr)mmi_fm_at_lcd_test_msg_hdlr);
    mmi_frm_set_single_protocol_event_handler(MSG_ID_MMI_EM_RGB_TEST_REQ_IND,
                                        (PsIntFuncPtr)mmi_fm_at_lcm_rgb_test_handler);
    #endif /* __MMI_MAINLCD_96X64__ */
}

/*****************************************************************************
 * FUNCTION
 *	mmi_fm_get_test_item
 * DESCRIPTION
 *	Get index from menu_id
 * PARAMETERS
 *	mmi_menu_id id
 * RETURNS
 *	
 *****************************************************************************/
static U8 mmi_fm_get_test_item(mmi_menu_id id)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/
	U8 i;

	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
	for (i = 0; i < MAX_TEST_ITEM; i++)
	{
		if (id == g_fm_test_item_tab[i].menu_id)
		{
			break;
		}
	}
	if (i < MAX_TEST_ITEM)
		return i;
	else
		return INVALID_MENU_ITEM;
}

/*****************************************************************************
 * FUNCTION
 *	mmi_fm_get_entry_test_item
 * DESCRIPTION
 *	
 * PARAMETERS
 *	mmi_menu_id id
 * RETURNS
 *	
 *****************************************************************************/
static U8 mmi_fm_get_entry_test_item(mmi_menu_id id)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/
	U32 i;
	
	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
	for (i = 0; i < MAX_ENTRY_ITEM; i++)
	{
		if (id == g_fm_entry_test_item_tab[i].menu_id)
		{
			break;
		}
	}
	if (i < MAX_ENTRY_ITEM)
		return i;
	else
		return INVALID_MENU_ITEM;
}

/*****************************************************************************
 * FUNCTION
 *	mmi_fm_exit
 * DESCRIPTION
 *	This function will be called when exit FM
 * PARAMETERS
 *	void
 * RETURNS
 *	void
 *****************************************************************************/
static void mmi_fm_exit(void)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/
	mmi_fm_eachloop_struct *eachloop_cntx;

	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/

#ifdef __MMI_FM_RADIO__	
    /* If FM Radio is turned on, then stop/turn-off it */
    if (g_fm_contxt->radio_contxt.g_fm_fm_radio_cntx.is_FMRDO_on)
    {
        mdi_audio_stop_fmr();
        g_fm_contxt->radio_contxt.g_fm_fm_radio_cntx.is_FMRDO_on = 0;
    }
#endif
	
/* Close Echo loop 2*/

	if (g_fm_echoloop2_need_close == MMI_TRUE)
	{
	aud_util_proc_in_med(MOD_MMI,
				mmi_fm_set_loopback2,
				KAL_FALSE,
				NULL);
	}
	
#if 0
/* under construction !*/
#ifdef __ACOUSTIC_LOOPBACK_SUPPORT__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif  /*__ACOUSTIC_LOOPBACK_SUPPORT__*/
/* under construction !*/
#endif

#ifdef __MMI_FM_DUAL_MIC_ECHO_LOOP__  
    /* for 2micnr */
    if(g_fm_contxt->two_micnr.two_micnr_test)
    {
        kal_prompt_trace(MOD_MMI_COMMON_APP,"mmi_fm_exit for mmi_fm_set_acoustic_loopback");
        aud_util_proc_in_med(MOD_MMI, mmi_fm_set_acoustic_loopback, KAL_FALSE, NULL);
        mdi_audio_set_audio_mode(g_fm_contxt->two_micnr.two_micnr_audio_mode_enum);
    }
    if(g_fm_contxt->two_micnr.disable_2micnr_test)
    {
        kal_prompt_trace(MOD_MMI_COMMON_APP,"mmi_fm_exit for mmi_fm_set_disable_2mic_nr_back");
        aud_util_proc_in_med(MOD_MMI, mmi_fm_set_disable_2mic_nr_back, KAL_FALSE, NULL);
        mdi_audio_set_audio_mode(g_fm_contxt->two_micnr.two_micnr_audio_mode_enum);
    }/* end  2micnr */
    #endif    
	eachloop_cntx = &(g_fm_contxt->eachloop_contxt);
	
	/* FM_RestoreAudio(); */
	if (g_fm_contxt->loudspk_contxt.LoudSpkTestOn
		|| eachloop_cntx->ReceiverTestOn)
	{
		FM_RestoreAudio();
		FM_SendSetAudioModeReq(AUD_MODE_NORMAL);
		mdi_audio_stop_id(TONE_KEY_NORMAL);
	}
	if (eachloop_cntx->EchoLoopTestOn ||
		eachloop_cntx->HeadsetTestOn)
	{
		FM_SendSetAudioModeReq(AUD_MODE_NORMAL);
	    kal_sleep_task(kal_milli_secs_to_ticks(200));
        mmi_frm_kbd_set_tone_state(MMI_KEY_TONE_ENABLED);
		//mmi_fm_set_loopback(MMI_FALSE);
		aud_util_proc_in_med(MOD_MMI,
				mmi_fm_set_loopback,
				MMI_FALSE,
				NULL);
	}
	if (eachloop_cntx->RingToneTestOn)
	{
		FM_SendStopAudioReq(0);
	}

	mmi_fm_stop_MTBF_tone();
	mdi_audio_start_background_timer();
  
	mmi_frm_group_close(g_fm_gourp_id);
	g_fm_gourp_id = 0; 

	if (g_fm_contxt != NULL)
	{
	   applib_mem_ap_free(g_fm_contxt); 
	   g_fm_contxt = NULL;
	}						 
	gCurrentMode = NORMAL_MODE;
	StopTimer(FM_AUTO_TEST_COMMNON_TIMER);
	StopTimer(FM_LCD_COLOR_CHANGE_TIMER);
	StopTimer(FM_VIB_TIMER);
	FM_SetGpioVirbateReq(VIBRATOR_OFF);

	/* For background */
	mdi_switch_device_ownership(MOD_MMI, MDI_DEVICE_AUDIO | MDI_DEVICE_CAMER | MDI_DEVICE_VIDEO);
	mdi_audio_start_background_timer();
	mdi_audio_resume_background_play();
	srv_gpio_play_pattern((srv_gpio_pattern_id_enum)srv_led_pattern_get_bg_pattern(), SRV_GPIO_PATN_PLAY_START);

	/* For adc */
	mmi_frm_set_single_protocol_event_handler(MSG_ID_MMI_EQ_ADC_ALL_CHANNEL_IND, 
									(PsIntFuncPtr)NULL);
	mmi_frm_set_single_protocol_event_handler(PRT_BATTERY_STATUS_IND, 
									(PsIntFuncPtr)BatteryStatusRsp);

  FM_SendADCStopReq();

	/* Enable tone internal */
	gui_touch_feedback_enable_tone_internal();
	gui_touch_feedback_enable_vibrate_internal();

#ifdef __MMI_FM_CAMERA_PREVIEW__
	/* For camera */
	mmi_fm_close_camera();
#endif
}


static void mmi_fm_avoid_audio_conflict(void)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/

	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
#ifdef __MMI_FM_DUAL_MIC_ECHO_LOOP__  
    g_fm_contxt->two_micnr.two_micnr_audio_mode_enum = mdi_audio_get_audio_mode();
    if(g_fm_contxt->two_micnr.two_micnr_test)
    {
        kal_prompt_trace(MOD_MMI_COMMON_APP,"mmi_fm_avoid_audio_conflict for mmi_fm_set_acoustic_loopback");
        aud_util_proc_in_med(MOD_MMI, mmi_fm_set_acoustic_loopback, KAL_FALSE, NULL);
        mdi_audio_set_audio_mode(g_fm_contxt->two_micnr.two_micnr_audio_mode_enum);
    }

    if(g_fm_contxt->two_micnr.disable_2micnr_test)
    {
        kal_prompt_trace(MOD_MMI_COMMON_APP,"mmi_fm_avoid_audio_conflict for mmi_fm_set_disable_2mic_nr_back");
        aud_util_proc_in_med(MOD_MMI, mmi_fm_set_disable_2mic_nr_back, KAL_FALSE, NULL);
        mdi_audio_set_audio_mode(g_fm_contxt->two_micnr.two_micnr_audio_mode_enum);
    }
    
#endif
	FM_SendSetAudioModeReq(AUD_MODE_NORMAL);
	mdi_audio_stop_id(TONE_KEY_NORMAL);
		
	/* Close ringtone */
	g_fm_contxt->eachloop_contxt.RingToneTestOn = MMI_FALSE;
	FM_SendStopAudioReq(0); /* stop MIDI */

	/* Close EchoLoop and EchoLoop2 */

	aud_util_proc_in_med(MOD_MMI,
				mmi_fm_set_loopback,
				MMI_FALSE,
				NULL);

	aud_util_proc_in_med(MOD_MMI,
				mmi_fm_set_loopback2,
				KAL_FALSE,
				NULL);

	/* Close vibrator */    
	FM_SetGpioVirbateReq(VIBRATOR_OFF);
	StopTimer(FM_VIB_TIMER);
	g_fm_contxt->viberate_contxt.vib_status = MMI_FALSE;

	g_fm_contxt->loudspk_contxt.LoudSpkTestOn = MMI_FALSE;
	g_fm_contxt->eachloop_contxt.ReceiverTestOn = MMI_FALSE;
	g_fm_contxt->eachloop_contxt.HeadsetTestOn = MMI_FALSE;
	g_fm_contxt->eachloop_contxt.EchoLoopTestOn = MMI_FALSE;
	
}

/*****************************************************************************
 * FUNCTION
 *	mmi_fm_enter_main_menu_proc
 * DESCRIPTION
 *	Process EVT for group fm
 * PARAMETERS
 *	mmi_event_struct * evt
 * RETURNS
 *	MMI_RET
 *****************************************************************************/
static MMI_RET mmi_fm_enter_main_menu_proc(mmi_event_struct *evt)
{
	 /*----------------------------------------------------------------*/
	 /* Local Variables 											   */
	 /*----------------------------------------------------------------*/
	 cui_menu_event_struct *menu_evt = (cui_menu_event_struct *)evt;
	 U8 menu_test_item = 0;
	 
	 /*----------------------------------------------------------------*/
	 /* Code Body													   */
	 /*----------------------------------------------------------------*/
	switch(evt->evt_id)
	{
		case EVT_ID_CUI_MENU_LIST_ENTRY:
			menu_test_item = mmi_fm_get_entry_test_item(menu_evt->parent_menu_id);
			if (menu_test_item != INVALID_MENU_ITEM)
				g_fm_entry_test_item_tab[menu_test_item].enter_func(menu_evt);
			break;

		case EVT_ID_CUI_MENU_CLOSE_REQUEST:
			cui_menu_close(menu_evt->sender_id);
			break;

		case EVT_ID_CUI_MENU_ITEM_SELECT:
			menu_test_item = mmi_fm_get_test_item(menu_evt->highlighted_menu_id);
			if (menu_test_item != INVALID_MENU_ITEM)
				g_fm_test_item_tab[menu_test_item].select_func(menu_evt);
			break;
		case EVT_ID_GROUP_DEINIT:
			mmi_fm_exit();
            //post event to handle DCM Unload 
            MMI_FM_DCM_POST_UNLOAD();
            break;
		case EVT_ID_CUI_MENU_ITEM_HILITE:

			mmi_fm_avoid_audio_conflict();
		
			/* Call highlight handler */
			menu_test_item = mmi_fm_get_test_item(menu_evt->highlighted_menu_id);
			if (menu_test_item != INVALID_MENU_ITEM)
				g_fm_test_item_tab[menu_test_item].highlight_func(menu_evt);
			break;
			
		default:
			break;	
	}

	return MMI_RET_OK;
}

/*****************************************************************************
 * FUNCTION
 *	mmi_entry_fm_menu
 * DESCRIPTION
 *	
 * PARAMETERS
 *	void
 * RETURNS
 *	void
 *****************************************************************************/
void mmi_entry_fm_menu(void)
{
    /*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/

	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
    InitFactoryModeEvent();
    
    mmi_frm_send_ilm((oslModuleType) MOD_MMI, (oslMsgType)MSG_ID_MMI_FM_SCR_LEVEL_NOTIFY_IND, 
                         (oslParaType*)NULL, (oslPeerBuffType*)NULL);  /*Send message for QA auto_test*/
    mmi_fm_pre_enter_fm_menu();  
}


#if (defined(__MMI_AP_DCM_FM__) || defined(__DCM_WITH_COMPRESSION_MMI_POOL_A__))
#pragma arm section rodata , code
#endif /* (defined(__MMI_AP_DCM_FM__) || defined(__DCM_WITH_COMPRESSION_MMI_POOL_A__)) */

// DCM require
/*****************************************************************************
 * FUNCTION
 *	InitFactoryMode
 * DESCRIPTION
 *	
 * PARAMETERS
 *	void
 * RETURNS
 *	void
 *****************************************************************************/
extern void InitFactoryMode(void)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/

	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
    mmi_frm_set_single_protocol_event_handler(MSG_ID_MMI_FACTORY_TEST_IND, 
	                                   (PsIntFuncPtr)mmi_fm_at_entry_menu_hdlr);
#if (defined(__MSDC_MS__) || defined(__MSDC_SD_MMC__) || defined(__MSDC_MSPRO__))
    mmi_frm_set_single_protocol_event_handler(MSG_ID_MMI_FMT_GET_MSDC_STATUS_RSP, 
									   (PsIntFuncPtr)FM_MemoryCardResponseHandler);
#endif
    mmi_frm_set_single_protocol_event_handler(MSG_ID_MMI_EM_QUICK_TEST_REPORT_IND,
	                                   (PsIntFuncPtr)mmi_fm_quick_test_report);
    MMI_FM_DCM_LOAD();
#ifdef __MMI_FM_TC01_CAMERA_TEST__
	mmi_fm_cam_tc01_init();
#endif
	drv_sec_init();
	applib_mem_ap_register(APPLIB_MEM_AP_ID_FM_COMM_MEM, STR_ID_FM_ROOT, 
		NULL, mmi_fm_comm_mem_em_stop_callback);		   	
    MMI_FM_DCM_SEND_UNLOAD();
}


/*****************************************************************************
 * FUNCTION
 *	EntryFMMenu
 * DESCRIPTION
 *	It is entry of FM,if dail *#66*#, it will enter from it
 * PARAMETERS
 *	void
 * RETURNS
 *	void
 *****************************************************************************/
extern void EntryFMMenu(void)
{
    /*----------------------------------------------------------------*/
	/* Local Variables												  */
	/*----------------------------------------------------------------*/

	/*----------------------------------------------------------------*/
	/* Code Body													  */
	/*----------------------------------------------------------------*/
    MMI_FM_DCM_LOAD();
    
    mmi_entry_fm_menu();
}

#endif /* __MMI_FACTORY_MODE__*/
