/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 * Birthday.c
 *
 * Project:
 * --------
 * MAUI
 *
 * Description:
 * ------------
 * Birthday application.
 *
 * Author:
 * -------
 * -------
 *
 *==============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *==============================================================================
 *******************************************************************************/
/*****************************************************************************
 * Include
 *****************************************************************************/
#ifndef MMI_BIRTHDAY_C
#define MMI_BIRTHDAY_C 

#include "MMI_features.h"

#ifdef __MMI_BIRTHDAY_REMINDER__

#include "MMI_common_app_trc.h"
#include "DebugInitDef_Int.h"
#include "MMIDataType.h"
#include "mmi_common_app_trc.h"
#include "kal_trace.h"
#include "string.h"
#include "mmi_frm_scenario_gprot.h"
#include "mmi_frm_events_gprot.h"
#include "mmi_rp_srv_syncml_def.h"
#include "kal_general_types.h"
#include "wgui_categories_util.h"
#include "AlertScreen.h"
#include "mmi_frm_mem_gprot.h"
#include "kal_public_api.h"
#include "custom_mmi_default_value.h"
#include "ToDoListGprot.h"
#include "GlobalResDef.h"
#include "CommonScreensResDef.h"
#include "CustDataRes.h"
#include "mmi_frm_history_gprot.h"
#include "gui_typedef.h"
#include "DateTimeType.h"
#include "app_datetime.h"
#include "Unicodexdcl.h"
#include "TodolistSrvGprot.h"
#include "ps_public_enum.h"
#include "BirthdayProt.h"
#include "BirthdayGprot.h"
#include "mmi_rp_app_calendar_def.h"
#include "mmi_rp_app_todolist_def.h"
#include "mmi_rp_srv_vcalendar_def.h"
#include "ToDoListProt.h"
#include "SyncMLGprot.h"
#include "PhbSrvGprot.h"
#include "InlineCuiGprot.h" 
#include "phbsrvgprot.h"


/*****************************************************************************
 * Define
 *****************************************************************************/
#define MMI_BIRTH_TRACE0(sub_grp) \
		MMI_TRACE(MMI_COMMON_TRC_G2_ORG, sub_grp)

#define MMI_BIRTH_TRACE1(sub_grp, arg) \
		MMI_TRACE(MMI_COMMON_TRC_G2_ORG, sub_grp, arg)
		
#define MMI_BIRTH_TRACE2(sub_grp, arg1, arg2) \
		MMI_TRACE(MMI_COMMON_TRC_G2_ORG, sub_grp, arg1, arg2)

#define MMI_BIRTH_TRACE3(sub_grp, arg1, arg2, arg3) \
		MMI_TRACE(MMI_COMMON_TRC_G2_ORG, sub_grp, arg1, arg2, arg3)

		
/*****************************************************************************
 * Static Declaration
 *****************************************************************************/
#define STATIC_DECLARATION
static const cui_inline_item_caption_struct cui_birthday_caption[3] =
{
    STR_ID_BDAY_TIME,
    STR_ID_BDAY_REMINDER_TIME,
    STR_ID_BDAY_REMINDER
};

static const cui_inline_set_item_struct cui_birthday_view_items[6] = 
{
    {CUI_INLINE_ITEM_ID_BASE + 0, CUI_INLINE_ITEM_TYPE_CAPTION, IMG_TODO_LIST_DATE, &cui_birthday_caption[0]},
    {CUI_INLINE_ITEM_ID_BASE + 1, CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY, 0, NULL},
    {CUI_INLINE_ITEM_ID_BASE + 2, CUI_INLINE_ITEM_TYPE_CAPTION, IMG_TODO_LIST_REPEAT, &cui_birthday_caption[1]},
    {CUI_INLINE_ITEM_ID_BASE + 3, CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY, 0, NULL},
    {CUI_INLINE_ITEM_ID_BASE + 4, CUI_INLINE_ITEM_TYPE_CAPTION, IMG_TODO_LIST_TIME, &cui_birthday_caption[2]},
    {CUI_INLINE_ITEM_ID_BASE + 5, CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY, 0, NULL}    
};

static const cui_inline_set_item_struct cui_birthday_edit_items[6] = 
{
    {CUI_INLINE_ITEM_ID_BASE + 0, CUI_INLINE_ITEM_TYPE_CAPTION, IMG_TODO_LIST_DATE, &cui_birthday_caption[0]},
    {CUI_INLINE_ITEM_ID_BASE + 1, CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY, 0, NULL},
    {CUI_INLINE_ITEM_ID_BASE + 2, CUI_INLINE_ITEM_TYPE_CAPTION, IMG_TODO_LIST_REPEAT, &cui_birthday_caption[1]},
    {CUI_INLINE_ITEM_ID_BASE + 3, CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY, 0, NULL},
    {CUI_INLINE_ITEM_ID_BASE + 4, CUI_INLINE_ITEM_TYPE_CAPTION, IMG_TODO_LIST_TIME, &cui_birthday_caption[2]},
    {CUI_INLINE_ITEM_ID_BASE + 5, CUI_INLINE_ITEM_TYPE_SELECT, 0, NULL}    
};

static void mmi_tdl_br_reminder_goback(mmi_id parent_id);
static void mmi_tdl_br_save_confirm(mmi_id parent_id);
static void mmi_tdl_br_save_confirm_no(mmi_id parent_id);
static void mmi_tdl_br_add(mmi_id parent_id);

static void mmi_tdl_br_view_to_edit(mmi_id parent_id);
static U16 mmi_tdl_br_get_store_index(U16 phn_book_index);
static void mmi_tdl_br_update(mmi_id parent_id);
static void mmi_tdl_br_entry_bday_edit_int(void);
static void mmi_tdl_br_entry_bday_edit_from_phb(mmi_id parent_id);
static mmi_ret mmi_tdl_br_edit_group_proc(mmi_event_struct *evt);
static void mmi_tdl_br_entry_bday_view_int(void);
static mmi_ret mmi_tdl_br_view_group_proc(mmi_event_struct *evt);

/*****************************************************************************
 * Global Variable
 *****************************************************************************/
birthday_context_struct g_birth_cntx;

/*****************************************************************************
 * Local Function
 *****************************************************************************/ 
 #define LOCAL_FUNCTION


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_clear_buffer_cb
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_tdl_br_clear_buffer_cb(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_BIRTH_TRACE0(MMI_TDL_BIRTHDAY_CLEAR_BUFF);
    memset(&g_birth_cntx.temp_birth_info, 0, sizeof(mmi_tdl_birthday_struct));  
    g_birth_cntx.temp_birth_info.reminder_type = 0xFF;
    g_birth_cntx.is_add = MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_reminder_goback
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_reminder_goback(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_tdl_br_clear_buffer_cb();
    mmi_frm_scrn_close_active_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_entry_bday_edit_from_org
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_tdl_br_entry_bday_edit_from_org(mmi_id parent_id)
{    
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_br_edit_group_data_struct *edit_cntx;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__
    if (mmi_syncml_is_calendar_sync_now())
    {
        mmi_popup_display_simple((WCHAR*)(get_string(STR_ID_SYNC_CODE_FORBIDDEN)), MMI_EVENT_FAILURE, parent_id, NULL);
        return;
    }
#endif /* __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__ */

    edit_cntx = (mmi_br_edit_group_data_struct*)OslMalloc(sizeof(mmi_br_edit_group_data_struct));
    edit_cntx->edit_birth_info.bday_year = g_tdl_cntx.curr_event.start_time.nYear;
    edit_cntx->edit_birth_info.bday_month = g_tdl_cntx.curr_event.start_time.nMonth;
    edit_cntx->edit_birth_info.bday_day = g_tdl_cntx.curr_event.start_time.nDay;
    
    if (parent_id == GRP_ID_VCLNDR_SAVE_TO_TDL)
    {
        edit_cntx->edit_birth_info.flag = MMI_BR_ENTER_FILE;
    }
    else
    {
        edit_cntx->edit_birth_info.flag = MMI_BR_ENTER_ORG;
    }
    
    edit_cntx->edit_birth_info.reminder_type = g_tdl_cntx.curr_event.alarm.type;

    if (g_tdl_cntx.curr_event.alarm.type == MMI_TDL_ALARM_CUSTOM)
    {
        edit_cntx->edit_birth_info.reminder_type = MMI_BR_REMINDER_PREV_DAY;
    }
    else
    {
        edit_cntx->edit_birth_info.reminder_type = g_tdl_cntx.curr_event.alarm.type;
    }
    
    edit_cntx->edit_birth_info.store_idx = g_tdl_cntx.curr_event.extend;
    g_birth_cntx.curr_birth_info.name = (WCHAR*)&g_tdl_cntx.curr_event.subject;
    g_birth_cntx.curr_birth_info.store_idx = g_tdl_cntx.curr_event.extend;
    edit_cntx->parent_id = parent_id;
    g_birth_cntx.curr_store_idx = g_tdl_cntx.curr_store_idx;
    
    if (mmi_frm_group_is_present(GRP_ID_TDL_BR_REMINDER))
    {
        mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
    }

    edit_cntx->group_id = mmi_frm_group_create(
                                            parent_id,
                                            GRP_ID_TDL_BR_REMINDER,
                                            mmi_tdl_br_edit_group_proc,
                                            edit_cntx);

    mmi_frm_group_enter(
                GRP_ID_TDL_BR_REMINDER,
                MMI_FRM_NODE_SMART_CLOSE_FLAG);
    
    mmi_tdl_br_entry_bday_edit_int();
}




/*****************************************************************************
 * FUNCTION
 *  mmi_clndr_daily_group_proc
 * DESCRIPTION
 *  Exit function of task view all application
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static mmi_ret mmi_tdl_br_edit_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/    
    mmi_br_edit_group_data_struct *edit_cntx;
    mmi_group_event_struct send_evt;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    edit_cntx = (mmi_br_edit_group_data_struct*)evt->user_data;
    
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_DEINIT:        
        {
            OslMfree(edit_cntx);
            break;
        }
        case EVT_ID_CUI_INLINE_ABORT:
        {
            send_evt.evt_id = EVT_ID_TDL_SAVE_CANCEL;
            send_evt.user_data = NULL;
            send_evt.sender_id = GRP_ID_TDL_BR_REMINDER;
            mmi_frm_group_send_to_parent(GRP_ID_TDL_BR_REMINDER, (mmi_group_event_struct*)&send_evt); 

            /* GRP_ID_TDL_BR_REMINDER will be closed automatically when close inline gid */
            mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
            break;
        }
        case EVT_ID_POPUP_QUIT:
        {
            if (mmi_frm_group_is_present(GRP_ID_TDL_REMINDER))
            {
                mmi_frm_group_close(GRP_ID_TDL_REMINDER);
            }
            else
            {
                mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
            }
            break;
        }
        case EVT_ID_CUI_INLINE_SUBMIT:
        case EVT_ID_CUI_INLINE_CSK_PRESS:
        {
            cui_inline_get_value(
                    edit_cntx->cui_inline_gid, 
                    CUI_INLINE_ITEM_ID_BASE + 5, 
                    &edit_cntx->edit_birth_info.reminder_type);

            g_birth_cntx.curr_birth_info.reminder_type = edit_cntx->edit_birth_info.reminder_type;
            g_birth_cntx.curr_birth_info.store_idx = edit_cntx->edit_birth_info.store_idx;
            g_birth_cntx.curr_birth_info.bday_year = edit_cntx->edit_birth_info.bday_year;
            g_birth_cntx.curr_birth_info.bday_month = edit_cntx->edit_birth_info.bday_month;
            g_birth_cntx.curr_birth_info.bday_day = edit_cntx->edit_birth_info.bday_day;
            if (edit_cntx->edit_birth_info.flag == MMI_BR_ENTER_PHB)
            {            
                g_birth_cntx.is_add = MMI_TRUE;
                memcpy(&g_birth_cntx.curr_birth_info, &edit_cntx->edit_birth_info, sizeof(mmi_tdl_birthday_struct));
                g_birth_cntx.temp_birth_info.reminder_type = edit_cntx->edit_birth_info.reminder_type;
                mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
            }
            else if (edit_cntx->edit_birth_info.flag == MMI_BR_ENTER_FILE)
            {
                g_birth_cntx.is_add = MMI_TRUE;
                mmi_tdl_br_save_confirm(edit_cntx->group_id);
            }
            else
            {
                g_birth_cntx.is_add = MMI_FALSE;
                mmi_tdl_br_save_confirm(edit_cntx->group_id);
            }
            break;
        }
        default:
            break;
    }

    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_entry_bday_edit_from_phb
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_entry_bday_edit_from_phb(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_br_edit_group_data_struct *edit_cntx;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__
    if (mmi_syncml_is_calendar_sync_now())
    {
        mmi_popup_display_simple((WCHAR*)(get_string(STR_ID_SYNC_CODE_FORBIDDEN)), MMI_EVENT_FAILURE, parent_id, NULL);
        return;
    }
#endif /* __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__ */

    if (srv_tdl_is_full(SRV_TDL_VCAL_EVENT))
    {
        mmi_popup_display_simple((WCHAR*)(get_string(STR_ID_TDL_CAL_FULL)), MMI_EVENT_FAILURE, parent_id, NULL);
        return;
    }
    
    edit_cntx = (mmi_br_edit_group_data_struct*)OslMalloc(sizeof(mmi_br_edit_group_data_struct));
    edit_cntx->edit_birth_info.bday_year = g_birth_cntx.temp_birth_info.bday_year;
    edit_cntx->edit_birth_info.bday_month = g_birth_cntx.temp_birth_info.bday_month;
    edit_cntx->edit_birth_info.bday_day = g_birth_cntx.temp_birth_info.bday_day;
    edit_cntx->edit_birth_info.flag = MMI_BR_ENTER_PHB;
    edit_cntx->edit_birth_info.reminder_type = g_birth_cntx.temp_birth_info.reminder_type;
    
    edit_cntx->parent_id = parent_id;
    
    if (mmi_frm_group_is_present(GRP_ID_TDL_BR_REMINDER))
    {
        mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
    }
    edit_cntx->group_id = mmi_frm_group_create(
                                        parent_id,
                                        GRP_ID_TDL_BR_REMINDER,
                                        mmi_tdl_br_edit_group_proc,
                                        edit_cntx);
    mmi_frm_group_enter(
                    GRP_ID_TDL_BR_REMINDER,
                    MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_tdl_br_entry_bday_edit_int();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_entry_bday_edit_int
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_entry_bday_edit_int(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 title_id = STR_ID_BDAY_ALERT_EDIT;
    cui_inline_struct inline_data;
    CHAR *reminder_type[3];
    mmi_br_edit_group_data_struct *edit_cntx;

    /*----------------------------------------------------------------*/
    /* Code Body      												  */
    /*----------------------------------------------------------------*/
    edit_cntx = mmi_frm_group_get_user_data(GRP_ID_TDL_BR_REMINDER);
    reminder_type[0] = GetString(STR_ID_BDAY_REMINDER_NONE);
    reminder_type[1] = GetString(STR_ID_BDAY_REMINDER_SAME_DAY);
    reminder_type[2] = GetString(STR_ID_BDAY_REMINDER_PREV_DAY);

#if defined(__MMI_VCALENDAR__)
    if (g_tdl_cntx.curr_option == TODO_FROM_FMGR || 
        g_tdl_cntx.curr_option == TODO_FROM_APP ||
        g_tdl_cntx.curr_option == TODO_FROM_NETWORK)
    {
        title_id = STR_GLOBAL_ADD;
    }
#endif /* defined(__MMI_VCALENDAR__) */ 

    inline_data.items_count = 6;
    inline_data.title = title_id;
    inline_data.title_icon = GetRootTitleIcon(ORGANIZER_CALENDER_MENU);
    inline_data.screen_flag = CUI_INLINE_SCREEN_DISABLE_DONE;
    inline_data.softkey = NULL;
    inline_data.items = cui_birthday_edit_items;

    edit_cntx->cui_inline_gid = cui_inline_create(
                                        GRP_ID_TDL_BR_REMINDER,
                                        &inline_data);

    if (edit_cntx->cui_inline_gid != GRP_ID_INVALID)
    {
        kal_wsprintf(
                g_birth_cntx.birth_date_buff, 
                "%04d/%02d/%02d", 
                edit_cntx->edit_birth_info.bday_year, 
                edit_cntx->edit_birth_info.bday_month, 
                edit_cntx->edit_birth_info.bday_day);

        kal_wsprintf(
                g_birth_cntx.birth_time_buff, 
                "%02d:%02d", 
                MMI_BR_REMINDER_HOUR,
                0); 

        cui_inline_set_value(
                            edit_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 1, 
                            g_birth_cntx.birth_date_buff);
                            
        cui_inline_set_item_attributes(
                            edit_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 1, 
                            CUI_INLINE_SET_ATTRIBUTE,
                            CUI_INLINE_ITEM_DISABLE);

        cui_inline_set_value(
                            edit_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 3, 
                            g_birth_cntx.birth_time_buff);

        cui_inline_set_item_attributes(
                            edit_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 3, 
                            CUI_INLINE_SET_ATTRIBUTE,
                            CUI_INLINE_ITEM_DISABLE);
                            
        cui_inline_set_item_select(
                            edit_cntx->cui_inline_gid,
                            CUI_INLINE_ITEM_ID_BASE + 5,
                            3,
                            (PU8*)reminder_type,
                            edit_cntx->edit_birth_info.reminder_type);

        cui_inline_set_highlight_item(
                            edit_cntx->cui_inline_gid,
                            CUI_INLINE_ITEM_ID_BASE + 5);
                            
        cui_inline_run(edit_cntx->cui_inline_gid);
    }
    else
    {
        mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_entry_bday_view_from_org
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_tdl_br_entry_bday_view_from_org(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_br_view_group_data_struct *view_cntx;    

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    view_cntx = (mmi_br_view_group_data_struct*)OslMalloc(sizeof(mmi_br_view_group_data_struct));
    view_cntx->view_birth_info.bday_year = g_tdl_cntx.curr_event.start_time.nYear;
    view_cntx->view_birth_info.bday_month = g_tdl_cntx.curr_event.start_time.nMonth;
    view_cntx->view_birth_info.bday_day = g_tdl_cntx.curr_event.start_time.nDay;
    view_cntx->view_birth_info.flag = MMI_BR_ENTER_ORG;
    
    if (g_tdl_cntx.curr_event.alarm.type == MMI_TDL_ALARM_CUSTOM)
    {
        view_cntx->view_birth_info.reminder_type = MMI_BR_REMINDER_PREV_DAY;
    }
    else
    {
        view_cntx->view_birth_info.reminder_type = g_tdl_cntx.curr_event.alarm.type;
    }
    
    view_cntx->parent_id = parent_id;
    
    if (mmi_frm_group_is_present(GRP_ID_TDL_BR_VIEW))
    {
        mmi_frm_group_close(GRP_ID_TDL_BR_VIEW);
    }

    view_cntx->group_id = mmi_frm_group_create(
                                    parent_id,
                                    GRP_ID_TDL_BR_VIEW,
                                    mmi_tdl_br_view_group_proc,
                                    view_cntx);

    mmi_frm_group_enter(
                GRP_ID_TDL_BR_VIEW,
                MMI_FRM_NODE_SMART_CLOSE_FLAG);
    
    mmi_tdl_br_entry_bday_view_int();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_entry_bday_view_int
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_entry_bday_view_int(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_inline_struct inline_data;
    CHAR *reminder_type[3];
    mmi_br_view_group_data_struct *view_cntx;

    /*----------------------------------------------------------------*/
    /* Code Body      												  */
    /*----------------------------------------------------------------*/
    view_cntx = mmi_frm_group_get_user_data(GRP_ID_TDL_BR_VIEW);
   
    reminder_type[0] = GetString(STR_ID_BDAY_REMINDER_NONE);
    reminder_type[1] = GetString(STR_ID_BDAY_REMINDER_SAME_DAY);
    reminder_type[2] = GetString(STR_ID_BDAY_REMINDER_PREV_DAY);

    inline_data.items_count = 6;
    inline_data.title = STR_ID_BDAY_ALERT_EDIT;
    inline_data.title_icon = GetRootTitleIcon(ORGANIZER_CALENDER_MENU);
    inline_data.screen_flag = CUI_INLINE_SCREEN_DISABLE_DONE;
    inline_data.softkey = NULL;
    inline_data.items = cui_birthday_view_items;

    view_cntx->cui_inline_gid = cui_inline_create(
                                        GRP_ID_TDL_BR_VIEW,
                                        &inline_data);

    if (view_cntx->cui_inline_gid != GRP_ID_INVALID)
    {
        kal_wsprintf(
                g_birth_cntx.birth_date_buff, 
                "%04d/%02d/%02d", 
                view_cntx->view_birth_info.bday_year, 
                view_cntx->view_birth_info.bday_month, 
                view_cntx->view_birth_info.bday_day);

        kal_wsprintf(
                g_birth_cntx.birth_time_buff, 
                "%02d:%02d", 
                MMI_BR_REMINDER_HOUR,
                0); 
        

        cui_inline_set_value(
                            view_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 1, 
                            g_birth_cntx.birth_date_buff);
                            
        cui_inline_set_item_attributes(
                            view_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 1, 
                            CUI_INLINE_SET_ATTRIBUTE,
                            CUI_INLINE_ITEM_DISABLE);
                            
        cui_inline_set_value(
                            view_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 3, 
                            g_birth_cntx.birth_time_buff);

        cui_inline_set_item_attributes(
                            view_cntx->cui_inline_gid, 
                            CUI_INLINE_ITEM_ID_BASE + 3, 
                            CUI_INLINE_SET_ATTRIBUTE,
                            CUI_INLINE_ITEM_DISABLE);

        cui_inline_set_value(
                            view_cntx->cui_inline_gid,
                            CUI_INLINE_ITEM_ID_BASE + 5,
                            reminder_type[view_cntx->view_birth_info.reminder_type]);
                
        cui_inline_set_softkey_text(
                            view_cntx->cui_inline_gid,
                            CUI_INLINE_ITEM_ID_BASE + 5,
                            MMI_LEFT_SOFTKEY,
                            STR_GLOBAL_EDIT);

        cui_inline_run(view_cntx->cui_inline_gid);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_view_group_proc
 * DESCRIPTION
 *  Exit function of task view all application
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static mmi_ret mmi_tdl_br_view_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/    
    mmi_br_view_group_data_struct *view_cntx;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    view_cntx = (mmi_br_view_group_data_struct*)evt->user_data;
    
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_ACTIVE:
        case EVT_ID_GROUP_INACTIVE:
            break;

        case EVT_ID_GROUP_DEINIT:
        {
            /* need addd code to release buffer */
            view_cntx->cui_inline_gid = GRP_ID_INVALID;
            OslMfree(view_cntx);
            break;
        }
        case EVT_ID_CUI_INLINE_ABORT:
        {
            mmi_frm_group_close(GRP_ID_TDL_VIEW);
            break;
        }
        case EVT_ID_CUI_INLINE_SUBMIT: 
        case EVT_ID_CUI_INLINE_CSK_PRESS:
        {
            /* enter from calendar */
            if (mmi_frm_group_is_present(GRP_ID_CAL_MAIN))
            {
                mmi_tdl_br_view_to_edit(GRP_ID_CAL_MAIN);
            }
            /* enter from homescreen on idle */
            else
            {
                mmi_tdl_br_view_to_edit(GRP_ID_ROOT);
            }
            mmi_frm_group_close(GRP_ID_TDL_VIEW);
            break;
        }
        default:
            break;
    }

    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_view_to_edit
 * DESCRIPTION
 *  Edit to do list task from View screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_view_to_edit(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_tdl_cntx.curr_option = TODO_LIST_TASK_OPTION_EDIT;
    mmi_tdl_br_entry_bday_edit_from_org(parent_id);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_save_confirm
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_save_confirm(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_confirm_property_struct arg;    

    /*----------------------------------------------------------------*/
    /* Code Body      												  */
    /*----------------------------------------------------------------*/   
    g_birth_cntx.ui_mode = MMI_TRUE;    
    mmi_confirm_property_init(&arg, CNFM_TYPE_YESNO);
    arg.parent_id = parent_id;
    arg.callback = (mmi_proc_func)mmi_tdl_comfirm_proc;

    mmi_tdl_confirm_user_data_init(&g_tdl_confirm_user_data);
    g_tdl_confirm_user_data.sg_id = parent_id;
    
    /* add from filemgr or phb */
    if (g_birth_cntx.is_add == MMI_TRUE)
    {
        g_tdl_confirm_user_data.LSK_function = mmi_tdl_br_add;
        g_tdl_confirm_user_data.RSK_function = mmi_tdl_br_save_confirm_no;
    }
    else
    /* enter from calendar */
    {
        g_tdl_confirm_user_data.LSK_function = mmi_tdl_br_update;        
        g_tdl_confirm_user_data.RSK_function = mmi_tdl_br_save_confirm_no;
    }
    arg.user_tag = (void*)&g_tdl_confirm_user_data;
    mmi_confirm_display(
        (WCHAR*)get_string(STR_GLOBAL_SAVE_ASK),
        MMI_EVENT_QUERY,
        &arg);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_save_confirm
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_save_confirm_no(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_group_event_struct send_evt;
    

    /*----------------------------------------------------------------*/
    /* Code Body      												  */
    /*----------------------------------------------------------------*/
    send_evt.evt_id = EVT_ID_TDL_SAVE_CANCEL;
    send_evt.user_data = NULL;
    send_evt.sender_id = GRP_ID_TDL_BR_REMINDER;
    g_birth_cntx.is_add = MMI_FALSE;

    mmi_frm_group_send_to_parent(GRP_ID_TDL_BR_REMINDER, (mmi_group_event_struct*)&send_evt); 
    
    /* GRP_ID_TDL_BR_REMINDER will be closed automatically when close inline gid */
    mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_is_delete_show_confirm
 * DESCRIPTION
 *  Ask whether to add it to todolist.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_tdl_br_is_delete_show_confirm(U16 store_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL show_confirm = MMI_FALSE;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* The birthday to delete is saved in calendar */
    if (mmi_tdl_br_get_store_index(store_index) != 0xFFFF)
    {
        show_confirm = MMI_TRUE;
    }

    /* At this time, the birthday to delete is in viewing. */
    if ((mmi_tdl_br_get_store_index(store_index) == g_tdl_cntx.curr_store_idx) &&
        (mmi_frm_group_is_present(GRP_ID_TDL_BR_VIEW) ||
         mmi_frm_group_is_present(GRP_ID_TDL_BR_REMINDER)))
    {
        show_confirm = MMI_FALSE;
    }  

    #ifdef __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__
    if (mmi_syncml_is_calendar_sync_now())
    {
        show_confirm = MMI_FALSE;
    }
    #endif /* __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__ */

    MMI_BIRTH_TRACE1(MMI_TDL_IS_BIRTHDAT_SHOW_CONFIRM, show_confirm);
    return show_confirm;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_is_store_index_exist
 * DESCRIPTION
 *  Ask whether to add it to todolist.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static U16 mmi_tdl_br_get_store_index(U16 phn_book_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_tdl_event_short_struct *pevent;
    U16 i;	
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < NUM_OF_CAL; i++)
    {
        srv_tdl_get_cache(
                    (void*)&pevent, 
                    sizeof(srv_tdl_event_short_struct), 
                    SRV_TDL_VCAL_EVENT,
                    i);

        if (pevent->category == MMI_TDL_CATEGORY_BIRTHDAY &&
            pevent->extend == phn_book_index)
        {      
            MMI_BIRTH_TRACE1(MMI_TDL_BIRTHDAY_GET_STORE_INDEX, i);
            return i;
        }
    }

    MMI_BIRTH_TRACE0(MMI_TDL_BIRTHDAY_GET_STORE_INDEX_RETURN);
    return 0xFFFF;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_add
 * DESCRIPTION
 *  Ask whether to add it to todolist.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_add(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_tdl_event_struct *event = OslMalloc(sizeof(srv_tdl_event_struct));    
    U16 index;
    MYTIME dec_time;
    U16 result;
    U16 popup_string = STR_GLOBAL_SAVED;
    mmi_event_notify_enum popup_type = MMI_EVENT_SUCCESS;
    cui_tdl_save_result_struct send_evt;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/  
    memset(event, 0, sizeof(srv_tdl_event_struct));

    /* Set birthday buffer */
    event->present = MMI_TRUE;
    event->all_day = MMI_TRUE;
    event->category = MMI_TDL_CATEGORY_BIRTHDAY;
    event->repeat.rule = MMI_TDL_RULE_YEARLY;
    event->start_time.nYear = g_birth_cntx.curr_birth_info.bday_year;
    event->start_time.nMonth = g_birth_cntx.curr_birth_info.bday_month;
    event->start_time.nDay = g_birth_cntx.curr_birth_info.bday_day;
    event->start_time.nHour = MMI_BR_REMINDER_HOUR;
    memcpy(&event->end_time, &event->start_time, sizeof(MYTIME));
    event->extend = g_birth_cntx.curr_birth_info.store_idx;
    if (g_birth_cntx.curr_birth_info.reminder_type != 0xFF)
    {
        event->alarm.type = g_birth_cntx.curr_birth_info.reminder_type;
        if (event->alarm.type == MMI_BR_REMINDER_PREV_DAY)
        {
            event->alarm.type = MMI_TDL_ALARM_CUSTOM;
            
            memcpy(&(event->alarm.first_launch), &(event->start_time), sizeof(MYTIME));
            memset(&dec_time, 0, sizeof(MYTIME));
            dec_time.nDay = 1;
            
            DecrementTime(event->alarm.first_launch, dec_time, &(event->alarm.first_launch));
        }
        else if (event->alarm.type == MMI_BR_REMINDER_SAME_DAY)
        {
            event->alarm.type = MMI_TDL_ALARM_ON;
            memcpy(&(event->alarm.first_launch), &(event->start_time), sizeof(MYTIME));
        }
        else if (event->alarm.type == MMI_BR_REMINDER_NONE)
        {
            /* do nothing */
        }
    }
    if (0 != mmi_ucs2strlen((CHAR*)(g_birth_cntx.curr_birth_info.name)))
    {
        mmi_ucs2ncpy((CHAR*)event->subject, (CHAR*)g_birth_cntx.curr_birth_info.name, MAX_TODO_NOTE_LEN - 1);
    }
    else
    {
        mmi_ucs2ncpy((CHAR*)event->subject, GetString(STR_ID_TDL_NO_NAME), MAX_TODO_NOTE_LEN - 1);
    }
    
    result = srv_tdl_add(
                 (void*)event, 
                 SRV_TDL_VCAL_EVENT, 
                 &index);
    
    if (g_birth_cntx.ui_mode)
    {    
        if (result != SRV_TDL_RESULT_OK)
        {
            if (result == SRV_TDL_RESULT_ADD_NOT_ENOUGH_MEMORY)
            {
                popup_string = STR_ID_TDL_CAL_FULL;
            }
            else
            {
                popup_string = STR_GLOBAL_FAILED_TO_SAVE;
            }
            popup_type = MMI_EVENT_FAILURE;
        }
        mmi_popup_display_simple((WCHAR*)(get_string(popup_string)), popup_type, GRP_ID_ROOT, NULL);
    }

    OslMfree(event);

    memset(&send_evt, 0, sizeof(cui_tdl_save_result_struct));
    if (result != SRV_TDL_RESULT_OK)
    {
        send_evt.evt_id = EVT_ID_TDL_SAVE_FAIL;
    }
    else
    {
        send_evt.evt_id = EVT_ID_TDL_SAVE_SUCCESS;
    }
    mmi_frm_group_send_to_parent(GRP_ID_TDL_BR_REMINDER, (mmi_group_event_struct*)&send_evt); 

    /* if enter addition from CMCC phb, there no our GRP_ID_TDL_BR_REMINDER, so the following code will be fatal error,
        should add "mmi_frm_group_is_present(GRP_ID_TDL_BR_REMINDER)" */
    mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_br_update
 * DESCRIPTION
 *  Ask whether to add it to todolist.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_tdl_br_update(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/	
    srv_tdl_event_struct *event = OslMalloc(sizeof(srv_tdl_event_struct));
    MYTIME dec_time;
    U16 result;
    U16 popup_string = STR_GLOBAL_SAVED;
    mmi_event_notify_enum popup_type = MMI_EVENT_SUCCESS;
    cui_tdl_save_result_struct send_evt;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    memset(event, 0, sizeof(srv_tdl_event_struct));

    /* Set birthday buffer */
    event->present = MMI_TRUE;
    event->all_day = MMI_TRUE;
    event->category = MMI_TDL_CATEGORY_BIRTHDAY;
    event->repeat.rule = MMI_TDL_RULE_YEARLY;
    event->start_time.nYear = g_birth_cntx.curr_birth_info.bday_year;
    event->start_time.nMonth = g_birth_cntx.curr_birth_info.bday_month;
    event->start_time.nDay = g_birth_cntx.curr_birth_info.bday_day;
    event->start_time.nHour = MMI_BR_REMINDER_HOUR;
    memcpy(&event->end_time, &event->start_time, sizeof(MYTIME));
    event->extend = g_birth_cntx.curr_birth_info.store_idx;
    if (g_birth_cntx.curr_birth_info.reminder_type != 0xFF)
    {
        event->alarm.type = g_birth_cntx.curr_birth_info.reminder_type;
        if (event->alarm.type == MMI_BR_REMINDER_PREV_DAY)
        {
            event->alarm.type = MMI_TDL_ALARM_CUSTOM;
            
            memcpy(&(event->alarm.first_launch), &(event->start_time), sizeof(MYTIME));
            memset(&dec_time, 0, sizeof(MYTIME));
            dec_time.nDay = 1;
            
            DecrementTime(event->alarm.first_launch, dec_time, &(event->alarm.first_launch));
        }
        else if (event->alarm.type == MMI_BR_REMINDER_SAME_DAY)
        {
            event->alarm.type = MMI_TDL_ALARM_ON;
            memcpy(&(event->alarm.first_launch), &(event->start_time), sizeof(MYTIME));
        }
        else if (event->alarm.type == MMI_BR_REMINDER_NONE)
        {
            /* do nothing */
        }

    }
    if (0 != mmi_ucs2strlen((CHAR*)(g_birth_cntx.curr_birth_info.name)))
    {
        mmi_ucs2ncpy((CHAR*)event->subject, (CHAR*)g_birth_cntx.curr_birth_info.name, MAX_TODO_NOTE_LEN - 1);
    }
    else
    {
        mmi_ucs2ncpy((CHAR*)event->subject, GetString(STR_ID_TDL_NO_NAME), MAX_TODO_NOTE_LEN - 1);
    }
    
    result = srv_tdl_update(
                    (void*)event, 
                    SRV_TDL_VCAL_EVENT, 
                    g_birth_cntx.curr_store_idx);

    if (g_birth_cntx.ui_mode)
    {    
        if (result != SRV_TDL_RESULT_OK)
        {
            if (result == SRV_TDL_RESULT_ADD_NOT_ENOUGH_MEMORY)
            {
                popup_string = STR_ID_TDL_CAL_FULL;
            }
            else
            {
                popup_string = STR_GLOBAL_FAILED_TO_SAVE;
            }
            popup_type = MMI_EVENT_FAILURE;
        }
        mmi_popup_display_simple((WCHAR*)(get_string(popup_string)), popup_type, GRP_ID_ROOT, NULL);
    }

    OslMfree(event);
    
    memset(&send_evt, 0, sizeof(cui_tdl_save_result_struct));
    if (result != SRV_TDL_RESULT_OK)
    {
        send_evt.evt_id = EVT_ID_TDL_SAVE_FAIL;
    }
    else
    {
        send_evt.evt_id = EVT_ID_TDL_SAVE_SUCCESS;
    }
    mmi_frm_group_send_to_parent(GRP_ID_TDL_BR_REMINDER, (mmi_group_event_struct*)&send_evt); 


	if (mmi_frm_group_is_present(GRP_ID_TDL_REMINDER))
    {
	    mmi_tdl_dismiss_reminder();
    }

    /* if enter addition from CMCC phb, there no our GRP_ID_TDL_BR_REMINDER, so the following code will be fatal error,
    should add "mmi_frm_group_is_present(GRP_ID_TDL_BR_REMINDER)" */
    mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);
}

/*****************************************************************************
 * Global Function
 *****************************************************************************/
 #define GLOBAL_FUNCTIION
 /*****************************************************************************
  * FUNCTION
  *  mmi_tdl_br_delete
  * DESCRIPTION
  *  Ask whether to delete it from todolist.
  * PARAMETERS
  *  void
  * RETURNS
  *  void
  *****************************************************************************/
 void mmi_tdl_br_delete(U16 store_index)
 {
     /*----------------------------------------------------------------*/
     /* Local Variables                                                */
     /*----------------------------------------------------------------*/
     U16 birthday_index;
     
     /*----------------------------------------------------------------*/
     /* Code Body                                                      */
     /*----------------------------------------------------------------*/
#ifdef __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__
    if (mmi_syncml_is_calendar_sync_now())
    {
        /* if syncing calendar, do not promot the popup */
        mmi_tdl_br_delete_no(store_index);
        return;
    }
#endif /* __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__ */

     birthday_index = mmi_tdl_br_get_store_index(store_index);
     if (birthday_index == 0xFFFF)
     {
         return;
     }
     
     if(birthday_index >= NUM_OF_CAL)
     {
         return;
     }
     srv_tdl_delete(birthday_index, SRV_TDL_VCAL_EVENT);
     mmi_tdl_delete_all_history();
 }
 
 
 /*****************************************************************************
  * FUNCTION
  *  mmi_tdl_br_delete_no
  * DESCRIPTION
  *  Ask whether to delete it from todolist. The record has been deleted from phb
  *  if user press no, only reset the mapping between phb and birthday
  * PARAMETERS
  *  void
  * RETURNS
  *  void
  *****************************************************************************/
 void mmi_tdl_br_delete_no(U16 store_index)
 {
     /*----------------------------------------------------------------*/
     /* Local Variables                                                */
     /*----------------------------------------------------------------*/
     srv_tdl_event_struct *pevent;
     U16 birthday_index;
 
     /*----------------------------------------------------------------*/
     /* Code Body                                                      */
     /*----------------------------------------------------------------*/
     birthday_index = mmi_tdl_br_get_store_index(store_index);
 
     if (birthday_index == 0xFFFF)
     {
         return;
     }
     
     pevent = OslMalloc(sizeof(srv_tdl_event_struct));
     srv_tdl_get(
             pevent, 
             sizeof(srv_tdl_event_struct), 
             SRV_TDL_VCAL_EVENT, 
             birthday_index);
 
     pevent->extend = 0xFFFF;
 
     srv_tdl_update(
             pevent, 
             SRV_TDL_VCAL_EVENT, 
             birthday_index);
             
     OslMfree(pevent);
 }
 


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_birthday_add_confirm
 * DESCRIPTION
 *  Ask usr whether to set birthday alert in todolist
 * PARAMETERS
 *  U16		[IN]	store_index
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_tdl_birthday_add_confirm(mmi_id parent_id, U16 store_idx, MYTIME *birthday)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_tdl_event_struct *pevent = NULL;
    mmi_confirm_property_struct arg;    
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_BIRTH_TRACE3(MMI_TDL_BIRTHDAY_ADD_CONFIRM_BR, birthday->nYear, birthday->nMonth, birthday->nDay);
    MMI_BIRTH_TRACE1(MMI_TDL_BIRTHDAY_ADD_CONFIRM_INDEX, store_idx);
    mmi_frm_group_close(GRP_ID_TDL_BR_VIEW);
    mmi_frm_group_close(GRP_ID_TDL_BR_REMINDER);

    birthday->nHour = 0;
    birthday->nMin = 0;
    birthday->nSec = 0;
    
    if (!applib_dt_check_valid_by_app(1900, 2030, (applib_time_struct*)birthday))
    {
    	return;
    }
    
    /* 
     * Condition 1: Update an exited birthday reminder, whose phonebook index exists and not 0xFFFF.
     * Condition 2: The second time to edit the birthday reminder in an UPDATE operation.
     */
    if ((mmi_tdl_br_get_store_index(store_idx) != 0xFFFF && store_idx != 0xFFFF) ||
        g_birth_cntx.temp_birth_info.bday_year != 0)
    {
        g_birth_cntx.temp_birth_info.bday_year = birthday->nYear;
        g_birth_cntx.temp_birth_info.bday_month = birthday->nMonth;
        g_birth_cntx.temp_birth_info.bday_day = birthday->nDay;
        
        /* 
         * If the store index exists, means to update the reminder, then the reminder type should 
         * be readed from nvram.
         */
        if (mmi_tdl_br_get_store_index(store_idx) != 0xFFFF && store_idx != 0xFFFF)
        {
            pevent = (srv_tdl_event_struct*)OslMalloc(sizeof(srv_tdl_event_struct));         
            srv_tdl_get(
                    (void*)pevent, 
                    sizeof(srv_tdl_event_struct), 
                    SRV_TDL_VCAL_EVENT,
                    mmi_tdl_br_get_store_index(store_idx));                    
            g_birth_cntx.temp_birth_info.reminder_type = pevent->alarm.type;
            OslMfree(pevent);
        }
        return;
    }

    g_birth_cntx.temp_birth_info.bday_year = birthday->nYear;
    g_birth_cntx.temp_birth_info.bday_month = birthday->nMonth;
    g_birth_cntx.temp_birth_info.bday_day = birthday->nDay;
    g_birth_cntx.temp_birth_info.reminder_type = MMI_BR_REMINDER_PREV_DAY;

    mmi_confirm_property_init(&arg, CNFM_TYPE_YESNO);
    arg.parent_id = parent_id;
    arg.callback = (mmi_proc_func)mmi_tdl_comfirm_proc;

    mmi_tdl_confirm_user_data_init(&g_tdl_confirm_user_data);
    g_tdl_confirm_user_data.sg_id = parent_id;
    g_tdl_confirm_user_data.LSK_function = mmi_tdl_br_entry_bday_edit_from_phb;
    g_tdl_confirm_user_data.RSK_function = mmi_tdl_br_reminder_goback;
    arg.user_tag = (void*)&g_tdl_confirm_user_data;
    mmi_confirm_display(
        (WCHAR*)get_string(STR_ID_BDAY_ALERT_ADD_QUERY),
        MMI_EVENT_QUERY,
        &arg);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_add_birthday_result_callback
 * DESCRIPTION
 *  will call this api to update once phb birthday is edited;
 * PARAMETERS
 *  SelectedDate        [IN]        
 * RETURNS
 *  
 *****************************************************************************/
void mmi_tdl_birthday_add_result_callback(MMI_BOOL result, mmi_tdl_birthday_struct *birthday_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_tdl_event_struct *pevent;
    U16 cal_store_idx;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_BIRTH_TRACE1(MMI_TDL_BIRTHDAY_ADD_RESULT_CALLBACK, result);
    
    if (MMI_FALSE == result || NULL == birthday_info)
    {
        goto ERROR_HDLR;
    }

#ifdef __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__
    if (mmi_syncml_is_calendar_sync_now())
    {
        goto ERROR_HDLR;
    }
#endif /* __MMI_SYNCML_SYNC_CALENDAR_SUPPORT__ */

    cal_store_idx = mmi_tdl_br_get_store_index((U16)birthday_info->store_idx);

    if ((cal_store_idx == 0xFFFF && g_birth_cntx.is_add == MMI_TRUE) 
        || cal_store_idx != 0xFFFF)
    {
        g_birth_cntx.curr_birth_info.store_idx = birthday_info->store_idx;
        g_birth_cntx.curr_birth_info.name = birthday_info->name;
        g_birth_cntx.curr_birth_info.bday_year = birthday_info->bday_year;
        g_birth_cntx.curr_birth_info.bday_month = birthday_info->bday_month;
        g_birth_cntx.curr_birth_info.bday_day = birthday_info->bday_day;

        if (g_birth_cntx.temp_birth_info.reminder_type != 0xFF)
        {
            g_birth_cntx.curr_birth_info.reminder_type = g_birth_cntx.temp_birth_info.reminder_type;
        }
        // update
        if (birthday_info->store_idx != 0xFFFF && cal_store_idx != 0xFFFF)
        {
            g_tdl_cntx.curr_store_idx = cal_store_idx;
            g_birth_cntx.curr_store_idx = cal_store_idx;
            g_birth_cntx.ui_mode = MMI_FALSE;

            if (g_birth_cntx.temp_birth_info.reminder_type == 0xFF)
            {
                pevent = (srv_tdl_event_struct*)OslMalloc(sizeof(srv_tdl_event_struct));
                srv_tdl_get(pevent, sizeof(srv_tdl_event_struct), SRV_TDL_VCAL_EVENT, g_tdl_cntx.curr_store_idx);
                g_birth_cntx.curr_birth_info.reminder_type = pevent->alarm.type;
                OslMfree(pevent);
            }
            else
            {
                g_birth_cntx.curr_birth_info.reminder_type = g_birth_cntx.temp_birth_info.reminder_type;
            }
            mmi_tdl_br_update(GRP_ID_TDL_BR_REMINDER);
        }
        // add
        else if (!srv_tdl_is_full(SRV_TDL_VCAL_EVENT))
        {
            g_birth_cntx.ui_mode = MMI_FALSE;
            mmi_tdl_br_add(GRP_ID_TDL_BR_REMINDER);
        }
    }

ERROR_HDLR:
    mmi_tdl_br_clear_buffer_cb();
    mmi_tdl_delete_all_history();
}


void mmi_tdl_br_add_reminder_entry_edit(mmi_id parent_id, U16 store_idx, MYTIME *birthday)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_tdl_event_struct *event = NULL;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    birthday->nHour = 0;
    birthday->nMin = 0;
    birthday->nSec = 0;

    if (srv_tdl_is_full(SRV_TDL_VCAL_EVENT) &&
        g_tdl_cntx.curr_option != TODO_LIST_TASK_OPTION_EDIT)
    {
        mmi_popup_display_simple((WCHAR*)(get_string(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, parent_id, NULL);
        return;
    }
    
    if (!applib_dt_check_valid_by_app(1900, 2030, (applib_time_struct*)birthday))
    {
    	return;
    }
    
    if (mmi_tdl_br_get_store_index(store_idx) != 0xFFFF && store_idx != 0xFFFF)
    {
        event = (srv_tdl_event_struct*)OslMalloc(sizeof(srv_tdl_event_struct));
        srv_tdl_get(
                event,
                sizeof(srv_tdl_event_struct),
                SRV_TDL_VCAL_EVENT,
                mmi_tdl_br_get_store_index(store_idx));
 
        if (event->alarm.type == MMI_TDL_ALARM_CUSTOM)
        {
             g_birth_cntx.temp_birth_info.reminder_type = MMI_BR_REMINDER_PREV_DAY;
        }
        else
        {
            g_birth_cntx.temp_birth_info.reminder_type = event->alarm.type;
        }
        OslMfree(event);
    }
    else
    {
        g_birth_cntx.temp_birth_info.reminder_type = MMI_BR_REMINDER_PREV_DAY;
    }
    /* Set birthday buffer */
    g_birth_cntx.temp_birth_info.bday_year = birthday->nYear;
    g_birth_cntx.temp_birth_info.bday_month = birthday->nMonth;
    g_birth_cntx.temp_birth_info.bday_day = birthday->nDay;
    mmi_tdl_br_entry_bday_edit_from_phb(parent_id);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_phb_deletion_proc
 * DESCRIPTION
 *  deletion notification to update birthday
 * PARAMETERS
 *  event              [IN]            event structure
 * RETURNS
 *  mmi_ret
 *****************************************************************************/
static mmi_ret mmi_tdl_phb_deletion_post(mmi_event_struct* param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_phb_op_evt_struct* evt = (srv_phb_op_evt_struct*)(param);
    U16 birthday_index;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    birthday_index = mmi_tdl_br_get_store_index(evt->store_index);
    
    /* the mapping do not exist */
    if (birthday_index == 0xFFFF)
    {
         return MMI_RET_OK;
    }
    
    if (srv_phb_get_storage(evt->store_index) == PHB_STORAGE_NVRAM)
    {
        mmi_tdl_br_delete_no(evt->store_index);
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_tdl_phb_deletion_proc
 * DESCRIPTION
 *  deletion notification to update birthday
 * PARAMETERS
 *  event              [IN]            event structure
 * RETURNS
 *  mmi_ret
 *****************************************************************************/
mmi_ret mmi_tdl_phb_deletion_proc(mmi_event_struct* param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_phb_op_evt_struct* evt = (srv_phb_op_evt_struct*)param;
    srv_phb_op_evt_struct phb_evt;
    U16 birthday_index;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    birthday_index = mmi_tdl_br_get_store_index(evt->store_index);
    
    /* the mapping do not exist */
    if (birthday_index == 0xFFFF)
    {
         return MMI_RET_OK;
    }

	MMI_FRM_INIT_EVENT(&phb_evt, 0xFFFE);
    phb_evt.store_index = evt->store_index;
	mmi_frm_post_event((mmi_event_struct*)&phb_evt, mmi_tdl_phb_deletion_post, NULL);
    return MMI_RET_OK;
}
    
#endif /* __MMI_BIRTHDAY_REMINDER__ */
#endif /* MMI_BIRTHDAY_C */

