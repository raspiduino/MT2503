/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/
/*****************************************************************************
 *
 * Filename:
 * ---------
 *  PhoneBookpbapcEx.c
 *
 * Project:
 * -------- 
 *  MAUI
 *
 * Description:
 * ------------
 *  PBAPC
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/


#include "MMI_features.h"

#if defined(__MMI_BT_PBAP_CLIENT__)
#include "PhbpbapSrvGprot.h"

#if defined(__MMI_PHB_PBAPC_SYNC_CONTACT__) && !defined(__MMI_WEARABLE_DEVICE__)
#include "gui_typedef.h"
#include "PhoneBookpbapcEx.h"
#include "mmi_rp_app_bluetooth_def.h"
#include "wgui_fixed_menus.h"
#include "wgui_categories_util.h"
#include "BTMMIScrGprots.h"
//#include ".\..\..\plutommi\Framework\Scenario\mmi_frm_scenario_prot.h"
#include "CommonScreensResDef.h"
#include "wgui_include.h"
#include "BtcmSrvGprot.h"
#include "btcmsrvgprot.h"
#include "BTMMIScrGprots.h"
#include "mmi_frm_prot.h"


//#define PBAPC_UNIT_TEST
//#define __MMI_TELEPHONY_SUPPORT__

U8 g_test_flag = 0;

/* user data info */
/*******************************
0xbabe0001 read pse contact from pse list call

0xbabe0002   list call select number

0xbabe0003   cui list pre select contact

0xbabe0004  pre select contact select number

0xbabe0005  notify evt

********************************/


/* global */
extern S32 g_phb_pbapc_show_symbol;
extern WCHAR g_device_name[SRV_PBAPC_LINK_NUM][SRV_BT_CM_BD_UCS2_NAME_LEN];

mmi_phb_pbapc_cntx_struct g_mmi_phb_pbapc_cntx;
#if defined(__MMI_PHB_QUICK_SEARCH__)
extern S32(*g_phb_pbapc_search_function) (U8 *);
#endif

mmi_phb_pbapc_for_connect_struct g_for_connect;

static void mmi_phb_pbapc_con_profile_cb
    (srv_bt_cm_bt_addr *dev_addr, srv_bt_cm_connection_type conn_type, MMI_BOOL result, MMI_BOOL is_connect, MMI_BOOL is_indicate);
static void mmi_phb_pbapc_pse_list_op_option_back(void);
static void mmi_phb_pbapc_covert_data(mmi_phb_pbapc_phb_info_struct *phb_info);
static void mmi_phb_pbapc_update_sync_status_hdlr(mmi_event_struct *evt);
static S32 mmi_phb_pbapc_is_connect(void);

static void mmi_phb_pbapc_view_contact_op(void);
static S32 mmi_phb_pbapc_bt_set_index_cb(srv_pbapc_query_req_struct *req);
static void mmi_phb_pbapc_sync_data(void);
void cui_phb_pbapc_bt_send_select_result(mmi_phb_pbapc_phb_info_struct *pse_phb, S32 ret);
static void mmi_phb_pbapc_show_no_contact_list(void);
static void mmi_phb_pbapc_build_contact_list(U8 bt_index, srv_phb_qsearch_filter_struct* qsearch_filter);

extern void mmi_phb_launch_entry(void);

extern void mmi_phb_launch_exit(void);
#if defined(__MMI_BT_PBAP_CLIENT__)
extern MMI_BOOL g_wgui_cat199_has_default_hilight_item;
#endif

/* func */
mmi_phb_pbapc_cntx_struct *mmi_phb_pbapc_get_cntx(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return &g_mmi_phb_pbapc_cntx;
}


void mmi_phb_pbapc_entry_list_tab(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_ret ret = 0;
    srv_phb_qsearch_filter_struct qsearch_filter;
    MMI_ID scr_id ;
    U8 index;
    S32 ret_connect;
    srv_phb_pbapc_btd_enum bt_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();


    if (phb_pbapc_cntx_p->list_type == 0)
    {
#ifdef __MMI_TAB_BAR_SUPPORT_TAB_PAGE__
        index = cui_tab_get_select_index(SCR_PBOOK_MAIN_MENU);
#else
        index = mmi_frm_scrn_tab_get_active_page_index(); 
#endif  
#ifndef __MMI_TELEPHONY_SUPPORT__

        if (index == 0)
        {
            scr_id = SCR_ID_PHB_PBAP_LIST;
        }
        else if (index == 1)
        {
            scr_id = SCR_ID_PHB_PBAP_LIST2;
        }  
#else
        if (index == 1)
        {
            scr_id = SCR_ID_PHB_PBAP_LIST;
        }
        else if (index == 2)
        {
            scr_id = SCR_ID_PHB_PBAP_LIST2;
        }
#endif
    
        phb_pbapc_cntx_p->parent_id = GRP_ID_PHB_MAIN;
    #ifdef __MMI_TAB_BAR_SUPPORT_TAB_PAGE__
        if (!cui_tab_enter(
                GRP_ID_PHB_MAIN,
                scr_id,
                mmi_phb_pbapc_exit_list_tab,
                mmi_phb_pbapc_entry_list_tab,
                MMI_FRM_FULL_SCRN
                ))
    #else
        if (!mmi_frm_scrn_tab_page_enter(
                GRP_ID_PHB_MAIN,
                SCR_PBOOK_MAIN_MENU,
                SCR_ID_PHB_PBAP_LIST,
                mmi_phb_pbapc_exit_list_tab,
                mmi_phb_pbapc_entry_list_tab,
                MMI_FRM_TAB_PAGE
                ))
    #endif
        {
            return;
        }
#ifndef __MMI_TELEPHONY_SUPPORT__
    if (scr_id == SCR_ID_PHB_PBAP_LIST)
    {
        phb_pbapc_cntx_p->phb_list = 2;
        phb_pbapc_cntx_p->cui_list = 2;
    }
    else if (scr_id = SCR_ID_PHB_PBAP_LIST2)
    {
        phb_pbapc_cntx_p->phb_list = 3;
        phb_pbapc_cntx_p->cui_list = 3;
    }
        
#else

    phb_pbapc_cntx_p->phb_list = 2;

#endif
#if defined(__MMI_BT_PBAP_CLIENT__)
        g_wgui_cat199_has_default_hilight_item = MMI_FALSE;
#endif

        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_TAB_V3, ret);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        phb_pbapc_cntx_p->parent_id = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
#ifdef __MMI_TAB_BAR_SUPPORT_TAB_PAGE__
        index = cui_tab_get_select_index(SCR_ID_PHB_PBAPC_TAB);
#else
        index = mmi_frm_scrn_tab_get_active_page_index(); 
#endif  
#ifndef __MMI_TELEPHONY_SUPPORT__

        if (index == 0)
        {
            scr_id = SCR_ID_PHB_PBAPC_BT;
        }
        else if (index == 1)
        {
            scr_id = SCR_ID_PHB_PBAPC_BT1;
        }
            
#else
        if (index == 1)
        {
            scr_id = SCR_ID_PHB_PBAPC_BT;
        }
        else if (index == 2)
        {
            scr_id = SCR_ID_PHB_PBAPC_BT1;
        }
#endif
        
    #ifdef __MMI_TAB_BAR_SUPPORT_TAB_PAGE__
        if (!cui_tab_enter(
                GRP_ID_PHB_PBAPC_SELECT_CONTACT,
                scr_id,
                mmi_phb_pbapc_exit_list_tab,
                mmi_phb_pbapc_entry_list_tab,
                MMI_FRM_FULL_SCRN
                ))
    #else
        if (!mmi_frm_scrn_tab_page_enter(
                GRP_ID_PHB_PBAPC_SELECT_CONTACT,
                scr_id,
                SCR_ID_PHB_PBAPC_BT,
                mmi_phb_pbapc_exit_list_tab,
                mmi_phb_pbapc_entry_list_tab,
                MMI_FRM_TAB_PAGE
                ))
     #endif
        {
            return;
        }

#ifndef __MMI_TELEPHONY_SUPPORT__
    if (scr_id == SCR_ID_PHB_PBAP_LIST)
    {
        phb_pbapc_cntx_p->phb_list = 2;
        phb_pbapc_cntx_p->cui_list = 2;
    }
    else if (scr_id = SCR_ID_PHB_PBAP_LIST2)
    {
        phb_pbapc_cntx_p->phb_list = 3;        
        phb_pbapc_cntx_p->cui_list = 3;
    }        
#else

    phb_pbapc_cntx_p->phb_list = 2;

#endif
    }
    else
    {
        ;
    }
#ifndef __MMI_TELEPHONY_SUPPORT__ /*test*/
	bt_index = index;
#else
    bt_index = index - (MMI_PHB_MAIN_SCREEN_TAB_COUNT - SRV_PBAPC_LINK_NUM);
#endif
    phb_pbapc_cntx_p->bt_index = bt_index;
    if (phb_pbapc_cntx_p->list_type == 0)
    {
        mmi_phb_pbapc_set_list_type(0);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        mmi_phb_pbapc_set_list_type(1);
    }

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_TAB1, phb_pbapc_cntx_p->qsearch_input_buffer[0], phb_pbapc_cntx_p->total_pse_contact);

    phb_pbapc_cntx_p->list_state = 1; // active
    phb_pbapc_cntx_p->hlight_index = 0;
    if (phb_pbapc_cntx_p->qsearch_input_buffer[0])
    { 
        qsearch_filter.key_word = phb_pbapc_cntx_p->qsearch_input_buffer;
        qsearch_filter.key_len = mmi_ucs2strlen((CHAR*)phb_pbapc_cntx_p->qsearch_input_buffer); 
        qsearch_filter.input_mode =  (U16)mmi_imm_get_curr_input_mode();

    }
    else
    {
        qsearch_filter.key_word = NULL;
        qsearch_filter.key_len = 0;
        qsearch_filter.input_mode = 0;
        phb_pbapc_cntx_p->hlight_index = 0;

    }


    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_TAB3,
            phb_pbapc_cntx_p->bt_index, phb_pbapc_cntx_p->is_inbg[bt_index]);
    
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_TAB1, phb_pbapc_cntx_p->is_stop[index], ret);
    mmi_frm_cb_reg_event(EVT_ID_PHB_PBAPC_SYNC_STATUS_UPDATE, mmi_phb_pbapc_update_sync_status_hdlr,(void*)0x00001);
#ifdef __MTK_TARGET__
    ret_connect = mmi_phb_pbapc_is_connect();
    if (ret_connect >= 0)
#endif 
    {
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_FLAG, phb_pbapc_cntx_p->flag[bt_index],phb_pbapc_cntx_p->qsearch_input_buffer[0]);
        if (!phb_pbapc_cntx_p->flag[bt_index])
        {
            mmi_phb_pbapc_sync_data();
        }
        else
        {

            if (phb_pbapc_cntx_p->is_inbg[bt_index] && !phb_pbapc_cntx_p->is_stop[bt_index])// for click stop in extern.
            {
            
                mmi_phb_pbapc_show_loading(phb_pbapc_cntx_p->parent_id, SCR_ID_PHB_PROCESSING);
            
            }
            else
            {
                g_mmi_phb_pbapc_cntx.contact_count =
                    (U16) srv_phb_pbapc_build_contact_list(bt_index, &qsearch_filter, g_mmi_phb_pbapc_cntx.contact_array, SRV_PHB_PBAPC_CONTACT_COUNT);
            
                g_mmi_phb_pbapc_cntx.pse_phone_num = srv_phb_pbapc_get_phone_count(bt_index);
                g_mmi_phb_pbapc_cntx.pse_sim_num = srv_phb_pbapc_get_sim_count(bt_index);
                phb_pbapc_cntx_p->total_pse_contact = g_mmi_phb_pbapc_cntx.contact_count;
                if (phb_pbapc_cntx_p->is_stop[bt_index] && phb_pbapc_cntx_p->is_inbg[bt_index])
                {
                    phb_pbapc_cntx_p->is_inbg[bt_index]  = 0;
                    phb_pbapc_cntx_p->is_stop[bt_index] = 0;
            
                }
                mmi_phb_pbapc_show_pse_list();
                
                MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_TAB4,
                        g_mmi_phb_pbapc_cntx.contact_count, g_mmi_phb_pbapc_cntx.pse_phone_num, g_mmi_phb_pbapc_cntx.pse_sim_num);
            
            }
        }

    }
#ifdef __MTK_TARGET__
    else
    {
        g_mmi_phb_pbapc_cntx.contact_count = 0;
        
        g_mmi_phb_pbapc_cntx.pse_phone_num = 0;
        g_mmi_phb_pbapc_cntx.pse_sim_num = 0;
        phb_pbapc_cntx_p->total_pse_contact = g_mmi_phb_pbapc_cntx.contact_count;
        mmi_phb_pbapc_show_pse_list();
    }
#endif
#if defined(__MMI_PHB_QUICK_SEARCH__)
    g_phb_pbapc_search_function = mmi_phb_pbapc_search_function;
#endif
}


void mmi_phb_pbapc_entry_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 bt_index;
    MMI_BOOL is_redraw;
    srv_bt_cm_bt_addr addr;
    srv_phb_qsearch_filter_struct qsearch_filter;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    S32 ret = 0;
    S32 ret1= 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    if (phb_pbapc_cntx_p->list_type == 0)
    {
#if SRV_PBAPC_LINK_NUM >= 2
        #if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
        phb_pbapc_cntx_p->parent_id = GRP_ID_PHB_LIST;
        #endif
#else
        phb_pbapc_cntx_p->parent_id = GRP_ID_PHB_MAIN;

#endif

        phb_pbapc_cntx_p->phb_list = 2;

        ret = mmi_frm_cb_reg_event(EVT_ID_PHB_PBAPC_NOTIFY, mmi_phb_pbapc_notify_evt_hdlr, (void *)0xbabe0005);
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_V3, ret);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
#if SRV_PBAPC_LINK_NUM >= 2
    #if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
        phb_pbapc_cntx_p->parent_id = GRP_ID_PHBLIST_PBAPC_SELECT_CONTACT;
    #endif
#else 
        phb_pbapc_cntx_p->parent_id = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
#endif
        phb_pbapc_cntx_p->cui_list = 2;
        ret = mmi_frm_cb_reg_event(EVT_ID_PHB_PBAPC_NOTIFY, mmi_phb_pbapc_notify_evt_hdlr, (void *)0xbabe0005);

    }
    else
    {
        ;
    }

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        if (!mmi_frm_scrn_enter(
                phb_pbapc_cntx_p->parent_id,
                SCR_ID_PHB_PBAPC_BT,
                mmi_phb_launch_exit,
        #if SRV_PBAPC_LINK_NUM >= 2
            #if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
                mmi_phb_pbapc_entry_list,
            #endif/*!defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)*/
        #else /*SRV_PBAPC_LINK_NUM >= 2*/
                mmi_phb_launch_entry,
        #endif
                MMI_FRM_FULL_SCRN
                ))
        {
            MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_V3, -1, phb_pbapc_cntx_p->list_type);

            return;
        }
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        if (!mmi_frm_scrn_enter(
                phb_pbapc_cntx_p->parent_id,
                SCR_ID_PHB_PBAPC_BT,
                mmi_phb_pbapc_exit_list,
        #if SRV_PBAPC_LINK_NUM >= 2
            #if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
                mmi_phb_pbapc_entry_list,
            #endif
        #else
                cui_phb_pbapc_select_contact_entry,
        #endif
                MMI_FRM_FULL_SCRN
                ))
        {
            MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_V3, -1,phb_pbapc_cntx_p->list_type);

            return;
        } 
    }

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_V3, phb_pbapc_cntx_p->total_pse_contact,phb_pbapc_cntx_p->list_type);
#if SRV_PBAPC_LINK_NUM >= 2
    #if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
        phb_pbapc_cntx_p->bt_index = phb_pbapc_cntx_p->higlight_item;
        kal_prompt_trace(MOD_MMI, "[TEST]mmi_phb_pbapc_entry_list: bt_index = %d", phb_pbapc_cntx_p->bt_index);
        bt_index = phb_pbapc_cntx_p->bt_index;
    #endif /*!defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)*/
#else /*SRV_PBAPC_LINK_NUM >= 2*/
        phb_pbapc_cntx_p->bt_index = 0;
        bt_index = 0;
#endif

    g_wgui_cat199_has_default_hilight_item = MMI_FALSE;

    
    if (phb_pbapc_cntx_p->list_type == 0)
    {
        mmi_phb_pbapc_set_list_type(0);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        mmi_phb_pbapc_set_list_type(1);
    }
    phb_pbapc_cntx_p->list_state = 1; // active
    phb_pbapc_cntx_p->hlight_index = 0;
    if (phb_pbapc_cntx_p->qsearch_input_buffer[0])
    { 
        qsearch_filter.key_word = phb_pbapc_cntx_p->qsearch_input_buffer;
        qsearch_filter.key_len = mmi_ucs2strlen((CHAR*)phb_pbapc_cntx_p->qsearch_input_buffer); 
        qsearch_filter.input_mode =  (U16)mmi_imm_get_curr_input_mode();

    }
    else
    {
        qsearch_filter.key_word = NULL;
        qsearch_filter.key_len = 0;
        qsearch_filter.input_mode = 0;
    }
    is_redraw = mmi_frm_scenario_is_redrawing();

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_TAB1, phb_pbapc_cntx_p->qsearch_input_buffer[0], is_redraw);

    if (is_redraw)
    {
        mmi_phb_pbapc_show_pse_list();
        return;
    }
    
    mmi_frm_cb_reg_event(EVT_ID_PHB_PBAPC_SYNC_STATUS_UPDATE, mmi_phb_pbapc_update_sync_status_hdlr,(void*)0x00001);
    ret = mmi_phb_pbapc_is_connect();
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_LIST_V3_0,
        mmi_frm_is_in_backward_scenario(),ret);

#ifdef __MTK_TARGET__
    if (ret >= 0)
#endif
    {
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_ENTRY_FLAG, phb_pbapc_cntx_p->flag[bt_index],phb_pbapc_cntx_p->qsearch_input_buffer[0]);

        if (ret > 0)
        {
            if (!phb_pbapc_cntx_p->flag[bt_index])
            {
                mmi_phb_pbapc_sync_data();
            }
            else
            {
                if (phb_pbapc_cntx_p->is_inbg[bt_index] && !phb_pbapc_cntx_p->is_stop[bt_index])// for click stop in extern.
                {
                    mmi_phb_pbapc_show_loading(phb_pbapc_cntx_p->parent_id, SCR_ID_PHB_PROCESSING);
                }
                else
                {
                    mmi_phb_pbapc_build_contact_list(bt_index, &qsearch_filter);                
                }
            }
        }
        else
        {
            srv_phb_pbapc_get_btd_addr(&addr, bt_index);

            ret1 =  srv_bt_cm_get_existed_conn_num_by_addr(&addr);/*for judge other profile is connect*/
            if (ret1)
            {
                mmi_phb_pbapc_show_no_contact_list();
            }
            else
            {
                mmi_phb_pbapc_build_contact_list(bt_index, &qsearch_filter);
            }
        }

    }
#ifdef __MTK_TARGET__
    else
    {
        mmi_phb_pbapc_show_no_contact_list();
    }
#endif

}


static void mmi_phb_pbapc_build_contact_list(U8 bt_index, srv_phb_qsearch_filter_struct* qsearch_filter)
{
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    
    g_mmi_phb_pbapc_cntx.contact_count =
        (U16) srv_phb_pbapc_build_contact_list(bt_index, qsearch_filter, g_mmi_phb_pbapc_cntx.contact_array, SRV_PHB_PBAPC_CONTACT_COUNT);
    
    g_mmi_phb_pbapc_cntx.pse_phone_num = srv_phb_pbapc_get_phone_count(bt_index);
    g_mmi_phb_pbapc_cntx.pse_sim_num = srv_phb_pbapc_get_sim_count(bt_index);
    phb_pbapc_cntx_p->total_pse_contact = g_mmi_phb_pbapc_cntx.contact_count;
    if (phb_pbapc_cntx_p->is_stop[bt_index] && phb_pbapc_cntx_p->is_inbg[bt_index])
    {
        phb_pbapc_cntx_p->is_inbg[bt_index]  = 0;
        phb_pbapc_cntx_p->is_stop[bt_index] = 0;           
    }
#if defined(__MMI_PHB_QUICK_SEARCH__)
    g_phb_pbapc_search_function = mmi_phb_pbapc_search_function;
#endif
                        
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SHOW_NUM,
        g_mmi_phb_pbapc_cntx.contact_count, g_mmi_phb_pbapc_cntx.pse_phone_num, g_mmi_phb_pbapc_cntx.pse_sim_num);
    mmi_phb_pbapc_show_pse_list();

}


static void mmi_phb_pbapc_show_no_contact_list(void)
{
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SHOW_NUM);

    g_mmi_phb_pbapc_cntx.contact_count = 0;
    
    g_mmi_phb_pbapc_cntx.pse_phone_num = 0;
    g_mmi_phb_pbapc_cntx.pse_sim_num = 0;
    phb_pbapc_cntx_p->total_pse_contact = g_mmi_phb_pbapc_cntx.contact_count;
    mmi_phb_pbapc_show_pse_list();
}


static void mmi_phb_pbapc_update_sync_status_hdlr(mmi_event_struct *evt)
{
    MMI_ID active_id;
    U8 percentage;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    srv_phb_pbapc_sync_status_evt_struct *sync_data = (srv_phb_pbapc_sync_status_evt_struct*)evt; 
    active_id = mmi_frm_scrn_get_active_id();
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_UPDATE_STATUS,
        evt->evt_id, active_id, sync_data->sync_count, sync_data->total_count);
    if (evt->evt_id == EVT_ID_PHB_PBAPC_SYNC_STATUS_UPDATE)
    {
        if (sync_data->bt_index != phb_pbapc_cntx_p->bt_index)
        {
            return;
        }
        if (active_id == SCR_ID_PHB_PROCESSING)
        {
            if (sync_data->sync_count >= sync_data->total_count)
            {
                percentage = 100;
            }
            else
            {
                percentage = (sync_data->sync_count* 100) / sync_data->total_count;
            }
            
            wgui_cat6003_update_all((WCHAR*)GetString(STR_GLOBAL_LOADING), NULL, percentage);

        }

    }
}

mmi_imc_history_p history_data;

void mmi_phb_pbapc_exit_list_tab(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    MMI_ID group_id = 0;
    MMI_ID scrn_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_EXIT_LIST_TAB, 0, phb_pbapc_cntx_p->total_pse_contact);

    phb_pbapc_cntx_p->list_state = 2;


    wgui_set_menu_empty_string_by_id(STR_GLOBAL_EMPTY);

    mmi_frm_get_active_scrn_id(&group_id, &scrn_id);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_BACKUP1, group_id, scrn_id, phb_pbapc_cntx_p->phb_list, phb_pbapc_cntx_p->is_stop[phb_pbapc_cntx_p->bt_index]);
#if defined(__MMI_PHB_QUICK_SEARCH__)
    g_phb_pbapc_search_function = NULL;
#endif
    history_data = (mmi_imc_history_p) mmi_imc_get_editor_history_data();

}


void mmi_phb_pbapc_exit_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    MMI_ID group_id = 0;
    MMI_ID scrn_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    phb_pbapc_cntx_p->list_state = 2;

    wgui_set_menu_empty_string_by_id(STR_GLOBAL_EMPTY);

    mmi_frm_get_active_scrn_id(&group_id, &scrn_id);

#if defined(__MMI_PHB_QUICK_SEARCH__)
    g_phb_pbapc_search_function = NULL;
#endif
    history_data = (mmi_imc_history_p) mmi_imc_get_editor_history_data();

}


static void mmi_phb_pbapc_show_loading(MMI_ID parent_id, MMI_ID scrn_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //mmi_frm_scrn_create(parent_id, scrn_id, mmi_phb_pbapc_loading_scrn_proc, NULL);
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_pbapc_cntx_p->load_gid = parent_id;
    mmi_phb_pbapc_entry_show_loading();
    //mmi_phb_pbapc_show_searching();
}


static void mmi_phb_pbapc_stop_sync_op()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 index;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    index = phb_pbapc_cntx_p->bt_index;
    phb_pbapc_cntx_p->is_stop[index] = 1;
    srv_phb_pbapc_load_contact_cancel(index); 

    if (phb_pbapc_cntx_p->is_inbg[index])
    {
        wgui_status_icon_bar_hide_icon(STATUS_ICON_BT_SYNC_PB_BG);
    }
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_STOP_SYNC_0, index, phb_pbapc_cntx_p->is_inbg[index],g_mmi_phb_pbapc_cntx.is_stop[index]);

    mmi_phb_pbapc_show_loading_abort(phb_pbapc_cntx_p->parent_id, SCR_ID_PHB_PROCESSING); 
}


static void mmi_phb_pbapc_exchange_bg_sync()
{
    U8 index;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    index = phb_pbapc_cntx_p->bt_index;
    phb_pbapc_cntx_p->is_inbg[index] = MMI_TRUE;
    mmi_phb_pbapc_show_loading_abort(phb_pbapc_cntx_p->parent_id, SCR_ID_PHB_PROCESSING);
    wgui_status_icon_bar_show_icon(STATUS_ICON_BT_SYNC_PB_BG);
    wgui_status_icon_bar_update();
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_EXCHANGE_BG_SYNC_0, index, phb_pbapc_cntx_p->is_inbg[index], phb_pbapc_cntx_p->phb_list);
    if (mmi_frm_group_is_present(phb_pbapc_cntx_p->parent_id))
    {
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_EXCHANGE_BG_SYNC_1, 0);
        mmi_frm_group_close(phb_pbapc_cntx_p->parent_id);
    }
}

static void mmi_phb_pbapc_exchange_bg_sync_by_end_key()
{
    mmi_phb_pbapc_exchange_bg_sync();
    mmi_frm_close_to_idle_group();
}


static void mmi_phb_pbapc_entry_show_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = -1;
    U16 percentage;
    U16 sync_count;
    U16 total_count;
    U8 index;
    MMI_BOOL is_bg;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    ret = mmi_frm_scrn_enter(phb_pbapc_cntx_p->load_gid, SCR_ID_PHB_PROCESSING, NULL, mmi_phb_pbapc_entry_show_loading, MMI_FRM_FULL_SCRN);

    if (MMI_TRUE != ret)
    {
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_SHOW_LOAD_V3, -1,-1,-1);
        return;
    }

    //ShowCategory62Screen(STR_GLOBAL_LOADING, IMG_SCR_PBOOK_CAPTION, NULL);
    wgui_cat6003_show(STR_ID_PHB_PBAPC_BG,STR_GLOBAL_STOP,(WCHAR*)GetString(STR_GLOBAL_LOADING),NULL,0);

    index = phb_pbapc_cntx_p->bt_index;
    is_bg = mmi_frm_shell_is_in_backward_scenario();
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_SHOW_LOAD_V3, is_bg, index, phb_pbapc_cntx_p->is_inbg[index]);
    if (phb_pbapc_cntx_p->is_inbg[index] || is_bg)
    {
        srv_phb_pbapc_get_sync_info(index, &sync_count, &total_count);
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_SHOW_LOAD_V3, 1, sync_count,1, total_count);
        if (sync_count >= total_count)
        {
            percentage = 100;
        }
        else
        {
            percentage = (sync_count *100)/total_count; 
        }

        wgui_cat6003_update_all((WCHAR*)GetString(STR_GLOBAL_LOADING), NULL, percentage);
    }
    SetRightSoftkeyFunction(mmi_phb_pbapc_stop_sync_op, KEY_EVENT_UP);
    SetCenterSoftkeyFunction(mmi_phb_pbapc_exchange_bg_sync, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_phb_pbapc_exchange_bg_sync, KEY_EVENT_UP);
    SetKeyHandler(mmi_phb_pbapc_exchange_bg_sync_by_end_key, KEY_END,KEY_EVENT_DOWN);
}


#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif


static void mmi_phb_pbapc_show_loading_abort(MMI_ID parent_id, MMI_ID scrn_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    mmi_frm_scrn_close(parent_id, SCR_ID_PHB_PROCESSING);

    phb_pbapc_cntx_p->load_gid = 0;

}


static S32 mmi_phb_pbapc_find_entry_internal(U8 *keyword)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 key_length;
    S32 result_count;
    U16 total_count;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    U8 search_asi[MMI_PHB_NAME_LENGTH + 1];
    srv_phb_qsearch_filter_struct qsearch_filter;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
#ifdef __MMI_PHB_PBAPC_NO_CLEAR__
    total_count = phb_pbapc_cntx_p->pse_phone_num + phb_pbapc_cntx_p->pse_sim_num;
    if (!total_count)
        return 0;
#endif /* Count the input string length to decide behavior */
    key_length = (U8) mmi_ucs2strlen((CHAR*) keyword);

    mmi_ucs2_n_to_asc(search_asi, (CHAR *)keyword, MMI_PHB_NAME_LENGTH);
    search_asi[key_length] = '\0';
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP ,TRC_MMI_PHB_PBAPC_BACKUP2 ,search_asi, key_length, phb_pbapc_cntx_p->list_state);

    qsearch_filter.key_word = (U16*)keyword;
    qsearch_filter.key_len = key_length;
    qsearch_filter.input_mode = (U16)mmi_imm_get_curr_input_mode();    
    /* change  btd_enum*/
    g_mmi_phb_pbapc_cntx.contact_count =
        (U16) srv_phb_pbapc_build_contact_list(phb_pbapc_cntx_p->bt_index, &qsearch_filter, g_mmi_phb_pbapc_cntx.contact_array, SRV_PHB_PBAPC_CONTACT_COUNT);
    phb_pbapc_cntx_p->total_pse_contact = g_mmi_phb_pbapc_cntx.contact_count;
    result_count = phb_pbapc_cntx_p->total_pse_contact;
    if (!result_count)
    {
         SetCenterSoftkeyFunction(NULL, KEY_EVENT_UP);
    }

    return result_count;
}


static S32 mmi_phb_pbapc_find_entry(U8 *keyword)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result_count;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result_count = mmi_phb_pbapc_find_entry_internal(keyword);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_BACKUP3,result_count);
#ifdef __MMI_TELEPHONY_SUPPORT__
    if (result_count == 0)
    {
        SetKeyHandler(mmi_frm_general_tab_l_arrow_key_hdlr, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
        SetKeyHandler(mmi_frm_general_tab_r_arrow_key_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    }
#endif

    return result_count;
}


static BOOL mmi_phb_pbapc_lsk_present_function(S32 *max_number)
{

    S32 ret;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

#ifndef __MMI_PHB_PBAPC_NO_CLEAR__
    ret = mmi_phb_pbapc_is_connect();

    if (ret > 0)
    {
        return FALSE; /*include two case :1. connect, 2. disconnect*/
    }
    else
    {
        return TRUE;
        /*include four case : 1. connect& number = 0,2. disconnect & number =0, 3. not connected. 4. only pbap not connected*/
    }
#else
    ret = phb_pbapc_cntx_p->pse_phone_num + phb_pbapc_cntx_p->pse_sim_num;
    if (ret > 0)
    {
        return FALSE;
    }
    else
    {
        return TRUE;
    }

#endif
}


static S32 mmi_phb_pbapc_search_function(U8 *keyword)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result_count = 0;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    result_count = mmi_phb_pbapc_find_entry_internal((U8 *)(phb_pbapc_cntx_p->qsearch_input_buffer));
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_BACKUP4, result_count);
    return result_count;
}


static void mmi_phb_pbapc_show_pse_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 is_connect, ret, ret1;/*for dev is valid*/
    S32 has_lsk = MMI_FALSE;
    srv_bt_cm_bt_addr addr;
    U16 str_id = 0, img_id = 0;
    U16 total_count;
    U8 hightab_index = 1;
    U8 *gui_buffer = NULL;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SHOW_PSE_LIST,
               0, phb_pbapc_cntx_p->total_pse_contact, phb_pbapc_cntx_p->pse_phone_num);

    kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] mmi_phb_pbapc_show_pse_list(list state)--list_state: %d\n",
                phb_pbapc_cntx_p->list_state);

    if (phb_pbapc_cntx_p->list_state != 1)
    {
        return;
    }

    UI_common_screen_exit();
    total_count =  phb_pbapc_cntx_p->pse_phone_num + phb_pbapc_cntx_p->pse_sim_num;

    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    RegisterHighlightHandler(mmi_phb_pbapc_pse_list_highlight_hdlr);
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_BACKUP5, gui_buffer, phb_pbapc_cntx_p->qsearch_input_buffer[0],phb_pbapc_cntx_p->contact_count);


    if(NULL == gui_buffer && !phb_pbapc_cntx_p->qsearch_input_buffer[0])
    {
        phb_pbapc_cntx_p->pse_list_index = 0;
        phb_pbapc_cntx_p->qsearch_input_buffer[0] = 0;
    }
    else
    {
        if (history_data)
        {
            mmi_imc_get_input_method_history(history_data);
            mmi_imc_set_input_method_history(history_data);
        }
    }

    wgui_override_list_menu_slim_style(WGUI_LIST_MENU_SLIM_STYLE_NO_ICON);
    gui_buffer = NULL;

    is_connect = mmi_phb_pbapc_is_connect();
    ret1 = srv_phb_pbapc_get_btd_addr(&addr, phb_pbapc_cntx_p->bt_index);
    if (ret1 >= 0)/*dev is vaild*/
    {
        ret =  srv_bt_cm_get_existed_conn_num_by_addr(&addr);/*for judge other profile is connect*/
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_BACKUP9, is_connect, ret, ret1);
    }

#ifdef __MMI_PHB_PBAPC_NO_CLEAR__

    if(is_connect < 0)/*not connect before*/
    {
        wgui_set_menu_empty_string_by_id(STR_ID_PHB_PBAPC_NO_CONN);
    }
    else if(is_connect == 0)
    {
        if (total_count)
        {
            wgui_set_menu_empty_string_by_id(STR_GLOBAL_EMPTY);

        }
        else
        {
            wgui_set_menu_empty_string_by_id(STR_ID_PHB_PBAPC_NO_CONN);

        }
    }
    else
    {
        wgui_set_menu_empty_string_by_id(STR_GLOBAL_EMPTY);/*connect*/
    }
#else
    if (is_connect > 0)
    {
        wgui_set_menu_empty_string_by_id(STR_GLOBAL_EMPTY);

    }
    else
    {
        wgui_set_menu_empty_string_by_id(STR_ID_PHB_PBAPC_NO_CONN);
    }

#endif

#ifndef __MMI_PHB_PBAPC_NO_CLEAR__
    if (phb_pbapc_cntx_p->total_pse_contact)
#endif
    {
        has_lsk = MMI_TRUE;
    }

#ifndef __MMI_PHB_QUICK_SEARCH__
    wgui_cat1032_show(
                (WCHAR*) GetString(STR_SCR_PBOOK_VIEW_CAPTION),
                (PU8) GetImage(IMG_SCR_PBOOK_CAPTION),
                has_lsk?(WCHAR*) GetString(STR_GLOBAL_OPTIONS): NULL,
                has_lsk?(PU8) GetImage(IMG_GLOBAL_OPTIONS):NULL,
                (WCHAR*) GetString(STR_GLOBAL_BACK),
                (PU8) GetImage(IMG_GLOBAL_BACK),
                phb_pbapc_cntx_p->total_pse_contact,
                mmi_phb_pbapc_pse_list_get_item,
                NULL,
                phb_pbapc_cntx_p->pse_list_index,
                1,
                0,
                0,
                gui_buffer,
                NULL);
    SetRightSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option_back, KEY_EVENT_UP);
#else
    RegisterCat200SearchFunction(mmi_phb_pbapc_find_entry);
    Register_appl_present_function(mmi_phb_pbapc_lsk_present_function);// why this function , and this function do.


#if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
#ifndef __MMI_PHB_PBAPC_NO_CLEAR__ /*not clear*/
    if (has_lsk)
    {
        str_id = (phb_pbapc_cntx_p->list_type == 0) ? STR_GLOBAL_OPTIONS : STR_GLOBAL_OK;
        img_id = IMG_GLOBAL_OK;
    }
    else if (is_connect < 0)
    {
        str_id = STR_GLOBAL_CONNECT;
        img_id = IMG_GLOBAL_OK;
    }
#else
    if (is_connect < 0 ||(!is_connect && !total_count)) /*not connect & count ==0 */
    {
        str_id = STR_GLOBAL_CONNECT;
        img_id = IMG_GLOBAL_OK;
    }
    else/*total_count > 0*/
    {
        str_id = (phb_pbapc_cntx_p->list_type == 0) ? STR_GLOBAL_OPTIONS : STR_GLOBAL_OK;
        img_id = IMG_GLOBAL_OK;
        
        if (phb_pbapc_cntx_p->list_type == 1) /*from cui . number = 0*/
        {
           if (phb_pbapc_cntx_p->total_pse_contact)
           {
               str_id = STR_GLOBAL_OK;
               img_id = IMG_GLOBAL_OK;
           }
            else
           {
               str_id = NULL;       
           }
        }
    }

#endif
    if (ret1 >= 0)
    {
        srv_bt_cm_get_dev_ucs2_name(&addr, SRV_BT_CM_BD_UCS2_NAME_LEN, g_device_name[phb_pbapc_cntx_p->bt_index]);
    }
    else
    {
        kal_wsprintf(
            g_device_name[phb_pbapc_cntx_p->bt_index],
            "%w",
        (U16*)GetString(STR_ID_PHB_PBAPC_BT1 + phb_pbapc_cntx_p->bt_index));
        
    }


#if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
#if SRV_PBAPC_LINK_NUM >= 2

    ShowCategory200Screen_ext(
       (UI_string_type)g_device_name[phb_pbapc_cntx_p->bt_index],
        IMG_SCR_PBOOK_CAPTION,
        str_id,
        img_id,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        phb_pbapc_cntx_p->total_pse_contact,
        mmi_phb_pbapc_pse_list_get_item,
        NULL,
        phb_pbapc_cntx_p->pse_list_index,
        IMG_ID_PHB_QUICK_SEARCH_FIND,
        get_image(IMG_GLOBAL_L1),
        get_image(IMG_STORAGE_SIM),
        (U8*) phb_pbapc_cntx_p->qsearch_input_buffer,
        MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
        gui_buffer);
#else
	ShowCategory200Screen_ext(
	   (UI_string_type)GetString(STR_SCR_PBOOK_VIEW_CAPTION),
		IMG_SCR_PBOOK_CAPTION,
		str_id,
		img_id,
		STR_GLOBAL_BACK,
		IMG_GLOBAL_BACK,
		phb_pbapc_cntx_p->total_pse_contact,
		mmi_phb_pbapc_pse_list_get_item,
		NULL,
		phb_pbapc_cntx_p->pse_list_index,
		IMG_ID_PHB_QUICK_SEARCH_FIND,
		get_image(IMG_GLOBAL_L1),
		get_image(IMG_STORAGE_SIM),
		(U8*) phb_pbapc_cntx_p->qsearch_input_buffer,
		MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
		gui_buffer);


#endif /*SRV_PBAPC_LINK_NUM >= 2*/


#else    

      ShowCategory200Screen_ext(
       STR_SCR_PBOOK_VIEW_CAPTION,
        IMG_SCR_PBOOK_CAPTION,
        str_id,
        img_id,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        phb_pbapc_cntx_p->total_pse_contact,
        mmi_phb_pbapc_pse_list_get_item,
        NULL,
        phb_pbapc_cntx_p->pse_list_index,
        IMG_ID_PHB_QUICK_SEARCH_FIND,
        get_image(IMG_GLOBAL_L1),
        get_image(IMG_STORAGE_SIM),
        (U8*) phb_pbapc_cntx_p->qsearch_input_buffer,
        MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
        gui_buffer);
#endif /*!defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)*/ 
    SetCategory200RightSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option_back, KEY_EVENT_UP);

#else

#if SRV_PBAPC_LINK_NUM >= 2

    if (has_lsk)
    {
        str_id = (phb_pbapc_cntx_p->list_type == 0) ? STR_GLOBAL_OPTIONS: STR_GLOBAL_OK;
        img_id = IMG_GLOBAL_OPTIONS;
    }
    else if (!is_connect)// need change api
    {
        str_id = STR_GLOBAL_CONNECT;
        img_id = IMG_GLOBAL_OK;
    }

    wgui_cat_set_search_icon(IMG_ID_PHB_QUICK_SEARCH_FIND);

   // if (phb_pbapc_cntx_p->list_type == 0)before why only list type = 0 has this function. 
    //{
#ifndef __MMI_TELEPHONY_SUPPORT__ /*test*/
    hightab_index = phb_pbapc_cntx_p->bt_index;

#else
    hightab_index = phb_pbapc_cntx_p->bt_index + (MMI_PHB_MAIN_SCREEN_TAB_COUNT - SRV_PBAPC_LINK_NUM);
#endif
   // }


    ShowCategory199Screen_ext(
        (UI_string_type)GetString(str_id),
        (PU8)GetImage(img_id),
        (UI_string_type)GetString(STR_GLOBAL_BACK),
        (PU8)GetImage(IMG_GLOBAL_BACK),
        hightab_index,        
        (UI_string_type)GetString(STR_SCR_PBOOK_VIEW_CAPTION),
        NULL,
        phb_pbapc_cntx_p->total_pse_contact,
        mmi_phb_pbapc_pse_list_get_item,
        NULL,
        NULL,
        NULL,
        phb_pbapc_cntx_p->pse_list_index,
        get_image(IMG_GLOBAL_L1),
        get_image(IMG_STORAGE_SIM),
        (U8*) phb_pbapc_cntx_p->qsearch_input_buffer,
        MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
        gui_buffer);
#else /*SRV_PBAPC_LINK_NUM >= 2*/
#ifdef __MMI_TELEPHONY_SUPPORT__
    if (has_lsk)
    {
        str_id = (phb_pbapc_cntx_p->list_type == 0) ? STR_GLOBAL_OPTIONS: STR_GLOBAL_OK;
        img_id = IMG_GLOBAL_OPTIONS;
    }
    else if (!is_connect)// need change api
    {
        str_id = STR_GLOBAL_CONNECT;
        img_id = IMG_GLOBAL_OK;
    }

    wgui_cat_set_search_icon(IMG_ID_PHB_QUICK_SEARCH_FIND);

   // if (phb_pbapc_cntx_p->list_type == 0)before why only list type = 0 has this function. 
    //{
    #ifndef __MMI_TELEPHONY_SUPPORT__ /*test*/
    hightab_index = phb_pbapc_cntx_p->bt_index;

    #else
    hightab_index = phb_pbapc_cntx_p->bt_index + (MMI_PHB_MAIN_SCREEN_TAB_COUNT - SRV_PBAPC_LINK_NUM);
    #endif
   // }

    ShowCategory199Screen_ext(
        (UI_string_type)GetString(str_id),
        (PU8)GetImage(img_id),
        (UI_string_type)GetString(STR_GLOBAL_BACK),
        (PU8)GetImage(IMG_GLOBAL_BACK),
        hightab_index,        
        (UI_string_type)GetString(STR_SCR_PBOOK_VIEW_CAPTION),
        NULL,
        phb_pbapc_cntx_p->total_pse_contact,
        mmi_phb_pbapc_pse_list_get_item,
        NULL,
        NULL,
        NULL,
        phb_pbapc_cntx_p->pse_list_index,
        get_image(IMG_GLOBAL_L1),
        get_image(IMG_STORAGE_SIM),
        (U8*) phb_pbapc_cntx_p->qsearch_input_buffer,
        MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
        gui_buffer);

#else /*__MMI_TELEPHONY_SUPPORT__*/
    if (has_lsk)
    {
        str_id = (phb_pbapc_cntx_p->list_type == 0) ? STR_GLOBAL_OPTIONS : STR_GLOBAL_OK;
        img_id = IMG_GLOBAL_OK;
    }
    else if (is_connect < 0)
    {
        str_id = STR_GLOBAL_CONNECT;
        img_id = IMG_GLOBAL_OK;
    }
#if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
    ShowCategory200Screen_ext(
       (UI_string_type)GetString(STR_SCR_PBOOK_VIEW_CAPTION),
        IMG_SCR_PBOOK_CAPTION,
        str_id,
        img_id,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        phb_pbapc_cntx_p->total_pse_contact,
        mmi_phb_pbapc_pse_list_get_item,
        NULL,
        phb_pbapc_cntx_p->pse_list_index,
        IMG_ID_PHB_QUICK_SEARCH_FIND,
        get_image(IMG_GLOBAL_L1),
        get_image(IMG_STORAGE_SIM),
        (U8*) phb_pbapc_cntx_p->qsearch_input_buffer,
        MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
        gui_buffer);
#else
        ShowCategory200Screen_ext(
            STR_SCR_PBOOK_VIEW_CAPTION,
            IMG_SCR_PBOOK_CAPTION,
            str_id,
            img_id,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            phb_pbapc_cntx_p->total_pse_contact,
            mmi_phb_pbapc_pse_list_get_item,
            NULL,
            phb_pbapc_cntx_p->pse_list_index,
            IMG_ID_PHB_QUICK_SEARCH_FIND,
            get_image(IMG_GLOBAL_L1),
            get_image(IMG_STORAGE_SIM),
            (U8*) phb_pbapc_cntx_p->qsearch_input_buffer,
            MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
            gui_buffer);
#endif

#endif/*__MMI_TELEPHONY_SUPPORT__*/
#endif /* SRV_PBAPC_LINK_NUM >= 2 */

    SetCategory200RightSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option_back, KEY_EVENT_UP);
#endif /*!defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)*/
#endif/*__MMI_PHB_QUICK_SEARCH__*/
    wgui_override_list_menu_slim_style(WGUI_LIST_MENU_SLIM_STYLE_DEFAULT);
    if(is_connect < 0 || (is_connect == 0 && !total_count))/*not connect & count == 0*/
    {
        ChangeLeftSoftkey(STR_GLOBAL_CONNECT, IMG_GLOBAL_OK);
        SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_connect, KEY_EVENT_UP);
        SetCategory200LeftSoftkeyFunction(mmi_phb_pbapc_pse_list_connect, KEY_EVENT_UP);

        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_phb_pbapc_pse_list_connect, KEY_EVENT_UP);
    }
    else /*connect & disconnect count> 0*/
#ifdef __MMI_PHB_PBAPC_NO_CLEAR__ 
    {
        
        if (phb_pbapc_cntx_p->list_type == 0)
        {
            if ((phb_pbapc_cntx_p->qsearch_input_buffer[0] && phb_pbapc_cntx_p->contact_count == 0))
            {     
                if (total_count> 0)
                {
                    ChangeLeftSoftkey(NULL, 0);
                }
                else /*connect &  num = 0*/
                {
                    ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
                }
            }
            else
            {
                ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
            }

        }
        else if (phb_pbapc_cntx_p->list_type == 1)
        {
            if (has_lsk &&  phb_pbapc_cntx_p->contact_count > 0)
            {
                ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
            }
        }

        SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
        SetCategory200LeftSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
        if (phb_pbapc_cntx_p->list_type == 0)
        {
            if (phb_pbapc_cntx_p->contact_count)
            {
                SetCenterSoftkeyFunction(mmi_phb_pbapc_view_contact_op, KEY_EVENT_UP);
            }  
            if (is_connect && !total_count)
            {
                SetCenterSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
            }
        }
        else if(phb_pbapc_cntx_p->list_type == 1)
        {
            if (phb_pbapc_cntx_p->contact_count)
            {
                SetCenterSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
            }
        }
    }
#else
    {
        if (phb_pbapc_cntx_p->list_type == 0)
        {
            if ((phb_pbapc_cntx_p->qsearch_input_buffer[0] && phb_pbapc_cntx_p->contact_count == 0))
            {
                ChangeLeftSoftkey(NULL, 0);
            }
            else
            {
                ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
            }
        }
        else if (phb_pbapc_cntx_p->list_type == 1)
        {
            if (has_lsk)
            {
                ChangeLeftSoftkey(STR_GLOBAL_OK, 0);

            }
        }
        SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
        SetCategory200LeftSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
        SetCenterSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
    }
#endif
  ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);

#ifdef __MMI_TOUCH_SCREEN__
    wgui_set_horizontal_tab_bar_select_callback(mmi_frm_set_cur_sel_page);
#endif /* __MMI_TOUCH_SCREEN__ */

#if defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_phb_pbapc_bt_list_tap_callback);
#endif /* defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__) */

    if (phb_pbapc_cntx_p->list_type == 0 && phb_pbapc_cntx_p->total_pse_contact > 0)
    {
        SetKeyHandler(mmi_phb_pbapc_pse_list_call, KEY_SEND, KEY_EVENT_UP);

        phb_pbapc_cntx_p->phb_state = 0;
    }
    else
    {
        ClearKeyHandler(KEY_SEND, KEY_EVENT_UP);
    }
}


static void mmi_phb_pbapc_pse_list_highlight_hdlr(S32 item_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL is_connect;
    U16 total_count;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    srv_phb_pbapc_list_entry_struct *pse_contact = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    pse_contact = phb_pbapc_cntx_p->pse_contact;
    total_count = phb_pbapc_cntx_p->pse_phone_num + phb_pbapc_cntx_p->pse_sim_num;
    

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        phb_pbapc_cntx_p->pse_list_index = item_index;
        phb_pbapc_cntx_p->pse_entry_index = phb_pbapc_cntx_p->contact_array[item_index];

        if (item_index < phb_pbapc_cntx_p->pse_phone_num)
        {
            phb_pbapc_cntx_p->contact_storage  = SRV_PHB_PBAP_STORAGE_PHONE_PB;
        }
        else
        {
            phb_pbapc_cntx_p->contact_storage  = SRV_PHB_PBAP_STORAGE_SIM1_PB;
        }
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        phb_pbapc_cntx_p->cui_pse_list_index = item_index;
        phb_pbapc_cntx_p->cui_pse_entry_index =  phb_pbapc_cntx_p->contact_array[item_index];

        if (item_index < phb_pbapc_cntx_p->pse_phone_num)
        {
            phb_pbapc_cntx_p->cui_contact_storage  = SRV_PHB_PBAP_STORAGE_PHONE_PB;
        }
        else
        {
            phb_pbapc_cntx_p->cui_contact_storage  = SRV_PHB_PBAP_STORAGE_SIM1_PB;
        }
    }

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        //ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, IMG_GLOBAL_OK);
        ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, IMG_GLOBAL_OK);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        if (phb_pbapc_cntx_p->total_pse_contact)
        {
            ChangeLeftSoftkey(STR_GLOBAL_OK, IMG_GLOBAL_OK);
        }

    }

    ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);

    is_connect = mmi_phb_pbapc_is_connect();

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_REHIHGLIGHT, is_connect, phb_pbapc_cntx_p->bt_index,phb_pbapc_cntx_p->qsearch_input_buffer[0]);
#ifdef __MMI_PHB_PBAPC_NO_CLEAR__
    if (total_count > 0)
    {
        if (phb_pbapc_cntx_p->contact_count)
        {
            if(phb_pbapc_cntx_p->list_type == 1)
            {
                SetCenterSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
            }
            else
            {
                SetCenterSoftkeyFunction(mmi_phb_pbapc_view_contact_op, KEY_EVENT_UP);
            }

            SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
        }
        else
        {
            SetCenterSoftkeyFunction(NULL, KEY_EVENT_UP);
            SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);

        }
    }
    else /*not change*/
    {
        if (is_connect <= 0)
        {
            SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_connect, KEY_EVENT_UP);
            SetCenterSoftkeyFunction(mmi_phb_pbapc_pse_list_connect, KEY_EVENT_UP);
        }
        else
        {
            SetCenterSoftkeyFunction(mmi_phb_pbapc_view_contact_op, KEY_EVENT_UP);
            SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
        }            
    }

#else
    if (is_connect > 0)
    {
        SetCenterSoftkeyFunction(mmi_phb_pbapc_view_contact_op, KEY_EVENT_UP);
        SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option, KEY_EVENT_UP);
    }
    else
    {
        SetLeftSoftkeyFunction(mmi_phb_pbapc_pse_list_connect, KEY_EVENT_UP);
        SetCenterSoftkeyFunction(mmi_phb_pbapc_pse_list_connect, KEY_EVENT_UP);

    }
#endif

    SetRightSoftkeyFunction(mmi_phb_pbapc_pse_list_op_option_back, KEY_EVENT_UP);

    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);


    if (phb_pbapc_cntx_p->list_type == 0 && phb_pbapc_cntx_p->total_pse_contact > 0)
    {
        SetKeyHandler(mmi_phb_pbapc_pse_list_call, KEY_SEND, KEY_EVENT_UP);

        phb_pbapc_cntx_p->phb_state = 0;
    }
    else
    {
        ClearKeyHandler(KEY_SEND, KEY_EVENT_UP);
    }
#ifdef __MMI_TELEPHONY_SUPPORT__
#ifdef __MMI_PHB_QUICK_SEARCH__
    SetKeyHandler(mmi_frm_general_tab_l_arrow_key_hdlr, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_frm_general_tab_r_arrow_key_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
#endif
#endif
}


static void mmi_phb_pbapc_in_status_rsk_hdlr()
{
    /*mmi_frm_scrn_close_active_id();
    mmi_frm_group_close(GRP_ID_PHB_PBAP_SETTING);*/
    mmi_frm_scrn_close(GRP_ID_PHB_PBAP_OP_OPTION, SCR_MEMORY_STATUS);
}


static void mmi_phb_pbapc_pse_list_op_option_back(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    if (phb_pbapc_cntx_p->qsearch_input_buffer)
    {
        phb_pbapc_cntx_p->qsearch_input_buffer[0] = 0;
    
    }

#if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
#if (SRV_PBAPC_LINK_NUM >= 2) 
        mmi_frm_scrn_close_active_id();
        mmi_frm_group_close(phb_pbapc_cntx_p->parent_id);
#else
    if (phb_pbapc_cntx_p->list_type == 0)
    {
        mmi_frm_scrn_close_active_id();
        mmi_frm_group_close(phb_pbapc_cntx_p->parent_id);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        cui_phb_pbapc_bt_send_select_result(NULL, 1); // select cancel
    }
#endif
#else
    if (phb_pbapc_cntx_p->list_type == 0)
    {
        mmi_frm_scrn_close_active_id();
        mmi_frm_group_close(phb_pbapc_cntx_p->parent_id);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        cui_phb_pbapc_bt_send_select_result(NULL, 1); // select cancel
    }
#endif
}

static void mmi_phb_pbapc_status_show(void)
{
    srv_phb_pbapc_btd_enum bt_index;

    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    U16 sim_count = 0;
    U16 phone_count = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    CHAR *memory_status = OslMalloc(1024);
    CHAR *sep_string = GetString(STR_ID_PHB_SEP_COLON);
    /* change bt device*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    bt_index = phb_pbapc_cntx_p->bt_index;
    phone_count = srv_phb_pbapc_get_phone_count(bt_index);
  
    kal_wsprintf((WCHAR*)memory_status, "%w%w%d\n",
        GetString(STR_GLOBAL_PHONE),        
        sep_string,
        phone_count
        );

    sim_count = srv_phb_pbapc_get_sim_count(bt_index); 

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_STATUS_SHOW, bt_index, phone_count, sim_count);
    kal_wsprintf((WCHAR*)memory_status, "%w%w%w%d\n",
        memory_status,
        GetString(STR_GLOBAL_SIM),
        sep_string,
        sim_count);


    if(!mmi_frm_scrn_enter(
       //GRP_ID_PHB_PBAP_SETTING,
        GRP_ID_PHB_PBAP_OP_OPTION,
        SCR_MEMORY_STATUS,
        NULL,
        mmi_phb_pbapc_status_show,
        MMI_FRM_UNKNOW_SCRN))
        {
            OslMfree(memory_status);
            return ;
        }
        ShowCategory7Screen(
            STR_GLOBAL_MEMORY_STATUS,
            IMG_SCR_PBOOK_CAPTION,
            0,
            0,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            (PU8) memory_status,
            mmi_frm_scrn_get_active_gui_buf());
        SetRightSoftkeyFunction(mmi_phb_pbapc_in_status_rsk_hdlr, KEY_EVENT_UP);

    OslMfree(memory_status);
    
}

static S32 mmi_phb_pbapc_read_folder_cb(srv_phb_pbapc_load_contact_rsp *load_rsp, void *user_data)
{
    U8 cb_index;
    U8 index;
    MMI_ID active_id;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_contx_cb_data = (mmi_phb_pbapc_cntx_struct *)user_data;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    cb_index = load_rsp->bt_index;
    index = phb_pbapc_cntx_p->bt_index;

    active_id = mmi_frm_scrn_get_active_id();
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_READ_CB, phb_pbapc_cntx_p->is_stop[index], phb_pbapc_cntx_p->is_inbg[cb_index], load_rsp->ret);  

    phb_pbapc_cntx_p->is_inbg[cb_index] = MMI_FALSE;
#ifdef __MTK_TARGET__
    wgui_status_icon_bar_hide_icon(STATUS_ICON_BT_SYNC_PB_BG);
#endif
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_BACKUP6, active_id, SCR_ID_PHB_PROCESSING, index,cb_index);
    if(load_rsp->ret == SRV_PHB_PBAPC_RET_OK && index == cb_index)
    {
        if (active_id == SCR_ID_PHB_PROCESSING)
        {
            wgui_cat6003_update_all((WCHAR*)GetString(STR_GLOBAL_LOADING),NULL,100);
        }
        mmi_phb_pbapc_show_loading_abort(phb_pbapc_cntx_p->load_gid, SCR_ID_PHB_PROCESSING);
    }
    else
    {

    }
    return;
}


static void mmi_phb_pbapc_sync_data(void)
{
    S32 ret;
    U8 index;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    index = phb_pbapc_cntx_p->bt_index;
    phb_pbapc_cntx_p->is_stop[index] = 0;
    phb_pbapc_cntx_p->flag[index] = 1;
    mmi_phb_pbapc_show_loading(phb_pbapc_cntx_p->parent_id, SCR_ID_PHB_PROCESSING);/*change bt device*/

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SYNC_DATA, phb_pbapc_cntx_p->bt_index, phb_pbapc_cntx_p->phb_list);
    ret = srv_phb_pbapc_load_contact(phb_pbapc_cntx_p->bt_index, mmi_phb_pbapc_read_folder_cb, phb_pbapc_cntx_p);

    if (ret != SRV_PHB_PBAPC_RET_OK)
    {
        //error = mmi_phb_pbapc_get_error_msg(ret);

        mmi_phb_pbapc_show_loading_abort(phb_pbapc_cntx_p->parent_id, SCR_ID_PHB_PROCESSING);
        
        mmi_frm_nmgr_popup(
            MMI_SCENARIO_ID_DEFAULT,
            MMI_EVENT_FAILURE,
            (WCHAR*)GetString(STR_ID_PHB_PBAPC_SRV_IS_BUSY));

    }
    else
    {
        phb_pbapc_cntx_p->pse_list_index = 0;

    }
}


static void mmi_phb_pbapc_setting_evt_select_hdlr(cui_menu_event_struct *evt)
{
    switch (evt->highlighted_menu_id)
    {
        case MENU_ID_PHB_PBAPC_MEM_STATUS:
        {
            mmi_phb_pbapc_status_show();
            break;

        }      
        case MENU_ID_PHB_PBAPC_BT_SYNC:
        {
            mmi_frm_group_close(GRP_ID_PHB_PBAP_OP_OPTION);
            mmi_phb_pbapc_sync_data();
            break;

        }
        default: 
            break;
    }
}


static mmi_ret mmi_phb_pbapc_sub_menu_group_proc(mmi_event_struct *evt)
{
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_DEINIT:
            //memset(&g_mmi_clog_pbapc_op_inst, 0x0, sizeof(mmi_clog_pbapc_op_inst_struct));
            break;

        case EVT_ID_CUI_MENU_LIST_ENTRY:
        {
            cui_menu_set_item_string(((cui_menu_event_struct*)evt)->sender_id,MENU_ID_PHB_PBAPC_BT_SYNC,(WCHAR*)GetString(STR_ID_PHB_BT_SYNC));
            break;
        }

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_phb_pbapc_setting_evt_select_hdlr((cui_menu_event_struct*)evt);
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(((cui_menu_event_struct*)evt)->sender_id);//?why can't close this menu.
            //mmi_frm_group_close(GRP_ID_PHB_PBAP_SETTING);
            break;

        default:
            break;
    }
    
    return MMI_RET_OK;

}


static void mmi_phb_pbapc_settings(void)
{
    mmi_id mmi_id;
    U16 StringId;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;


    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
   // mmi_frm_group_create_ex(GRP_ID_PHB_PBAP_OP_OPTION, GRP_ID_PHB_PBAP_SETTING, mmi_phb_pbapc_sub_menu_group_proc , NULL, MMI_FRM_NODE_NONE_FLAG);

    mmi_id = cui_menu_create(
                    //GRP_ID_PHB_PBAP_SETTING,
                    GRP_ID_PHB_PBAP_OP_OPTION,
                    CUI_MENU_SRC_TYPE_RESOURCE,
                    CUI_MENU_TYPE_APPSUB,
                    MMI_PHBOOK_PBAPC_BT_SETTING,
                    MMI_FALSE, 
                    NULL);
#ifdef __MTK_TARGET__
    if (mmi_phb_pbapc_is_connect())
    {
        cui_menu_set_item_hidden(mmi_id, MENU_ID_PHB_PBAPC_BT_SYNC, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(mmi_id, MENU_ID_PHB_PBAPC_BT_SYNC, MMI_TRUE);
    }
#else
#endif
#if (SRV_PBAPC_LINK_NUM >= 2) 
    if (phb_pbapc_cntx_p->bt_index == 1)
    {        
        StringId = STR_ID_PHB_PBAPC_BT2_SETTING;
    }
    else
    {
        StringId = STR_ID_PHB_PBAPC_BT1_SETTING;
    }
    
    cui_menu_set_default_title_string(mmi_id,(WCHAR*)GetString(StringId));
#else
    cui_menu_set_default_title_string(mmi_id,(WCHAR*)GetString(STR_ID_PHB_BT_SETTINGS));
#endif
    cui_menu_run(mmi_id);

}


static S32 mmi_phb_pbapc_is_connect(void)
{
    U8 index;
    MMI_BOOL is_connect;
    S32 ret;
    srv_bt_cm_bt_addr addr;

    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    index = phb_pbapc_cntx_p->bt_index;
    ret = srv_phb_pbapc_get_btd_addr(&addr, index);
    if (ret >= 0)
    {
        is_connect = srv_bt_cm_is_profile_connected_ex(SRV_BT_CM_PBAPC_CONNECTION, &addr);
        ret = is_connect;
    }

    
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_PSE_LIST_V3, phb_pbapc_cntx_p->bt_index, ret, index, addr);
    return ret;
}


static void mmi_phb_pbapc_pse_list_op_option()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    MMI_ID menu_gid;
    S32 is_connect;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_LIST_OP_V3, phb_pbapc_cntx_p->list_type,phb_pbapc_cntx_p->total_pse_contact, phb_pbapc_cntx_p->contact_count);

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        mmi_frm_group_create_ex(phb_pbapc_cntx_p->parent_id, GRP_ID_PHB_PBAP_OP_OPTION, cui_phb_pbapc_select_contact_proc, NULL, MMI_FRM_NODE_SMART_CLOSE_FLAG);
        menu_gid = cui_menu_create(
                    GRP_ID_PHB_PBAP_OP_OPTION,//GRP_ID_PHB_PBAP_OP_OPTION,
                    CUI_MENU_SRC_TYPE_RESOURCE,
                    CUI_MENU_TYPE_OPTION,
                    MMI_PHBOOK_PBAPC_OP_OPTIONS,
                    MMI_FALSE, NULL);

        cui_menu_set_default_title_image(menu_gid, (UI_image_type)GetImage(IMG_SCR_PBOOK_CAPTION));
        //MMI_ASSERT(0);
        is_connect = mmi_phb_pbapc_is_connect();
        if (is_connect)/*connect*/
        {
            if(0 == phb_pbapc_cntx_p->total_pse_contact || !phb_pbapc_cntx_p->contact_count)
            {
                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT, MMI_TRUE);

                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SEND_SMS, MMI_TRUE);

                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_TRUE);
                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SAVE, MMI_TRUE);
            }
            else
            {
                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT, MMI_FALSE);
                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SEND_SMS, MMI_FALSE);
                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_FALSE);
                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SAVE, MMI_FALSE);
                if (phb_pbapc_cntx_p->list_type == 0)
                {
                    cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_FALSE);
                }
                else if (phb_pbapc_cntx_p->list_type == 1)
                {
                    cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_TRUE);
                }
            }
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_RECONNECT, MMI_TRUE);
        }
        else if (is_connect == 0)/* disconnect*/
        {
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT, MMI_TRUE);

            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SEND_SMS, MMI_TRUE);

            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_TRUE);
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SAVE, MMI_TRUE);
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_SETTING, MMI_TRUE);

            if (phb_pbapc_cntx_p->contact_count)
            {
                cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT, MMI_FALSE);
            }
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_RECONNECT, MMI_FALSE);
        }
#ifndef __MMI_TELEPHONY_SUPPORT__
        cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SAVE, MMI_TRUE);
#endif

        cui_menu_set_default_title_image_by_id(menu_gid, IMG_SCR_PBOOK_CAPTION);
        cui_menu_run(menu_gid);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        cui_phb_pbapc_pre_select_contact();
    }
}


static void mmi_phb_pbapc_pse_list_connect(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_ret gid;
    mmi_id cui_id;
    srv_bt_cm_bt_addr addr;
    S32 ret;
    U8 index;

    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;



    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    index = phb_pbapc_cntx_p->bt_index;
    srv_phb_pbapc_get_btd_addr(&addr, index);
    kal_prompt_trace(MOD_MMI, "[test]mmi_phb_pbapc_pse_list_connect:index = %d, lap: 0x%x, uap: 0x%x, nap: 0x%x",index, addr.lap, addr.uap, addr.nap);
    if (phb_pbapc_cntx_p->list_type == 0)
    {
        gid = GRP_ID_PHB_MAIN;
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        gid = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
    }
    else
    {
        gid = mmi_frm_group_get_active_id();
    }
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_PSE_LIST_CONNECT, gid, GRP_ID_PHB_MAIN, GRP_ID_PHB_PBAPC_SELECT_CONTACT);
    ret = srv_bt_cm_get_existed_conn_num_by_addr(&addr);
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_CONNECT_SINGLE,index, ret, addr);

    if (ret)
    {
        
        // mmi_bt_dialer_conn_profile(NULL, gid, SRV_BT_CM_PBAPC_CONNECTION, mmi_phb_pbapc_con_profile_cb);
        cui_id = cui_bt_dialer_connecting_create(gid);
        if (cui_id != GRP_ID_INVALID)
        {
            cui_bt_dialer_connecting_run(cui_id);
            g_for_connect.cui_id= cui_id;
            g_for_connect.ret = srv_pbapc_connect(&addr, mmi_phb_pbapc_con_profile_cb);

        }
    }
    else
    {
        if (srv_bt_cm_get_busy_dev() == NULL)
        {
            g_for_connect.speci_index = phb_pbapc_cntx_p->bt_index;
            srv_pbapc_set_query_func(mmi_phb_pbapc_bt_set_index_cb);
        }

        mmi_bt_dialer_show_popup(gid);
    }
}
 

static void mmi_phb_pbapc_con_profile_cb
    (srv_bt_cm_bt_addr *dev_addr, srv_bt_cm_connection_type conn_type, MMI_BOOL result, MMI_BOOL is_connect, MMI_BOOL is_indicate)

{
    U16 str_id;
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_CON_CB_V3,result);
      
    cui_bt_dialer_connecting_close(g_for_connect.cui_id);
    if (!result)
    {
        if (g_for_connect.ret != SRV_PBAPC_RET_OK)
        {
            str_id = STR_GLOBAL_CURRENTLY_NOT_AVAILABLE;
        }
        else
        {
            str_id = STR_BT_CONN_FAILED;
        }
        mmi_frm_nmgr_popup(
            MMI_SCENARIO_ID_DEFAULT,
            MMI_EVENT_FAILURE,
        (WCHAR*)GetString(str_id));

    }
}


static S32 mmi_phb_pbapc_pse_list_get_item(S32 item_index, gui_iconlist_menu_item *menu_data, S32 data_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (index = 0; index < data_size; index++)
    {
       mmi_phb_pbapc_pse_list_get_item_int((item_index + index), menu_data[index].item_list[0], &menu_data[index].image_list[0], &menu_data[index].image_list[1]);
    }
    return data_size;
}

static void mmi_phb_pbapc_pse_list_get_item_int(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p1, PU8 *img_buff_p2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    srv_phb_pbapc_list_entry_struct *pse_contact = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    pse_contact = phb_pbapc_cntx_p->pse_contact;

    if (phb_pbapc_cntx_p->total_pse_contact == 0) return;
    srv_phb_pbapc_get_name(phb_pbapc_cntx_p->bt_index, phb_pbapc_cntx_p->contact_array[item_index], str_buff, SRV_PHB_PBAPC_NAME_LENGTH);
    //mmi_chset_utf8_to_ucs2_string((kal_uint8 *)str_buff, 2 * (strlen((const unsigned char *)pse_contact->name) + 1), (kal_uint8 *) pse_contact->name);

    if (str_buff[0] == 0)
    {
        mmi_ucs2ncpy((CHAR*) str_buff, GetString(STR_ID_PHB_UNNAMED), MAX_SUBMENU_CHARACTERS);
    }
#ifdef __MMI_PHB_QUICK_SEARCH__
    *img_buff_p1 = (PHB_STORAGE_NVRAM == srv_phb_pbapc_get_storage(phb_pbapc_cntx_p->bt_index, phb_pbapc_cntx_p->contact_array[item_index])) ? get_image(IMG_STORAGE_HANDSET) : get_image(IMG_GLOBAL_SIM1);
#endif
}

static void mmi_phb_pbapc_view_contact_op(void)
{
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_ret gid = GRP_ID_PHB_MAIN;

    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        if(mmi_frm_group_is_present(GRP_ID_PHB_PBAP_OP_OPTION))
        {
            gid = GRP_ID_PHB_PBAP_OP_OPTION;
        }
        else
        {
            gid = mmi_frm_group_create_ex(phb_pbapc_cntx_p->parent_id, GRP_ID_PHB_PBAP_OP_OPTION, cui_phb_pbapc_select_contact_proc, NULL, MMI_FRM_NODE_SMART_CLOSE_FLAG);

        }
    }
    else
    {
        gid = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
    }

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_BACKUP7,phb_pbapc_cntx_p->list_type, phb_pbapc_cntx_p->pse_phb.num_count, phb_pbapc_cntx_p->pse_phb.name[0]);
    if (phb_pbapc_cntx_p->pse_phb.name[0] == '\0' && phb_pbapc_cntx_p->pse_phb.num_count == 0)
    {
        mmi_frm_nmgr_popup(
               MMI_SCENARIO_ID_DEFAULT,
               MMI_EVENT_FAILURE,
        (WCHAR*)GetString(STR_GLOBAL_FAILED));
    }  
    else
    {
        cui_phb_pbapc_view_pse_contact(gid, phb_pbapc_cntx_p->pse_entry_index, phb_pbapc_cntx_p->contact_storage);    
    }

}


mmi_ret mmi_phb_pbapc_list_proc(mmi_event_struct *evt)
{

    return MMI_RET_OK;
}


mmi_ret mmi_phb_pbapc_menu_cui_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_ret ret = MMI_RET_DONT_CARE;
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    cui_phb_save_contact_result_struct *save_evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] mmi_phb_pbapc_menu_cui_proc--evt_id: %d, menu_id: %d, MENU_ITEM_SELECT: %d, MENU_ID_VIEW_CONTACT: %d\n",
    //                                                                evt->evt_id, menu_evt->highlighted_menu_id, EVT_ID_CUI_MENU_ITEM_SELECT, MENU_ID_PHB_PBAPC_VIEW_CONTACT);
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    mmi_phb_pbapc_covert_data(&phb_pbapc_cntx_p->pse_phb); 

    switch (evt->evt_id)
    {
        case EVT_ID_CUI_MENU_ITEM_SELECT:
        {
            switch (menu_evt->highlighted_menu_id)
            {  
                /* pse list option */
                case MENU_ID_PHB_PBAPC_VIEW_CONTACT:
                {
                    mmi_phb_pbapc_view_contact_op();
                    ret = MMI_RET_OK;
                    break;
                }

                /* view menu option */
                case MENU_ID_PHB_PBAPC_VIEW_CONTACT_SEND_SMS:
                {
                    phb_pbapc_cntx_p->op_type = 0;
                    mmi_phb_pbapc_do_by_select();
                    ret = MMI_RET_OK;
                    break;
                }
                case MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL:
                {
                    phb_pbapc_cntx_p->op_type = 1;
                    mmi_phb_pbapc_do_by_select();
                    ret = MMI_RET_OK;
                    break;
                }
                case MENU_ID_PHB_PBAPC_VIEW_CONTACT_SAVE:
                {
                    mmi_phb_pbapc_save_pse_contact();
                    ret = MMI_RET_OK;
                    break;
                } 
                case MENU_ID_PHB_PBAPC_RECONNECT:
                {
                    mmi_frm_group_close(GRP_ID_PHB_PBAP_OP_OPTION);
                    mmi_phb_pbapc_pse_list_connect();
                    ret = MMI_RET_OK;
                    break;
                }
                case MENU_ID_PHB_PBAPC_SETTING:
                {
                    mmi_phb_pbapc_settings();
                    ret = MMI_RET_OK;
                    break;
                }
                case MENU_ID_PHB_PBAPC_MEM_STATUS:
                {
                    mmi_phb_pbapc_status_show();
                    ret = MMI_RET_OK;
                    break;

                }      
                case MENU_ID_PHB_PBAPC_BT_SYNC:
                {
                    mmi_frm_group_close(GRP_ID_PHB_PBAP_OP_OPTION);
                    mmi_phb_pbapc_sync_data();
                    ret = MMI_RET_OK;
                    break;
                }

            }
            break;
        }

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
        {
            cui_menu_close(menu_evt->sender_id);
            ret = MMI_RET_OK;
            break;
        }
        case EVT_ID_PHB_SAVE_CONTACT:
        case EVT_ID_PHB_SAVE_CONTACT_CANCEL:
        {
           save_evt = (cui_phb_save_contact_result_struct *) evt;

           //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] mmi_phb_pbapc_view_pse_contact_proc(save contact)--evt->id: %d, ret: %d, sender_id\n",
           //                                                                evt->evt_id, save_evt->result, save_evt->sender_id);

           MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_VIEW_PSE_CONTACT_PROC, evt->evt_id, save_evt->result, save_evt->sender_id);

           cui_phb_save_contact_close(save_evt->sender_id);
           
           break;
        }

        default:
        {
            ret = MMI_RET_DONT_CARE;
            break;
        }
    }

    return ret;
}


static void mmi_phb_pbapc_pse_list_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_ucm_make_call_para_struct call_para;


    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_PSE_LIST_CALL, phb_pbapc_cntx_p->pse_entry_index, phb_pbapc_cntx_p->contact_storage, phb_pbapc_cntx_p->phb_state);
    if (1 == phb_pbapc_cntx_p->phb_state)
    {
        return ;
    }

    phb_pbapc_cntx_p->phb_state = 1;
    memset(&(phb_pbapc_cntx_p->pse_phb), 0x00, sizeof(mmi_phb_pbapc_phb_info_struct));
    mmi_phb_pbapc_covert_data(&(phb_pbapc_cntx_p->pse_phb));
    if (phb_pbapc_cntx_p->pse_phb.num_count == 0)
    {
        /* show no number popup */
        //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] mmi_phb_pbapc_pse_list_call_read_entry_cb(null number call)\n");

        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_PSE_LIST_CALL_READ_ENTRY_CB_N_NUM_CALL);

        mmi_ucm_init_call_para(&call_para);

        call_para.ucs2_num_uri = phb_pbapc_cntx_p->pse_phb.num[0].number;
        phb_pbapc_cntx_p->pse_phb.num[0].number[0] = L'\0'; // set num null
        call_para.adv_para.after_callback_user_data = NULL;
        call_para.adv_para.after_make_call_callback = NULL;
        call_para.adv_para.highlight_dial_type = SRV_UCM_INVALID_CALL_TYPE;
        call_para.adv_para.is_ip_dial = MMI_FALSE;
        call_para.adv_para.module_id = SRV_UCM_MODULE_ORIGIN_COMMON;
        call_para.adv_para.phb_data = phb_pbapc_cntx_p->pse_phb.name;

        mmi_ucm_call_launch(0, &call_para);
    }
    else if (phb_pbapc_cntx_p->pse_phb.num_count > 1)
    {
        phb_pbapc_cntx_p->op_type = 1;

        mmi_phb_pbapc_select_op_number(GRP_ID_PHB_MAIN, mmi_phb_pbapc_view_sel_num_cb, 
                               (void *)0xbabe0002, &(phb_pbapc_cntx_p->pse_phb));
    }
    else /* just 1 number call directly */
    {
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_PSE_LIST_CALL_READ_ENTRY_CB_CALL);
        mmi_phb_pbapc_view_contact_op_call(0);
    }
    
}


static void cui_phb_pbapc_view_pse_contact(mmi_id parent_id, U16 entry_index, srv_phb_pbap_storage_enum storage)
{

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_VIEW_PSE_CONTACT, parent_id, entry_index, storage);

    mmi_frm_group_create_ex(parent_id, GRP_ID_PHB_PBAPC_VIEW_CONTACT, mmi_phb_pbapc_view_pse_contact_proc, NULL, MMI_FRM_NODE_NONE_FLAG);

    mmi_frm_scrn_create(GRP_ID_PHB_PBAPC_VIEW_CONTACT, SCR_ID_PHB_PBAP_VIEW_CONTACT_DETAIL, mmi_phb_pbapc_view_contact_scrn_proc, NULL);

}


static MMI_RET mmi_phb_pbapc_view_contact_scrn_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/


    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_INACTIVE:
        {
            break;

        }

        case EVT_ID_SCRN_ACTIVE:
        {
            mmi_phb_pbapc_show_pse_contact_detail();
            break;
        }

        case EVT_ID_SCRN_DEINIT:
            
        break;
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        {
            break;
        }
        default:
         break;
     }

    return MMI_RET_OK;
}

static void mmi_phb_pbapc_covert_data(mmi_phb_pbapc_phb_info_struct *phb_info)
{
    S32 i = 0;
    U16 entry_index;
    srv_phb_pbapc_btd_enum bt_index;

    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    if (phb_pbapc_cntx_p->list_type == 0)
    {
        entry_index =  phb_pbapc_cntx_p->pse_entry_index;
    }
    else
    {
        entry_index = phb_pbapc_cntx_p->cui_pse_entry_index;
    }
    memset(phb_info, 0x00, sizeof(mmi_phb_pbapc_phb_info_struct));
    bt_index = phb_pbapc_cntx_p->bt_index;
    phb_info->num_count = srv_phb_pbapc_get_number_count(bt_index, entry_index);
    srv_phb_pbapc_get_name(bt_index, entry_index, phb_info->name, SRV_PHB_PBAPC_NAME_LENGTH);
    for (i = 0; i < phb_info->num_count; i++)
    {
        srv_phb_pbapc_get_number(bt_index, entry_index, i, phb_info->num[i].number, &phb_info->num[i].type, SRV_PHB_PBAPC_NUMBER_LENGTH);
    }
}


static void mmi_phb_pbapc_show_pse_contact_detail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    CHAR *item_list[MAX_PHB_PBAPC_MAX_FIELDS * 2]; 
    S32 highlight_item = 0;
    U8 *gui_buffer = NULL;
    S32 item_num = 0;
    mmi_phb_pbapc_phb_info_struct *phb_info = NULL;
    S32 i = 0, k = 0;
    U16 str_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_info = &(phb_pbapc_cntx_p->pse_phb);

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] mmi_phb_pbapc_show_pse_contact_detail--pbapc_handle: 0x%x, num_count: %d\n",

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SHOW_PSE_CONTACT_DETAIL, 2, phb_info->num_count);

    phb_pbapc_cntx_p->phb_state = 0;
    phb_pbapc_cntx_p->op_type = 1;

    // reset status bar
    wgui_status_icon_bar_reset();

    gui_buffer = mmi_frm_scrn_get_active_gui_buf();

    RegisterHighlightHandler(mmi_phb_pbapc_view_contact_highlight_hdlr);

    wgui_fixed_list_register_get_flags_handler(mmi_phb_pbapc_set_pse_view_flags);

    if (phb_info->name[0])
    {
        item_list[0] = GetString(STR_ID_PHB_NAME);
        item_list[1] = (CHAR *)(phb_info->name);
        highlight_item = item_num;
        ++item_num;
    }

    for (i = 0, k = (item_num << 1); i < phb_info->num_count; ++i)
    {
        str_id = mmi_phb_pbapc_get_num_type(phb_info->num[i].type);
        item_list[k] = GetString(str_id);
        item_list[k + 1] = (CHAR *)(phb_info->num[i].number);
        k += 2;
    }
    if (phb_info->name[0])
    {
        highlight_item = 1;
    }
    else
    {
        highlight_item = 3;
    }

    if (gui_buffer)
    {
        highlight_item = (phb_pbapc_cntx_p->hlight_index << 1) + 1;
    }

    item_num += phb_info->num_count;
#if 1
    if (phb_info->num_count == 0)
    {
        item_num += 1;
        item_list[2] = GetString(STR_ID_PHB_NUMBER);
        item_list[3] = NULL;
    }
#endif 

    ShowCategory84Screen(
                STR_SCR_ENTRY_VIEW_CAPTION,
                GetRootTitleIcon(MAIN_MENU_PHONEBOOK_MENUID),
                0,
                0,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                item_num * 2,
                (U8 **) item_list,
                NULL,
                WGUI_CATE_ITEM_DISABLE_WITHOUT_CHANGE_TEXT_COLOR,
                highlight_item,
                gui_buffer);
}


static void mmi_phb_pbapc_view_contact_highlight_hdlr(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_pbapc_cntx_p->hlight_index = index >> 1;

    #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
    #endif

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, IMG_GLOBAL_OK);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        ChangeLeftSoftkey(STR_GLOBAL_OK, IMG_GLOBAL_OK);
    }
    else
    {
        ;
    }

    ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);
    SetLeftSoftkeyFunction(mmi_phb_pbapc_view_contact_option, KEY_EVENT_UP);
    
    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetCenterSoftkeyFunction(mmi_phb_pbapc_view_contact_option, KEY_EVENT_UP);

    SetRightSoftkeyFunction(mmi_phb_pbapc_view_contact_option_back, KEY_EVENT_UP);

    // add send key call handle
    SetKeyHandler(mmi_phb_pbapc_do_by_select, KEY_SEND, KEY_EVENT_UP);
}


static void mmi_phb_pbapc_view_contact_option_back(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    mmi_frm_scrn_close_active_id();

    if(mmi_frm_scrn_is_present(GRP_ID_PHB_PBAPC_VIEW_CONTACT, SCR_ID_PHB_PBAPC_VIEW_CONTACT, MMI_FRM_NODE_ALL_FLAG))
    {
        mmi_frm_scrn_close(GRP_ID_PHB_PBAPC_VIEW_CONTACT, SCR_ID_PHB_PBAPC_VIEW_CONTACT);
    }

    mmi_frm_group_close(GRP_ID_PHB_PBAPC_VIEW_CONTACT);
}


static void mmi_phb_pbapc_view_contact_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    MMI_ID menu_gid;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        menu_gid = cui_menu_create(
                               GRP_ID_PHB_PBAPC_VIEW_CONTACT,
                               CUI_MENU_SRC_TYPE_RESOURCE,
                               CUI_MENU_TYPE_OPTION,
                               MENU_ID_PHB_PBAPC_ENTRY_VIEW_OPTIONS,
                               MMI_FALSE,
                               NULL);
     

        cui_menu_set_default_title_image(menu_gid, (UI_image_type)GetImage(IMG_SCR_PBOOK_CAPTION));

        //if(mmi_bt_is_call_supported())
        if (MMI_TRUE)
        {
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_TRUE);
        }
    #ifdef __MMI_BTD_BOX_UI_STYLE__
        if(!mmi_phb_pbapc_is_connect())
        {
            cui_menu_set_item_disabled(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_TRUE);
        }
        else
        {
            cui_menu_set_item_disabled(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_DIAL, MMI_FALSE);
        }
    #endif /* __MMI_BTD_BOX_UI_STYLE__ */
        //if(mmi_bt_is_message_access_profile_supported())
        #ifndef __MMI_BTD_BOX_UI_STYLE__
        if (MMI_TRUE)
	#else /*__MMI_BTD_BOX_UI_STYLE__*/
	if (MMI_FALSE)
	#endif /*__MMI_BTD_BOX_UI_STYLE__*/
        {
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SEND_SMS, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SEND_SMS, MMI_TRUE);
        }

    #ifdef __MMI_TELEPHONY_SUPPORT__
        // save bt contact to local
        cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SAVE, MMI_FALSE);
    #else
        cui_menu_set_item_hidden(menu_gid, MENU_ID_PHB_PBAPC_VIEW_CONTACT_SAVE, MMI_TRUE);
    #endif /* __MMI_TELEPHONY_SUPPORT__ */

        cui_menu_set_default_title_image_by_id(menu_gid, IMG_SCR_PBOOK_CAPTION);

        cui_menu_run(menu_gid);
    }
    else if (phb_pbapc_cntx_p->list_type == 1)
    {
        //cui_phb_pbapc_bt_send_select_result(&phb_pbapc_cntx_p->pse_phb, 0);
        cui_phb_pbapc_bt_send_select_result(&phb_pbapc_cntx_p->cui_pse_phb, 0);

        mmi_frm_group_close(GRP_ID_PHB_PBAPC_VIEW_CONTACT);
    }
}


static MMI_BOOL mmi_phb_pbapc_set_pse_view_flags(S32 index, U32* flag, U32* flag_ex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    if (index % 2 == 0)
    {
        *flag |= UI_MENUITEM_STATE_DISABLED;
    }

    return MMI_TRUE;
}

static void mmi_phb_pbapc_do_by_select(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_sms_write_msg_para_struct op_msg_req;
    S32 index = -1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();


    /* 1. need chose number */
    if (phb_pbapc_cntx_p->hlight_index == 0 && // hlight name field
        phb_pbapc_cntx_p->pse_phb.num_count > 1)
    {

        mmi_phb_pbapc_select_op_number(GRP_ID_PHB_PBAP_OP_OPTION, mmi_phb_pbapc_view_sel_num_cb, 
                                (void *)0xbabe0a, &(phb_pbapc_cntx_p->pse_phb));
    }
    else
    {
        if (phb_pbapc_cntx_p->hlight_index == 0 ||
            phb_pbapc_cntx_p->pse_phb.num_count == 1)
        {
            index = 0;
        }
        else
        {
            index = phb_pbapc_cntx_p->hlight_index - 1;
        }
        if (phb_pbapc_cntx_p->op_type == 0)
        {
            mmi_phb_pbapc_view_contact_op_msg(index);
        }
        else
        {
            mmi_phb_pbapc_view_contact_op_call(index);

        }
    }
}

static void  mmi_phb_pbapc_view_contact_op_msg(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_sms_write_msg_para_struct op_msg_req;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    memset(&op_msg_req, 0x00, sizeof(mmi_sms_write_msg_para_struct));
    op_msg_req.ascii_addr = (U8 *)srv_phb_mem_malloc(sizeof(U8) * (MMI_PHB_NUMBER_LENGTH + 1) ,SRV_PHB_MEMORY_TYPE_CTR); 
    memset(op_msg_req.ascii_addr, 0x00, sizeof(U8) * (MMI_PHB_NUMBER_LENGTH + 1));
    mmi_wcs_n_to_asc((CHAR *) op_msg_req.ascii_addr, (WCHAR *) (phb_pbapc_cntx_p->pse_phb.num[index].number), MMI_PHB_NUMBER_LENGTH * ENCODING_LENGTH);
    op_msg_req.ascii_addr[MMI_PHB_NUMBER_LENGTH] = '\0';
    op_msg_req.flag = MMI_SMS_ENTRY_WRITE_REPLY;
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_VIEW_OP_MSG_V3,op_msg_req.ascii_addr);

    mmi_sms_write_msg_lanch(GRP_ID_PHB_PBAPC_VIEW_CONTACT, &op_msg_req);
    srv_phb_mem_free(op_msg_req.ascii_addr);

}


static void  mmi_phb_pbapc_save_pse_contact(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_ret gid = GRP_ID_INVALID;
    S32 index = -1;
    mmi_phb_pbapc_phb_info_struct *phb_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_info = &(phb_pbapc_cntx_p->pse_phb);

    gid = cui_phb_save_contact_create(GRP_ID_PHB_PBAP_OP_OPTION);

    cui_phb_save_contact_set_name(gid, phb_info->name, NULL);

    index = 0; // always sel the 1st number
    if (phb_pbapc_cntx_p->pse_phb.num_count >= 1)
    {
        //gid = cui_phb_save_contact_create(GRP_ID_PHB_PBAPC_VIEW_CONTACT);

        //cui_phb_save_contact_set_name(gid, phb_info->name, NULL);

        cui_phb_save_contact_set_number(gid, phb_info->num[index].number);

        cui_phb_save_contact_set_phb_info(gid, phb_info);

        //cui_phb_save_contact_run(gid);
    }

    cui_phb_save_contact_run(gid);

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] mmi_phb_pbapc_save_pse_contact--gid: %d, num_count: %d\n",
    //        gid, phb_info->num_count);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SAVE_PSE_CONTACT, gid, phb_info->num_count);
}


static void  mmi_phb_pbapc_view_contact_op_call(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_ucm_make_call_para_struct call_para;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();


    mmi_ucm_init_call_para(&call_para);

    call_para.ucs2_num_uri = phb_pbapc_cntx_p->pse_phb.num[index].number;
    call_para.adv_para.after_callback_user_data = NULL;
    call_para.adv_para.after_make_call_callback = NULL;
    call_para.adv_para.highlight_dial_type = SRV_UCM_INVALID_CALL_TYPE;
    call_para.adv_para.is_ip_dial = MMI_FALSE;
    call_para.adv_para.module_id = SRV_UCM_MODULE_ORIGIN_COMMON;
    call_para.adv_para.phb_data = phb_pbapc_cntx_p->pse_phb.name;
    mmi_ucm_call_launch(0, &call_para);

}


static S32 mmi_phb_pbapc_view_sel_num_cb(mmi_phb_pbapc_cb_info_struct *cb_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    S32 index = -1;
    mmi_ucm_make_call_para_struct call_para;
    mmi_sms_write_msg_para_struct op_msg_req;
    mmi_phb_pbapc_sel_num_rsp_struct *sel_num_rsp;
    S32 ret = 0;
    U16 entry_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    sel_num_rsp = (mmi_phb_pbapc_sel_num_rsp_struct *) (cb_info->type_rsp);
    entry_index = phb_pbapc_cntx_p->pse_entry_index;
    if (sel_num_rsp->ret == 0)
    {
        index = sel_num_rsp->sel_index;
        srv_phb_pbapc_get_number(phb_pbapc_cntx_p->bt_index, entry_index, index, phb_pbapc_cntx_p->pse_phb.num[index].number, NULL, SRV_PHB_PBAPC_NUMBER_LENGTH);
        if (phb_pbapc_cntx_p->op_type == 0) // msg
        {
            mmi_phb_pbapc_view_contact_op_msg(index);

        }
        else if (phb_pbapc_cntx_p->op_type == 1) // call
        {
            mmi_phb_pbapc_view_contact_op_call(index);
        }
        else
        {
            ;
        }
    }

    return ret;
}


static U16 mmi_phb_pbapc_get_num_type(U8 num_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 str_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (num_type)
    {
        case VCARD_TEL_TYPE_CELL:
            str_id = STR_ID_PHB_MOBILE_NUMBER;
            break;

        case VCARD_TEL_TYPE_HOME:
            str_id = STR_HOME_NUMBER;
            break;

        case VCARD_TEL_TYPE_WORK:
            str_id = STR_OFFICE_NUMBER;
            break;

        case VCARD_TEL_TYPE_FAX:
            str_id = STR_FAX_NUMBER;
            break;

        default:
            str_id = STR_ID_PHB_NUMBER;
            break;
    }

    return str_id;
}


static mmi_ret mmi_phb_pbapc_view_pse_contact_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_ret menu_cui_proc = MMI_RET_DONT_CARE;
    cui_phb_save_contact_result_struct *save_evt = NULL;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    menu_cui_proc = mmi_phb_pbapc_menu_cui_proc(evt);
 
    if (menu_cui_proc == MMI_RET_OK)
    {
        return MMI_RET_OK;
    }

    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_FIRST_ENTRY:
            break;
            
        case EVT_ID_GROUP_INACTIVE:
        {
            break;
        }
        case EVT_ID_GROUP_ACTIVE:
             break;
            
        case EVT_ID_GROUP_GOBACK:
        case EVT_ID_GROUP_DELETE_REQ:
             break;

        case EVT_ID_GROUP_DEINIT:
        {
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif 
            break;
        }

        case EVT_ID_GROUP_FOCUSED:
        case EVT_ID_GROUP_REDRAW_START:
            break;

        case EVT_ID_PHB_SAVE_CONTACT:
        case EVT_ID_PHB_SAVE_CONTACT_CANCEL:
        {
            save_evt = (cui_phb_save_contact_result_struct *) evt;

            //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] mmi_phb_pbapc_view_pse_contact_proc(save contact)--evt->id: %d, ret: %d, sender_id\n",
            //                                                                evt->evt_id, save_evt->result, save_evt->sender_id);

            MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_VIEW_PSE_CONTACT_PROC, evt->evt_id, save_evt->result, save_evt->sender_id);

            cui_phb_save_contact_close(save_evt->sender_id);
            
            break;
        }

        default:
            break;
    }

    return MMI_RET_OK;
}


void mmi_phb_pbapc_select_op_number(mmi_id parent_id, mmi_phb_pbapc_cb_func sel_cb_func,
                        void *user_data, mmi_phb_pbapc_phb_info_struct *phb_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    phb_pbapc_cntx_p->sel_num_pid = parent_id;
    phb_pbapc_cntx_p->sel_cb_func = sel_cb_func;
    phb_pbapc_cntx_p->sel_num_ud = user_data;
    memcpy(&(phb_pbapc_cntx_p->sel_phb_info), phb_info, sizeof(mmi_phb_pbapc_phb_info_struct));

    mmi_frm_scrn_create(parent_id, SCR_ID_PHB_PBAPC_SEL_OP_NUM, mmi_phb_pbapc_select_op_number_proc, NULL);
}


static MMI_RET mmi_phb_pbapc_select_op_number_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_ACTIVE:
        {
            mmi_phb_pbapc_show_select_number();
            break;
        }

        default:
         break;
    }

    return MMI_RET_OK;
}


static void mmi_phb_pbapc_show_select_number(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    CHAR *item_list[MAX_PHB_PBAPC_MAX_FIELDS * 2]; 
    S32 highlight_item = 0;
    U8 *gui_buffer = NULL;
    mmi_phb_pbapc_phb_info_struct *phb_info = NULL;
    S32 i = 0, k = 0;
    U16 str_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_info = &(phb_pbapc_cntx_p->sel_phb_info);
    mmi_phb_pbapc_covert_data(phb_info);
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_COVERT_DATA, phb_pbapc_cntx_p->bt_index, phb_info->num_count,phb_info->name[0], 0);
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();

    RegisterHighlightHandler(mmi_phb_pbapc_select_number_hlight_hdlr);

    wgui_fixed_list_register_get_flags_handler(mmi_phb_pbapc_set_pse_view_flags);

    for (i = 0, k = 0; i < phb_info->num_count; ++i)
    {
        str_id = mmi_phb_pbapc_get_num_type(phb_info->num[i].type);
        item_list[k] = GetString(str_id);
        item_list[k + 1] = (CHAR *)(phb_info->num[i].number);
        k += 2;
    }

    if (gui_buffer)
    {
        highlight_item = (phb_pbapc_cntx_p->sel_hlight_index << 1) + 1 ;
    }
    else
    {
        highlight_item = 1;
    }

    ShowCategory84Screen(
                STR_GLOBAL_SELECT,
                GetRootTitleIcon(MAIN_MENU_PHONEBOOK_MENUID),
                0,
                0,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                phb_info->num_count * 2,
                (U8 **) item_list,
                NULL,
                WGUI_CATE_ITEM_DISABLE_WITHOUT_CHANGE_TEXT_COLOR,
                highlight_item,
                gui_buffer);
}


static void mmi_phb_pbapc_select_number_hlight_hdlr(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    phb_pbapc_cntx_p->sel_hlight_index = index >> 1;

   
    ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);
    SetRightSoftkeyFunction(mmi_phb_pbapc_select_num_cancel, KEY_EVENT_UP);

    ChangeLeftSoftkey(STR_GLOBAL_SELECT, IMG_GLOBAL_OK); 
    SetLeftSoftkeyFunction(mmi_phb_pbapc_select_num_ok, KEY_EVENT_UP);

    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetCenterSoftkeyFunction(mmi_phb_pbapc_select_num_ok, KEY_EVENT_UP);

    if (phb_pbapc_cntx_p->list_type == 0)
    {
        SetKeyHandler(mmi_phb_pbapc_select_num_ok, KEY_SEND, KEY_EVENT_UP);
    }
}


static void mmi_phb_pbapc_select_num_ok(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_select_num_done(0);
}


static void mmi_phb_pbapc_select_num_cancel(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_select_num_done(-1);
}


static void mmi_phb_pbapc_select_num_done(S32 ret)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_phb_pbapc_sel_num_rsp_struct sel_num_rsp;
    mmi_phb_pbapc_cb_info_struct cb_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    sel_num_rsp.ret = ret;
    sel_num_rsp.sel_index = phb_pbapc_cntx_p->sel_hlight_index;

    cb_info.cb_type = 1;
    cb_info.type_rsp = (void *)&sel_num_rsp;
    cb_info.user_data = phb_pbapc_cntx_p->sel_num_ud;
    phb_pbapc_cntx_p->sel_cb_func(&cb_info);

    mmi_frm_scrn_close(phb_pbapc_cntx_p->sel_num_pid, SCR_ID_PHB_PBAPC_SEL_OP_NUM);
}


void mmi_phb_pbapc_set_list_type(U8 list_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_pbapc_cntx_p->list_type = list_type;
    if (list_type == 0)
    {
        phb_pbapc_cntx_p->qsearch_input_buffer = phb_pbapc_cntx_p->phb_input_buffer[phb_pbapc_cntx_p->bt_index];
    }
    else if (list_type == 1)
    {
        phb_pbapc_cntx_p->qsearch_input_buffer = phb_pbapc_cntx_p->cui_input_buffer[phb_pbapc_cntx_p->bt_index];
    }
    else
    {
        MMI_ASSERT(0);
    }
}


mmi_ret mmi_phb_pbapc_notify_evt_hdlr(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 index;
    srv_pbapc_notify_event_struct *notify_evt = NULL;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    notify_evt = (srv_pbapc_notify_event_struct *)evt;
    index = notify_evt->bt_index;

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_NOTIFY_V3, notify_evt->evt_id, index, notify_evt->type);

    if (notify_evt->evt_id == EVT_ID_PBAP_NOTIFY && (notify_evt->type == EVT_ID_PBAPC_DISCONNECT_IND || notify_evt->type == EVT_ID_PBAPC_DISCONNECT_RSP))
    {
        /* reset hlight tab */
        phb_pbapc_cntx_p->phb_list = 0;
        phb_pbapc_cntx_p->cui_list = 0;
        phb_pbapc_cntx_p->is_inbg[index] = 0;
        phb_pbapc_cntx_p->is_stop[index] = 0;
        phb_pbapc_cntx_p->flag[index] = 0;
        wgui_status_icon_bar_hide_icon(STATUS_ICON_BT_SYNC_PB_BG);
        if (phb_pbapc_cntx_p->list_state == 1)
        {
            mmi_frm_display_dummy_screen();
            mmi_frm_scrn_close_active_id();
        }
        if (notify_evt->bt_index == phb_pbapc_cntx_p->bt_index)
        {
            phb_pbapc_cntx_p->pse_list_index = 0;
            mmi_phb_pbapc_show_loading_abort(phb_pbapc_cntx_p->parent_id, SCR_ID_PHB_PROCESSING);
            if (mmi_frm_group_is_present(GRP_ID_PHB_PBAP_OP_OPTION))
            {
                mmi_frm_group_close(GRP_ID_PHB_PBAP_OP_OPTION);
            }
        }
    }
    #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
    #endif

    return MMI_RET_OK;
}


#if defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
static void mmi_phb_pbapc_bt_list_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_TAP_CB_V3, tap_type);
        mmi_phb_pbapc_pse_list_op_option();

        return;
    }
    else
    {
        return;
    }
}
#endif /* defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__) */


#define LOCAL_CUI_PHB_PBAPC_SELECT_CONTACT_API

/* select contact cui */
static mmi_ret cui_phb_pbapc_select_contact_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_ret menu_cui_proc;
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    menu_cui_proc = mmi_phb_pbapc_menu_cui_proc(evt);

    if (menu_cui_proc == MMI_RET_OK)
    {
        return MMI_RET_OK;
    }

    switch (evt->evt_id)
    {
        case EVT_ID_SCENAIO_CHANGE:
            break;

        case EVT_ID_GROUP_INACTIVE:
        {
            break;
        }

        case EVT_ID_GROUP_FIRST_ENTRY:
            break;

        case EVT_ID_GROUP_ACTIVE:
            break;

        case EVT_ID_GROUP_GOBACK:
        case EVT_ID_GROUP_DELETE_REQ:
            break;

        case EVT_ID_GROUP_DEINIT:
        {
            //phb_pbapc_cntx_p->qsearch_input_buffer[0] = 0;
#if 0 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif 
        }

            break;

        case EVT_ID_GROUP_FOCUSED:
        case EVT_ID_GROUP_REDRAW_START:
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


static void cui_phb_pbapc_select_contact_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __MMI_TELEPHONY_SUPPORT__
    mmi_frm_tab_struct pbapc_tab_pages_info_array[MMI_PHB_MAIN_SCREEN_TAB_COUNT];
#else
    mmi_frm_tab_struct pbapc_tab_pages_info_array[SRV_PBAPC_LINK_NUM];

#endif
      S32 ret;
      srv_bt_cm_bt_addr bt_addr;
#if SRV_PBAPC_LINK_NUM >= 2
      S32 ret1;
#endif

    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    S32 tab_num = 0;
    U8 tab_index = 0;
    U8 i = 0;


    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_set_list_type(1);
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
#if SRV_PBAPC_LINK_NUM >= 2
    srv_phb_pbapc_get_btd_addr(&bt_addr, 0);
    ret = srv_bt_cm_is_profile_connected_ex(SRV_BT_CM_PBAPC_CONNECTION, &bt_addr);
    srv_phb_pbapc_get_btd_addr(&bt_addr, 1);

    ret1 = srv_bt_cm_is_profile_connected_ex(SRV_BT_CM_PBAPC_CONNECTION, &bt_addr);

#ifdef __MMI_TELEPHONY_SUPPORT__
    pbapc_tab_pages_info_array[tab_num].screen_id = SCR_ID_PHB_PBAPC_LOCAL;
    pbapc_tab_pages_info_array[tab_num].tab_entry_func = cui_phb_pbapc_select_contact_local_entry;

#ifdef __MMI_PHB_UI_IN_TABS__
    pbapc_tab_pages_info_array[tab_num].tab_icon = (U8*)GetImage(IMG_ID_PHB_TAB_LIST);
    pbapc_tab_pages_info_array[tab_num].tab_string = NULL;
#else
    pbapc_tab_pages_info_array[tab_num].tab_icon = NULL;
    pbapc_tab_pages_info_array[tab_num].tab_string = GetString(STR_ID_PHB_PBAPC_LOCAL);
#endif
    tab_num++;
#endif
   // for (;tab_num < SRV_PBAPC_LINK_NUM; tab_num++)
    {
        pbapc_tab_pages_info_array[tab_num].screen_id = (SCR_ID_PHB_PBAPC_BT);
        pbapc_tab_pages_info_array[tab_num].tab_entry_func = cui_phb_pbapc_select_contact_bt_entry;
#ifdef __MMI_PHB_UI_IN_TABS__
        pbapc_tab_pages_info_array[tab_num].tab_icon = (U8*)GetImage(IMG_ID_PHB_TAB_BT_LIST);
        pbapc_tab_pages_info_array[tab_num].tab_string = NULL;
#else
        pbapc_tab_pages_info_array[tab_num].tab_icon = NULL;
        pbapc_tab_pages_info_array[tab_num].tab_string = GetString(STR_ID_PHB_PBAPC_BT);
#endif
    }

    tab_num++;
    
    pbapc_tab_pages_info_array[tab_num].screen_id = (SCR_ID_PHB_PBAPC_BT1);
    pbapc_tab_pages_info_array[tab_num].tab_entry_func = cui_phb_pbapc_select_contact_bt_entry;
#ifdef __MMI_PHB_UI_IN_TABS__
    pbapc_tab_pages_info_array[tab_num].tab_icon = NULL; //(U8*)GetImage(IMG_ID_PHB_TAB_BT_LIST);
    pbapc_tab_pages_info_array[tab_num].tab_string = NULL;
#else
    pbapc_tab_pages_info_array[tab_num].tab_icon = NULL;
    pbapc_tab_pages_info_array[tab_num].tab_string = GetString(STR_ID_PHB_PBAPC_BT);
#endif

    if(!ret && !ret1)
        {
            tab_index = 0; // disconnected hlight local
        }
        else if (!ret && ret1)
        {
            if (phb_pbapc_cntx_p->cui_list== 0)
            {
                tab_index = 1;
            }
            else if (phb_pbapc_cntx_p->cui_list == 1)
            {
                tab_index = 0;
            }
            else if (phb_pbapc_cntx_p->cui_list == 2)
            {
        #ifdef __MMI_TELEPHONY_SUPPORT__
                tab_index = 1;
        #else
                tab_index = 0;
        #endif
            }
            else if (phb_pbapc_cntx_p->cui_list == 3)
            {
        #ifdef __MMI_TELEPHONY_SUPPORT__
                tab_index = 2;
        #else
                tab_index = 1;
        #endif
            }
        }
        else
        {
            if (phb_pbapc_cntx_p->cui_list == 0)
            {
        #ifdef __MMI_TELEPHONY_SUPPORT__
                tab_index = 1;
        #else
                tab_index = 0;
        #endif
            }
            else if (phb_pbapc_cntx_p->cui_list == 1)
            {
                tab_index = 0;
            }
            else if (phb_pbapc_cntx_p->cui_list == 2)
            {
        #ifdef __MMI_TELEPHONY_SUPPORT__
                tab_index = 1;
        #else
                tab_index = 0;
        #endif
            }
            else if (phb_pbapc_cntx_p->cui_list == 3)
            {
        #ifdef __MMI_TELEPHONY_SUPPORT__
                tab_index = 2;
        #else
                tab_index = 1;
        #endif
            }
    
        }       

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SELECT_CONTACT_ENTRY, phb_pbapc_cntx_p->cui_list,
                tab_index, 0);
#ifdef __MMI_TAB_BAR_SUPPORT_TAB_PAGE__
    cui_tab_create(
                GRP_ID_PHB_PBAPC_SELECT_CONTACT,
                SCR_ID_PHB_PBAPC_TAB,
                pbapc_tab_pages_info_array,
                #ifdef __MMI_TELEPHONY_SUPPORT__
                MMI_PHB_MAIN_SCREEN_TAB_COUNT,
                #else
                SRV_PBAPC_LINK_NUM,
                #endif
                tab_index,
                NULL);
#else
    mmi_frm_scrn_tab_enter(
                    GRP_ID_PHB_PBAPC_SELECT_CONTACT,
                    SCR_ID_PHB_PBAPC_TAB,
                    cui_phb_pbapc_select_contact_exit,
                    cui_phb_pbapc_select_contact_entry,
                    pbapc_tab_pages_info_array,
            #ifdef __MMI_TELEPHONY_SUPPORT__
                    MMI_PHB_MAIN_SCREEN_TAB_COUNT,
            #else
                    SRV_PBAPC_LINK_NUM,
            #endif

                    tab_index);
#endif
#else /*SRV_PBAPC_LINK_NUM> = 2*/

#ifdef __MMI_TELEPHONY_SUPPORT__

    pbapc_tab_pages_info_array[tab_num].screen_id = SCR_ID_PHB_PBAPC_LOCAL;
    pbapc_tab_pages_info_array[tab_num].tab_entry_func = cui_phb_pbapc_select_contact_local_entry;

#ifdef __MMI_PHB_UI_IN_TABS__
    pbapc_tab_pages_info_array[tab_num].tab_icon = (U8*)GetImage(IMG_ID_PHB_TAB_LIST);
    pbapc_tab_pages_info_array[tab_num].tab_string = NULL;
#else
    pbapc_tab_pages_info_array[tab_num].tab_icon = NULL;
    pbapc_tab_pages_info_array[tab_num].tab_string = GetString(STR_ID_PHB_PBAPC_LOCAL);
#endif
    tab_num++;
   // for (;tab_num < SRV_PBAPC_LINK_NUM; tab_num++)
    {
        pbapc_tab_pages_info_array[tab_num].screen_id = (SCR_ID_PHB_PBAPC_BT);
        pbapc_tab_pages_info_array[tab_num].tab_entry_func = cui_phb_pbapc_select_contact_bt_entry;
#ifdef __MMI_PHB_UI_IN_TABS__
        pbapc_tab_pages_info_array[tab_num].tab_icon = (U8*)GetImage(IMG_ID_PHB_TAB_BT_LIST);
        pbapc_tab_pages_info_array[tab_num].tab_string = NULL;
#else
        pbapc_tab_pages_info_array[tab_num].tab_icon = NULL;
        pbapc_tab_pages_info_array[tab_num].tab_string = GetString(STR_ID_PHB_PBAPC_BT);
#endif
    }

    if(!mmi_phb_pbapc_is_connect())
    {
        tab_index = 0; // disconnected hlight local
    }
    else
    {
        if (phb_pbapc_cntx_p->cui_list == 0)
        {
            tab_index = 1;
        }
        else if (phb_pbapc_cntx_p->cui_list == 1)
        {
            tab_index = 0;
        }
        else if (phb_pbapc_cntx_p->cui_list == 2)
        {
            tab_index = 1;
        }
    }

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SELECT_CONTACT_ENTRY, phb_pbapc_cntx_p->cui_list,
                tab_index, 0);
#ifdef __MMI_TAB_BAR_SUPPORT_TAB_PAGE__
    cui_tab_create(
                GRP_ID_PHB_PBAPC_SELECT_CONTACT,
                SCR_ID_PHB_PBAPC_TAB,
                pbapc_tab_pages_info_array,
                MMI_PHB_MAIN_SCREEN_TAB_COUNT,
                tab_index,
                NULL);
#else
    mmi_frm_scrn_tab_enter(
                    GRP_ID_PHB_PBAPC_SELECT_CONTACT,
                    SCR_ID_PHB_PBAPC_TAB,
                    cui_phb_pbapc_select_contact_exit,
                    cui_phb_pbapc_select_contact_entry,
                    pbapc_tab_pages_info_array,
                    MMI_PHB_MAIN_SCREEN_TAB_COUNT,
                    tab_index);
#endif


#else /*__MMI_TELEPHONY_SUPPORT__*/
    mmi_phb_pbapc_entry_list();
#endif /*__MMI_TELEPHONY_SUPPORT__ NUM == 1*/
#endif /*SRV_PBAPC_LINK_NUM> = 2*/
}


static void cui_phb_pbapc_select_contact_exit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


static S32 mmi_phb_pbapc_local_find_entry(U8 *keyword)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 key_length;
    S32 result_count;
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    srv_phb_filter_struct filter;
    srv_phb_qsearch_filter_struct qsearch_filter;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Count the input string length to decide behavior */
    key_length = (U8) mmi_ucs2strlen((CHAR*) keyword);
    
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_pbapc_cntx_p->local_contact_hlight_index = 0;

    filter.storage = PHB_STORAGE_MAX;
    filter.field_filter = SRV_PHB_ENTRY_FIELD_GSM_NUM;
    filter.name_filter = NULL;
    filter.qsearch_filter = NULL;
    filter.group_filter = NULL;

    if (key_length > 0)
    {
        qsearch_filter.key_len = key_length;
        qsearch_filter.key_word = (U16*)keyword;
        qsearch_filter.input_mode = (U16)mmi_imm_get_curr_input_mode();
        filter.qsearch_filter = &qsearch_filter;
    }

    phb_pbapc_cntx_p->local_contact_count = (U16) srv_phb_oplib_build_contact_list(&filter, phb_pbapc_cntx_p->local_contact_id, MMI_PHB_ENTRIES);
    result_count = phb_pbapc_cntx_p->local_contact_count;

    if (result_count == 0)
    {
        SetKeyHandler(mmi_frm_general_tab_l_arrow_key_hdlr, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
        SetKeyHandler(mmi_frm_general_tab_r_arrow_key_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    }

    return result_count;
}


static void cui_phb_pbapc_local_show_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    U8 *gui_buffer = NULL;
    S32 has_lsk = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    gui_buffer = mmi_frm_scrn_get_active_gui_buf();

    if (gui_buffer == NULL)
    {
        phb_pbapc_cntx_p->local_contact_hlight_index = 0;
        phb_pbapc_cntx_p->local_qsearch_input_buffer[0] = 0;
    }

    if (phb_pbapc_cntx_p->local_contact_count)
    {
        has_lsk = MMI_TRUE;
    }

    RegisterHighlightHandler(cui_phb_pbapc_local_list_highlight_hdlr);

#ifndef __MMI_PHB_QUICK_SEARCH__
    wgui_cat1032_show(
            (WCHAR*) GetString(STR_SCR_PBOOK_VIEW_CAPTION),
            (PU8) GetImage(IMG_SCR_PBOOK_CAPTION),
            //(WCHAR*) GetString(STR_GLOBAL_OK),
            //(PU8) GetImage(IMG_GLOBAL_OK),
            has_lsk ?(WCHAR*) GetString(STR_GLOBAL_OK) : NULL,
            has_lsk ?(PU8) GetImage(IMG_GLOBAL_OK) : NULL,
            (WCHAR*) GetString(STR_GLOBAL_BACK),
            (PU8) GetImage(IMG_GLOBAL_BACK),
            phb_pbapc_cntx_p->local_contact_count,
            cui_phb_pbapc_local_get_get_item,
            NULL,
            phb_pbapc_cntx_p->local_contact_hlight_index,
            0,
            IMG_STORAGE_SIM,
            IMG_GLOBAL_SIM1,
            gui_buffer,
            NULL);
    SetRightSoftkeyFunction(cui_phb_pbapc_local_list_option_back, KEY_EVENT_UP);
#else
    RegisterCat200SearchFunction(mmi_phb_pbapc_local_find_entry);
    wgui_cat_set_search_icon(IMG_ID_PHB_QUICK_SEARCH_FIND);
    ShowCategory199Screen_ext(
        has_lsk ?(UI_string_type)GetString(STR_GLOBAL_OK) : NULL,
        has_lsk ?(PU8)GetImage(IMG_GLOBAL_OK) : NULL,
        (UI_string_type)GetString(STR_GLOBAL_BACK),
        (PU8)GetImage(IMG_GLOBAL_BACK),
        0,        
        (UI_string_type)GetString(STR_SCR_PBOOK_VIEW_CAPTION),
        NULL,
        phb_pbapc_cntx_p->local_contact_count,
        cui_phb_pbapc_local_get_get_item,
        NULL,
        NULL,
        NULL,
        phb_pbapc_cntx_p->local_contact_hlight_index,
        get_image(IMG_GLOBAL_L1),
        get_image(IMG_STORAGE_SIM),
        (U8*) phb_pbapc_cntx_p->local_qsearch_input_buffer,
        MMI_PHB_QUICK_SEARCH_INPUT_LENGTH,
        gui_buffer);
    SetCategory200RightSoftkeyFunction(cui_phb_pbapc_local_list_option_back, KEY_EVENT_UP);
#endif

    ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);
}


static S32 cui_phb_pbapc_local_get_get_item(S32 start_index, gui_iconlist_menu_item *menu_data, S32 num_items)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < num_items; i++)
    {
        cui_phb_pbapc_local_get_get_item_int((i + start_index), menu_data[i].item_list[0], &menu_data[i].image_list[0], &menu_data[i].image_list[1]);
    }

    return num_items;
}


static pBOOL cui_phb_pbapc_local_get_get_item_int(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p1, PU8 *img_buff_p2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    U16 contact_id = SRV_PHB_INVALID_INDEX;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    contact_id = phb_pbapc_cntx_p->local_contact_id[item_index];

    srv_phb_get_name(contact_id, str_buff, 2 * MMI_PHB_NAME_FIELD_LENGTH + 1);

    if (str_buff[0] == 0)
    {
        mmi_ucs2ncpy((CHAR*) str_buff, GetString(STR_ID_PHB_UNNAMED), MAX_SUBMENU_CHARACTERS);
    }

    mmi_phb_contact_get_item_image(contact_id, img_buff_p1, img_buff_p2);

    return TRUE;
}


static void cui_phb_pbapc_local_list_highlight_hdlr(S32 item_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    U16 *local_contact_id = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    local_contact_id = phb_pbapc_cntx_p->local_contact_id;

    phb_pbapc_cntx_p->local_contact_hlight_index = item_index;

    ChangeLeftSoftkey(STR_GLOBAL_OK, IMG_GLOBAL_OK);
    ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);

    SetLeftSoftkeyFunction(cui_phb_pbapc_local_list_option, KEY_EVENT_UP);
    SetRightSoftkeyFunction(cui_phb_pbapc_local_list_option_back, KEY_EVENT_UP);

    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetCenterSoftkeyFunction(cui_phb_pbapc_local_list_option, KEY_EVENT_UP);

#ifdef __MMI_PHB_QUICK_SEARCH__
    SetKeyHandler(mmi_frm_general_tab_l_arrow_key_hdlr, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_frm_general_tab_r_arrow_key_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
#endif
}


static void cui_phb_pbapc_local_list_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    cui_phb_pbapc_select_contact_rsp_struct sel_rsp;
    cui_phb_pbapc_select_contact_ret_struct sel_ret;
    mmi_phb_contact_id contact_id;
    U32 field_mask = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    contact_id = phb_pbapc_cntx_p->local_contact_id[phb_pbapc_cntx_p->local_contact_hlight_index];

    memset(&sel_ret, 0x00, sizeof(cui_phb_pbapc_select_contact_ret_struct));

    MMI_FRM_INIT_EVENT(&sel_rsp, EVT_ID_PHB_PBAPC_SEL_CONTACT);

    sel_rsp.sender_id = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
    sel_rsp.cb_user_data = phb_pbapc_cntx_p->cui_sel_contact_ud;
    sel_rsp.rsp_type = MMI_PHB_PBAPC_SEL_RESULT;
    sel_rsp.rsp = (void *)&sel_ret;

    /* sel ok result */
    sel_ret.ret = MMI_PHB_PBAPC_SEL_RET_OK;
    sel_ret.contact_type = MMI_PHB_PBAPC_CONTACT_LOCAL;
    sel_ret.contact_id = contact_id;
    sel_ret.sub_id = 0;

    srv_phb_get_name(contact_id, sel_ret.name, MMI_PHB_PBAPC_MAX_NAME_LEN);
    sel_ret.name[MMI_PHB_PBAPC_MAX_NAME_LEN] = L'\0';
    srv_phb_get_number(contact_id, sel_ret.number, MMI_PHB_PBAPC_MAX_NUM_LEN);
    sel_ret.number[MMI_PHB_PBAPC_MAX_NUM_LEN] = L'\0';

    field_mask = 0;
    if (sel_ret.name[0])
    {
        field_mask |= 0x01;
    }
    
    if (sel_ret.number[0])
    {
        field_mask |= 0x02;
    }

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_local_list_option--pid: %d, 0x%x\n",
    //                                                                phb_pbapc_cntx_p->cui_sel_contact_pid, field_mask);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_LOCAL_LIST_OPTION, phb_pbapc_cntx_p->cui_sel_contact_pid, field_mask);

    cui_phb_send_data_to_sa(GRP_ID_PHB_PBAPC_SELECT_CONTACT, &sel_rsp);

    cui_phb_pbapc_select_contact_send_req_close();
}


static void cui_phb_pbapc_local_list_option_back(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    cui_phb_pbapc_select_contact_rsp_struct sel_rsp;
    cui_phb_pbapc_select_contact_ret_struct sel_ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    memset(&sel_ret, 0x00, sizeof(cui_phb_pbapc_select_contact_ret_struct));

    MMI_FRM_INIT_EVENT(&sel_rsp, EVT_ID_PHB_PBAPC_SEL_CONTACT);

    sel_rsp.sender_id = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
    sel_rsp.cb_user_data = phb_pbapc_cntx_p->cui_sel_contact_ud;
    sel_rsp.rsp_type = MMI_PHB_PBAPC_SEL_RESULT;
    sel_rsp.rsp = (void *)&sel_ret;

    /* sel ok cancle */
    sel_ret.ret = MMI_PHB_PBAPC_SEL_RET_CANCEL;

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_local_list_option_back--pid: %d\n",
    //                                                                phb_pbapc_cntx_p->cui_sel_contact_pid);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_LOCAL_LIST_OPTION_BACK, phb_pbapc_cntx_p->cui_sel_contact_pid);

    cui_phb_send_data_to_sa(GRP_ID_PHB_PBAPC_SELECT_CONTACT, &sel_rsp);

    cui_phb_pbapc_select_contact_send_req_close();
}


static void cui_phb_pbapc_select_contact_send_req_close(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    cui_phb_pbapc_select_contact_rsp_struct sel_rsp;
    cui_phb_pbapc_select_contact_req_close_struct req_close;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    memset(&req_close, 0x00, sizeof(cui_phb_pbapc_select_contact_req_close_struct));

    MMI_FRM_INIT_EVENT(&sel_rsp, EVT_ID_PHB_PBAPC_SEL_CONTACT);

    sel_rsp.sender_id = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
    sel_rsp.cb_user_data = phb_pbapc_cntx_p->cui_sel_contact_ud;
    sel_rsp.rsp_type = MMI_PHB_PBAPC_SEL_REQ_CLOSE;
    sel_rsp.rsp = (void *)&req_close;

    req_close.ret = MMI_PHB_PBAPC_SEL_RET_OK;

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_select_contact_send_req_close--pid: %d\n",
    //                                                                phb_pbapc_cntx_p->cui_sel_contact_pid);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SEL_SEND_REQ_CLOSE, phb_pbapc_cntx_p->cui_sel_contact_pid);

    cui_phb_send_data_to_sa(GRP_ID_PHB_PBAPC_SELECT_CONTACT, &sel_rsp);
}


void cui_phb_pbapc_bt_send_select_result(mmi_phb_pbapc_phb_info_struct *pse_phb, S32 ret)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    cui_phb_pbapc_select_contact_rsp_struct sel_rsp;
    cui_phb_pbapc_select_contact_ret_struct sel_ret;
    S32 index = 0;
    U32 field_mask = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    memset(&sel_ret, 0x00, sizeof(cui_phb_pbapc_select_contact_ret_struct));

    MMI_FRM_INIT_EVENT(&sel_rsp, EVT_ID_PHB_PBAPC_SEL_CONTACT);

    sel_rsp.sender_id = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
    sel_rsp.cb_user_data = phb_pbapc_cntx_p->cui_sel_contact_ud;
    sel_rsp.rsp_type = MMI_PHB_PBAPC_SEL_RESULT;
    sel_rsp.rsp = (void *)&sel_ret;

    if (ret == 0)
    {
        index = phb_pbapc_cntx_p->hlight_index - 1;

        /* sel ok result */
        sel_ret.ret = MMI_PHB_PBAPC_SEL_RET_OK;
        sel_ret.contact_type = MMI_PHB_PBAPC_CONTACT_BT;
        sel_ret.entry_index = phb_pbapc_cntx_p->cui_pse_entry_index;
        sel_ret.storage = phb_pbapc_cntx_p->cui_contact_storage;
        sel_ret.num_type = pse_phb->num[index].type;

        mmi_wcsncpy(sel_ret.name, pse_phb->name, MMI_PHB_PBAPC_MAX_NAME_LEN);
        sel_ret.name[MMI_PHB_PBAPC_MAX_NAME_LEN] = L'\0';

        mmi_wcsncpy(sel_ret.number, pse_phb->num[index].number, MMI_PHB_PBAPC_MAX_NUM_LEN);
        sel_ret.number[MMI_PHB_PBAPC_MAX_NUM_LEN] = L'\0';

        field_mask = 0;
        if (sel_ret.name[0])
        {
            field_mask |= 0x01;
        }

        if (sel_ret.number[0])
        {
            field_mask |= 0x02;
        }
    }
    else if (ret == 1)
    {
        sel_ret.ret = MMI_PHB_PBAPC_SEL_RET_CANCEL;
    }

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_bt_send_select_result--ret: %d, field_mask: 0x%x\n",
    //                                                                ret, field_mask);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SEND_SEL_RESULT, ret, field_mask);

    cui_phb_send_data_to_sa(GRP_ID_PHB_PBAPC_SELECT_CONTACT, &sel_rsp);

    cui_phb_pbapc_select_contact_send_req_close();
}


static void cui_phb_pbapc_bt_send_select_result_ext(mmi_phb_pbapc_phb_info_struct *pse_phb, S32 index, S32 ret)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    cui_phb_pbapc_select_contact_rsp_struct sel_rsp;
    cui_phb_pbapc_select_contact_ret_struct sel_ret;
    U32 field_mask = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    memset(&sel_ret, 0x00, sizeof(cui_phb_pbapc_select_contact_ret_struct));

    MMI_FRM_INIT_EVENT(&sel_rsp, EVT_ID_PHB_PBAPC_SEL_CONTACT);

    sel_rsp.sender_id = GRP_ID_PHB_PBAPC_SELECT_CONTACT;
    sel_rsp.cb_user_data = phb_pbapc_cntx_p->cui_sel_contact_ud;
    sel_rsp.rsp_type = MMI_PHB_PBAPC_SEL_RESULT;
    sel_rsp.rsp = (void *)&sel_ret;

    if (ret == 0)
    {
        /* sel ok result */
        sel_ret.ret = MMI_PHB_PBAPC_SEL_RET_OK;
        sel_ret.contact_type = MMI_PHB_PBAPC_CONTACT_BT;
        sel_ret.entry_index = phb_pbapc_cntx_p->cui_pse_entry_index;
        sel_ret.storage = phb_pbapc_cntx_p->cui_contact_storage;
        sel_ret.num_type = pse_phb->num[index].type;

        mmi_wcsncpy(sel_ret.name, pse_phb->name, MMI_PHB_PBAPC_MAX_NAME_LEN);
        sel_ret.name[MMI_PHB_PBAPC_MAX_NAME_LEN] = L'\0';

        mmi_wcsncpy(sel_ret.number, pse_phb->num[index].number, MMI_PHB_PBAPC_MAX_NUM_LEN);
        sel_ret.number[MMI_PHB_PBAPC_MAX_NUM_LEN] = L'\0';

        field_mask = 0;
        if (sel_ret.name[0])
        {
            field_mask |= 0x01;
        }

        if (sel_ret.number[0])
        {
            field_mask |= 0x02;
        }
    }
    else if (ret == 1)
    {
        sel_ret.ret = MMI_PHB_PBAPC_SEL_RET_CANCEL;
    }

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_bt_send_select_result_ext--ret: %d, field_mask: 0x%x\n",
    //                                                                ret, field_mask);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SEND_SEL_RESULT_EXT, ret, field_mask);

    cui_phb_send_data_to_sa(GRP_ID_PHB_PBAPC_SELECT_CONTACT, &sel_rsp);

    cui_phb_pbapc_select_contact_send_req_close();
}


static void cui_phb_pbapc_select_contact_local_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    #if 1
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    srv_phb_filter_struct filter;
    U8 *gui_buffer = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_TAB_BAR_SUPPORT_TAB_PAGE__
    if (!cui_tab_enter(
            GRP_ID_PHB_PBAPC_SELECT_CONTACT,
            SCR_ID_PHB_PBAPC_LOCAL,
            cui_phb_pbapc_select_contact_local_exit,
            cui_phb_pbapc_select_contact_local_entry,
            MMI_FRM_FULL_SCRN
            ))
#else
    if (!mmi_frm_scrn_tab_page_enter(
            GRP_ID_PHB_PBAPC_SELECT_CONTACT,
            SCR_ID_PHB_PBAPC_TAB,
            SCR_ID_PHB_PBAPC_LOCAL,
            cui_phb_pbapc_select_contact_local_exit,
            cui_phb_pbapc_select_contact_local_entry,
            MMI_FRM_TAB_PAGE
            ))
#endif
    {
        return;
    }

    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
#if defined(__MMI_BT_PBAP_CLIENT__)
    g_wgui_cat199_has_default_hilight_item = MMI_FALSE;
#endif
    phb_pbapc_cntx_p->cui_list = 1;

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_select_contact_local_entry--is_in_backward: %d\n",
    //                                                                mmi_frm_is_in_backward_scenario());

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SEL_LOCAL_ENTRY, mmi_frm_is_in_backward_scenario());

    if (!mmi_frm_is_in_backward_scenario())
    {
        if (srv_phb_startup_is_phb_ready())
        {
            if (phb_pbapc_cntx_p->local_contact_id == NULL)
            {
                phb_pbapc_cntx_p->local_contact_id = srv_phb_mem_malloc(sizeof(U16) * MMI_PHB_ENTRIES, SRV_PHB_MEMORY_TYPE_ADM);
            }

            filter.storage = PHB_STORAGE_MAX;
            filter.field_filter = SRV_PHB_ENTRY_FIELD_GSM_NUM;
            filter.name_filter = NULL;
            filter.qsearch_filter = NULL;
            filter.group_filter = NULL;

            phb_pbapc_cntx_p->local_contact_count = (U16) srv_phb_oplib_build_contact_list(&filter, phb_pbapc_cntx_p->local_contact_id, MMI_PHB_ENTRIES);
        
            cui_phb_pbapc_local_show_list();
        }
     }
     else
     {
         cui_phb_pbapc_local_show_list();
     }
     #endif
     //mmi_phb_launch_entry();
}


static void cui_phb_pbapc_select_contact_local_exit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


static void cui_phb_pbapc_select_contact_bt_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
   #if defined(__MMI_BT_PBAP_CLIENT__) 
    g_wgui_cat199_has_default_hilight_item = MMI_FALSE;
   #endif
    mmi_phb_pbapc_entry_list_tab();
}


static void cui_phb_pbapc_select_contact_bt_exit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_exit_list_tab();
}


static void cui_phb_pbapc_pre_select_contact(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    memset(&(phb_pbapc_cntx_p->cui_pse_phb), 0x00, sizeof(mmi_phb_pbapc_phb_info_struct));

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_PRE_SEL_CONTACT, phb_pbapc_cntx_p->cui_pse_entry_index, phb_pbapc_cntx_p->cui_contact_storage);

    mmi_phb_pbapc_covert_data(&(phb_pbapc_cntx_p->cui_pse_phb));
    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP,TRC_MMI_PHB_PBAPC_COVERT_DATA, phb_pbapc_cntx_p->bt_index, phb_pbapc_cntx_p->cui_pse_phb.num_count,phb_pbapc_cntx_p->cui_pse_phb.name[0],phb_pbapc_cntx_p->cui_pse_phb.num[0]);
    if (phb_pbapc_cntx_p->cui_pse_phb.num_count == 0)
    {
        /* show no number popup */
        cui_phb_pbapc_bt_send_select_result_ext(&(phb_pbapc_cntx_p->cui_pse_phb), 0, 0);
    }
    else if (phb_pbapc_cntx_p->cui_pse_phb.num_count > 1)
    {
        // phb_pbapc_cntx_p->op_type = 1;
        mmi_phb_pbapc_select_op_number(GRP_ID_PHB_PBAPC_SELECT_CONTACT, cui_phb_pbapc_pre_select_contact_number_cb,
                               (void *)0xbabe0004, &(phb_pbapc_cntx_p->cui_pse_phb));
    }
    else /* just 1 number send ret directly */
    {
        //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_pre_select_contact_cb(send ret)\n");
        MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_PRE_SEL_CONTACT_CB_SEND_RET);
        cui_phb_pbapc_bt_send_select_result_ext(&(phb_pbapc_cntx_p->cui_pse_phb), 0, 0);
    }

}


static S32 cui_phb_pbapc_pre_select_contact_number_cb(mmi_phb_pbapc_cb_info_struct *cb_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    S32 index = -1;
    mmi_phb_pbapc_sel_num_rsp_struct *sel_num_rsp;
    S32 ret = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    sel_num_rsp = (mmi_phb_pbapc_sel_num_rsp_struct *) (cb_info->type_rsp);

    if (sel_num_rsp->ret == 0)
    {
        index = sel_num_rsp->sel_index;
        cui_phb_pbapc_bt_send_select_result_ext(&(phb_pbapc_cntx_p->cui_pse_phb), index, 0);
    }
    else
    {
        cui_phb_pbapc_bt_send_select_result_ext(&(phb_pbapc_cntx_p->cui_pse_phb), 0, 1);
    }

    return ret;
}



#define EXTERN_CUI_PHB_PBAPC_SELECT_CONTACT_API


mmi_ret cui_phb_pbapc_select_contact_create(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    mmi_ret gid;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();

    phb_pbapc_cntx_p->cui_sel_contact_pid = parent_id;
    phb_pbapc_cntx_p->cui_sel_contact_ud = NULL;

    gid = mmi_frm_group_create_ex(parent_id, GRP_ID_PHB_PBAPC_SELECT_CONTACT, cui_phb_pbapc_select_contact_proc, NULL, MMI_FRM_NODE_NONE_FLAG);


    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_select_contact_create--parent_id: %d, gid: %d\n",
    //                                                                parent_id, gid);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SEL_CONTACT_CREATE, parent_id, gid);

    return gid;
}


void cui_phb_pbapc_select_contact_run(mmi_id sel_contact_gid)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;
    if (GRP_ID_PHB_PBAPC_SELECT_CONTACT != sel_contact_gid)
    {
        MMI_ASSERT(0);
    }
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    mmi_phb_pbapc_set_list_type(1);
    phb_pbapc_cntx_p->qsearch_input_buffer[0] = 0;/*clear search content*/

    mmi_frm_cb_reg_event(EVT_ID_PBAP_NOTIFY, mmi_phb_pbapc_notify_evt_hdlr, (void *)0xbabe0003);
#if SRV_PBAPC_LINK_NUM >= 2
#if !defined (__MMI_PHB_UI_IN_TABS__) && defined (__MMI_PHB_PBAPC_SYNC_CONTACT__)
    mmi_phb_launch_entry();
#endif
#else
    cui_phb_pbapc_select_contact_entry();
#endif
}


void cui_phb_pbapc_select_contact_set_user_data(mmi_id sel_contact_gid, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (GRP_ID_PHB_PBAPC_SELECT_CONTACT != sel_contact_gid)
    {
        MMI_ASSERT(0);
    }

    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    phb_pbapc_cntx_p->cui_sel_contact_ud = user_data;
}


void cui_phb_pbapc_select_contact_close(mmi_id sel_contact_gid)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_phb_pbapc_cntx_struct *phb_pbapc_cntx_p = NULL;

    if (GRP_ID_PHB_PBAPC_SELECT_CONTACT != sel_contact_gid)
    {
        MMI_ASSERT(0);
    }

    //kal_wap_trace(MOD_MMI_COMMON_APP, MMI_PHB_PBAPC_TRACE_GROUP, "[MMI_PHB_PBAPC] cui_phb_pbapc_select_contact_close--sel_contact_gid: %d\n",
    //                                                                sel_contact_gid);

    MMI_TRACE(MMI_PHB_PBAPC_TRACE_GROUP, TRC_MMI_PHB_PBAPC_SEL_CONTACT_CLOSE, sel_contact_gid);
    phb_pbapc_cntx_p = mmi_phb_pbapc_get_cntx();
    if (phb_pbapc_cntx_p->qsearch_input_buffer)
    {
        phb_pbapc_cntx_p->qsearch_input_buffer[0] = 0;

    }

    mmi_phb_pbapc_set_list_type(0);

    mmi_frm_group_close(sel_contact_gid);
}


static S32 mmi_phb_pbapc_bt_set_index_cb(srv_pbapc_query_req_struct *req)
{
    req->bt_index = g_for_connect.speci_index;
    srv_pbapc_set_query_func(NULL);
    return 0;

}


#define MAX_PBAPC_BQB_MAX_FIELDS                        (6)

typedef struct
{
    S32 hlight_index;
    SRV_PHB_PBAPC_HANDLE pbapc_handle;
} mmi_pbapc_bqb_context_struct;


mmi_pbapc_bqb_context_struct g_mmi_pbapc_bqb_cntx;

S32 g_pbap_bqb_flag = 0;


MMI_BOOL mmi_pbapc_is_bqb_test()
{
    return srv_bt_cm_get_bqb_test_flag();
}


void mmi_pbapc_bqb_start()
{
    g_pbap_bqb_flag = 0;

    mmi_frm_group_create_ex(GRP_ID_PHB_MAIN, GRP_ID_PHB_PBAPC_VIEW_CONTACT, mmi_pbapc_bqb_grp_proc, NULL, MMI_FRM_NODE_NONE_FLAG);

    mmi_frm_scrn_create(GRP_ID_PHB_PBAPC_VIEW_CONTACT, SCR_ID_PHB_PBAPC_VIEW_CONTACT, mmi_pbapc_bqb_scr_proc, NULL);
}


static mmi_ret mmi_pbapc_bqb_grp_proc(mmi_event_struct *evt)
{
    return MMI_RET_OK;
}

static mmi_ret mmi_pbapc_bqb_scr_proc(mmi_event_struct *evt)
{
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_INACTIVE:
        {
            break;

        }

        case EVT_ID_SCRN_ACTIVE:
        {
            mmi_pbapc_bqb_show();
            break;
        }

        case EVT_ID_SCRN_DEINIT:
            
        break;
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        {
            break;
        }
        default:
         break;
    }

    return MMI_RET_OK;
}


static void mmi_pbapc_bqb_show()
{
    CHAR *item_list[MAX_PBAPC_BQB_MAX_FIELDS]; 
    S32 highlight_item = 0;
    U8 *gui_buffer = NULL;
    S32 item_num = 0;


    gui_buffer = mmi_frm_scrn_get_active_gui_buf();

    RegisterHighlightHandler(mmi_pbapc_bqb_highlight_hdlr);


    item_list[0] = (CHAR *)(L"PBD/BV-1-C(Download)");
    item_list[1] = (CHAR *)(L"PDF/BV-1-I(Retrieve)");
    item_list[2] = (CHAR *)(L"PDF/BV-6-I(Abort)");
    item_list[3] = (CHAR *)(L"SSM/BV-2-C(Close)");

    item_num = 4;

    ShowCategory84Screen(
                STR_ID_PBAP_BQB_TEST,
                GetRootTitleIcon(MAIN_MENU_PHONEBOOK_MENUID),
                0,
                0,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                item_num,
                (U8 **) item_list,
                NULL,
                WGUI_CATE_ITEM_DISABLE_WITHOUT_CHANGE_TEXT_COLOR,
                highlight_item,
                gui_buffer);
}


static void mmi_pbapc_bqb_highlight_hdlr(S32 index)
{

    g_mmi_pbapc_bqb_cntx.hlight_index = index;

    ChangeLeftSoftkey(STR_GLOBAL_OK, IMG_GLOBAL_OK);

    ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);
    SetLeftSoftkeyFunction(mmi_pbapc_bqb_option, KEY_EVENT_UP);

    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    SetCenterSoftkeyFunction(mmi_pbapc_bqb_option, KEY_EVENT_UP);

    SetRightSoftkeyFunction(mmi_pbapc_bqb_back, KEY_EVENT_UP);
}

extern void srv_pbapc_bqb_disconnect_req();

static void mmi_pbapc_bqb_option()
{
    S32 index = 0;

    index = g_mmi_pbapc_bqb_cntx.hlight_index;

    if (index == 0)
    {
        mmi_pbapc_bqb_read_folder();
    }
    else if (index == 1)
    {
        mmi_pbapc_bqb_read_folder();
    }
    else if (index == 2)
    {
        //mmi_pbapc_bqb_abort();
        mmi_pbapc_bqb_read_folder();
        g_pbap_bqb_flag = 1;
    }
    else if (index == 3)
    {
        mmi_pbapc_bqb_disconnect();

        if (g_mmi_pbapc_bqb_cntx.pbapc_handle)
        {
            srv_phb_pbapc_destory_handle(g_mmi_pbapc_bqb_cntx.pbapc_handle);
            g_mmi_pbapc_bqb_cntx.pbapc_handle = NULL;
        }

        g_pbap_bqb_flag = 0;
    }
}


static void mmi_pbapc_bqb_back()
{
    if (g_mmi_pbapc_bqb_cntx.pbapc_handle)
    {
        srv_phb_pbapc_destory_handle(g_mmi_pbapc_bqb_cntx.pbapc_handle);
        g_mmi_pbapc_bqb_cntx.pbapc_handle = NULL;
    }

    mmi_frm_group_close(GRP_ID_PHB_PBAPC_VIEW_CONTACT);
}


static void mmi_pbapc_bqb_read_folder()
{
    S32 ret = -1;
    srv_phb_pbapc_read_folder_req_struct folder_req;


    g_mmi_pbapc_bqb_cntx.pbapc_handle = srv_phb_pbapc_create_handle(&ret);

    /* Req head */
    folder_req.handle = g_mmi_pbapc_bqb_cntx.pbapc_handle;
    folder_req.storage = SRV_PHB_PBAP_STORAGE_PHONE_PB;
    folder_req.user_data = (void *)0xb0b;
    folder_req.bt_index = SRV_PHB_PBAPC_BTD_1ST;

    folder_req.folder_name = NULL;
    folder_req.vcard_format = SRV_PHB_PBAP_VCARD_FORMAT_21;
    folder_req.vcard_filter = SRV_PHB_PBAP_VCARD_FILTER_ALL;
    folder_req.list_count = 52;
    folder_req.list_offset = 0;

    ret = srv_phb_pbapc_read_pse_folder(&folder_req, mmi_pbapc_bqb_read_folder_cb);
}


static S32 mmi_pbapc_bqb_read_folder_cb(srv_phb_pbapc_read_folder_rsp_struct *folder_rsp, void *user_data)
{
    srv_phb_pbapc_destory_handle(g_mmi_pbapc_bqb_cntx.pbapc_handle);
    g_mmi_pbapc_bqb_cntx.pbapc_handle = NULL;

    return 0;
}

extern  void srv_pbapc_bqb_abort_req();
extern void srv_pbapc_bqb_disconnect();

static void mmi_pbapc_bqb_abort()
{
    srv_pbapc_bqb_abort_req();
}

static void mmi_pbapc_bqb_disconnect()
{
    srv_pbapc_bqb_disconnect();
}

#endif

#endif /* defined(__MMI_BT_PBAP_CLIENT__) */

