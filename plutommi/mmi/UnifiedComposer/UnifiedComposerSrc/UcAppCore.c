/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 * UcAppCore.c
 *
 * Project:
 * --------
 * MAUI
 *
 * Description:
 * ------------
 * This file have UC application core part.
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#include "MMI_include.h"
#ifdef __MMI_TELEPHONY_SUPPORT__

#ifndef _MMI_UNIFIED_COMPOSER_APP_CORE_C
#define _MMI_UNIFIED_COMPOSER_APP_CORE_C

#if (defined(__MMI_UNIFIED_COMPOSER__) || defined(__MMI_MMS_STANDALONE_COMPOSER__))
#include "FileMgr.h"
//#include "FileManagerGprot.h"
#include "FileMgrCUIGProt.h"
#include "mdi_datatype.h"
#include "mdi_audio.h"
#if defined(__MMI_VIDEO_PLAY_SUPPORT__) || defined(__MMI_VIDEO_RECORDER__)
#include "mdi_video.h"
#endif 

/* micha1230 */
//#include "custom_nvram_editor_data_item.h"
//#include "custom_data_account.h"
//#include "MessagesExDcl.h"
//#include "MessagesResourceData.h"
#ifdef __MMI_USB_SUPPORT__
#include "USBDeviceGprot.h"
#include "USBSrvGProt.h"
#endif

#include "MenuCuiGprot.h"
#include "MMIDataType.h"
#include "inlineCuiGprot.h"
#ifdef __MMI_FTE_SUPPORT__
//#include "Wgui_icon_bar.h"
#endif
#include "CommonScreens.h"
//#include "SettingProfile.h"
//#include "ProfileGprots.h"

#include "PhoneBookGprot.h"
#include "PhbSrvGprot.h"
#include "PhbCuiGprot.h"
//#include "PhoneSetupGprots.h"

#include "Conversions.h"

//#include "MemPoolContainerProt.h"

//#include "AudioPlayerProt.h"
#include "VdoPlyGProt.h"

#include "CallManagementGprot.h"
#include "CommonScreens.h"
//#include "fmt_struct.h"
#include "DateTimeGprot.h"
#include "MessagesMiscell.h"
#include "SmsGuiInterfaceProt.h"
#include "wapadp.h"
// #include "mmsadp.h"
//#include "wap_ps_struct.h"
#include "custom_wap_config.h"
#include "ReminderSrvGprot.h"
#include "customer_ps_inc.h"
//#include "mmi_msg_context.h"
//#include "MessagesL4Def.h"
//#include "MessagesResourceData.h"
#include "MessagesMiscell.h"
//#include "MessagesExDcl.h"
#include "SmsGuiInterfaceProt.h"
//#include "SMsGuiInterfaceType.h"
//#include "SmsPsHandler.h"

#include "SmsAppGprot.h"
#include "SmsCuiGprot.h"
#include "SmsSrvGprot.h"
#include "SmsAppProt.h"
//#include "IdleAppDef.h"
//#include "xml_def.h"
#include "app_asyncfile.h"
#include "app_mem.h"
#include "app_str.h"

#ifdef __MMI_SOUND_RECORDER__
#include "SoundRecorderProt.h"
#include "SndrecGProt.h"
#endif 

#if defined(__MMI_CAMERA__) && !defined(__MMI_CAMCORDER__)
    #include "CameraGprot.h"
#endif
#if defined(__MMI_CAMCORDER__)    
    #include "mmi_features_camcorder.h"
    #include "CamcorderGprot.h"
#else /* __MMI_CAMCORDER__ */ 
#if defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE)
    #include "VdoRecGprot.h"
#endif /* defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE) */ 
#endif /* __MMI_CAMCORDER__ */ 

/* yingchun modify for framework2.0 */
/* include cui vdorec and camra part */
#include "VdoRecCuiGprot.h"
#include "CameraCuiGprot.h"

#ifdef __MMI_MMS_2__
#include "MmsSrvGprot.h"
#endif 

#include "app_oppostcard.h"

//#include "UMGprot.h"
#include "custom_uc_config.h"
#include "UcResDef.h"
#include "Mmsadp.h"

#ifndef WAP_SUPPORT
#ifdef __MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__
#include "ProfileHandlerTypes.h"
#include "ProfileHandlerProts.h"
#endif /* __MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__ */ 
#else /* WAP_SUPPORT */ 
#include "WAPProfileSrvType.h"
#include "WAPProfileSrvGProt.h"
#endif /* WAP_SUPPORT */ 

#ifdef __MMI_MMS_POSTCARD__
#include "UcPcrdProt.h"
#endif 

#include "UCMGProt.h"
#include "UcmSrvGprot.h"
#include "UmSrvGprot.h"

#ifdef __MMI_PHOTOEDITOR__
#include "PhotoEditorGProt.h"
#include "PhotoEditorCuiGProt.h"
#endif 
#include "Custom_events_notify.h"

#include "UcCuiGprot.h"
#include "UcSrvGprot.h"
#include "UcSrvIprot.h"
#include "UcAppGprot.h"
#include "UcAppProt.h"
#include "UcScrUIProt.h"
#include "FSEditorCuiGprot.h"
#include "FileMgrCUIGProt.h"
#include "wgui_inputs.h"
#include "bookmarkcuigprot.h"
#include "med_api.h"
#ifdef J2ME_SHARE_MED_EXT_MEM
#include "med_mem.h"
#endif
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
#include "ImageViewCuiGprot.h"
#include "MediaAppGProt.h"
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
#include "mmi_rp_app_unifiedmessage_def.h"  /* for UM 10A resource */
#ifdef __DRM_SUPPORT__
#include "drm_gprot.h"
#endif
#if(MMI_MAX_SIM_NUM >=3)
#include "Simselcuigprot.h"
#endif
//suggested add
#include "MMI_features.h"
    #include "ems.h"
    //#include "kal_general_types.h"
   // #include "kal_public_api.h"
    #include "GlobalResDef.h"
    #include "mmi_frm_scenario_gprot.h"
    #include "gdi_const.h"
    #include "gdi_datatype.h"
    #include "gdi_include.h"
    //#include "MMI_common_app_trc.h"
    #include "DebugInitDef_Int.h"
    #include "kal_trace.h"
    #include "mmi_common_app_trc.h"
    #include "string.h"
    #include "customer_email_num.h"
    #include "mma_api.h"
    #include "CustDataRes.h"
    #include "mmi_frm_events_gprot.h"
    #include "mmi_rp_app_unifiedcomposer_def.h"
    #include "gui_data_types.h"
    #include "AlertScreen.h"
    #include "fs_type.h"
    #include "fs_func.h"
    #include "FileMgrSrvGProt.h"
    #include "mmi_frm_history_gprot.h"
    #include "mmi_rp_app_sms_def.h"
    #include "UmSrvDefs.h"
    #include "mmi_frm_input_gprot.h"
    #include "GlobalConstants.h"
    #include "ProfilesSrvGprot.h"
    #include "stdio.h"
    #include "Unicodexdcl.h"
    #include "mmi_frm_mem_gprot.h"
    #include "fs_errcode.h"
    #include "wgui_categories_UCE.h"
    #include "mms_api.h"
    #include "gui_config.h"
    //#include "ps_public_enum.h"
    #include "mma_struct.h"
    #include "mmi_frm_timer_gprot.h"
    //#include "TimerEvents.h"
    #include "wgui_categories_util.h"
    #include "WAPProfileSrvType.h"
    #include "mms_sap_struct.h"
    #include "mmi_res_range_def.h"
    #include "FileMgrType.h"
    #include "FileMgrGProt.h"
    #include "mmi_rp_file_type_def.h"
    //#include "MMI_features_switch.h"
    #include "MMI_features_type.h"
    #include "CommonScreensResDef.h"
    #include "stdlib.h"
    #include "custom_phb_config.h"
    #include "stack_ltlcom.h"
    #include "mms_adp_struct.h"
    #include "wgui.h"
    #include "smsal_l4c_enum.h"
    #include "mmi_rp_app_idle_def.h"
    #include "IdleAppResDef.h"
    #include "wgui_categories_popup.h"
    #include "Gsm7BitNationalLang.h"
    #include "app_usedetails.h"
    #include "gui_typedef.h"
#ifdef __MMI_MMS_INSERT_SENDER_ADDR_FROM_SIM__
#include "CphsSrvGprot.h"
#endif
#define __MMI_UC_SUPPORT_SOUNDRECORDER_IN_UCM__ 1
#include "MMSAppCommonGprot.h"
#include "BootupSrvGprot.h"
/***************************************************************************** 
* Define
*****************************************************************************/
mmi_uc_context_struct g_uc_cntx;    /* global context of uc */
mmi_uc_context_struct *g_uc_p = &g_uc_cntx;

/****************************************************************************
* Constants
*****************************************************************************/
/****************************************************************************
 * Type definitions
 ****************************************************************************/
/***************************************************************************** 
* Extern Function
*****************************************************************************/

extern U8 mmi_phb_convert_to_digit_by_store_index(U8 *dest, U8 *source, U8 max_dest_len, U16 store_index);

extern int wap_entry_select_bookmark(void);
extern void mmi_frm_highlight_input_method_generic(void);

extern EMSData *GetEMSDataForEdit(EMSData **p, U8 force);
extern int mmi_charset_utf8_to_ucs2_length_in_bytes(const kal_uint8 *raw);
extern int mmi_charset_ucs2_to_utf8_length_in_bytes(const kal_uint8 *raw);
extern EMSTATUS EMSCalculateSeg(kal_uint8 dcs, kal_uint16 num_byte, kal_uint8 *usedSegment);

/***************************************************************************** 
* Local static Variable
*****************************************************************************/

/***************************************************************************** 
* Local Function
*****************************************************************************/


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_srv_alloc_mem_cbk
 * DESCRIPTION
 *  Application's callback function for SRV to allocate memory
 * PARAMETERS
 *  len     [IN]        
 * RETURNS
 *  Allocated address pointer(?)
 *****************************************************************************/
void *mmi_uc_srv_alloc_mem_cbk(kal_uint32 len, void* user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (void*)kal_adm_alloc(g_uc_p->main.mem_pool_id, len);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_srv_free_mem_cbk
 * DESCRIPTION
 *  Application's callback function for SRV to free memory
 * PARAMETERS
 *  ptr     [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_srv_free_mem_cbk(void *ptr, void* user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    kal_adm_free(g_uc_p->main.mem_pool_id, ptr);
}
void mmi_uc_mms_free_mem_cbk(void *ptr)
{
	kal_adm_free(g_uc_p->main.mem_pool_id, ptr);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_srv_text_buffer_alloc_mem_cbk
 * DESCRIPTION
 *  Application's callback function for SRV to allocate memory
 * PARAMETERS
 *  len     [IN]        
 * RETURNS
 *  Allocated address pointer(?)
 *****************************************************************************/
void *mmi_uc_srv_text_buffer_alloc_mem_cbk(kal_uint32 len, void* user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (void*)applib_mem_screen_alloc((U16) len);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_srv_text_buffer_free_mem_cbk
 * DESCRIPTION
 *  Application's callback function for SRV to free memory
 * PARAMETERS
 *  ptr     [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_srv_text_buffer_free_mem_cbk(void *ptr, void* user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    applib_mem_screen_free(ptr);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_group_id
 * DESCRIPTION
 *  To set the group id to UC main group id
 * PARAMETERS
 *  ptr     [?]     
 * RETURNS
 *  void
 *****************************************************************************/
BOOL mmi_uc_set_group_id(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->main.parent_grp_id != GRP_ID_INVALID)
    {
        mmi_id temp_gid = g_uc_p->main.uc_cui_gid;
        g_uc_p->main.uc_cui_gid = g_uc_p->main.parent_grp_id;
        g_uc_p->main.parent_grp_id = GRP_ID_INVALID;
        mmi_frm_group_close(temp_gid);
        return MMI_TRUE;
    }
    return MMI_FALSE;
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_valid_image
 * DESCRIPTION
 *  Check if the image is the valid
 * PARAMETERS
 *  file_path       [?]     
 * RETURNS
 *  TRUE means the image is the valid
 *****************************************************************************/
MMI_BOOL mmi_uc_is_valid_image(U16 *file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    GDI_RESULT gdi_ret = GDI_FAILED;
    S32 width = 0, height = 0;

#ifndef __MMI_SLIM_MMS_2__
#ifdef __MMI_CAMERA__
    S32 width_max = 0, height_max = 0;
#endif 
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Check image resolution */
    gdi_ret = gdi_image_get_dimension_file((PS8) file_path, (S32*) & width, (S32*) & height);

#if (defined(__MMI_CAMERA__) && !defined(__MMI_SLIM_MMS_2__))
    mmi_camera_get_max_capture_resolution(&width_max, &height_max);
    if (gdi_ret < 0 || width <= 0 || height <= 0 || width > width_max || height > height_max)
#else /* __MMI_CAMERA__ */ 
    if (gdi_ret < 0 || width <= 0 || height <= 0 || width > SRV_UC_MAX_IMAGE_WIDTH || height > SRV_UC_MAX_IMAGE_HEIGHT)
#endif /* __MMI_CAMERA__ */ 
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_IS_VALID_IMG_NO_P1, gdi_ret);
        return MMI_FALSE;
    }
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_IS_VALID_IMG_YES);
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_init_context
 * DESCRIPTION
 *  Initialize Unified Composer context
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_init_context(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_uc_app_registered_data_struct app_registered_data = {0, };

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(g_uc_p, 0, sizeof(mmi_uc_context_struct));
    app_registered_data.user_data = NULL;
    app_registered_data.app_mem_alloc_fun = mmi_uc_srv_alloc_mem_cbk;
    app_registered_data.app_mem_free_fun = mmi_uc_srv_free_mem_cbk;
    app_registered_data.app_text_buffer_mem_alloc_fun = mmi_uc_srv_text_buffer_alloc_mem_cbk;
    app_registered_data.app_text_buffer_mem_free_fun = mmi_uc_srv_text_buffer_free_mem_cbk;

    /* To get the service instance and register the callbacks.*/
    g_uc_p->main.instance = srv_uc_create(app_registered_data);

    /* Code here to get the pointers to the SRV context to be stored in the APP context */
    g_uc_p->srv_main = srv_uc_get_srv_main_context(g_uc_p->main.instance);
    g_uc_p->srv_msg_type = srv_uc_get_srv_msg_type_context(g_uc_p->main.instance);
    g_uc_p->srv_mms_info = srv_uc_get_srv_mms_info_context(g_uc_p->main.instance);
    g_uc_p->srv_sms_info = srv_uc_get_srv_sms_info_context(g_uc_p->main.instance);
    g_uc_p->srv_msg = srv_uc_get_srv_msg_info_context(g_uc_p->main.instance);
    g_uc_p->srv_send_info = srv_uc_get_srv_send_info_context(g_uc_p->main.instance);
   // g_uc_p->srv_xml = srv_uc_get_srv_xml_info_context(g_uc_p->main.instance);
//#if (MMI_MAX_SIM_NUM >=2)kuldeep_nosim
    g_uc_p->srv_sim_info = srv_uc_get_srv_sim_info_context(g_uc_p->main.instance);
//#endif 
}

#ifdef __MMI_UC_USE_ASM__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_create_asm_mem
 * DESCRIPTION
 *  Create adm memory for UC
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_asm_register_app(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    applib_mem_ap_register(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, STR_UC_WRITE_MSG_ID, IMG_UC_ENTRY_SCRN_CAPTION_ID, mmi_uc_asm_stop_cb);
}

#else
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_create_adm_mem
 * DESCRIPTION
 *  Create adm memory for UC
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_create_adm_mem(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.mem_pool_id = kal_adm_create(mmi_uc_adm_mem, MMI_UC_ADM_MEM_SIZE, NULL, KAL_FALSE);
    MMI_ASSERT(g_uc_p->main.mem_pool_id);
	if(!(g_uc_p->main.mem_pool_id))
	{
	MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
	}
}
#endif /* __MMI_UC_USE_ASM__ */

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_editor_cui_enter_recipient_group_proc
 * DESCRIPTION
 *  To handle the recipient address text
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_editor_cui_enter_recipient_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch(evt->evt_id)
    {
    case EVT_ID_CUI_FSEDITOR_SUBMMIT:
        /* Handler when user confirm input */
        cui_fseditor_get_text(g_uc_p->main.editor_child_cui_id, (WCHAR *)g_uc_p->done.to, (MMI_UC_MAX_RECIPIENT_LEN + 1)  * ENCODING_LENGTH);
        mmi_uc_enter_recipient_done();
        break;

    case EVT_ID_CUI_FSEDITOR_ABORT:
        /* Handler when user Cancel input */
        mmi_frm_group_close(g_uc_p->main.editor_cui_id);
        mmi_frm_group_close(g_uc_p->main.editor_child_cui_id);
        mmi_uc_set_group_id();
        g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
        break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_edit_recipient
 * DESCRIPTION
 *  Entry function for edit address
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_edit_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_recipient_editor_operation_enum recipient_operation = (mmi_uc_recipient_editor_operation_enum)0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_msg_type->caller_specific_msg_type == MMI_UC_MSG_TYPE_SMS_ONLY)
    {
        if (g_uc_p->done.state == MMI_UC_DONE_STATE_EDIT_NUMBER)
        {
            recipient_operation = MMI_UC_RECIPIENT_EDITOR_OP_EDIT_NUMBER_ONLY;
        }
        else
        {
            recipient_operation = MMI_UC_RECIPIENT_EDITOR_OP_EDIT;
        }
    }
    else
    {
        recipient_operation = MMI_UC_RECIPIENT_EDITOR_OP_EDIT;
    }

    g_uc_p->main.editor_cui_id = mmi_frm_group_create(g_uc_p->main.uc_cui_gid, GRP_ID_UNIFIED_COMPOSER_EDITOR_CUI, mmi_uc_editor_cui_enter_recipient_group_proc, 0);
    mmi_frm_group_enter(g_uc_p->main.editor_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_uc_entry_recipient_editor(recipient_operation);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_recipient_editor
 * DESCRIPTION
 *  Entry function of recipient editor
 * NA
 *  
 * PARAMETERS
 *  recipient_operation     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_recipient_editor(mmi_uc_recipient_editor_operation_enum recipient_operation)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (recipient_operation == MMI_UC_RECIPIENT_EDITOR_OP_ADD ||
        recipient_operation == MMI_UC_RECIPIENT_EDITOR_OP_ADD_NUMBER_ONLY)
    {
        mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_ENTER_RECIPIENT);
    }
    else if (recipient_operation == MMI_UC_RECIPIENT_EDITOR_OP_EDIT ||
             recipient_operation == MMI_UC_RECIPIENT_EDITOR_OP_EDIT_NUMBER_ONLY)
    {
        mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_EDIT_RECIPIENT);
    }
    else
    {
        ASSERT(0);
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_enter_recipient
 * DESCRIPTION
 *  Entry msg number screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_enter_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_recipient_editor_operation_enum recipient_operation = (mmi_uc_recipient_editor_operation_enum)0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_msg->to_num >= SRV_UC_MAX_ADDRESS_NUM)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
        return;
    }
    g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_TO;
    if (g_uc_p->srv_msg_type->caller_specific_msg_type == MMI_UC_MSG_TYPE_SMS_ONLY)
    {
        recipient_operation = MMI_UC_RECIPIENT_EDITOR_OP_ADD_NUMBER_ONLY;
    }
    else
    {
        recipient_operation = MMI_UC_RECIPIENT_EDITOR_OP_ADD;
    }
    g_uc_p->main.editor_cui_id = mmi_frm_group_create(g_uc_p->main.uc_cui_gid, GRP_ID_UNIFIED_COMPOSER_EDITOR_CUI, mmi_uc_editor_cui_enter_recipient_group_proc, 0);
    mmi_frm_group_enter(g_uc_p->main.editor_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_NUMBER;
    mmi_uc_entry_recipient_editor(recipient_operation);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_enter_recipient_options
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_enter_recipient_options(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_ENTER_RECIPIENT_OPTIONS);
    return;
}
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#ifdef __MMI_MMS_POSTCARD__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_write_msg_selection_dummy
 * DESCRIPTION
 *  Entry function of write message for supporting postcard feature.
 * NA
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_write_msg_selection(void)
{
	  /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	mmi_uc_entry_write_msg_selection_launch(0);
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_write_msg_selection
 * DESCRIPTION
 *  Entry function of write message for supporting postcard feature.
 * NA
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_write_msg_selection_launch(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!(mmi_uc_is_uc_ready()) || mmi_uc_is_uc_reenter())
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);

        return;
    }

#ifdef __USB_IN_NORMAL_MODE__
    if (srv_usb_is_in_mass_storage_mode() && mma_is_storage_exported_to_pc())
    {
        /* in mass storage mode */
        if (srv_usb_check_path_exported((WCHAR*)SRV_UC_FOLDER_DRV))
        {
            /* MMI public drive is exported, cannot use this app */
            mmi_usb_app_unavailable_popup(0);   /* pass 0 will show default string */
            return;
        }
    }
#endif /* __USB_IN_NORMAL_MODE__ */

	if (mmi_frm_group_get_active_id() != g_uc_p->main.uc_cui_gid &&  g_uc_p->main.uc_cui_gid == GRP_ID_UNIFIED_COMPOSER)
	{
		mmi_frm_group_close (g_uc_p->main.uc_cui_gid);
		g_uc_p->main.uc_cui_gid = GRP_ID_INVALID;
	}
    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
                cui_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
        mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);

    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_WRITE_MSG_SELECTION);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_postcard_entry_multiple_recipient_option
 * DESCRIPTION
 *  Entry function of recipient list option menu
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_postcard_entry_multiple_recipient_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_POSTCARD_RECIPIENT_OPTION);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_postcard_recipient_adr_inline_cui_group_proc
 * DESCRIPTION
 *  Handle the postcard recipient address
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_postcard_recipient_adr_inline_cui_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_group_event_struct *inline_evt = (mmi_group_event_struct *)evt;

    switch(evt->evt_id)
    {
        case EVT_ID_GROUP_INACTIVE:
        {
            break;
        }
        case EVT_ID_GROUP_DEINIT:
        {
            break;
        }
        case EVT_ID_CUI_INLINE_ABORT:
        {
            if(inline_evt->sender_id == g_uc_p->main.inline_cui_id)
            {
               cui_inline_close(g_uc_p->main.inline_cui_id);
            }
            else if(inline_evt->sender_id == g_uc_p->main.inline_child_cui_id)
            {
               cui_inline_close(g_uc_p->main.inline_child_cui_id);
            }
            mmi_uc_set_group_id();
            break;
        }
        case EVT_ID_CUI_INLINE_SUBMIT:
        {
            if(inline_evt->sender_id == g_uc_p->main.inline_child_cui_id)
            {
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, POSTCARD_FULLSCREEN_EDIT1, g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_editor->postcard_name);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, POSTCARD_FULLSCREEN_EDIT2, g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_editor->postcard_additional);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, POSTCARD_FULLSCREEN_EDIT3, g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_editor->postcard_street);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, POSTCARD_FULLSCREEN_EDIT4, g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_editor->postcard_city);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, POSTCARD_FULLSCREEN_EDIT5, g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_editor->postcard_state);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, POSTCARD_FULLSCREEN_EDIT6, g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_editor->postcard_postalcode);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, POSTCARD_FULLSCREEN_EDIT7, g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_editor->postcard_country);
                mmi_postcard_validate_recipient_address_data();
            }
           break;
        }
        case EVT_ID_CUI_INLINE_NOTIFY:
        {
            cui_event_inline_notify_struct *notify_evt = (cui_event_inline_notify_struct *)evt;
            switch(notify_evt->event_type)
            {
                case CUI_INLINE_NOTIFY_ITEM_ACTIVATED:
                {
                    mmi_postcard_set_recipient_address_custom_function();
                    break;
                }
            }
            break;
        }
    }
    return MMI_RET_OK;
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_recipient_address_inline_editor_cui
 * DESCRIPTION
 *  Entry function of recipient's address editor through cui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_recipient_address_inline_editor_cui(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.inline_cui_id = mmi_frm_group_create(
            g_uc_p->main.uc_cui_gid, GRP_ID_UNIFIED_COMPOSER_INLINE_CUI, mmi_uc_postcard_recipient_adr_inline_cui_group_proc, (void*)NULL);
    mmi_frm_group_enter(g_uc_p->main.inline_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_postcard_entry_recipient_address_editor(); 
}
/*****************************************************************************
 * FUNCTION
 *  mmi_postcard_entry_recipient_address_editor
 * DESCRIPTION
 *  Entry function of recipient's address editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_postcard_entry_recipient_address_editor(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_POSTCARD_ADDRESS);
    return;
}
#endif /* __MMI_MMS_POSTCARD__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_attachment_list
 * DESCRIPTION
 *  Entry function of attachment list
 * PARAMETERS
 *  action      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_attachment_list(S32 action)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
    if (action == MMI_UC_MEDIA_ACTION_REPLACE)
    {
        mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_REPLACE);
    }
    else
#endif /* __MMI_UC_REPLACE_MEDIA_SUPPORT__ */ 
        /* if(action == MMI_UC_MEDIA_ACTION_REMOVE) */
    {
        mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_REMOVE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_remove
 * DESCRIPTION
 *  Entry function for remove type list
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_remove(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_entry_attachment_list(MMI_UC_MEDIA_ACTION_REMOVE);
    /* mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_REMOVE); */
}

#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_replace
 * DESCRIPTION
 *  Entry function for replace type list
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_replace(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_REPLACE);
    mmi_uc_entry_attachment_list(MMI_UC_MEDIA_ACTION_REPLACE);
    /* mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_REPLACE); */
}
#endif /* __MMI_UC_REPLACE_MEDIA_SUPPORT__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_slide_opt
 * DESCRIPTION
 *  Entry function for slide option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_slide_opt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_SLIDE_OPT);

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_SLIDE_OPT);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_slide_time_editor_cui_group_proc
 * DESCRIPTION
 *  slide timing editor handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_slide_time_editor_cui_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(evt->evt_id)
    {
    case EVT_ID_CUI_FSEDITOR_SUBMMIT:
        /* Handler when user confirm input */
        cui_fseditor_get_text(g_uc_p->main.editor_child_cui_id, (WCHAR *)g_uc_p->main.slide_timing, (MMI_UC_MAX_SLIDE_TIMING_DIGIT + 1) * ENCODING_LENGTH);
        mmi_uc_entry_slide_timing_done();
        break;
    case EVT_ID_CUI_FSEDITOR_ABORT:
        /* Handler when user Cancel input */
        mmi_frm_group_close(g_uc_p->main.editor_cui_id);
        g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
        mmi_uc_set_group_id();
        break;
    }
    return MMI_RET_OK;
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_slide_timing_editor_cui
 * DESCRIPTION
 *  Entry screen to edit slide timing through cui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_slide_timing_editor_cui(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.editor_cui_id = mmi_frm_group_create(g_uc_p->main.uc_cui_gid, GRP_ID_UNIFIED_COMPOSER_EDITOR_CUI, mmi_uc_slide_time_editor_cui_group_proc, 0);
    mmi_frm_group_enter(g_uc_p->main.editor_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    mmi_uc_entry_slide_timing(); 
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_slide_timing
 * DESCRIPTION
 *  Entry screen to edit slide timing
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_slide_timing(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_SLIDE_OPT_SLIDE_TIMING);
    return;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_object_timing_inline_cui_group_proc
 * DESCRIPTION
 *  Handler for object timing inline cui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_object_timing_inline_cui_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_group_event_struct *inline_evt = (mmi_group_event_struct *)evt;

    switch(evt->evt_id)
    {
        case EVT_ID_GROUP_INACTIVE:
        {
            break;
        }
        case EVT_ID_GROUP_DEINIT:
        {
            break;
        }
        case EVT_ID_CUI_INLINE_ABORT:
        {
            if(inline_evt->sender_id == g_uc_p->main.inline_cui_id)
            {
               cui_inline_close(g_uc_p->main.inline_cui_id);
            }
            else if(inline_evt->sender_id == g_uc_p->main.inline_child_cui_id)
            {
               cui_inline_close(g_uc_p->main.inline_child_cui_id);
            }
            break;
        }
        case EVT_ID_CUI_INLINE_SUBMIT:
        {
            if(inline_evt->sender_id == g_uc_p->main.inline_child_cui_id)
            {
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, APP_TEXTEDIT1, g_uc_p->main.slide_timing);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, APP_TEXTEDIT2, g_uc_p->main.slide_number);
                if (g_uc_p->srv_msg->best_page_duration)
                {
                    mmi_uc_entry_timing_check_before_done();
                }
                else
                {
                    mmi_uc_entry_timing_done();
                }
            }
           break;
        }
        case EVT_ID_CUI_INLINE_NOTIFY:
        {
            cui_event_inline_notify_struct *notify_evt = (cui_event_inline_notify_struct *)evt;
            switch(notify_evt->event_type)
            {
                
                case CUI_INLINE_NOTIFY_HIGHLIGHT_ITEM:
                {
                    cui_inline_set_screen_attributes(inline_evt->sender_id, CUI_INLINE_SET_ATTRIBUTE , CUI_INLINE_SCREEN_DISABLE_DONE);
                    break;
                }
            }
            break;
        }
    }
    return MMI_RET_OK;
}

#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_timing_inline_cui
 * DESCRIPTION
 *  Entry screen to edit object timing through cui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_timing_inline_cui(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.inline_cui_id = mmi_frm_group_create(
            g_uc_p->main.uc_cui_gid, GRP_ID_UNIFIED_COMPOSER_INLINE_CUI, mmi_uc_object_timing_inline_cui_group_proc, (void*)NULL);
    mmi_frm_group_enter(g_uc_p->main.inline_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_uc_entry_timing(); 
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_timing
 * DESCRIPTION
 *  Entry screen to edit object timing
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_timing(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_SLIDE_OPT_TEXT_TIMING);
    return;
}
#endif


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_opt_inline_cui_group_proc
 * DESCRIPTION
 *  Handler for send option cui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_send_opt_inline_cui_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_group_event_struct *inline_evt = (mmi_group_event_struct *)evt;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch(evt->evt_id)
    {
        case EVT_ID_GROUP_INACTIVE:
        {
            break;
        }
        case EVT_ID_GROUP_DEINIT:
        {
            break;
        }
        case EVT_ID_CUI_INLINE_ABORT:
        {
            if(inline_evt->sender_id == g_uc_p->main.inline_cui_id)
            {
               cui_inline_close(g_uc_p->main.inline_cui_id);
            }
            else if(inline_evt->sender_id == g_uc_p->main.inline_child_cui_id)
            {
               cui_inline_close(g_uc_p->main.inline_child_cui_id);
            }
            mmi_uc_set_group_id();
            break;
        }
        case EVT_ID_CUI_INLINE_SUBMIT:
        {
            if(inline_evt->sender_id == g_uc_p->main.inline_child_cui_id)
            {
                #ifdef __MMI_MMS_SETTINGS_VALIDITY_PERIOD_VISIBILITY__
                    cui_inline_get_value(g_uc_p->main.inline_child_cui_id, VALIDITY_PERIOD_SELECT, (void *)&g_uc_p->send_opt.validity_period);
                #endif
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, DELIVERY_REPORT_SELECT, (void *)&g_uc_p->send_opt.delivery_report);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, READ_REPORT_SELECT,     (void *)&g_uc_p->send_opt.read_report);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, PRIORITY_SELECT,        (void *)&g_uc_p->send_opt.priority);
                cui_inline_get_value(g_uc_p->main.inline_child_cui_id, DELIVERY_TIME_SELECT,   (void *)&g_uc_p->send_opt.delivery_time);
                #ifdef __MMI_MMS_HIDE_SENDER_SUPPORT__
                    cui_inline_get_value(g_uc_p->main.inline_child_cui_id, SENDER_VISIBILITY_SELECT, (void *)&g_uc_p->send_opt.hide_sender);
                #endif
				#ifdef OMA13_CON_739_SUPPORT_TEMP_TEST_CODE
					cui_inline_get_value(g_uc_p->main.inline_child_cui_id, MSG_CLASS_SELECT, (void *)&(g_uc_p->send_opt.msg_class));
				#endif
                mmi_uc_send_opt_done_hdlr();
            }
           break;
        }
    }
    return MMI_RET_OK;
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_send_opt_inline_cui
 * DESCRIPTION
 *  Entry function of send option through cui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_send_opt_inline_cui(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	if(g_uc_p->main.parent_grp_id == GRP_ID_INVALID)
	{
	    g_uc_p->main.inline_cui_id = mmi_frm_group_create(
        GRP_ID_ROOT, GRP_ID_AUTO_GEN, mmi_uc_send_opt_inline_cui_group_proc, (void*)NULL);
	}
	else
	{
		g_uc_p->main.inline_cui_id = mmi_frm_group_create(
            g_uc_p->main.uc_cui_gid, GRP_ID_UNIFIED_COMPOSER_INLINE_CUI, mmi_uc_send_opt_inline_cui_group_proc, (void*)NULL);
	}
    mmi_frm_group_enter(g_uc_p->main.inline_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_uc_entry_send_opt(); 
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_send_opt
 * DESCRIPTION
 *  Entry function of send option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_send_opt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(g_uc_p->srv_msg_type->caller_specific_msg_type != MMI_UC_MSG_TYPE_SMS_ONLY);
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_SEND_OPT);
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_SEND_OPT);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_preview
 * DESCRIPTION
 *  Entry preview dummy screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_preview(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL is_back = mmi_frm_is_in_backward_scenario();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* required as edit allowed on big MMS also. */
    if (is_back)
    {
		//#ifdef __MMI_UI_SMALL_SCREEN_SUPPORT__
		if (mmi_is_redrawing_bk_screens() == TRUE)
		{
			MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_PREVIEW_REDRAW_DUE_TO_SMALL_SCR);
			return;
		}
		//#endif /* __MMI_UI_SMALL_SCREEN_SUPPORT__ */ 
		mmi_uc_set_group_id();
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

        if (g_uc_p->srv_send_info->new_msg_id)
        {
            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
        }
        return;
    }
    if (g_uc_p->srv_mms_info->max_mms_size < g_uc_p->srv_msg->msg_size)
    {
        mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
        return;
    }
//#ifdef __MMI_UI_SMALL_SCREEN_SUPPORT__
    if (mmi_is_redrawing_bk_screens() == TRUE)
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_PREVIEW_REDRAW_DUE_TO_SMALL_SCR);
        return;
    }
//#endif /* __MMI_UI_SMALL_SCREEN_SUPPORT__ */ 
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_PREVIEW);

    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_MSG_PREVIEW);
    return;
}

#ifndef __MMI_SLIM_MMS_2__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_text_option
 * DESCRIPTION
 *  shows text options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_text_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_TEXT_OPTIONS);
    return;
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_picture_option
 * DESCRIPTION
 *  Shows picture options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_picture_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_PICTURE_OPTIONS);
    return;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_sound_option
 * DESCRIPTION
 *  shows sound options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_sound_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_SOUND_OPTIONS);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_video_option
 * DESCRIPTION
 *  shows video options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_video_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_VIDEO_OPTIONS);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_attachment_option
 * DESCRIPTION
 *  shows attachment options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_attachment_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_ATTACHMENT_OPTIONS);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_advanced_options
 * DESCRIPTION
 *  shows advance options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_advanced_options(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_ADVANCED_OPTIONS);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_picture_options
 * DESCRIPTION
 *  shows add picture options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_picture_options(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_ADD_PICTURE_OPTIONS);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_sound_options
 * DESCRIPTION
 *  shows add sound options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_sound_options(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_ADD_SOUND_OPTIONS);
    return;
}

#ifdef __MMI_MMS_VIDEO_FEATURE__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_video_options
 * DESCRIPTION
 *  shows add video options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_video_options(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_ADD_VIDEO_OPTIONS);
    return;
}
#endif

#if defined(__MMI_MSG_EDITOR_WITH_RECIPIENT__) && defined(__MMI_TOUCH_SCREEN__)
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_attachment_list
 * DESCRIPTION
 *  open attachment list
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_attachment_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_ATTACHMENT_LIST);
    g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_ATTACHMENT;
    g_uc_p->main.select_media_opt = UC_MEDIA_OPT_ATTACHMENT_LIST;
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_ATTACH_LIST);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_attachment_list
 * DESCRIPTION
 *  Exit function for remove attachment
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_attachment_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

}


#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_attachment_option_replace
 * DESCRIPTION
 *  open list to replace attachment
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_attachment_option_replace(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_MSG_EDITOR_WITH_RECIPIENT__) && defined(__MMI_TOUCH_SCREEN__)
    mmi_uc_select_fmgr_object();
#else
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_ATTACHMENT_LIST);
    g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_ATTACHMENT;
    g_uc_p->main.select_media_opt = UC_MEDIA_OPT_ATTACHMENT_LIST;
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_ATTACHMENT_REPLACE);
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    return;
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_attachment_option_remove
 * DESCRIPTION
 *  open list to remove attachment
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_attachment_option_remove(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_MSG_EDITOR_WITH_RECIPIENT__) && defined(__MMI_TOUCH_SCREEN__)
    mmi_uc_remove_object();
    if(!g_uc_p->srv_msg->msg_body.attachment)
    {
        mmi_uc_delete_screen(SCR_ID_UC_OPT_ATTACHMENT_LIST);
    }
#else
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_ATTACHMENT_LIST);
    g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_ATTACHMENT;
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_ATTACHMENT_REMOVE);
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    return;
}

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_add_recipient
 * DESCRIPTION
 *  To add recipients.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_add_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_uc_is_critaria_follow_in_pre_process_select_option_from_editor() == MMI_FALSE)
    {
        return;
    }
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS &&
        srv_postcard_is_recipient_forward(g_uc_p->main.instance))
    {
		mmi_uc_set_group_id();
        mmi_postcard_entry_import_manual();
        return;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_ADD_RECIPIENT);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_add_recipients_options
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_add_recipients_options(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_group_id();
	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_ADD_RECIPIENT_OPTIONS);
    return;
}
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#if(MMI_MAX_SIM_NUM >= 2)
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_sim_option
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_sim_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
        g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
        g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
                g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
        mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
    }
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_SIM_OPT);
    return;
}

#endif /* #if(MMI_MAX_SIM_NUM == 2) */ 

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_editor_proc
 * DESCRIPTION
 *  Handler of unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_editor_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_ACTIVE:
        case EVT_ID_GROUP_INACTIVE:
            break;
        case EVT_ID_GROUP_DEINIT:
            /* need addd code to release buffer */
            mmi_frm_group_close (g_uc_p->main.uc_cui_gid);
            g_uc_p->main.uc_cui_gid = GRP_ID_INVALID;
            break;
        default:
            break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_write_msg
 * DESCRIPTION
 *  Entry function of unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	/*For DCD Added*/
	U16 show_popup = 0 ;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* reset */
    /* Add additional condition of send screen to handle framework calls
       when small screen is above to editor screen. In case forground send. */
#ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    if (!mmi_frm_scrn_is_present (g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_ALL_FLAG)&&
		!mmi_frm_scrn_is_present (g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_ALL_FLAG))
#endif
    {
#ifdef __MMI_FRM_HISTORY__
        if(!CheckIsBackHistory())
#else
		if(!mmi_frm_is_in_backward_scenario())
#endif
        {
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
        g_uc_p->send_info.abort = MMI_UC_ABORT_NONE;
        }
#ifndef __MMI_MMS_STANDALONE_COMPOSER__
        /* if it is mms only, it's impossible to change msg type, so no need consider sms pending action */
        if (g_uc_p->srv_msg_type->caller_specific_msg_type != MMI_UC_MSG_TYPE_MMS_ONLY)
        {
            /* disallow re-entering SMS application when there is a pending SMS job running in the background */
        #ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
            if (srv_sms_is_send_action_busy())
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_MSG_NOT_READY_YET)), MMI_EVENT_FAILURE, NULL);
    
                /* main_cb will be called */
                mmi_frm_scrn_close (g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                mmi_frm_scrn_close (g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_group_close (g_uc_p->main.uc_cui_gid);
                g_uc_p->main.uc_cui_gid = GRP_ID_INVALID;
                mmi_uc_reset_msg();
                return;
            }
        #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
        }
#endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
    }
    mmi_uc_set_group_id();
	/*For DCD Added*/
	if(g_uc_p->srv_msg->get_media_callback && !g_uc_p->srv_msg->is_abort)
	{
		U16 curr_media_count = 0;
		U16 result = 0;
		WCHAR* path_buffer  = NULL;
		g_uc_p->srv_msg->is_abort = MMI_TRUE ;
		while(curr_media_count < g_uc_p->srv_msg->media_count) 
		{
			path_buffer = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1 ) * sizeof(WCHAR));
			g_uc_p->srv_msg->get_media_callback(curr_media_count, path_buffer, MMI_TRUE);
			result = mmi_uc_handle_object_from_DCD_and_insert(path_buffer);
			/*need to save result to show popup after insert all objects*/
			if(result != 0)
			{
				show_popup = result ;
			}
			OslMfree(path_buffer);
			curr_media_count++ ;
		}
		/*ask DCD App to free all memory for object path*/
		g_uc_p->srv_msg->get_media_callback(curr_media_count, NULL, MMI_FALSE);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_EDITOR);
	/*For DCD Added*/
	/*if any error show popup here atlast*/
	if(show_popup != 0)
	{
		mmi_uc_display_popup((srv_uc_result)show_popup);
	}
    return;
}
/*Added For DCD*/

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_object_from_DCD_and_insert
 * DESCRIPTION
 *  Entry function of unified composer exit option
 * PARAMETERS
 *  WCHAR
 * RETURNS
 *  srv_uc_result
 *****************************************************************************/
srv_uc_result mmi_uc_handle_object_from_DCD_and_insert(WCHAR* file_path)
{
	U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
    //U16 *filePath = (U16*) g_uc_p->srv_main->file_path;
    mma_insert_check_struct check_result;
    srv_uc_result result;
    mma_insert_info_struct insert_info;
    
	memset(&check_result, 0, sizeof(check_result));

	if (file_path == NULL)
    {
        MMI_ASSERT(0);
        return SRV_UC_OK;    /* even no file path, caller still go on following flow */
    }
    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = g_uc_p->srv_msg->msg_size;
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = MMA_INSERT_UNKNOWN;
    insert_info.filepath = (kal_wchar*)file_path;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);
	g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_IMAGE ;

    mma_uc_insert_object_check(&insert_info, &check_result);
    if (!(check_result.result))
	{
		result = srv_uc_convert_mms_check_result(&check_result);
		return result ;
	}
	if(check_result.insert_type == MMA_INSERT_TEXT ||
	   check_result.insert_type == MMA_INSERT_REF  ||
	   check_result.insert_type == MMA_INSERT_ATTACHMENT)
	{
		check_result.insert_type = MMA_INSERT_ATTACHMENT;

		srv_uc_post_handler_handle_object_insert_if_file_path_exist(
        g_uc_p->main.instance,
        check_result.insert_type,
        mmi_uc_image_path,
        (PU16)file_path);
	}
	else
	{
		 mmi_uc_post_handler_select_object_from_fm_to_insert(check_result.insert_type, (PU8)file_path, (PU16)file_path);
	}
	return SRV_UC_OK ;
}

#ifndef __MMI_FTE_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_exit_option
 * DESCRIPTION
 *  Entry function of unified composer exit option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_exit_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	#ifdef __MMI_OP02_LEMEI__
	/*direct discard lemei mms on exit*/
	if(g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
	{
       mmi_uc_discard_msg_before_exit_write_msg();
       g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_NORMAL_MMS;
       return;
     }
     else
    #endif /*__MMI_OP02_LEMEI__*/
    {
    mmi_uc_set_group_id();
	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
    {
	    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
	}
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_EXIT_OPT);
    return;
	}
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_option
 * DESCRIPTION
 *  Entry function of unified composer option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_option(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_OPTION);
    mmi_uc_set_group_id();
    g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
    g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
            g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
    mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_input_method_and_done
 * DESCRIPTION
 *  Entry function of option menu after editing subject
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_input_method_and_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_INPUT_METHOD_AND_DONE);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_subject_editor_cui_group_proc
 * DESCRIPTION
 *  Handler of editing subject field
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
#if !defined(__MMI_MMS_OMA_SUBJECT_LENGTH_SUPPORT__) && !defined(__MMI_MMS_CHARACTER_NUM_SUBJECT_LENGTH_SUPPORT__)
mmi_ret mmi_uc_subject_editor_cui_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(evt->evt_id)
    {
    case EVT_ID_CUI_FSEDITOR_SUBMMIT:
        /* Handler when user confirm input */
        cui_fseditor_get_text(g_uc_p->main.editor_child_cui_id, (WCHAR *)g_uc_p->srv_msg->temp_subject, (MMI_UC_MAX_SUBJECT_LEN + 1) * ENCODING_LENGTH);
        mmi_uc_input_method_and_done_go_back_to_option();
        
        break;
    case EVT_ID_CUI_FSEDITOR_ABORT:
        /* Handler when user Cancel input */
        mmi_uc_restore_subject_after_back_from_edit_subject();
        mmi_frm_group_close(g_uc_p->main.editor_cui_id);
        break;
    }
    return MMI_RET_OK;
}
#endif

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_edit_subject_editor_cui
 * DESCRIPTION
 *  Entry function of editing subject field through cui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_edit_subject_editor_cui(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    #if defined(__MMI_MMS_OMA_SUBJECT_LENGTH_SUPPORT__)
        mmi_uc_entry_edit_subject();
    #elif defined(__MMI_MMS_CHARACTER_NUM_SUBJECT_LENGTH_SUPPORT__)
        mmi_uc_entry_edit_subject();
    #else /* must define===> Normal UC */

        g_uc_p->main.editor_cui_id = mmi_frm_group_create(g_uc_p->main.uc_cui_gid, GRP_ID_UNIFIED_COMPOSER_EDITOR_CUI, mmi_uc_subject_editor_cui_group_proc, 0);
        mmi_frm_group_enter(g_uc_p->main.editor_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

        mmi_uc_entry_edit_subject();

    #endif 
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_edit_subject
 * DESCRIPTION
 *  Entry function of editing subject field
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_edit_subject(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_SUBJECT_EDITOR);
    return;
}
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#if !defined(__UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__) && !defined(__MMI_MMS_STANDALONE_COMPOSER__)
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_sending_sms
 * DESCRIPTION
 *  Entry function of sending sms
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_sending_sms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_SENDING_FORGROUND_SMS);
    return;
}
#endif /* !defined(__UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__) && !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ /* #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)  */


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_action_fsm
 * DESCRIPTION
 *  FSM for unified composer action
 * PARAMETERS
 *  action      [IN]        
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_action_fsm(srv_uc_action_type_enum action, U32 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
    U16 end_screen_id;  /* uc_src_id_enum */
    #endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(
        MMI_COMMON_TRC_G6_MSG,
        TRC_MMI_UC_ACTION_FSM_P4,
        g_uc_p->srv_send_info->action,
        g_uc_p->srv_main->state,
        action,
        result);
    MMI_TRACE(
        MMI_COMMON_TRC_G6_MSG,
        TRC_MMI_UC_ACTION_FSM_MSG_TYPE_P2,
        g_uc_p->srv_msg_type->curr_msg_type,
        g_uc_p->srv_send_info->existed_msg_type);
#if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    end_screen_id = SCR_ID_UC_PROCESSING;
#else 
    end_screen_id = SCR_ID_UC_SENDING;
#endif 
#endif
    switch (g_uc_p->srv_send_info->action)
    {
        case SRV_UC_ACTION_SEND:
        {
            switch (g_uc_p->srv_main->state)
            {
                case MMI_UC_STATE_WRITE_NEW_MSG:
                case MMI_UC_STATE_FORWARD:
                case MMI_UC_STATE_REPLY:
                case MMI_UC_STATE_REPLY_ALL:
                {
                    switch (action)
                    {
                            /* send , write new */
                        case SRV_UC_ACTION_SEND:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                switch (result)
                                {
                                    case SRV_SMS_CAUSE_NO_ERROR:
                                    {
                                        /* For background send, this case is triggerred when "save" successfully */
                                    #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                        {
                                            mmi_popup_property_struct arg;
	                                        mmi_popup_property_init(&arg);
	                                        #ifndef __MMI_BASIC_UI_STYLE__
	                                        arg.msg_icon = IMG_NEW_SMS_SEND;
	                                        #else
	                                        arg.msg_icon = mmi_get_event_based_image(MMI_EVENT_PROGRESS);
	                                        #endif
	                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SENDING)), MMI_EVENT_PROGRESS, &arg);                                       
                                        }

                                    #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SENT)), MMI_EVENT_MESSAGE_SENT, NULL);

                                    #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                        {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                    #else
                                            mmi_uc_delete_between_screens(SCR_ID_UC_OPT_ADD_RECIPIENT, end_screen_id);
                                    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else
                                        {
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                        }
                                        mmi_uc_reset_msg();
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;

                                        /* the following cases will not happened in background send, because only save successfully (SRV_SMS_CAUSE_NO_ERROR) or 
                                           fail (MMI_FRM_SMS_ERROR) result will be returned */
                                #ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                    case SRV_SMS_CAUSE_SEND_ABORT:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
											U16 curr_scrn_id = SCR_ID_UC_PROCESSING;
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);
											if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_PROCESSING;
											}
											else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_SENDING;
											}
                                            if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                            {
                                                U16 next_scrn_id = 0;
                                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                        #else
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            else
                                            {
                                                U16 next_scrn_id = 0;

                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                                            g_uc_p->send_info.abort = MMI_UC_ABORT_NONE;
                                            mmi_uc_delete_sms_frm_screen();
                                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            srv_uc_addr_struct *addr = NULL;

                                            addr = srv_uc_get_addr(
                                                    g_uc_p->main.instance,
                                                    g_uc_p->srv_send_info->curr_send_number);
                                            mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);   /* send-->end key to abort */
                                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                        break;

                                #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
/* under construction !*/
/* under construction !*/
                                #endif

                                    case SRV_SMS_CAUSE_NUMBER_INVALID:
                                    case SRV_SMS_CAUSE_SC_EMPTY:
									case SRV_SMS_CAUSE_ERROR_FDN_ENABLED:
                                    {
                                        if (SRV_SMS_CAUSE_NUMBER_INVALID == result)
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_NUMBER)), MMI_EVENT_ERROR, NULL);
                                        }
                                        else if(SRV_SMS_CAUSE_SC_EMPTY == result)
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_FAILURE_SC_NUM_EMPTY)), MMI_EVENT_ERROR, NULL);
                                        }
										else
										{
											mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_ID_SMS_FDN_FAIL)), MMI_EVENT_ERROR, NULL);
										}

                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                        {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                    #else
                                            mmi_uc_delete_between_screens(SCR_ID_UC_OPT_ADD_RECIPIENT, end_screen_id);
                                    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else
                                        {
                                            U16 next_scrn_id = 0;

                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                            mmi_uc_delete_between_screens(next_scrn_id, end_screen_id);
                                        }
                                        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_NOT_READY:
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_MSG_NOT_READY_YET)), MMI_EVENT_FAILURE, NULL);

                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, end_screen_id);
                                        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;
                                #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
/*
                                    case SRV_SMS_CAUSE_MEM_FULL:
                                    case SRV_SMS_CAUSE_MEM_INSUFFICIENT:
                                    case MMI_FRM_SMS_DATAEMPTY: 
                                    case SRV_SMS_CAUSE_DATA_EXCEED:
                                    case SRV_SMS_CAUSE_DATA_INVALID:
                                    case MMI_FRM_SMS_ERROR: 
*/
                                    default:
                                    {

                                        mmi_sms_api_result_handler_struct save_result;

                                        save_result.delete_sms_screen = KAL_FALSE;      /* Because only for display popup */
                                        save_result.display_popup = KAL_TRUE;
                                        save_result.request_type = MMI_SMS_REQ_SEND;        /* This is only for SRV_SMS_CAUSE_NO_ERROR. so the value in this case is meanless */
                                        save_result.result = result;
                                        mmi_sms_api_send_result_handler(&save_result);
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                        {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                    #else
                                            mmi_uc_delete_between_screens(SCR_ID_UC_OPT_ADD_RECIPIENT, end_screen_id);
                                    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else
                                        {
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                        }
                                        mmi_uc_reset_msg();
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;
/*
                                    default:
                                        MMI_ASSERT(0);
                                        break;
*/
                                #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 

                                    default:
                                    {
                                        srv_uc_addr_struct *addr = NULL;

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */

                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, end_screen_id);
                                        addr = srv_uc_get_addr(
                                                g_uc_p->main.instance,
                                                g_uc_p->srv_send_info->curr_send_number);
                                        mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                    }
                                        break;
                                #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 

                                }
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            /* send , write new mms */
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                switch (result)
                                {
                                    case MMA_RESULT_OK:
                                    {
                                        /* Avoid user to send abort after sending rsp is received. */
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_SENDING)
                                        {
                                            ClearInputEventHandler(MMI_DEVICE_ALL);
                                            ClearKeyHandler(KEY_END, KEY_EVENT_UP);
                                            ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
                                            ClearKeyHandler(KEY_END, KEY_LONG_PRESS);
                                            ClearKeyHandler(KEY_END, KEY_REPEAT);
                                        }
                                        else if (g_uc_p->send_info.abort != MMI_UC_ABORT_NONE)
                                        {

                                            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ACTION_FSM_CANCEL);

                                            g_uc_p->send_info.send_result = MMA_RESULT_FAIL_USER_CANCEL;
                                            mmi_uc_action_fsm(SRV_UC_ACTION_SEND, MMA_RESULT_FAIL_USER_CANCEL);
                                            return;
                                        }
                                        /* no matter send ok or fail, should notify anyway. */
                                        /* foreground send. should not be postcard cases. because postcard will be dependent with bgsr */
                                        /* won't notify if user select cancel send */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                    }
                                        break;

                                    case MMA_RESULT_FAIL_USER_CANCEL:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
                                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_OUTBOX);
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }

                                    }
                                        break;

                                    default:
                                    {
                                        if (g_uc_p->send_info.abort != MMI_UC_ABORT_NONE)
                                        {

                                            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ACTION_FSM_CANCEL);
                                            g_uc_p->send_info.send_result = MMA_RESULT_FAIL_USER_CANCEL;
                                            mmi_uc_action_fsm(SRV_UC_ACTION_SEND, MMA_RESULT_FAIL_USER_CANCEL);
                                            return;
                                        }
                                        /* no matter send ok or fail, should notify anyway. */
                                        /* foreground send. should not be postcard cases. because postcard will be dependent with bgsr */
                                        /* won't notify if user select cancel send */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_OUTBOX);
                                    }
                                        break;

                                }

                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send , write new */
                        case SRV_UC_ACTION_SAVE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                /* For background send, the following case will not happen, L4/mmsgrsr will take care */
                            #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                MMI_ASSERT(0);
                            #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_SEND_ABORT)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if (result == SRV_SMS_CAUSE_NO_ERROR)
                                    {
                                        /* send > save and use the same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_SUCCESS)), MMI_EVENT_PROPLEM, NULL);
                                    }
                                    else
                                    {
                                        /* send > save and use the same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_FAIL)), MMI_EVENT_PROPLEM, NULL);
                                    }
                                /*no matter send(1st save for sms-bg) ok or fail, should notify anyway*/
            					#ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
            						mmi_uc_phb_save_contact_notify_check(SRV_UC_PHB_LIST_TYPE_SMS, result, SCR_ID_UC_PROCESSING);
            					#endif /*__MMI_PHB_SAVE_CONTACT_NOTIFY__*/ 
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }

                                    mmi_uc_delete_sms_frm_screen();
                                    mmi_uc_reset_msg();
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {

                                    /* Should handle save result */
                                    if (result != MMA_RESULT_OK)
                                    {
                                        mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_FALSE);
                                    }
                                    else
                                    {
                                        mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_TRUE);
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }

                        }
                            break;

                            /* send , write new */
                        case SRV_UC_ACTION_DELETE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                                MMI_ASSERT(0);
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                /* Deletion may fail in USB normal mode. */

                                if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                        g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                        U16 next_scrn_id = 0;
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                #else
                                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                    }
                                    else
                                    {
                                        U16 next_scrn_id = 0;

                                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                        mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                    }
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                                else
                                {
                                    mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_TRUE);

                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_SENDING);
                                #else
                                        mmi_uc_delete_between_screens(SCR_ID_UC_OPT_ADD_RECIPIENT, SCR_ID_UC_SENDING);
                                #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_SENDING);
                                    }
                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }

                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send , write new */
                        default:
                        {
                            MMI_ASSERT(0);
                        }
                            break;
                    }
                }
                    break;  /* send , write new  */

                    /* send , edit */
                case MMI_UC_STATE_EDIT_EXISTED_MSG:
                case MMI_UC_STATE_SEND:
                {
                    srv_um_msg_box_enum msg_box = (srv_um_msg_box_enum) g_uc_p->send_info.curr_folder;

                    MMI_ASSERT(msg_box);
					if(!(msg_box))
					{
					MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
					}

                    switch (action)
                    {
                            /* send , edit */
                            /* if background sending is enabled, the "SEND" here only mean "SAVE successfully */
                        case SRV_UC_ACTION_SEND:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                switch (result)
                                {
                                    case SRV_SMS_CAUSE_NO_ERROR:
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            /* For background send, this case is triggerred when "save" successfully */
                                        #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                            {
                                                mmi_popup_property_struct arg;
	                                            mmi_popup_property_init(&arg);
	                                            #ifndef __MMI_BASIC_UI_STYLE__
	                                            arg.msg_icon = IMG_NEW_SMS_SEND;
	                                            #else
	                                            arg.msg_icon = mmi_get_event_based_image(MMI_EVENT_PROGRESS);
	                                            #endif
                                                arg.duration = MMI_UC_POPUP_TIME_OUT;
                                                arg.tone_id = SUCCESS_TONE;
	                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SENDING)), MMI_EVENT_MESSAGE_SENT, &arg);                                       
                                            }
                                        #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 

                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SENT)), MMI_EVENT_MESSAGE_SENT, NULL);
                                        #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                            /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                        #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                            mmi_uc_phb_save_contact_notify_check(
                                                SRV_UC_PHB_LIST_TYPE_SMS,
                                                result,
                                                end_screen_id);
                                        #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                            if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                            {
                                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                mmi_uc_delete_between_screens(
                                                    SCR_ID_UC_EDITOR,
                                                    end_screen_id);
                                        #else
                                                mmi_uc_delete_between_screens(
                                                    SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                    end_screen_id);
                                        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            }
                                            else
                                            {
                                                mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                            }
                                            mmi_uc_reset_msg();
                                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                            mmi_uc_delete_sms_frm_screen();
                                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                        }
                                        else    /* sent ok, then delete msg from draft */
                                        {
                                            /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                        #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                            /* because phb notify will be triggered in mmi_uc_delete_sms_callback */
                                            if (msg_box != SRV_UM_MSG_BOX_DRAFT && msg_box != SRV_UM_MSG_BOX_UNSENT)
                                            {
                                                mmi_uc_phb_save_contact_notify_check(
                                                    SRV_UC_PHB_LIST_TYPE_SMS,
                                                    result,
                                                    end_screen_id);
                                            }
                                        #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                            /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                            /* Do not display processing screen in such cases. */
                                            if (mmi_uc_is_uc_screen_in_history())
                                            {
                                                mmi_uc_set_processing_screen(
                                                    0,
                                                    STR_GLOBAL_SENDING,
                                                    #ifndef __MMI_BASIC_UI_STYLE__
                                                    IMG_NEW_SMS_SEND,
	                                                   #else
	                                                   mmi_get_event_based_image(MMI_EVENT_PROGRESS),
	                                                   #endif
                                                    0);
                                                mmi_uc_entry_processing_after_send();
                                            }
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);
                                            /* Delete the orignal message in draft/unsent */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                    msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                {
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                }
                                            }
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_delete_existed_mms();
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;

                                        /* if BGS is enabled, the following case will be handled by L4 */
                                #ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                    case SRV_SMS_CAUSE_SEND_ABORT:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
                                            U16 curr_scrn_id = SCR_ID_UC_PROCESSING;
											mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);
                                           if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_PROCESSING;
											}
											else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_SENDING;
											}
                                            if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                                g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                            {
                                                U16 next_scrn_id = 0;

                                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                        #else
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            else
                                            {
                                                U16 next_scrn_id = 0;

                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                                            mmi_uc_delete_sms_frm_screen();
                                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                            {
                                                srv_uc_addr_struct *addr = NULL;

                                                addr = srv_uc_get_addr(
                                                        g_uc_p->main.instance,
                                                        g_uc_p->srv_send_info->curr_send_number);
                                                mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);       /* send-->end ket to abort-->not sent--outbox */
                                                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                            }
                                            else
                                            {
                                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                        msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                    {
                                                        srv_sms_delete_msg(
                                                            (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                            mmi_uc_delete_sms_callback, 
                                                            NULL);
                                                    }

                                                }
                                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    srv_uc_addr_struct *addr = NULL;

                                                    addr = srv_uc_get_addr(
                                                            g_uc_p->main.instance,
                                                            g_uc_p->srv_send_info->curr_send_number);
                                                    mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);   /* send-->end ket to abort-->not sent--outbox */
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                        break;

                                #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
/* under construction !*/
/* under construction !*/
                                #endif

                                    case SRV_SMS_CAUSE_NOT_READY:
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_MSG_NOT_READY_YET)), MMI_EVENT_FAILURE, NULL);

                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, end_screen_id);
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_NUMBER_INVALID:
                                    case SRV_SMS_CAUSE_SC_EMPTY:
                                    {
                                        if (SRV_SMS_CAUSE_NUMBER_INVALID == result)
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_NUMBER)), MMI_EVENT_ERROR, NULL);
                                        }
                                        else
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_FAILURE_SC_NUM_EMPTY)), MMI_EVENT_ERROR, NULL);
                                        }
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                        {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                    #else
                                            mmi_uc_delete_between_screens(SCR_ID_UC_OPT_ADD_RECIPIENT, end_screen_id);
                                    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else
                                        {
                                            U16 next_scrn_id = 0;

                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                            mmi_uc_delete_between_screens(next_scrn_id, end_screen_id);
                                        }
                                        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;

                                #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
/*
                                    case SRV_SMS_CAUSE_MEM_FULL:
                                    case SRV_SMS_CAUSE_MEM_INSUFFICIENT:
                                    case MMI_FRM_SMS_DATAEMPTY: 
                                    case SRV_SMS_CAUSE_DATA_EXCEED:
                                    case SRV_SMS_CAUSE_DATA_INVALID:
                                    case MMI_FRM_SMS_ERROR: 
*/
                                    default:
                                    {
                                        mmi_sms_api_result_handler_struct save_result;

                                        save_result.delete_sms_screen = KAL_FALSE;      /* Because only for display popup */
                                        save_result.display_popup = KAL_TRUE;
                                        save_result.request_type = MMI_SMS_REQ_SEND;        /* This is only for SRV_SMS_CAUSE_NO_ERROR. so the value in this case is meanless */
                                        save_result.result = result;
                                        mmi_sms_api_send_result_handler(&save_result);
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                            g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                        {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                    #else
                                            mmi_uc_delete_between_screens(SCR_ID_UC_OPT_ADD_RECIPIENT, end_screen_id);
                                    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else
                                        {
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, end_screen_id);
                                        }
                                        mmi_uc_reset_msg();
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);

                                    }
                                        break;
/*
                                    default:
                                    {
                                        MMI_ASSERT(0);
                                    }
                                        break;
*/
                                #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 

                                    default:
                                    {
                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                          mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, end_screen_id);
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            end_screen_id);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            srv_uc_addr_struct *addr = NULL;

                                            addr = srv_uc_get_addr(
                                                    g_uc_p->main.instance,
                                                    g_uc_p->srv_send_info->curr_send_number);
                                            mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);   /* send-->error-->not sent ok--outbox */
                                        }
                                        else
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT)
                                            {
                                                /* highlighter need to set by UC */
                                                g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                            }

                                            /* save msg from SMS to SMS. Delete original one and then save new one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {

                                                if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                    msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                {
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                }
                                            }
                                            /* save msg from MMS to SMS. Save new one and then delete original one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                srv_uc_addr_struct *addr = NULL;

                                                addr = srv_uc_get_addr(
                                                        g_uc_p->main.instance,
                                                        g_uc_p->srv_send_info->curr_send_number);
                                                mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);       /* send-->error-->not sent ok--outbox */
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;
                                #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                }
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            /* send , edit */
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                switch (result)
                                {
                                    case MMA_RESULT_OK:
                                    {
                                        if (g_uc_p->send_info.abort != MMI_UC_ABORT_NONE)
                                        {

                                            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ACTION_FSM_CANCEL);
                                            g_uc_p->send_info.send_result = MMA_RESULT_FAIL_USER_CANCEL;
                                            mmi_uc_action_fsm(SRV_UC_ACTION_SEND, MMA_RESULT_FAIL_USER_CANCEL);
                                            return;
                                        }

                                        /* no matter send ok or fail, should notify anyway. */
                                        /* foreground send. should not be postcard cases. because postcard will be dependent with bgsr */
                                        /* won't notify if user select cancel send */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            /* Avoid user to send abort after sending rsp is received. */
                                            if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_SENDING)
                                            {
                                                ClearInputEventHandler(MMI_DEVICE_ALL);
                                                ClearKeyHandler(KEY_END, KEY_EVENT_UP);
                                                ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
                                                ClearKeyHandler(KEY_END, KEY_LONG_PRESS);
                                                ClearKeyHandler(KEY_END, KEY_REPEAT);
                                            }
                                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                        }
                                        else
                                        {
                                            /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                            /* Do not display processing screen in such cases. */
                                            if (mmi_uc_is_uc_screen_in_history())
                                            {
#ifndef __MMI_BASIC_UI_STYLE__
                                                mmi_uc_set_processing_screen(
                                                    0,
                                                    STR_GLOBAL_SENDING,
                                                    IMG_NEW_SMS_SEND,
                                                    0);
#else
												mmi_uc_set_processing_screen(
													0,
													STR_GLOBAL_SENDING,
													mmi_get_event_based_image(MMI_EVENT_PROGRESS),
													0);
#endif
                                                mmi_uc_entry_processing_after_send();
                                            }
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {

                                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                    msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                {
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                }
                                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                ASSERT(0);
                                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                            }
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_delete_existed_mms();
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;

                                    case MMA_RESULT_FAIL_USER_CANCEL:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
                                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                            {
                                                mmi_uc_save_mms_req(
                                                    g_uc_p->srv_send_info->new_msg_id,
                                                    MMA_FOLDER_OUTBOX);
                                            }
                                            else
                                            {
                                                /* save msg from SMS to MMS. Save new one and then delete original one */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    mmi_uc_save_mms_req(
                                                        g_uc_p->srv_send_info->new_msg_id,
                                                        MMA_FOLDER_OUTBOX);
                                                }
                                                /* save msg from MMS to MMS. Delete original one and then save new one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    mmi_uc_delete_existed_mms();
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                        break;

                                    default:
                                    {
                                        if (g_uc_p->send_info.abort != MMI_UC_ABORT_NONE)
                                        {

                                            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ACTION_FSM_CANCEL);
                                            g_uc_p->send_info.send_result = MMA_RESULT_FAIL_USER_CANCEL;
                                            mmi_uc_action_fsm(SRV_UC_ACTION_SEND, MMA_RESULT_FAIL_USER_CANCEL);
                                            return;
                                        }

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_OUTBOX);
                                        }
                                        else
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT)
                                            {
                                                /* highlighter need to set by UC */
                                                g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                            }

                                            /* save msg from SMS to MMS. Save new one and then delete original one */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                mmi_uc_save_mms_req(
                                                    g_uc_p->srv_send_info->new_msg_id,
                                                    MMA_FOLDER_OUTBOX);
                                            }
                                            /* save msg from MMS to MMS. Delete original one and then save new one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_delete_existed_mms();
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;

                                }

                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send , edit */
                        case SRV_UC_ACTION_SAVE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                /* For background send, the following case will not happen, L4 will take care */
                            #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                MMI_ASSERT(0);
                            #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_SEND_ABORT)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if (result == SRV_SMS_CAUSE_NO_ERROR)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    mmi_uc_delete_existed_mms();
                                                    return;
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }

                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);

                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if (result == SRV_SMS_CAUSE_NO_ERROR)
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                        {
                                            /* save msg from SMS to SMS. Delete original one and then save new one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                /* Do nothing. */
                                            }
                                            /* save msg from MMS to SMS. Save new one and then delete original one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_delete_existed_mms();
                                                return;
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }

                                        /* send > save, use same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_SUCCESS)), MMI_EVENT_PROPLEM, NULL);

                                    }
                                    else
                                    {
                                        /* send > save, use same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_FAIL)), MMI_EVENT_PROPLEM, NULL);
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                    #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_delete_sms_frm_screen();
                                    mmi_uc_reset_msg();
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if (result == MMA_RESULT_OK)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to MMS. Save new one and then delete original one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                    return;
                                                #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                    ASSERT(0);
                                                #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                }
                                                /* save msg from MMS to MMS. Delete original one and then save new one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if (result == MMA_RESULT_OK)
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                        {
                                            /* save msg from SMS to MMS. Save new one and then delete original one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                srv_sms_delete_msg(
                                                    (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                    mmi_uc_delete_sms_callback, 
                                                    NULL);
                                                return;
                                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                MMI_ASSERT(0);
                                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                            }
                                            /* save msg from MMS to MMS. Delete original one and then save new one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                /* Do nothing. */
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }

                                    mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_TRUE);
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 

                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }

                        }
                            break;

                            /* send , edit */
                        case SRV_UC_ACTION_DELETE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_NO_ERROR)
                                {

                                    /* For background send, this case is triggerred when "save" successfully, mean send from draft, send req already process 1st save ok, here, delete this sms from draft ok */
                                #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                    {
                                            mmi_popup_property_struct arg;
	                                        mmi_popup_property_init(&arg);
	                                        #ifndef __MMI_BASIC_UI_STYLE__
	                                        arg.msg_icon = IMG_NEW_SMS_SEND;
	                                        #else
	                                        arg.msg_icon = mmi_get_event_based_image(MMI_EVENT_PROGRESS);
	                                        #endif
                                            arg.duration = MMI_UC_POPUP_TIME_OUT;
                                            arg.tone_id = SUCCESS_TONE;
	                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SENDING)), MMI_EVENT_MESSAGE_SENT, &arg);                                       
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }

                                #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SENT)), MMI_EVENT_MESSAGE_SENT, NULL);
                                #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                    mmi_uc_phb_save_contact_notify_check(
                                        SRV_UC_PHB_LIST_TYPE_SMS,
                                        result,
                                        SCR_ID_UC_PROCESSING);
                                #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                    mmi_uc_reset_msg();
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                    mmi_uc_delete_sms_frm_screen();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
                                else
                                {
                                    MMI_ASSERT(0);  /* if 1st save fail, not delete msg from draft, so here this case will not happened */
									MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
								}
                            #else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                                else if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_SEND_ABORT)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                             result == SRV_SMS_CAUSE_NO_ERROR) ||
                                            (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                             result == MMA_RESULT_OK))
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    srv_uc_addr_struct *addr = NULL;

                                                    addr = srv_uc_get_addr(
                                                            g_uc_p->main.instance,
                                                            g_uc_p->srv_send_info->curr_send_number);
                                                    mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);   /* abort */
                                                    return;
                                                }
                                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                         result == SRV_SMS_CAUSE_NO_ERROR) ||
                                        (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                         result == MMA_RESULT_OK))
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                        {
                                            /* save msg from SMS to SMS. Delete original one and then save new one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                srv_uc_addr_struct *addr = NULL;

                                                addr = srv_uc_get_addr(
                                                        g_uc_p->main.instance,
                                                        g_uc_p->srv_send_info->curr_send_number);
                                                mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);       /* sent, del not ok */
                                                return;
                                            }
                                            /* save msg from MMS to SMS. Save new one and then delete original one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                /* Do nothing. */
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }

                                        /* send > save, use same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_SUCCESS)), MMI_EVENT_PROPLEM, NULL);
                                    }
                                    else
                                    {
                                        /* send > save, use same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_FAIL)), MMI_EVENT_PROPLEM, NULL);
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_delete_sms_frm_screen();
                                    mmi_uc_reset_msg();
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);

                                }
                            #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                if (g_uc_p->send_info.send_result == MMA_RESULT_OK)
                                {
                                    /* Original msg is deleted first in unsent and draft box cases */
                                    if (g_uc_p->srv_send_info->new_msg_id)
                                    {
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                        return;
                                    }

                                    mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_TRUE);

                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                        if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                                        {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(
                                                SCR_ID_UC_EDITOR,
                                                SCR_ID_UC_PROCESSING);
                                #else
                                            mmi_uc_delete_between_screens(
                                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                SCR_ID_UC_PROCESSING);
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                                        {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(
                                                SCR_ID_UC_EDITOR,
                                                SCR_ID_UC_SENDING);
                                    #else
                                            mmi_uc_delete_between_screens(
                                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                SCR_ID_UC_SENDING);
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                    else
                                    {
                                        if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                                        {
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                        }
                                        else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                                        {
                                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_SENDING);
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                                else if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                    {
                                        /* Deletion may fail in USB normal mode. */

                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);

                                    #ifdef __MMI_MMS_POSTCARD__
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                    #endif 
                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                            g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                        {
                                            U16 next_scrn_id = 0;
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                    #else
                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                        }
                                        else
                                        {
                                            U16 next_scrn_id = 0;

                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                            mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                        }
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                             result == SRV_SMS_CAUSE_NO_ERROR) ||
                                            (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                             result == MMA_RESULT_OK))
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to MMS. Save new one and then delete original one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                /* save msg from MMS to MMS. Delete original one and then save new one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    mmi_uc_save_mms_req(
                                                        g_uc_p->srv_send_info->new_msg_id,
                                                        MMA_FOLDER_OUTBOX);
                                                    return;
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                         result == SRV_SMS_CAUSE_NO_ERROR) ||
                                        (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                         result == MMA_RESULT_OK))
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                        {
                                            /* save msg from MMS to SMS. Save new one and then delete original one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                /* Do nothing. */
                                            }
                                            /* save msg from MMS to MMS. Delete original one and then save new one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_save_mms_req(
                                                    g_uc_p->srv_send_info->new_msg_id,
                                                    MMA_FOLDER_OUTBOX);
                                                return;
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }

                                    }

                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_TRUE);

                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }

                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send , write new */
                        default:
                        {
                            MMI_ASSERT(0);
                        }
                            break;
                    }
                }
                    break;  /* send , edit existed  */

                default:
                {
                    MMI_ASSERT(0);
                }
                    break;

            }

        }
            break;

        case SRV_UC_ACTION_SEND_AND_SAVE:
        {
            srv_um_msg_box_enum msg_box = (srv_um_msg_box_enum) g_uc_p->send_info.curr_folder;

        #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
            MMI_ASSERT(g_uc_p->srv_msg_type->curr_msg_type != MMI_UC_MSG_TYPE_SMS_PREFER);
			if(!(g_uc_p->srv_msg_type->curr_msg_type != MMI_UC_MSG_TYPE_SMS_PREFER))
			{
			MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
			}
        #endif 
        #ifdef __MMI_MMS_BGSR_SUPPORT__
            MMI_ASSERT(g_uc_p->srv_msg_type->curr_msg_type != MMI_UC_MSG_TYPE_MMS_PREFER);
			if(!(g_uc_p->srv_msg_type->curr_msg_type != MMI_UC_MSG_TYPE_MMS_PREFER))
			{
			MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
			}
        #endif 

            switch (g_uc_p->srv_main->state)
            {
                    /* send and save, write new */
                case MMI_UC_STATE_WRITE_NEW_MSG:
                case MMI_UC_STATE_FORWARD:
                case MMI_UC_STATE_REPLY:
                case MMI_UC_STATE_REPLY_ALL:
                {
                    switch (action)
                    {
                            /* send and save, write new */
                        case SRV_UC_ACTION_SEND:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                switch (result)
                                {
                                    case SRV_SMS_CAUSE_NO_ERROR:
                                    {
                                        srv_uc_addr_struct *addr = NULL;

                                        if (msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            /* highlighter need to set by UC */
                                            g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                        }

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                        addr = srv_uc_get_addr(g_uc_p->main.instance, 0);
                                        mmi_uc_save_sms_after_send(SRV_SMS_STATUS_SENT, addr->addr);
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_SEND_ABORT:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
											U16 curr_scrn_id = SCR_ID_UC_PROCESSING;
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);
											if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_PROCESSING;
											}
											else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_SENDING;
											}                                            

                                            if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                            {
                                                U16 next_scrn_id = 0;
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                #else
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            else
                                            {
                                                U16 next_scrn_id = 0;

                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                                            g_uc_p->send_info.abort = MMI_UC_ABORT_NONE;
                                            mmi_uc_delete_sms_frm_screen();
                                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            srv_uc_addr_struct *addr = NULL;

                                            addr = srv_uc_get_addr(
                                                    g_uc_p->main.instance,
                                                    g_uc_p->srv_send_info->curr_send_number);
                                            mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_NOT_READY:
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_MSG_NOT_READY_YET)), MMI_EVENT_FAILURE, NULL);
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);
                                        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_NUMBER_INVALID:
                                    case SRV_SMS_CAUSE_SC_EMPTY:
                                    {
                                        if (SRV_SMS_CAUSE_NUMBER_INVALID == result)
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_NUMBER)), MMI_EVENT_ERROR, NULL);
                                        }
                                        else
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_FAILURE_SC_NUM_EMPTY)), MMI_EVENT_ERROR, NULL);
                                        }

                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                        {
                                            U16 next_scrn_id = 0;
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                #else
                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_SENDING);
                                        }
                                        else
                                        {
                                            U16 next_scrn_id = 0;

                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                            mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_SENDING);
                                        }
                                        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;
                                #if 0 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
/* under construction !*/
/* under construction !*/
                            #endif 
                                    default:
                                    {
                                        srv_uc_addr_struct *addr = NULL;

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }

                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);
                                        addr = srv_uc_get_addr(
                                                g_uc_p->main.instance,
                                                g_uc_p->srv_send_info->curr_send_number);
                                        mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                    }
                                        break;
                                }
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            /* send and save, write new */
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                switch (result)
                                {
                                    case MMA_RESULT_OK:
                                    {
                                        if (g_uc_p->send_info.abort != MMI_UC_ABORT_NONE)
                                        {
                                            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ACTION_FSM_CANCEL);
                                            g_uc_p->send_info.send_result = MMA_RESULT_FAIL_USER_CANCEL;
                                            mmi_uc_action_fsm(SRV_UC_ACTION_SEND, MMA_RESULT_FAIL_USER_CANCEL);
                                            return;
                                        }

                                        /* no matter send ok or fail, should notify anyway. */
                                        /* foreground send. should not be postcard cases. because postcard will be dependent with bgsr */
                                        /* won't notify if user select cancel send */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            /* highlighter need to set by UC */
                                            g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                        }

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);

                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);
                                        mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_SENT);
                                    }
                                        break;

                                    case MMA_RESULT_FAIL_USER_CANCEL:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
                                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_OUTBOX);
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }

                                    }
                                        break;

                                    default:
                                    {
                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_OUTBOX);
                                    }
                                        break;

                                }
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send and save, write new */
                        case SRV_UC_ACTION_SAVE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_SEND_ABORT)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_NO_ERROR)
                                    {
                                        if (result == SRV_SMS_CAUSE_NO_ERROR)
                                        {
                                            /* send > save */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_SUCCESS)), MMI_EVENT_MESSAGE_SENT, NULL);

                                        }
                                        else
                                        {
                                            /* send > save */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_FAIL)), MMI_EVENT_MESSAGE_SENT, NULL);
                                        }

                                    }
                                    else
                                    {
                                        if (result == SRV_SMS_CAUSE_NO_ERROR)
                                        {
                                            /* send > save and play same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_SUCCESS)), MMI_EVENT_PROPLEM, NULL);
                                        }
                                        else
                                        {
                                            /* send > save and play same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_FAIL)), MMI_EVENT_PROPLEM, NULL);
                                        }
                                    }
                                    /*temp */
                                /*no matter send(1st save for sms-bg) ok or fail, should notify anyway*/
            						#ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
            							mmi_uc_phb_save_contact_notify_check(SRV_UC_PHB_LIST_TYPE_SMS, result, SCR_ID_UC_PROCESSING);
            						#endif /*__MMI_PHB_SAVE_CONTACT_NOTIFY__*/ 

                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_delete_sms_frm_screen();
                                }
                                mmi_uc_reset_msg();
                                mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if (g_uc_p->send_info.send_result == MMA_RESULT_OK)
                                    {
                                        if (result == MMA_RESULT_OK)
                                        {
                                            /* send > save, use same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_SUCCESS)), MMI_EVENT_MESSAGE_SENT, NULL);
                                        }
                                        else
                                        {
                                            /* send > save, use same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_FAIL)), MMI_EVENT_MESSAGE_SENT, NULL);
                                        }

                                    }
                                    else if (result != MMA_RESULT_OK)
                                    {
                                        mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_FALSE);
                                    }
                                    else
                                    {
                                        mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_TRUE);
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                    {
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                }
                                mmi_uc_reset_msg();
                                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                        case SRV_UC_ACTION_DELETE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                                MMI_ASSERT(0);
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                /* Deletion may fail in USB normal mode. */

                                if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);

                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                        g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                        U16 next_scrn_id = 0;
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                #else
                                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                    }
                                    else
                                    {
                                        U16 next_scrn_id = 0;

                                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                        mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                    }
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                                else
                                {
                                    MMI_ASSERT(0);
                                }

                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }

                        }
                            break;

                            /* send and save, write new */
                        default:
                        {
                            MMI_ASSERT(0);
                        }
                            break;
                    }

                }
                    break;  /* send and save, write new */

                case MMI_UC_STATE_EDIT_EXISTED_MSG:
                case MMI_UC_STATE_SEND:
                {
                    MMI_ASSERT(msg_box);
					if(!(msg_box))
					{
					MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
					}
                    switch (action)
                    {
                            /* send and save, edit */
                        case SRV_UC_ACTION_SEND:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                            #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                mmi_uc_phb_save_contact_notify_check(
                                    SRV_UC_PHB_LIST_TYPE_SMS,
                                    result,
                                    SCR_ID_UC_SENDING);
                            #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                switch (result)
                                {
                                    case SRV_SMS_CAUSE_NO_ERROR:
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            /* highlighter need to set by UC */
                                            g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                        }

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            srv_uc_addr_struct *addr = NULL;

                                            addr = srv_uc_get_addr(g_uc_p->main.instance, 0);
                                            mmi_uc_save_sms_after_send(SRV_SMS_STATUS_SENT, addr->addr);
                                        }
                                        else
                                        {
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                    msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                {
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                }
                                            }
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_delete_existed_mms();
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_SEND_ABORT:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
											U16 curr_scrn_id = SCR_ID_UC_PROCESSING;
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);
											if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_PROCESSING;
											}
											else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
											{
												curr_scrn_id = SCR_ID_UC_SENDING;
											}
                                            if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                                g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                            {
                                                U16 next_scrn_id = 0;
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                    #else
                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            else
                                            {
                                                U16 next_scrn_id = 0;

                                                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                                mmi_uc_delete_between_screens(next_scrn_id, curr_scrn_id);
                                            }
                                            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                                            mmi_uc_delete_sms_frm_screen();
                                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                            {
                                                srv_uc_addr_struct *addr = NULL;

                                                addr = srv_uc_get_addr(
                                                        g_uc_p->main.instance,
                                                        g_uc_p->srv_send_info->curr_send_number);
                                                mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                            }
                                            else
                                            {
                                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                        msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                    {
                                                        srv_sms_delete_msg(
                                                            (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                            mmi_uc_delete_sms_callback, 
                                                            NULL);
                                                    }

                                                }
                                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    srv_uc_addr_struct *addr = NULL;

                                                    addr = srv_uc_get_addr(
                                                            g_uc_p->main.instance,
                                                            g_uc_p->srv_send_info->curr_send_number);
                                                    mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_NOT_READY:
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_MSG_NOT_READY_YET)), MMI_EVENT_FAILURE, NULL);

                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;

                                    case SRV_SMS_CAUSE_NUMBER_INVALID:
                                    case SRV_SMS_CAUSE_SC_EMPTY:

                                    {
                                        if (SRV_SMS_CAUSE_NUMBER_INVALID == result)
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_NUMBER)), MMI_EVENT_ERROR, NULL);
                                        }
                                        else
                                        {
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_SMS_FAILURE_SC_NUM_EMPTY)), MMI_EVENT_ERROR, NULL);
                                        }
                                        /* no matter send(1st save for sms-bg) ok or fail, should notify anyway */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_SMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                        {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            mmi_uc_delete_between_screens(
                                                SCR_ID_UC_EDITOR,
                                                SCR_ID_UC_SENDING);
                                    #else
                                            mmi_uc_delete_between_screens(
                                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                SCR_ID_UC_SENDING);
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        }
                                        else
                                        {
                                            U16 next_scrn_id = 0;

                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG);
                                            mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_SENDING);
                                        }

                                        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                        break;
                                #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                                #endif
                                    default:
                                    {
                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            srv_uc_addr_struct *addr = NULL;

                                            addr = srv_uc_get_addr(
                                                    g_uc_p->main.instance,
                                                    g_uc_p->srv_send_info->curr_send_number);
                                            mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                        }
                                        else
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT)
                                            {
                                                /* highlighter need to set by UC */
                                                g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                            }

                                            /* save msg from SMS to SMS. Delete original one and then save new one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                    msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                {
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                }
                                            }
                                            /* save msg from MMS to SMS. Save new one and then delete original one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                srv_uc_addr_struct *addr = NULL;

                                                addr = srv_uc_get_addr(
                                                        g_uc_p->main.instance,
                                                        g_uc_p->srv_send_info->curr_send_number);
                                                mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;
                                }
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            /* send and save , edit */
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                switch (result)
                                {
                                    case MMA_RESULT_OK:
                                    {
                                        if (g_uc_p->send_info.abort != MMI_UC_ABORT_NONE)
                                        {
                                            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ACTION_FSM_CANCEL);
                                            g_uc_p->send_info.send_result = MMA_RESULT_FAIL_USER_CANCEL;
                                            mmi_uc_action_fsm(SRV_UC_ACTION_SEND, MMA_RESULT_FAIL_USER_CANCEL);
                                            return;
                                        }

                                        /* no matter send ok or fail, should notify anyway. */
                                        /* foreground send. should not be postcard cases. because postcard will be dependent with bgsr */
                                        /* won't notify if user select cancel send */
                                    #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                        mmi_uc_phb_save_contact_notify_check(
                                            SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                            result,
                                            SCR_ID_UC_SENDING);
                                    #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 

                                        if (msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            /* highlighter need to set by UC */
                                            g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                        }

                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_SENT);
                                        }
                                        else
                                        {
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                                    msg_box == SRV_UM_MSG_BOX_UNSENT)
                                                {
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                }
                                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                MMI_ASSERT(0);
                                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                            }
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_delete_existed_mms();
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;

                                    case MMA_RESULT_FAIL_USER_CANCEL:
                                    {
                                        if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                        {
                                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                        }
                                        else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                            {
                                                mmi_uc_save_mms_req(
                                                    g_uc_p->srv_send_info->new_msg_id,
                                                    MMA_FOLDER_OUTBOX);
                                            }
                                            else
                                            {
                                                /* save msg from SMS to MMS. Save new one and then delete original one */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                    /* srv_sms_delete_msg(
                                                            (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                            mmi_uc_delete_sms_callback, 
                                                            NULL); */

                                                    mmi_uc_save_mms_req(
                                                        g_uc_p->srv_send_info->new_msg_id,
                                                        MMA_FOLDER_OUTBOX);

                                                #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                    MMI_ASSERT(0);
                                                #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                }
                                                /* save msg from MMS to MMS. Delete original one and then save new one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    mmi_uc_delete_existed_mms();
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }
                                    }
                                        break;

                                    default:
                                    {
                                        /* UC Screens may be deleted by other Apps, ex. USB normal mode. */
                                        /* Do not display processing screen in such cases. */
                                        if (mmi_uc_is_uc_screen_in_history())
                                        {
                                            mmi_uc_set_processing_screen(
                                                0,
                                                STR_GLOBAL_SAVING,
                                                mmi_get_event_based_image(MMI_EVENT_PROGRESS),
                                                0);
                                            mmi_uc_entry_processing_after_send();
                                        }
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING);

                                        if (msg_box == SRV_UM_MSG_BOX_INBOX || msg_box == SRV_UM_MSG_BOX_SENT)
                                        {
                                            mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_OUTBOX);
                                        }
                                        else
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT)
                                            {
                                                /* highlighter need to set by UC */
                                                g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                            }

                                            /* save msg from SMS to MMS. Save new one and then delete original one */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                /* srv_sms_delete_msg(
                                                    (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                    mmi_uc_delete_sms_callback, 
                                                    NULL); */

                                                mmi_uc_save_mms_req(
                                                    g_uc_p->srv_send_info->new_msg_id,
                                                    MMA_FOLDER_OUTBOX);

                                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                MMI_ASSERT(0);
                                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                            }
                                            /* save msg from MMS to MMS. Delete original one and then save new one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_delete_existed_mms();
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                    }
                                        break;

                                }

                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send and save, edit */
                        case SRV_UC_ACTION_SAVE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_SEND_ABORT)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if (result == SRV_SMS_CAUSE_NO_ERROR)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    mmi_uc_delete_existed_mms();
                                                    return;
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }

                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_NO_ERROR)
                                    {
                                        if (result == SRV_SMS_CAUSE_NO_ERROR)
                                        {
                                            /* send > save, use same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_SUCCESS)), MMI_EVENT_MESSAGE_SENT, NULL);

                                        }
                                        else
                                        {
                                            /* send > save, use same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_FAIL)), MMI_EVENT_MESSAGE_SENT, NULL);
                                        }

                                    }
                                    else
                                    {
                                        if (result == SRV_SMS_CAUSE_NO_ERROR)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    mmi_uc_delete_existed_mms();
                                                    return;
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }

                                            /* send > save, use same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_SUCCESS)), MMI_EVENT_PROPLEM, NULL);
                                        }
                                        else
                                        {
                                            /* send > save, use same tone for all send fail reasons */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_FAIL)), MMI_EVENT_PROPLEM, NULL);
                                        }
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_EDITOR,
                                            SCR_ID_UC_PROCESSING);
                                    #else
                                        mmi_uc_delete_between_screens(
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                            SCR_ID_UC_PROCESSING);
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_delete_sms_frm_screen();
                                    mmi_uc_reset_msg();
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if (result == MMA_RESULT_OK)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to MMS. Save new one and then delete original one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                    return;
                                                #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                    MMI_ASSERT(0);
                                                #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                }
                                                /* save msg from MMS to MMS. Delete original one and then save new one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }

                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if (g_uc_p->send_info.send_result == MMA_RESULT_OK)
                                    {
                                        if (result == MMA_RESULT_OK)
                                        {
                                            /* send > save */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_SUCCESS)), MMI_EVENT_MESSAGE_SENT, NULL);
                                        }
                                        else
                                        {
                                            /* send > save */
                                            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_SUCCESS_SAVE_FAIL)), MMI_EVENT_MESSAGE_SENT, NULL);
                                        }

                                    }
                                    else
                                    {
                                        if (result == MMA_RESULT_OK)
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to MMS. Save new one and then delete original one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                    srv_sms_delete_msg(
                                                        (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                        mmi_uc_delete_sms_callback, 
                                                        NULL);
                                                    return;
                                                #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                    MMI_ASSERT(0);
                                                #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                }
                                                /* save msg from MMS to MMS. Delete original one and then save new one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                        }

                                        /* should handle save fail. not move to above, because assert(0) maybe define to nothing in release version */
                                        if (result != MMA_RESULT_OK)
                                        {
                                            mmi_uc_display_mma_send_result_popup(
                                                (mma_result_enum)g_uc_p->send_info.send_result,
                                                MMI_FALSE);
                                        }
                                        else
                                        {
                                            mmi_uc_display_mma_send_result_popup(
                                                (mma_result_enum)g_uc_p->send_info.send_result,
                                                MMI_TRUE);
                                        }
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                        mmi_uc_delete_between_screens(
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            SCR_ID_UC_EDITOR,
                                    #else
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            SCR_ID_UC_PROCESSING);
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                        case SRV_UC_ACTION_DELETE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_NO_ERROR)
                                {
                                    srv_uc_addr_struct *addr = NULL;

                                    addr = srv_uc_get_addr(g_uc_p->main.instance, 0);
                                    mmi_uc_save_sms_after_send(SRV_SMS_STATUS_SENT, addr->addr);
                                }
                                else if (g_uc_p->send_info.send_result == SRV_SMS_CAUSE_SEND_ABORT)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                             result == SRV_SMS_CAUSE_NO_ERROR) ||
                                            (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                             result == MMA_RESULT_OK))
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    srv_uc_addr_struct *addr = NULL;

                                                    addr = srv_uc_get_addr(
                                                            g_uc_p->main.instance,
                                                            g_uc_p->srv_send_info->curr_send_number);
                                                    mmi_uc_save_sms_after_send(SRV_SMS_STATUS_SENT, addr->addr);
                                                    return;

                                                }
                                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                         result == SRV_SMS_CAUSE_NO_ERROR) ||
                                        (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                         result == MMA_RESULT_OK))
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                        {
                                            /* save msg from SMS to SMS. Delete original one and then save new one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                srv_uc_addr_struct *addr = NULL;

                                                addr = srv_uc_get_addr(
                                                        g_uc_p->main.instance,
                                                        g_uc_p->srv_send_info->curr_send_number);
                                                mmi_uc_save_sms_after_send(SRV_SMS_STATUS_UNSENT, addr->addr);
                                                return;
                                            }
                                            /* save msg from MMS to SMS. Save new one and then delete original one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                /* Do nothing. */
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }

                                        /* send > save, use same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_SUCCESS)), MMI_EVENT_PROPLEM, NULL);
                                    }
                                    else
                                    {
                                        /* send > save, use same tone for all send fail reasons */
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_SAVE_FAIL)), MMI_EVENT_PROPLEM, NULL);
                                    }
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                        mmi_uc_delete_between_screens(
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            SCR_ID_UC_EDITOR,
                                    #else
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            SCR_ID_UC_PROCESSING);
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_delete_sms_frm_screen();
                                    mmi_uc_reset_msg();
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                ASSERT(0);
                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                if (g_uc_p->send_info.send_result == MMA_RESULT_OK)
                                {
                                    mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_SENT);
                                }
                                else if (g_uc_p->send_info.send_result == MMA_RESULT_FAIL_USER_CANCEL)
                                {
                                    if (g_uc_p->send_info.abort == MMI_UC_ABORT_NORMAL)
                                    {
                                        MMI_ASSERT(result == MMA_RESULT_OK);

                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);

                                    #ifdef __MMI_MMS_POSTCARD__
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                    #endif 
                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                            g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                        {
                                            U16 next_scrn_id = 0;

                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, 
                                                                                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                                                                SCR_ID_UC_EDITOR,
                                                                                        #else
                                                                                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                                                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                                                        MMI_FRM_NODE_AFTER_FLAG); 
                                            mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                        }
                                        else
                                        {
                                            U16 next_scrn_id = 0;

                                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                            mmi_uc_delete_between_screens(next_scrn_id, SCR_ID_UC_PROCESSING);
                                        }
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else if (g_uc_p->send_info.abort == MMI_UC_ABORT_BY_END_KEY)
                                    {
                                        if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                             result == SRV_SMS_CAUSE_NO_ERROR) ||
                                            (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                             result == MMA_RESULT_OK))
                                        {
                                            if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                            {
                                                /* save msg from SMS to MMS. Save new one and then delete original one. */
                                                if (g_uc_p->srv_send_info->existed_msg_type ==
                                                    MMI_UC_MSG_TYPE_SMS_PREFER)
                                                {
                                                    /* Do nothing. */
                                                }
                                                /* save msg from MMS to MMS. Delete original one and then save new one. */
                                                else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                         MMI_UC_MSG_TYPE_MMS_PREFER)
                                                {
                                                    mmi_uc_save_mms_req(
                                                        g_uc_p->srv_send_info->new_msg_id,
                                                        MMA_FOLDER_OUTBOX);
                                                    return;
                                                }
                                                else
                                                {
                                                    MMI_ASSERT(0);
                                                }
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }

                                        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                        {
                                            mmi_frm_scrn_close_active_id();
                                        }
                                        else
                                        {
                                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                        }
                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else    /* send fail */
                                {
                                    if ((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
                                         result == SRV_SMS_CAUSE_NO_ERROR) ||
                                        (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                                         result == MMA_RESULT_OK))
                                    {
                                        if (msg_box == SRV_UM_MSG_BOX_UNSENT || msg_box == SRV_UM_MSG_BOX_DRAFT)
                                        {
                                            /* save msg from SMS to MMS. Save new one and then delete original one. */
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                                /* Do nothing. */
                                            }
                                            /* save msg from MMS to MMS. Delete original one and then save new one. */
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                mmi_uc_save_mms_req(
                                                    g_uc_p->srv_send_info->new_msg_id,
                                                    MMA_FOLDER_OUTBOX);
                                                return;
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        else
                                        {
                                            MMI_ASSERT(0);
                                        }

                                    }
                                    mmi_uc_display_mma_send_result_popup((mma_result_enum)g_uc_p->send_info.send_result, MMI_TRUE);
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                    {
                                        mmi_uc_delete_between_screens(
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            SCR_ID_UC_EDITOR,
                                    #else
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            SCR_ID_UC_PROCESSING);
                                    }
                                    else
                                    {
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                    }
                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send , write new */
                        default:
                        {
                            MMI_ASSERT(0);
                        }
                            break;
                    }
                }
                    break;

                default:
                {
                    MMI_ASSERT(0);
                }
                    break;

            }
        }
            break;

        case SRV_UC_ACTION_SAVE:
        {
            srv_um_msg_box_enum msg_box = (srv_um_msg_box_enum) g_uc_p->send_info.curr_folder;

            /* save */
            switch (g_uc_p->srv_main->state)
            {
                    /* save, write new */
                case MMI_UC_STATE_WRITE_NEW_MSG:
                case MMI_UC_STATE_REPLY:
                case MMI_UC_STATE_REPLY_ALL:
                {
                    /* save, write new */
                    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                    {
                    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                        /* save, write new, sms */
                        if (action == SRV_UC_ACTION_SAVE)
                        {
                            if (result == SRV_SMS_CAUSE_NO_ERROR)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);
                            }
                            else if (result == SRV_SMS_CAUSE_MEM_FULL)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_MEMORY_FULL)), MMI_EVENT_PROPLEM, NULL);
                            }
                            else if (result == SRV_SMS_CAUSE_MEM_INSUFFICIENT)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_PROPLEM, NULL);
                            }
                            else
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_FAILED_TO_SAVE)), MMI_EVENT_PROPLEM, NULL);
                            }
                        #ifdef __MMI_MMS_POSTCARD__
                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                        #endif 
                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);

                            mmi_uc_reset_msg();
                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                            mmi_uc_delete_sms_frm_screen();
                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                        }
                        else
                        {
                            MMI_ASSERT(0);
                        }
                    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                        ASSERT(0);
                    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                    }
                    /* save, write new */
                    else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                    {
                        /* save, write new, mms */
                        if (action == SRV_UC_ACTION_SAVE)
                        {
                            if (result == MMA_RESULT_OK)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);
                            }
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__
                            else if (result == MMA_RESULT_FAIL_USERDEF_TEMPLATE_FULL)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_MAX_TEMPLATE_ALREADY_PRESENT_ID)), MMI_EVENT_PROPLEM, NULL);
                            }
#endif /* __MMI_MMS_TEMPLATE_SUPPORT__ */
                            else
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_PROPLEM, NULL);
                            }

                            /* 
                             *  if result is equal to TEMPLATE FULL, return to the 
                             *  edit mode and not reset the uc_msg. Otherwise,
                             *  reset the msg and enable alram
                             */
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__
                            if (result == MMA_RESULT_FAIL_USERDEF_TEMPLATE_FULL)
                            {
                                g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

                                if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))//IsScreenPresent(SCR_ID_UC_EDITOR))
                                {
                                    U16 top_scrn_id = 0, next_scrn_id = 0;

                                    top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                                    next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                    mmi_uc_delete_between_screens(next_scrn_id, top_scrn_id);
                                }
                                else
                                {
                                    MMI_ASSERT(0);
                                }

                                /* remove the mms tmp file */
                                if (g_uc_p->srv_send_info->new_msg_id)
                                {
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                }
                                else
                                {
                                    MMI_ASSERT(0);
                                }
                            }
                            /* 
                             *  result will only be equal to MMA_RESULT_OK because
                             *  if result is equal to storage full, the create action
                             *  won't succeed and it can't go into this state.
                             */
                            else
#endif /* __MMI_MMS_TEMPLATE_SUPPORT__ */
                            {
                            #ifdef __MMI_MMS_POSTCARD__
                                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                            #endif 
                                mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                mmi_uc_reset_msg();
                                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                            }

                        }
                        else
                        {
                            MMI_ASSERT(0);
                        }

                    }
                    else
                    {
                        MMI_ASSERT(0);
                    }
                }
                    break;

                    /* save, edit existed */
                case MMI_UC_STATE_EDIT_EXISTED_MSG:
                {
                    /* save, edit */
                    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                    {
                    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                        /* save, edit, sms */
                        if (action == SRV_UC_ACTION_SAVE)
                        {
                            if (result == SRV_SMS_CAUSE_NO_ERROR)
                            {
                                if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                    (msg_box == SRV_UM_MSG_BOX_UNSENT && g_uc_p->srv_msg->to_num > 0))
                                {
                                    /* save msg from SMS to SMS. Delete original one and then save new one. */
                                    if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);
                                    }
                                    /* save msg from MMS to SMS. Save new one and then delete original one. */
                                    else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                                    {
                                        mmi_uc_delete_existed_mms();
                                        return;
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);

                                }
                            }
                            else if (result == SRV_SMS_CAUSE_MEM_FULL)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_MEMORY_FULL)), MMI_EVENT_PROPLEM, NULL);
                            }
                            else if (result == SRV_SMS_CAUSE_MEM_INSUFFICIENT)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_PROPLEM, NULL);
                            }
                            else
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_FAILED_TO_SAVE)), MMI_EVENT_FAILURE, NULL);
                            }
                        #ifdef __MMI_MMS_POSTCARD__
                            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                        #endif 
                            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);

                            mmi_uc_reset_msg();
                            mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                            mmi_uc_delete_sms_frm_screen();
                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                        }
                        else if (action == SRV_UC_ACTION_DELETE)
                        {
                            if (msg_box == SRV_UM_MSG_BOX_DRAFT ||
                                (msg_box == SRV_UM_MSG_BOX_UNSENT && g_uc_p->srv_msg->to_num > 0))
                            {
                                /* save msg from SMS to SMS. Delete original one and then save new one. */
                                if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                {
                                    /* In SMS, delete orig one and then save new one, here, save new one if delete successfully */
                                    if (result == SRV_SMS_CAUSE_NO_ERROR)
                                    {
                                        mmi_uc_save_sms_req();
                                    }
                                    else
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);

                                    #ifdef __MMI_MMS_POSTCARD__
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                    #endif 
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);

                                        mmi_uc_reset_msg();
                                        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                        mmi_uc_delete_sms_frm_screen();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                }
                                /* save msg from MMS to SMS. Save new one and then delete original one. */
                                else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                                {
                                    /* Deletion may fail in USB normal mode. */

                                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);

                                    mmi_uc_reset_msg();
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);
                                    mmi_uc_delete_sms_frm_screen();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                }
                                else
                                {
                                    MMI_ASSERT(0);
                                }
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                        else
                        {
                            MMI_ASSERT(0);
                        }
                    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                        ASSERT(0);
                    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                    }
                    /* save, edit */
                    else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                    {
                        /* save, edit, mms */
                        if (action == SRV_UC_ACTION_SAVE)
                        {
                            if (result == MMA_RESULT_OK)
                            {
                                if (msg_box == SRV_UM_MSG_BOX_DRAFT)
                                {
                                    /* save msg from SMS to MMS. Save new one and then delete original one. */
                                    if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                    {
                                    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                        srv_sms_delete_msg(
                                            (U16) g_uc_p->srv_send_info->existed_msg_id,
                                            mmi_uc_delete_sms_callback, 
                                            NULL);
                                        return;
                                    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                        MMI_ASSERT(0);
                                    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                    }
                                    /* save msg from MMS to MMS. Delete original one and then save new one. */
                                    else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);
                                    }
                                    else
                                    {
                                        MMI_ASSERT(0);
                                    }
                                }
                                else
                                {
                                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);
                                }
                            }
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__
                            else if (result == MMA_RESULT_FAIL_USERDEF_TEMPLATE_FULL)
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_MAX_TEMPLATE_ALREADY_PRESENT_ID)), MMI_EVENT_FAILURE, NULL);
                            }
#endif /* __MMI_MMS_TEMPLATE_SUPPORT__ */
                            else
                            {
                                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
                            }
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__
                            /* 
                             *  if result is equal to TEMPLATE FULL, return to the 
                             *  edit mode and not reset the uc_msg. Otherwise,
                             *  reset the msg and enable alram
                             */
                            if (result == MMA_RESULT_FAIL_USERDEF_TEMPLATE_FULL)
                            {
                                g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

                                if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                                {
                                    U16 top_scrn_id = 0, next_scrn_id = 0;

                                    top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                                    next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                                    mmi_uc_delete_between_screens(next_scrn_id, top_scrn_id);
                                }
                                else
                                {
                                    MMI_ASSERT(0);
                                }

                                /* remove the mms tmp file */
                                if (g_uc_p->srv_send_info->new_msg_id)
                                {
                                    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
                                }
                                else
                                {
                                    MMI_ASSERT(0);
                                }
                            }
                            /* 
                             *  result will only be equal to MMA_RESULT_OK because
                             *  if result is equal to storage full, the create action
                             *  won't succeed and it can't go into this state.
                             */
                            else
#endif /* __MMI_MMS_TEMPLATE_SUPPORT__ */
                            {
                            #ifdef __MMI_MMS_POSTCARD__
                                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                            #endif 
                                mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                mmi_uc_reset_msg();
                                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                            }
                        }
                        else if (action == SRV_UC_ACTION_DELETE)
                        {
                            if (msg_box == SRV_UM_MSG_BOX_DRAFT)
                            {
                                /* save msg from SMS to MMS. save new one and then delete original one . */
                                if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                {
                                #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                    MMI_ASSERT(result == SRV_SMS_CAUSE_NO_ERROR);
									if(!(result == SRV_SMS_CAUSE_NO_ERROR))
									{
									MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
									}
                                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                    mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);

                                    mmi_uc_reset_msg();
                                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                    ASSERT(0);
                                #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                }
                                /* save msg from MMS to MMS. delete original one and then Save new one. */
                                else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                                {
                                    if (result == MMA_RESULT_OK)
                                    {
                                        g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
                                        mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_DRAFT);
                                    }
                                    else
                                    {
                                        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
                                    #ifdef __MMI_MMS_POSTCARD__
                                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                    #endif 
                                        mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);

                                        mmi_uc_reset_msg();
                                        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                                    }
                                }
                                else
                                {
                                    MMI_ASSERT(0);
                                }
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                        else
                        {
                            MMI_ASSERT(0);
                        }
                    }
                    else
                    {
                        MMI_ASSERT(0);
                    }
                }
                    break;

                default:
                {
                    MMI_ASSERT(0);
                }
                    break;

            }
        }
            break;  /* save */

        case SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW:
        {
            /* save in background when battery low, but not exit uc editor screen */
            switch (g_uc_p->srv_main->state)
            {
                    /* save in background, write new */
                case MMI_UC_STATE_WRITE_NEW_MSG:
                case MMI_UC_STATE_REPLY:
                case MMI_UC_STATE_REPLY_ALL:
                case MMI_UC_STATE_EDIT_EXISTED_MSG:
                {
                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                }
                    break;

                default:
                {
                    MMI_ASSERT(0);
                }
                    break;
            }

        }
            break;  /* SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW */

        case SRV_UC_ACTION_SAVE_IN_BACKGROUND:
        {
            /* save in background */
            switch (g_uc_p->srv_main->state)
            {
                    /* save in background, write new */
                case MMI_UC_STATE_WRITE_NEW_MSG:
                case MMI_UC_STATE_REPLY:
                case MMI_UC_STATE_REPLY_ALL:
                case MMI_UC_STATE_EDIT_EXISTED_MSG:
                {
                    /* save in background, write new */
                    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                    {
                    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                        /* save, write new, sms */
                        if (action == SRV_UC_ACTION_SAVE)
                        {
                            mmi_uc_reset_msg();

                            /* The ems buffer would be reset in SMS framework. */
                            /* mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER); */
                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                        }
                        else
                        {
                            MMI_ASSERT(0);
                        }
                    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                        ASSERT(0);
                    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                    }
                    /* save in background, write new */
                    else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                    {
                        /* save in background, write new, mms */
                        if (action == SRV_UC_ACTION_SAVE)
                        {
                            mmi_uc_reset_msg();
                            srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                        }
                        else
                        {
                            MMI_ASSERT(0);
                        }
                    }
                    else
                    {
                        MMI_ASSERT(0);
                    }
                }
                    break;

                default:
                {
                    MMI_ASSERT(0);
                }
                    break;

            }
        }
            break;  /* save in background */

    #if (defined(__MMI_MMS_2__) || defined(__MMI_MMS_BGSR_SUPPORT__))

        case SRV_UC_ACTION_SEND_IN_BACKGROUND:
        {
            switch (g_uc_p->srv_main->state)
            {
                case MMI_UC_STATE_WRITE_NEW_MSG:
                case MMI_UC_STATE_FORWARD:
                case MMI_UC_STATE_REPLY:
                case MMI_UC_STATE_REPLY_ALL:
                {
                    switch (action)
                    {
                            /* send in background , write new */
                        case SRV_UC_ACTION_SEND:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                                MMI_ASSERT(0);
                            }
                            /* send in background , write new mms */
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                /* no matter send ok or fail, should notify anyway. */
                                /* background send. postcard cases also run this path for sending to one recipient */
                                /* If postcard mode-- ???? wait for postcard feature is done */
                            #ifdef __MMI_MMS_POSTCARD__
                                if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
                                {
                                    srv_postcard_clear_all_context(g_uc_p->main.instance);
                                }
                            #endif /* __MMI_MMS_POSTCARD__ */ 

                            #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                            #ifdef __MMI_MMS_POSTCARD__
                                if (g_uc_p->srv_msg_type->MMS_edit_mode != MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
                            #endif 
                                {
                                    mmi_uc_phb_save_contact_notify_check(
                                        SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                        result,
                                        SCR_ID_UC_PROCESSING);
                                }
                            #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD)
                                {
                                    mmi_uc_delete_between_screens(
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            SCR_ID_UC_EDITOR,
                                    #else
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            SCR_ID_UC_PROCESSING);
                                }
                                else
                                {
                                    mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                }

                                if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                {
                                    mmi_frm_scrn_close_active_id();
                                }
                                else
                                {
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                #ifdef __MMI_MMS_POSTCARD__
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_WRITE_MSG_SELECTION);
                                #endif 
                                }
                                mmi_uc_reset_msg();
								srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send in background, write new */
                        case SRV_UC_ACTION_SAVE:
                        {
                            MMI_ASSERT(0);
                        }
                            break;

                            /* send in background, write new */
                        case SRV_UC_ACTION_DELETE:
                        {
                            MMI_ASSERT(0);
                        }
                            break;

                            /* send in background, write new */
                        default:
                        {
                            MMI_ASSERT(0);
                        }
                            break;
                    }
                }
                    break;  /* send in background, write new  */

                    /* send in background, edit */
                case MMI_UC_STATE_EDIT_EXISTED_MSG:
                case MMI_UC_STATE_SEND:
                {
                    srv_um_msg_box_enum msg_box = (srv_um_msg_box_enum) g_uc_p->send_info.curr_folder;

                    MMI_ASSERT(msg_box);
					if(!(msg_box))
					{
					MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
					}

                    switch (action)
                    {
                            /* send in background, edit */
                        case SRV_UC_ACTION_SEND:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                                MMI_ASSERT(0);
                            }
                            /* send in background, edit */
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                                if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
                                {
                                    mmi_uc_delete_between_screens(
                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                            SCR_ID_UC_EDITOR,
                                    #else
                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            SCR_ID_UC_PROCESSING);
                                }
                                else
                                {
                                    mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_PROCESSING);
                                }
                                switch (result)
                                {
                                    case MMA_RESULT_OK:
                                    {
                                        if (
                                    #ifndef __MMI_MMS_BGSR_SUPPORT__
                                               msg_box == SRV_UM_MSG_BOX_UNSENT ||
                                    #endif 
                                               msg_box == SRV_UM_MSG_BOX_DRAFT)
                                        {
                                            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                                            {
                                            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                                                /* when sms deleting, use this screen to block mmi, to aviod display list, 
                                                   UM will get wrong info from sms */

                                                if ((mmi_frm_scrn_get_active_id() > SCR_ID_UC_START) &&
                                                      (mmi_frm_scrn_get_active_id() < SCR_ID_UC_END))
                                                {
                                                    mmi_uc_set_processing_screen(
                                                        0,
                                                        STR_GLOBAL_DELETING,
                                                        mmi_get_event_based_image (MMI_EVENT_PROGRESS),
                                                        0);

                                                    mmi_uc_entry_processing_generic();
                                                }
                                                else
                                                {
                                                    mmi_uc_add_processing_to_history();
                                                }
                                                srv_sms_delete_msg(
                                                    (U16) g_uc_p->srv_send_info->existed_msg_id,
                                                    mmi_uc_delete_sms_callback, 
                                                    NULL);
                                            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                                                MMI_ASSERT(0);
                                            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 

                                            }
                                            else if (g_uc_p->srv_send_info->existed_msg_type ==
                                                     MMI_UC_MSG_TYPE_MMS_PREFER)
                                            {
                                                /* Will be trigger after mmi_uc_delete_existed_mms */
                                                mmi_uc_delete_existed_mms();
                                            }
                                            else
                                            {
                                                MMI_ASSERT(0);
                                            }
                                        }
                                        else
                                        {
                                        #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                            mmi_uc_phb_save_contact_notify_check(
                                                SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                                result,
                                                SCR_ID_UC_PROCESSING);
                                        #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                            
                                            if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                            {
                                                mmi_frm_scrn_close_active_id();
                                            }
                                            else
                                            {
                                                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                            }
                                            mmi_uc_reset_msg();
                                        }
                                        if (g_uc_p->srv_main->state == MMI_UC_STATE_EDIT_EXISTED_MSG)
                                        {
                                        #ifdef __MMI_MMS_POSTCARD__
                                            if (g_uc_p->srv_msg_type->MMS_edit_mode ==
                                                MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
                                            {
                                                srv_postcard_clear_all_context(g_uc_p->main.instance);
                                            }
                                        #endif /* __MMI_MMS_POSTCARD__ */ 

                                        }
                                    }
                                        break;

                                    default:
                                    {
                                        MMI_ASSERT(0);
                                    }
                                        break;

                                }

                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send in background , edit */
                        case SRV_UC_ACTION_SAVE:
                        {
                            MMI_ASSERT(0);
                        }
                            break;

                            /* send in background , edit */
                        case SRV_UC_ACTION_DELETE:
                        {
                            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
                            {
                                MMI_ASSERT(0);
                            }
                            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
                            {
                            #ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__
                                mmi_uc_phb_save_contact_notify_check(
                                    SRV_UC_PHB_LIST_TYPE_NORMAL_MMS,
                                    result,
                                    SCR_ID_UC_PROCESSING);
                            #endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 
                                
                                if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
                                {
                                    mmi_frm_scrn_close_active_id();
                                }
                                else
                                {
                                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                                }
                                mmi_uc_reset_msg();
                            }
                            else
                            {
                                MMI_ASSERT(0);
                            }
                        }
                            break;

                            /* send , write new */
                        default:
                        {
                            MMI_ASSERT(0);
                        }
                            break;
                    }
                }
                    break;  /* send , edit existed  */

                default:
                {
                    MMI_ASSERT(0);
                }
                    break;
            }
        }
            break;
    #endif /* (defined(__MMI_MMS_2__) || defined(__MMI_MMS_BGSR_SUPPORT__)) */ 

        case SRV_UC_ACTION_DELETE_IN_BACKGROUND:
        {
            /* delete in background */
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

            if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
            {
                mmi_frm_scrn_close_active_id();
            }
            else
            {
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            }
        }
            break;  /* delete in background */

        case SRV_UC_ACTION_IDLE:
        {

            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ACTION_FSM_DO_NOTHING);
        }
            break;

        default:
        {
            MMI_ASSERT(0);
        }
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_number_of_options_omitted
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  
 *****************************************************************************/
U32 mmi_uc_get_number_of_options_omitted(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
    #ifdef __MMI_PHB_INFO_FIELD__
        return 0;
    #else 
        return 1;
    #endif 
    }
    else
#endif /* __MMI_MMS_POSTCARD__ */ 
    {
        return 0;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_highlighted_addr
 * DESCRIPTION
 *  get current highlighted address
 * PARAMETERS
 *  void
 * RETURNS
 *  current highlighted address
 *****************************************************************************/
srv_uc_addr_struct *mmi_uc_get_highlighted_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_uc_addr_struct *addr = NULL;
    //U32 addr_num = 0;
    U32 i = 0;
    U32 item_index = g_uc_p->done.current_addr_index
        - (MMI_UC_ADD_RECIPIENT_TOTAL - mmi_uc_get_number_of_options_omitted());

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (item_index < g_uc_p->srv_msg->to_num)
    {
        addr = g_uc_p->srv_msg->to_head;
    }
    else
    {
        ASSERT(0);
    }

    for (; i < item_index; addr = addr->next)
    {
        i++;
        MMI_ASSERT(addr->next);
    }

    return addr;
}

#ifdef __MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_msg_size_limitation_popup
 * DESCRIPTION
 *  Display result popup
 * PARAMETERS
 *  max_size        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_msg_size_limitation_popup(kal_uint32 max_size)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    const S8 *pstr1, *pstr2;
    int msg_size;
    S8 *message = NULL;
    U8 temp_string[12];
    U8 temp_ucs2_string[12 * ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(temp_string, 0, 12);
    memset(temp_ucs2_string, 0, 12 * ENCODING_LENGTH);

    pstr1 = GetString(STR_UC_CONN_TYPE_MAX_SIZE_REACHED_ID);
    pstr2 = GetString(STR_UC_KB_ID);
    sprintf((char*)temp_string, "%d ", max_size);
    mmi_asc_n_to_ucs2((S8*) temp_ucs2_string, (S8*) temp_string, 10);

    msg_size =
        (mmi_ucs2strlen((PS8) pstr1) + mmi_ucs2strlen((PS8) pstr2) + mmi_ucs2strlen((PS8) temp_ucs2_string) +
         1 /* null terminate */ ) * ENCODING_LENGTH;
    message = (S8*) OslMalloc(msg_size);
    if (NULL == message)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
        return;
    }

    mmi_ucs2cpy(message, (S8*) temp_ucs2_string);

    mmi_ucs2cat(message, pstr2);
    mmi_ucs2cat(message, pstr1);

    mmi_popup_display((WCHAR*)((UI_string_type) message), MMI_EVENT_ERROR, NULL);
    OslMfree(message);
    return;
}
#endif /* __MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__ */ /* __MMI_MMS_CALC_MSG_SIZE_BY_USER_ELEMENTS__ */


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_popup
 * DESCRIPTION
 *  Display result popup
 * PARAMETERS
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_popup(srv_uc_result result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    int msg_size;
    PU8 str_msg_size_exceed, str_kb;
    PU8 msg_with_max_size;
    U32 len_max_size = 10;
    U8 str_max_size[15], str_max_size_ucs[15 * ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (result)
    {
        case SRV_UC_OK:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_OK)), MMI_EVENT_SUCCESS, NULL);
        }
            break;

    #ifdef __MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__
        case SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED:
        {
            /* MMA_MAX_WAP_CONN_MSG_SIZE -- Conn. type WAP is used. Max msg size is 100KB */
            mmi_uc_display_msg_size_limitation_popup(MMA_MAX_WAP_CONN_MSG_SIZE / 1024);
        }
            break;
    #endif /* __MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__ */ 

        case SRV_UC_SIZE_EXCEEDS:
        {
            /* 
             *  In order to show the maximum size of each message
             *  concate the STR_UC_MSG_SIZE_EXCEED_ID and the size
             *  in the same string and popup to let user know
             */
            /* initialize the local variables */
            str_msg_size_exceed = NULL;
            str_kb = NULL;
            msg_with_max_size = NULL;
            memset(str_max_size, 0, 15);
            memset(str_max_size_ucs, 0, 15 * ENCODING_LENGTH);

            /* copy the size to the string */
            /***********************************************************************
             * check the size if overflow :
             * g_uc_p->srv_mms_info->max_mms_size should be small than (10^len_max_size)
             * 10^len_max_size -> 2^(3*len_max_size)
             * 2^(3*len_max_size) > g_uc_p->srv_mms_info->max_mms_size/1024
             * the first -1 indicates the '\n', the second -1 indicates the '\0'
            ***********************************************************************/
            MMI_ASSERT((U32) (1 << (3 * (len_max_size - 1 - 1))) > (U32) (g_uc_p->srv_mms_info->max_mms_size / 1024));
			if(!((U32) (1 << (3 * (len_max_size - 1 - 1))) > (U32) (g_uc_p->srv_mms_info->max_mms_size / 1024)))
			{
			MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
			}

            sprintf((char*)str_max_size, " %d ", g_uc_p->srv_mms_info->max_mms_size / 1024);
            mmi_asc_n_to_ucs2((S8*) str_max_size_ucs, (S8*) str_max_size, len_max_size);

            str_msg_size_exceed = (PU8) GetString(STR_UC_MSG_SIZE_EXCEED_ID);
            str_kb = (PU8) GetString(STR_UC_KB_ID);

            msg_size = ((mmi_ucs2strlen((S8*) str_msg_size_exceed) +
                         mmi_ucs2strlen((S8*) str_max_size_ucs) +
                         mmi_ucs2strlen((S8*) str_kb)) + 1) * ENCODING_LENGTH;

            msg_with_max_size = (PU8) OslMalloc(msg_size);

            /* copy to the output string */
            mmi_ucs2cpy((S8*) msg_with_max_size, (S8*) str_msg_size_exceed);
            mmi_ucs2cat((S8*) msg_with_max_size, (S8*) str_max_size_ucs);
            mmi_ucs2cat((S8*) msg_with_max_size, (S8*) str_kb);

            mmi_popup_display((WCHAR*)((UI_string_type) msg_with_max_size), MMI_EVENT_ERROR, NULL);

            OslMfree(msg_with_max_size);
            msg_with_max_size = NULL;
        }
            break;

        case SRV_UC_CREATION_MODE_SIZE_EXCEEDS:
        {
	        mmi_popup_property_struct arg;
	        mmi_popup_property_init(&arg);
	        arg.f_msg_icon = MMI_FALSE;
	        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RESTRICTED_MODE_MSG_SIZE_EXCEED_ID)), MMI_EVENT_ERROR, &arg);
        }
            break;

        case SRV_UC_SIZE_NOT_ENOUGH_FOR_REC_VIDEO:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SIZE_NOT_ENOUGH_FOR_REC_VIDEO_ID)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_PROHIBIT_BY_CREATION_MODE:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_PROHIBIT_BY_CREATION_MODE_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;

        case SRV_UC_PROHIBIT_BY_DRM:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_DRM_PROHIBITED)), MMI_EVENT_ERROR, NULL);
        }
            break;

            /* Because editor already play the error tone, therefore for no space case, app(UC) should not play tone again, fill tone ID =0 */
        case SRV_UC_NO_SPACE:
        {
	       mmi_popup_property_struct arg;
	       mmi_popup_property_init(&arg);
	       arg.f_play_tone = MMI_FALSE;
	       mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NO_SPACE_ID)), MMI_EVENT_ERROR, &arg);
        }
            break;
            /* This is called when UC itself calculates that the space is not enough, so editor doesn't play any tone */
        case SRV_UC_NO_SPACE_TONE:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NO_SPACE_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;

        case SRV_UC_STORAGE_FULL:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_INSUFFICIENT_MEMORY:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INSUFFICIENT_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_XML_ERROR:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_CONTENT_ERROR_ID)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_ERROR:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_NOT_SUPPORT:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_SUPPORTED)), MMI_EVENT_FAILURE, NULL);
        }
            break;
        case SRV_UC_FILE_CORRUPT:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_FAILED_TO_ADD_MEDIA_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;

        case SRV_UC_FILE_EMPTY:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_FILE_EMPTY_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;
        case SRV_UC_FILE_NOT_FOUND:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_FILE_NOT_FOUND)), MMI_EVENT_ERROR, NULL);
        }
            break;
        case SRV_UC_FOLDER_NOT_FOUND:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(srv_fmgr_fs_error_get_string(FS_PATH_NOT_FOUND))), MMI_EVENT_ERROR, NULL);
        }
            break;
        case SRV_UC_FAIL_IN_VIDEO_CALL:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL)), MMI_EVENT_ERROR, NULL);
        }
            break;
        case SRV_UC_FAIL_IMAGE_TOO_LARGE:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_IMAGE_TOO_LARGE)), MMI_EVENT_ERROR, NULL);
        }
            break;

        default:
        {
            MMI_ASSERT(0);
        }
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_working_space_popup
 * DESCRIPTION
 *  Display popup -- working space needed for different mms solution
 * PARAMETERS
 *  min_fs_space_required       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_working_space_popup(kal_uint32 min_fs_space_required)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    const S8 *pstr1, *pstr2;
    int msg_size;
    S8 *message = NULL;
    U8 temp_string[12];
    U8 temp_ucs2_string[12 * ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(temp_string, 0, 12);
    memset(temp_ucs2_string, 0, 12 * ENCODING_LENGTH);

    pstr1 = GetString(STR_UC_NO_ENOUGH_WORKING_SPACE_ID);
    pstr2 = GetString(STR_UC_KB_ID);
    sprintf((char*)temp_string, "%d ", min_fs_space_required);
    mmi_asc_n_to_ucs2((S8*) temp_ucs2_string, (S8*) temp_string, 10);

    msg_size =
        (mmi_ucs2strlen((PS8) pstr1) + mmi_ucs2strlen((PS8) pstr2) + mmi_ucs2strlen((PS8) temp_ucs2_string) +
         1 /* null terminate */ ) * ENCODING_LENGTH;
    message = (S8*) OslMalloc(msg_size);
    if (NULL == message)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
        return;
    }

    mmi_ucs2cpy(message, pstr1);

    mmi_ucs2cat(message, (S8*) temp_ucs2_string);

    mmi_ucs2cat(message, pstr2);

    mmi_popup_display((WCHAR*)((UI_string_type) message), MMI_EVENT_ERROR, NULL);

    OslMfree(message);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_mma_result_popup
 * DESCRIPTION
 *  Display result popup
 * PARAMETERS
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_mma_result_popup(mma_result_enum result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (result)
    {
        case MMA_RESULT_OK:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_OK)), MMI_EVENT_SUCCESS, NULL);
        }
            break;

        case MMA_RESULT_FAIL_UNSUPPORT_CONTENT:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_UNSUPPORT_CONTENT_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;

        case MMA_RESULT_FAIL_CREATION_MODE_MAX_MSG_SIZE_REACHED:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_CREATION_MODE_MAX_MSG_SIZE_REACHED_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;

        case MMA_RESULT_FAIL_MAX_SLIDE_NUM_REACHED:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_MAX_SLIDE_NUM_REACHED_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__
        case MMA_RESULT_FAIL_USERDEF_TEMPLATE_FULL:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_MAX_TEMPLATE_ALREADY_PRESENT_ID)), MMI_EVENT_ERROR, NULL);
        }
            break;
#endif /* __MMI_MMS_TEMPLATE_SUPPORT__ */
        case MMA_RESULT_FAIL_MAX_MSG_NUM_REACHED:
        {
	        mmi_popup_property_struct arg;
	        mmi_popup_property_init(&arg);
	        arg.f_msg_icon = MMI_FALSE;
	        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_TOO_MANY_MSG_ID)), MMI_EVENT_ERROR, &arg);
        }
            break;

        case MMA_RESULT_FAIL_INSUFFICIENT_STORAGE:
        {
            if (g_uc_p->srv_send_info->action != SRV_UC_ACTION_SEND_IN_BACKGROUND)
            {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
            else
            {
                 const S8 *pstr1, *pstr2;
                 int msg_size;
                 S8 *message = NULL;
                 U8 temp_string[3];
                 U8 temp_ucs2_string[3 * ENCODING_LENGTH];

                 memset(temp_string, 0, 3);
                 memset(temp_ucs2_string, 0, 3 * ENCODING_LENGTH);
                 pstr1 = GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY);
                 pstr2 = GetString(STR_UC_SEND_FAIL_NO_BOX_ID_LOWER);

                 sprintf((char*)temp_string, "%c ", ',');
                 mmi_asc_n_to_ucs2((S8*) temp_ucs2_string, (S8*) temp_string, 2);

                 msg_size =
                 (mmi_ucs2strlen((PS8) pstr1) + mmi_ucs2strlen((PS8) pstr2) + mmi_ucs2strlen((PS8) temp_ucs2_string) +
                 1 /* null terminate */ ) * ENCODING_LENGTH;
                 message = (S8*) OslMalloc(msg_size);
                 if (NULL == message)
                 {
                      mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
                      return;
                 }

                 mmi_ucs2cpy(message, pstr1);

                 mmi_ucs2cat(message, (S8*) temp_ucs2_string);

                 mmi_ucs2cat(message, pstr2);

                 mmi_popup_display((WCHAR*)((UI_string_type) message), MMI_EVENT_ERROR, NULL);

                 OslMfree(message);
            }
        }
            break;
        case MMA_RESULT_FAIL_INSUFFICIENT_MEMORY:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INSUFFICIENT_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case MMA_RESULT_FAIL_FILE_IO:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_STORAGE_FILE_IO_ERROR_ID)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case MMA_RESULT_FAIL_NOT_READY:
        case MMA_RESULT_FAIL_BUSY:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);
        }
            break;
#ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__
        case MMA_RESULT_FAIL_MEM_CARD_NOT_PRESENT_INSERT_CARD:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_INSERT_CARD)), MMI_EVENT_FAILURE, NULL);
        }
            break;
#endif
        case MMA_RESULT_FAIL_ROOT_DIR_FULL:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(srv_fmgr_fs_error_get_string(FS_ROOT_DIR_FULL))), MMI_EVENT_FAILURE, NULL);
        }
            break;

        default:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
        }
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_mma_send_result_popup
 * DESCRIPTION
 *  Display result popup
 * PARAMETERS
 *  result          [IN]        
 *  displayBox      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_mma_send_result_popup(mma_result_enum result, U8 displayBox)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DISP_MMA_SEND_RESULT_POPUP_P1, result);

    if (g_uc_p->send_info.fail_cause != NULL && mmi_ucs2strlen((S8*) g_uc_p->send_info.fail_cause))
    {

        const S8 *pstr1;
        int msg_size;
        S8 *message = NULL;

        pstr1 = GetString(STR_UC_SERVER_ID);
        msg_size = (mmi_ucs2strlen(pstr1) + mmi_ucs2strlen((S8*) g_uc_p->send_info.fail_cause) + 1) * ENCODING_LENGTH; /* +1 for null terminate */
        message = (S8*) OslMalloc(msg_size);
        if (NULL == message)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DISP_MMA_SEND_RESULT_POPUP_ERROR);
            return;
        }

        mmi_ucs2cpy(message, pstr1);
        mmi_ucs2cat(message, (S8*) g_uc_p->send_info.fail_cause);

        mmi_popup_display((WCHAR*)((UI_string_type) message), MMI_EVENT_PROPLEM, NULL);

        OslMfree(message);

        return;
    }

    switch (result)
    {
        case MMA_RESULT_OK:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SENT)), MMI_EVENT_MESSAGE_SENT, NULL);
        }
            break;

        case MMA_RESULT_FAIL_USER_CANCEL:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ABORTED_ID)), MMI_EVENT_SUCCESS, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_CONFIG_ERROR:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_CONFIG_ERROR_ID)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_CONNECT_ERROR:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_ID)), MMI_EVENT_PROPLEM, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_SERVER_TIMEOUT:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SERVER_TIMEOUT_ID)), MMI_EVENT_PROPLEM, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_SERVER_ERROR:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SERVER_ERROR_ID)), MMI_EVENT_PROPLEM, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_SERVICE_DENIED:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SERVICE_DENIED_ID)), MMI_EVENT_PROPLEM, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_UNSUPPORT_CONTENT:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_UNSUPPORT_CONTENT_BY_SERVER_ID)), MMI_EVENT_PROPLEM, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_UNKNOWN_APN:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_UNKNOWN_APN_ID)), MMI_EVENT_PROPLEM, NULL);
        }
            break;

        case MMA_RESULT_FAIL_COMM_UNAUTHORIZED:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_UNAUTHORIZED_ID)), MMI_EVENT_PROPLEM, NULL);
        }
            break;

        case MMA_RESULT_FAIL_NOT_READY:
        case MMA_RESULT_FAIL_BUSY:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        default:
        {
            if (!displayBox)
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_NO_BOX_ID)), MMI_EVENT_PROPLEM, NULL);
            }
            else
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SEND_FAIL_ID)), MMI_EVENT_PROPLEM, NULL);
            }
        }
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_resize_result_popup
 * DESCRIPTION
 *  Display result popup
 * PARAMETERS
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_resize_result_popup(S32 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (result)
    {
        case SRV_UC_RESIZING_SUCCEED:
        {
            MMI_ASSERT(0);
        }
            break;

        case SRV_UC_RESIZING_SUCCEED_WITH_UNCHANGED:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RESIZE_IMAGE_UNCHANGED_ID)), MMI_EVENT_INFO, NULL);
        }
            break;

        case SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_DISK_FULL:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_RESIZING_FAILED_IN_INSUFFICIENT_DRAWING_BUF:
        case SRV_UC_RESIZING_FAILED_IN_NO_QUOTA:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SYSTEM_RESOURCES_EXHAUSTED_ID)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_RESIZING_FAILED_IN_UNKNOWN_DIMENSION:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_FILE_CORRUPT_ID)), MMI_EVENT_FAILURE, NULL);
        }
            break;

        case SRV_UC_RESIZING_FAILED_IN_GDI_FAILED:
        case SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_WRITE_PROTECTION:
        case SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_NO_DISK:
        default:
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_FAIL_TO_RESIZE_IMAGE_ID)), MMI_EVENT_FAILURE, NULL);
        }
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_truncated_information_popup
 * DESCRIPTION
 *  Display result popup
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_truncated_information_popup(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_send_info->content_truncated_type & MMA_TRUNCATED_SLIDE ||
        g_uc_p->srv_send_info->content_truncated_type & MMA_TRUNCATED_ATTACHMENT ||
        g_uc_p->srv_send_info->content_truncated_type & MMA_TRUNCATE_TEXT)
    {	
    	if((g_uc_p->srv_send_info->content_truncated_type & MMA_TRUNCATED_ATTACHMENT) && g_uc_p->srv_msg->msg_body.total_attach_no == 0)
		{
			
		}
		else
		{
        	mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SOME_OBJECT_WITHDREW)), MMI_EVENT_INFO, NULL);
		}
        g_uc_p->srv_send_info->content_truncated_type = (srv_uc_msg_truncation_type_enum)0;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_check_if_scr_older
 * DESCRIPTION
 *  Check if the screen is older than the base screen in history
 * PARAMETERS
 *  check_scr       [IN]        Screen to be checked
 *  base_scr        [IN]        Base screen
 * RETURNS
 *  True means the check_scr is older than the base screen in history.
 *  False means the check_scr is newer, it is not in history, or base_scr is not in history
 *****************************************************************************/
MMI_BOOL mmi_uc_check_if_scr_older(U16 check_scr, U16 base_scr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //U16 cur_scr = base_scr;
    U16 pre_scr = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, check_scr, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        return MMI_FALSE;
    }

    if (!mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, base_scr, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        return MMI_FALSE;
    }

    while (mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG))
    {
        if (pre_scr == check_scr)
        {
            return MMI_TRUE;
        }

        //cur_scr = pre_scr;
        pre_scr = 0;
    }

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_screen
 * DESCRIPTION
 *  delete UC screen if present
 * PARAMETERS
 *  scrn_id     [IN]        
 *  screen to be deleted(?)
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_delete_screen(U16 scrn_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_scrn_get_active_id() == scrn_id)
    {
        mmi_frm_scrn_close_active_id();
    }
    else
    {
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, scrn_id);
		mmi_frm_scrn_close(g_uc_p->main.parent_grp_id, scrn_id);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_all_uc_screens
 * DESCRIPTION
 *  delete UC screens if present
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_delete_all_uc_screens(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 startScrnId = 0;
    U16 endScrnId = 0;
    MMI_BOOL IsCurrentScrn = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*
     * cases: 
     * 1. //no uc
     * 2. UC - call
     * 3. call - UC
     * 4. UC  
     */

    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_ALL_UC_SCRS_P1, g_uc_p->srv_main->state);

    /* decide startScrnId */
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    startScrnId = SCR_ID_UC_EDITOR;
#else
    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD || g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
    {
        startScrnId = SCR_ID_UC_OPT_ADD_RECIPIENT;
    }
    else
    {
        startScrnId = SCR_ID_UC_EDITOR;
    }        
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, startScrnId, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        IsCurrentScrn = MMI_FALSE;
    }
    else if (mmi_frm_scrn_get_active_id() == startScrnId)
    {
        IsCurrentScrn = MMI_TRUE;
    }
    else
    {
        /* case 1, no UC */
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_ALL_UC_SCRS_CASE1);
        return;
    }

    /* the endScrnId will differnt */
    if ((srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_ALL, NULL) > 0))
    {
        MMI_BOOL UC_is_older;

        endScrnId = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
        if (endScrnId)
        {
            UC_is_older = mmi_uc_check_if_scr_older(startScrnId, endScrnId);    /* chk, base */

            if (MMI_TRUE == UC_is_older)    /* case2: UC - call */
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_ALL_UC_SCRS_CASE2_P2, startScrnId, endScrnId);
                /* UC must in history, IsCurrentScrn should be T */
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, endScrnId, 1, 0, startScrnId, 1);
            }
            else    /* case3: call - UC */
            {
                MMI_TRACE(
                    MMI_COMMON_TRC_G6_MSG,
                    TRC_MMI_UC_DEL_ALL_UC_SCRS_CASE3_P3,
                    startScrnId,
                    endScrnId,
                    IsCurrentScrn);
                if (MMI_TRUE == IsCurrentScrn)
                {
                    mmi_frm_scrn_close_active_id();
                }
                else
                {
                    /* delete screen up to start scrn and include start scrn */
                    {
                        U16 next_scrn_id = 0, top_scrn_id = 0;
                        top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, startScrnId, MMI_FRM_NODE_AFTER_FLAG); 
                        mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                    }
                }
            }

        }
        else
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_ALL_UC_SCRS_CM_ERR_P1, GetCmMarkerScrnID());
            MMI_ASSERT(0);
        }
    }
    else    /* case 4, UC */
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_ALL_UC_SCRS_CASE4_P2, startScrnId, IsCurrentScrn);
        if (MMI_TRUE == IsCurrentScrn)
        {
            mmi_frm_scrn_close_active_id();
        }
        else
        {
            /* delete screen up to start scrn and include start scrn */
            {
                U16 next_scrn_id = 0, top_scrn_id = 0;
                top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, startScrnId, MMI_FRM_NODE_AFTER_FLAG); 
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
            }
        }
    }

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_reset_history_guibuffer
 * DESCRIPTION
 *  reset editor history gui buffer
 * PARAMETERS
 *  screen_id       [IN]        
 * RETURNS
 *  kal_bool
 *****************************************************************************/
BOOL mmi_uc_reset_history_guibuffer(U16 screen_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_scrn_is_present(g_uc_p->main.parent_grp_id, screen_id, MMI_FRM_NODE_ALL_FLAG))
    {
        mmi_frm_scrn_clean_gui_buf (g_uc_p->main.parent_grp_id, screen_id);
    }
    else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, screen_id, MMI_FRM_NODE_ALL_FLAG))
    {
        mmi_frm_scrn_clean_gui_buf (g_uc_p->main.uc_cui_gid, screen_id);
    }
	return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_uc_screen_in_history
 * DESCRIPTION
 *  Return if unified composer screen is in the history
 * PARAMETERS
 *  void
 *  screen_id(?)        [IN]        
 * RETURNS
 *  kal_bool
 *****************************************************************************/
kal_bool mmi_uc_is_uc_screen_in_history(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_ALL_FLAG) || 
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_ALL_FLAG) ||
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
		mmi_frm_scrn_is_present(g_uc_p->main.parent_grp_id, SCR_ID_UC_EDITOR, MMI_FRM_NODE_ALL_FLAG) 
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        || mmi_frm_scrn_is_present(g_uc_p->main.parent_grp_id, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_ALL_FLAG)
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    )
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_SCREENS_PRESENT_P1, 1);
        return KAL_TRUE;
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_SCREENS_PRESENT_P1, 0);
        return KAL_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_uc_screen_alraedy_present
 * DESCRIPTION
 *  Return if unified composer screen is in the history
 * PARAMETERS
 *  void
 *  screen_id(?)        [IN]        
 * RETURNS
 *  kal_bool
 *****************************************************************************/
kal_bool mmi_uc_is_uc_screen_alraedy_present(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG)) || (mmi_frm_scrn_get_active_id() == SCR_ID_UC_EDITOR) 
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        || (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        || (mmi_frm_scrn_get_active_id() == SCR_ID_UC_OPT_ADD_RECIPIENT)
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        )
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_SCREENS_PRESENT_P1, 1);
        return KAL_TRUE;
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_SCREENS_PRESENT_P1, 0);
        return KAL_FALSE;
    }
}

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_msg_type_check
 * DESCRIPTION
 *  Handler for checking if msg type changes
 * PARAMETERS
 *  void
 *  screen_id(?)        [IN]        
 * RETURNS
 *  kal_bool(?)
 *****************************************************************************/
void mmi_uc_handle_msg_type_check(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_HANDLE_MSG_TYPE_CHECK);
    if(!mmi_uc_is_uc_screen_in_history())
    {
        return;
    }
    if (mmi_uc_change_msg_type_if_needed())
    {
        pass_sig_check = mmi_uc_insert_signature_check();
    }

    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_OPT_ADD_RECIPIENT)
    {
        if (g_uc_p->done.pre_msg_type != g_uc_p->srv_msg_type->curr_msg_type)
        {
            g_uc_p->done.pre_msg_type = g_uc_p->srv_msg_type->curr_msg_type;
#ifndef __MMI_MMS_STANDALONE_COMPOSER__
            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SWITCHED_TO_SMS_ID)), MMI_EVENT_INFO, NULL);
            }
            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SWITCHED_TO_MMS_ID)), MMI_EVENT_INFO, NULL);
            }
            else
            {
                MMI_ASSERT(0);
            }
#endif
        }
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_HANDLE_MSG_TYPE_CHECK_IGNORE);
    }
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_add_sig_confirm_to_history();
    }
}
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_disply_msg_type_change
 * DESCRIPTION
 *  display msg type is changed
 * PARAMETERS
 *  void
 *  screen_id(?)        [IN]        
 * RETURNS
 *  kal_bool(?)
 *****************************************************************************/
void mmi_uc_disply_msg_type_change(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DISP_MSG_TYPE_CHANGE);
#ifndef __MMI_MMS_STANDALONE_COMPOSER__
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if(!g_uc_p->main.prev_msg_type || g_uc_p->main.prev_msg_type == g_uc_p->srv_msg_type->curr_msg_type)
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    {
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SWITCHED_TO_SMS_ID)), MMI_EVENT_INFO, NULL);
        }
        else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SWITCHED_TO_MMS_ID)), MMI_EVENT_INFO, NULL);
        }
        else
        {
            MMI_ASSERT(0);
        }
    }
    
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    g_uc_p->main.prev_msg_type = 0;
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
#endif
    pass_sig_check = mmi_uc_insert_signature_check();
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_add_sig_confirm_to_history();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_text_change_callback
 * DESCRIPTION
 *  Check if the text is allowed to be inserted
 * PARAMETERS
 *  new_text_info       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
wgui_uce_text_change_result_enum mmi_uc_text_change_callback(wgui_uce_text_info_struct *new_text_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 max_size = 0;
    MMI_BOOL Is_delete_char = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!g_uc_p->srv_msg->msg_body.curr_slide)
    {
        return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
    }
    max_size = mms_get_max_msg_size_in_restricted_mode();
    max_size =
        (g_uc_p->srv_mms_info->creation_mode ==
         MMA_CREATION_MODE_RESTRICTED) && (max_size < g_uc_p->srv_mms_info->max_mms_size) ? max_size : g_uc_p->srv_mms_info->max_mms_size;
    if (new_text_info->char_count > SRV_UC_MAX_CHAR_NUM_IN_ONE_SLIDE)
    {
        return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
    }
#ifdef __MMI_MMS_POSTCARD__
    else if ((g_uc_p->srv_msg_type->MMS_edit_mode == SRV_UC_MMS_EDIT_MODE_POSTCARD_MMS) &&
             (new_text_info->char_count > SRV_POSTCARD_MAX_GREETING))
    {
        return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 
    else
    {
        if (g_uc_p->srv_msg_type->caller_specific_msg_type == SRV_UC_MSG_TYPE_SMS_ONLY)
        {
        #ifndef __MMI_MMS_STANDALONE_COMPOSER__
            if (new_text_info->UCS2_count > 0)
            {
                if (new_text_info->char_count > (srv_sms_get_usable_text_len(SMSAL_UCS2_DCS) / 2))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_TEXT_CHANGE_CB_UCS2_TEXT_SIZE_EXCEED);
                    return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
                }
            }
            else
            {
                if (new_text_info->char_count + new_text_info->extension_char_count >
                    (srv_sms_get_usable_text_len(SMSAL_DEFAULT_DCS) / 2))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_TEXT_CHANGE_CB_ASCII_TEXT_SIZE_EXCEED);
                    return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
                }
            }
        #else /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
            MMI_ASSERT(0);
        #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
        }

        if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count == 0)
            {
                U8 mmi_uc_text_path[SRV_UC_MAX_TEMP_FILE_LEN];
                U32 text_obj_size = 0;

                memset(mmi_uc_text_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);
                SRV_UC_MAKE_TEXT_FILE_PATH(mmi_uc_text_path, g_uc_p->srv_msg->current_slide_num, g_uc_p->main.instance);
                if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_SMIL_MMS)
                {
                    text_obj_size = mma_uc_calc_object_smil_size(MMA_INSERT_TEXT, (U16*) mmi_uc_text_path);
                }
                text_obj_size += mma_uc_calc_object_multipart_size((U16*) mmi_uc_text_path);

                if ((g_uc_p->srv_msg->msg_size + text_obj_size + new_text_info->utf8_msg_len) > max_size)
                {
                    MMI_TRACE(
                        MMI_COMMON_TRC_G6_MSG,
                        TRC_MMI_UC_TEXT_CHANGE_CB_MMS_SIZE_EXCEED_0_P3,
                        g_uc_p->srv_msg->msg_size,
                        text_obj_size,
                        new_text_info->utf8_msg_len);
                    return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
                }
            }
            else
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count > new_text_info->char_count)
                {
                    /* Always allow to delete characters operation */
                }
                else if ((g_uc_p->srv_msg->msg_size_without_text_buffer + new_text_info->utf8_msg_len +
                          mma_uc_calc_text_uintvar_overhead_size(new_text_info->utf8_msg_len)) > max_size)
                {
                    MMI_TRACE(
                        MMI_COMMON_TRC_G6_MSG,
                        TRC_MMI_UC_TEXT_CHANGE_CB_MMS_SIZE_EXCEED_P2,
                        g_uc_p->srv_msg->msg_size_without_text_buffer,
                        new_text_info->utf8_msg_len);
                    return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
                }
            }
        }
        MMI_TRACE(
            MMI_COMMON_TRC_G6_MSG,
            TRC_MMI_UC_TEXT_CHANGE_CB_ORI_P4,
            g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count,
            g_uc_p->srv_msg->msg_body.curr_slide->txt.utf8_msg_len,
            g_uc_p->srv_msg->msg_body.curr_slide->txt.extension_char_count,
            g_uc_p->srv_msg->msg_body.curr_slide->txt.UCS2_count);

        MMI_TRACE(
            MMI_COMMON_TRC_G6_MSG,
            TRC_MMI_UC_TEXT_CHANGE_CB_NEW_P4,
            new_text_info->char_count,
            new_text_info->utf8_msg_len,
            new_text_info->extension_char_count,
            new_text_info->UCS2_count);
        if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count > new_text_info->char_count)
        {
            Is_delete_char = MMI_TRUE;
        }
        else
        {
            Is_delete_char = MMI_FALSE;
        }

        g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count = new_text_info->char_count;
        g_uc_p->srv_msg->msg_body.curr_slide->txt.utf8_msg_len = new_text_info->utf8_msg_len;
        g_uc_p->srv_msg->msg_body.curr_slide->txt.extension_char_count = new_text_info->extension_char_count;
        g_uc_p->srv_msg->msg_body.curr_slide->txt.UCS2_count = new_text_info->UCS2_count;

        /* For better performance, only update text buffer to text object when char count is one or zero */
        /* That is, text object is existed or not. */
        if ((Is_delete_char == MMI_FALSE) && (new_text_info->char_count == 1) ||
            (Is_delete_char == MMI_TRUE) && (new_text_info->char_count == 0))
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide)
            {
                g_uc_p->srv_main->current_text_file_save_result = srv_uc_handle_text_in_current_slide(g_uc_p->main.instance);
            }
            /* actually, srv_uc_exit_write_msg */
            /* Tricky: because before return WGUI_UCE_TEXT_CHANGE_ALLOWED, editor will not copy string to dst:g_uc_p->srv_main->text_buffer
               so, when srv_uc_save_buffer_to_file is called, no character will be saved to uc txt file, and obj size will not be updated.
               When wap call calculate api, use the obj->size, will use the wrong error -- */
            if (new_text_info->char_count == 1) /* only for add characters */
            {
                if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
                {
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.object->size =
                        g_uc_p->srv_msg->msg_body.curr_slide->txt.utf8_msg_len;
                }
                else
                {
                    return WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED;
                }
            }
            else
            {
                if (g_uc_p->srv_main->current_text_file_save_result != FS_NO_ERROR)
                {
                    MMI_ASSERT(0);  /* because should can save successfully for delete char case */
                }
            }
            srv_uc_update_msg_size(g_uc_p->main.instance);
        }
        if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
        }
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
        }
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        return WGUI_UCE_TEXT_CHANGE_ALLOWED;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_between_screens
 * DESCRIPTION
 *  Delete screens including start_sreen and end_screen
 * PARAMETERS
 *  start_screen_id     [IN]        
 *  end_screen_id       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
BOOL mmi_uc_delete_between_screens(U16 start_screen_id, U16 end_screen_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_ret ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_BETWEEN_SCREENS_SE_P2, start_screen_id, end_screen_id);

    if (!mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, start_screen_id, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_BETWEEN_SCREENS_S_ERR_P1, start_screen_id);

        return MMI_FALSE;
    }

    if (!mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, end_screen_id, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {

        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DEL_BETWEEN_SCREENS_E_ERR_P1, end_screen_id);
        return MMI_FALSE;
    }

    ret = mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, end_screen_id, 1, 0, start_screen_id, 1);
    if (ret == MMI_RET_ERR)
    {
        return MMI_FALSE;
    }
    else
    {
        return MMI_TRUE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_setSoftkeyFunction
 * DESCRIPTION
 *  set lsk and rsk and tone for uc confirm popup
 *  it will be in history
 * PARAMETERS
 *  lsk_f       [IN]        
 *  rsk_f       [IN]        
 *  toneId      [IN]        
 *  strId       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_setSoftkeyFunction(void (*lsk_f) (void), void (*rsk_f) (void), U8 toneId, U16 strId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.confirm_lsk_func = lsk_f;
    g_uc_p->main.confirm_rsk_func = rsk_f;
    g_uc_p->main.confirm_tone_id = toneId;
    g_uc_p->main.confirm_str_id = strId;
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_sig_setSoftkeyFunction
 * DESCRIPTION
 *  set lsk and rsk and tone for uc sigature confirm popup
 *  it will be in history
 * PARAMETERS
 *  lsk_f       [IN]        
 *  rsk_f       [IN]        
 *  toneId      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_sig_setSoftkeyFunction(void (*lsk_f) (void), void (*rsk_f) (void), U8 toneId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.sig_confirm_lsk_func = lsk_f;
    g_uc_p->main.sig_confirm_rsk_func = rsk_f;
    g_uc_p->main.sig_confirm_tone_id = toneId;
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_confirm_popup
 * DESCRIPTION
 *  
 *  it will be in history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_confirm_popup(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->main.confirm_tone_id)
    {
        srv_prof_stop_tone((srv_prof_tone_enum)g_uc_p->main.confirm_tone_id);
        g_uc_p->main.confirm_tone_id = 0;
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_sig_confirm_popup
 * DESCRIPTION
 *  
 *  it will be in history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_sig_confirm_popup(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->main.sig_confirm_tone_id)
    {
        srv_prof_stop_tone((srv_prof_tone_enum)g_uc_p->main.sig_confirm_tone_id);
        g_uc_p->main.sig_confirm_tone_id = 0;
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_displayConfirm
 * DESCRIPTION
 *  will display confirm popup, and this api differ from displayconfirm()
 *  should be also use mmi_uc_setSoftkeyFunction (pair)
 *  it will be in history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_displayConfirm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_CONFIRM);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_confirm_to_history
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_confirm_to_history(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_frm_node_struct new_node_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_node_info_init (&new_node_info);
    new_node_info.id = SCR_ID_UC_CONFIRM;
    new_node_info.entry_proc = (mmi_proc_func) mmi_uc_entry_displayConfirm;
#ifdef __MMI_BACKGROUND_CALL__
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0)
    {
        mmi_frm_scrn_insert(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, &new_node_info, MMI_FRM_NODE_AT_LATEST_FLAG);
        mmi_frm_scrn_set_attribute (g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM, MMI_SCRN_ATTRIB_SMALL_SCRN);
    }
#endif /* __MMI_BACKGROUND_CALL__ */ 
    mmi_frm_scrn_insert(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, &new_node_info, MMI_FRM_NODE_AT_LATEST_FLAG);
    mmi_frm_scrn_set_attribute (g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM, MMI_SCRN_ATTRIB_SMALL_SCRN);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_displayConfirm_generic
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_displayConfirm_generic(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0) || srv_reminder_is_expiring())
    {
        mmi_uc_add_confirm_to_history();
    }
    else
    {
        mmi_uc_entry_displayConfirm();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_sig_displayConfirm
 * DESCRIPTION
 *  will display signature confirm popup, and this api differ from displayconfirm()
 *  should be also use mmi_uc_sig_setSoftkeyFunction (pair)
 *  it will be in history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_sig_displayConfirm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_SIG_CONFIRM);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_sig_confirm_to_history
 * DESCRIPTION
 *  Add warnig mode confirm for singature popup screen to history
 *  if use this API, should call mmi_uc_sig_setSoftkeyFunction at the same time to
 *  set the LSK and RSK
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_sig_confirm_to_history(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_frm_node_struct new_node_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_node_info_init (&new_node_info);
    new_node_info.id = SCR_ID_UC_SIG_CONFIRM;
    new_node_info.entry_proc = (mmi_proc_func) mmi_uc_entry_sig_displayConfirm;
#ifdef __MMI_BACKGROUND_CALL__
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0)
    {
        U16 inter_cm_scrnId = mmi_ucm_app_get_intermediate_marker_scrn_id();
        mmi_frm_scrn_insert(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, &new_node_info, MMI_FRM_NODE_AT_LATEST_FLAG);
        mmi_frm_scrn_set_attribute (g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIG_CONFIRM, MMI_SCRN_ATTRIB_SMALL_SCRN);
        return;
    }
#endif /* __MMI_BACKGROUND_CALL__ */ 
    mmi_frm_scrn_insert(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, &new_node_info, MMI_FRM_NODE_AT_LATEST_FLAG);
    mmi_frm_scrn_set_attribute (g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIG_CONFIRM, MMI_SCRN_ATTRIB_SMALL_SCRN);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_sig_displayConfirm_generic
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_sig_displayConfirm_generic(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0) || srv_reminder_is_expiring())
    {
        mmi_uc_add_sig_confirm_to_history();
    }
    else
    {
        mmi_uc_entry_sig_displayConfirm();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_warning_mode_insert_signature_for_yes
 * DESCRIPTION
 *  process insert signature for warning mode confirm popup
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_warning_mode_insert_signature_for_yes(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_process_insert_signature();
    g_uc_p->send_info.need_to_skip_popup = FALSE;
    mmi_frm_scrn_close_active_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_warning_mode_insert_signature_for_back
 * DESCRIPTION
 *  process insert signature for warning mode confirm popup
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_warning_mode_insert_signature_for_back(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->send_info.need_to_skip_popup = FALSE;
    mmi_frm_scrn_close_active_id();
}


#ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_sd_plug_in_hdlr
 * DESCRIPTION
 *  Handler when memory card is removed
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_sd_plug_in_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_SD_CARD_PLUG_IN_HDLR);
    /* There is a popup when memory card is inserted! */
    if (mmi_uc_is_uc_screen_in_history())
    {
        if (g_uc_p->main.confirm_str_id == STR_UC_CARD_NOT_PRESENT_CONFIRM)
        {
            mmi_uc_delete_screen(SCR_ID_UC_CONFIRM);
			mmi_uc_delete_screen(SCR_ID_UC_MSG_PREVIEW);
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
            g_uc_p->main.confirm_str_id = 0;
        }
    }
}
#endif /* __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__ */


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_sd_plug_out_hdlr
 * DESCRIPTION
 *  Handler when memory card is removed
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_sd_plug_out_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_slide_struct *slide = NULL;
    mma_mms_object_struct *object = NULL;
    mma_mms_attachment_info_struct *attachment = g_uc_p->srv_msg->msg_body.attachment;
    #ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
    U16 shift_attachment_num = 0;
    #endif
    U8 cur_slide_num = 0;
    U8 cur_attachment_num = 0;
    BOOL attach_removed = FALSE, media_removed = FALSE;
    MMI_BOOL local_flag_hide_sig_confirm = MMI_FALSE;
    MMI_BOOL phoart_close = MMI_FALSE;
#ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__
    BOOL deinit_preview = FALSE;
#endif /* __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_SD_CARD_PLUG_OUT_HDLR);
    /* There is a popup when memory card is removed! */
#ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__

    if (mmi_uc_is_uc_screen_in_history())
    {
        BOOL close_uc = FALSE;

        if (g_uc_p->srv_send_info->new_msg_id)
        {
            if (g_uc_p->send_info.new_msg_storage != MMA_MSG_STORAGE_PHONE)
            {
                close_uc = TRUE;
                if(g_uc_p->srv_send_info->action == SRV_UC_ACTION_PREVIEW)
                {
                    deinit_preview = TRUE;
                    if((g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                        g_uc_p->srv_send_info->existed_msg_id && 
                        g_uc_p->send_info.existed_msg_storage == MMA_MSG_STORAGE_PHONE) ||
                        (g_uc_p->srv_main->state == MMI_UC_STATE_WRITE_NEW_MSG &&
                        !g_uc_p->srv_send_info->existed_msg_id))
                    {
                        close_uc = FALSE;
                    }
                }
            }
            else
            {
                if (g_uc_p->srv_send_info->action == SRV_UC_ACTION_PREVIEW &&
                        g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                        g_uc_p->srv_send_info->existed_msg_id && 
                        g_uc_p->send_info.existed_msg_storage != MMA_MSG_STORAGE_PHONE)
                {
                    deinit_preview = TRUE;
                    close_uc = TRUE;
                }
            }
        }
        else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
                 g_uc_p->srv_send_info->existed_msg_id)
        {
            if (g_uc_p->send_info.existed_msg_storage != MMA_MSG_STORAGE_PHONE)
            {
                close_uc = TRUE;
            }
        }

        if (deinit_preview)
        {
            mmi_umms_app_if_uc_request_to_deinit();
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
            g_uc_p->send_info.abort = MMI_UC_ABORT_NONE;
            if (g_uc_p->srv_send_info->new_msg_id)
            {
                mmi_uc_delete_mms_req(g_uc_p->srv_send_info->new_msg_id, g_uc_p->send_info.new_msg_storage);
                g_uc_p->srv_send_info->new_msg_id = 0;
            }
        }

        if (close_uc)
        {
            /* Close UC */
            if(g_uc_p->srv_send_info->fs)
            {
                FS_Close(g_uc_p->srv_send_info->fs);
                g_uc_p->srv_send_info->fs =0;
            }
            mmi_uc_reset_msg();
            mmi_uc_delete_all_uc_screens();
            return;
        }

        if (g_uc_p->main.confirm_str_id == STR_UC_MAX_MSG_CARD_CONFIRM ||
            g_uc_p->main.confirm_str_id == STR_UC_MAX_MSG_PHONE_CONFIRM)
        {
            mmi_uc_delete_screen(SCR_ID_UC_CONFIRM);
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
            g_uc_p->main.confirm_str_id = 0;
        }
    }
#endif /* __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__ */ 
    if (mmi_uc_is_uc_screen_in_history())
    {
        if (g_uc_p->srv_msg->msg_body.curr_slide->img.object)
        {
            object = g_uc_p->srv_msg->msg_body.curr_slide->img.object;
            if (!(object->is_virtual_file))
            {
                if (FS_GetAttributes((const WCHAR *)object->file_path_ucs) < 0)
                {
                    phoart_close = MMI_TRUE;
                }
            }
        }
    }

    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_ALL_FLAG) ||
		mmi_frm_scrn_is_present(g_uc_p->main.parent_grp_id, SCR_ID_UC_EDITOR, MMI_FRM_NODE_ALL_FLAG))
    {
        for (slide = g_uc_p->srv_msg->msg_body.slides; cur_slide_num < g_uc_p->srv_msg->msg_body.slide_no ; cur_slide_num++)
        {
            MMI_ASSERT(slide);
            if (slide->img.object)
            {
                object = slide->img.object;

                if (!(object->is_virtual_file))
                {
                    if (FS_GetAttributes((const WCHAR *)object->file_path_ucs) < 0)
                    {
                        if (object->reference_count > 1)
                        {
                            object->reference_count--;
                        }
                        else
                        {
                            srv_uc_delete_object_from_list(g_uc_p->main.instance, object);
                        }
                        memset(&slide->img, 0, sizeof(mma_mms_slide_object_struct));
                    }
                }
            }

            if (slide->aud.object)
            {
                object = slide->aud.object;

                if (!(object->is_virtual_file))
                {
                    if (FS_GetAttributes((const WCHAR *)object->file_path_ucs) < 0)
                    {
                        if (object->reference_count > 1)
                        {
                            object->reference_count--;
                        }
                        else
                        {
                            srv_uc_delete_object_from_list(g_uc_p->main.instance, object);
                        }
                        memset(&slide->aud, 0, sizeof(mma_mms_slide_object_struct));
                    }
                }
            }

            if (slide->vid.object)
            {
                object = slide->vid.object;

                if (!(object->is_virtual_file))
                {
                    if (FS_GetAttributes((const WCHAR *)object->file_path_ucs) < 0)
                    {
                        if (object->reference_count > 1)
                        {
                            object->reference_count--;
                        }
                        else
                        {
                            srv_uc_delete_object_from_list(g_uc_p->main.instance, object);
                        }
                        memset(&slide->vid, 0, sizeof(mma_mms_slide_object_struct));
                    }
                }
            }

            if (slide->ref_items != NULL)
			{
			    if (slide->ref_items->object)
			    {
				    mma_mms_slide_ref_object_struct *cur_ref = slide->ref_items;
				    mma_mms_slide_ref_object_struct *next_ref = NULL;
				    object = slide->ref_items->object;

					if (!(object->is_virtual_file))
					{
						if (FS_GetAttributes((const WCHAR *)object->file_path_ucs) < 0)
						{
							if (object->reference_count > 1)
							{
								object->reference_count--;
							}
							else
							{
								srv_uc_delete_object_from_list(g_uc_p->main.instance, object);
							}

							if (slide->ref_items == cur_ref)
							{
								slide->ref_items = cur_ref->next;

								if (cur_ref->next)
								{
									cur_ref->next->prev = NULL;
								}
								g_uc_p->srv_msg->msg_body.total_attach_no--;
								next_ref = cur_ref->next;
								kal_adm_free(g_uc_p->main.mem_pool_id, cur_ref);
							}
							else
							{
								next_ref = cur_ref->next;
								srv_uc_delete_ref_obj_info_from_list(g_uc_p->main.instance, cur_ref);
							}
							cur_ref = next_ref;
						}
					}
				}
			}

            slide = slide->next;

        }

        while (attachment != NULL)
        {
            object = attachment->object;

            if (!(object->is_virtual_file))
            {
                if (FS_GetAttributes((const WCHAR *)object->file_path_ucs) < 0)
                {
                    mma_mms_attachment_info_struct *att_temp = attachment->next;

                    MMI_ASSERT(object->reference_count == 1);
					if(!(object->reference_count == 1))
					{
					MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
					}
                    srv_uc_delete_object_from_list(g_uc_p->main.instance, object);
                #ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
                    /* Replace attachment handling */
                    if (g_uc_p->main.select_media_opt == UC_MEDIA_OPT_REPLACE || 
                    g_uc_p->main.select_media_opt == UC_MEDIA_OPT_ATTACHMENT_LIST)
                    {
                        if (g_uc_p->main.object_index == cur_attachment_num)
                        {
                            shift_attachment_num = SRV_UC_INVALID_INDEX;
                        }

                        if (shift_attachment_num != SRV_UC_INVALID_INDEX &&
                            g_uc_p->main.object_index > cur_attachment_num)
                        {
                            shift_attachment_num++;
                        }
                    }
                #endif /* __MMI_UC_REPLACE_MEDIA_SUPPORT__ */ 

                    srv_uc_delete_attachment_from_list(g_uc_p->main.instance, attachment);
                    attachment = att_temp;
                    cur_attachment_num++;
                    attach_removed = TRUE;

                    continue;
                }
            }

            cur_attachment_num++;
            attachment = attachment->next;
        }
    #ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
        /* Replace attachment handling */
        if (shift_attachment_num > 0)
        {
            if (shift_attachment_num == SRV_UC_INVALID_INDEX)
            {
                g_uc_p->main.object_index = SRV_UC_INVALID_INDEX;
            }
            else
            {
                MMI_ASSERT(g_uc_p->main.object_index >= shift_attachment_num);
				if(!(g_uc_p->main.object_index >= shift_attachment_num))
				{
				MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
				}
                g_uc_p->main.object_index -= shift_attachment_num;
            }
        }
    #endif /* __MMI_UC_REPLACE_MEDIA_SUPPORT__ */ 

        srv_uc_reset_layout_if_needed(g_uc_p->main.instance);

        /* info stored in global structure, it's impossbile to from sms to mms or mms to sms  */
        if (mmi_uc_change_msg_type_if_needed())
        {
            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
            {
                local_flag_hide_sig_confirm = MMI_TRUE;
            }
            mmi_uc_insert_signature_check();
        }
    #ifdef __MMI_MMS_2__
        if (g_uc_p->srv_send_info->action == SRV_UC_ACTION_PREVIEW
            && g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
        {
        #ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__
            if(!deinit_preview)
        #endif /* __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__ */
            mmi_umms_app_if_uc_request_to_deinit();
        }
    #endif /* __MMI_MMS_2__ */ 
        switch (g_uc_p->main.highlighted_object_type)
        {
            case SRV_UC_OBJECT_TYPE_AUDIO:
            {
                if (!g_uc_p->srv_msg->msg_body.curr_slide->aud.object)
                {
                    media_removed = TRUE;
                }
            }
                break;
            case SRV_UC_OBJECT_TYPE_VIDEO:
            {
                if (!g_uc_p->srv_msg->msg_body.curr_slide->vid.object)
                {
                    media_removed = TRUE;
                }
            }
                break;
            case SRV_UC_OBJECT_TYPE_IMAGE:
            {
                if (!g_uc_p->srv_msg->msg_body.curr_slide->img.object)
                {
                    media_removed = TRUE;
                }
            }
                break;
        }
        if (g_uc_p->srv_main->file_path && FS_GetAttributes((WCHAR*) g_uc_p->srv_main->file_path) < 0)
        {
            mmi_uc_delete_screen(SCR_ID_UC_CONFIRM);
            mmi_uc_delete_screen(SCR_ID_UC_PROCESSING);
        }
        if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIG_CONFIRM, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG) ||
			mmi_frm_scrn_is_present(g_uc_p->main.parent_grp_id, SCR_ID_UC_SIG_CONFIRM, MMI_FRM_NODE_ALL_FLAG)
            || mmi_frm_scrn_get_active_id() == SCR_ID_UC_SIG_CONFIRM)
        {
            /* to remove the confirm popup for signature if media removed with card. */
            if (g_uc_p->srv_mms_info->signature.img_file &&
                FS_GetAttributes((WCHAR*) g_uc_p->srv_mms_info->signature.img_file) < 0)
            {
                local_flag_hide_sig_confirm = MMI_TRUE;
            }
            else if (g_uc_p->srv_mms_info->signature.audio_file &&
                     FS_GetAttributes((WCHAR*) g_uc_p->srv_mms_info->signature.audio_file) < 0)
            {
                local_flag_hide_sig_confirm = MMI_TRUE;
            }
            else if (g_uc_p->srv_mms_info->signature.video_file &&
                     FS_GetAttributes((WCHAR*) g_uc_p->srv_mms_info->signature.video_file) < 0)
            {
                local_flag_hide_sig_confirm = MMI_TRUE;
            }
            if (local_flag_hide_sig_confirm == MMI_TRUE)
            {
                mmi_uc_delete_screen(SCR_ID_UC_SIG_CONFIRM);
            }
        }
        if (media_removed == TRUE)
        {
            mmi_uc_delete_screen(SCR_ID_UC_OPT_REMOVE);
            mmi_uc_delete_screen(SCR_ID_UC_OPT_SLIDE_OPT_SLIDE_TIMING);
        }
        if (attach_removed && !g_uc_p->srv_msg->msg_body.attachment)
        {
            mmi_uc_delete_screen(SCR_ID_ATTACHMENT_OPTIONS);
            mmi_uc_delete_screen(SCR_ID_UC_OPT_ATTACHMENT_LIST);
        }
        if (phoart_close)
        {
#ifdef __MMI_PHOTOEDITOR__
            if(g_uc_p->main.uc_phart_id != GRP_ID_INVALID)
            {
                cui_phoedt_close(g_uc_p->main.uc_phart_id);
                g_uc_p->main.uc_phart_id = GRP_ID_INVALID;
            }
#endif
        }
        srv_uc_update_msg_size(g_uc_p->main.instance);
        /* mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide); */
        mmi_uc_editor_initialize();
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        mmi_uc_recipient_initialize();
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
    }
    else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        if (g_uc_p->srv_main->file_path && FS_GetAttributes((WCHAR*) g_uc_p->srv_main->file_path) < 0)
        {
            mmi_uc_delete_screen(SCR_ID_UC_CONFIRM);
			mmi_uc_delete_screen(SCR_ID_UC_PROCESSING);
        }        
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_usb_ms_plug_in_hdlr
 * DESCRIPTION
 *  Select mass storage in USB
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_usb_ms_plug_in_hdlr(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    if(g_uc_p && g_uc_p->srv_msg_type && (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER) && 
        g_uc_p->send_info.abort != MMI_UC_ABORT_BY_END_KEY && 
        g_uc_p->srv_send_info && (g_uc_p->srv_send_info->action == SRV_UC_ACTION_SEND_AND_SAVE ||
        g_uc_p->srv_send_info->action == SRV_UC_ACTION_SEND))
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_USB_MS_PLUG_IN_HDLR_FG_SEND_CNCL);
        srv_sms_clear_send_callback(g_uc_p->main.send_handle);
        srv_sms_abort_send(g_uc_p->main.send_handle);
        mmi_uc_reset_msg();
        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
    }
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
	return MMI_RET_OK;
}





/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_object_insert_if_file_path_exist
 * DESCRIPTION
 *  Handle object insertion (obj -- the file-- g_uc_p->srv_main->file_path)
 *  when call this API, g_uc_p->srv_main->file_path should not = NULL
 * PARAMETERS
 *  void
 * RETURNS
 *  BOOL  -- if encounter error, should indicate caller, caller maybe stop to do the following flow
 *****************************************************************************/
BOOL mmi_uc_handle_object_insert_if_file_path_exist(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
    U16 *filePath = (U16*) g_uc_p->srv_main->file_path;
    mma_insert_check_struct check_result;
    S32 result;
    mma_insert_info_struct insert_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_main->file_path == NULL)
    {
        MMI_ASSERT(0);
        return MMI_TRUE;    /* even no file path, caller still go on following flow */
    }

    memset(&check_result, 0, sizeof(check_result));

    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = g_uc_p->srv_msg->msg_size;
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = MMA_INSERT_UNKNOWN;
    insert_info.filepath = (kal_wchar*) g_uc_p->srv_main->file_path;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_result);

#ifdef __MMI_MMS_POSTCARD__
    if ((g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS) && (check_result.result))
    {
        MMI_ASSERT(check_result.insert_type == MMA_INSERT_IMAGE);
    }
#endif /* __MMI_MMS_POSTCARD__ */ 

    memset(mmi_uc_image_path, 0x00, SRV_UC_MAX_TEMP_FILE_LEN);

    /* Treat .txt files as attachments */
    if (check_result.insert_type == MMA_INSERT_TEXT)
    {

        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_SETTING_RSP_TO_ATT);
        check_result.insert_type = MMA_INSERT_ATTACHMENT;
    }

    if (!(check_result.result))
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_SETTING_RSP_INSERT_OBJ_CHECK_ERR);

        result = srv_uc_convert_mms_check_result(&check_result);
        mmi_uc_display_popup((srv_uc_result)result);
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
        mmi_uc_reset_msg();
        #ifdef __MMI_OP02_LEMEI__
		  if(g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
			{
			g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_NORMAL_MMS;
			}
        #endif
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        return MMI_FALSE;
    }
    srv_uc_post_handler_handle_object_insert_if_file_path_exist(
        g_uc_p->main.instance,
        check_result.insert_type,
        mmi_uc_image_path,
        filePath);
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_no_in_mms_setting_rsp
 * DESCRIPTION
 *  process no for MMI_UC_STATE_WRITE_NEW_MSG case (forward mms from fmgr)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_no_in_mms_setting_rsp(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_main->file_path != NULL && srv_uc_is_resized_image((U16*) g_uc_p->srv_main->file_path, g_uc_p->main.instance) == MMI_TRUE)
    {
        FS_Delete((WCHAR*) g_uc_p->srv_main->file_path);
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
    mmi_frm_scrn_close_active_id();
    mmi_uc_reset_msg();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_state_write_new_msg_in_mms_setting_rsp
 * DESCRIPTION
 *  process MMS setting response for MMI_UC_STATE_WRITE_NEW_MSG case (forward mms from fmgr)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_state_write_new_msg_in_mms_setting_rsp(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_uc_handle_object_insert_if_file_path_exist())
    {
        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_CONFIRM)
        {
            mmi_frm_scrn_close_active_id();
        }
        else
        {
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        }
        return;
    }
    mmi_uc_change_msg_type_if_needed();
    /* g_uc_p->srv_msg->msg_body.curr_slide->duration = g_uc_p->srv_msg->slide_timing; */

    pass_sig_check = mmi_uc_insert_signature_check();
    mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
    srv_uc_update_msg_size(g_uc_p->main.instance);
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        mmi_uc_replace_screen(SCR_ID_UC_PROCESSING, SCR_ID_UC_EDITOR, (mmi_proc_func) mmi_uc_entry_write_msg, 0);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
    }
    else
    //   if ((mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING) || (mmi_frm_scrn_get_active_id() == SCR_ID_UC_CONFIRM))
    {
        mmi_uc_entry_write_msg();
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
    }

    /* Does not call mmi_frm_scrn_close_active_id for warning mode confirm pop, because entry write msg will delete it */
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_entry_sig_displayConfirm_generic();
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_post_handler_handle_image_object_insert_if_file_path_exist_then_entry_editor
 * DESCRIPTION
 *  
 * PARAMETERS
 *  mms_type                [IN]        
 *  mmi_uc_image_path       [?]         
 *  filePath                [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_post_handler_handle_image_object_insert_if_file_path_exist_then_entry_editor(
        mma_insert_type_enum mms_type,
        U8 *mmi_uc_image_path,
        PU16 filePath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    S32 result;
    mma_insert_info_struct insert_info = {0, 0, MMA_CREATION_MODE_FREE, MMA_INSERT_UNKNOWN, MMA_MMS_TYPE_SMIL_MMS, NULL};
    //srv_uc_object_type object_type = SRV_UC_OBJECT_TYPE_IMAGE;
    mma_insert_check_struct check_image_result = {KAL_FALSE, KAL_FALSE, KAL_FALSE, MMA_RESULT_OK, MMA_INSERT_UNKNOWN, MMA_DRM_NONE};

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* The img size may exceed limitation even if it is resized. */
    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = g_uc_p->srv_msg->msg_size;
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = mms_type;
    insert_info.filepath = (kal_wchar*) filePath;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_image_result);

    if (check_image_result.result && (MMA_RESULT_OK_WITH_WARNING_CONTENT == check_image_result.detail_result))
    {
        mmi_uc_setSoftkeyFunction(
            mmi_uc_process_state_write_new_msg_in_mms_setting_rsp,
            mmi_uc_process_no_in_mms_setting_rsp,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
            (U16) STR_UC_WARNING_MODE_CONFIRM);
        mmi_uc_entry_displayConfirm_generic();
        return;
    }
    if (!(check_image_result.result))
    {
        g_uc_p->srv_msg->display_no_resize = MMI_FALSE;
        result = srv_uc_convert_mms_check_result(&check_image_result);
        mmi_uc_display_popup((srv_uc_result)result);
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        mmi_uc_reset_msg();
        return;
    }
    mmi_uc_process_state_write_new_msg_in_mms_setting_rsp();
    return;
}


#ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_resize_image_and_mms_check
 * DESCRIPTION
 *  resize image based on current left mms size --> it's non-blocking
 * PARAMETERS
 *  src_file            [?]         
 *  dest_file           [?]         
 *  resize_w            [IN]        
 *  resize_h            [IN]        
 *  left_mms_size       [IN]        
 *  encoded_size        [?]         
 * RETURNS
 *  S32
 *****************************************************************************/
S32 mmi_uc_resize_image_and_mms_check(
        U8 *src_file,
        U8 *dest_file,
        U32 resize_w,
        U32 resize_h,
        S32 left_mms_size,
        S32 *encoded_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 buf_size = 0;
    U8 *buf_ptr = NULL;
    S32 encoded_file_size = 0;
    GDI_RESULT gdi_ret = GDI_FAILED;
    S32 ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* resize the image and encode to jpeg file */
    buf_size = (resize_w * resize_h * GDI_MAINLCD_BIT_PER_PIXEL) >> 3;
    buf_size = ((buf_size + 3) / 4) * 4;
    if (buf_size > 0)
    {
        media_get_ext_buffer(MOD_MMI, (void **)&buf_ptr, buf_size);
        if (buf_ptr != NULL)
        {
            gdi_ret = gdi_image_encode_file_to_jpeg_with_exp_size(
                        (PS8) src_file,
                        (S8*) dest_file,
                        resize_w,
                        resize_h,
                        buf_ptr,
                        buf_size,
                        left_mms_size,
                        &encoded_file_size);
            media_free_ext_buffer(MOD_MMI, (void **)&buf_ptr);
        }
        else
        {   /* if the memory is not enough, treat it as disk size not enough, let it can try smaller cases. maybe the size will be enough */
            gdi_ret = GDI_IMAGE_ENCODER_ERR_SIZE_LARGER_THAN_EXPECTATION;
        }
        switch (gdi_ret)
        {
            case GDI_IMAGE_ENCODER_ERR_SIZE_LARGER_THAN_EXPECTATION:
                ret = SRV_UC_RESIZING_ERR_SIZE_LARGER_THAN_EXPECTATION;
                break;
            case GDI_SUCCEED:
                ret = SRV_UC_RESIZING_SUCCEED;
                break;
            case GDI_IMAGE_ENCODER_ERR_DISK_FULL:
                ret = SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_DISK_FULL;
                break;
            case GDI_IMAGE_ENCODER_ERR_WRITE_PROTECTION:
                ret = SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_WRITE_PROTECTION;
                break;
            case GDI_IMAGE_ENCODER_ERR_NO_DISK:
                ret = SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_NO_DISK;
                break;
            default:
                ret = SRV_UC_RESIZING_FAILED_IN_GDI_FAILED;
        }
    }
    else
    {
        /* -12: can't allocate gdi_layer for drawing image */
        ret = SRV_UC_RESIZING_FAILED_IN_INSUFFICIENT_DRAWING_BUF;
    }

    *encoded_size = encoded_file_size;
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_cal_img_resolution
 * DESCRIPTION
 *  to cal
 * PARAMETERS
 *  old_width       [IN]        
 *  old_height      [IN]        
 *  new_width       [?]         
 *  new_height      [?]         
 * RETURNS
 *  BOOL -return MMI_FALSE means can not get correct resolution, or too small to resize..etc
 *****************************************************************************/
MMI_BOOL mmi_uc_cal_img_resolution(S32 old_width, S32 old_height, S32 *new_width, S32 *new_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((old_width == 1) && (old_height == 1))  /* mean already tried 1*1 but fail */
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_CAL_MG_RESOLUTION_P4, old_width, old_height, 0, 0);
        return MMI_FALSE;
    }

    *new_width = (old_width * 3) / 4;
    *new_height = (old_height * 3) / 4;

    if (*new_width == 0)
    {
        *new_width = 1;
    }

    if (*new_height == 0)
    {
        *new_height = 1;
    }
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_CAL_MG_RESOLUTION_P4, old_width, old_height, *new_width, *new_height);
    return MMI_TRUE;

}

#endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_resize_image
 * DESCRIPTION
 *  Resize image
 * PARAMETERS
 *  file            [?]         
 *  dest_file       [?]         
 *  resize_w        [IN]        
 *  resize_h        [IN]        
 * RETURNS
 *  1: resized. 0: no need to resize. negative: error!
 *****************************************************************************/
S32 mmi_uc_resize_image(U8 *file, U8 *dest_file, U32 resize_w, U32 resize_h)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 img_width = 0, img_height = 0;
    GDI_RESULT gdi_ret = GDI_FAILED;
    S32 ret = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(file != NULL);
    MMI_ASSERT(dest_file != NULL);

    /* Get the image dimension */
    gdi_image_get_dimension_file((PS8) file, &img_width, &img_height);

    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_RESIZE_IMG_INPUT_P4, img_width, img_height, resize_w, resize_h);
    if ((img_width != 0) && (img_height != 0))
    {
        /* calculate the dimension of the resize JPEG */
        if (((S32) img_width > (S32) resize_w) || ((S32) img_height > (S32) resize_h))
        {
            S32 w = 0, h = 0, buf_size = 0;
            U8 *buf_ptr = NULL;

            /* need to resize */
            if ((img_width * resize_h) > (img_height * resize_w))
            {
                w = resize_w;
                h = img_height * resize_w / img_width;
                if (h == 0)
                {
                    h = 1;
                }
            }
            else
            {
                w = img_width * resize_h / img_height;
                h = resize_h;
                if (w == 0)
                {
                    w = 1;
                }
            }

            /* resize the image and encode to jpeg file */
            buf_size = (w * h * GDI_MAINLCD_BIT_PER_PIXEL) >> 3;
            buf_size = ((buf_size + 3) / 4) * 4;
            if (buf_size > 0)
            {
                media_get_ext_buffer(MOD_MMI, (void **)&buf_ptr, buf_size);
                if (buf_ptr != NULL)
                {
                    gdi_ret = gdi_image_encode_file_to_jpeg((PS8) file, (S8*) dest_file, w, h, buf_ptr, buf_size);
                    media_free_ext_buffer(MOD_MMI, (void **)&buf_ptr);
                }
                switch (gdi_ret)
                {
                    case GDI_SUCCEED:
                        ret = SRV_UC_RESIZING_SUCCEED;
                        break;
                    case GDI_IMAGE_ENCODER_ERR_DISK_FULL:
                        ret = SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_DISK_FULL;
                        break;
                    case GDI_IMAGE_ENCODER_ERR_WRITE_PROTECTION:
                        ret = SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_WRITE_PROTECTION;
                        break;
                    case GDI_IMAGE_ENCODER_ERR_NO_DISK:
                        ret = SRV_UC_RESIZING_FAILED_IN_GDI_ENCODER_ERR_NO_DISK;
                        break;
                    default:
                        ret = SRV_UC_RESIZING_FAILED_IN_GDI_FAILED;
                }
            }
            else
            {
                /* -12: can't allocate gdi_layer for drawing image */
                ret = SRV_UC_RESIZING_FAILED_IN_INSUFFICIENT_DRAWING_BUF;
            }
        }
        else
        {
            /* the dimension of the original image is smaller */
            ret = SRV_UC_RESIZING_SUCCEED_WITH_UNCHANGED;
        }
    }
    else
    {
        /* -11: can't get the image dimension */
        ret = SRV_UC_RESIZING_FAILED_IN_UNKNOWN_DIMENSION;
    }
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_RESIZE_IMG_RET_P1, ret);
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_image_object_resize_process_before_resolution_verification
 * DESCRIPTION
 *  
 * PARAMETERS
 *  file_path       [?]         
 *  is_short        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_handle_image_object_resize_process_before_resolution_verification(U16 *file_path, BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
	S32 img_width = 0, img_height = 0;
    U16 *filePath = (U16*) g_uc_p->srv_main->file_path;
#ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__
    srv_uc_object_type object_type = SRV_UC_OBJECT_TYPE_IMAGE;
#endif
#ifdef __MMI_OP02_LEMEI__
    S32 Lemei_image_size  = 102400;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	gdi_image_get_dimension_file((PS8) file_path, &img_width, &img_height);
	if ((img_width != 0) && (img_height != 0))
    {
        /* calculate the dimension of the resize JPEG */
        if (((S32) img_width > (S32) g_uc_p->srv_mms_info->image_resize.width) || ((S32) img_height > (S32) g_uc_p->srv_mms_info->image_resize.height))
        {
			mmi_uc_set_group_id();
			mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
			mmi_uc_entry_processing_generic();
		}
	}
#ifdef __MMI_UC_MMS_IMG_RESOLUTION__
    if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED  &&
            !(g_uc_p->srv_mms_info->image_resize.enable))
    {
        mms_get_max_image_resolution_in_restricted_mode(
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.width)),
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.height)));
    }
#endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 

    {
    #ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__

        {
            S32 left_size = 0;
            MMI_BOOL flag_for_restricted_popup = (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
                                                  mms_get_max_msg_size_in_restricted_mode() <=
                                                  g_uc_p->srv_mms_info->max_mms_size) ? MMI_TRUE : MMI_FALSE;
            U32 max_mms_size =
                (flag_for_restricted_popup) ? mms_get_max_msg_size_in_restricted_mode() : g_uc_p->srv_mms_info->
                max_mms_size;

            if (!mmi_uc_is_valid_image(filePath))
            {
                mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                mmi_uc_reset_msg();
                return;
            }

            /* gdi_image_get_dimension_file here should be return ok, becasue if not ok, already return in previous check */
            gdi_image_get_dimension_file(
                (PS8) filePath,
                (S32*) & (g_uc_p->main.resized_w),
                (S32*) & (g_uc_p->main.resized_h));
            srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);

            left_size = max_mms_size - g_uc_p->srv_msg->msg_size
                - mma_uc_calc_object_overhead_size(
                    MMA_INSERT_IMAGE,
                    (PU16) mmi_uc_image_path,
                    max_mms_size,
                    srv_uc_get_mms_type(g_uc_p->main.instance));

            if (left_size <= 0)
            {
            #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
            #ifdef WAP_SUPPORT
                if (srv_wap_prof_get_active_profile_connection_type((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) >
                    SRV_WAP_PROF_CONN_TYPE_HTTP)
            #else /* WAP_SUPPORT */ 
                if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) > BRW_PROF_CONN_TYPE_HTTP)
            #endif /* WAP_SUPPORT */ 
                {
                    mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
                }
                else
            #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
                {
                    (flag_for_restricted_popup) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                        mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                }
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }

            /* here, file path is = g_uc_p->srv_main->file_path */

#ifdef __MMI_OP02_LEMEI__
        	if((g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS) && (left_size > Lemei_image_size))
            {
                mmi_uc_auto_resize_img_handler
                    (mmi_uc_post_handler_handle_image_object_insert_if_file_path_exist_then_entry_editor, (U8*) filePath,
                     mmi_uc_image_path, srv_uc_convert_to_mms_insert_type(object_type), g_uc_p->main.resized_w,
                     g_uc_p->main.resized_h, Lemei_image_size, MMI_TRUE);
            }
            else
#endif
            {
                mmi_uc_auto_resize_img_handler
                    (mmi_uc_post_handler_handle_image_object_insert_if_file_path_exist_then_entry_editor, (U8*) filePath,
                     mmi_uc_image_path, srv_uc_convert_to_mms_insert_type(object_type), g_uc_p->main.resized_w,
                     g_uc_p->main.resized_h, left_size, MMI_TRUE);
            }


            return;
        }   /* */
    #else /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
        S32 resize_result;

        {
            if (!mmi_uc_is_valid_image(filePath))
            {
                mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                mmi_uc_reset_msg();
                return;
            }
            srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);
            resize_result = mmi_uc_resize_image(
                                (U8*) filePath,
                                mmi_uc_image_path,
                                g_uc_p->srv_mms_info->image_resize.width,
                                g_uc_p->srv_mms_info->image_resize.height);

            /* Error ! */
            if (resize_result < 0)
            {
                MMI_TRACE(
                    MMI_COMMON_TRC_G6_MSG,
                    TRC_MMI_UC_GET_MMS_SETTING_RSP_RESIZE_ERR_P2,
                    g_uc_p->srv_mms_info->image_resize.width,
                    g_uc_p->srv_mms_info->image_resize.height);

                mmi_uc_display_resize_result_popup((S32) resize_result);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                mmi_uc_reset_msg();
                return;
            }
            /* resized */
            else if (resize_result)
            {
                filePath = (PU16) mmi_uc_image_path;
                srv_uc_update_filepath_with_string(g_uc_p->main.instance, (S8*) mmi_uc_image_path);
            }
            /* resize_result == 0 means no need to resize */
            else    /* SRV_UC_RESIZING_SUCCEED_WITH_UNCHANGED= 0, filepath is still original one */
            {
                /* not use mmi_uc_display_resize_result_popup, because mmi_uc_entry_write_msg will let the popup disapper immediately */
                g_uc_p->srv_msg->display_no_resize = MMI_TRUE;
            }
        }
    #endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
    }   /* SRV_UC_OBJECT_TYPE_IMAGE */
    mmi_uc_post_handler_handle_image_object_insert_if_file_path_exist_then_entry_editor(
        MMA_INSERT_IMAGE,
        (U8*) g_uc_p->srv_main->file_path,
        (PU16) g_uc_p->srv_main->file_path);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_success_case_process_after_get_content_rsp
 * DESCRIPTION
 *  Process the rsp part of Get MMS content request as a callback.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_success_case_process_after_get_content_rsp(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->send_info.need_to_skip_popup = FALSE;
    switch (g_uc_p->srv_main->state)
    {
        case MMI_UC_STATE_EDIT_EXISTED_MSG:
         {
            /* In reply case, there is no content. */
            if (g_uc_p->srv_msg->msg_body.slide_no == 0)
            {
                g_uc_p->srv_msg->msg_body.curr_slide = srv_uc_insert_slide(g_uc_p->main.instance, NULL);
            }
            else
            {
                g_uc_p->srv_msg->msg_body.curr_slide = g_uc_p->srv_msg->msg_body.slides;            
            }                        
            
            g_uc_p->srv_msg->current_slide_num = g_uc_p->srv_msg->msg_body.curr_slide->slide_num;

            mmi_uc_change_msg_type_if_needed();

            /* Reset slide time if the msg type is changed to SMS */
            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
            {
                g_uc_p->srv_msg->msg_body.curr_slide->duration = g_uc_p->srv_mms_info->sliding_time.value;
            }
            else
            {
                /* tricky! disallow to insert signature for forward and send case */
                g_uc_p->srv_msg->auto_signature_inserted = MMI_TRUE;
            }
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__            
            /* (MMS template -> write msg) should be taken as write new msg case */
            if ((mma_get_box(g_uc_p->srv_send_info->existed_msg_id) == MMA_FOLDER_TEMPLATE ||
                 mma_get_box(g_uc_p->srv_send_info->existed_msg_id) == MMA_FOLDER_USRDEF_TEMPLATE))
            {
                g_uc_p->srv_main->state = MMI_UC_STATE_WRITE_NEW_MSG;
            }
#endif /* __MMI_MMS_TEMPLATE_SUPPORT__ */
        #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
            /* Editing archive MMS should be taken as write new msg case */
            if (mma_get_box(g_uc_p->srv_send_info->existed_msg_id) == MMA_FOLDER_ARCHIVE)
            {
                g_uc_p->srv_main->state = MMI_UC_STATE_WRITE_NEW_MSG;
            }                        
        #endif /* __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__ */

            mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
            srv_uc_update_msg_size(g_uc_p->main.instance);

            if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
            {
                mmi_uc_entry_write_msg();
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            }
            else
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT); 
                if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                {
                    mmi_uc_replace_screen(SCR_ID_UC_PROCESSING, SCR_ID_UC_EDITOR, (mmi_proc_func) mmi_uc_entry_write_msg, 0);
                }
                else
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT_DONNOTHING); 
                }
            }
        }
        break;
        case MMI_UC_STATE_REPLY:
        case MMI_UC_STATE_REPLY_ALL:
        {
            mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

            /* In reply case, there is no content. */
            if (g_uc_p->srv_msg->msg_body.slide_no == 0)
            {
                g_uc_p->srv_msg->msg_body.curr_slide = srv_uc_insert_slide(g_uc_p->main.instance, NULL);
            }
            else
            {
                g_uc_p->srv_msg->msg_body.curr_slide = g_uc_p->srv_msg->msg_body.slides;
            }

            g_uc_p->srv_msg->current_slide_num = g_uc_p->srv_msg->msg_body.curr_slide->slide_num;

            mmi_uc_change_msg_type_if_needed();

            /* Reset slide time if the msg type is changed to SMS */
            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
            {
                g_uc_p->srv_msg->msg_body.curr_slide->duration = g_uc_p->srv_mms_info->sliding_time.value;
            }

            pass_sig_check = mmi_uc_insert_signature_check();
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__
            /* (MMS template -> write msg) should be taken as write new msg case */
            if (g_uc_p->srv_main->state == MMI_UC_STATE_EDIT_EXISTED_MSG &&
                (mma_get_box(g_uc_p->srv_send_info->existed_msg_id) == MMA_FOLDER_TEMPLATE ||
                 mma_get_box(g_uc_p->srv_send_info->existed_msg_id) == MMA_FOLDER_USRDEF_TEMPLATE))
            {
                g_uc_p->srv_main->state = MMI_UC_STATE_WRITE_NEW_MSG;
            }
#endif /* __MMI_MMS_TEMPLATE_SUPPORT__*/
        #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
            /* Editing archive MMS should be taken as write new msg case */
            if (g_uc_p->srv_main->state == MMI_UC_STATE_EDIT_EXISTED_MSG &&
                mma_get_box(g_uc_p->srv_send_info->existed_msg_id) == MMA_FOLDER_ARCHIVE)
            {
                g_uc_p->srv_main->state = MMI_UC_STATE_WRITE_NEW_MSG;
            }
        #endif /* __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__ */ 

            /* mmi_uc_change_msg_type_if_needed(); */

            mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
            srv_uc_update_msg_size(g_uc_p->main.instance);
            if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
            {
                g_uc_p->send_info.need_to_skip_popup = TRUE;
            }
            if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
            {
                mmi_uc_entry_write_msg();
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            }
            else
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT);
                if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                {
                    mmi_uc_replace_screen(SCR_ID_UC_PROCESSING, SCR_ID_UC_EDITOR, (mmi_proc_func) mmi_uc_entry_write_msg, 0);
                }
                else
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT_DONNOTHING);
                }
            }
            if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
            {
                mmi_uc_sig_setSoftkeyFunction(
                    mmi_uc_process_warning_mode_insert_signature_for_yes,
                    mmi_uc_process_warning_mode_insert_signature_for_back,
                    (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
                mmi_uc_entry_sig_displayConfirm_generic();
            }
        }
            break;

        case MMI_UC_STATE_FORWARD:
        case MMI_UC_STATE_SEND:
        {
            g_uc_p->srv_msg->msg_body.curr_slide = g_uc_p->srv_msg->msg_body.slides;

            /* In forward case, there is no content. */
            if (g_uc_p->srv_msg->msg_body.curr_slide)
            {
                g_uc_p->srv_msg->current_slide_num = g_uc_p->srv_msg->msg_body.curr_slide->slide_num;
            }

            /* mmi_uc_change_msg_type_if_needed(); */
            g_uc_p->srv_msg_type->caller_specific_msg_type = MMI_UC_MSG_TYPE_MMS_ONLY;
            g_uc_p->srv_msg_type->curr_msg_type = MMI_UC_MSG_TYPE_MMS_PREFER;

            g_uc_p->done.pre_msg_type = g_uc_p->srv_msg_type->curr_msg_type;

            /* tricky! disallow to insert signature for forward and send case */
            g_uc_p->srv_msg->auto_signature_inserted = MMI_TRUE;

            mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
            srv_uc_update_msg_size(g_uc_p->main.instance);

            if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
            {
                mmi_uc_pre_process_send_to();
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            }
            else
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT);

                if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                {
				#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                    mmi_uc_replace_screen(SCR_ID_UC_PROCESSING, SCR_ID_UC_EDITOR, (mmi_proc_func) mmi_uc_entry_write_msg, 0);
                #else
                    mmi_uc_replace_screen(SCR_ID_UC_PROCESSING, SCR_ID_UC_OPT_ADD_RECIPIENT, (mmi_proc_func) mmi_uc_entry_add_recipient, 0);
                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                            
                }
                else
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT_DONNOTHING);
                }
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        }
            break;

        default:
        {
            MMI_ASSERT(0);
        }
            break;
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_message_size_callback
 * DESCRIPTION
 *  Return msg size
 * PARAMETERS
 *  current_text_info       [?]         
 *  uce_msg_type            [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_get_message_size_callback(wgui_uce_text_info_struct *current_text_info, wgui_uce_msg_type_enum uce_msg_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 msg_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_msg->msg_body.curr_slide != NULL)
    {
        /* For better performance, only update text buffer to text object when char count is one or zero */
        /* That is, text object is existed or not. */
        if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count == 1 ||
            g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count == 0)
        {
            mmi_uc_exit_write_msg();
            srv_uc_update_msg_size(g_uc_p->main.instance);
        }
    }

    /* postcard will display character num instead of size */
    if ((uce_msg_type == WGUI_UCE_MSG_TYPE_SMS)
#ifdef __MMI_MMS_POSTCARD__
        || ((uce_msg_type == WGUI_UCE_MSG_TYPE_MMS) &&
            (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS))
#endif /* __MMI_MMS_POSTCARD__ */ 
        )
    {
        msg_size = current_text_info->char_count;
    }
    else if (uce_msg_type == WGUI_UCE_MSG_TYPE_MMS)
    {
        msg_size = current_text_info->utf8_msg_len + g_uc_p->srv_msg->msg_size_without_text_buffer;
    }
    else
    {
        MMI_ASSERT(0);
    }

    if (mmi_uc_change_msg_type_if_needed())
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_START_TIMER_TO_CHANGE_MSG_TYPE);
        StartTimer(UC_MSG_TYPE_CHECK_TIMER_ID, MMI_UC_MSG_TYPE_CHECK_TIME, mmi_uc_disply_msg_type_change);
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if(g_uc_p->main.max_recipient_fields == 1)
        {
            g_uc_p->main.max_recipient_fields++;
        }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    }

    return msg_size;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_signature_insertion_fail
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_signature_insertion_fail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_FAIL_TO_INSERT_SIGNATURE_ID)), MMI_EVENT_FAILURE, NULL);
    g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_SUCCESS;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_signature_object_missed
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_signature_object_missed(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_SIGNATURE_OBJECT_MISSED_ID)), MMI_EVENT_ERROR, NULL);
    g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_SUCCESS;
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_dummy_screen
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_dummy_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_DUMMY_START);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_text_before_change_slide
 * DESCRIPTION
 *  Pre-entry function before changing slide using arrow keys
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_save_text_before_change_slide(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_exit_write_msg();
    if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
    {
        mmi_uc_entry_dummy_screen();
        return MMI_TRUE;
    }
    else
    {
        if (g_uc_p->srv_main->current_text_file_save_result == FS_DISK_FULL)
        {
            mmi_popup_display((WCHAR*)(get_string(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
        else
        {
            mmi_popup_display((WCHAR*)(get_string(srv_fmgr_fs_error_get_string(g_uc_p->srv_main->current_text_file_save_result))), MMI_EVENT_FAILURE, NULL);
        }
        return MMI_FALSE;
    }
}


#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_dummy_func
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_dummy_func(void)
{
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_semi_colon_location
 * DESCRIPTION
 *  Find the location of ; in a UCS2 string
 * PARAMETERS
 *  U16*
 * RETURNS
 *  void
 *****************************************************************************/
U16* mmi_uc_get_semi_colon_location(U16* ucs2_string)
{
    if(!ucs2_string)
    {
        ASSERT(0);
    }

    while(*ucs2_string)
    {
        if(*ucs2_string == 0x003b || *ucs2_string == 0xff1b)
        {
            return ucs2_string;
        }
        ucs2_string++;
    }
    return (U16 *)NULL;
}

#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_highlighted_object_handler
 * DESCRIPTION
 *  UCE callback function to get the highlighted region
 * PARAMETERS
 *  state       [IN]        Highlighted region
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_highlighted_object_handler(wgui_uce_highlight_state_enum state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_OBJECT_HIGHLIGHT_P1, state);
    switch (state)
    {
        case WGUI_UCE_HIGHLIGHT_SUBJECT:
            g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_SUBJECT;
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            //SetKeyHandler(mmi_uc_dummy_func, KEY_ENTER, KEY_EVENT_UP);
            ChangeCenterSoftkey(0, 0);
            SetCenterSoftkeyFunction(mmi_uc_dummy_func, KEY_EVENT_UP);
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
            break;
        case WGUI_UCE_HIGHLIGHT_THUMBNAIL:
            g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_THUMBNAIL;
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            //SetKeyHandler(mmi_uc_play_highlighted_object, KEY_ENTER, KEY_EVENT_UP);
            ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
            SetCenterSoftkeyFunction(mmi_uc_play_highlighted_object, KEY_EVENT_UP);
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
            break;
        case WGUI_UCE_HIGHLIGHT_EDITOR:
            g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_EDITOR;
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            //SetKeyHandler(mmi_uc_dummy_func, KEY_ENTER, KEY_EVENT_UP);
            ChangeCenterSoftkey(0, 0);
            SetCenterSoftkeyFunction(mmi_uc_dummy_func, KEY_EVENT_UP);
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
            break;
        default:
            g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_NONE;
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_change_slide_handler
 * DESCRIPTION
 *  UCE callback function to change slide using arrow keys
 * PARAMETERS
 *  change_slide        [IN]        Goto next or previous slide
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_change_slide_handler(wgui_uce_change_slide_enum change_slide)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_SLIDE_CHANGE_P1, change_slide);
    if (change_slide == WGUI_UCE_CHANGE_SLIDE_NEXT && g_uc_p->srv_msg->msg_body.curr_slide->next)
    {
        if (mmi_uc_save_text_before_change_slide())
        {
            mmi_uc_entry_next_slide();
        }
    }
    else if (change_slide == WGUI_UCE_CHANGE_SLIDE_PREVIOUS && g_uc_p->srv_msg->msg_body.curr_slide->prev)
    {
        if (mmi_uc_save_text_before_change_slide())
        {
            mmi_uc_entry_previous_slide();
        }
    }
}

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_to_label_cb_func
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_to_label_cb_func(void)
{
    mmi_uc_search_phb_recipient();
    return;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_highlighted_object_handler
 * DESCRIPTION
 *  UCE callback function to get the highlighted region
 * PARAMETERS
 *  state       [IN]        Highlighted region
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_highlighted_object_handler_ext(wgui_uce_highlight_state_enum state, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_OBJECT_HIGHLIGHT_P1, state);
    switch (state)
    {
    case WGUI_UCE_HIGHLIGHT_TO_RECIPIENTS:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_TO_RECIPIENT;
		g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_TO;
        //SetKeyHandler(mmi_uc_search_phb_recipient, KEY_ENTER, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_uc_search_phb_recipient, KEY_EVENT_UP);
        break;
    case WGUI_UCE_HIGHLIGHT_CC_RECIPIENTS:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_CC_RECIPIENT;
		g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_CC;
        //SetKeyHandler(mmi_uc_search_phb_recipient, KEY_ENTER, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_uc_search_phb_recipient, KEY_EVENT_UP);
        break;
    case WGUI_UCE_HIGHLIGHT_BCC_RECIPIENTS:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_BCC_RECIPIENT;
		g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_BCC;
        //SetKeyHandler(mmi_uc_search_phb_recipient, KEY_ENTER, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_uc_search_phb_recipient, KEY_EVENT_UP);
        break;
    case WGUI_UCE_HIGHLIGHT_SUBJECT:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_SUBJECT;
        //SetKeyHandler(mmi_uc_dummy_func, KEY_ENTER, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, 0);
        SetCenterSoftkeyFunction(mmi_uc_dummy_func, KEY_EVENT_UP);
        break;
    case WGUI_UCE_HIGHLIGHT_THUMBNAIL:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_THUMBNAIL;
        //SetKeyHandler(mmi_uc_play_highlighted_object, KEY_ENTER, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_uc_play_highlighted_object, KEY_EVENT_UP);
        break;
    case WGUI_UCE_HIGHLIGHT_AUDIO:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_AUDIO;
        //SetKeyHandler(mmi_uc_play_highlighted_object, KEY_ENTER, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_uc_play_highlighted_object, KEY_EVENT_UP);
        break;
    case WGUI_UCE_HIGHLIGHT_EDITOR:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_EDITOR;
        //SetKeyHandler(mmi_uc_dummy_func, KEY_ENTER, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, 0);
        SetCenterSoftkeyFunction(mmi_uc_dummy_func, KEY_EVENT_UP);
        break;
    default:
        g_uc_p->main.highlight_state = MMI_UC_HIGHLIGHT_NONE;
        break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_convert_group_to_region
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
wgui_uce_region_id_enum mmi_uc_convert_group_to_region(srv_uc_address_group_type_enum group)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(group)
    {
        case SRV_UC_ADDRESS_GROUP_TYPE_TO:
            return WGUI_UCE_TO_RECIPIENTS;

        case SRV_UC_ADDRESS_GROUP_TYPE_CC:
            return WGUI_UCE_CC_RECIPIENTS;

        case SRV_UC_ADDRESS_GROUP_TYPE_BCC:
            return WGUI_UCE_BCC_RECIPIENTS;

        default :
            return WGUI_UCE_TO_RECIPIENTS;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_get_recipient_position
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
S32 mmi_uc_add_get_recipient_position(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 count, check, found = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (check = 0; check < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; check++)
    {
        for (count = 0; count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
        {
            if(g_uc_p->main.recipient_info[count].app_mapping_index == check)
            {
                found = 1;
                break;
            }
        }
        if(found)
        {
            found = 0;
        }
        else
        {
            return check;
        }
    }
    return -1;
//    mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[count], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_warning_mode_insert_signature
 * DESCRIPTION
 *  process insert signature for warning mode confirm popup
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_warning_mode_insert_signature_to_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_process_insert_signature();
    mmi_uc_entry_displayConfirm_generic();
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIG_CONFIRM);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_warning_mode_insert_signature
 * DESCRIPTION
 *  process insert signature for warning mode confirm popup
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_warning_mode_insert_signature_to_send_back(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_entry_displayConfirm_generic();
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIG_CONFIRM);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_shift_recipients_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_uc_shift_recipients_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_region_id_enum region;
    U32 count, slot_found = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    region = mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type);
    for (count = g_uc_p->main.recipient_count; count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        if((mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[count].input_buf) == 0 && 
            g_uc_p->main.recipient_info[count].region_id == region) ||
            g_uc_p->main.recipient_info[count].is_valid == MMI_FALSE)
        {
            slot_found = 1;
            break;
        }
    }

    if(slot_found)
    {
        for(; count > g_uc_p->main.recipient_count; count--)
        {
            U32 length = mmi_ucs2strlen((S8*) g_uc_p->main.recipient_buffer[count - 1]);
            g_uc_p->main.recipient_info[count].is_valid = g_uc_p->main.recipient_info[count - 1].is_valid;
            g_uc_p->main.recipient_info[count].editor_flags = g_uc_p->main.recipient_info[count - 1].editor_flags;
            g_uc_p->main.recipient_info[count].region_id = g_uc_p->main.recipient_info[count - 1].region_id;
            g_uc_p->main.recipient_info[count].app_mapping_index = g_uc_p->main.recipient_info[count - 1].app_mapping_index;
            if(length)
            {
                mmi_ucs2ncpy((S8*) g_uc_p->main.recipient_buffer[count], (S8*) g_uc_p->main.recipient_buffer[count - 1], length);
            }
            else
            {
                memset(g_uc_p->main.recipient_buffer[count], 0, (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
            }
        }
    }
    else
    {
        return MMI_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_valid_recipient
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_uc_is_valid_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!srv_uc_is_email_addr_valid(g_uc_p->done.to))
    {
        if (!srv_uc_is_phone_number_valid((S8*) g_uc_p->done.to))
        {
            return MMI_FALSE;
        }
        else
        {
            if(mmi_ucs2strlen((S8*) g_uc_p->done.to) > (MMI_UC_MAX_PHONE_NUMBER_LEN))
            {
                return MMI_FALSE;
            }
            return MMI_TRUE;
        }
    }
    else
    {
        if (mmi_ucs2strlen((S8*) g_uc_p->done.to) > (MMI_UC_MAX_EMAIL_LEN))
        {
            return MMI_FALSE;
        }
        return MMI_TRUE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_recipient_field_available_count
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_get_recipient_field_available_count(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count, available_count = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (count = 0; count< WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        if(g_uc_p->main.recipient_info[count].is_valid == MMI_FALSE ||
            (g_uc_p->main.recipient_info[count].region_id == region_id && 
            mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[count].input_buf) == 0))
        {
            available_count++;
        }
    }
    return available_count;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_phb_entry_to_buffer
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
void mmi_uc_add_phb_entry_to_buffer(S32 pos, U32 count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.recipient_info[count].region_id = mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type);
    g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
    g_uc_p->main.recipient_info[count].editor_flags = WGUI_UCE_WRAPPING_DELETE_RECIPIENT;
    g_uc_p->main.recipient_info[count].app_mapping_index = pos;
    mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_info[count].input_buf, (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
    mmi_ucs2cat((char *) g_uc_p->main.recipient_info[count].input_buf, (const char *) ";\0");
    if (wgui_cat280_get_highlight_buffer_index() == count)
    {
        wgui_cat280_is_recipient_changed(MMI_TRUE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_recipient_to_buffer
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
void mmi_uc_add_recipient_to_buffer(wgui_uce_region_id_enum region)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count, check = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (count = 0; count< WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        if(mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[count].input_buf) == 0 && 
            ( g_uc_p->main.recipient_info[count].region_id == region ||
            g_uc_p->main.recipient_info[count].is_valid == MMI_FALSE))
        {
            if(check)
            {
                mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_info[count].input_buf, (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
                g_uc_p->main.recipient_info[count].region_id = region;
                g_uc_p->main.recipient_info[count].editor_flags = WGUI_UCE_WRAPPING_DELETE_RECIPIENT;
                check = 0;
            }
            else
            {
                g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
                g_uc_p->main.recipient_info[count].region_id = region;
                g_uc_p->main.recipient_info[count].editor_flags = 0;
                break;
            }
        }
    }
    //wgui_cat280_add_recipient(region, (UI_string_type)g_uc_p->done.to, 0, MMI_TRUE);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_buffer_recipient_count
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_get_buffer_recipient_count(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count, recipient_count = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (count = 0; count< WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        if(g_uc_p->main.recipient_info[count].is_valid == MMI_TRUE && 
            mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[count].input_buf))
        {
            recipient_count++;
        }
    }
    return recipient_count;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_max_fields
 * DESCRIPTION
 *  
 * PARAMETERS
 *  index [IN]
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_display_max_fields(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_MAX_RECIPIENT_FIELDS_ID)), MMI_EVENT_ERROR, NULL);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_recipient_change_callback
 * DESCRIPTION
 *  Check whether a valid recipient is added to the editor
 * PARAMETERS
 *  index [IN]
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_recipient_change_callback(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[index].input_buf))
    {
        g_uc_p->main.recipient_info[index].is_valid = MMI_TRUE;
        g_uc_p->main.recipient_info[index].region_id = mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type);
    }
    if (mmi_uc_change_msg_type_if_needed())
    {
        if(!g_uc_p->main.prev_msg_type)
        {
            g_uc_p->main.prev_msg_type = g_uc_p->srv_msg_type->curr_msg_type;
        }
        StartTimer(UC_MSG_TYPE_CHECK_TIMER_ID, MMI_UC_MSG_TYPE_CHECK_TIME, mmi_uc_disply_msg_type_change);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_email_recipient_present
 * DESCRIPTION
 *  Check whether a valid email ID is present in the editor
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_is_email_recipient_present(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (count = 0; count< WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        if(g_uc_p->main.recipient_info[count].is_valid == MMI_TRUE && 
            mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[count].input_buf))
        {
            memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
            if(g_uc_p->main.recipient_info[count].app_mapping_index != -1)
            {
                mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)g_uc_p->main.recipient_value[g_uc_p->main.recipient_info[count].app_mapping_index],
                    mmi_ucs2strlen((S8*) g_uc_p->main.recipient_value[g_uc_p->main.recipient_info[count].app_mapping_index]));
            }
            else
            {
                U32 length = 0;
                char * loc = (char *)mmi_uc_get_semi_colon_location((U16*) g_uc_p->main.recipient_info[count].input_buf);

                if(loc)
                {
                    length = (loc - g_uc_p->main.recipient_info[count].input_buf)/ENCODING_LENGTH;
                }
                if(length)
                {
                    mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)g_uc_p->main.recipient_info[count].input_buf, length);
                }
                else
                {
                    if(loc)
                    {
                        continue;
                    }
                    else
                    {
                        mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)g_uc_p->main.recipient_info[count].input_buf, mmi_ucs2strlen((S8*) g_uc_p->main.recipient_info[count].input_buf));
                    }
                }
            }

            if (mmi_ucs2strlen((S8*) g_uc_p->done.to) == 0)
            {
                ASSERT(0);
            }

            if (!mmi_uc_is_email_addr_valid(g_uc_p->done.to))
            {
                /* Do Nothing */
            }
            else
            {
                    return MMI_TRUE;
            }
        }
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_valid_email_local_domain_part
 * DESCRIPTION
 *  This function is to check if the input str is valid email address
  * PARAMETERS
 *  str		[IN]	string being checked     
 * RETURNS
 *  MMI_TRUE or MMI_FALSE
 *****************************************************************************/
MMI_BOOL mmi_uc_is_valid_email_local_domain_part(char *str)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    char c;
    S32 pos, len;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (str == NULL)
    {
        return MMI_FALSE;
    }

    /* get the str len */
    len = 0;
    while(str[len] != '\0')
    {
        len++;
    }
    if (len < 3)
    {
        return MMI_FALSE;
    }

    /* find the '@' position */
    pos = 0;
    while(pos < len)
    {
        c = str[pos];
        if (c == '@')
        {
            break;
        }
        pos++;
    }

    if (pos == 0 || pos >= len - 1)
    {
        /* '@' at first or last or no '@' */
        return MMI_FALSE;
    }

    if (!applib_is_valid_email_local_part(str, pos))
    {
        /* local part invalid */
        return MMI_FALSE;
    }

    if (!applib_is_valid_email_domain_name(str + pos + 1))
    {
        return MMI_FALSE;
    }

    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_email_addr_valid
 * DESCRIPTION
 *  Return if email address valid
 * PARAMETERS
 *  addr                [?]         
 *  screen_id(?)        [IN]        
 * RETURNS
 *  kal_bool
 *****************************************************************************/
MMI_BOOL mmi_uc_is_email_addr_valid(U8 *addr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 email_addr_len = mmi_ucs2strlen((S8*) addr);
    U16 i = 0;
    U16 *email_addr = (U16*) addr;
    U16 j = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (; i < email_addr_len; i++)
    {
        if (mmi_ucs2ncmp((S8*) & email_addr[i], (S8*) L"@", 1) == 0)
        {
            if (i == 0 || i == (email_addr_len - 1))
            {
                return MMI_FALSE;
            }
            else
            {
                U8 *ascii_addr = NULL;

                for (; j < email_addr_len; j++)
                {
                    U16 ucs2_char = email_addr[j];

                    /* non-ascii char */
                    if ((ucs2_char & 0xFF00) > 0)
                    {
                        return MMI_FALSE;
                    }
                }

                ascii_addr = OslMalloc(email_addr_len + 1);
                memset(ascii_addr, 0, (email_addr_len + 1));

                mmi_ucs2_n_to_asc((S8*) ascii_addr, (S8*) addr, email_addr_len * ENCODING_LENGTH);

                if (mmi_uc_is_valid_email_local_domain_part((char*)ascii_addr) == KAL_TRUE)
                {
                    OslMfree(ascii_addr);
                    return MMI_TRUE;
                }

                OslMfree(ascii_addr);
                return MMI_FALSE;
            }
        }
    }

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_pending_recipient_in_editor
 * DESCRIPTION
 *  Check whether a vlid recipient is present in the editor
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_is_pending_recipient_in_editor(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (count = 0; count< WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        if(g_uc_p->main.recipient_info[count].is_valid == MMI_TRUE && 
            mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[count].input_buf))
        {
            memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
            mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)g_uc_p->main.recipient_info[count].input_buf, mmi_ucs2strlen((S8*) g_uc_p->main.recipient_info[count].input_buf));
            if (mmi_ucs2strlen((S8*) g_uc_p->done.to) == 0)
            {
                ASSERT(0);
            }

            if (!srv_uc_is_email_addr_valid(g_uc_p->done.to))
            {
                if (!srv_uc_is_phone_number_valid((S8*) g_uc_p->done.to))
                {
                    /* Do Nothing */
                }
                else
                {
                    return MMI_TRUE;
                }
            }
            else
            {
                    return MMI_TRUE;
            }
        }
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_recipient
 * DESCRIPTION
 *  Add recipient to the recipient list
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_add_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((S8*) g_uc_p->done.to) == 0)
    {
        ASSERT(0);
    }

    if (!srv_uc_is_email_addr_valid(g_uc_p->done.to))
    {
        if (!srv_uc_is_phone_number_valid((S8*) g_uc_p->done.to))
        {
            if(g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND &&
                g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW)
            {
                if(g_uc_p->main.operation)
                {
                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_INPUT)), MMI_EVENT_ERROR, NULL);
                    g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].editor_flags = WGUI_UCE_HIGHLIGHT_RECIPIENT;
                    g_uc_p->main.recipient_count = 0;
                }
                else
                {
                 #ifdef __MMI_UC_MULTI_SELECT__                    
                    mmi_uc_search_name();
                 #else
                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_INPUT)), MMI_EVENT_ERROR, NULL);
                 #endif
                }
                return MMI_FALSE;
            }
            return MMI_TRUE;
        }
        else
        {
            if(mmi_ucs2strlen((S8*) g_uc_p->done.to) > (MMI_UC_MAX_PHONE_NUMBER_LEN))
            {
                if(g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND &&
                    g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW)
                {
                    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NUMBER_LENGTH_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
                     g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].editor_flags = WGUI_UCE_HIGHLIGHT_RECIPIENT;
                    g_uc_p->main.recipient_count = 0;
                    return MMI_FALSE;
                }
                return MMI_TRUE;
            }
            g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_NUMBER;
            if(!mmi_uc_addr_add_number_done())
                return MMI_FALSE;
        }
    }
    else
    {
        if (mmi_ucs2strlen((S8*) g_uc_p->done.to) > (MMI_UC_MAX_EMAIL_LEN))
        {
            if(g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND &&
                g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW)
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ADDR_LENGTH_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
                    g_uc_p->main.recipient_count = 0;
                    return MMI_FALSE;
            }
            return MMI_TRUE;
        }
        g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_EMAIL;
        if(!mmi_uc_addr_add_email_done())
            return MMI_FALSE;
    }
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_remove_empty_recipients
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_remove_empty_recipients(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 count, to_num = 0, cc_num = 0, bcc_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for(count = 0; count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        if(g_uc_p->main.recipient_info[count].is_valid == MMI_TRUE)
        {
            switch(g_uc_p->main.recipient_info[count].region_id)
            {
                case WGUI_UCE_BCC_RECIPIENTS:
                    bcc_num++;
                    break;
                case WGUI_UCE_CC_RECIPIENTS:
                    cc_num++;
                    break;
                case WGUI_UCE_TO_RECIPIENTS:
                    to_num++;
                    break;
            }
        }
    }

    for(count = WAP_CUSTOM_CFG_MAX_MMS_ADDRESS - 1; count >= 0; count--)
    {
        if(g_uc_p->main.recipient_info[count].is_valid == MMI_TRUE && 
            g_uc_p->main.recipient_info[count].app_mapping_index == -1 &&
            (mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[count].input_buf) == 0 ||
            ((U8 *)mmi_uc_get_semi_colon_location((U16*)g_uc_p->main.recipient_info[count].input_buf) == g_uc_p->main.recipient_info[count].input_buf)))
        {
            switch(g_uc_p->main.recipient_info[count].region_id)
            {
                case WGUI_UCE_BCC_RECIPIENTS:
                    if(bcc_num > 1)
                    {
                        wgui_cat280_remove_recipient(count);
                        bcc_num--;
                    }
                    else
                    {
                        g_uc_p->main.recipient_info[count].editor_flags = 0;
                        if ((wgui_cat280_get_highlight_state() == WGUI_UCE_BCC_RECIPIENTS) &&
                            (wgui_cat280_get_highlight_buffer_index() == count))
                        {
                            gdi_layer_lock_frame_buffer();
                        wgui_inputs_sl_delete_all_characters();
                            gdi_layer_unlock_frame_buffer();
                        }
                        memset(g_uc_p->main.recipient_buffer[count], 0, (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
                    }
                    break;
                case WGUI_UCE_CC_RECIPIENTS:
                    if(cc_num > 1)
                    {
                        wgui_cat280_remove_recipient(count);
                        cc_num--;
                    }
                    else
                    {
                        g_uc_p->main.recipient_info[count].editor_flags = 0;
                        if ((wgui_cat280_get_highlight_state() == WGUI_UCE_CC_RECIPIENTS) &&
                            (wgui_cat280_get_highlight_buffer_index() == count))
                        {
                            gdi_layer_lock_frame_buffer();
                        wgui_inputs_sl_delete_all_characters();
                            gdi_layer_unlock_frame_buffer();
                        }
                        memset(g_uc_p->main.recipient_buffer[count], 0, (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
                    }
                    break;
                case WGUI_UCE_TO_RECIPIENTS:
                    if(to_num > 1)
                    {
                        wgui_cat280_remove_recipient(count);
                        to_num--;
                    }
                    else
                    {
                        g_uc_p->main.recipient_info[count].editor_flags = 0;
                        if ((wgui_cat280_get_highlight_state() == WGUI_UCE_TO_RECIPIENTS) &&
                            (wgui_cat280_get_highlight_buffer_index() == count))
                        {
                            gdi_layer_lock_frame_buffer();
                        wgui_inputs_sl_delete_all_characters();
                            gdi_layer_unlock_frame_buffer();
                        }
                        memset(g_uc_p->main.recipient_buffer[count], 0, (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
                    }
                    break;
            }
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_recipient_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_get_recipient_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!g_uc_p->main.recipient_count)
    {
        srv_uc_delete_all_addr(g_uc_p->main.instance);
    }
//    g_uc_p->send_info.change_in_recipient_list = TRUE;
    for (; g_uc_p->main.recipient_count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; g_uc_p->main.recipient_count++)
    {
        if(g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].is_valid == MMI_TRUE && 
            mmi_ucs2strlen((S8*)g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].input_buf))
        {
            if(g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].app_mapping_index != -1)
            {
                mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)g_uc_p->main.recipient_value[g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].app_mapping_index],
                    mmi_ucs2strlen((S8*) g_uc_p->main.recipient_value[g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].app_mapping_index]));
            }
            else
            {
                U32 length = 0;
                char * loc = (char *)mmi_uc_get_semi_colon_location((U16*) g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].input_buf);

                memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
                if(loc)
                {
                    length = (loc - g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].input_buf)/ENCODING_LENGTH;
                }
                if(length)
                {
                    mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].input_buf, length);
                }
                else
                {
                    if(loc)
                    {
                        continue;
                    }
                    else
                    {
                        mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].input_buf, mmi_ucs2strlen((S8*) g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].input_buf));
                    }
                }
            }

            if(g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].region_id == WGUI_UCE_TO_RECIPIENTS)
            {
                g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_TO;
            }
            else if(g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].region_id == WGUI_UCE_CC_RECIPIENTS)
            {
                g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_CC;
            }
            else if(g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].region_id == WGUI_UCE_BCC_RECIPIENTS)
            {
                g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_BCC;
            }
            if(!mmi_uc_add_recipient())
            {
                return MMI_FALSE;
            }
        }
    }
    g_uc_p->main.recipient_count = 0;

/*
    if(g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND &&
                g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW)
    {
        if (mmi_uc_change_msg_type_if_needed())
        {
            mmi_uc_disply_msg_type_change();
        }
    }
*/
    srv_uc_update_msg_size(g_uc_p->main.instance);
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_recipient_if_not_present
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_uc_add_recipient_if_not_present(wgui_uce_region_id_enum region)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 count;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	for(count = 0; count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
	{
        if(g_uc_p->main.recipient_info[count].is_valid == MMI_TRUE &&
            g_uc_p->main.recipient_info[count].region_id)
        {
            if(g_uc_p->main.recipient_info[count].region_id == region)
            {
                return MMI_TRUE;
            }
        }
        else
        {
            break;
        }
	}
    if(count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS)
    {
        memset(g_uc_p->main.recipient_buffer[count], 0, (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
	    g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
	    g_uc_p->main.recipient_info[count].region_id = region;
	    g_uc_p->main.recipient_info[count].editor_flags = 0;
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_recipient_buffer_from_context
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
void mmi_uc_get_recipient_buffer_from_context(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count, to_num = 0;
    srv_uc_addr_struct *temp_address = g_uc_p->srv_msg->to_head;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	memset(g_uc_p->main.recipient_info, 0, WAP_CUSTOM_CFG_MAX_MMS_ADDRESS * (sizeof(wgui_uce_recipients_struct)));
	memset(g_uc_p->main.recipient_buffer, 0, WAP_CUSTOM_CFG_MAX_MMS_ADDRESS * (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);

	for(count = 0; count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
	{
        g_uc_p->main.recipient_info[count].input_buf = g_uc_p->main.recipient_buffer[count];
        g_uc_p->main.recipient_info[count].app_mapping_index = -1;
	}

    count = 0;

    if(g_uc_p->srv_main->mode != SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
    while (temp_address)
    {
        if(temp_address->group == SRV_UC_ADDRESS_GROUP_TYPE_TO)
        {
            to_num++;
            break;
        }
        temp_address = temp_address->next;
    }
    }

    if(g_uc_p->srv_main->mode != SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
    temp_address = g_uc_p->srv_msg->to_head;
    }
	if(!to_num)
	{
		g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
        g_uc_p->main.recipient_info[count].region_id = WGUI_UCE_TO_RECIPIENTS;
        g_uc_p->main.recipient_info[count].editor_flags = 0;
        count++;
    }

    if(g_uc_p->srv_main->mode != SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
    while (temp_address && g_uc_p->srv_main->mode != SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
        U16 recipient_name[(MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH];
        S32 pos = 0;

        memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
		if(temp_address->type == SRV_UC_ADDRESS_TYPE_PHONE_NUMBER)
		{
			mmi_asc_n_to_ucs2((S8*) g_uc_p->done.to, (S8*)temp_address->addr, strlen((char*)temp_address->addr));
		}
		else if(temp_address->type == SRV_UC_ADDRESS_TYPE_EMAIL)
		{
            mmi_ucs2ncpy((S8*) g_uc_p->done.to, (S8*) temp_address->addr, mmi_ucs2strlen((S8*) temp_address->addr));
		}
		else
		{
			ASSERT(0);
		}

        memset(recipient_name, 0, (MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH);
/*
        if(g_uc_p->srv_main->state == MMI_UC_STATE_WRITE_NEW_MSG ||
            g_uc_p->srv_main->state == MMI_UC_STATE_REPLY ||
            g_uc_p->srv_main->state == MMI_UC_STATE_REPLY_ALL)
*/
        {
            srv_phb_get_name_by_number((U16 *)g_uc_p->done.to, recipient_name, MMI_UC_MAX_EMAIL_LEN);
            if(mmi_ucs2strlen((S8*) recipient_name) == 0)
            {
                mmi_ucs2ncpy((S8*)recipient_name, (S8*)g_uc_p->done.to, MMI_UC_MAX_EMAIL_LEN);
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                mmi_ucs2ncpy((S8*) g_uc_p->main.recipient_info[count].input_buf, (S8*) recipient_name, mmi_ucs2strlen((S8*) recipient_name));
                g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
                g_uc_p->main.recipient_info[count].editor_flags = 0;
                g_uc_p->main.recipient_info[count].app_mapping_index = -1;
            }
            else
            {
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                pos = mmi_uc_add_get_recipient_position();
                mmi_ucs2ncpy((S8*) g_uc_p->main.recipient_info[count].input_buf, (S8*) recipient_name, mmi_ucs2strlen((S8*) recipient_name));
                mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
                g_uc_p->main.recipient_info[count].editor_flags = WGUI_UCE_WRAPPING_DELETE_RECIPIENT;
                g_uc_p->main.recipient_info[count].app_mapping_index = pos;
            }
        }
/*
        else
        {
            mmi_ucs2ncpy((S8*)recipient_name, (S8*)g_uc_p->done.to, MMI_UC_MAX_EMAIL_LEN);
            mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
            mmi_ucs2ncpy((S8*) g_uc_p->main.recipient_info[count].input_buf, (S8*) recipient_name, mmi_ucs2strlen((S8*) recipient_name));
            g_uc_p->main.recipient_info[count].is_valid = MMI_TRUE;
            g_uc_p->main.recipient_info[count].editor_flags = 0;
            g_uc_p->main.recipient_info[count].app_mapping_index = -1;
        }
*/
        if(temp_address->group == SRV_UC_ADDRESS_GROUP_TYPE_TO)
        {
            g_uc_p->main.recipient_info[count].region_id = WGUI_UCE_TO_RECIPIENTS;
        }
        else if(temp_address->group == SRV_UC_ADDRESS_GROUP_TYPE_CC)
        {
            g_uc_p->main.recipient_info[count].region_id = WGUI_UCE_CC_RECIPIENTS;
			g_uc_p->main.cc_region_flag = 1;
        }
        else if(temp_address->group == SRV_UC_ADDRESS_GROUP_TYPE_BCC)
        {
            g_uc_p->main.recipient_info[count].region_id = WGUI_UCE_BCC_RECIPIENTS;
			g_uc_p->main.bcc_region_flag = 1;
        }
        temp_address = temp_address->next;
		count++;
    }
    }

    srv_uc_delete_all_addr(g_uc_p->main.instance);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_recipient_initialize
 * DESCRIPTION
 *  Initialize editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_recipient_initialize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_recipients_label_struct to_label;
    wgui_uce_recipients_label_struct *p_cc_label = NULL, cc_label;
    wgui_uce_recipients_label_struct *p_bcc_label = NULL, bcc_label;
    wgui_uce_subject_struct *p_subject = NULL, subject;
    //wgui_uce_recipients_struct recipients_buf[20];
    //S32 i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!g_uc_p->main.check_buffer_flag)
    {
    	mmi_uc_get_recipient_buffer_from_context();
        g_uc_p->main.check_buffer_flag = 1;
    }

#ifdef __MMI_FTE_SUPPORT__
    to_label.label_normal_image = get_image(IMG_UC_FTE_RECIPIENT_BUTTON_NORMAL_ID);
    to_label.label_pressed_image = get_image(IMG_UC_FTE_RECIPIENT_BUTTON_PRESSED_ID);
#else
    to_label.label_normal_image = get_image(IMG_UC_TO_BUTTON_ID);
    to_label.label_pressed_image = get_image(IMG_UC_TO_BUTTON_ID);
#endif /* __MMI_FTE_SUPPORT__ */
    to_label.label_callback = mmi_uc_to_label_cb_func;
	if(g_uc_p->main.cc_region_flag)
	{
        if(mmi_uc_add_recipient_if_not_present(WGUI_UCE_CC_RECIPIENTS))
        {
    #ifdef __MMI_FTE_SUPPORT__
		    cc_label.label_normal_image = get_image(IMG_UC_FTE_RECIPIENT_BUTTON_NORMAL_ID);
		    cc_label.label_pressed_image = get_image(IMG_UC_FTE_RECIPIENT_BUTTON_PRESSED_ID);
    #else
		    cc_label.label_normal_image = get_image(IMG_UC_CC_BUTTON_ID);
		    cc_label.label_pressed_image = get_image(IMG_UC_CC_BUTTON_ID);
    #endif /* __MMI_FTE_SUPPORT__ */
		    cc_label.label_callback = mmi_uc_to_label_cb_func;
		    p_cc_label = &cc_label;
        }
        else
        {
            g_uc_p->main.cc_region_flag = 0;
            g_uc_p->main.max_recipient_fields = 1;
        }
	}
	if(g_uc_p->main.bcc_region_flag)
	{
        if(mmi_uc_add_recipient_if_not_present(WGUI_UCE_BCC_RECIPIENTS))
        {
    #ifdef __MMI_FTE_SUPPORT__
		    bcc_label.label_normal_image = get_image(IMG_UC_FTE_RECIPIENT_BUTTON_NORMAL_ID);
		    bcc_label.label_pressed_image = get_image(IMG_UC_FTE_RECIPIENT_BUTTON_PRESSED_ID);
    #else
		    bcc_label.label_normal_image = get_image(IMG_UC_BCC_BUTTON_ID);
		    bcc_label.label_pressed_image = get_image(IMG_UC_BCC_BUTTON_ID);
    #endif /* __MMI_FTE_SUPPORT__ */
		    bcc_label.label_callback = mmi_uc_to_label_cb_func;
		    p_bcc_label = &bcc_label;
        }
        else
        {
            g_uc_p->main.bcc_region_flag = 0;
            g_uc_p->main.max_recipient_fields = 1;
        }
	}
/*lemei mms subject field hide*/
#ifdef __MMI_OP02_LEMEI__
	if(g_uc_p->srv_msg_type->MMS_edit_mode != MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
#endif
	{
		if(g_uc_p->main.subject_region_flag || mmi_ucs2strlen((S8*) g_uc_p->srv_msg->subject) > 0)
		{
			g_uc_p->main.subject_region_flag = 1;
			subject.buffer_size = MMI_UC_MAX_SUBJECT_LEN + 1;
			subject.input_buf = (UI_buffer_type) g_uc_p->srv_msg->subject;
			subject.input_type = IMM_INPUT_TYPE_SENTENCE;
			subject.label_string = get_string(STR_UC_WRITE_MSG_SUBJECT_ID);
			p_subject = &subject;
		}
   }

    wgui_uce_initialize_recipients(
        &to_label,
        p_cc_label,
        p_bcc_label,
        p_subject,
        g_uc_p->main.recipient_info,
        WAP_CUSTOM_CFG_MAX_MMS_ADDRESS,
        (MMI_UC_MAX_EMAIL_LEN + 2),
        IMM_INPUT_TYPE_SENTENCE,
        mmi_uc_highlighted_object_handler_ext);
}
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_editor_initialize
 * DESCRIPTION
 *  Initialize editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_editor_initialize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_get_sms_remaining_character_callback get_sms_rm_character = mmi_uc_sms_remaining_char_count;
    wgui_uce_get_sms_segment_callback get_sms_segment = mmi_uc_sms_segment_count;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_uce_initialize_editor(g_uc_p->srv_main->text_buffer,
                               SRV_UC_TEXT_BUFFER_SIZE / ENCODING_LENGTH,
                               g_uc_p->srv_msg->current_slide_num, g_uc_p->srv_msg->msg_body.slide_no,
#ifdef __MMI_MMS_POSTCARD__
                               SRV_POSTCARD_MAX_GREETING,
#else 
                               0,
#endif 
                               mmi_uc_get_message_size_callback,
                               mmi_uc_text_change_callback,
                               mmi_uc_display_type_callback,
                               get_sms_rm_character,
                               get_sms_segment, mmi_uc_highlighted_object_handler, mmi_uc_change_slide_handler);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_index
 * DESCRIPTION
 *  Set highlighted idnex
 * PARAMETERS
 *  hilited_index       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_set_index(S32 hilited_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.object_index = hilited_index;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_switch_slide
 * DESCRIPTION
 *  Switch slide
 * PARAMETERS
 *  slide       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_switch_slide(mma_mms_slide_struct *slide)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    srv_uc_reset_text_buffer(g_uc_p->main.instance);
    mmi_uc_editor_initialize();
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    mmi_uc_recipient_initialize();
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    mmi_uc_reset_history_guibuffer(SCR_ID_UC_EDITOR);

    if (slide != NULL && slide->txt.object)
    {
        srv_uc_read_file_to_text_buffer(
            g_uc_p->main.instance,
            (U8*) slide->txt.object->file_path_ucs,
            slide->txt.object->encoding);
    }
  #ifdef __DRM_SUPPORT__
	if(slide->img.object && (slide->img.object)->drm_type != MMA_DRM_NONE && (slide->img.object)->drm_type != MMA_DRM_SD_NO_RIGHT )
	{
     		switch ((slide->img.object)->drm_type)
    {
        
        case MMA_DRM_SD:
        case MMA_DRM_PDCF_V2:
        case MMA_DRM_PDCF_V2_NO_RIGHT:
	{
     FS_HANDLE drm_fh = DRM_open_file((PU16)(slide->img.object)->file_path_ucs, FS_READ_ONLY, DRM_PERMISSION_DISPLAY);
	   if (drm_fh >= FS_NO_ERROR)
		{
			if (MMI_FALSE == DRM_validate_permission(drm_fh, NULL, DRM_PERMISSION_DISPLAY))
			{	           
				slide->img.object->drm_type=MMA_DRM_SD_NO_RIGHT;
			}
			else
			{
				slide->img.object->drm_type=MMA_DRM_SD;
			}
			DRM_close_file(drm_fh);
		}
	}
	   break;
			}
	}
 #endif  
mmi_uc_set_editor_info(slide);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_insert_signature
 * DESCRIPTION
 *  insert signature
 * PARAMETERS
 *  void
 * RETURNS
 *  
 *****************************************************************************/
BOOL mmi_uc_process_insert_signature(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_uc_insert_signature())
    {
        /* Add signature successfully. Initialize editor. */
        mmi_uc_editor_initialize();
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        mmi_uc_recipient_initialize();
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_warning_mode_insert_signature
 * DESCRIPTION
 *  process insert signature for warning mode confirm popup
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_warning_mode_insert_signature(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_process_insert_signature();
    mmi_frm_scrn_close_active_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_insert_signature_check
 * DESCRIPTION
 *  Check if it is needed to insert signature, if need, check if need popup warning mode confirm popup
 *  in this API. not insert signature object.
 * PARAMETERS
 *  void
 * RETURNS
 *  mmi_uc_insert_sig_result_enum
 *  MMI_UC_INSERT_SIG_RESULT_WARNING: FALSE means need popup
 *  MMI_UC_INSERT_SIG_RESULT_PASS: mean NO need popup confirm, and signature is added successfully
 *  MMI_UC_INSERT_SIG_RESULT_INSERT_OBJ_FAIL, pass but insert sig fail
 *****************************************************************************/
mmi_uc_insert_sig_result_enum mmi_uc_insert_signature_check(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* aviod similar case like -- forward a sms / add subject / but forward won't add sig/ 
       should not popup warning mode check for sig to avoid user to misunderstand */
    if (g_uc_p->srv_msg->auto_signature_inserted)
    {
        return MMI_UC_INSERT_SIG_RESULT_PASS;
    }

#ifdef __MMI_MMS_POSTCARD__
    /* Won't add signature if the current editing msg is postcard */
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        return MMI_UC_INSERT_SIG_RESULT_PASS;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 
    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER && g_uc_p->srv_mms_info->signature.enable)
    {
        if (MMI_TRUE == srv_uc_signature_pass_warning_mode_content_check(g_uc_p->main.instance))
        {
            if (!mmi_uc_process_insert_signature())
            {
                return MMI_UC_INSERT_SIG_RESULT_INSERT_OBJ_FAIL;
            }
        }
        else
        {
            return MMI_UC_INSERT_SIG_RESULT_WARNING;
        }
    }

#ifndef __MMI_MMS_STANDALONE_COMPOSER__
    else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
             g_uc_p->srv_mms_info->signature.enable)
    {
        /* tricky! disallow to insert signature for forward and send case */
        if (g_uc_p->srv_main->state != MMI_UC_STATE_FORWARD && g_uc_p->srv_main->state != MMI_UC_STATE_SEND)
        {
            g_uc_p->srv_msg->signature_inserted = MMI_FALSE;
        }
    }
#endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 

    return MMI_UC_INSERT_SIG_RESULT_PASS;
}

#ifndef __MMI_MMS_STANDALONE_COMPOSER__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_sms_frm_screen
 * DESCRIPTION
 *  Delete SMS framework screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_delete_sms_frm_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
//    mmi_frm_sms_delete_screen_history();
}
#endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_reset_msg
 * DESCRIPTION
 *  Reset msg info in context
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_reset_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    U32 count = 0;
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Reset App stuff here */
    if (g_uc_p->srv_msg->temp_subject)
    {
        OslMfree(g_uc_p->srv_msg->temp_subject);
        g_uc_p->srv_msg->temp_subject = NULL;
    }
    if(g_uc_p->srv_msg->msg_header.subject.text)
	{
	 kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_msg->msg_header.subject.text);
	 g_uc_p->srv_msg->msg_header.subject.text  = NULL ;
	}

    if (g_uc_p->main.create_msg_rsp)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->main.create_msg_rsp);
        g_uc_p->main.create_msg_rsp = NULL;
    }

    if (g_uc_p->send_info.fail_cause)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->send_info.fail_cause);
        g_uc_p->send_info.fail_cause = NULL;
    }
    memset(&(g_uc_p->send_info), 0, sizeof(g_uc_p->send_info));

    g_uc_p->main.select_media_opt = UC_MEDIA_OPT_NONE;
    g_uc_p->main.is_short = MMI_FALSE;
    g_uc_p->main.is_warning = MMI_FALSE;
    g_uc_p->main.confirm_lsk_func = NULL;
    g_uc_p->main.confirm_rsk_func = NULL;
    g_uc_p->main.confirm_tone_id = 0;
    g_uc_p->main.confirm_str_id = 0;
	g_uc_p->main.confirm_flag_onoff = MMI_TRUE;
    g_uc_p->main.sig_confirm_lsk_func = NULL;
    g_uc_p->main.sig_confirm_rsk_func = NULL;
    g_uc_p->main.sig_confirm_tone_id = 0;

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    g_uc_p->main.cc_region_flag = 0;
    g_uc_p->main.bcc_region_flag = 0;
    g_uc_p->main.subject_region_flag = 0;
    g_uc_p->main.recipient_count = 0;
    g_uc_p->main.check_buffer_flag = 0;
    g_uc_p->main.max_recipient_fields = 0;
    g_uc_p->main.phb_search_name_flag = 0;
    g_uc_p->main.phb_max_recipient_flag = 0;
    g_uc_p->main.prev_msg_type = 0;
    g_uc_p->main.operation = NULL;
	memset(g_uc_p->main.recipient_info, 0, WAP_CUSTOM_CFG_MAX_MMS_ADDRESS * (sizeof(wgui_uce_recipients_struct)));
	memset(g_uc_p->main.recipient_buffer, 0, WAP_CUSTOM_CFG_MAX_MMS_ADDRESS * (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
    memset(g_uc_p->main.recipient_value, 0, WAP_CUSTOM_CFG_MAX_MMS_ADDRESS * (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
    for (count = 0; count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
    {
        g_uc_p->main.recipient_info[count].app_mapping_index = -1;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

    if (g_uc_p->main.callback != NULL)
    {
        g_uc_p->main.callback((void*)g_uc_p->main.callback_para);
        g_uc_p->main.callback = NULL;
    }
    g_uc_p->main.callback_para = NULL;

    srv_uc_reset_msg(g_uc_p->main.instance);
#ifdef __MMI_UC_USE_ASM__
    mmi_uc_de_alloc_asm_pool();
#else
    if (!g_uc_p->other_app_temp_uc_info)    /* See where it goes */
    {
        kal_adm_delete(g_uc_p->main.mem_pool_id);   /* PROBLEM */
        mmi_uc_create_adm_mem();
    }
#endif /* __MMI_UC_USE_ASM__ */
#ifndef __MMI_SLIM_MMS_2__
#ifdef __MMI_CAMERA__
    if (g_uc_p->main.camera_cui_gid != GRP_ID_INVALID)
    {
        cui_camera_ex_close(g_uc_p->main.camera_cui_gid);
        g_uc_p->main.camera_cui_gid = GRP_ID_INVALID;
    }
#endif
#ifdef __MMI_SOUND_RECORDER__    
    if (g_uc_p->main.sndrec_cui_gid != GRP_ID_INVALID)
    {
        mmi_sndrec_exit_notify();
        g_uc_p->main.sndrec_cui_gid = GRP_ID_INVALID;
    }
#endif
#ifdef __MMI_VIDEO_RECORDER__    
    if (g_uc_p->main.vdorec_cui_gid != GRP_ID_INVALID)
    {
        cui_vdorec_ex_close(g_uc_p->main.vdorec_cui_gid);
        g_uc_p->main.vdorec_cui_gid = GRP_ID_INVALID;
    }
#endif
#endif
    if ( g_uc_p->main.uc_cui_gid != GRP_ID_INVALID || 
        g_uc_p->main.parent_grp_id != GRP_ID_INVALID)
    {
        mmi_frm_group_close (g_uc_p->main.parent_grp_id);
        mmi_frm_group_close (g_uc_p->main.uc_cui_gid);
        g_uc_p->main.parent_grp_id = GRP_ID_INVALID;
        g_uc_p->main.uc_cui_gid = GRP_ID_INVALID;
    }
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__
	if ( g_uc_p->main.cui_bookmark_gid != GRP_ID_INVALID || 
        g_uc_p->main.uc_bookmark_cui_id != GRP_ID_INVALID)
    {
        mmi_frm_group_close (g_uc_p->main.cui_bookmark_gid);
        mmi_frm_group_close (g_uc_p->main.uc_bookmark_cui_id);
        g_uc_p->main.cui_bookmark_gid = GRP_ID_INVALID;
        g_uc_p->main.uc_bookmark_cui_id = GRP_ID_INVALID;
    }
#endif
#if defined(__MMI_MESSAGES_TEMPLATE__)
	if ( g_uc_p->main.cui_template_gid != GRP_ID_INVALID || 
        g_uc_p->main.mmi_sms_template_gid != GRP_ID_INVALID)
    {
        mmi_frm_group_close (g_uc_p->main.cui_template_gid);
        mmi_frm_group_close (g_uc_p->main.mmi_sms_template_gid);
        g_uc_p->main.cui_template_gid = GRP_ID_INVALID;
        g_uc_p->main.mmi_sms_template_gid = GRP_ID_INVALID;
    }
#endif
    if (g_uc_p->main.select_contact_cui_gid != GRP_ID_INVALID)
	{
		mmi_frm_group_close (g_uc_p->main.select_contact_cui_gid);
		g_uc_p->main.select_contact_cui_gid = GRP_ID_INVALID;
	}
	if (g_uc_p->main.uc_fmgr_cui_id || g_uc_p->main.cui_fmgr_gid)
	{
		mmi_frm_group_close (g_uc_p->main.uc_fmgr_cui_id);
		mmi_frm_group_close (g_uc_p->main.cui_fmgr_gid);
		g_uc_p->main.cui_fmgr_gid = GRP_ID_INVALID;
		g_uc_p->main.uc_fmgr_cui_id = GRP_ID_INVALID;
	}
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
	#ifdef __MMI_IMAGE_VIEWER__
    if(g_uc_p->main.cui_img_view_gid != GRP_ID_INVALID || 
        g_uc_p->main.uc_img_view_cui_id != GRP_ID_INVALID)
    {
        //cui_imgview_close(g_uc_p->main.cui_img_view_gid);
        mmi_frm_group_close(g_uc_p->main.uc_img_view_cui_id);
        g_uc_p->main.cui_img_view_gid = GRP_ID_INVALID; 
        g_uc_p->main.uc_img_view_cui_id = GRP_ID_INVALID;
    }
	#endif /* __MMI_IMAGE_VIEWER__ */
    if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
        g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
	{
		g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
		g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
	}
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
#ifdef __MMI_PHOTOEDITOR__
    if(g_uc_p->main.uc_phart_id != GRP_ID_INVALID)
    {
        cui_phoedt_close(g_uc_p->main.uc_phart_id);
        g_uc_p->main.uc_phart_id = GRP_ID_INVALID;
    }
#endif
 #ifdef __MMI_MMS_2__
 if (g_uc_p->main.mms_cui_gid != GRP_ID_INVALID)
    {
       mmi_frm_group_close (g_uc_p->main.mms_cui_gid );
       g_uc_p->main.mms_cui_gid  = GRP_ID_INVALID;
    }
#endif
 #ifdef __MMI_UC_USE_ASM__
 g_uc_p->main.parent_cui_gid = GRP_ID_INVALID;
#endif
#if (defined(__SIM_HOT_SWAP_SUPPORT__) || defined(__SIM_RECOVERY_ENHANCEMENT__))
 if(g_uc_p->main.uc_sim_cui_id != GRP_ID_INVALID)
 {
     mmi_frm_group_close (g_uc_p->main.uc_sim_cui_id );
     g_uc_p->main.uc_sim_cui_id  = GRP_ID_INVALID;
 }
#endif
 StopTimer(UC_INPROGRESS_TIMER_ID);
 StopTimer(UC_MSG_TYPE_CHECK_TIMER_ID);
 StopTimer(UC_IMG_RESIZE_TIMER_ID);
 StopTimer(UC_CREATE_RSP_RETRY_TIMER_ID);
}

#ifdef WAP_SUPPORT


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_wap_prof_config_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  sim_id                  [IN]        
 *  app_id                  [IN]        
 *  profile_id              [IN]        
 *  configure_dtcnt_rsp     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_wap_prof_config_callback(
        srv_wap_prof_sim_id_enum sim_id,
        srv_wap_prof_app_id_enum app_id,
        U8 profile_id,
        srv_wap_prof_result_enum configure_dtcnt_rsp)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((configure_dtcnt_rsp == SRV_WAP_PROF_SUCCESS) && mmi_uc_is_uc_screen_in_history())
    {
    #if (defined(__MMI_MMS_2__) || defined(__MMI_MMS_BGSR_SUPPORT__))
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND_IN_BACKGROUND;
    #else 
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND;
    #endif 

    #ifdef __MMI_MMS_POSTCARD__
        g_uc_p->srv_send_info->curr_send_number = 0;
    #endif 
        mmi_uc_create_mms();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_wap_prof_config_callback_for_previewer
 * DESCRIPTION
 *  
 * PARAMETERS
 *  sim_id                  [IN]        
 *  app_id                  [IN]        
 *  profile_id              [IN]        
 *  configure_dtcnt_rsp     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_wap_prof_config_callback_for_previewer(
        srv_wap_prof_sim_id_enum sim_id,
        srv_wap_prof_app_id_enum app_id,
        U8 profile_id,
        srv_wap_prof_result_enum configure_dtcnt_rsp)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((configure_dtcnt_rsp == SRV_WAP_PROF_SUCCESS) && mmi_uc_is_uc_screen_in_history())
    {
    #if (defined(__MMI_MMS_2__) || defined(__MMI_MMS_BGSR_SUPPORT__))
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND_IN_BACKGROUND;
        mms_send_msg(
            srv_uc_convert_uc_sim_id_to_mma(srv_uc_convert_sim_id(g_uc_p->srv_send_info->send_sim_id)),
            g_uc_p->srv_send_info->new_msg_id,
            (kal_uint16) g_uc_p->send_info.new_msg_storage,
            (kal_uint16) MMA_APP_ID_UC);
        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD || g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
        {
            MMI_ASSERT(0);
        }
        else
        {
            mmi_uc_delete_between_screens(SCR_ID_UC_EDITOR, SCR_ID_UC_MSG_PREVIEW);
        }
        mmi_uc_action_fsm(SRV_UC_ACTION_SEND, MMA_RESULT_OK);
    #else /* (defined(__MMI_MMS_2__) || defined(__MMI_MMS_BGSR_SUPPORT__)) */ 
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND;
        mmi_uc_send_mms();
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
    #endif /* (defined(__MMI_MMS_2__) || defined(__MMI_MMS_BGSR_SUPPORT__)) */ 
    }
}

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
#endif /* WAP_SUPPORT */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_xml_start_element_hdlr
 * DESCRIPTION
 *  Start element handler
 * PARAMETERS
 *  data        [?]         
 *  el          [IN]        
 *  attr        [IN]        
 *  error       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_parse_mms_xml_description_file
 * DESCRIPTION
 *  Pare mms xml description file
 * PARAMETERS
 *  file_path       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
S32 mmi_uc_parse_mms_xml_description_file(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	//S32 result = 0;
	//result = SRV_UC_OK;
	
    

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
   /* g_uc_p->srv_xml->xml_parser = OslMalloc(sizeof(XML_PARSER_STRUCT));

    memset(g_uc_p->srv_xml->xml_parser, 0, sizeof(XML_PARSER_STRUCT));

    result = xml_new_parser(g_uc_p->srv_xml->xml_parser);

    if (result)
    {
        xml_close_parser(g_uc_p->srv_xml->xml_parser);
        OslMfree(g_uc_p->srv_xml->xml_parser);
        g_uc_p->srv_xml->xml_parser = NULL;
        return SRV_UC_XML_ERROR;
    }

    xml_register_element_handler(
        g_uc_p->srv_xml->xml_parser,
        mmi_uc_xml_start_element_hdlr,
        mmi_uc_xml_end_element_hdlr);

    xml_register_data_handler(g_uc_p->srv_xml->xml_parser, mmi_uc_xml_data_hdlr);

    result = xml_parse(g_uc_p->srv_xml->xml_parser, file_path);

    xml_close_parser(g_uc_p->srv_xml->xml_parser);

    OslMfree(g_uc_p->srv_xml->xml_parser);
    g_uc_p->srv_xml->xml_parser = NULL;

    if (result)
    {
        return SRV_UC_XML_ERROR;
    }
    else
   */ {
        S32 match_obj_result = mmi_uc_match_object_id();

        /* Add prefix RE: for reply msg and FW: for forward msg */
        /* Only add that for MMS, because SMS has no subject */
    #ifdef __MMI_UC_SUB_PREFIX_MMS__
    #ifndef __MMI_MMS_STANDALONE_COMPOSER__
    #ifndef __MMI_OP01_202_MMS_REPLY_BY_SMS_MMS_SUPPORT__
        if (mmi_uc_determine_msg_type_by_content() == SRV_UC_MSG_TYPE_MMS_PREFER)
    #endif 
    #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
            mmi_uc_add_prefix_before_subject(g_uc_p->main.instance);
    #endif /* __MMI_UC_SUB_PREFIX_MMS__ */ 

        if (FS_NO_ERROR == match_obj_result)
        {
            return SRV_UC_OK;
        }
        else if (FS_ERROR_RESERVED == match_obj_result) /* mean text obj is refered more than once */
        {
            return SRV_UC_NOT_SUPPORT;
        }
        else
        {
            return SRV_UC_STORAGE_FULL;
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_cui_event_handler_group_proc
 * DESCRIPTION
 *  Function for unified composer to process the result of cui events
 * PARAMETERS
 *  evt     [IN]        
 * RETURNS
 *  process result of msg
 *****************************************************************************/
mmi_ret mmi_uc_cui_event_handler_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
#ifndef __MMI_SLIM_MMS_2__
            /* yingchun modify for framework2.0 */
    #if (defined(__MMI_VIDEO_RECORDER__) || defined(__MMI_CAMERA__))
    #ifdef __MMI_VIDEO_RECORDER__
        case CUI_VDOREC_RECORD_EVENT_RESULT_SUCCESS:
            {
                mmi_uc_enter_multimedia_app_callback(MMI_TRUE, (PS8) ((cui_vdorec_event_struct*) evt)->file_path);
                cui_vdorec_ex_close(g_uc_p->main.vdorec_cui_gid);
                g_uc_p->main.vdorec_cui_gid = GRP_ID_INVALID;
            }
            break;

        case CUI_VDOREC_RECORD_EVENT_RESULT_FAILED:
            {
                mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);
                cui_vdorec_ex_close(g_uc_p->main.vdorec_cui_gid);
                g_uc_p->main.vdorec_cui_gid = GRP_ID_INVALID;
            }
            break;

        case CUI_VDOREC_RECORD_EVENT_RESULT_CLOSE_ME:
            {
                mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);    
                cui_vdorec_ex_close(g_uc_p->main.vdorec_cui_gid);
                g_uc_p->main.vdorec_cui_gid = GRP_ID_INVALID;
            }
            break;
    #endif /* __MMI_VIDEO_RECORDER__ */ 

    #ifdef __MMI_CAMERA__
        case CUI_CAMERA_EVENT_RESULT_SUCCESS:
            {
				CHAR *camera_file_path = NULL ;
				camera_file_path = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1 ) * ENCODING_LENGTH);
				memcpy((char*)camera_file_path , (char *)(((cui_camera_event_struct*)evt)->file_path), (SRV_FMGR_PATH_MAX_LEN + 1 ) * ENCODING_LENGTH);
                //mmi_uc_enter_multimedia_app_callback(MMI_TRUE, (PS8) ((cui_vdorec_event_struct*) evt)->file_path);
                cui_camera_ex_close(g_uc_p->main.camera_cui_gid);
                g_uc_p->main.camera_cui_gid = GRP_ID_INVALID;
				
				mmi_frm_display_dummy_screen();
				mmi_uc_enter_multimedia_app_callback(MMI_TRUE, (PS8)camera_file_path);
				OslMfree(camera_file_path);
            }
            break;

        case CUI_CAMERA_EVENT_RESULT_FAILED:
            {
                //mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);
                cui_camera_ex_close(g_uc_p->main.camera_cui_gid);
                g_uc_p->main.camera_cui_gid = GRP_ID_INVALID;
				
				//mmi_frm_display_dummy_screen();				
				mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);
            }
            break;

        case CUI_CAMERA_EVENT_RESULT_CLOSE_ME:
            {
                //mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);
                cui_camera_ex_close(g_uc_p->main.camera_cui_gid);
                g_uc_p->main.camera_cui_gid = GRP_ID_INVALID;
				
				//mmi_frm_display_dummy_screen();
				mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);
            }
            break;
    #endif /* __MMI_CAMERA__ */ 
    #endif /* (defined(__MMI_VIDEO_RECORDER__) || defined(__MMI_CAMERA__)) && !defined(__MMI_CAMCORDER__) */ 
#endif /* __MMI_SLIM_MMS_2__ */
        case EVT_ID_GROUP_DELETE_REQ_IN_END_KEY:
        case EVT_ID_GROUP_GOBACK_IN_END_KEY:
        case EVT_ID_MEM_FREE_ASM:
#ifndef __MMI_SLIM_MMS_2__
        #ifdef __MMI_CAMERA__
            if (g_uc_p->main.camera_cui_gid != GRP_ID_INVALID)
            {
                mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);
                cui_camera_ex_close(g_uc_p->main.camera_cui_gid);
                g_uc_p->main.camera_cui_gid = GRP_ID_INVALID;
            }
        #endif
        #ifdef __MMI_VIDEO_RECORDER__    
            if (g_uc_p->main.vdorec_cui_gid != GRP_ID_INVALID)
            {
                mmi_uc_enter_multimedia_app_callback(MMI_FALSE, NULL);
                cui_vdorec_ex_close(g_uc_p->main.vdorec_cui_gid);
                g_uc_p->main.vdorec_cui_gid = GRP_ID_INVALID;
            }
        #endif
#endif
            break;
        case EVT_ID_PHB_SELECT_CONTACT:
            {
                cui_phb_select_contact_result_struct* select_contact_result = (cui_phb_select_contact_result_struct*)evt;

                mmi_uc_get_address_from_phb_ext( (S8*)select_contact_result->name, (S8*)select_contact_result->select_data);
                cui_phb_list_select_contact_close(g_uc_p->main.select_contact_cui_gid);
            }
            break;
    #ifdef __MMI_UC_MULTI_SELECT__
        case EVT_ID_PHB_SELECT_MULTI_CONTACT:
            {
                cui_phb_multi_select_contact_result_struct* select_contact_result = (cui_phb_multi_select_contact_result_struct*)evt;

                mmi_uc_handle_addr_callback(select_contact_result->count, select_contact_result->store_index, select_contact_result->field, select_contact_result->is_group);
                cui_phb_list_select_contact_close(g_uc_p->main.select_contact_cui_gid);
            }
            break;
        case EVT_ID_PHB_SELECT_MULTI_CONTACT_CANCEL:
    #endif
        case EVT_ID_PHB_SELECT_CONTACT_CANCEL:
            {
                cui_phb_list_select_contact_close(g_uc_p->main.select_contact_cui_gid);
            }
            break;
    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
        case EVT_ID_CUI_SMS_SEND:
            {
                cui_evt_sms_send_struct *send_sms_result = (cui_evt_sms_send_struct*)evt;
                if(send_sms_result->is_send_finish)
                {
                    cui_sms_send_close(g_uc_p->main.sms_cui_gid);
                    cui_sms_send_close(APP_UNIFIEDCOMPOSER);
                    g_uc_p->main.sms_cui_gid = GRP_ID_INVALID;
                }
            }
            break;
    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */
        default:
            break;
    }

    if (evt->evt_id == EVT_ID_MEM_FREE_ASM)
    {
        return MMI_MEM_FREED;
    }
    else
    {
        return MMI_RET_OK;   
    }
}


#ifndef __MMI_SLIM_MMS_2__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enter_multimedia_app
 * DESCRIPTION
 *  Function for users to enter MM application to add new object
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_enter_multimedia_app(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    U32 new_slide_size = 0;
    U32 max_file_size = 0;
    U32 smil_size = 0;

    /* max "file name" size, not path size. not include file extension, the max file name that user can edit is 35 */
    U16 temp_file_path[43] = L"D:\\temp1234567890123456789012345678901.tmp";
    U16 file_name_size = (35 + 4) * 3 + 50; /* (max+file extension) *3 + constant for mms calculation */
    U32 max_mms_size_available = 0;
    MMI_BOOL flag_for_restricted_popup = (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
                                          mms_get_max_msg_size_in_restricted_mode() <=
                                          g_uc_p->srv_mms_info->max_mms_size) ? MMI_TRUE : MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTER_MULTIMEDIA_APP_P1, g_uc_p->main.highlighted_object_type);
    max_mms_size_available =
        (flag_for_restricted_popup) ? mms_get_max_msg_size_in_restricted_mode() : g_uc_p->srv_mms_info->max_mms_size;
    
    switch (g_uc_p->main.highlighted_object_type)
    {
    #ifdef __MMI_CAMERA__
            case SRV_UC_OBJECT_TYPE_IMAGE:
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->img.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL)
                {

                    new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
                }

                smil_size = mma_uc_calc_object_smil_size(MMA_INSERT_IMAGE, (kal_wchar*) temp_file_path);
                if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
                {
                    new_slide_size = 0;
                    smil_size = 0;
                }

                if (max_mms_size_available < (g_uc_p->srv_msg->msg_size + new_slide_size + smil_size + file_name_size))
                {
                    MMI_TRACE(
                        MMI_COMMON_TRC_G6_MSG,
                        TRC_MMI_UC_ENTER_MULTIMEDIA_APP_SIZE_EXCEED_P5,
                        max_file_size,
                        max_mms_size_available,
                        g_uc_p->srv_msg->msg_size,
                        new_slide_size,
                        smil_size);
                    max_file_size = 0;
                }
                else    /* avoid overflow */
                {
                    max_file_size =
                        (max_mms_size_available - g_uc_p->srv_msg->msg_size - new_slide_size - smil_size -
                         file_name_size) / 1024;
                }

                MMI_TRACE(
                    MMI_COMMON_TRC_G6_MSG,
                    TRC_MMI_UC_ENTER_MULTIMEDIA_APP_P5,
                    max_file_size,
                    max_mms_size_available,
                    g_uc_p->srv_msg->msg_size,
                    new_slide_size,
                    smil_size);

                if (max_file_size > 0)
                {
                    /* yingchun modify for framework2.0 */
                    /* it will use vdorec cui to record */
                    {
                        cui_camera_run_struct camera_struct;

                        cui_camera_struct_init(&camera_struct);

                    #ifdef __MMI_MMS_POSTCARD__
                        if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
                        {
                            camera_struct.req_mode = MMI_CAMERA_EXTERNAL_MODE_LARGEST_RESOLUTION;
                            /* mmi_camera_external_request_by_mode(MMI_CAMERA_EXTERNAL_MODE_LARGEST_RESOLUTION, mmi_uc_enter_multimedia_app_callback); */
                        }
                        else
                    #endif /* __MMI_MMS_POSTCARD__ */ 
                        {
                            camera_struct.req_mode = MMI_CAMERA_EXTERNAL_MODE_NORMAL;
                            /* mmi_camera_external_request_by_mode(MMI_CAMERA_EXTERNAL_MODE_NORMAL, mmi_uc_enter_multimedia_app_callback); */
                        }

                        g_uc_p->main.camera_cui_gid = cui_camera_ex_create(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, mmi_uc_cui_event_handler_group_proc);
                        cui_camera_ex_run(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, g_uc_p->main.camera_cui_gid, &camera_struct);
                    }
                }
                else
                {
                #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
                #ifdef WAP_SUPPORT
                    if (srv_wap_prof_get_active_profile_connection_type
                        ((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) > SRV_WAP_PROF_CONN_TYPE_HTTP)
                #else /* WAP_SUPPORT */ 
                    if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) >
                        BRW_PROF_CONN_TYPE_HTTP)
                #endif /* WAP_SUPPORT */ 
                    {
                        mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
                    }
                    else
                #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
                    {
                        if (flag_for_restricted_popup)
                        {
                            mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS);
                        }
                        else
                        {
                            mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                        }
                    }
                
                    return;
                }
            }
                break;
        #endif /* __MMI_CAMERA__ */ 

        #ifdef __MMI_SOUND_RECORDER__
            case SRV_UC_OBJECT_TYPE_AUDIO:
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->aud.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL)
                {

                    new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
                }

                smil_size = mma_uc_calc_object_smil_size(MMA_INSERT_AUDIO, (kal_wchar*) temp_file_path);
                if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
                {
                    new_slide_size = 0;
                    smil_size = 0;
                }

                if (max_mms_size_available < (g_uc_p->srv_msg->msg_size + new_slide_size + smil_size + file_name_size))
                {
                    MMI_TRACE(
                        MMI_COMMON_TRC_G6_MSG,
                        TRC_MMI_UC_ENTER_MULTIMEDIA_APP_SIZE_EXCEED_P5,
                        max_file_size,
                        max_mms_size_available,
                        g_uc_p->srv_msg->msg_size,
                        new_slide_size,
                        smil_size);
                    max_file_size = 0;
                }
                else    /* avoid overflow */
                {
                    max_file_size =
                        (max_mms_size_available - g_uc_p->srv_msg->msg_size - new_slide_size - smil_size -
                         file_name_size) / 1024;
                }

                MMI_TRACE(
                    MMI_COMMON_TRC_G6_MSG,
                    TRC_MMI_UC_ENTER_MULTIMEDIA_APP_P5,
                    max_file_size,
                    max_mms_size_available,
                    g_uc_p->srv_msg->msg_size,
                    new_slide_size,
                    smil_size);

                if (max_file_size > 0)
                {
                    g_uc_p->main.sndrec_cui_gid = 1;
                    /* audio use byptes */
                #ifdef __MMI_OP11_MMS_SUPPORT_AUDIO_MSG__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                #else /* __MMI_OP11_MMS_SUPPORT_AUDIO_MSG__ */ 

                    mmi_sndrec_entry_record_from_other_app(
                        NULL,
                        max_mms_size_available - g_uc_p->srv_msg->msg_size - new_slide_size - smil_size - file_name_size,
                        0,
                        (void (*)(BOOL, U16*))mmi_uc_enter_multimedia_app_callback);
                #endif /* __MMI_OP11_MMS_SUPPORT_AUDIO_MSG__ */ 
                }
                else
                {
                #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
                #ifdef WAP_SUPPORT
                    if (srv_wap_prof_get_active_profile_connection_type
                        ((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) > SRV_WAP_PROF_CONN_TYPE_HTTP)
                #else /* __SRV_WAP_PROF__ */ 
                    if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) >
                        BRW_PROF_CONN_TYPE_HTTP)
                #endif /* WAP_SUPPORT */ 
                    {
                        mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
                    }
                    else
                #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
                    {
                        if (flag_for_restricted_popup)
                        {
                            mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS);
                        }
                        else
                        {
                            mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                        }
                    }
                    return;
                }
            }
                break;
        #endif /* __MMI_SOUND_RECORDER__ */ 

        #if defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE)

            case SRV_UC_OBJECT_TYPE_VIDEO:
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->img.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->aud.object != NULL)
                {

                    new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
                }

                smil_size = mma_uc_calc_object_smil_size(MMA_INSERT_VIDEO, (kal_wchar*) temp_file_path);
                if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
                {
                    new_slide_size = 0;
                    smil_size = 0;
                }

                if (max_mms_size_available < (g_uc_p->srv_msg->msg_size + new_slide_size + smil_size + file_name_size))
                {
                    MMI_TRACE(
                        MMI_COMMON_TRC_G6_MSG,
                        TRC_MMI_UC_ENTER_MULTIMEDIA_APP_SIZE_EXCEED_P5,
                        max_file_size,
                        max_mms_size_available,
                        g_uc_p->srv_msg->msg_size,
                        new_slide_size,
                        smil_size);
                    max_file_size = 0;

                }
                else
                {
                    max_file_size =
                        (max_mms_size_available - g_uc_p->srv_msg->msg_size - new_slide_size - smil_size -
                         file_name_size) / 1024;
                }

                MMI_TRACE(
                    MMI_COMMON_TRC_G6_MSG,
                    TRC_MMI_UC_ENTER_MULTIMEDIA_APP_P5,
                    max_file_size,
                    max_mms_size_available,
                    g_uc_p->srv_msg->msg_size,
                    new_slide_size,
                    smil_size);

                if (max_file_size >= mmi_vdorec_get_min_external_request_size())        /* because video recorder can not record with accurate size, walk around */
                {
                    /* yingchun modify for framework2.0 */
                    /* it will use vdorec cui to record */
                    if(cui_vdorec_check_and_display_popup())    
                    {
                        cui_vdorec_run_struct vdorec_struct;

                        cui_vdorec_struct_init(&vdorec_struct);
                    #ifdef __MMI_OP11_MMS_SUPPORT_VIDEO_MSG__
/* under construction !*/
/* under construction !*/
/* under construction !*/
                        #if defined(__MMI_CAMCORDER__)
/* under construction !*/
                        #endif
/* under construction !*/
                    #else /* __MMI_OP11_MMS_SUPPORT_VIDEO_MSG__ */ 
                        /* mmi_vdorec_entry_for_external_request(NULL,  max_file_size, 0, mmi_uc_enter_multimedia_app_callback); */
                        vdorec_struct.max_file_size = max_file_size;
                        vdorec_struct.max_record_time = 0;
                        #if defined(__MMI_CAMCORDER__)
                        vdorec_struct.is_partial = 0;
                        #endif
                        g_uc_p->main.vdorec_cui_gid = cui_vdorec_ex_create(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, mmi_uc_cui_event_handler_group_proc);
                    #endif /* __MMI_OP11_MMS_SUPPORT_VIDEO_MSG__ */ 

                        cui_vdorec_ex_run(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, g_uc_p->main.vdorec_cui_gid, &vdorec_struct);
                    }
                }
                else if (max_file_size > 0)
                {
                    mmi_uc_display_popup(SRV_UC_SIZE_NOT_ENOUGH_FOR_REC_VIDEO);
                    return;
                }
                else
                {
                #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
                #ifdef WAP_SUPPORT
                    if (srv_wap_prof_get_active_profile_connection_type
                        ((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) > SRV_WAP_PROF_CONN_TYPE_HTTP)
                #else /* WAP_SUPPORT */ 
                    if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) >
                        BRW_PROF_CONN_TYPE_HTTP)
                #endif /* WAP_SUPPORT */ 
                    {
                        mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
                    }
                    else
                #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
                    {
                        if (flag_for_restricted_popup)
                        {
                            mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS);
                        }
                        else
                        {
                            mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                        }
                    }
                    return;
                }
            }
                break;
        #endif /* defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE) */ 
            default:
            {
                MMI_ASSERT(0);
            }
                break;
        }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enter_multimedia_app_callback
 * DESCRIPTION
 *  Add object from Multimedia application
 * PARAMETERS
 *  result          [IN]        
 *  file_path       [?]         
 *  is_short(?)     [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_enter_multimedia_app_callback(MMI_BOOL result, S8 *file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 flie_path_len = 0;
    mma_insert_check_struct check_result;

    mma_insert_info_struct insert_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTER_MULTIMEDIA_APP_CALLBACK_P1, result);
    g_uc_p->main.is_warning = MMI_FALSE;
/* for temporary only till sound recorder's CUI is not available */
    if (g_uc_p->main.sndrec_cui_gid != GRP_ID_INVALID)
    {
        g_uc_p->main.sndrec_cui_gid = GRP_ID_INVALID;
    }
	
		/* while saving the file check UC existence */
		if (!mmi_uc_is_uc_screen_in_history())
		{
			return;
		}

    if (g_uc_p->srv_main->file_path)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }

    if (result)
    {
        flie_path_len = mmi_ucs2strlen((S8*) file_path);

        g_uc_p->srv_main->file_path = kal_adm_alloc(g_uc_p->main.mem_pool_id, (flie_path_len + 1) * ENCODING_LENGTH);

        MMI_ASSERT(g_uc_p->srv_main->file_path);
        mmi_ucs2ncpy((S8*) g_uc_p->srv_main->file_path, (S8*) file_path, flie_path_len);
        memset(&check_result, 0, sizeof(mma_insert_check_struct));

        insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
        insert_info.current_msg_size = 0;   /* becasue only check warning mode, no need curr size */
        insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
        insert_info.insert_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);
        insert_info.filepath = (kal_wchar*) file_path;
        insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

        mma_uc_insert_object_check(&insert_info, &check_result);

        if (check_result.result && (MMA_RESULT_OK_WITH_WARNING_CONTENT == check_result.detail_result))
        {
            mmi_uc_enter_multimedia_app_add_object_warning_mode_check();
            return;
        }

    }
    mmi_uc_enter_multimedia_app_add_object();
    return;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_multimedia_app_add_object
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 *  is_short(?)     [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_multimedia_app_add_object(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_enter_multimedia_app_add_object();
    g_uc_p->main.is_warning = MMI_FALSE;
}
#endif /* #ifndef __MMI_SLIM_MMS_2__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_goback_history_to_editor
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_goback_history_to_editor(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_main->file_path != NULL)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }

    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))//IsScreenPresent(SCR_ID_UC_EDITOR))
    {
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
		mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
    }
    else
    {
        MMI_ASSERT(0);
    }

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_goback_history_to_editor_warning_mode_check
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_goback_history_to_editor_warning_mode_check(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_goback_history_to_editor();
    g_uc_p->main.is_warning = MMI_FALSE;
}

#ifndef __MMI_SLIM_MMS_2__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enter_multimedia_app_add_object_warning_mode_check
 * DESCRIPTION
 *  check if the object (from Multimedia application) is a restricted obj.
 *  need popup confirm to let user to decide continue add this obj or not.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_enter_multimedia_app_add_object_warning_mode_check(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	#ifdef __MMI_UC_MMS_IMG_RESOLUTION__
		U16* filePath = (U16*)g_uc_p->srv_main->file_path;
	#endif
    MMI_BOOL img_resolution_need_resize = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_group_id();

    if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE)
    {
        if (g_uc_p->srv_mms_info->image_resize.enable)
        {
            img_resolution_need_resize = MMI_TRUE;
        }
    #ifdef __MMI_UC_MMS_IMG_RESOLUTION__
        else if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
        {
            img_resolution_need_resize = srv_uc_img_resolution_exceed_limitation(filePath);
        }
    #endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 
    }
    if (!img_resolution_need_resize &&
        g_uc_p->main.is_warning)
    {
	    mmi_uc_setSoftkeyFunction(
	        mmi_uc_process_multimedia_app_add_object,
	        mmi_uc_goback_history_to_editor_warning_mode_check,
	        (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
	        (U16) STR_UC_WARNING_MODE_CONFIRM);
	    if (g_uc_p->main.parent_grp_id != GRP_ID_INVALID)
        {
            mmi_uc_insert_screen(g_uc_p->main.parent_grp_id, SCR_ID_UC_CONFIRM, (mmi_proc_func) mmi_uc_entry_displayConfirm, 1);
        }
        else
        {
            mmi_uc_insert_screen(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM, (mmi_proc_func) mmi_uc_entry_displayConfirm, 1);
        }
    	return;
    }
    else if (img_resolution_need_resize)
    {
        mmi_uc_image_object_from_multimedia_app_resize_process_before_resolution_verification_to_insert(
            (PU16) g_uc_p->srv_main->file_path,
            g_uc_p->main.is_short);
        return;
    }
	mmi_uc_enter_multimedia_app_add_object();
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_post_handler_enter_multimedia_app_add_object
 * DESCRIPTION
 *  
 * PARAMETERS
 *  mms_type                [IN]        
 *  mmi_uc_image_path       [?]         
 *  filePath                [IN]        
 *  is_short(?)             [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_post_handler_enter_multimedia_app_add_object(
        mma_insert_type_enum mms_type,
        U8 *mmi_uc_image_path,
        PU16 filePath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
    U32 new_slide_size = 0;
    mma_insert_check_struct check_result;
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;
    srv_uc_result result;
    mma_mms_object_struct *object = NULL;
    mma_insert_info_struct insert_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&check_result, 0, sizeof(mma_insert_check_struct));
    if (g_uc_p->srv_main->file_path != NULL)
    {

        switch (g_uc_p->main.highlighted_object_type)
        {
            case SRV_UC_OBJECT_TYPE_IMAGE:
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->img.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL)
                {

                    new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
                }
            }
                break;

            case SRV_UC_OBJECT_TYPE_AUDIO:
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->aud.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL)
                {

                    new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
                }
            }
                break;

            case SRV_UC_OBJECT_TYPE_VIDEO:
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->img.object != NULL ||
                    g_uc_p->srv_msg->msg_body.curr_slide->aud.object != NULL)
                {

                    new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
                }
            }
                break;

            default:
            {
                MMI_ASSERT(0);
                return;
            }
                
        }

        insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;

        if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
        {
            insert_info.current_msg_size = g_uc_p->srv_msg->msg_size;
        }
        else
        {
            insert_info.current_msg_size = g_uc_p->srv_msg->msg_size + new_slide_size;
        }

        insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
        insert_info.insert_type = mms_type;
        insert_info.filepath = (kal_wchar*) filePath;
        insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

        mma_uc_insert_object_check(&insert_info, &check_result);

        if (!(check_result.result))
        {
            result = srv_uc_convert_mms_check_result(&check_result);
            mmi_uc_display_popup(result);
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_INSERT_NEW_MM_OBJECT, 1, 0, SCR_ID_UC_OPT, 1);
            if (mmi_ucs2strlen((S8*) mmi_uc_image_path) &&
                srv_uc_is_resized_image((U16*) mmi_uc_image_path, g_uc_p->main.instance) == MMI_TRUE)
            {
                FS_Delete((WCHAR*) mmi_uc_image_path);
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }

        if (new_slide_size > 0)
        {
            slide = srv_uc_insert_slide(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide);
            g_uc_p->srv_msg->msg_body.curr_slide = slide;
            g_uc_p->srv_msg->current_slide_num = slide->slide_num;
        }

        object = srv_uc_insert_object(g_uc_p->main.instance, (S8*) filePath, g_uc_p->main.highlighted_object_type);
        object->drm_type = check_result.drm_type;
        srv_uc_insert_object_to_slide(g_uc_p->main.instance, object, slide, g_uc_p->main.highlighted_object_type);

        /* Determine layout */
        if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE ||
            g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_VIDEO)
        {
            if (g_uc_p->srv_msg->msg_body.layout == MMA_LAYOUT_NONE)
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count)
                {
                    g_uc_p->srv_msg->msg_body.layout = MMA_LAYOUT_TEXT_ON_TOP;
                }
                else
                {
                    g_uc_p->srv_msg->msg_body.layout = MMA_LAYOUT_IMAGE_ON_TOP;
                }
            }
        }

        if (mmi_uc_change_msg_type_if_needed())
        {
            pass_sig_check = mmi_uc_insert_signature_check();
        }

        srv_uc_update_msg_size(g_uc_p->main.instance);

        if (new_slide_size)
        {
            mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
        }
        else
        {
            mmi_uc_editor_initialize();
        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            mmi_uc_recipient_initialize();
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
            mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
        }

    }

    /* Screen flow */
    if (g_uc_p->srv_main->file_path != NULL)
    {
        {
            U16 next_scrn_id = 0, top_scrn_id = 0;
            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
        }
    }
    else
    {
        /* back from other MM application(camera, video recorder, audio recorder) */
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_INSERT_NEW_MM_OBJECT);
    }

    if (g_uc_p->srv_main->file_path != NULL)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_entry_sig_displayConfirm_generic();
    }
    if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
    }
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enter_multimedia_app_add_object
 * DESCRIPTION
 *  Add object from Multimedia application
 * PARAMETERS
 *  void
 *  is_short(?)     [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_enter_multimedia_app_add_object(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN] = {0,};
    U16 *filePath = (U16*) g_uc_p->srv_main->file_path;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Success case in callback */
    mmi_uc_set_group_id();
    if (g_uc_p->srv_main->file_path != NULL)
    {
    #ifdef __MMI_UC_MMS_IMG_RESOLUTION__
        MMI_BOOL img_resolution_need_resize = MMI_FALSE;

        if ((g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE) &&
            (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED) &&
            !(g_uc_p->srv_mms_info->image_resize.enable))
        {
            img_resolution_need_resize = srv_uc_img_resolution_exceed_limitation(filePath);
            mms_get_max_image_resolution_in_restricted_mode(
                (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.width)),
                (kal_int32 *) (&(g_uc_p->srv_mms_info->image_resize.height)));
        }
    #endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 

        memset(mmi_uc_image_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);

        if ((g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE &&
             g_uc_p->srv_mms_info->image_resize.enable)
    #ifdef __MMI_UC_MMS_IMG_RESOLUTION__
            || img_resolution_need_resize
    #endif 
            )

        {

        #ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__
            S32 left_size = 0;
            MMI_BOOL flag_for_restricted_popup = (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
                                                  mms_get_max_msg_size_in_restricted_mode() <=
                                                  g_uc_p->srv_mms_info->max_mms_size) ? MMI_TRUE : MMI_FALSE;
            U32 max_mms_size =
                (flag_for_restricted_popup) ? mms_get_max_msg_size_in_restricted_mode() : g_uc_p->srv_mms_info->
                max_mms_size;

            if (!mmi_uc_is_valid_image(filePath))
            {
                mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                {
                    U16 next_scrn_id = 0, top_scrn_id = 0;
                    top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                    next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                    mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                }
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }
            {   /* no need here but just to make both flow in sync used here. */
                srv_uc_result result;
                S32 fmgr_ret = -1;

                mmi_fmgr_util_file_limit_check2(FMGR_LIMIT_MMS_CATEGORY, (PS8) g_uc_p->srv_main->file_path, &fmgr_ret);

                if (fmgr_ret < 0)
                {
                    if (fmgr_ret == GDI_IMAGE_ERR_IMAGE_TOO_LARGE)
                    {
                        result = SRV_UC_FAIL_IMAGE_TOO_LARGE;
                    }
                    else
                    {
                        result = SRV_UC_FILE_CORRUPT;
                    }
                    mmi_uc_display_popup(result);
                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                    {
                        U16 next_scrn_id = 0, top_scrn_id = 0;
                        top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                        mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                    }
                    kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                    g_uc_p->srv_main->file_path = NULL;
                    return;
                }
            }
            /* gdi_image_get_dimension_file here should be return ok, becasue if not ok, already return in previous check */
            gdi_image_get_dimension_file(
                (PS8) filePath,
                (S32*) & (g_uc_p->main.resized_w),
                (S32*) & (g_uc_p->main.resized_h));
            srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);

            left_size = max_mms_size - g_uc_p->srv_msg->msg_size
                - mma_uc_calc_object_overhead_size(
                    MMA_INSERT_IMAGE,
                    (PU16) mmi_uc_image_path,
                    max_mms_size,
                    srv_uc_get_mms_type(g_uc_p->main.instance));

            if (left_size <= 0)
            {
                (flag_for_restricted_popup) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }

            /* here, file path is = g_uc_p->srv_main->file_path */
            mmi_uc_auto_resize_img_handler(
                mmi_uc_post_handler_enter_multimedia_app_add_object,
                (U8*) filePath,
                mmi_uc_image_path,
                mms_type,
                g_uc_p->main.resized_w,
                g_uc_p->main.resized_h,
                left_size,
                MMI_TRUE);

            return;
        #else /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 

            S32 resize_result;

            if (!mmi_uc_is_valid_image(filePath))
            {
                mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
				mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_uc_delete_between_screens(SCR_ID_UC_OPT, SCR_ID_UC_OPT_INSERT_NEW_MM_OBJECT);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }
            {   /* no need here but just to make both flow in sync used here. */
                srv_uc_result result;
                S32 fmgr_ret = -1;

                mmi_fmgr_util_file_limit_check2(FMGR_LIMIT_MMS_CATEGORY, (PS8) g_uc_p->srv_main->file_path, &fmgr_ret);

                if (fmgr_ret < 0)
                {
                    if (fmgr_ret == GDI_IMAGE_ERR_IMAGE_TOO_LARGE)
                    {
                        result = SRV_UC_FAIL_IMAGE_TOO_LARGE;
                    }
                    else
                    {
                        result = SRV_UC_FILE_CORRUPT;
                    }
                    mmi_uc_display_popup(result);
                    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                    {
                        U16 next_scrn_id = 0, top_scrn_id = 0;
                        top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                        mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                    }
                    kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                    g_uc_p->srv_main->file_path = NULL;
                    return;
                }
            }
            srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);
            resize_result = mmi_uc_resize_image(
                                (U8*) filePath,
                                mmi_uc_image_path,
                                g_uc_p->srv_mms_info->image_resize.width,
                                g_uc_p->srv_mms_info->image_resize.height);

            /* Error ! */
            if (resize_result < 0)
            {

                mmi_uc_display_resize_result_popup((S32) resize_result);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                {
                    U16 next_scrn_id = 0, top_scrn_id = 0;
                    top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                    next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                    mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                }
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }
            /* resized */
            else if (resize_result)
            {
                filePath = (PU16) mmi_uc_image_path;
            }
            /* resize_result == 0 means no need to resize */
            else    /* SRV_UC_RESIZING_SUCCEED_WITH_UNCHANGED= 0, filepath is still original one */
            {
                /* mmi_uc_display_resize_result_popup((S32)resize_result); */
            }

        #endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 

        }
        mmi_uc_post_handler_enter_multimedia_app_add_object(mms_type, mmi_uc_image_path, filePath);
    }
    else
    {
        mmi_uc_post_handler_enter_multimedia_app_add_object(mms_type, mmi_uc_image_path, filePath);
    }

    return;
}
#endif /* #ifndef __MMI_SLIM_MMS_2__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_select_file_group_proc
 * DESCRIPTION
 *  Function for users to select inserted object according to selected type
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
 static mmi_ret mmi_uc_select_file_group_proc(mmi_event_struct *evt)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_DEINIT:
            g_uc_p->main.cui_fmgr_gid = GRP_ID_INVALID;
            g_uc_p->main.uc_fmgr_cui_id = GRP_ID_INVALID;
            break;

        //#if defined(__MMI_FILE_MANAGER__)
        case EVT_ID_CUI_FILE_SELECTOR_RESULT:
		        { 
		        	cui_file_selector_result_event_struct *fmgr_evt =  (cui_file_selector_result_event_struct*) evt;
                    srv_fmgr_fileinfo_struct info;
                    WCHAR* path_buffer  = NULL;

		            if (g_uc_p->main.select_media_opt == UC_MEDIA_OPT_INSERT)
                    {
                        if (fmgr_evt->result > 0)
                        {
                            path_buffer = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1 ) * sizeof(WCHAR));
                            cui_file_selector_get_selected_filepath(g_uc_p->main.cui_fmgr_gid, &info, 
                                                   path_buffer, (SRV_FMGR_PATH_MAX_LEN + 1 ) * sizeof(WCHAR));
		                    mmi_uc_select_object_from_fm_to_insert_warning_mode_check((PU16)path_buffer, 0);
                            OslMfree(path_buffer);
                        }
                        else 
                        {
                            cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
                            mmi_uc_select_object_from_fm_to_insert_warning_mode_check(NULL, 0);
                        }
                    }
                    #ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
                    else if (g_uc_p->main.select_media_opt == UC_MEDIA_OPT_REPLACE || 
                                    g_uc_p->main.select_media_opt == UC_MEDIA_OPT_ATTACHMENT_LIST)
                    {
                        if (fmgr_evt->result > 0)
                        {
                            path_buffer = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1 ) * sizeof(WCHAR));
                            cui_file_selector_get_selected_filepath(g_uc_p->main.cui_fmgr_gid, &info, 
                                                   path_buffer, ( SRV_FMGR_PATH_MAX_LEN + 1 ) * sizeof(WCHAR));
                            mmi_uc_select_object_from_fm_to_replace_warning_mode_check((PU16)path_buffer, 0);
                            OslMfree(path_buffer);
                        }
                        else
                        {
                            cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
                            mmi_uc_select_object_from_fm_to_replace_warning_mode_check(NULL, 0);
                        }
                    }
                    #endif
		            break;
		        }
        //#endif
      }
    return MMI_RET_OK;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_select_fmgr_object
 * DESCRIPTION
 *  Function for users to select inserted object according to selected type
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_select_fmgr_object(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILTER filter;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* FMGR_FILTER_INIT(&filter); *//* will be handled in mma_uc_set_file_mgr_filter */
    g_uc_p->main.cui_fmgr_gid = GRP_ID_INVALID;
    g_uc_p->main.uc_fmgr_cui_id = GRP_ID_INVALID;

    g_uc_p->main.uc_fmgr_cui_id = mmi_frm_group_create (GRP_ID_ROOT, GRP_ID_AUTO_GEN, mmi_uc_select_file_group_proc, NULL);
    mmi_frm_group_enter(g_uc_p->main.uc_fmgr_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    switch (g_uc_p->main.highlighted_object_type)
    {
        case SRV_UC_OBJECT_TYPE_IMAGE:
        {
            if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_IMAGE_RESTRICTED_MODE);
                /* mmi_uc_set_file_mgr_filter(&filter, MMA_OPEN_RESTRICTED_IMAGE_TYPES); */
            }
            else
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_IMAGE_OPEN_MODE);
                /* mmi_uc_set_file_mgr_filter(&filter, MMA_OPEN_IMAGE_TYPES); */
            }
        }
            break;

        case SRV_UC_OBJECT_TYPE_AUDIO:
        {
            if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_AUDIO_RESTRICTED_MODE);
                /* mmi_uc_set_file_mgr_filter(&filter, MMA_OPEN_RESTRICTED_AUDIO_TYPES); */
            }
            else
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_AUDIO_OPEN_MODE);
                /* mmi_uc_set_file_mgr_filter(&filter, MMA_OPEN_AUDIO_TYPES); */
            }
        }
            break;

        case SRV_UC_OBJECT_TYPE_VIDEO:
        {
            if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_VIDEO_RESTRICTED_MODE);
                /* mmi_uc_set_file_mgr_filter(&filter, MMA_OPEN_RESTRICTED_VIDEO_TYPES); */
            }
            else
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_VIDEO_OPEN_MODE);
                /* mmi_uc_set_file_mgr_filter(&filter, MMA_OPEN_VIDEO_TYPES); */
            }
        }
            break;

        case SRV_UC_OBJECT_TYPE_ATTACHMENT:
        {
            if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_ATTACHMENT_RESTRICTED_MODE);
                /* mmi_uc_set_file_mgr_filter(&filter, MMA_OPEN_RESTRICTED_ATTACHMENT_TYPES); */
            }
            else
            {
                mma_uc_set_file_mgr_filter(&filter, MMA_UC_FILTER_MODE_ATTACHMENT_OPEN_MODE);
                /* mmi_uc_set_file_mgr_filter_all(&filter); */
            }
        }
            break;

        default:
        {
            MMI_ASSERT(0);
        }
            break;
    }

    /* FMGR_FILTER_SET(&filter, FMGR_TYPE_FOLDER); *//* will be handled in mma_uc_set_file_mgr_filter */
    /* FMGR_FILTER_SET(&filter, FMGR_TYPE_FOLDER_DOT); *//* will be handled in mma_uc_set_file_mgr_filter */
    /* disallow user to insert a gif to postcard */
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        FMGR_FILTER_CLEAR(&filter, FMGR_TYPE_GIF);
    }
#endif /* __MMI_MMS_POSTCARD__ */ 
    if (g_uc_p->main.select_media_opt == UC_MEDIA_OPT_INSERT)
    {
        if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
        {
                g_uc_p->main.cui_fmgr_gid =  cui_file_selector_create(g_uc_p->main.uc_fmgr_cui_id,
                                                           (WCHAR*)L"root",
                                                           &filter,
                                                           CUI_FILE_SELECTOR_STYLE_FILE_ONLY,
                                                           CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_FOLDER);
        }
        else
        {
                g_uc_p->main.cui_fmgr_gid =  cui_file_selector_create(g_uc_p->main.uc_fmgr_cui_id,
                                                           (WCHAR*)L"root",
                                                           &filter,
                                                           CUI_FILE_SELECTOR_STYLE_FILE_ONLY,
                                                           CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_FILE);
        }
    }
#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
    else if (g_uc_p->main.select_media_opt == UC_MEDIA_OPT_REPLACE || 
                    g_uc_p->main.select_media_opt == UC_MEDIA_OPT_ATTACHMENT_LIST)
    {
        if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
        {
             g_uc_p->main.cui_fmgr_gid =  cui_file_selector_create(g_uc_p->main.uc_fmgr_cui_id,
                                                           (WCHAR*)L"root",
                                                           &filter,
                                                           CUI_FILE_SELECTOR_STYLE_FILE_ONLY,
                                                           CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_FOLDER);
        }
        else
        {
                g_uc_p->main.cui_fmgr_gid =  cui_file_selector_create(g_uc_p->main.uc_fmgr_cui_id,
                                                           (WCHAR*)L"root",
                                                           &filter,
                                                           CUI_FILE_SELECTOR_STYLE_FILE_ONLY,
                                                           CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_FILE);
        }
    }
#endif /* __MMI_UC_REPLACE_MEDIA_SUPPORT__ */ 
    else
    {
        MMI_ASSERT(0);
    }
    
    if (g_uc_p->main.cui_fmgr_gid > 0)
	{
		cui_file_selector_set_title(g_uc_p->main.cui_fmgr_gid, 0, IMG_UC_ENTRY_SCRN_CAPTION_ID);
		cui_file_selector_run(g_uc_p->main.cui_fmgr_gid);
	}
	else
	{
		mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);
	}
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_select_object_from_fm_to_insert
 * DESCRIPTION
 *  should fill parameter
 * PARAMETERS
 *  void
 *  is_short(?)     [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_select_object_from_fm_to_insert(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_select_object_from_fm_to_insert((PU16) g_uc_p->srv_main->file_path, g_uc_p->main.is_short);

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_insert
 * DESCRIPTION
 *  resizing for replacing
 * PARAMETERS
 *  file_path       [?]         
 *  is_short        [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_insert(U16 *file_path, BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
	S32 img_width = 0, img_height = 0;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(mmi_uc_image_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);

    /* move file path related check to mmi_uc_select_object_from_fm_to_insert_warning_mode_check */
    /* 1. processing screen */
	gdi_image_get_dimension_file((PS8) file_path, &img_width, &img_height);
	if ((img_width != 0) && (img_height != 0))
    {
        /* calculate the dimension of the resize JPEG */
        if (((S32) img_width > (S32) g_uc_p->srv_mms_info->image_resize.width) || ((S32) img_height > (S32) g_uc_p->srv_mms_info->image_resize.height))
        {
			mmi_uc_set_group_id();
			cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
			mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
			mmi_uc_entry_processing_generic();
		}
	}

#ifdef __MMI_UC_MMS_IMG_RESOLUTION__
    if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
        !(g_uc_p->srv_mms_info->image_resize.enable))
    {
        mms_get_max_image_resolution_in_restricted_mode(
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.width)),
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.height)));
    }
#endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 

    /* 2. for image need resize cases, resize it to get finally file path */
#ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__

    {
        S32 left_size = 0;
        MMI_BOOL flag_for_restricted_popup = (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
                                              mms_get_max_msg_size_in_restricted_mode() <=
                                              g_uc_p->srv_mms_info->max_mms_size) ? MMI_TRUE : MMI_FALSE;
        U32 max_mms_size =
            (flag_for_restricted_popup) ? mms_get_max_msg_size_in_restricted_mode() : g_uc_p->srv_mms_info->
            max_mms_size;

        /* in case user to select a very big image, and it will taks a lot of time just for resize once */
        if (!mmi_uc_is_valid_image(file_path))
        {
            mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
        /* gdi_image_get_dimension_file here should be return ok, becasue if not ok, already return in previous check */
        gdi_image_get_dimension_file(
            (PS8) file_path,
            (S32*) & (g_uc_p->main.resized_w),
            (S32*) & (g_uc_p->main.resized_h));

        srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);

        /* the orig img file path is already kept by g_uc_p->srv_main->file_path */

        left_size = max_mms_size - g_uc_p->srv_msg->msg_size
            - mma_uc_calc_object_overhead_size(
                MMA_INSERT_IMAGE,
                (PU16) mmi_uc_image_path,
                max_mms_size,
                srv_uc_get_mms_type(g_uc_p->main.instance));

        if (left_size <= 0)
        {
            (flag_for_restricted_popup) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
        g_uc_p->main.post_handler = mmi_uc_image_object_verification_process;
        /* here, file path is = g_uc_p->srv_main->file_path */
        mmi_uc_auto_resize_img_handler(
            g_uc_p->main.post_handler,
            (U8*) file_path,
            mmi_uc_image_path,
            mms_type,
            g_uc_p->main.resized_w,
            g_uc_p->main.resized_h,
            left_size,
            MMI_TRUE);

        return;
    }
#else /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
    {
        S32 resize_result;

        if (!mmi_uc_is_valid_image(file_path))
        {
            mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }

        srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);
        resize_result = mmi_uc_resize_image(
                            (U8*) file_path,
                            mmi_uc_image_path,
                            g_uc_p->srv_mms_info->image_resize.width,
                            g_uc_p->srv_mms_info->image_resize.height);

        /* Error ! */
        if (resize_result < 0)
        {
            MMI_TRACE(
                MMI_COMMON_TRC_G6_MSG,
                TRC_MMI_UC_SELECT_OBJECT_FROM_FM_TO_INSERT_RESIZE_P2,
                g_uc_p->srv_mms_info->image_resize.width,
                g_uc_p->srv_mms_info->image_resize.height);

            mmi_uc_display_resize_result_popup((S32) resize_result);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
        /* resized */
        else if (resize_result)
        {
            file_path = (PU16) mmi_uc_image_path;
            srv_uc_update_filepath_with_string(g_uc_p->main.instance, (S8*) mmi_uc_image_path);
        }
        /* resize_result == 0 means no need to resize */
        else    /* SRV_UC_RESIZING_SUCCEED_WITH_UNCHANGED= 0, filepath is still original one */
        {
            /* mmi_uc_display_resize_result_popup((S32)resize_result); */
        }
    }
#endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
    mmi_uc_image_object_verification_process(mms_type, (U8*) file_path, (PU16) file_path);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_resized_object_to_insert
 * DESCRIPTION
 *  Select object from file manager
 * PARAMETERS
 *  void
 *  is_short(?)     [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_resized_object_to_insert(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_post_handler_select_object_from_fm_to_insert(
        mms_type,
        (U8*) g_uc_p->srv_main->file_path,
        (PU16) g_uc_p->srv_main->file_path);
	mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_image_object_verification_process
 * DESCRIPTION
 *  Select object from file manager
 * PARAMETERS
 *  insert_mms_type         [IN]        
 *  mmi_uc_image_path       [IN]        
 *  file_path               [IN]        
 *  filePath(?)             [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_image_object_verification_process(
        mma_insert_type_enum insert_mms_type,
        U8 *mmi_uc_image_path,
        PU16 file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_insert_check_struct check_result = {KAL_FALSE, KAL_FALSE, KAL_FALSE, MMA_RESULT_OK, MMA_INSERT_UNKNOWN, MMA_DRM_NONE};
    mma_insert_type_enum mms_type = insert_mms_type;
    mma_insert_info_struct insert_info = {0, 0, MMA_CREATION_MODE_FREE, MMA_INSERT_UNKNOWN, MMA_MMS_TYPE_SMIL_MMS, NULL};
    //S32 flie_path_len = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = 0;   /* becasue only check warning mode, no need curr size */
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = mms_type;
    insert_info.filepath = (kal_wchar*) mmi_uc_image_path;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_result);
    if (check_result.result && (MMA_RESULT_OK_WITH_WARNING_CONTENT == check_result.detail_result))
    {
		mmi_uc_set_group_id();
		cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
        mmi_uc_setSoftkeyFunction(
            mmi_uc_process_resized_object_to_insert,
            mmi_uc_goback_history_to_editor,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
            (U16) STR_UC_WARNING_MODE_CONFIRM);
        mmi_uc_entry_displayConfirm_generic();
        return;
    }
    mmi_uc_post_handler_select_object_from_fm_to_insert(
        insert_mms_type,
        g_uc_p->srv_main->file_path,
        (PU16) g_uc_p->srv_main->file_path);
    return;
}

#ifdef __MMI_MMS_IMAGE_VIEW_ENHANCEMENT__

void mmi_uc_decode_image(S32 img_width, S32 img_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 gdi_result = GDI_FAILED;
    S32 bytesperpx;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	bytesperpx = (gdi_layer_get_bit_per_pixel()) >> 3;
    media_get_ext_buffer(MOD_MMI, (void **)&(g_uc_p->main.buff), bytesperpx*(img_width+1) * (img_height+1));
    
    if(g_uc_p->main.buff!=NULL)
    {
        gdi_result = gdi_layer_create_cf_using_outside_memory(bytesperpx, MMI_CONTENT_X, 0,
					    img_width +1, img_height + 1,
					    &(g_uc_p->main.mmi_uc_dec_image_handle),
					    g_uc_p->main.buff,
					    (img_width + 1) * (img_height + 1) * bytesperpx);
    }
    else
    {
        g_uc_p->main.decode_fp(
            (PU16) g_uc_p->srv_main->file_path,
            g_uc_p->main.is_short);
        return;
    }
    if(gdi_result < 0)
    {
        mmi_uc_decode_error_handler();
        return;
    }
    /*show processing screen*/
    mmi_uc_set_group_id();
    cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
    mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
    mmi_uc_entry_processing_generic();
    g_uc_p->main.gdi_dec_hdl = gdi_imgdec_nb_draw_resized_file(g_uc_p->main.mmi_uc_dec_image_handle, 0, 0,
			                       img_width, img_height,
			                       (U8*)g_uc_p->srv_main->file_path,
			                       (gdi_imgdec_nb_done_callback_funcptr)mmi_uc_gdi_decode_done_cb);      

    if(g_uc_p->main.gdi_dec_hdl < 0)
    {
        mmi_uc_decode_error_handler();
        return;
    }
}

void mmi_uc_gdi_decode_done_cb(GDI_RESULT result,gdi_handle handle)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //S32 gdi_result = GDI_FAILED;
    //S32 bytesperpx = 0;
    //U8 mmi_uc_dec_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
    //S32 img_width = 0, img_height = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(result >= 0 && g_uc_p->main.gdi_dec_hdl == handle)
    {
        /*show processing screen*/
        //mmi_uc_set_group_id();
	    //cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
		//mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
		//mmi_uc_entry_processing_generic();
        
        //StartTimer(UC_IMG_RESIZE_TIMER_ID, 250, mmi_uc_final_resize_and_encode_image);
        mmi_uc_final_resize_and_encode_image();
    }
    else
    {
         mmi_uc_decode_error_handler();
    } 
}

void mmi_uc_final_resize_and_encode_image(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 decode_file_path[SRV_UC_MAX_TEMP_FILE_LEN];	    
    S32 gdi_result = GDI_FAILED;
    S32 bytesperpx;
    gdi_handle handle;
    S32 img_width = g_uc_p->srv_mms_info->image_resize.width;
    S32 img_height = g_uc_p->srv_mms_info->image_resize.height;
    S32 img_w_actual = 0;
    S32 img_h_actual = 0;
    U8 *buf_ptr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //StopTimer(UC_IMG_RESIZE_TIMER_ID);
	bytesperpx = (gdi_layer_get_bit_per_pixel()) >> 3;
    gdi_image_get_dimension_file((PS8) g_uc_p->srv_main->file_path, &img_w_actual, &img_h_actual);
    media_get_ext_buffer(MOD_MMI, (void **)&(buf_ptr), bytesperpx*(img_width+1) * (img_height+1));
    
    if(buf_ptr!=NULL)
    {
        gdi_result = gdi_layer_create_cf_using_outside_memory(bytesperpx, MMI_CONTENT_X, 0,
                        img_width, img_height,
                        &(handle),buf_ptr,
					    (img_width) * (img_height) * bytesperpx);

        if(gdi_result < 0)
        {
            media_free_ext_buffer(MOD_MMI, (void **)&(buf_ptr));
            mmi_uc_decode_error_handler();
            return;   
        }

        gdi_layer_push_and_set_active(handle);

        gdi_result = gdi_bitblt_resized_with_resizer(g_uc_p->main.mmi_uc_dec_image_handle, 0, 0,
                        img_w_actual, img_h_actual,
                        0, 0,
                        img_width, img_height,
                        GDI_RESIZER_SW_QUALITY_HIGH);

        gdi_layer_pop_and_restore_active();

        if(gdi_result < 0)
        {
            gdi_layer_free(handle);
            media_free_ext_buffer(MOD_MMI, (void **)&(buf_ptr));
            
            mmi_uc_decode_error_handler();
            return;
        }
    }
    else
    {
        mmi_uc_decode_error_handler();
        return;
    }
    
    srv_uc_make_image_file_path(decode_file_path, g_uc_p->main.instance);
    gdi_image_encode_layer_to_jpeg(handle, decode_file_path);
    srv_uc_update_filepath_with_string(g_uc_p->main.instance, (S8*) decode_file_path);

    if(g_uc_p->main.decode_fp == mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_insert)
    {
        mmi_uc_post_handler_select_object_from_fm_to_insert(MMA_INSERT_IMAGE, 
            g_uc_p->srv_main->file_path,
            (PU16) g_uc_p->srv_main->file_path);
    }
    else if(g_uc_p->main.decode_fp == mmi_uc_handle_image_object_resize_process_before_resolution_verification)
    {
        mmi_uc_post_handler_handle_image_object_insert_if_file_path_exist_then_entry_editor(MMA_INSERT_IMAGE, 
            (U8*) g_uc_p->srv_main->file_path,
            (PU16) g_uc_p->srv_main->file_path);
    }
    
    gdi_layer_free(handle);
    gdi_layer_free(g_uc_p->main.mmi_uc_dec_image_handle);
    media_free_ext_buffer(MOD_MMI, (void **)&(buf_ptr));
    media_free_ext_buffer(MOD_MMI, (void **)&(g_uc_p->main.buff));   
}

void mmi_uc_decode_error_handler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	if(g_uc_p->main.mmi_uc_dec_image_handle)
	{
		gdi_layer_free(g_uc_p->main.mmi_uc_dec_image_handle);
		g_uc_p->main.mmi_uc_dec_image_handle = GDI_NULL_HANDLE;
	}
    if(g_uc_p->main.buff)
	{
		media_free_ext_buffer(MOD_MMI, (void **)&(g_uc_p->main.buff));
		g_uc_p->main.buff = NULL;
	}
    g_uc_p->main.decode_fp(
        (PU16) g_uc_p->srv_main->file_path,
        g_uc_p->main.is_short);
    /*mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_insert(
        (PU16) g_uc_p->srv_main->file_path,
        g_uc_p->main.is_short);*/
}

#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_select_object_from_fm_to_insert_warning_mode_check
 * DESCRIPTION
 *  Select object from file manager
 * PARAMETERS
 *  filePath        [IN]        
 *  is_short        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_select_object_from_fm_to_insert_warning_mode_check(PU16 filePath, S32 is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    mma_insert_check_struct check_result;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);
    FS_HANDLE handle;
    U32 flie_path_len = 0;
    mma_insert_info_struct insert_info;
    MMI_BOOL img_resolution_need_resize = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&check_result, 0, sizeof(mma_insert_check_struct));

    if (filePath == NULL)
    {
        cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
        return;
    }

    if ((handle = FS_GetAttributes((PU16) filePath)) < 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(srv_fmgr_fs_error_get_string(handle))), MMI_EVENT_FAILURE, NULL);
        return;
    }

    /* use self parameter to save file name info */
    if (g_uc_p->srv_main->file_path)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }

    flie_path_len = mmi_ucs2strlen((S8*) filePath);

    g_uc_p->srv_main->file_path = kal_adm_alloc(g_uc_p->main.mem_pool_id, (flie_path_len + 1) * ENCODING_LENGTH);

    MMI_ASSERT(g_uc_p->srv_main->file_path);
    mmi_ucs2ncpy((S8*) g_uc_p->srv_main->file_path, (S8*) filePath, flie_path_len);

    g_uc_p->main.is_short = is_short;

#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        MMI_ASSERT(g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE);
    }
#endif /* __MMI_MMS_POSTCARD__ */ 

    /* because here is only check for warning mode, no need to reserve the size for greeting and address in advance */

    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = 0;   /* becasue only check warning mode, no need curr size */
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = mms_type;
    insert_info.filepath = (kal_wchar*) filePath;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_result);

#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        /* can not insert drm file in postcard */
        if (check_result.drm_type != MMA_DRM_NONE)
        {
            mmi_uc_display_popup((U16) SRV_UC_PROHIBIT_BY_DRM);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
    }
#endif /* __MMI_MMS_POSTCARD__ */ 
    /* Main use is in Image case to show error popup before resize test. */
    if (!(check_result.result) &&
        ((MMA_RESULT_FAIL_FILE_IO == check_result.detail_result) ||
         (MMA_RESULT_FAIL_FILE_CORRUPTED == check_result.detail_result) ||
         (MMA_RESULT_FAIL_FILE_EMPTY == check_result.detail_result) ||
         (MMA_RESULT_FAIL_IMAGE_TOO_LARGE == check_result.detail_result)))
    {
        srv_uc_result result;

        result = srv_uc_convert_mms_check_result(&check_result);
        mmi_uc_display_popup(result);
        mmi_uc_set_group_id();
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
        return;
    }
    /* Check if it is DRM file */
    /* all DRM files can not be resized. */
    if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE && check_result.drm_type == MMA_DRM_NONE)
    {
        if (g_uc_p->srv_mms_info->image_resize.enable)
        {
            img_resolution_need_resize = MMI_TRUE;
        }
    #ifdef __MMI_UC_MMS_IMG_RESOLUTION__
        else if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
        {
            img_resolution_need_resize = srv_uc_img_resolution_exceed_limitation(filePath);
        }
    #endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 
    }
    if (!img_resolution_need_resize &&
        check_result.result && (MMA_RESULT_OK_WITH_WARNING_CONTENT == check_result.detail_result))
    {
        mmi_uc_set_group_id();
		cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
        mmi_uc_setSoftkeyFunction(
            mmi_uc_process_select_object_from_fm_to_insert,
            mmi_uc_goback_history_to_editor,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
            (U16) STR_UC_WARNING_MODE_CONFIRM);
        mmi_uc_entry_displayConfirm_generic();
        return;
    }
    else if (img_resolution_need_resize)
    {
        S32 fmgr_ret = -1;
        srv_uc_result result;
#ifdef __MMI_MMS_IMAGE_VIEW_ENHANCEMENT__
        S32 img_width = 0, img_height = 0;
        S32 resize_w = (S32) g_uc_p->srv_mms_info->image_resize.width;
        S32 resize_h = (S32) g_uc_p->srv_mms_info->image_resize.height;
#endif
        if (!check_result.result)
        {
            mmi_fmgr_util_file_limit_check2(FMGR_LIMIT_MMS_CATEGORY, (PS8) g_uc_p->srv_main->file_path, &fmgr_ret);

            if (fmgr_ret < 0)
            {
                if (fmgr_ret == GDI_IMAGE_ERR_IMAGE_TOO_LARGE)
                {
                    result = SRV_UC_FAIL_IMAGE_TOO_LARGE;
                }
                else
                {
                    result = SRV_UC_FILE_CORRUPT;
                }
                mmi_uc_display_popup(result);
                mmi_uc_set_group_id();
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }
        }
#ifdef __MMI_MMS_IMAGE_VIEW_ENHANCEMENT__
        gdi_image_get_dimension_file((PS8)g_uc_p->srv_main->file_path, &img_width, &img_height);
        if(((S32) img_width > (S32) resize_w) || ((S32) img_height > (S32) resize_h))
        {
            g_uc_p->main.decode_fp = mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_insert;
            mmi_uc_decode_image(img_width, img_height);
        }
        else
#endif
        {
        mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_insert(
            (PU16) g_uc_p->srv_main->file_path,
            g_uc_p->main.is_short);
        }

        return;
    }
    mmi_uc_select_object_from_fm_to_insert((PU16) g_uc_p->srv_main->file_path, g_uc_p->main.is_short);
    return;
}

#ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_auto_resize_img_timeout_handler
 * DESCRIPTION
 *  resize image based on current left mms size --> it's non-blocking
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 * BOOL
 *****************************************************************************/
void mmi_uc_auto_resize_img_timeout_handler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
    S32 curr_left_size;
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;
    mma_mms_object_struct *replaced_object = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* 1. use same name, because the img file still not be resized and encoded */
    memset(mmi_uc_image_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);
    srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);

    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_REPLACE, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        replaced_object = srv_uc_get_object_in_slide(slide, g_uc_p->main.highlighted_object_type);
        curr_left_size = g_uc_p->srv_mms_info->max_mms_size - g_uc_p->srv_msg->msg_size + replaced_object->size
            + mma_uc_calc_object_overhead_size(
                MMA_INSERT_IMAGE,
                (PU16) replaced_object->file_path_ucs,
                g_uc_p->srv_mms_info->max_mms_size,
                srv_uc_get_mms_type(g_uc_p->main.instance)) -
            mma_uc_calc_object_overhead_size(
                MMA_INSERT_IMAGE,
                (PU16) mmi_uc_image_path,
                g_uc_p->srv_mms_info->max_mms_size,
                srv_uc_get_mms_type(g_uc_p->main.instance));
    }
    else
    {
        curr_left_size = g_uc_p->srv_mms_info->max_mms_size - g_uc_p->srv_msg->msg_size
            - mma_uc_calc_object_overhead_size(
                MMA_INSERT_IMAGE,
                (PU16) mmi_uc_image_path,
                g_uc_p->srv_mms_info->max_mms_size,
                srv_uc_get_mms_type(g_uc_p->main.instance));
    }

    if (curr_left_size < 0)
    {
        MMI_ASSERT(0);
		MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
    }

    mmi_uc_auto_resize_img_handler(
        g_uc_p->main.post_handler,
        g_uc_p->srv_main->file_path,
        mmi_uc_image_path,
        MMA_INSERT_IMAGE,
        g_uc_p->main.resized_w,
        g_uc_p->main.resized_h,
        curr_left_size,
        MMI_FALSE);

}
#endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_post_handler_select_object_from_fm_to_insert
 * DESCRIPTION
 *  the post handler for Select object from file manager
 * PARAMETERS
 *  mms_type                [IN]        
 *  mmi_uc_image_path       [?]         
 *  filePath                [IN]        
 * RETURNS
 *  void
 * BOOL
 *****************************************************************************/
void mmi_uc_post_handler_select_object_from_fm_to_insert(
        mma_insert_type_enum mms_type,
        U8 *mmi_uc_image_path,
        PU16 filePath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    U32 new_slide_size = 0;
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;
    mma_insert_check_struct check_result;
    mma_mms_attachment_info_struct *att;
    mma_mms_object_struct *object = NULL;
    mma_insert_info_struct insert_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&check_result, 0, sizeof(mma_insert_check_struct));
    /* 3. calculate new_slide_size */
    switch (g_uc_p->main.highlighted_object_type)
    {
        case SRV_UC_OBJECT_TYPE_IMAGE:
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->img.object != NULL ||
                g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL)
            {

                new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
            }
        }
            break;

        case SRV_UC_OBJECT_TYPE_AUDIO:
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->aud.object != NULL ||
                g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL)
            {

                new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
            }
        }
            break;

        case SRV_UC_OBJECT_TYPE_VIDEO:
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->vid.object != NULL ||
                g_uc_p->srv_msg->msg_body.curr_slide->img.object != NULL ||
                g_uc_p->srv_msg->msg_body.curr_slide->aud.object != NULL)
            {

                new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
            }
        }
            break;

        default:
        {
            ;
        }
            break;
    }

    /* 4. really insert to uc structure */
    object = srv_uc_check_duplicate_object(g_uc_p->main.instance, filePath);

    if (g_uc_p->main.highlighted_object_type != SRV_UC_OBJECT_TYPE_ATTACHMENT &&
        object && object->type != MMA_MMS_OBJECT_TYPE_ATTACHMENT)
    {
        U32 obj_smil_size = mma_uc_calc_object_smil_size(mms_type, filePath);
        U32 new_slide_size_tmp = new_slide_size;
        MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

        if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
        {
            new_slide_size_tmp = 0;
        }

        /* only affect size check, still insert slide as usual */
        if (!srv_uc_check_if_exceed_MMS_size_limitation
            (g_uc_p->main.instance, obj_smil_size + new_slide_size_tmp + g_uc_p->srv_msg->msg_size,
             &fail_in_restricted_size_check))
        {
            if (new_slide_size > 0)
            {
                slide = srv_uc_insert_slide(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide);
                g_uc_p->srv_msg->msg_body.curr_slide = slide;
                g_uc_p->srv_msg->current_slide_num = slide->slide_num;
            }

            srv_uc_insert_object_to_slide(g_uc_p->main.instance, object, slide, g_uc_p->main.highlighted_object_type);
        }
        else
        {
            (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            g_uc_p->main.post_handler = NULL;
            return;
        }
    }
    else
    {

        insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
        if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
        {
            insert_info.current_msg_size = g_uc_p->srv_msg->msg_size;
        }
        else
        {
            insert_info.current_msg_size = g_uc_p->srv_msg->msg_size + new_slide_size;
        }
        insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
        insert_info.insert_type = mms_type;
        insert_info.filepath = (kal_wchar*) filePath;
        insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

        mma_uc_insert_object_check(&insert_info, &check_result);

        if (!(check_result.result))
        {
            srv_uc_result result;

            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_OBJECT_CHECK_FAIL_FMGR);

            result = srv_uc_convert_mms_check_result(&check_result);
            mmi_uc_display_popup(result);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            if (mmi_ucs2strlen((S8*) mmi_uc_image_path) &&
                srv_uc_is_resized_image((U16*) mmi_uc_image_path, g_uc_p->main.instance) == MMI_TRUE)
            {
                FS_Delete((WCHAR*) mmi_uc_image_path);
            }

            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            g_uc_p->main.post_handler = NULL;
            return;
        }

        if (new_slide_size > 0)
        {
            slide = srv_uc_insert_slide(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide);
            g_uc_p->srv_msg->msg_body.curr_slide = slide;
            g_uc_p->srv_msg->current_slide_num = slide->slide_num;
        }

        object = srv_uc_insert_object(g_uc_p->main.instance, (S8*) filePath, g_uc_p->main.highlighted_object_type);
        object->drm_type = check_result.drm_type;

        if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
        {
        #ifdef __MMI_UC_REF__
            if (srv_uc_is_in_ref_obj_type_range((S8*) filePath))
            {

                mma_mms_slide_ref_object_struct *new_ref_obj_info;

                /* do not care id, so set 0 here */
                new_ref_obj_info = srv_uc_insert_ref_obj_info_to_tail(
                                    g_uc_p->main.instance,
                                    slide,
                                    0,
                                    SRV_UC_INVALID_VALUE,
                                    SRV_UC_INVALID_VALUE);

                /* associate real object and the new ref obj info */
                new_ref_obj_info->object = object;
                object->reference_count++;
            }
            else
        #endif /* __MMI_UC_REF__ */ 
            {
                att = srv_uc_insert_attachment(g_uc_p->main.instance);
                srv_uc_insert_object_to_attachment(object, att);
            }
        }
        else
        {
            srv_uc_insert_object_to_slide(g_uc_p->main.instance, object, slide, g_uc_p->main.highlighted_object_type);
        }
    }
    /* 5. fmgr */
//    cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);

    /* 6. Determine layout */
    if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE ||
        g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_VIDEO)
    {
        if (g_uc_p->srv_msg->msg_body.layout == MMA_LAYOUT_NONE)
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count)
            {
                g_uc_p->srv_msg->msg_body.layout = MMA_LAYOUT_TEXT_ON_TOP;
            }
            else
            {
                g_uc_p->srv_msg->msg_body.layout = MMA_LAYOUT_IMAGE_ON_TOP;
            }
        }
    }

    /* 7-1. check signature -1 */
    if (mmi_uc_change_msg_type_if_needed())
    {
        pass_sig_check = mmi_uc_insert_signature_check();
    }

    srv_uc_update_msg_size(g_uc_p->main.instance);

    /* 8. update wgui info */
    if (new_slide_size)
    {
        mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
    }
    else
    {
        mmi_uc_editor_initialize();
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        mmi_uc_recipient_initialize();
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
    }

    /* 9. handle screen. remove processing screen */
    mmi_uc_set_group_id();
    cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
    {
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
		mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
    }
    else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
		mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
    }
    else
    {
        /* because popup will push progressing screen to history and therefore the progessing screen
           will be removed by fmgr_reset_app_select */
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
		mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
    }
    /* 10. free memory */
    if (g_uc_p->srv_main->file_path)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
        g_uc_p->main.post_handler = NULL;
    }
    /* 7-2. check signature */

    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_entry_sig_displayConfirm_generic();
    }
    if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
    }
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    return;
}

#ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_auto_resize_img_handler
 * DESCRIPTION
 *  resize image based on current left mms size --> it's non-blocking
 * PARAMETERS
 *  post_handler        [IN]        
 *  filePath            [?]         
 *  dest_file           [?]         
 *  mms_type            [IN]        
 *  width               [IN]        
 *  height              [IN]        
 *  left_mms_size       [IN]        
 *  first               [IN]        
 * RETURNS
 *  void
 * BOOL
 *****************************************************************************/
void mmi_uc_auto_resize_img_handler(
        psFuncResizeFunc post_handler,
        U8 *filePath,
        U8 *dest_file,
        mma_insert_type_enum mms_type,
        S32 width,
        S32 height,
        S32 left_mms_size,
        BOOL first)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    S32 new_width = width;
    S32 new_height = height;
    S32 max_res_width = 0;
    S32 max_res_height = 0;
    S32 resize_result;
    S32 encoded_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((MMA_INSERT_IMAGE != mms_type) || (left_mms_size < 0))
    {
        MMI_ASSERT(0);
        return;
    }

    if (post_handler == NULL)
    {
        MMI_ASSERT(0);
        return;
    }
    /* 1. Decide the resolution W*H */
    if (!first)
    {
        if (mmi_uc_cal_img_resolution(width, height, (S32*) & new_width, (S32*) & new_height) == MMI_FALSE)
        {
            mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            if (g_uc_p->srv_main->file_path)
            {
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
            }
            return;
        }
    }
#ifdef __MMI_MMS_MAX_IMAGE_RESIZING_RESOLUTION__
    else
    {
        MMI_BOOL local_flag = TRUE;

    #if (__MMI_MMS_MAX_IMAGE_RESIZING_RESOLUTION__ == __160x120__)
        {
            max_res_width = 160;
            max_res_height = 120;
        }
    #elif (__MMI_MMS_MAX_IMAGE_RESIZING_RESOLUTION__ == __320x240__)
        {
            max_res_width = 320;
            max_res_height = 240;
        }
    #elif (__MMI_MMS_MAX_IMAGE_RESIZING_RESOLUTION__ == __640x480__)
        {
            max_res_width = 640;
            max_res_height = 480;
        }
    #endif 
        while (((max_res_width * max_res_height) < (new_width * new_height)) && local_flag)
        {
            width = new_width;
            height = new_height;
            local_flag = mmi_uc_cal_img_resolution(width, height, (S32*) & new_width, (S32*) & new_height);
        }
    }
#endif /* __MMI_MMS_MAX_IMAGE_RESIZING_RESOLUTION__ */ 

    /* 2. Try to resize, encode to jpeg file, filePath should always be the orignal one which is returned by fmgr, 
       here, = g_uc_p->srv_main->file_path */
    resize_result = mmi_uc_resize_image_and_mms_check(filePath, dest_file, new_width, new_height, left_mms_size, &encoded_size);

    MMI_TRACE(
        MMI_COMMON_TRC_G6_MSG,
        TRC_MMI_UC_AUTO_RESIZE_IMG_HDLR_P5,
        resize_result,
        new_width,
        new_height,
        left_mms_size,
        encoded_size);
    g_uc_p->main.resized_w = new_width;
    g_uc_p->main.resized_h = new_height;

    if (SRV_UC_RESIZING_ERR_SIZE_LARGER_THAN_EXPECTATION == resize_result)      /* if still larger than expected size */
    {
        g_uc_p->main.post_handler = post_handler;
        StartTimer(UC_IMG_RESIZE_TIMER_ID, MMI_UC_IMG_RESIZE_TIME_OUT, mmi_uc_auto_resize_img_timeout_handler);
    }
    else if (SRV_UC_RESIZING_SUCCEED == resize_result)  /* img is resized successfully and already saved to dest_file */
    {
        /* if succeed, mean the resized file is produced by mmi_uc_resize_image_and_mms_check. */
        srv_uc_update_filepath_with_string(g_uc_p->main.instance, (S8*) dest_file);
        post_handler(MMA_INSERT_IMAGE, dest_file, (PU16) dest_file);
    }
    else    /* error */
    {
        mmi_uc_display_resize_result_popup((S32) resize_result);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        if (g_uc_p->srv_main->file_path)
        {
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
        }
    }
    return;
}

#endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_select_object_from_fm_to_insert
 * DESCRIPTION
 *  Select object from file manager
 * PARAMETERS
 *  filePath        [IN]        
 *  is_short        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_select_object_from_fm_to_insert(PU16 filePath, S32 is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* move file path related check to mmi_uc_select_object_from_fm_to_insert_warning_mode_check */
    /* 1. processing screen */
 /*   mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
    mmi_uc_entry_processing_generic();*/
    mmi_uc_post_handler_select_object_from_fm_to_insert(mms_type, (PU8) filePath, filePath);
    return;
}

#if defined(__MMI_MESSAGES_TEMPLATE__)


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_insert_text_template
 * DESCRIPTION
 *  Insert template
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_insert_text_template(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR* templ = NULL;
    mmi_scrn_node_struct node_info;
    U16 templateCharNum = 0;
    U8 result = 1, tone = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_TEXT_TEMPLATE);

    templ = cui_sms_template_list_get_select_content(g_uc_p->main.cui_template_gid);

    if (templ)
    {
        templateCharNum = mmi_ucs2strlen((PS8) templ);
        if (mmi_uc_check_insert_text((U8*) templ))
        {
            if (mmi_frm_scrn_get_info(g_uc_p->main.parent_grp_id, SCR_ID_UC_EDITOR, &node_info) == MMI_RET_OK)
            {
                result = wgui_uce_insert_text_template((U8*) templ, templateCharNum, node_info.gui_buf);
            }
            else
            {
                MMI_ASSERT(0);
            }
        }
        else
        {
            tone = (U8) SRV_UC_NO_SPACE_TONE;
        }
    }

    cui_sms_template_close(g_uc_p->main.mmi_sms_template_gid);
    mmi_uc_set_group_id();

    /* to pop up without playing tone. editor alreay play tone */
    /* also pop up no space if not add all characters */
    if (tone == (U8) SRV_UC_NO_SPACE_TONE)
    {
        mmi_uc_display_popup(SRV_UC_NO_SPACE_TONE);
    }
    else if ((result == 0 && templateCharNum != 0) || (result != templateCharNum))
    {
        mmi_uc_display_popup(SRV_UC_NO_SPACE);
    }

    //mmi_sms_deInit_templates();
}
#endif /* defined(__MMI_MESSAGES_TEMPLATE__) */ 

#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__ 

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_select_bookmark_group_proc
 * DESCRIPTION
 *  Entry bookmark list
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
 static mmi_ret mmi_uc_select_bookmark_group_proc(mmi_event_struct *evt)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
		case EVT_ID_MEM_FREE_ASM:
			cui_bkm_sel_bkm_close(g_uc_p->main.uc_bookmark_cui_id);
            g_uc_p->main.cui_bookmark_gid = GRP_ID_INVALID;
            g_uc_p->main.uc_bookmark_cui_id = GRP_ID_INVALID;
			break;

        case EVT_ID_GROUP_DEINIT:
            cui_bkm_sel_bkm_close(g_uc_p->main.uc_bookmark_cui_id);
            g_uc_p->main.cui_bookmark_gid = GRP_ID_INVALID;
            g_uc_p->main.uc_bookmark_cui_id = GRP_ID_INVALID;
            break;

        //#if defined(__MMI_FILE_MANAGER__)
        case EVT_ID_CUI_BKM_SEL_BKM_RESULT:
		        { 
                    cui_bkm_sel_bkm_result_evt_struct *bmk_evt = (cui_bkm_sel_bkm_result_evt_struct *)evt;
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_HANDLE_SELECT_BOOKMARK_RSP_P1, 1);
		        	mmi_uc_handle_select_bookmark_rsp(bmk_evt->selected_utf8_url);
                    cui_bkm_sel_bkm_close(g_uc_p->main.uc_bookmark_cui_id);
		            break;
		        }
        case EVT_ID_CUI_BKM_ADD_BKM_CLOSE:
		        { 
		        	cui_bkm_sel_bkm_close(g_uc_p->main.uc_bookmark_cui_id);
		            break;
		        }
        //#endif
    }
    if (evt->evt_id == EVT_ID_MEM_FREE_ASM)
    {
        return MMI_MEM_FREED;
    }
    else
    {
		return MMI_RET_OK;
	}
}

#endif
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__ 
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_insert_bookmark
 * DESCRIPTION
 *  Entry bookmark list
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_insert_bookmark(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.cui_bookmark_gid = GRP_ID_INVALID;
    g_uc_p->main.uc_bookmark_cui_id = GRP_ID_INVALID;

    g_uc_p->main.uc_bookmark_cui_id = mmi_frm_group_create (GRP_ID_ROOT/*g_uc_p->main.uc_cui_gid*/, GRP_ID_AUTO_GEN, mmi_uc_select_bookmark_group_proc, NULL);
    mmi_frm_group_enter(g_uc_p->main.uc_bookmark_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    g_uc_p->main.cui_bookmark_gid = cui_bkm_sel_bkm_create(g_uc_p->main.uc_bookmark_cui_id);

    if (g_uc_p->main.cui_bookmark_gid > 0)
    {
        cui_bkm_sel_bkm_run(g_uc_p->main.cui_bookmark_gid);
    }
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_cui_event_handler_for_name_entry_proc
 * DESCRIPTION
 *  Function for unified composer to process the result of cui events
 * PARAMETERS
 *  evt     [IN]
 * RETURNS
 *  process result of msg
 *****************************************************************************/
static mmi_ret mmi_uc_cui_event_handler_for_name_entry_proc(mmi_event_struct *evt)
{
    switch (evt->evt_id)
    {
        case EVT_ID_PHB_SELECT_CONTACT:
            {
                cui_phb_select_contact_result_struct* select_contact_result = (cui_phb_select_contact_result_struct*)evt;

                mmi_uc_insert_name_from_phb( (S8*)select_contact_result->name, (S8*)select_contact_result->select_data);
                cui_phb_list_select_contact_close(g_uc_p->main.select_contact_cui_gid);
            }
            break;
        default:
            break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_cui_event_handler_for_number_entry_proc
 * DESCRIPTION
 *  Function for unified composer to process the result of cui events
 * PARAMETERS
 *  evt     [IN]
 * RETURNS
 *  process result of msg
 *****************************************************************************/
static mmi_ret mmi_uc_cui_event_handler_for_number_entry_proc(mmi_event_struct *evt)
{
    switch (evt->evt_id)
    {
        case EVT_ID_PHB_SELECT_CONTACT:
            {
                cui_phb_select_contact_result_struct* select_contact_result = (cui_phb_select_contact_result_struct*)evt;

                mmi_uc_insert_number_from_phb( (S8*)select_contact_result->name, (S8*)select_contact_result->select_data);
                cui_phb_list_select_contact_close(g_uc_p->main.select_contact_cui_gid);
            }
            break;
        default:
            break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_insert_phb_number
 * DESCRIPTION
 *  Highlight Insert PHB number handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_insert_phb_number(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //mmi_frm_group_entry_ex(GRP_ID_ROOT, APP_UNIFIEDCOMPOSER, mmi_uc_cui_event_handler_for_number_entry_proc, NULL, NULL);
    mmi_frm_group_create(GRP_ID_ROOT, APP_UNIFIEDCOMPOSER, mmi_uc_cui_event_handler_for_number_entry_proc, NULL);
    mmi_frm_group_enter(APP_UNIFIEDCOMPOSER, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    g_uc_p->main.select_contact_cui_gid = cui_phb_list_select_contact_create(APP_UNIFIEDCOMPOSER);
    if(g_uc_p->main.select_contact_cui_gid != GRP_ID_INVALID)
    {
        cui_phb_list_select_contact_set_field_filter(g_uc_p->main.select_contact_cui_gid, SRV_PHB_ENTRY_FIELD_GSM_NUM);
        cui_phb_list_select_contact_run(g_uc_p->main.select_contact_cui_gid);
    }
    else
    {
        mmi_frm_group_close(APP_UNIFIEDCOMPOSER);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_insert_phb_name
 * DESCRIPTION
 *  Highlight Insert PHB name handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_insert_phb_name(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //mmi_frm_group_entry_ex(GRP_ID_ROOT, APP_UNIFIEDCOMPOSER, mmi_uc_cui_event_handler_for_name_entry_proc, NULL, NULL);
    mmi_frm_group_create(GRP_ID_ROOT, APP_UNIFIEDCOMPOSER, mmi_uc_cui_event_handler_for_name_entry_proc, NULL);
    mmi_frm_group_enter(APP_UNIFIEDCOMPOSER, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    g_uc_p->main.select_contact_cui_gid = cui_phb_list_select_contact_create(APP_UNIFIEDCOMPOSER);
    if(g_uc_p->main.select_contact_cui_gid != GRP_ID_INVALID)
    {
        cui_phb_list_select_contact_set_field_filter(g_uc_p->main.select_contact_cui_gid, SRV_PHB_ENTRY_FIELD_NAME);
        cui_phb_list_select_contact_run(g_uc_p->main.select_contact_cui_gid);
    }
    else
    {
        mmi_frm_group_close(APP_UNIFIEDCOMPOSER);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_insert_number_from_phb
 * DESCRIPTION
 *  Insert phonebook number into write msg
 * PARAMETERS
 *  name        [?]     
 *  number      [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_insert_number_from_phb(S8 *name, S8 *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_scrn_node_struct node_info;
    U16 char_num = 0;
    U8 result = 1, tone = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_NUMBER_FROM_PHB);
    mmi_uc_set_group_id();

    if (NULL != number && (char_num = mmi_ucs2strlen(number)) > 0)
    {
        if (mmi_uc_check_insert_text((U8*) number))
        {
            if (mmi_frm_scrn_get_info(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, &node_info) == MMI_RET_OK)
            {
                result = wgui_uce_insert_text_template((U8*) number, char_num, node_info.gui_buf);
            }
            else
            {
                MMI_ASSERT(0);
            }
        }
        else
        {
            tone = (U8) SRV_UC_NO_SPACE_TONE;
        }
    }


    if (tone == (U8) SRV_UC_NO_SPACE_TONE)
    {
        mmi_uc_display_popup(SRV_UC_NO_SPACE_TONE);
    }
    else if (((result == 0) && (char_num != 0)) || (result != char_num))
    {
        mmi_uc_display_popup(SRV_UC_NO_SPACE);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_insert_name_from_phb
 * DESCRIPTION
 *  Insert phonebook name into write msg
 * PARAMETERS
 *  name        [?]     
 *  number      [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_insert_name_from_phb(S8 *name, S8 *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_scrn_node_struct node_info;
    U16 char_num = 0;
    U8 result = 1, tone = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_NAME_FROM_PHB);
    mmi_uc_set_group_id();

    if (NULL != name && (char_num = mmi_ucs2strlen(name)) > 0)
    {
        if (mmi_uc_check_insert_text((U8*) name))
        {
            if (mmi_frm_scrn_get_info(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, &node_info) == MMI_RET_OK)
            {
                result = wgui_uce_insert_text_template((U8*) name, char_num, node_info.gui_buf);
            }
            else
            {
                MMI_ASSERT(0);
            }
        }
        else
        {
            tone = (U8) SRV_UC_NO_SPACE_TONE;
        }
    }
    else
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_EMPTY)), MMI_EVENT_ERROR, NULL);

        return;
    }


    if (tone == (U8) SRV_UC_NO_SPACE_TONE)
    {
        mmi_uc_display_popup(SRV_UC_NO_SPACE_TONE);
    }
    else if (((result == 0) && (char_num != 0)) || (result != char_num))
    {
        mmi_uc_display_popup(SRV_UC_NO_SPACE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_remove_object
 * DESCRIPTION
 *  Remove the object from current slide
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_remove_object(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (g_uc_p->main.highlighted_object_type)
    {
        case SRV_UC_OBJECT_TYPE_IMAGE:
        {
            if (srv_uc_is_resized_image(g_uc_p->srv_msg->msg_body.curr_slide->img.object->file_path_ucs, g_uc_p->main.instance) == MMI_TRUE)
            {
                FS_Delete((WCHAR*) g_uc_p->srv_msg->msg_body.curr_slide->img.object->file_path_ucs);
            }

            if (g_uc_p->srv_msg->msg_body.curr_slide->img.object->reference_count > 1)
            {
                g_uc_p->srv_msg->msg_body.curr_slide->img.object->reference_count--;
            }
            else
            {
                srv_uc_delete_object_from_list(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide->img.object);
            }
            memset(&(g_uc_p->srv_msg->msg_body.curr_slide->img), 0, sizeof(mma_mms_slide_object_struct));
            wgui_uce_delete_object((wgui_uce_object_type_enum)mmi_uc_convert_to_editor_object_type(SRV_UC_OBJECT_TYPE_IMAGE));

            srv_uc_reset_layout_if_needed(g_uc_p->main.instance);

            if (mmi_uc_change_msg_type_if_needed())
            {
                mmi_uc_insert_signature_check();
            }
            srv_uc_update_msg_size(g_uc_p->main.instance);

            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_REMOVED)), MMI_EVENT_EXPLICITLY_DELETED, NULL);
            
            mmi_uc_set_group_id();
        }
            break;

        case SRV_UC_OBJECT_TYPE_AUDIO:
        {
			mma_setting_struct sliding_time;
            if (g_uc_p->srv_msg->msg_body.curr_slide->aud.object->reference_count > 1)
            {
                g_uc_p->srv_msg->msg_body.curr_slide->aud.object->reference_count--;
            }
            else
            {
                srv_uc_delete_object_from_list(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide->aud.object);
            }
            memset(&(g_uc_p->srv_msg->msg_body.curr_slide->aud), 0, sizeof(mma_mms_slide_object_struct));
			srv_mms_compose_settings_default_slide_time(&sliding_time);
			g_uc_p->srv_msg->msg_body.curr_slide->duration=sliding_time.value;

            wgui_uce_delete_object((wgui_uce_object_type_enum)mmi_uc_convert_to_editor_object_type(SRV_UC_OBJECT_TYPE_AUDIO));

            if (mmi_uc_change_msg_type_if_needed())
            {
                mmi_uc_insert_signature_check();
            }
            srv_uc_update_msg_size(g_uc_p->main.instance);

            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_REMOVED)), MMI_EVENT_EXPLICITLY_DELETED, NULL);
            
            mmi_uc_set_group_id();
        }
            break;

        case SRV_UC_OBJECT_TYPE_VIDEO:
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->vid.object->reference_count > 1)
            {
                g_uc_p->srv_msg->msg_body.curr_slide->vid.object->reference_count--;
            }
            else
            {
                srv_uc_delete_object_from_list(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide->vid.object);
            }
            memset(&(g_uc_p->srv_msg->msg_body.curr_slide->vid), 0, sizeof(mma_mms_slide_object_struct));
            wgui_uce_delete_object((wgui_uce_object_type_enum)mmi_uc_convert_to_editor_object_type(SRV_UC_OBJECT_TYPE_VIDEO));

            srv_uc_reset_layout_if_needed(g_uc_p->main.instance);

            if (mmi_uc_change_msg_type_if_needed())
            {
                mmi_uc_insert_signature_check();
            }
            srv_uc_update_msg_size(g_uc_p->main.instance);

            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_REMOVED)), MMI_EVENT_EXPLICITLY_DELETED, NULL);
            
            mmi_uc_set_group_id();
        }
            break;

        case SRV_UC_OBJECT_TYPE_ATTACHMENT:
        {
            MMI_ASSERT(g_uc_p->srv_msg->msg_body.total_ref_no<= g_uc_p->srv_msg->msg_body.total_attach_no);

            /* List == ref list + attachment list */
            /* 1. REF */
            if (g_uc_p->main.object_index < g_uc_p->srv_msg->msg_body.total_ref_no)
            {
                /* selected object in the list is ref object */
                mma_mms_slide_ref_object_struct *ref = srv_uc_get_ref_by_index(g_uc_p->main.instance, g_uc_p->main.object_index);
                /* because ref, could be multiple refereced */

                if (ref->object->reference_count > 1)
                {
                    ref->object->reference_count--;
                }
                else
                {
                    srv_uc_delete_object_from_list(g_uc_p->main.instance, ref->object);
                }

                /* remove it from slide structure */
                srv_uc_delete_ref_by_index(g_uc_p->main.instance, g_uc_p->main.object_index);

            }
            /* 2. Attachment */
            else
            {
                /* selected object in the list is attach object */

                mma_mms_attachment_info_struct *att = srv_uc_get_attachment_by_index(
                                                        g_uc_p->main.instance,
                                                        (U16) (g_uc_p->main.object_index - g_uc_p->srv_msg->msg_body.total_ref_no));

                MMI_ASSERT(att->object->reference_count == 1);
				if(!(att->object->reference_count == 1))
				{
				MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
				}
                srv_uc_delete_object_from_list(g_uc_p->main.instance, att->object);
                srv_uc_delete_attachment_from_list(g_uc_p->main.instance, att);
            }

            if (mmi_uc_change_msg_type_if_needed())
            {
                mmi_uc_insert_signature_check();
            }
            srv_uc_update_msg_size(g_uc_p->main.instance);

            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_REMOVED)), MMI_EVENT_EXPLICITLY_DELETED, NULL);

            if (g_uc_p->srv_msg->msg_body.total_attach_no == 0)
            {
                mmi_uc_set_group_id();
                wgui_uce_delete_object((wgui_uce_object_type_enum)mmi_uc_convert_to_editor_object_type(SRV_UC_OBJECT_TYPE_ATTACHMENT));
            }
        }
            break;

        default:
        {
            MMI_ASSERT(0);
        }
            break;
    }
    if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
    }
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
}

#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_image_replace_with_resize_image
 * DESCRIPTION
 *  resize image to replace
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_image_replace_with_resize_image(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_check_resize_image_to_replace(
        mms_type,
        (U8*) g_uc_p->srv_main->file_path,
        (PU16) g_uc_p->srv_main->file_path);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_image_validate_resize_to_replace_warning_mode_check
 * DESCRIPTION
 *  should fill parameter
 * PARAMETERS
 *  mms_type                [IN]        
 *  mmi_uc_image_path       [IN]        
 *  filePath                [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_image_validate_resize_to_replace_warning_mode_check(
        mma_insert_type_enum mms_type,
        U8 *mmi_uc_image_path,
        PU16 filePath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_insert_check_struct check_result = {KAL_FALSE, KAL_FALSE, KAL_FALSE, MMA_RESULT_OK, MMA_INSERT_UNKNOWN, MMA_DRM_NONE};
    mma_insert_info_struct insert_info = {0, 0, MMA_CREATION_MODE_FREE, MMA_INSERT_UNKNOWN, MMA_MMS_TYPE_SMIL_MMS, NULL};

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = 0;   /* becasue only check warning mode, no need curr size */
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = mms_type;
    insert_info.filepath = (kal_wchar*) filePath;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_result);

    if (check_result.result && (MMA_RESULT_OK_WITH_WARNING_CONTENT == check_result.detail_result))
    {

		mmi_uc_set_group_id();
		cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
        mmi_uc_setSoftkeyFunction(
            mmi_uc_image_replace_with_resize_image,
            mmi_uc_goback_history_to_editor,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
            (U16) STR_UC_WARNING_MODE_CONFIRM);
        mmi_uc_entry_displayConfirm_generic();
        return;
    }
    mmi_uc_image_replace_with_resize_image();
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_replace
 * DESCRIPTION
 *  resizing for replacing
 * PARAMETERS
 *  filePath        [IN]        
 *  is_short        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_replace(U16 *filePath, BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;
    //mma_mms_object_struct *new_object = NULL;
    //mma_mms_object_struct *duplicated_object = NULL;
    mma_mms_object_struct *replaced_object = NULL;
    //mma_mms_attachment_info_struct *att = NULL;
    //mma_mms_slide_ref_object_struct *ref = NULL;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);
    //U32 new_obj_smil_size = 0;
    //U32 replaced_obj_smil_size = 0;
    //U32 replaced_obj_body_size = 0;
    //U32 new_msg_size = 0;
	S32 img_width = 0, img_height = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(mmi_uc_image_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);
    /* move filepath related check to mmi_uc_select_object_from_fm_to_replace_warning_mode_check */

	gdi_image_get_dimension_file((PS8) filePath, &img_width, &img_height);
	if ((img_width != 0) && (img_height != 0))
    {
        /* calculate the dimension of the resize JPEG */
        if (((S32) img_width > (S32) g_uc_p->srv_mms_info->image_resize.width) || ((S32) img_height > (S32) g_uc_p->srv_mms_info->image_resize.height))
        {
			mmi_uc_set_group_id();
			cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
			mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
			mmi_uc_entry_processing_generic();
		}
	}

    replaced_object = srv_uc_get_object_in_slide(slide, g_uc_p->main.highlighted_object_type);

    if (replaced_object == NULL)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_CONTENT_ERROR_ID)), MMI_EVENT_ERROR, NULL);
		mmi_uc_set_group_id();
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
        return;
    }

#ifdef __MMI_UC_MMS_IMG_RESOLUTION__
    if ((g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED) &&
        !(g_uc_p->srv_mms_info->image_resize.enable))
    {
        mms_get_max_image_resolution_in_restricted_mode(
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.width)),
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.height)));
    }
#endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 

    {
        S32 resize_result;

        if (!mmi_uc_is_valid_image(filePath))
        {
            mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }

        srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);
    #ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__
        if (g_uc_p->srv_mms_info->image_resize.width == 0 && g_uc_p->srv_mms_info->image_resize.height == 0)    /* means auto size and no img_resolution_need_resize */
        {
            gdi_image_get_dimension_file(
                (PS8) filePath,
                (S32*) & (g_uc_p->main.resized_w),
                (S32*) & (g_uc_p->main.resized_h));
        }
        else
        {
            g_uc_p->main.resized_w = g_uc_p->srv_mms_info->image_resize.width;
            g_uc_p->main.resized_h = g_uc_p->srv_mms_info->image_resize.height;
        }

        {
            S32 left_size = 0;
            MMI_BOOL flag_for_restricted_popup = (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
                                                  mms_get_max_msg_size_in_restricted_mode() <=
                                                  g_uc_p->srv_mms_info->max_mms_size) ? MMI_TRUE : MMI_FALSE;
            U32 max_mms_size =
                (flag_for_restricted_popup) ? mms_get_max_msg_size_in_restricted_mode() : g_uc_p->srv_mms_info->
                max_mms_size;

            left_size = max_mms_size - g_uc_p->srv_msg->msg_size + replaced_object->size
                + mma_uc_calc_object_overhead_size(
                    mms_type,
                    (PU16) replaced_object->file_path_ucs,
                    g_uc_p->srv_mms_info->max_mms_size,
                    srv_uc_get_mms_type(g_uc_p->main.instance)) -
                mma_uc_calc_object_overhead_size(
                    mms_type,
                    (PU16) mmi_uc_image_path,
                    max_mms_size,
                    srv_uc_get_mms_type(g_uc_p->main.instance));

            if (left_size <= 0)
            {
                (flag_for_restricted_popup) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }
            g_uc_p->main.post_handler = mmi_uc_image_validate_resize_to_replace_warning_mode_check;
            /* here, file path is = g_uc_p->srv_main->file_path */
            mmi_uc_auto_resize_img_handler(
                g_uc_p->main.post_handler,
                (U8*) filePath,
                mmi_uc_image_path,
                mms_type,
                g_uc_p->main.resized_w,
                g_uc_p->main.resized_h,
                left_size,
                MMI_TRUE);

            return;
        }

    #else /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
        resize_result = mmi_uc_resize_image(
                            (U8*) filePath,
                            mmi_uc_image_path,
                            g_uc_p->srv_mms_info->image_resize.width,
                            g_uc_p->srv_mms_info->image_resize.height);

    #endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
        /* Error ! */
        if (resize_result < 0)
        {

            mmi_uc_display_resize_result_popup((S32) resize_result);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
        /* resized */
        else if (resize_result)
        {
            filePath = (PU16) mmi_uc_image_path;
            srv_uc_update_filepath_with_string(g_uc_p->main.instance, (S8*) mmi_uc_image_path);
        }
        /* resize_result == 0 means no need to resize */
        else    /* SRV_UC_RESIZING_SUCCEED_WITH_UNCHANGED= 0, filepath is still original one */
        {
            /* mmi_uc_display_resize_result_popup((S32)resize_result); */
        }
    }
    mmi_uc_image_validate_resize_to_replace_warning_mode_check(mms_type, (U8*) mmi_uc_image_path, (PU16) filePath);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_select_object_from_fm_to_replace
 * DESCRIPTION
 *  should fill parameter
 * PARAMETERS
 *  void
 *  is_short(?)     [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_select_object_from_fm_to_replace(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_select_object_from_fm_to_replace((PU16) g_uc_p->srv_main->file_path, g_uc_p->main.is_short);

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_select_object_from_fm_to_replace_warning_mode_check
 * DESCRIPTION
 *  Select object from file manager
 * PARAMETERS
 *  filePath        [IN]        
 *  is_short        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_select_object_from_fm_to_replace_warning_mode_check(PU16 filePath, S32 is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FS_HANDLE handle;
    U32 flie_path_len = 0;
    mma_insert_check_struct check_result;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);
    mma_insert_info_struct insert_info;
    MMI_BOOL img_resolution_need_resize = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&check_result, 0, sizeof(mma_insert_check_struct));

    if (filePath == NULL)
    {
        if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
        {
            if (g_uc_p->srv_msg->msg_body.total_attach_no > 0)
            {
                /* go to attachment options */
            }
            else
            {
                mmi_uc_set_group_id();
            }
        }
        else
        {
            mmi_uc_set_group_id();
        }
        return;
    }

    if ((handle = FS_GetAttributes((PU16) filePath)) < 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(srv_fmgr_fs_error_get_string(handle))), MMI_EVENT_FAILURE, NULL);
        return;
    }

    if ((g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT &&
         g_uc_p->main.object_index == SRV_UC_INVALID_INDEX) ||
        (g_uc_p->main.highlighted_object_type != SRV_UC_OBJECT_TYPE_ATTACHMENT &&
         !srv_uc_get_object_in_slide(g_uc_p->srv_msg->msg_body.curr_slide, g_uc_p->main.highlighted_object_type)))
    {
        mmi_uc_select_object_from_fm_to_insert_warning_mode_check(filePath, is_short);
        return;
    }

    /* use self parameter to save file name info */
    if (g_uc_p->srv_main->file_path)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }

    flie_path_len = mmi_ucs2strlen((S8*) filePath);

    g_uc_p->srv_main->file_path = kal_adm_alloc(g_uc_p->main.mem_pool_id, (flie_path_len + 1) * ENCODING_LENGTH);

    MMI_ASSERT(g_uc_p->srv_main->file_path);
    mmi_ucs2ncpy((S8*) g_uc_p->srv_main->file_path, (S8*) filePath, flie_path_len);

    g_uc_p->main.is_short = is_short;

    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = 0;   /* becasue only check warning mode, no need curr size */
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = mms_type;
    insert_info.filepath = (kal_wchar*) filePath;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_result);
    /* Main use is in Image case to show error popup before resize test. */
    if (!(check_result.result) &&
        ((MMA_RESULT_FAIL_FILE_IO == check_result.detail_result) ||
         (MMA_RESULT_FAIL_FILE_CORRUPTED == check_result.detail_result) ||
         (MMA_RESULT_FAIL_FILE_EMPTY == check_result.detail_result) ||
         (MMA_RESULT_FAIL_IMAGE_TOO_LARGE == check_result.detail_result)))
    {
        srv_uc_result result;

        result = srv_uc_convert_mms_check_result(&check_result);
        mmi_uc_display_popup(result);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
        return;
    }
    if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE && check_result.drm_type == MMA_DRM_NONE)
    {
        if (g_uc_p->srv_mms_info->image_resize.enable)
        {
            img_resolution_need_resize = MMI_TRUE;
        }
    #ifdef __MMI_UC_MMS_IMG_RESOLUTION__
        else if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
        {
            img_resolution_need_resize = srv_uc_img_resolution_exceed_limitation(filePath);
        }
    #endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 
    }
    if (!img_resolution_need_resize &&
        check_result.result && (MMA_RESULT_OK_WITH_WARNING_CONTENT == check_result.detail_result))
    {
        mmi_uc_set_group_id();
		cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);
        mmi_uc_setSoftkeyFunction(
            mmi_uc_process_select_object_from_fm_to_replace,
            mmi_uc_goback_history_to_editor,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
            (U16) STR_UC_WARNING_MODE_CONFIRM);
        mmi_uc_entry_displayConfirm_generic();
        return;
    }
    else if (img_resolution_need_resize)
    {
        S32 fmgr_ret = -1;
        srv_uc_result result;

        if (!check_result.result)
        {
            mmi_fmgr_util_file_limit_check2(FMGR_LIMIT_MMS_CATEGORY, (PS8) g_uc_p->srv_main->file_path, &fmgr_ret);

            if (fmgr_ret < 0)
            {
                if (fmgr_ret == GDI_IMAGE_ERR_IMAGE_TOO_LARGE)
                {
                    result = SRV_UC_FAIL_IMAGE_TOO_LARGE;
                }
                else
                {
                    result = SRV_UC_FILE_CORRUPT;
                }
                mmi_uc_display_popup(result);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
                kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
                g_uc_p->srv_main->file_path = NULL;
                return;
            }
        }
        mmi_uc_image_object_from_fm_resize_process_before_resolution_verification_to_replace(
            (PU16) g_uc_p->srv_main->file_path,
            g_uc_p->main.is_short);
        return;
    }
    mmi_uc_select_object_from_fm_to_replace((PU16) g_uc_p->srv_main->file_path, g_uc_p->main.is_short);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_check_resize_image_to_replace
 * DESCRIPTION
 *  Select object from file manager
 * PARAMETERS
 *  mms_type                [IN]        
 *  mmi_uc_image_path       [IN]        
 *  filePath                [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_check_resize_image_to_replace(mma_insert_type_enum mms_type, U8 *mmi_uc_image_path, PU16 filePath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_uc_result result;
    mma_insert_check_struct check_result;
    mma_insert_info_struct insert_info;
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;
    mma_mms_object_struct *new_object = NULL;
    mma_mms_object_struct *duplicated_object = NULL;
    mma_mms_object_struct *replaced_object = NULL;
    U32 new_obj_smil_size = 0;
    U32 replaced_obj_smil_size = 0;
    U32 replaced_obj_body_size = 0;
    U32 new_msg_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    filePath = (PU16) mmi_uc_image_path;
    memset(&check_result, 0, sizeof(mma_insert_check_struct));

    duplicated_object = srv_uc_check_duplicate_object(g_uc_p->main.instance, filePath);

    new_obj_smil_size = mma_uc_calc_object_smil_size(mms_type, filePath);
    replaced_object = srv_uc_get_object_in_slide(slide, g_uc_p->main.highlighted_object_type);
    replaced_obj_smil_size = mma_uc_calc_object_smil_size((mma_insert_type_enum)
                                srv_uc_convert_to_mms_insert_type((srv_uc_object_type)replaced_object->type),
                                (const kal_wchar*)replaced_object->file_path_ucs);

    if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
    {
        new_obj_smil_size = 0;
        replaced_obj_smil_size = 0;
    }
    if (g_uc_p->main.highlighted_object_type != SRV_UC_OBJECT_TYPE_ATTACHMENT &&
        duplicated_object && duplicated_object->type != MMA_MMS_OBJECT_TYPE_ATTACHMENT)
    {
        MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

        /* if the original object and the new object are the same, no need to delete the original object. */
        if (replaced_object->reference_count == 1 && replaced_object != duplicated_object)
        {
            if (replaced_object->is_virtual_file)
            {
                U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
                S32 result;
                S32 file_handle;
                U16 virtual_file_name_len = sizeof(virtual_file_name);

                memset(virtual_file_name, 0, virtual_file_name_len);

                file_handle = FS_Open(replaced_object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                if (file_handle <= 0)
                {
                    MMI_ASSERT(0);
                }

                result = FS_GenVirtualFileName(
                            file_handle,
                            (U16*) virtual_file_name,
                            (unsigned int)FS_GenVFN_SIZE,
                            replaced_object->offset,
                            replaced_object->size);

                if (result < 0)
                {
                    MMI_ASSERT(0);
                }

                mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                if (srv_uc_get_file_extension(replaced_object->file_name_ucs))
                {
                    mmi_ucs2ncat(
                        (PS8) virtual_file_name,
                        (PS8) srv_uc_get_file_extension(replaced_object->file_name_ucs),
                        virtual_file_name_len / ENCODING_LENGTH);
                }

                replaced_obj_body_size = mma_uc_calc_object_multipart_size((U16*) virtual_file_name);

                FS_Close(file_handle);
            }
            else
            {
                replaced_obj_body_size = mma_uc_calc_object_multipart_size(replaced_object->file_path_ucs);
            }
        }
        else
        {
            replaced_obj_body_size = 0;
        }

        new_msg_size = g_uc_p->srv_msg->msg_size + new_obj_smil_size - replaced_obj_smil_size - replaced_obj_body_size;

        if (!srv_uc_check_if_exceed_MMS_size_limitation
            (g_uc_p->main.instance, new_msg_size, &fail_in_restricted_size_check))
        {
            replaced_object->reference_count--;
            srv_uc_insert_object_to_slide(
                g_uc_p->main.instance,
                duplicated_object,
                slide,
                g_uc_p->main.highlighted_object_type);

            if (replaced_object->reference_count == 0)
            {
                srv_uc_delete_object_from_list(g_uc_p->main.instance, replaced_object);
            }

        }
        else
        {
        #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
        #ifdef WAP_SUPPORT
            if (srv_wap_prof_get_active_profile_connection_type((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) >
                SRV_WAP_PROF_CONN_TYPE_HTTP)
        #else /* WAP_SUPPORT */ 
            if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) > BRW_PROF_CONN_TYPE_HTTP)
        #endif /* WAP_SUPPORT */ 
            {
                mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
            }
            else
        #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
            {
                (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            if (mmi_ucs2strlen((S8*) mmi_uc_image_path) &&
                srv_uc_is_resized_image((U16*) mmi_uc_image_path, g_uc_p->main.instance) == MMI_TRUE)
            {
                FS_Delete((WCHAR*) mmi_uc_image_path);
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
    }
    else
    {
        /* attachment or other objects that not duplicate */
        if (replaced_object->reference_count == 1)
        {
            if (replaced_object->is_virtual_file)
            {
                U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
                S32 result;
                S32 file_handle;
                U16 virtual_file_name_len = sizeof(virtual_file_name);

                memset(virtual_file_name, 0, virtual_file_name_len);

                file_handle = FS_Open(replaced_object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                if (file_handle <= 0)
                {
                    MMI_ASSERT(0);
                }

                result = FS_GenVirtualFileName(
                            file_handle,
                            (U16*) virtual_file_name,
                            (unsigned int)FS_GenVFN_SIZE,
                            replaced_object->offset,
                            replaced_object->size);

                if (result < 0)
                {
                    MMI_ASSERT(0);
                }

                mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                if (srv_uc_get_file_extension(replaced_object->file_name_ucs))
                {
                    mmi_ucs2ncat(
                        (PS8) virtual_file_name,
                        (PS8) srv_uc_get_file_extension(replaced_object->file_name_ucs),
                        virtual_file_name_len / ENCODING_LENGTH);
                }

                replaced_obj_body_size = mma_uc_calc_object_multipart_size((U16*) virtual_file_name);

                FS_Close(file_handle);
            }
            else
            {
                replaced_obj_body_size = mma_uc_calc_object_multipart_size(replaced_object->file_path_ucs);
            }
        }
        else
        {
            replaced_obj_body_size = 0;
        }

        new_msg_size = g_uc_p->srv_msg->msg_size - replaced_obj_smil_size - replaced_obj_body_size;

        insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
        insert_info.current_msg_size = new_msg_size;
        insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
        insert_info.insert_type = mms_type;
        insert_info.filepath = (kal_wchar*) filePath;
        insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

        mma_uc_insert_object_check(&insert_info, &check_result);

        if (!(check_result.result))
        {
            result = srv_uc_convert_mms_check_result(&check_result);
            mmi_uc_display_popup(result);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            if (mmi_ucs2strlen((S8*) mmi_uc_image_path) &&
                srv_uc_is_resized_image((U16*) mmi_uc_image_path, g_uc_p->main.instance) == MMI_TRUE)
            {
                FS_Delete((WCHAR*) mmi_uc_image_path);
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }

        replaced_object->reference_count--;

        if (replaced_object->reference_count == 0)
        {
            srv_uc_delete_object_from_list(g_uc_p->main.instance, replaced_object);
        }

        /* in mmi_uc_insert_object, will re-assign type (maybe some att should be ref) */
        new_object = srv_uc_insert_object(g_uc_p->main.instance, (S8*) filePath, g_uc_p->main.highlighted_object_type);
        new_object->drm_type = check_result.drm_type;

        srv_uc_insert_object_to_slide(g_uc_p->main.instance, new_object, slide, g_uc_p->main.highlighted_object_type);
    }

    /* In this case, mmi_uc_insert_signature_check should return F */

    if (mmi_uc_change_msg_type_if_needed())
    {
        mmi_uc_insert_signature_check();
    }

    srv_uc_update_msg_size(g_uc_p->main.instance);
    mmi_uc_editor_initialize();
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    mmi_uc_recipient_initialize();
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
	mmi_uc_set_group_id();
    cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);

    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING || mmi_frm_scrn_get_active_id() == SCR_ID_UC_CONFIRM)
    {
        {
            U16 next_scrn_id = 0, top_scrn_id = 0;
            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
        }
    }
    else
    {
        U16 screen_id = 0;

        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        screen_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
        if (screen_id)
        {

            /* if popup happens, the progressing screen will be push to history, and be deleted by fmgr (fmgr_reset_app_select) */
            if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
            {
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, 1, 0, screen_id, 1);
            }
            else
            {
                /* because popup will push progressing screen to history and therefore the progessing screen
                   will be removed by fmgr_reset_app_select */
                {
                    U16 next_scrn_id = 0, top_scrn_id = 0;
                    top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                    next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                    mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                }
            }

        }
        else
        {
            /* SCR_ID_UC_EDITOR is the last screen in history */
            /* MMI_ASSERT(0); */
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        }

    }
    if (g_uc_p->srv_main->file_path)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }
	if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_select_object_from_fm_to_replace
 * DESCRIPTION
 *  Select object from file manager
 * PARAMETERS
 *  filePath        [IN]        
 *  is_short        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_select_object_from_fm_to_replace(PU16 filePath, S32 is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN] = {0,};
    srv_uc_result result;
    mma_insert_check_struct check_result;
    mma_insert_info_struct insert_info;
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;
    mma_mms_object_struct *new_object = NULL;
    mma_mms_object_struct *duplicated_object = NULL;
    mma_mms_object_struct *replaced_object = NULL;
    mma_mms_attachment_info_struct *att = NULL;
    mma_mms_slide_ref_object_struct *ref = NULL;
    srv_uc_object_type replace_obj_type;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);
    U32 new_obj_smil_size = 0;
    U32 replaced_obj_smil_size = 0;
    U32 replaced_obj_body_size = 0;
    U32 new_msg_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&check_result, 0, sizeof(mma_insert_check_struct));
    memset(mmi_uc_image_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);

    if ((g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT &&
         g_uc_p->main.object_index == SRV_UC_INVALID_INDEX) ||
        (g_uc_p->main.highlighted_object_type != SRV_UC_OBJECT_TYPE_ATTACHMENT &&
         !srv_uc_get_object_in_slide(g_uc_p->srv_msg->msg_body.curr_slide, g_uc_p->main.highlighted_object_type)))
    {
        mmi_uc_select_object_from_fm_to_insert(filePath, is_short);
        return;
    }
    /* move filepath related check to mmi_uc_select_object_from_fm_to_replace_warning_mode_check */

    //mmi_uc_set_group_id();
    /* Removing the progress screen from here
        mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
        mmi_uc_entry_processing_generic();*/

    if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
    {
        if (g_uc_p->main.object_index != SRV_UC_INVALID_INDEX)
        {
            MMI_ASSERT(g_uc_p->srv_msg->msg_body.total_ref_no <= g_uc_p->srv_msg->msg_body.total_attach_no);
            /* List == ref list + attachment list */
            /* 1. REF */
            if (g_uc_p->main.object_index < g_uc_p->srv_msg->msg_body.total_ref_no)
            {
                /* selected object in the list is ref object */
                ref = srv_uc_get_ref_by_index(g_uc_p->main.instance, g_uc_p->main.object_index);
                replaced_object = ref->object;
                MMI_ASSERT(replaced_object->type == MMA_MMS_OBJECT_TYPE_REF);
				if(!(replaced_object->type == MMA_MMS_OBJECT_TYPE_REF))
				{
				MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
				}
            }
            /* 2. Attach */
            else
            {
                att = srv_uc_get_attachment_by_index(
                        g_uc_p->main.instance,
                        (U16) (g_uc_p->main.object_index - g_uc_p->srv_msg->msg_body.total_ref_no));
                replaced_object = att->object;
                MMI_ASSERT(replaced_object->type == MMA_MMS_OBJECT_TYPE_ATTACHMENT);
            }
        }
    }
    else
    {
        replaced_object = srv_uc_get_object_in_slide(slide, g_uc_p->main.highlighted_object_type);
    }
    replace_obj_type = (srv_uc_object_type)replaced_object->type;

    duplicated_object = srv_uc_check_duplicate_object(g_uc_p->main.instance, filePath);

    new_obj_smil_size = mma_uc_calc_object_smil_size(mms_type, filePath);
    replaced_obj_smil_size = mma_uc_calc_object_smil_size((mma_insert_type_enum)
                                srv_uc_convert_to_mms_insert_type((srv_uc_object_type)replaced_object->type),
                                (const kal_wchar*)replaced_object->file_path_ucs);

    if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
    {
        new_obj_smil_size = 0;
        replaced_obj_smil_size = 0;
    }
    if (g_uc_p->main.highlighted_object_type != SRV_UC_OBJECT_TYPE_ATTACHMENT &&
        duplicated_object && duplicated_object->type != MMA_MMS_OBJECT_TYPE_ATTACHMENT)
    {
        MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

        /* if the original object and the new object are the same, no need to delete the original object. */
        if (replaced_object->reference_count == 1 && replaced_object != duplicated_object)
        {
            if (replaced_object->is_virtual_file)
            {
                U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
                S32 result;
                S32 file_handle;
                U16 virtual_file_name_len = sizeof(virtual_file_name);

                memset(virtual_file_name, 0, virtual_file_name_len);

                file_handle = FS_Open(replaced_object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                if (file_handle <= 0)
                {
                    MMI_ASSERT(0);
					MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
                }

                result = FS_GenVirtualFileName(
                            file_handle,
                            (U16*) virtual_file_name,
                            (unsigned int)FS_GenVFN_SIZE,
                            replaced_object->offset,
                            replaced_object->size);

                if (result < 0)
                {
                    MMI_ASSERT(0);
					MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
                }

                mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                if (srv_uc_get_file_extension(replaced_object->file_name_ucs))
                {
                    mmi_ucs2ncat(
                        (PS8) virtual_file_name,
                        (PS8) srv_uc_get_file_extension(replaced_object->file_name_ucs),
                        virtual_file_name_len / ENCODING_LENGTH);
                }

                replaced_obj_body_size = mma_uc_calc_object_multipart_size((U16*) virtual_file_name);

                FS_Close(file_handle);
            }
            else
            {
                replaced_obj_body_size = mma_uc_calc_object_multipart_size(replaced_object->file_path_ucs);
            }
        }
        else
        {
            replaced_obj_body_size = 0;
        }

        new_msg_size = g_uc_p->srv_msg->msg_size + new_obj_smil_size - replaced_obj_smil_size - replaced_obj_body_size;

        if (!srv_uc_check_if_exceed_MMS_size_limitation
            (g_uc_p->main.instance, new_msg_size, &fail_in_restricted_size_check))
        {
            replaced_object->reference_count--;
            srv_uc_insert_object_to_slide(
                g_uc_p->main.instance,
                duplicated_object,
                slide,
                g_uc_p->main.highlighted_object_type);

            if (replaced_object->reference_count == 0)
            {
                srv_uc_delete_object_from_list(g_uc_p->main.instance, replaced_object);
            }

        }
        else
        {
        #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
        #ifdef WAP_SUPPORT
            if (srv_wap_prof_get_active_profile_connection_type((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) >
                SRV_WAP_PROF_CONN_TYPE_HTTP)
        #else /* WAP_SUPPORT */ 
            if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) > BRW_PROF_CONN_TYPE_HTTP)
        #endif /* WAP_SUPPORT */ 
            {
                mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
            }
            else
        #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
            {
                (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            if (mmi_ucs2strlen((S8*) mmi_uc_image_path) &&
                srv_uc_is_resized_image((U16*) mmi_uc_image_path, g_uc_p->main.instance) == MMI_TRUE)
            {
                FS_Delete((WCHAR*) mmi_uc_image_path);
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
    }
    else
    {
        /* attachment or other objects that not duplicate */
        if (replaced_object->reference_count == 1)
        {
            if (replaced_object->is_virtual_file)
            {
                U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
                S32 result;
                S32 file_handle;
                U16 virtual_file_name_len = sizeof(virtual_file_name);

                memset(virtual_file_name, 0, virtual_file_name_len);

                file_handle = FS_Open(replaced_object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                if (file_handle <= 0)
                {
                    MMI_ASSERT(0);
                }

                result = FS_GenVirtualFileName(
                            file_handle,
                            (U16*) virtual_file_name,
                            (unsigned int)FS_GenVFN_SIZE,
                            replaced_object->offset,
                            replaced_object->size);

                if (result < 0)
                {
                    MMI_ASSERT(0);
                }

                mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                if (srv_uc_get_file_extension(replaced_object->file_name_ucs))
                {
                    mmi_ucs2ncat(
                        (PS8) virtual_file_name,
                        (PS8) srv_uc_get_file_extension(replaced_object->file_name_ucs),
                        virtual_file_name_len / ENCODING_LENGTH);
                }

                replaced_obj_body_size = mma_uc_calc_object_multipart_size((U16*) virtual_file_name);

                FS_Close(file_handle);
            }
            else
            {
                replaced_obj_body_size = mma_uc_calc_object_multipart_size(replaced_object->file_path_ucs);
            }
        }
        else
        {
            replaced_obj_body_size = 0;
        }

        new_msg_size = g_uc_p->srv_msg->msg_size - replaced_obj_smil_size - replaced_obj_body_size;

        insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
        insert_info.current_msg_size = new_msg_size;
        insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
        insert_info.insert_type = mms_type;
        insert_info.filepath = (kal_wchar*) filePath;
        insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

        mma_uc_insert_object_check(&insert_info, &check_result);

        if (!(check_result.result))
        {
            result = srv_uc_convert_mms_check_result(&check_result);
            mmi_uc_display_popup(result);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            if (mmi_ucs2strlen((S8*) mmi_uc_image_path) &&
                srv_uc_is_resized_image((U16*) mmi_uc_image_path, g_uc_p->main.instance) == MMI_TRUE)
            {
                FS_Delete((WCHAR*) mmi_uc_image_path);
            }
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }

        replaced_object->reference_count--;

        if (replaced_object->reference_count == 0)
        {
            srv_uc_delete_object_from_list(g_uc_p->main.instance, replaced_object);
        }

        /* in mmi_uc_insert_object, will re-assign type (maybe some att should be ref) */
        new_object = srv_uc_insert_object(g_uc_p->main.instance, (S8*) filePath, g_uc_p->main.highlighted_object_type);
        new_object->drm_type = check_result.drm_type;

        if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
        {
            /* tsaiml_ogdr_ref */
            srv_uc_object_type new_obj_type = SRV_UC_OBJECT_TYPE_ATTACHMENT;

        #ifdef __MMI_UC_REF__
            if (srv_uc_is_in_ref_obj_type_range((S8*) filePath))
            {
                new_obj_type = SRV_UC_OBJECT_TYPE_REF;
            }
        #endif /* __MMI_UC_REF__ */ 
            if (replace_obj_type != new_obj_type)
            {
                /* ref --> attach */
                if (replace_obj_type == SRV_UC_OBJECT_TYPE_REF)
                {
                    /* remove orignal ref info it from slide structure */
                    srv_uc_delete_ref_by_index(g_uc_p->main.instance, g_uc_p->main.object_index);

                    /* Add new attachment and associate to new object */
                    MMI_ASSERT(att == NULL);    /* should be null */
                    att = srv_uc_insert_attachment(g_uc_p->main.instance);
                    srv_uc_insert_object_to_attachment(new_object, att);
                }
                /* attach --> ref */
                else
                {
                    /* remove original attach */
                    MMI_ASSERT(att != NULL);    /* should not be null */
                    srv_uc_delete_attachment_from_list(g_uc_p->main.instance, att);

                    /* add new ref and associate to new object */
                    MMI_ASSERT(ref == NULL);    /* ref should be NULL */
                    /* do not care id, so set 0 here */
                    ref = srv_uc_insert_ref_obj_info_to_tail(
                            g_uc_p->main.instance,
                            slide,
                            0,
                            SRV_UC_INVALID_VALUE,
                            SRV_UC_INVALID_VALUE);
                    /* associate real object and the new ref obj info */
                    ref->object = new_object;
                    new_object->reference_count++;
                }
            }
            else
            {
                /* replace with obj with same type */
                if (new_obj_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
                {
                    srv_uc_delete_attachment_from_list(g_uc_p->main.instance, att);
                    att = srv_uc_insert_attachment(g_uc_p->main.instance);
                    srv_uc_insert_object_to_attachment(new_object, att);
                }
                else if (new_obj_type == SRV_UC_OBJECT_TYPE_REF)
                {
                    /* associate real object and the new ref obj info */
                    ref->object = new_object;
                    new_object->reference_count++;
                }
                else
                {
                    MMI_ASSERT(0);
                }
            }
        }
        else
        {
            srv_uc_insert_object_to_slide(
                g_uc_p->main.instance,
                new_object,
                slide,
                g_uc_p->main.highlighted_object_type);
        }
    }

    /* In this case, mmi_uc_insert_signature_check should return F */

    if (mmi_uc_change_msg_type_if_needed())
    {
        mmi_uc_insert_signature_check();
    }

    srv_uc_update_msg_size(g_uc_p->main.instance);
    mmi_uc_editor_initialize();
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    mmi_uc_recipient_initialize();
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
	mmi_uc_set_group_id();
    cui_file_selector_close(g_uc_p->main.cui_fmgr_gid);

    if (g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_ATTACHMENT)
    {
        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
        {
            {
                U16 next_scrn_id = 0, top_scrn_id = 0;
                top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ATTACHMENT_LIST, MMI_FRM_NODE_AFTER_FLAG); 
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
            }
        }
        else
        {
            U16 screen_id = 0;
            screen_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG);

            if (screen_id)
            {
                if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                {
                    mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, 1, 0, screen_id, 1);
                }
                else
                {
                    /* because popup will push progressing screen to history and therefore the progessing screen
                       will be removed by fmgr_reset_app_select */
                    {
						U16 next_scrn_id = 0, top_scrn_id = 0;
                        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
                        top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ATTACHMENT_LIST, MMI_FRM_NODE_AFTER_FLAG); 
                        mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                    }
                }
            }
            /* processing is push to history if warning mode popup case happens, then fmgr_reset_app_select 
               will delete that screen, so SCR_ID_UC_OPT_ATTACHMENT_LIST will be the last screen */
            else
            {
                /* MMI_ASSERT(0); */
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            }
        }
    }
    else
    {
        if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
        {
            {
                U16 next_scrn_id = 0, top_scrn_id = 0;
                top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
            }
        }
        else
        {
            U16 screen_id = 0;
            screen_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG);

            if (screen_id)
            {

                /* if popup happens, the progressing screen will be push to history, and be deleted by fmgr (fmgr_reset_app_select) */
                if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))//IsScreenPresent(SCR_ID_UC_PROCESSING))
                {
                    mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, 1, 0, screen_id, 1);
                }
                else
                {
                    /* because popup will push progressing screen to history and therefore the progessing screen
                       will be removed by fmgr_reset_app_select */
                    {
                        U16 next_scrn_id = 0, top_scrn_id = 0;
                        top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                        mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                    }
                }

            }
            else
            {
                /* SCR_ID_UC_EDITOR is the last screen in history */
                /* MMI_ASSERT(0); */
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            }

        }
    }
    if (g_uc_p->srv_main->file_path)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }
    if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
    }
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    return;
}
#endif /* __MMI_UC_REPLACE_MEDIA_SUPPORT__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_insert_slide
 * DESCRIPTION
 *  insert new slide
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_insert_slide(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 new_slide_size = 0;
    mma_mms_slide_struct *slide;
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
    MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_SMIL_MMS)
    {
        new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
    }

    if (!srv_uc_check_if_exceed_MMS_size_limitation
        (g_uc_p->main.instance, new_slide_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
    {
        slide = srv_uc_insert_slide(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide);
        g_uc_p->srv_msg->msg_body.curr_slide = slide;
        g_uc_p->srv_msg->current_slide_num = slide->slide_num;

        if (mmi_uc_change_msg_type_if_needed())
        {
            pass_sig_check = mmi_uc_insert_signature_check();
        }

        srv_uc_update_msg_size(g_uc_p->main.instance);
        mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);

        //srv_uc_reset_text_buffer();
        //mmi_uc_editor_initialize();

        mmi_uc_set_group_id();
        if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
        {
            mmi_uc_sig_setSoftkeyFunction(
                mmi_uc_process_warning_mode_insert_signature,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
            mmi_uc_entry_sig_displayConfirm_generic();
        }
        if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
        }
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
        }
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    }
    else
    {
    #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
    #ifdef WAP_SUPPORT
        if (srv_wap_prof_get_active_profile_connection_type((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) >
            SRV_WAP_PROF_CONN_TYPE_HTTP)
    #else /* WAP_SUPPORT */ 
        if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) > BRW_PROF_CONN_TYPE_HTTP)
    #endif /* WAP_SUPPORT */ 
        {
            mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
        }
        else
    #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
        {
            (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
        }
        return;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_insert_slide_before
 * DESCRIPTION
 *  insert new slide before current slide
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_insert_slide_before(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 new_slide_size = 0;
    mma_mms_slide_struct *slide;
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
    MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_SMIL_MMS)
    {
        new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
    }

    if (!srv_uc_check_if_exceed_MMS_size_limitation
        (g_uc_p->main.instance, new_slide_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
    {
        slide = srv_uc_insert_slide(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide->prev);
        g_uc_p->srv_msg->msg_body.curr_slide = slide;
        g_uc_p->srv_msg->current_slide_num = slide->slide_num;

        if (mmi_uc_change_msg_type_if_needed())
        {
            pass_sig_check = mmi_uc_insert_signature_check();
        }

        srv_uc_update_msg_size(g_uc_p->main.instance);
        mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);

        mmi_uc_set_group_id();

        if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
        {
            mmi_uc_sig_setSoftkeyFunction(
                mmi_uc_process_warning_mode_insert_signature,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
            mmi_uc_entry_sig_displayConfirm_generic();
        }
        if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
        }
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
        }
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    }
    else
    {
    #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
    #ifdef WAP_SUPPORT
        if (srv_wap_prof_get_active_profile_connection_type((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) >
            SRV_WAP_PROF_CONN_TYPE_HTTP)
    #else /* WAP_SUPPORT */ 
        if (mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) > BRW_PROF_CONN_TYPE_HTTP)
    #endif /* WAP_SUPPORT */ 
        {
            mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
        }
        else
    #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && !defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
        {
            (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
        }
        return;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_delete_slide
 * DESCRIPTION
 *  insert new slide
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_delete_slide(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (slide->next)
    {
        g_uc_p->srv_msg->msg_body.curr_slide = slide->next;
    }
    else if (slide->prev)
    {
        g_uc_p->srv_msg->msg_body.curr_slide = slide->prev;
        g_uc_p->srv_msg->signature_in_last_slide = MMI_FALSE;
    }
    else
    {
        g_uc_p->srv_msg->msg_body.curr_slide = NULL;
        g_uc_p->srv_msg->signature_in_last_slide = MMI_FALSE;
    }

    srv_uc_delete_slide_with_object(g_uc_p->main.instance, slide);
    if (g_uc_p->srv_msg->msg_body.curr_slide != NULL)
    {
        g_uc_p->srv_msg->current_slide_num = g_uc_p->srv_msg->msg_body.curr_slide->slide_num;
    }

    mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);

    if (mmi_uc_change_msg_type_if_needed())
    {
        mmi_uc_insert_signature_check();
    }
    srv_uc_update_msg_size(g_uc_p->main.instance);

    mmi_uc_set_group_id();
    if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
    }
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
    {
        g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_previous_slide
 * DESCRIPTION
 *  Go to previous slide
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_previous_slide(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(slide->prev);

    g_uc_p->srv_msg->msg_body.curr_slide = slide->prev;
    g_uc_p->srv_msg->current_slide_num = g_uc_p->srv_msg->msg_body.curr_slide->slide_num;

    mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
    srv_uc_update_msg_size(g_uc_p->main.instance);

    mmi_uc_set_group_id();
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_DUMMY);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_next_slide
 * DESCRIPTION
 *  Go to next slide
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_next_slide(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(slide->next);

    g_uc_p->srv_msg->msg_body.curr_slide = slide->next;
    g_uc_p->srv_msg->current_slide_num = g_uc_p->srv_msg->msg_body.curr_slide->slide_num;

    mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
    srv_uc_update_msg_size(g_uc_p->main.instance);
    mmi_uc_set_group_id();
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_DUMMY);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_goback_to_editor
 * DESCRIPTION
 *  Go back to editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_goback_to_editor(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(evt->evt_id)
    {
		case EVT_ID_POPUP_QUIT:
		{
			mmi_uc_set_group_id();
			break;
		}
		default:
			break;	
    }
    return MMI_RET_OK ;
}

#ifdef __MMI_MMS_2__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_slide_timing_done
 * DESCRIPTION
 *  Set slide timing and go back to editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_slide_timing_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 ascii_buff[6];
    U32 slide_timing = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((S8*) g_uc_p->main.slide_timing) != 0)
    {
        mmi_ucs2_to_asc((S8*) ascii_buff, (S8*) g_uc_p->main.slide_timing);
        slide_timing = (U32) atoi(ascii_buff);
    }
#ifdef __MMI_MMS_2__
    if (g_uc_p->srv_msg->best_page_duration && (mmi_ucs2strlen((S8*) g_uc_p->main.slide_timing) == 0 || slide_timing == 0))
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID)), MMI_EVENT_ERROR, NULL);
    }
    else
#endif /* __MMI_MMS_2__ */ 
        if (mmi_ucs2strlen((S8*) g_uc_p->main.slide_timing) == 0 ||
            ((slide_timing < g_uc_p->srv_mms_info->sliding_time.min ||
              slide_timing > g_uc_p->srv_mms_info->sliding_time.max)
#ifdef __MMI_MMS_2__
             && (!g_uc_p->srv_msg->best_page_duration)
#endif 
            ))
    {
        U16 number_len = 10;
        U16 ucs2_number[12];
        U8 ascii_number[12];
        U16 temp_str_size = 200;
        U16 *temp_str = OslMalloc(temp_str_size);

        memset(temp_str, 0, temp_str_size);

        mmi_ucs2cpy((S8*) temp_str, (S8*) GetString(STR_UC_INTERVAL_PREFIX_ID));
        mmi_ucs2cat((S8*) temp_str, (S8*) L" ");

        memset(ascii_number, 0, 12);
        memset(ucs2_number, 0, 12 * ENCODING_LENGTH);
        sprintf((char*)ascii_number, "%d", g_uc_p->srv_mms_info->sliding_time.min);
        mmi_asc_n_to_ucs2((S8*) ucs2_number, (S8*) ascii_number, number_len);
        mmi_ucs2cat((PS8) temp_str, (PS8) ucs2_number);
        mmi_ucs2cat((S8*) temp_str, (S8*) L" ");

        mmi_ucs2cat((S8*) temp_str, (S8*) GetString(STR_UC_INTERVAL_INFIX_ID));
        mmi_ucs2cat((S8*) temp_str, (S8*) L" ");

        memset(ascii_number, 0, number_len);
        memset(ucs2_number, 0, number_len * ENCODING_LENGTH);
        sprintf((char*)ascii_number, "%d", g_uc_p->srv_mms_info->sliding_time.max);
        mmi_asc_n_to_ucs2((S8*) ucs2_number, (S8*) ascii_number, number_len);
        mmi_ucs2cat((PS8) temp_str, (PS8) ucs2_number);

        mmi_popup_display((WCHAR*)((UI_string_type) temp_str), MMI_EVENT_ERROR, NULL);

        OslMfree(temp_str);
    }

#ifdef __MMI_MMS_2__
    else if ((g_uc_p->srv_msg->msg_body.curr_slide->txt.object &&
              g_uc_p->srv_msg->msg_body.curr_slide->txt.begin != SRV_UC_INVALID_VALUE &&
              slide_timing <= g_uc_p->srv_msg->msg_body.curr_slide->txt.begin) ||
             (g_uc_p->srv_msg->msg_body.curr_slide->img.object &&
              g_uc_p->srv_msg->msg_body.curr_slide->img.begin != SRV_UC_INVALID_VALUE &&
              slide_timing <= g_uc_p->srv_msg->msg_body.curr_slide->img.begin) ||
             (g_uc_p->srv_msg->msg_body.curr_slide->aud.object &&
              g_uc_p->srv_msg->msg_body.curr_slide->aud.begin != SRV_UC_INVALID_VALUE &&
              slide_timing <= g_uc_p->srv_msg->msg_body.curr_slide->aud.begin) ||
             (g_uc_p->srv_msg->msg_body.curr_slide->vid.object &&
              g_uc_p->srv_msg->msg_body.curr_slide->vid.begin != SRV_UC_INVALID_VALUE &&
              slide_timing <= g_uc_p->srv_msg->msg_body.curr_slide->vid.begin))
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_LESS_THAN_MEDIA_TIME_ID)), MMI_EVENT_ERROR, NULL);
    }
    else if ((g_uc_p->srv_msg->best_page_duration) &&
             ((g_uc_p->srv_msg->msg_body.curr_slide->aud.object &&
               g_uc_p->srv_msg->msg_body.curr_slide->aud.end != SRV_UC_INVALID_VALUE &&
               slide_timing < g_uc_p->srv_msg->msg_body.curr_slide->aud.end) ||
              (g_uc_p->srv_msg->msg_body.curr_slide->vid.object &&
               g_uc_p->srv_msg->msg_body.curr_slide->vid.end != SRV_UC_INVALID_VALUE &&
               slide_timing < g_uc_p->srv_msg->msg_body.curr_slide->vid.end)))
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_LESS_THAN_MEDIA_TIME_ID)), MMI_EVENT_ERROR, NULL);
    }
#endif /* __MMI_MMS_2__ */ 

    else
    {
        U32 old_slide_timing = g_uc_p->srv_msg->msg_body.curr_slide->duration;
        MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

        g_uc_p->srv_msg->msg_body.curr_slide->duration = slide_timing;
        srv_uc_update_msg_size(g_uc_p->main.instance);
        if (srv_uc_check_if_exceed_MMS_size_limitation
            (g_uc_p->main.instance, g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
        {
            g_uc_p->srv_msg->msg_body.curr_slide->duration = old_slide_timing;
            srv_uc_update_msg_size(g_uc_p->main.instance);
            (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            return;
        }
    #ifdef __MMI_MMS_2__
        if (g_uc_p->srv_msg->msg_body.curr_slide->txt.object &&
            g_uc_p->srv_msg->msg_body.curr_slide->txt.end != SRV_UC_INVALID_VALUE &&
            slide_timing < g_uc_p->srv_msg->msg_body.curr_slide->txt.end)
        {
            g_uc_p->srv_msg->msg_body.curr_slide->txt.end = slide_timing;
        }

        if (g_uc_p->srv_msg->msg_body.curr_slide->img.object &&
            g_uc_p->srv_msg->msg_body.curr_slide->img.end != SRV_UC_INVALID_VALUE &&
            slide_timing < g_uc_p->srv_msg->msg_body.curr_slide->img.end)
        {
            g_uc_p->srv_msg->msg_body.curr_slide->img.end = slide_timing;
        }

        if (g_uc_p->srv_msg->msg_body.curr_slide->aud.object &&
            g_uc_p->srv_msg->msg_body.curr_slide->aud.end != SRV_UC_INVALID_VALUE &&
            slide_timing < g_uc_p->srv_msg->msg_body.curr_slide->aud.end)
        {
            g_uc_p->srv_msg->msg_body.curr_slide->aud.end = slide_timing;
        }

        if (g_uc_p->srv_msg->msg_body.curr_slide->vid.object &&
            g_uc_p->srv_msg->msg_body.curr_slide->vid.end != SRV_UC_INVALID_VALUE &&
            slide_timing < g_uc_p->srv_msg->msg_body.curr_slide->vid.end)
        {
            g_uc_p->srv_msg->msg_body.curr_slide->vid.end = slide_timing;
        }
    #endif /* __MMI_MMS_2__ */ 
        if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
        }
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
        }
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        //mmi_display_popupcallback_with_sg(g_uc_p->main.editor_cui_id,(UI_string_type) GetString(STR_GLOBAL_DONE),(mmi_event_notify_enum) MMI_EVENT_SUCCESS,mmi_uc_goback_to_editor,NULL,0);
        {
	        mmi_popup_property_struct arg;

	        mmi_popup_property_init(&arg);
	        arg.parent_id = GRP_ID_ROOT;
	        arg.callback = mmi_uc_goback_to_editor;
	        arg.user_tag = (void *)(NULL); // not for parent proc
	        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_DONE)), (mmi_event_notify_enum) MMI_EVENT_SUCCESS, &arg);
			mmi_frm_group_close(g_uc_p->main.editor_cui_id);
            g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_timing_done
 * DESCRIPTION
 *  Set object timing and go back to editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_timing_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //mmi_id grp_id;
    S8 ascii_buff_start_time[6];
    S8 ascii_buff_end_time[6];
    U32 start_time;
    U32 end_time;
    MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((S8*) g_uc_p->main.slide_timing) == 0 || mmi_ucs2strlen((S8*) g_uc_p->main.slide_number) == 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID)), MMI_EVENT_ERROR, NULL);
        return;
    }

    mmi_ucs2_to_asc((S8*) ascii_buff_start_time, (S8*) g_uc_p->main.slide_timing);
    start_time = (U32) atoi(ascii_buff_start_time);

    mmi_ucs2_to_asc((S8*) ascii_buff_end_time, (S8*) g_uc_p->main.slide_number);
    end_time = (U32) atoi(ascii_buff_end_time);

    if (start_time > g_uc_p->srv_msg->msg_body.curr_slide->duration || end_time > g_uc_p->srv_msg->msg_body.curr_slide->duration)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_EXCEED_SLIDE_TIME_ID)), MMI_EVENT_ERROR, NULL);
    }
    else if (start_time >= end_time)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID)), MMI_EVENT_ERROR, NULL);
    }
    else
    {
        U32 old_start_time = 0;
        U32 old_end_time = 0;

        switch (g_uc_p->main.highlighted_object_type)
        {
            case SRV_UC_OBJECT_TYPE_TEXT:
            {
                old_start_time = g_uc_p->srv_msg->msg_body.curr_slide->txt.begin;
                old_end_time = g_uc_p->srv_msg->msg_body.curr_slide->txt.end;
                g_uc_p->srv_msg->msg_body.curr_slide->txt.begin = start_time;
                g_uc_p->srv_msg->msg_body.curr_slide->txt.end = end_time;
                break;
            }

            case SRV_UC_OBJECT_TYPE_IMAGE:
            {
                old_start_time = g_uc_p->srv_msg->msg_body.curr_slide->img.begin;
                old_end_time = g_uc_p->srv_msg->msg_body.curr_slide->img.end;
                g_uc_p->srv_msg->msg_body.curr_slide->img.begin = start_time;
                g_uc_p->srv_msg->msg_body.curr_slide->img.end = end_time;
                break;
            }

            case SRV_UC_OBJECT_TYPE_AUDIO:
            {
                old_start_time = g_uc_p->srv_msg->msg_body.curr_slide->aud.begin;
                old_end_time = g_uc_p->srv_msg->msg_body.curr_slide->aud.end;
                g_uc_p->srv_msg->msg_body.curr_slide->aud.begin = start_time;
                g_uc_p->srv_msg->msg_body.curr_slide->aud.end = end_time;
                break;
            }

            case SRV_UC_OBJECT_TYPE_VIDEO:
            {
                old_start_time = g_uc_p->srv_msg->msg_body.curr_slide->vid.begin;
                old_end_time = g_uc_p->srv_msg->msg_body.curr_slide->vid.end;
                g_uc_p->srv_msg->msg_body.curr_slide->vid.begin = start_time;
                g_uc_p->srv_msg->msg_body.curr_slide->vid.end = end_time;
                break;
            }

            default:
            {
                MMI_ASSERT(0);
            }
        }
        srv_uc_update_msg_size(g_uc_p->main.instance);
        if (srv_uc_check_if_exceed_MMS_size_limitation
            (g_uc_p->main.instance, g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
        {

            switch (g_uc_p->main.highlighted_object_type)
            {
                case SRV_UC_OBJECT_TYPE_TEXT:
                {
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.begin = old_start_time;
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.end = old_end_time;
                    break;
                }

                case SRV_UC_OBJECT_TYPE_IMAGE:
                {
                    g_uc_p->srv_msg->msg_body.curr_slide->img.begin = old_start_time;
                    g_uc_p->srv_msg->msg_body.curr_slide->img.end = old_end_time;
                    break;
                }

                case SRV_UC_OBJECT_TYPE_AUDIO:
                {
                    g_uc_p->srv_msg->msg_body.curr_slide->aud.begin = old_start_time;
                    g_uc_p->srv_msg->msg_body.curr_slide->aud.end = old_end_time;
                    break;
                }

                case SRV_UC_OBJECT_TYPE_VIDEO:
                {
                    g_uc_p->srv_msg->msg_body.curr_slide->vid.begin = old_start_time;
                    g_uc_p->srv_msg->msg_body.curr_slide->vid.end = old_end_time;
                    break;
                }

                default:
                {
                    MMI_ASSERT(0);
                }
            }
            srv_uc_update_msg_size(g_uc_p->main.instance);
            (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            return;
        }
        if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
        }
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
        }
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_DONE)), MMI_EVENT_SUCCESS, NULL);
        mmi_uc_set_group_id();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_object_timing_confirm_popup_proc
 * DESCRIPTION
 *  check values and then set object timing and go back to editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_object_timing_confirm_popup_proc(mmi_alert_result_evt_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch (evt->result)
        {
        case MMI_ALERT_CNFM_1:
        case MMI_ALERT_CNFM_2:
        case MMI_ALERT_CNFM_3:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_OK:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_YES:
            mmi_uc_entry_timing_done();
            break;
        case MMI_ALERT_CNFM_NO:
            mmi_frm_scrn_close_active_id();
            break;
        }
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_timing_check_before_done
 * DESCRIPTION
 *  check values and then set object timing and go back to editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_timing_check_before_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 ascii_buff_start_time[10];
    S8 ascii_buff_end_time[10];

    U32 start_time;
    U32 end_time;
    U32 file_duration = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((S8*) g_uc_p->main.slide_timing) == 0 || mmi_ucs2strlen((S8*) g_uc_p->main.slide_number) == 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID)), MMI_EVENT_ERROR, NULL);
        return;
    }

    mmi_ucs2_to_asc((S8*) ascii_buff_start_time, (S8*) g_uc_p->main.slide_timing);
    start_time = (U32) atoi(ascii_buff_start_time);
    /* use slide_number for temp */
    mmi_ucs2_to_asc((S8*) ascii_buff_end_time, (S8*) g_uc_p->main.slide_number);
    end_time = (U32) atoi(ascii_buff_end_time);

    if (start_time > g_uc_p->srv_msg->msg_body.curr_slide->duration || end_time > g_uc_p->srv_msg->msg_body.curr_slide->duration)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_EXCEED_SLIDE_TIME_ID)), MMI_EVENT_ERROR, NULL);
        return;
    }
    else if (start_time >= end_time)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID)), MMI_EVENT_ERROR, NULL);

        return;
    }

    /* get media duration, just for best page duration case */

    switch (g_uc_p->main.highlighted_object_type)
    {
        case SRV_UC_OBJECT_TYPE_AUDIO:
        {
            U16 *extension = srv_uc_get_file_extension(g_uc_p->srv_msg->msg_body.curr_slide->aud.object->file_path_ucs);

            if (extension && (app_ucs2_strcmp((const kal_int8*)extension, (const kal_int8*)L"mid") == 0 ||
                              app_ucs2_strcmp((const kal_int8*)extension, (const kal_int8*)L"aac") == 0))
            {
                file_duration = 0;
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MDI_AUDIO_GET_DUR_OK_P1, file_duration);
            }
            else if (g_uc_p->srv_msg->msg_body.curr_slide->aud.object->is_virtual_file)
            {
                U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
                S32 virtual_filename_gen_result;
                S32 file_handle;
                U16 virtual_file_name_len = sizeof(virtual_file_name);

                memset(virtual_file_name, 0, virtual_file_name_len);

                file_handle = FS_Open(g_uc_p->srv_msg->msg_body.curr_slide->aud.object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                if (file_handle <= 0)
                {
                    MMI_ASSERT(0);
                }

                virtual_filename_gen_result = FS_GenVirtualFileName(
                                                file_handle,
                                                (U16*) virtual_file_name,
                                                (unsigned int)FS_GenVFN_SIZE,
                                                g_uc_p->srv_msg->msg_body.curr_slide->aud.object->offset,
                                                g_uc_p->srv_msg->msg_body.curr_slide->aud.object->size);

                if (virtual_filename_gen_result < 0)
                {
                    MMI_ASSERT(0);
                }

                mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                if (srv_uc_get_file_extension(g_uc_p->srv_msg->msg_body.curr_slide->aud.object->file_name_ucs))
                {
                    mmi_ucs2ncat(
                        (PS8) virtual_file_name,
                        (PS8) srv_uc_get_file_extension(g_uc_p->srv_msg->msg_body.curr_slide->aud.object->file_name_ucs),
                        virtual_file_name_len / ENCODING_LENGTH);
                }
                if (mdi_audio_get_duration(virtual_file_name, &(file_duration)) != MDI_AUDIO_SUCCESS)
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MDI_AUDIO_GET_DUR_FAIL);
                    file_duration = 0;
                }
                else
                {

                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MDI_AUDIO_GET_DUR_OK_P1, file_duration);
                    file_duration = (file_duration / 1000);
                }
                FS_Close(file_handle);
            }
            else
            {
                if (mdi_audio_get_duration(g_uc_p->srv_msg->msg_body.curr_slide->aud.object->file_path_ucs, &(file_duration)) !=
                    MDI_AUDIO_SUCCESS)
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MDI_AUDIO_GET_DUR_FAIL);
                    file_duration = 0;
                }
                else
                {

                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MDI_AUDIO_GET_DUR_OK_P1, file_duration);
                    file_duration = (file_duration / 1000);
                }
            }

            break;
        }

    #ifdef __MMI_VIDEO_PLAY_SUPPORT__
        case SRV_UC_OBJECT_TYPE_VIDEO:
        {

            /* 1. check media file duration */
            mdi_video_info_struct vdo_info;
            MDI_RESULT result;

            if (g_uc_p->srv_msg->msg_body.curr_slide->vid.object->is_virtual_file)
            {
                U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
                S32 virtual_filename_gen_result;
                S32 file_handle;
                U16 virtual_file_name_len = sizeof(virtual_file_name);

                memset(virtual_file_name, 0, virtual_file_name_len);

                file_handle = FS_Open(g_uc_p->srv_msg->msg_body.curr_slide->vid.object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                if (file_handle <= 0)
                {
                    MMI_ASSERT(0);
                }

                virtual_filename_gen_result = FS_GenVirtualFileName(
                                                file_handle,
                                                (U16*) virtual_file_name,
                                                (unsigned int)FS_GenVFN_SIZE,
                                                g_uc_p->srv_msg->msg_body.curr_slide->vid.object->offset,
                                                g_uc_p->srv_msg->msg_body.curr_slide->vid.object->size);

                if (virtual_filename_gen_result < 0)
                {
                    MMI_ASSERT(0);
                }

                mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                if (srv_uc_get_file_extension(g_uc_p->srv_msg->msg_body.curr_slide->vid.object->file_name_ucs))
                {
                    mmi_ucs2ncat(
                        (PS8) virtual_file_name,
                        (PS8) srv_uc_get_file_extension(g_uc_p->srv_msg->msg_body.curr_slide->vid.object->file_name_ucs),
                        virtual_file_name_len / ENCODING_LENGTH);
                }
				mdi_video_ply_enable_aud_only_video_clip();
                result = mdi_video_ply_open_clip_file(0, (PS8) virtual_file_name, &vdo_info);
                FS_Close(file_handle);
            }
            else
            {
				mdi_video_ply_enable_aud_only_video_clip();
                result = mdi_video_ply_open_clip_file(0, 
                            (PS8) g_uc_p->srv_msg->msg_body.curr_slide->vid.object->file_path_ucs,
                            &vdo_info);
            }
            if (result < 0)
            {
                file_duration = 0;
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MDI_VIDEO_GET_DUR_FAIL);

            }
            else
            {
                mdi_video_ply_close_clip_file();
                /* PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*[UC]#2 mdi_audio_get_duration =%d",vdo_info.total_time_duration); */
                file_duration = (U32) (vdo_info.total_time_duration / 1000);
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MDI_VIDEO_GET_DUR_OK_P1, vdo_info.total_time_duration);
            }
            break;
        }
    #endif /* __MMI_VIDEO_PLAY_SUPPORT__ */ 

    }                                           /* switch */
    if (end_time < start_time + file_duration)  /* confirm popup to ask user */
    {
	    mmi_confirm_property_struct arg;

	    mmi_confirm_property_init(&arg, CNFM_TYPE_YESNO);
	    arg.callback = (mmi_proc_func)mmi_uc_object_timing_confirm_popup_proc;
	    arg.parent_id = g_uc_p->main.uc_cui_gid;
	    mmi_confirm_display((WCHAR *)(get_string(STR_UC_CAN_NOT_PLAY_COMPLETE)), MMI_EVENT_QUERY, &arg);
    }
    else
    {
        mmi_uc_entry_timing_done();

    }
}

#endif /* __MMI_MMS_2__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_msg_type
 * DESCRIPTION
 *  Save msg type
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_msg_type(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->main.object_index == 0)
    {
        g_uc_p->srv_msg_type->curr_msg_type = MMI_UC_MSG_TYPE_SMS_PREFER;
        g_uc_p->srv_msg_type->caller_specific_msg_type = MMI_UC_MSG_TYPE_SMS_PREFER;
    }
    else if (g_uc_p->main.object_index == 1)
    {
        g_uc_p->srv_msg_type->curr_msg_type = MMI_UC_MSG_TYPE_MMS_PREFER;
        g_uc_p->srv_msg_type->caller_specific_msg_type = MMI_UC_MSG_TYPE_MMS_PREFER;
    }
    else
    {
        MMI_ASSERT(0);
    }

    pass_sig_check = mmi_uc_insert_signature_check();

    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_DONE)), MMI_EVENT_SUCCESS, NULL);

    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD || g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
    {
        /* Prevent the msg change ind popup display */
        g_uc_p->done.pre_msg_type = g_uc_p->srv_msg_type->curr_msg_type;
    }
    else
    {
        mmi_uc_set_group_id();
    }
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_add_sig_confirm_to_history();
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_opt_done_no_hdlr
 * DESCRIPTION
 *  Save the setting to context
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_opt_done_no_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_group_id();
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, 
                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                SCR_ID_UC_EDITOR,
                        #else
                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                MMI_FRM_NODE_ALL_FLAG))
    {
       /* go back to add recipient screen */
    }
    else
    {
        MMI_ASSERT(0);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_opt_done_yes_hdlr
 * DESCRIPTION
 *  Save the setting to context
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_opt_done_yes_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_SAVED)), MMI_EVENT_EXPLICITLY_SAVED, NULL);

    g_uc_p->srv_msg->read_report = g_uc_p->send_opt.read_report;
    g_uc_p->srv_msg->delivery_report = g_uc_p->send_opt.delivery_report;
    g_uc_p->srv_msg->priority = g_uc_p->send_opt.priority + 1;
#ifdef __MMI_MMS_SETTINGS_VALIDITY_PERIOD_VISIBILITY__
    g_uc_p->srv_msg->expiry_time = g_uc_p->send_opt.validity_period + 1;
#endif 
    g_uc_p->srv_msg->delivery_time = g_uc_p->send_opt.delivery_time + 1;

#ifdef __MMI_MMS_HIDE_SENDER_SUPPORT__
    g_uc_p->srv_msg->hide_sender = g_uc_p->send_opt.hide_sender;
#endif 
#ifdef OMA13_CON_739_SUPPORT_TEMP_TEST_CODE
    g_uc_p->srv_msg->msg_class = g_uc_p->send_opt.msg_class;
    if (g_uc_p->srv_msg->msg_class == MMA_MSG_CLASS_AUTO)
    {
        g_uc_p->srv_msg->read_report = 0;
        g_uc_p->srv_msg->delivery_report = 0;
    }
#endif /* OMA13_CON_739_SUPPORT_TEMP_TEST_CODE */
    mmi_uc_set_group_id();
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, 
                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                SCR_ID_UC_EDITOR,
                        #else
                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        /* Go back to add recipient screen */
    }
    else
    {
        MMI_ASSERT(0);
    }
	mmi_frm_group_close(g_uc_p->main.inline_cui_id);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_opt_done_confirm_popup_group_proc
 * DESCRIPTION
 *  Save the setting to context
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_send_opt_done_confirm_popup_group_proc(mmi_alert_result_evt_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch (evt->result)
        {
        case MMI_ALERT_CNFM_1:
        case MMI_ALERT_CNFM_2:
        case MMI_ALERT_CNFM_3:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_OK:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_YES:
            mmi_uc_send_opt_done_yes_hdlr();
            break;
        case MMI_ALERT_CNFM_NO:
            mmi_uc_send_opt_done_no_hdlr();
            break;
        }
    }
    return MMI_RET_OK;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_opt_done_hdlr
 * DESCRIPTION
 *  Save the setting to context
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_opt_done_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	mmi_confirm_property_struct arg;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	mmi_confirm_property_init(&arg, CNFM_TYPE_YESNO);
	arg.callback = (mmi_proc_func)mmi_uc_send_opt_done_confirm_popup_group_proc;
	arg.parent_id = g_uc_p->main.inline_cui_id;
	mmi_confirm_display((WCHAR *)(get_string(STR_GLOBAL_SAVE_ASK)), MMI_EVENT_QUERY, &arg);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_input_method_done
 * DESCRIPTION
 *  Funtion is called when type of input method is selected
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_input_method_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    {
        U16 next_scrn_id = 0, top_scrn_id = 0;
        top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
        mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_preview_mms
 * DESCRIPTION
 *  Preview mms
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_preview_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
    mmi_uc_entry_processing_generic();
    mmi_uc_preview_mms_req(g_uc_p->main.instance);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_generic
 * DESCRIPTION
 *  Generic exit function for unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_generic(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_displayConfirm
 * DESCRIPTION
 *  Exit function for display confirm
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_displayConfirm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_sig_displayConfirm
 * DESCRIPTION
 *  Exit function for sig display confirm
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_sig_displayConfirm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_uc_opt
 * DESCRIPTION
 *  Exit function for uc exit
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_uc_opt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_add_picture_options
 * DESCRIPTION
 *  Exit function for add picture options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_add_picture_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_add_sound_options
 * DESCRIPTION
 *  Exit function for add sound options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_add_sound_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}

#ifdef __MMI_MMS_VIDEO_FEATURE__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_add_video_options
 * DESCRIPTION
 *  Exit function for add video options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_add_video_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_advance_options
 * DESCRIPTION
 *  Exit function for advance options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_advance_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_remove_options
 * DESCRIPTION
 *  Exit function for remove
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_remove_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_replace_options
 * DESCRIPTION
 *  Exit function for replace
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_replace_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_picture_options
 * DESCRIPTION
 *  Exit function for picture options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_picture_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_sound_options
 * DESCRIPTION
 *  Exit function for sound options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_sound_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_video_options
 * DESCRIPTION
 *  Exit function for video options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_video_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_attachment_options
 * DESCRIPTION
 *  Exit function for attachment options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_attachment_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_text_options
 * DESCRIPTION
 *  Exit function for text options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_text_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_add_recipients_options
 * DESCRIPTION
 *  Exit function for add recipients options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_add_recipients_options(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_slide_opt
 * DESCRIPTION
 *  Exit function for slide opt
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_slide_opt(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_slide_timing
 * DESCRIPTION
 *  Exit function for slide timing
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_slide_timing(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}

#ifndef __MMI_FTE_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_option
 * DESCRIPTION
 *  Exit function for exit option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_edit_subject
 * DESCRIPTION
 *  Exit function for edit subject
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_edit_subject(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_input_method_and_done
 * DESCRIPTION
 *  Exit function for input method
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_input_method_and_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}

#ifndef __MMI_SLIM_MMS_2__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_multimedia_generic
 * DESCRIPTION
 *  Exit function for multimedia 
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_multimedia_generic(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_sh_delete_screen_context(MMI_UC_FLOW_INSTANCE_ID_OPT_INSERT_NEW_MM_OBJECT);
}
#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_enter_recipient_options
 * DESCRIPTION
 *  Exit function for enter recipient options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_enter_recipient_options(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_enter_recipient
 * DESCRIPTION
 *  Exit function for enter recipient
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_enter_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_edit_recipient
 * DESCRIPTION
 *  Exit function for edit recipient
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_edit_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_attachment_option_remove
 * DESCRIPTION
 *  Exit function for remove attachment
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_attachment_option_remove(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

}

#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_opt_attachment_option_replace
 * DESCRIPTION
 *  Exit function for repalce attachment
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_opt_attachment_option_replace(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_sending_sms
 * DESCRIPTION
 *  Exit function for sending sms
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
#if !defined(__UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__) && !defined(__MMI_MMS_STANDALONE_COMPOSER__)
void mmi_uc_exit_sending_sms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif /* !defined(__UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__) && !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_sending_mms
 * DESCRIPTION
 *  Exit function for sending mms
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
#if !defined(__MMI_MMS_BGSR_SUPPORT__)
void mmi_uc_exit_sending_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif /* !defined(__MMI_MMS_BGSR_SUPPORT__) */ 

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_sim_option
 * DESCRIPTION
 *  Exit function for sim option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
 #if (MMI_MAX_SIM_NUM >=2)
void mmi_uc_exit_sim_option(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif /* #if(MMI_MAX_SIM_NUM == 2) */ 

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_write_msg_selection
 * DESCRIPTION
 *  Exit function for write msg selection
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
#ifdef __MMI_MMS_POSTCARD__
void mmi_uc_exit_write_msg_selection(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}

#endif /* __MMI_MMS_POSTCARD__ */ 

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_add_object_selection
 * DESCRIPTION
 *  Exit function for object selection
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
#if defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
void mmi_uc_exit_add_object_selection(void)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}
#endif /* __MMI_FTE_SUPPORT__ */
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_processing_screen
 * DESCRIPTION
 *  Set string and image for UC processing screen
 * PARAMETERS
 *  captionStrId            [IN]        
 *  bodyStrId               [IN]        
 *  animationImageId        [IN]        
 *  rskStrId                [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_set_processing_screen(U16 captionStrId, U16 bodyStrId, U16 animationImageId, U16 rskStrId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->processing.caption_str_id = captionStrId;
    g_uc_p->processing.body_str_id = bodyStrId;
    g_uc_p->processing.animation_image_id = animationImageId;
    g_uc_p->processing.RSK_str_id = rskStrId;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_processing_generic
 * DESCRIPTION
 *  Exit generic processing screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_processing_generic(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    StopTimer(UC_INPROGRESS_TIMER_ID);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_time_out_processing_generic
 * DESCRIPTION
 *  Time out call back of processing screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_time_out_processing_generic(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    StopTimer(UC_INPROGRESS_TIMER_ID);
    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
    }
    g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_processing_to_history
 * DESCRIPTION
 *  Add processing screen to history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_processing_to_history(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //GenericExitScreen(SCR_ID_UC_PROCESSING, mmi_uc_entry_processing);
	if (g_uc_p->main.parent_grp_id != GRP_ID_INVALID)
    {
        mmi_uc_insert_screen(g_uc_p->main.parent_grp_id, SCR_ID_UC_PROCESSING, (mmi_proc_func) mmi_uc_entry_processing, 0);
    }
    else
    {
        mmi_uc_insert_screen(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, (mmi_proc_func) mmi_uc_entry_processing, 0);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_processing_generic
 * DESCRIPTION
 *  Entry MSG generic processing screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_processing_generic(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0) || srv_reminder_is_expiring())
    {
        mmi_uc_add_processing_to_history();
    }
    else
    {
        mmi_uc_entry_processing();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_processing_after_send
 * DESCRIPTION
 *  Entry MSG processing screen after send
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_processing_after_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_SENDING)
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_PROCESSING_AFTER_SEND);
        mmi_uc_entry_processing_generic();
    }
    else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SENDING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_PROCESSING_AFTER_SEND_HISTORY_REPLACE);
        mmi_uc_replace_screen(SCR_ID_UC_SENDING, SCR_ID_UC_PROCESSING, (mmi_proc_func) mmi_uc_entry_processing, 1);
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_PROCESSING_AFTER_SEND_DONOTHING);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_text_in_current_slide
 * DESCRIPTION
 *  Save content of text buffer to file OR delete text object
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
S32 mmi_uc_handle_text_in_current_slide(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 mmi_uc_text_path[SRV_UC_MAX_TEMP_FILE_LEN];
    mma_mms_object_struct *object = NULL;
    S32 result = FS_NO_ERROR;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(mmi_uc_text_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);
    SRV_UC_MAKE_TEXT_FILE_PATH(mmi_uc_text_path, g_uc_p->srv_msg->current_slide_num, g_uc_p->main.instance);

    /* Add text object with empty content to the slide */
    if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count > 0)
    {
        result = srv_uc_save_buffer_to_file(
                    g_uc_p->main.instance,
                    mmi_uc_text_path,
                    g_uc_p->srv_main->text_buffer,
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count);

        if (result == FS_NO_ERROR)
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->txt.object == NULL)
            {
                object = srv_uc_insert_object(g_uc_p->main.instance, (S8*) mmi_uc_text_path, SRV_UC_OBJECT_TYPE_TEXT);
                srv_uc_insert_object_to_slide(
                    g_uc_p->main.instance,
                    object,
                    g_uc_p->srv_msg->msg_body.curr_slide,
                    SRV_UC_OBJECT_TYPE_TEXT);
            }
            else
            {
                g_uc_p->srv_msg->msg_body.curr_slide->txt.object->size = applib_get_file_size((kal_wchar*) mmi_uc_text_path);
            }
            g_uc_p->srv_msg->msg_body.curr_slide->txt.object->encoding = MMA_CHARSET_UTF8;   /* because the text's encode already UTF8 when mmi_uc_save_buffer_to_file to file */
        }
        else
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_HANDLE_TEXT_IN_CURR_SLIDE_RESULT_P1, result);

        }
    }
    /* Delete the text object */
    else if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count == 0)
    {
        if (g_uc_p->srv_msg->msg_body.curr_slide->txt.object)
        {
            if (FS_Delete((U16*) mmi_uc_text_path) != FS_NO_ERROR)
            {
                MMI_ASSERT(0);
            }
            srv_uc_delete_object_from_list(g_uc_p->main.instance, g_uc_p->srv_msg->msg_body.curr_slide->txt.object);
            memset(&(g_uc_p->srv_msg->msg_body.curr_slide->txt), 0, sizeof(mma_mms_slide_text_object_struct));
        }
    }
    else
    {
        MMI_ASSERT(0);
    }

    return result;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_change_msg_type_to_mms
 * DESCRIPTION
 *  change the type to MMS
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_change_msg_type_to_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.object_index = 1;
    mmi_uc_save_msg_type();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_opt_change_msg_type_to_sms
 * DESCRIPTION
 *  change the type to SMS
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_opt_change_msg_type_to_sms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.object_index = 0;
    mmi_uc_save_msg_type();
}

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_entry_edit_addr
 * DESCRIPTION
 *  Pre-Entry function for edit address
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_entry_edit_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_uc_addr_struct *addr = mmi_uc_get_highlighted_addr();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (addr->type == MMI_UC_ADDRESS_TYPE_PHONE_NUMBER)
    {
        g_uc_p->done.state = MMI_UC_DONE_STATE_EDIT_NUMBER;
        mmi_asc_n_to_ucs2((S8*) g_uc_p->done.to, (S8*) addr->addr, SRV_UC_MAX_PHONE_NUMBER_LEN);
    }
    else if (addr->type == MMI_UC_ADDRESS_TYPE_EMAIL)
    {
        g_uc_p->done.state = MMI_UC_DONE_STATE_EDIT_EMAIL;
        mmi_ucs2ncpy((S8*) g_uc_p->done.to, (S8*) addr->addr, MMI_UC_MAX_EMAIL_LEN);
    }
    else
    {
        MMI_ASSERT(0);
    }
    mmi_uc_entry_edit_recipient();
}
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_critaria_follow_in_pre_process_select_option_from_editor
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_is_critaria_follow_in_pre_process_select_option_from_editor(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        if (g_uc_p->srv_msg->msg_body.obj_no== 0)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NO_IMAGE)), MMI_EVENT_ERROR, NULL);
            return MMI_FALSE;
        }
        /* postcard should include one image */
        if (g_uc_p->srv_msg->msg_body.curr_slide &&
            (g_uc_p->srv_msg->msg_body.obj_no == 1) && (g_uc_p->srv_msg->msg_body.curr_slide->img.object == NULL))
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NO_IMAGE)), MMI_EVENT_ERROR, NULL);
            return MMI_FALSE;
        }
        else if (g_uc_p->srv_msg->msg_body.curr_slide &&
                 (g_uc_p->srv_msg->msg_body.obj_no == 1) && (g_uc_p->srv_msg->msg_body.curr_slide->txt.object == NULL))
        {
            g_uc_p->srv_msg->msg_body.greeting_exist_flag = MMI_FALSE;
        }
        else
        {
            g_uc_p->srv_msg->msg_body.greeting_exist_flag = MMI_TRUE;
        }

    }
#endif /* __MMI_MMS_POSTCARD__ */ 
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_process_save
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_process_save(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        if (g_uc_p->srv_msg->msg_body.curr_slide &&
            (g_uc_p->srv_msg->msg_body.obj_no == 1) && (g_uc_p->srv_msg->msg_body.curr_slide->txt.object == NULL))
        {
            g_uc_p->srv_msg->msg_body.greeting_exist_flag = MMI_FALSE;
        }
        else
        {
            g_uc_p->srv_msg->msg_body.greeting_exist_flag = MMI_TRUE;
        }

    }
#endif /* __MMI_MMS_POSTCARD__ */ 
 #if (MMI_MAX_SIM_NUM >=2)
    g_uc_p->srv_sim_info->action = SRV_UC_ACTION_SAVE;
    mmi_uc_pre_entry_sim_option();
#else /* #if(MMI_MAX_SIM_NUM == 2) */ 
    mmi_uc_process_save();
#endif /* #if(MMI_MAX_SIM_NUM == 2) */ 
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_recipient_screen_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
U16 mmi_uc_get_recipient_screen_id(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    return SCR_ID_UC_EDITOR;
#else
    return SCR_ID_UC_OPT_ADD_RECIPIENT;
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_replace_recipient_screen
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_replace_recipient_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        mmi_uc_replace_screen(SCR_ID_UC_EDITOR, SCR_ID_UC_EDITOR, (mmi_proc_func) mmi_uc_entry_write_msg, 0);
        //MMI_ASSERT(result);
    }
    else
    {
        mmi_uc_entry_write_msg();
    }
#else
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        mmi_uc_replace_screen(SCR_ID_UC_OPT_ADD_RECIPIENT, SCR_ID_UC_OPT_ADD_RECIPIENT, (mmi_proc_func) mmi_uc_entry_add_recipient, 0);
        //MMI_ASSERT(result);
    }
    else
    {
        mmi_uc_entry_add_recipient();
    }
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
}

#ifdef __MMI_MMS_POSTCARD__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_recipient_index
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_set_recipient_index(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    U8 index = srv_postcard_get_total_recipient_count(g_uc_p->main.instance);

    if (index)
    {
        g_uc_p->done.current_addr_index = index +
            MMI_UC_ADD_RECIPIENT_TOTAL - mmi_uc_get_number_of_options_omitted() - 1;
    }
    else
    {
        g_uc_p->done.current_addr_index = index;
    }
}
#endif /* __MMI_MMS_POSTCARD__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_address_from_phb_ext
 * DESCRIPTION
 *  Get phonebook number
 * PARAMETERS
 *  name        [IN]        Name
 *  number      [IN]        Number
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_get_address_from_phb_ext(S8 *name, S8 *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 addr_len = mmi_ucs2strlen(number);
    U16 i = 0;
    U16 *addr = (U16*) number;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_NUMBER;
    for (; i < addr_len; i++)
    {
        if (mmi_ucs2ncmp((S8*) & addr[i], (S8*) L"@", 1) == 0)
        {
            g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_EMAIL;
            break;
        }
    }

    if (g_uc_p->done.state == MMI_UC_DONE_STATE_ADD_NUMBER)
    {
        if (!srv_uc_is_phone_number_valid(number))
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_NUMBER)), MMI_EVENT_ERROR, NULL);
            {
                U16 next_scrn_id = 0, top_scrn_id = 0;
                top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, 
                                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                            SCR_ID_UC_EDITOR,
                                                    #else
                                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                            MMI_FRM_NODE_AFTER_FLAG); 
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
            }
            return;
        }
    #ifdef __MMI_MMS_2__
        if (mmi_ucs2strlen((PS8) number) > (MMI_UC_MAX_PHONE_NUMBER_LEN))
    #else 
        if (mmi_ucs2strlen((PS8) number) > (SRV_SMS_MAX_ADDR_LEN - 1))
    #endif 
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NUMBER_LENGTH_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
            {
                U16 next_scrn_id = 0, top_scrn_id = 0;
                top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, 
                                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                            SCR_ID_UC_EDITOR,
                                                    #else
                                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                            MMI_FRM_NODE_AFTER_FLAG); 
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
            }
            return;
        }
    }
    else if (g_uc_p->done.state == MMI_UC_DONE_STATE_ADD_EMAIL)
    {
        if (!srv_uc_is_email_addr_valid((U8*) number))
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_EMAIL_ADDRESS)), MMI_EVENT_ERROR, NULL);
            {
                U16 next_scrn_id = 0, top_scrn_id = 0;
                top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, 
                                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                            SCR_ID_UC_EDITOR,
                                                    #else
                                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                            MMI_FRM_NODE_AFTER_FLAG); 
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
            }
            return;
        }
        if (mmi_ucs2strlen((PS8) number) > (MMI_UC_MAX_EMAIL_LEN))
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_ADDR_LENGTH_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
            {
                U16 next_scrn_id = 0, top_scrn_id = 0;
                top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, 
                                                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                            SCR_ID_UC_EDITOR,
                                                    #else
                                                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                            MMI_FRM_NODE_AFTER_FLAG); 
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
            }
            return;
        }
    }

    memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
    if (number)
    {
        mmi_ucs2ncpy((S8*) g_uc_p->done.to, (PS8) number, MMI_UC_MAX_EMAIL_LEN);
    }
    mmi_uc_enter_recipient_done();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enter_recipient_done
 * DESCRIPTION
 *  code to identify whether addr is num or email
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_enter_recipient_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/


    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((S8*) g_uc_p->done.to) == 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_EMPTY)), MMI_EVENT_ERROR, NULL);
        return;
    }

    if (!srv_uc_is_email_addr_valid(g_uc_p->done.to))
    {
        if (!srv_uc_is_phone_number_valid((S8*) g_uc_p->done.to))
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_INPUT)), MMI_EVENT_ERROR, NULL);
            return;
        }
        else
        {
            if (g_uc_p->done.state == MMI_UC_DONE_STATE_EDIT_NUMBER ||
                g_uc_p->done.state == MMI_UC_DONE_STATE_EDIT_EMAIL)
            {
                g_uc_p->done.state = MMI_UC_DONE_STATE_EDIT_NUMBER;
            }
            else
            {
                g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_NUMBER;
            }

        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            {
                U16 recipient_name[(MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH];
                S32 pos = 0;
                memset(recipient_name, 0, (MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH);
                srv_phb_get_name_by_number((U16 *)g_uc_p->done.to, recipient_name, MMI_UC_MAX_EMAIL_LEN);
                if(mmi_ucs2strlen((S8*) recipient_name) == 0)
                {
                    mmi_ucs2ncpy((S8*)recipient_name, (S8*)g_uc_p->done.to, MMI_UC_MAX_EMAIL_LEN);
                    mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                    wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                                (UI_string_type)recipient_name, 0, MMI_TRUE, -1);
                }
                else
                {
                    mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                    pos = mmi_uc_add_get_recipient_position();
                    if(wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                                (UI_string_type)recipient_name, WGUI_UCE_WRAPPING_DELETE_RECIPIENT, 
                                                MMI_TRUE, pos))
                    {
                        mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                    }
                }
            }
        #else
            mmi_uc_addr_add_number_done();
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        }
    }
    else
    {
        if (g_uc_p->srv_msg_type->caller_specific_msg_type == MMI_UC_MSG_TYPE_SMS_ONLY)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_INPUT)), MMI_EVENT_ERROR, NULL);
            return;
        }
        if (g_uc_p->done.state == MMI_UC_DONE_STATE_EDIT_NUMBER || g_uc_p->done.state == MMI_UC_DONE_STATE_EDIT_EMAIL)
        {
            g_uc_p->done.state = MMI_UC_DONE_STATE_EDIT_EMAIL;
        }
        else
        {
            g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_EMAIL;
        }

    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        {
            U16 recipient_name[(MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH];
            S32 pos = 0;
            memset(recipient_name, 0, (MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH);
            srv_phb_get_name_by_number((U16 *)g_uc_p->done.to, recipient_name, MMI_UC_MAX_EMAIL_LEN);
            if(mmi_ucs2strlen((S8*) recipient_name) == 0)
            {
                mmi_ucs2ncpy((S8*)recipient_name, (S8*)g_uc_p->done.to, MMI_UC_MAX_EMAIL_LEN);
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                            (UI_string_type)recipient_name, 0, MMI_TRUE, -1);
            }
            else
            {
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                pos = mmi_uc_add_get_recipient_position();
                if(wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                            (UI_string_type)recipient_name, WGUI_UCE_WRAPPING_DELETE_RECIPIENT, 
                                            MMI_TRUE, pos))
                {
                    mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                }
            }
        }
    #else
        mmi_uc_addr_add_email_done();
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    }

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*
    if (mmi_uc_change_msg_type_if_needed())
    {
        pass_sig_check = mmi_uc_insert_signature_check();
    }
*/
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        {
            U16 next_scrn_id = 0, top_scrn_id = 0;
            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
        }
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
}

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_entry_add_recipient
 * DESCRIPTION
 *  Pre-entry function of unified composer add recipient screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_entry_add_recipient(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_exit_write_msg();
    /* srv_uc_update_msg_size(g_uc_p->main.instance); */
    if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
    {
        srv_uc_update_msg_size(g_uc_p->main.instance);
        mmi_uc_entry_add_recipient();
    }
    else
    {
        if (g_uc_p->srv_main->current_text_file_save_result == FS_DISK_FULL)
        {
            mmi_popup_display((WCHAR*)(get_string(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
        else
        {
            mmi_popup_display((WCHAR*)(get_string(srv_fmgr_fs_error_get_string(g_uc_p->srv_main->current_text_file_save_result))), MMI_EVENT_FAILURE, NULL);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_addr_add_number_done
 * DESCRIPTION
 *  Get phonebook number
 * PARAMETERS
 *  void
 *  number(?)       [IN]        Number
 *  name(?)         [IN]        Name
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_addr_add_number_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    BOOL result = MMI_FALSE;
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!srv_uc_is_phone_number_valid((S8*) g_uc_p->done.to))
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_NUMBER)), MMI_EVENT_ERROR, NULL);
        return MMI_TRUE;
    }

    if (g_uc_p->done.state == MMI_UC_DONE_STATE_ADD_NUMBER)
    {
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            /* Check if the msg size exceeds the MMS limitation */
            U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
            MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

            if (srv_uc_check_if_exceed_MMS_size_limitation
                (g_uc_p->main.instance, addr_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
            {
                (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
               
                if (g_uc_p->main.editor_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_cui_id);
                }
                else if (g_uc_p->main.editor_child_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_child_cui_id);
                }
                mmi_uc_set_group_id();
                g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
                g_uc_p->main.editor_child_cui_id = GRP_ID_INVALID;
                return MMI_TRUE;
            }
        }

        result = srv_uc_add_address(
                    g_uc_p->main.instance,
                    g_uc_p->done.to,
                    MMI_UC_ADDRESS_TYPE_PHONE_NUMBER,
                    g_uc_p->done.current_addr_type);

        MMI_ASSERT(result);

        /* update the highlighted address to the new one */
        g_uc_p->done.current_addr_index = g_uc_p->srv_msg->to_num + MMI_UC_ADD_RECIPIENT_TOTAL
            - mmi_uc_get_number_of_options_omitted() - 1;

        /* reset guibuffer */
        if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            result = mmi_uc_replace_screen(SCR_ID_UC_OPT_ADD_RECIPIENT, SCR_ID_UC_OPT_ADD_RECIPIENT, (mmi_proc_func) mmi_uc_entry_add_recipient, 0);
            //MMI_ASSERT(result);
        }
    }
    else if (g_uc_p->done.state == MMI_UC_DONE_STATE_EDIT_NUMBER)
    {
        mmi_uc_addr_struct *addr = mmi_uc_get_highlighted_addr();
        U8 ascii_addr[SRV_UC_MAX_PHONE_NUMBER_LEN + 1];
        U16 len = 0;

        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            /* Check if the msg size exceeds the MMS limitation */
            U16 ori_addr_len = strlen((char*)addr->addr);
            U8 *ori_ucs2_addr = OslMalloc((ori_addr_len + 1) * ENCODING_LENGTH);
            U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
            U32 ori_addr_size = 0;
            MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

            memset(ori_ucs2_addr, 0, (ori_addr_len + 1) * ENCODING_LENGTH);
            mmi_asc_to_ucs2((S8*) ori_ucs2_addr, (S8*) addr->addr);
            ori_addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)ori_ucs2_addr);
            OslMfree(ori_ucs2_addr);

            if (srv_uc_check_if_exceed_MMS_size_limitation
                (g_uc_p->main.instance, addr_size + g_uc_p->srv_msg->msg_size - ori_addr_size,
                 &fail_in_restricted_size_check))
            {
                (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                if (g_uc_p->main.editor_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_cui_id);
                }
                else if (g_uc_p->main.editor_child_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_child_cui_id);
                }
                mmi_uc_set_group_id();
                g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
                g_uc_p->main.editor_child_cui_id = GRP_ID_INVALID;
                return MMI_TRUE;
            }
        }

        memset(ascii_addr, 0, sizeof(ascii_addr));
        mmi_ucs2_n_to_asc((S8*) ascii_addr, (S8*) g_uc_p->done.to, SRV_UC_MAX_PHONE_NUMBER_LEN * ENCODING_LENGTH);

        len = strlen((char*)ascii_addr);
        MMI_ASSERT(len <= SRV_UC_MAX_PHONE_NUMBER_LEN);

        kal_adm_free(g_uc_p->main.mem_pool_id, addr->addr);
        addr->addr = kal_adm_alloc(g_uc_p->main.mem_pool_id, len + 1);
        MMI_ASSERT(addr->addr);

        memset(addr->addr, 0, len + 1);
        memcpy(addr->addr, ascii_addr, len);
        addr->type = MMI_UC_ADDRESS_TYPE_PHONE_NUMBER;

    }
    else
    {
        MMI_ASSERT(0);
    }
    g_uc_p->send_info.change_in_recipient_list = TRUE;
    if (mmi_uc_change_msg_type_if_needed())
    {
        pass_sig_check = mmi_uc_insert_signature_check();
    }

    srv_uc_update_msg_size(g_uc_p->main.instance);

    /* group handling */
     if (g_uc_p->main.editor_cui_id != GRP_ID_INVALID)
     {
        mmi_frm_group_close(g_uc_p->main.editor_cui_id);
     }
     else if (g_uc_p->main.editor_child_cui_id != GRP_ID_INVALID)
     {
        mmi_frm_group_close(g_uc_p->main.editor_child_cui_id);
     }
    g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
    g_uc_p->main.editor_child_cui_id = GRP_ID_INVALID;
    mmi_uc_set_group_id();

    if (mmi_ucs2strlen((S8*) g_uc_p->done.to) > SRV_UC_MAX_PHONE_NUMBER_LEN)
    {
        memset(g_uc_p->done.to, 0, (MMI_UC_MAX_RECIPIENT_LEN + 1) * ENCODING_LENGTH);
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_TRUNCATE_NUMBER_ID)), MMI_EVENT_INFO, NULL);
    }
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_entry_sig_displayConfirm_generic();
    }
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_addr_add_email_done
 * DESCRIPTION
 *  Get phonebook number
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_addr_add_email_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    BOOL result = MMI_FALSE;
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!srv_uc_is_email_addr_valid(g_uc_p->done.to))
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_INVALID_EMAIL_ADDRESS)), MMI_EVENT_ERROR, NULL);
        return MMI_TRUE;
    }

    if (g_uc_p->done.state == MMI_UC_DONE_STATE_ADD_EMAIL)
    {
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            /* Check if the msg size exceeds the MMS limitation */
            U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
            MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

            if (srv_uc_check_if_exceed_MMS_size_limitation
                (g_uc_p->main.instance, addr_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
            {
                (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                if (g_uc_p->main.editor_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_cui_id);
                }
                else if (g_uc_p->main.editor_child_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_child_cui_id);
                }
                mmi_uc_set_group_id();
                g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
                g_uc_p->main.editor_child_cui_id = GRP_ID_INVALID;
                return MMI_TRUE;
            }
        }

        result = srv_uc_add_address(
                    g_uc_p->main.instance,
                    g_uc_p->done.to,
                    MMI_UC_ADDRESS_TYPE_EMAIL,
                    g_uc_p->done.current_addr_type);

        MMI_ASSERT(result);

        /* update the highlighted address to the new one */
        g_uc_p->done.current_addr_index = g_uc_p->srv_msg->to_num +
            MMI_UC_ADD_RECIPIENT_TOTAL - mmi_uc_get_number_of_options_omitted() - 1;

        /* reset guibuffer */
        if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            result = mmi_uc_replace_screen(SCR_ID_UC_OPT_ADD_RECIPIENT, SCR_ID_UC_OPT_ADD_RECIPIENT, (mmi_proc_func) mmi_uc_entry_add_recipient, 0);
            //MMI_ASSERT(result);
        }

    }
    else if (g_uc_p->done.state == MMI_UC_DONE_STATE_EDIT_EMAIL)
    {
        srv_uc_addr_struct *addr = mmi_uc_get_highlighted_addr();
        U16 len = 0;

        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            /* Check if the msg size exceeds the MMS limitation */
            U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
            U32 ori_addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)addr->addr);
            MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

            if (srv_uc_check_if_exceed_MMS_size_limitation
                (g_uc_p->main.instance, (addr_size + g_uc_p->srv_msg->msg_size - ori_addr_size),
                 &fail_in_restricted_size_check))
            {
                (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                    mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                if (g_uc_p->main.editor_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_cui_id);
                }
                else if (g_uc_p->main.editor_child_cui_id != GRP_ID_INVALID)
                {
                    mmi_frm_group_close(g_uc_p->main.editor_child_cui_id);
                }
                g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
                g_uc_p->main.editor_child_cui_id = GRP_ID_INVALID;
                return MMI_TRUE;
            }
        }

        len = mmi_ucs2strlen((char*)g_uc_p->done.to);
        MMI_ASSERT(len <= MMI_UC_MAX_EMAIL_LEN);

        kal_adm_free(g_uc_p->main.mem_pool_id, addr->addr);
        addr->addr = kal_adm_alloc(g_uc_p->main.mem_pool_id, (len + 1) * ENCODING_LENGTH);
        MMI_ASSERT(addr->addr);

        memset(addr->addr, 0, (len + 1) * ENCODING_LENGTH);
        memcpy(addr->addr, g_uc_p->done.to, (len * ENCODING_LENGTH));
        addr->type = MMI_UC_ADDRESS_TYPE_EMAIL;
    }
    else
    {
        MMI_ASSERT(0);
    }
    g_uc_p->send_info.change_in_recipient_list = TRUE;
    if (mmi_uc_change_msg_type_if_needed())
    {
        pass_sig_check = mmi_uc_insert_signature_check();
    }

    srv_uc_update_msg_size(g_uc_p->main.instance);

    if (g_uc_p->main.editor_cui_id != GRP_ID_INVALID)
    {
        mmi_frm_group_close(g_uc_p->main.editor_cui_id);
    }
    else if (g_uc_p->main.editor_child_cui_id != GRP_ID_INVALID)
    {
        mmi_frm_group_close(g_uc_p->main.editor_child_cui_id);
    }
    mmi_uc_set_group_id();
    g_uc_p->main.editor_cui_id = GRP_ID_INVALID;
    g_uc_p->main.editor_child_cui_id = GRP_ID_INVALID;
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_entry_sig_displayConfirm_generic();
    }
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_delete_all_addr
 * DESCRIPTION
 *  Delete current highlighted group addresses
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_delete_all_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    srv_uc_delete_all_addr(g_uc_p->main.instance);
    g_uc_p->send_info.change_in_recipient_list = TRUE;
    if (mmi_uc_change_msg_type_if_needed())
    {
        pass_sig_check = mmi_uc_insert_signature_check();
    }
    srv_uc_update_msg_size(g_uc_p->main.instance);
    mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_REMOVED_ID)), MMI_EVENT_SUCCESS, NULL);

    mmi_uc_set_group_id();
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        {
            U16 next_scrn_id = 0, top_scrn_id = 0;
            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_AFTER_FLAG); 
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
        }
    }
    else
    {
        MMI_ASSERT(0);
    }
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_add_sig_confirm_to_history();
    }
}
#else

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_addr_add_number_done
 * DESCRIPTION
 *  Get phonebook number
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_addr_add_number_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->done.state == MMI_UC_DONE_STATE_ADD_NUMBER)
    {
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            /* Check if the msg size exceeds the MMS limitation */
            U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
            MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

            if (srv_uc_check_if_exceed_MMS_size_limitation
                (g_uc_p->main.instance, addr_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
            {
                if(g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND &&
                    g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW)
                {
                    (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                        mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                }
                return MMI_FALSE;
            }
        }

        result = srv_uc_add_address(
                    g_uc_p->main.instance,
                    g_uc_p->done.to,
                    MMI_UC_ADDRESS_TYPE_PHONE_NUMBER,
                    g_uc_p->done.current_addr_type);

        MMI_ASSERT(result);
    }
    else
    {
        MMI_ASSERT(0);
    }
    srv_uc_update_msg_size(g_uc_p->main.instance);
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_addr_add_email_done
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_addr_add_email_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->done.state == MMI_UC_DONE_STATE_ADD_EMAIL)
    {
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            /* Check if the msg size exceeds the MMS limitation */
            U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
            MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

            if (srv_uc_check_if_exceed_MMS_size_limitation
                (g_uc_p->main.instance, addr_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
            {
                if(g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND &&
                    g_uc_p->srv_send_info->action != SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW)
                {
                    (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                        mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                }
                return MMI_FALSE;
            }
        }

        result = srv_uc_add_address(
                    g_uc_p->main.instance,
                    g_uc_p->done.to,
                    MMI_UC_ADDRESS_TYPE_EMAIL,
                    g_uc_p->done.current_addr_type);

        MMI_ASSERT(result);
    }
    else
    {
        MMI_ASSERT(0);
    }
    srv_uc_update_msg_size(g_uc_p->main.instance);
    return MMI_TRUE;
}
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_search_phb_recipient
 * DESCRIPTION
 *  search phone book for both types of addresses
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_search_phb_recipient(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    mmi_uc_remove_empty_recipients();
    if (mmi_uc_get_buffer_recipient_count() >= SRV_UC_MAX_ADDRESS_NUM)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
        return;
    }
    else if(!mmi_uc_get_recipient_field_available_count(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type)))
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_MAX_RECIPIENT_FIELDS_ID)), MMI_EVENT_ERROR, NULL);
        return;
    }
#else
    if (g_uc_p->srv_msg->to_num >= SRV_UC_MAX_ADDRESS_NUM)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
        return;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_TO;
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    //mmi_frm_group_entry_ex(GRP_ID_ROOT, APP_UNIFIEDCOMPOSER, mmi_uc_cui_event_handler_group_proc, NULL, NULL);
    mmi_frm_group_create(GRP_ID_ROOT, APP_UNIFIEDCOMPOSER, mmi_uc_cui_event_handler_group_proc, NULL);
    mmi_frm_group_enter(APP_UNIFIEDCOMPOSER, MMI_FRM_NODE_SMART_CLOSE_FLAG);
#ifdef __MMI_UC_MULTI_SELECT__
    g_uc_p->main.select_contact_cui_gid = cui_phb_list_group_select_contact_create(APP_UNIFIEDCOMPOSER);
#else
    g_uc_p->main.select_contact_cui_gid = cui_phb_list_select_contact_create(APP_UNIFIEDCOMPOSER);
#endif
    if(g_uc_p->main.select_contact_cui_gid != GRP_ID_INVALID)
    {
        if(g_uc_p->srv_msg_type->caller_specific_msg_type == MMI_UC_MSG_TYPE_SMS_ONLY) 
        {
            cui_phb_list_select_contact_set_field_filter(g_uc_p->main.select_contact_cui_gid, SRV_PHB_ENTRY_FIELD_NUMBER);
        }
        else
        {
            cui_phb_list_select_contact_set_field_filter(g_uc_p->main.select_contact_cui_gid, SRV_PHB_ENTRY_FIELD_NUMBER | SRV_PHB_ENTRY_FIELD_EMAIL);        
        }
    #ifdef __MMI_UC_MULTI_SELECT__
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        cui_phb_list_select_contact_set_count(g_uc_p->main.select_contact_cui_gid, mmi_uc_get_recipient_field_available_count(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type)));
#else
        cui_phb_list_select_contact_set_count(g_uc_p->main.select_contact_cui_gid, (SRV_UC_MAX_ADDRESS_NUM - g_uc_p->srv_msg->to_num));
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        cui_phb_list_group_select_contact_run(g_uc_p->main.select_contact_cui_gid);
    #else
        cui_phb_list_select_contact_run(g_uc_p->main.select_contact_cui_gid);
    #endif
    }
    else
    {
        mmi_frm_group_close(APP_UNIFIEDCOMPOSER);
    }
    return;
}

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_recipient_options_change_to_to
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_recipient_options_change_to_to(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    srv_uc_addr_struct *addr = mmi_uc_get_highlighted_addr();

    addr->group = MMI_UC_ADDRESS_GROUP_TYPE_TO;
    mmi_uc_set_group_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_recipient_options_change_to_cc
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_recipient_options_change_to_cc(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    srv_uc_addr_struct *addr = mmi_uc_get_highlighted_addr();

    addr->group = MMI_UC_ADDRESS_GROUP_TYPE_CC;
    mmi_uc_set_group_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_recipient_options_change_to_bcc
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_recipient_options_change_to_bcc(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    srv_uc_addr_struct *addr = mmi_uc_get_highlighted_addr();

    addr->group = MMI_UC_ADDRESS_GROUP_TYPE_BCC;
    mmi_uc_set_group_id();
}
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

 #if (MMI_MAX_SIM_NUM >=2)
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_entry_sim_option
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_entry_sim_option(void)
{
    if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM1
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM2
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM3
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM4/*kuldeep_nosim*/
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_UNCLASSIFIED)
        {

		if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM1)
            g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM1;
    else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM2)
       g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM2;
    else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM3)
       g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM3;
    else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM4)
       g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM4;
        else
        {
		g_uc_p->srv_send_info->send_sim_id = SRV_UC_SIM_ID_GSM_SIM1;/*kuldeep_nosim*/
        }
        if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND_AND_SAVE)
        {
            mmi_uc_process_send_and_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SAVE)
        {
            mmi_uc_process_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND)
        {
            mmi_uc_process_send();
        }
    }
    else
    {
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER
            || (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER
                && (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND)))
        {
            //mmi_uc_entry_sim_option();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SAVE)
        {
            mmi_uc_process_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND_AND_SAVE)
        {
            mmi_uc_process_send_and_save();
        }
    }
}

 #if (defined(__OP01__) && defined(__MMI_DUAL_SIM_MASTER__))
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
       #if (MMI_MAX_SIM_NUM >=2)
/* under construction !*/
/* under construction !*/
      #else      
/* under construction !*/
      #endif 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_entry_sim_option_csk
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_entry_sim_option_csk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //mmi_uc_set_group_id();
 #if (MMI_MAX_SIM_NUM ==2) || defined(__MMI_DYNAMIC_SIM_DYNAMIC_UI__)
#ifndef __MMI_DYNAMIC_SIM_DYNAMIC_UI__
    if (!(g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM1))
    {
        if ((g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM2))
        {
            g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM2;
        }
        else
        {
            g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_UNCLASSIFIED;
        }

        if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND_AND_SAVE)
        {
            mmi_uc_process_send_and_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SAVE)
        {
            mmi_uc_process_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND)
        {
            mmi_uc_process_send();
        }
    }
    else if (!(g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM2))
    {
        if (g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM1)


        {
            g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM1;
        }
        else
        {
            g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_UNCLASSIFIED;
        }

        if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND_AND_SAVE)
        {
            mmi_uc_process_send_and_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SAVE)
        {
            mmi_uc_process_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND)
        {
            mmi_uc_process_send();
        }
    }
    else
#else
    if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM1
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM2
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM3
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM4)
   {
    
	   if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM1)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM1;
       else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM2)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM2;
       else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM3)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM3;
       else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM4)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM4;
       else
           g_uc_p->srv_send_info->send_sim_id = SRV_UC_SIM_ID_UNCLASSIFIED;
	   mmi_uc_process_send();
   }
   else
#endif
    {
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER
            || (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER
                && (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND)))
        {
            mmi_uc_entry_sim_option();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SAVE)
        {
            mmi_uc_process_save();
        }
        else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND_AND_SAVE)
        {
            mmi_uc_process_send_and_save();
        }
    }
#endif
 #if (MMI_MAX_SIM_NUM >=3) && !defined(__MMI_DYNAMIC_SIM_DYNAMIC_UI__)
	 mmi_uc_launch_sim();
#endif
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_convert_sim_id_to_hilite_index
 * DESCRIPTION
 *  
 * PARAMETERS
 *  sim_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
S32 mmi_uc_convert_sim_id_to_hilite_index(mmi_uc_sim_id sim_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (sim_id == UC_SIM_ID_GSM_SIM2)
    {
        return 1;
    }
    else
    {
        return 0;
    }
}
#endif  /* #if (MMI_MAX_SIM_NUM ==2) */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_max_recipient_count
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  U32
 *****************************************************************************/
U32 mmi_uc_get_max_recipient_count(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return SRV_UC_MAX_ADDRESS_NUM;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_process_send_to
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_process_send_to(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* reset */
    g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
    g_uc_p->send_info.abort = MMI_UC_ABORT_NONE;
    g_uc_p->send_info.curr_folder =
        (U16) mmi_uc_get_current_msg_box_type(g_uc_p->srv_send_info->existed_msg_id);
    if (mmi_uc_is_no_recepient())
    {
        g_uc_p->done.current_addr_index = 0;
    }
    else
    {
        g_uc_p->done.current_addr_index = MMI_UC_ADD_RECIPIENT_TOTAL - mmi_uc_get_number_of_options_omitted();
    }
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
    {
        mmi_uc_entry_add_recipient();
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT);

        if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            mmi_uc_replace_screen(SCR_ID_UC_PROCESSING, SCR_ID_UC_OPT_ADD_RECIPIENT, (mmi_proc_func) mmi_uc_entry_add_recipient, 0);
        }
        else
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_GET_MMS_CONTENT_RSP_INTERRUPT_DONNOTHING);
        }
    }
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_multi_object_insert_req
 * DESCRIPTION
 *  Process function of entering unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
kal_bool mmi_uc_multi_object_insert_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result = 0;
    //U16 title_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!(mmi_uc_is_uc_ready()) || mmi_uc_is_uc_reenter())
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);

        return MMI_FALSE;
    }

#ifdef __USB_IN_NORMAL_MODE__
    if (srv_usb_is_in_mass_storage_mode() && mma_is_storage_exported_to_pc())
    {
        /* in mass storage mode */
        if (srv_usb_check_path_exported((WCHAR*)SRV_UC_FOLDER_DRV))
        {
            /* MMI public drive is exported, cannot use this app */
            mmi_usb_app_unavailable_popup(0);   /* pass 0 will show default string */
            return MMI_FALSE;
        }
    }
#endif /* __USB_IN_NORMAL_MODE__ */ 

    result = srv_uc_check_uc_folder(g_uc_p->main.instance);
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_PROCESS_ENTRY_WRITE_MSG_P1, result);
    if (result < 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(srv_fmgr_fs_error_get_string(result))), MMI_EVENT_FAILURE, NULL);

        return MMI_FALSE;
    }
	if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER)
    {
        g_uc_p->main.uc_cui_gid = mmi_frm_group_create(GRP_ID_ROOT, GRP_ID_UNIFIED_COMPOSER, mmi_uc_editor_proc, NULL);
        mmi_frm_group_enter(g_uc_p->main.uc_cui_gid, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    }
    else
    {
        mmi_frm_group_enter(g_uc_p->main.uc_cui_gid, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    }
    mmi_uc_show_progress_entry_composer_write_msg();
    g_uc_p->other_app_temp_uc_info = kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(mmi_uc_entry_write_struct));
    if(g_uc_p->other_app_temp_uc_info)
    {
        memset(g_uc_p->other_app_temp_uc_info, 0, sizeof(mmi_uc_entry_write_struct));
    }
    else
    {
        MMI_ASSERT(0);
    }

    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_progress_entry_composer_write_msg_on_fail
 * DESCRIPTION
 *  Process function of entering unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_handle_progress_entry_composer_write_msg_on_fail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->other_app_temp_uc_info != NULL)
    {
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_show_progress_entry_composer_write_msg
 * DESCRIPTION
 *  Process function of entering unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_show_progress_entry_composer_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //U16 title_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //title_id = STR_UC_WRITE_MSG_ID;

    mmi_uc_set_processing_screen(
        0,  /* title_id, */
        STR_GLOBAL_PLEASE_WAIT,
        mmi_get_event_based_image(MMI_EVENT_PROGRESS),
        0);
    mmi_uc_entry_processing_generic();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_collect_object_ind_data
 * DESCRIPTION
 *  Process function of entering unified composer
 * PARAMETERS
 *  peer_buffer_p       [?]         
 *  num_of_object       [IN]        
 *  more                [IN]        
 *  uc_data             [IN]        
 *  peer_buff_struct(?)
 *  kal_uint32(?)
 *  kal_bool(?)
 *  mmi_uc_entry_write_struct(?)
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_collect_object_ind_data(
        peer_buff_struct *peer_buffer_p,
        kal_uint32 num_of_object,
        kal_bool more,
        mmi_uc_entry_write_struct **uc_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_uint8 *peer_pdu = NULL;
    kal_uint16 peer_pdu_len = 0;
    srv_uc_addr_struct *addr_top_node = g_uc_p->other_app_temp_uc_info->addr;
    U32 count;
    mms_multi_object_struct *multi_object_data_p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    *uc_data = g_uc_p->other_app_temp_uc_info;
    multi_object_data_p = kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(mms_multi_object_struct) * num_of_object);
    MMI_ASSERT(multi_object_data_p);
    memset(multi_object_data_p, 0, sizeof(mms_multi_object_struct) * num_of_object);
    peer_pdu = (kal_uint8*) get_pdu_ptr(peer_buffer_p, &peer_pdu_len);
    memcpy((char*)multi_object_data_p, (char*)peer_pdu, sizeof(mms_multi_object_struct) * num_of_object);

    for (count = 0; count < num_of_object; count++)
    {
        switch (multi_object_data_p[count].type)
        {
            case MMS_MULTI_OBJECT_INSERT_TYPE_ADDR_PHONE_NUMBER:
            case MMS_MULTI_OBJECT_INSERT_TYPE_ADDR_EMAIL:
            {
                srv_uc_addr_struct *addr = NULL;
                U32 obj_len = mmi_chset_utf8_strlen((const kal_uint8*)(multi_object_data_p[count].object));

                if (obj_len > 0)
                {
                    addr = kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(srv_uc_addr_struct));
                    MMI_ASSERT(addr);
                    memset(addr, 0x00, sizeof(srv_uc_addr_struct));
                    addr->addr = kal_adm_alloc(g_uc_p->main.mem_pool_id, (obj_len << 1 + 1) * ENCODING_LENGTH);
                    MMI_ASSERT(addr->addr);
                    memset(addr->addr, 0x00, (obj_len << 1 + 1) * ENCODING_LENGTH);
                    mmi_chset_utf8_to_ucs2_string(
                        (kal_uint8*) addr->addr,
                        (kal_int32) (obj_len << 1 + 1),
                        (kal_uint8*) (multi_object_data_p[count].object));
                    addr->type =
                        (multi_object_data_p[count].type ==
                         MMS_MULTI_OBJECT_INSERT_TYPE_ADDR_PHONE_NUMBER) ? MMI_UC_ADDRESS_TYPE_PHONE_NUMBER :
                        MMI_UC_ADDRESS_TYPE_EMAIL;
                    addr->group = MMI_UC_ADDRESS_GROUP_TYPE_TO;
                    if (addr_top_node)
                    {
                        while (addr_top_node->next)
                        {
                            if (addr_top_node->next)
                            {
                                addr_top_node = addr_top_node->next;
                            }
                        }
                        addr_top_node->next = addr;
                    }
                    else
                    {
                        g_uc_p->other_app_temp_uc_info->addr = addr;
                        addr_top_node = addr;
                    }
                    g_uc_p->other_app_temp_uc_info->addr_num++;
                }
            }
                break;
        }
    }
    kal_adm_free(g_uc_p->main.mem_pool_id, multi_object_data_p);
    multi_object_data_p = NULL;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_free_collected_object_ind_data
 * DESCRIPTION
 *  Free multi object context
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_free_collected_object_ind_data(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //kal_uint8 *peer_pdu = NULL;
    //kal_uint16 peer_pdu_len = 0;
    srv_uc_addr_struct *addr_top_node = g_uc_p->other_app_temp_uc_info->addr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    while (addr_top_node)
    {
        srv_uc_addr_struct *temp_node_p = addr_top_node->next;

        kal_adm_free(g_uc_p->main.mem_pool_id, addr_top_node->addr);
        kal_adm_free(g_uc_p->main.mem_pool_id, addr_top_node);
        addr_top_node = temp_node_p;
    }
    kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->other_app_temp_uc_info);
    g_uc_p->other_app_temp_uc_info = NULL;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_multi_object_req_is_in_process
 * DESCRIPTION
 *  To check is multirequest already in process
 * PARAMETERS
 *  void
 * RETURNS
 *  kal_bool
 *****************************************************************************/
kal_bool mmi_uc_is_multi_object_req_is_in_process(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG) ||
        mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
    {
        return KAL_TRUE;
    }
    else
    {
        return KAL_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_entry_write_msg
 * DESCRIPTION
 *  Pre entry function of unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_entry_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_write_msg_launch(0);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_discard_edited_msg_confirm_popup_group_proc
 * DESCRIPTION
 *  Pre entry function of unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_discard_edited_msg_confirm_popup_group_proc(mmi_alert_result_evt_struct *evt)
{
    if (evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch (evt->result)
        {
        case MMI_ALERT_CNFM_1:
        case MMI_ALERT_CNFM_2:
        case MMI_ALERT_CNFM_3:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_OK:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_YES:
            mmi_uc_discard_msg_before_enter_write_msg();
            break;
        case MMI_ALERT_CNFM_NO:
            mmi_frm_scrn_close_active_id();
            break;
        }
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_create_msg_rsp_timeout_callback
 * DESCRIPTION
 *  the timeout handler for interrupt cases while handling create_mms_rsp
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_create_msg_rsp_timeout_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* check if the interrupt screen exit or not, if not, still start timer to wait for next check */
    if (g_uc_p->srv_send_info->action != SRV_UC_ACTION_IDLE)
    {
        
        /* restart processing timer */
        //StartTimer(UC_INPROGRESS_TIMER_ID, MMI_UC_INPROGRESS_TIME_OUT, mmi_uc_time_out_processing_generic);
        StartTimer(
            UC_CREATE_RSP_REENTRY_RETRY_TIMER_ID,
            MMI_UC_CREATE_RSP_REENTRY_RETRY_TIME,
            mmi_uc_create_msg_rsp_timeout_callback);
    }
    else
    {
        /* if the create_rsp is triggered by mmi_uc_create_mms_rsp_retry_timeout_callback, then the retry check flow won't be triggered in create_mms_rsp, 
           so we can free create_msg_rsp here. */
        /*mmi_frm_group_close(group_id_reentry);*/
        //mmi_frm_display_dummy_screen();
        mmi_frm_group_close(g_uc_p->main.group_id_reentry);
        g_uc_p->main.group_id_reentry = GRP_ID_INVALID;
        StopTimer(UC_CREATE_RSP_REENTRY_RETRY_TIMER_ID);
        if(g_uc_p->main.operation_reentry == (uc_confirm_func_ptr)mmi_uc_write_msg_launch)
        {
            g_uc_p->main.operation_reentry = NULL;
            mmi_uc_write_msg_launch(g_uc_p->main.callback_id);
        }
        else if(g_uc_p->main.operation_reentry == (uc_confirm_func_ptr)mmi_uc_entry_write_msg_with_content)
        {
            g_uc_p->main.operation_reentry = NULL;
            mmi_uc_entry_write_msg_with_content(g_uc_p->main.reentry_struct->type, g_uc_p->main.reentry_struct->data);
        }
        else if(g_uc_p->main.operation_reentry == (uc_confirm_func_ptr)cui_uc_write_msg_from_mms_launch)
        {
            g_uc_p->main.operation_reentry = NULL;
            cui_uc_write_msg_from_mms_launch(g_uc_p->main.callback_id, g_uc_p->main.reentry_msg);
        }
        else if(g_uc_p->main.operation_reentry == (uc_confirm_func_ptr)cui_uc_entry_msg_operation_launch)
        {
            g_uc_p->main.operation_reentry = NULL;
            cui_uc_entry_msg_operation_launch(g_uc_p->main.callback_id, g_uc_p->main.reentry_msg_id, g_uc_p->main.reentry_msg_type, g_uc_p->main.reentry_msg_operation);
        }
        else if(g_uc_p->main.operation_reentry == (uc_confirm_func_ptr)cui_uc_write_msg_with_content_launch)
        {
            g_uc_p->main.operation_reentry = NULL;
            cui_uc_write_msg_with_content_launch(g_uc_p->main.callback_id, g_uc_p->main.reentry_struct->type, g_uc_p->main.reentry_struct->data);
        }
    }
    return;
}

mmi_ret mmi_uc_dummy_proc(mmi_event_struct *evt)
{
    if(evt->evt_id == EVT_ID_GROUP_DEINIT)
    {
        /*mmi_frm_scrn_close (group_id_reentry, SCR_ID_UC_PROCESSING);*/
    }
    return MMI_RET_OK;
}



void mmi_uc_show_progress_in_reentry(mmi_id group_id)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(group_id)
    {
    g_uc_p->main.group_id_reentry = mmi_frm_group_create(
                    group_id, GRP_ID_AUTO_GEN, mmi_uc_dummy_proc, (void*)NULL); 
    }
    else
    {

        g_uc_p->main.group_id_reentry = mmi_frm_group_create(
                    GRP_ID_ROOT, GRP_ID_AUTO_GEN, mmi_uc_dummy_proc, (void*)NULL);
    }
    mmi_frm_group_enter(g_uc_p->main.group_id_reentry, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    if( mmi_frm_scrn_enter(
            g_uc_p->main.group_id_reentry,
            SCR_ID_UC_PROCESSING,
            NULL,
            (FuncPtr)mmi_uc_show_progress_in_reentry,
            MMI_FRM_FULL_SCRN))
    {

		mmi_frm_set_curr_scr_blt_mode(MMI_FRM_SCR_BLT_IMMEDIATE);
        ShowCategory66Screen(
            0,
            0,
            0,
            0,
            0,
            0,
            (PU8) GetString(STR_GLOBAL_PLEASE_WAIT),
            mmi_get_event_based_image(MMI_EVENT_PROGRESS),
            NULL);

        
        ClearInputEventHandler(MMI_DEVICE_ALL);
        ClearKeyHandler(KEY_END, KEY_EVENT_UP);
        ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
        ClearKeyHandler(KEY_END, KEY_LONG_PRESS);
        ClearKeyHandler(KEY_END, KEY_REPEAT);
        
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_write_msg_launch
 * DESCRIPTION
 *  Pre entry function of unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_write_msg_launch(mmi_id parent_cui_gid)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id group_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_uc_is_uc_ready())
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);

        return;
    }

    if (mmi_uc_is_uc_reenter())
    {
        //mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);

        mmi_uc_write_msg_delete_history_hdlr(NULL);
        //return;
    }

#ifdef __USB_IN_NORMAL_MODE__
    if (srv_usb_is_in_mass_storage_mode())
    {
        /* in mass storage mode */
        if (srv_usb_check_path_exported((WCHAR*) SRV_UC_FOLDER_DRV))
        {
            /* MMI public drive is exported, cannot use this app */
            mmi_usb_app_unavailable_popup(0);   /* pass 0 will show default string */
            return;
        }
    }
#endif /* __USB_IN_NORMAL_MODE__ */ 

    if (g_uc_p->srv_send_info->action == SRV_UC_ACTION_SAVE_IN_BACKGROUND)
    {
        g_uc_p->main.callback_id = parent_cui_gid;

        g_uc_p->main.operation_reentry = (uc_confirm_func_ptr)mmi_uc_write_msg_launch;

        mmi_uc_show_progress_in_reentry(parent_cui_gid);

       StartTimer(
                                UC_CREATE_RSP_REENTRY_RETRY_TIMER_ID,
                                MMI_UC_CREATE_RSP_REENTRY_RETRY_TIME,
                                mmi_uc_create_msg_rsp_timeout_callback);
       
       return;
    }

    if (g_uc_p->srv_send_info->action != SRV_UC_ACTION_IDLE)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);

        return;
    }

    g_uc_p->srv_main->state = MMI_UC_STATE_WRITE_NEW_MSG;

    if (g_uc_p->srv_msg->msg_body.slide_no > 0 && 
        mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        mmi_confirm_property_struct arg;
        /* UC in entered by other apps, ex, bar code reader. And then MT call. Option\message center\write message */
        MMI_ASSERT((srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_ALL, NULL) > 0));
		if(!((srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_ALL, NULL) > 0)))
		{
		MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
		}
	    mmi_confirm_property_init(&arg, CNFM_TYPE_YESNO);
	    arg.callback = (mmi_proc_func)mmi_uc_discard_edited_msg_confirm_popup_group_proc;
        arg.parent_id = parent_cui_gid;
	    mmi_confirm_display((WCHAR *)(get_string(STR_UC_DISCARD_EDITED_MSG_ID)), MMI_EVENT_QUERY, &arg);
    }
    else
    {
		if (mmi_frm_group_get_active_id() != g_uc_p->main.uc_cui_gid &&  g_uc_p->main.uc_cui_gid == GRP_ID_UNIFIED_COMPOSER)
		{
			mmi_frm_group_close (g_uc_p->main.uc_cui_gid);
			g_uc_p->main.uc_cui_gid = GRP_ID_INVALID;
		}
        if (parent_cui_gid == 0)
        {
			parent_cui_gid = GRP_ID_ROOT;
            group_id = mmi_frm_group_create(
                    GRP_ID_ROOT, GRP_ID_UNIFIED_COMPOSER, mmi_uc_editor_proc, (void*)NULL); 
            mmi_frm_group_enter(group_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
        }
        else
        {
            group_id = mmi_frm_group_create(
                    parent_cui_gid, GRP_ID_UNIFIED_COMPOSER, mmi_uc_editor_proc, (void*)NULL); 
            mmi_frm_group_enter(group_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
        }
		mmi_uc_reset_msg();
        g_uc_p->main.uc_cui_gid = group_id;
		g_uc_p->main.parent_cui_gid = parent_cui_gid;

        g_uc_p->srv_msg_type->setting_msg_type = srv_uc_get_setting_msg_type();
        g_uc_p->srv_msg_type->curr_msg_type = g_uc_p->srv_msg_type->setting_msg_type;
    #ifdef __MMI_MMS_STANDALONE_COMPOSER__
        g_uc_p->srv_msg_type->caller_specific_msg_type = MMI_UC_MSG_TYPE_MMS_ONLY;
    #else /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
    #ifdef __MMI_MMS_POSTCARD__
        if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
        {
            g_uc_p->srv_msg_type->curr_msg_type = MMI_UC_MSG_TYPE_MMS_PREFER;
            g_uc_p->srv_msg_type->caller_specific_msg_type = MMI_UC_MSG_TYPE_MMS_ONLY;
        }
        else
    #endif /* __MMI_MMS_POSTCARD__ */ 
        {
            g_uc_p->srv_msg_type->caller_specific_msg_type = MMI_UC_MSG_TYPE_DEFAULT;
        }
    #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 

        g_uc_p->srv_msg_type->backup_msg_type = MMI_UC_MSG_TYPE_DEFAULT;

        mmi_uc_process_entry_write_msg();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_discard_msg_before_enter_write_msg
 * DESCRIPTION
 *  Discard previous edited msg before entering write msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_discard_msg_before_enter_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 startScrnId = SCR_ID_UC_EDITOR;
    U16 endScrnId = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DISCARD_MSG_BEFORE_ENTER_WRITE_MSG);

    /* UC in entered by other apps, ex, bar code reader. And then MT call. Option\message center\write message */
    MMI_ASSERT((srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_ALL, NULL) > 0));
	if(!((srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_ALL, NULL) > 0)))
	{
	MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
	}
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, startScrnId, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        endScrnId = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
        if (endScrnId)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DISCARD_MSG_BEFORE_ENTER_WRITE_MSG_P1, endScrnId);

            if ( mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, endScrnId, 1, 0, startScrnId, 1) != MMI_RET_ERR)
            {
                MMI_TRACE(
                    MMI_COMMON_TRC_G6_MSG,
                    TRC_MMI_UC_DISCARD_MSG_BEFORE_ENTER_WRITE_MSG_P2,
                    startScrnId,
                    endScrnId);

            }
            else
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);

                return;
            }
        }
        else
        {
            MMI_ASSERT(0);
        }
    }
    else
    {
        MMI_ASSERT(0);
    }

    mmi_uc_reset_msg();

    g_uc_p->srv_msg_type->setting_msg_type = srv_uc_get_setting_msg_type();
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        g_uc_p->srv_msg_type->curr_msg_type = MMI_UC_MSG_TYPE_MMS_PREFER;
    }
    else
#endif /* __MMI_MMS_POSTCARD__ */ 
    {
        g_uc_p->srv_msg_type->curr_msg_type = g_uc_p->srv_msg_type->setting_msg_type;
    }
    g_uc_p->srv_msg_type->caller_specific_msg_type = MMI_UC_MSG_TYPE_DEFAULT;
    g_uc_p->srv_msg_type->backup_msg_type = MMI_UC_MSG_TYPE_DEFAULT;

    mmi_uc_process_entry_write_msg();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_entry_write_msg
 * DESCRIPTION
 *  Process function of entering unified composer
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_entry_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result = 0;
    //U16 title_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UC_USE_ASM__
    if(!mmi_uc_alloc_asm_pool())
    {
		mmi_frm_group_close(g_uc_p->main.uc_cui_gid);
        return;
    }
#endif /* __MMI_UC_USE_ASM__ */
    result = srv_uc_check_uc_folder(g_uc_p->main.instance);
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_PROCESS_ENTRY_WRITE_MSG_P1, result);
    if (result < 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(srv_fmgr_fs_error_get_string(result))), MMI_EVENT_FAILURE, NULL);
		mmi_frm_group_close(g_uc_p->main.uc_cui_gid);
	#ifdef __MMI_UC_USE_ASM__
		mmi_uc_de_alloc_asm_pool();
	#endif /* __MMI_UC_USE_ASM__ */

        return;
    }
#ifdef __MMI_MMS_POSTCARD__
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_PROCESS_ENTRY_WRITE_MSG_P1, g_uc_p->srv_msg_type->MMS_edit_mode);
#endif 
    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD || (g_uc_p->srv_main->mode != SRV_UC_NORMAL_EDIT_MODE
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        && g_uc_p->srv_main->mode != SRV_UC_SEND_WITHOUT_EDIT_MODE && 
            g_uc_p->srv_main->mode != SRV_UC_SEND_WITH_EDIT_MODE
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        ))
    {
        //title_id = STR_GLOBAL_FORWARD;
    }
    else if (g_uc_p->srv_main->state == MMI_UC_STATE_SEND
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                || g_uc_p->srv_main->mode != SRV_UC_NORMAL_EDIT_MODE
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        )
    {
        //title_id = STR_GLOBAL_SEND;
    }
    else
    {
        //title_id = STR_UC_WRITE_MSG_ID;
    }

/* Remove progress screen*/
    if(g_uc_p->srv_main->state != MMI_UC_STATE_WRITE_NEW_MSG)
    {
        mmi_uc_set_processing_screen(
            0,
            STR_GLOBAL_PLEASE_WAIT,
            mmi_get_event_based_image(MMI_EVENT_PROGRESS),
            0);
        mmi_uc_entry_processing_generic();
    }

#ifndef __MMI_MMS_STANDALONE_COMPOSER__
    /* need EMS library support  */
    srv_uc_get_sms_setting(g_uc_p->main.instance);
#endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 

    /* send get setting request to MMS */
    mmi_uc_get_mms_setting();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_write_msg_end_key_hdlr
 * DESCRIPTION
 *  End key handler for unified composer editor screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_write_msg_end_key_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_handle_text_in_current_slide();
    /* mmi_uc_write_msg_delete_history_hdlr would be called in ExecuteRootMainHistoryScreen */
    /* mmi_uc_write_msg_delete_history_hdlr(NULL); */

    ExecCurrEndKeyDownHandler();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_write_msg
 * DESCRIPTION
 *  Exit function from write msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result = FS_NO_ERROR;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* If press RSK in uc screen to exit editor, msg would be reset in RSK handler mmi_uc_go_back_from_write_msg */
    if (g_uc_p->srv_msg->msg_body.curr_slide)
    {
        result = mmi_uc_handle_text_in_current_slide();
        g_uc_p->srv_main->current_text_file_save_result = result;
    }
}

/* because postcard text object is already be encoded based on postcard format, so here, does not update text file again in case to overwrite encoded result */
#ifdef __MMI_MMS_POSTCARD__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_exit_write_msg_postcard
 * DESCRIPTION
 *  Exit function from write msg (postcard mode)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_exit_write_msg_postcard(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return;
}
#endif /* __MMI_MMS_POSTCARD__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_battery_low_hdlr
 * DESCRIPTION
 *  pre evnet handler when battery is low
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_battery_low_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* If the UC editor screen does not in the history, mean user does not change the content, no need to save */
    if (!mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG) && 
        mmi_frm_scrn_get_active_id() != SCR_ID_UC_EDITOR) 
    {
        return;
    }

    if (mmi_uc_is_pending_content()
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        || mmi_uc_is_pending_recipient_in_editor()
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        )
    {
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SAVE_IN_BACKGROUND_WHEN_BATTERY_LOW;

    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        mmi_uc_get_recipient_list();
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

        /* Save the edited msg. */
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
        {
        #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
            srv_uc_set_valid_sim(g_uc_p->main.instance);
            mmi_uc_save_sms_req();
        #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
            MMI_ASSERT(0);
        #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
        }
        else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
     #ifdef __MMI_MMS_INSERT_SENDER_ADDR_FROM_SIM__        
		      srv_uc_get_owner_num(g_uc_p->main.instance, mmi_uc_get_owner_from_prefered_sim());       
	 #endif
        if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
            {
                mmi_uc_create_mms_req();
            }
    
        }
    }

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_battery_low_callback
 * DESCRIPTION
 *  pre evnet handler when battery is low
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_battery_low_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    StartTimer(UM_BATTERY_LOW_CHECK_TIMER_ID, MMI_UC_BATTERY_LOW_CHECK_TIME, mmi_uc_battery_low_hdlr);

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_write_msg_delete_history_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  in_param        [?]     [?]
 * RETURNS
 *  U8
 *****************************************************************************/
U8 mmi_uc_write_msg_delete_history_hdlr(void *in_param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //S32 result = 0;
    MMI_BOOL local_flag = (MMI_BOOL)0;
#ifdef __MMI_OP02_LEMEI__
	srv_uc_MMS_edit_mode_enum pre_value;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* stop timer here to prevent the timer is timeout after UC screen does not exist 
       ps. in SRV_UC_ACTION_SAVE_IN_BACKGROUND, won't trigger create_rsp interrupt retry handling. */
    StopTimer(UC_CREATE_RSP_RETRY_TIMER_ID);
    if (g_uc_p->main.create_msg_rsp)
    {
        local_flag = MMI_TRUE;
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->main.create_msg_rsp);
        g_uc_p->main.create_msg_rsp = NULL;
    }
#ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__
    if (g_uc_p->main.confirm_str_id == STR_UC_CARD_NOT_PRESENT_CONFIRM ||
        g_uc_p->main.confirm_str_id == STR_UC_MAX_MSG_CARD_CONFIRM ||
        g_uc_p->main.confirm_str_id == STR_UC_MAX_MSG_PHONE_CONFIRM)
    {
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
        g_uc_p->main.confirm_str_id = 0;
    }
#endif /* __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__ */
    if (g_uc_p->srv_send_info->action == SRV_UC_ACTION_IDLE)
    {
    #ifndef __MMI_UC_USE_ASM__
        if (mmi_uc_is_pending_content()
        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            || mmi_uc_is_pending_recipient_in_editor()
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
            )
        {
            MMI_TRACE(
                MMI_COMMON_TRC_G6_MSG,
                TRC_MMI_UC_WRITE_MSG_DELETE_HISTORY_HDLR_SAVE_IN_BG_P1,
                g_uc_p->srv_msg_type->curr_msg_type);

            g_uc_p->srv_send_info->action = SRV_UC_ACTION_SAVE_IN_BACKGROUND;

        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            mmi_uc_get_recipient_list();
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

            /* Save the edited msg. */
            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
            {
            #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
                srv_uc_set_valid_sim(g_uc_p->main.instance);
                mmi_uc_save_sms_req();
            #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
                MMI_ASSERT(0);
            #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
            }
            else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
            {
                if (g_uc_p->srv_msg->msg_size > g_uc_p->srv_mms_info->max_mms_size)
                {
                #ifdef __MMI_OP12_MMS_MAX_SIZE_SUPPORT__
                    /* Required as edit allowed on big MMS also. So restrict to save on end key. */
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_WRITE_MSG_DELETE_HISTORY_HDLR_RESET_MSG);
                    mmi_uc_reset_msg();
                    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
                    return FALSE;
                #else /* __MMI_OP12_MMS_MAX_SIZE_SUPPORT__ */ 
                    /* because in size exceed case, not clear subject, if the screen is deleted at this time, the 
                       size will exceed the mms limitaion */
                    memset(g_uc_p->srv_msg->subject, 0, sizeof(g_uc_p->srv_msg->subject));
                #endif /* __MMI_OP12_MMS_MAX_SIZE_SUPPORT__ */ 
                }
                  
#ifdef __MMI_OP02_LEMEI__
				pre_value =g_uc_p->srv_msg_type->MMS_edit_mode;
#endif  
 #ifdef __MMI_MMS_INSERT_SENDER_ADDR_FROM_SIM__	      
   srv_uc_get_owner_num(g_uc_p->main.instance, mmi_uc_get_owner_from_prefered_sim());
 #endif             
// result = srv_uc_create_mms_xml_description_file(g_uc_p->main.instance);
                
        
			/* in lemei mms direct discard it on end key*/ 
#ifdef __MMI_OP02_LEMEI__ 
                     if(pre_value == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
                    {
                        mmi_uc_reset_msg();
                        g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_NORMAL_MMS;
                    }
                    else
#endif
                    {
                        if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)             
                        {
                            mmi_uc_create_mms_req();
                        }

                    }
            /*    else
                {
                    mmi_uc_reset_msg();
#ifdef __MMI_OP02_LEMEI__ 
 
		if(g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
                    {
                        g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_NORMAL_MMS;
                    }
#endif                   
                } */
            }
        }
        else
    #endif /* __MMI_UC_USE_ASM__ */
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_WRITE_MSG_DELETE_HISTORY_HDLR_RESET_MSG);

            mmi_uc_reset_msg();
#ifdef __MMI_OP02_LEMEI__ 
            if(g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
            {
                g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_NORMAL_MMS;
            }
#endif  
        }
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_WRITE_MSG_DELETE_HISTORY_HDLR_DO_NOTHING);

        /* Disable following actions in mmi_uc_action_fsm() */
        if (local_flag == MMI_TRUE)
        {
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
            local_flag = MMI_FALSE;
        }
    }
    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
    return FALSE;
}

#ifdef __MMI_MMS_POSTCARD__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_write_msg_selection_del_history_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  in_param        [?]     [?]
 * RETURNS
 *  U8
 *****************************************************************************/
U8 mmi_uc_write_msg_selection_del_history_hdlr(void *in_param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_NORMAL_MMS;
    return FALSE;
}
#endif /* __MMI_MMS_POSTCARD__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_go_back_from_write_msg
 * DESCRIPTION
 *  Go back function from write msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_go_back_from_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_exit_write_msg();
    if (mmi_uc_is_pending_content()
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        || mmi_uc_get_buffer_recipient_count()
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        )
    {
#ifndef __MMI_FTE_SUPPORT__
        mmi_uc_entry_exit_option();
#else
        mmi_uc_discard_msg_before_exit_write_msg();
#endif
    }
    else
    {
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR);
        mmi_uc_reset_msg();
        srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_discard_msg_before_exit_write_msg
 * DESCRIPTION
 *  Go back function from write msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_discard_msg_before_exit_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_reset_msg();
    srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_msg_confirm_popup_group_proc
 * DESCRIPTION
 *  Go back function from write msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_save_msg_confirm_popup_group_proc(mmi_alert_result_evt_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch (evt->result)
        {
        case MMI_ALERT_CNFM_1:
        case MMI_ALERT_CNFM_2:
        case MMI_ALERT_CNFM_3:
             #if (MMI_MAX_SIM_NUM >=2)
                mmi_uc_pre_entry_sim_option();
            #else 
                mmi_uc_process_save();
            #endif 
            break;
        case MMI_ALERT_CNFM_OK:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_YES:
            break;
        case MMI_ALERT_CNFM_NO:
            // handle softkey event here
            break;
        }
    }
    return MMI_RET_OK;
}

#ifndef __MMI_FTE_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_msg_before_exit_write_msg
 * DESCRIPTION
 *  Go back function from write msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_msg_before_exit_write_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_group_id();
    if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
    {
     #if (MMI_MAX_SIM_NUM >=2)
        mmi_uc_pre_entry_sim_option();
    #else 
        mmi_uc_process_save();
    #endif 
    }
    else
    {
        mmi_confirm_property_struct arg;

        mmi_uc_set_group_id();
	    mmi_confirm_property_init(&arg, CNFM_TYPE_USER_DEFINE);
	    arg.softkey[0].str = (WCHAR *)(get_string(STR_GLOBAL_YES));
	    arg.callback = (mmi_proc_func)mmi_uc_save_msg_confirm_popup_group_proc;
	    arg.parent_id = g_uc_p->main.uc_cui_gid;
	    mmi_confirm_display((WCHAR *)(get_string(STR_UC_STORAGE_FULL_MSG_CONTENT_LOSS_ID)), MMI_EVENT_QUERY, &arg);
    }
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_entry_option
 * DESCRIPTION
 *  Pre-entry function of unified composer option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_entry_option(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_exit_write_msg();
    /* srv_uc_update_msg_size(g_uc_p->main.instance); */
    if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
    {
        srv_uc_update_msg_size(g_uc_p->main.instance);
        mmi_uc_entry_option();
    }
    else
    {
        if (g_uc_p->srv_main->current_text_file_save_result == FS_DISK_FULL)
        {
            mmi_popup_display((WCHAR*)(get_string(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
        else
        {
            mmi_popup_display((WCHAR*)(get_string(srv_fmgr_fs_error_get_string(g_uc_p->srv_main->current_text_file_save_result))), MMI_EVENT_FAILURE, NULL);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_done_delete_history_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  in_param        [?]     [?]
 * RETURNS
 *  U8
 *****************************************************************************/
U8 mmi_uc_done_delete_history_hdlr(void *in_param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD || g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
    {
        MMI_TRACE(
            MMI_COMMON_TRC_G6_MSG,
            TRC_MMI_UC_DONE_DELETE_HISTORY_HDLR_P2,
            g_uc_p->srv_send_info->action,
            g_uc_p->srv_main->state);

        MMI_ASSERT(mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG) != MMI_TRUE);
		if(!(mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG) != MMI_TRUE))
		{
		MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
		}
        if (g_uc_p->srv_send_info->action == SRV_UC_ACTION_IDLE)
        {
            mmi_uc_reset_msg();
        }
        else
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DONE_DELETE_HISTORY_HDLR_DO_NOTHING);
            /* Disable following actions in mmi_uc_action_fsm() */
            /* g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE; */
        }
    }
    return FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_goback_to_option_done
 * DESCRIPTION
 *  goback to option done screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_goback_to_option_done(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    {
        U16 next_scrn_id = 0, top_scrn_id = 0;
        top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
        next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
        mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_input_method_and_done_go_back_to_option
 * DESCRIPTION
 *  Control return to subject editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_input_method_and_done_go_back_to_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
    U16 temp_subject[MMI_UC_MAX_SUBJECT_LEN + 1] = {0, };
    MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((S8*) g_uc_p->srv_msg->subject) > 0)
    {
        memcpy(temp_subject, g_uc_p->srv_msg->subject, sizeof(U16) * (MMI_UC_MAX_SUBJECT_LEN + 1));
    }
    if (g_uc_p->srv_msg->temp_subject)
    {
        memcpy(g_uc_p->srv_msg->subject, g_uc_p->srv_msg->temp_subject, sizeof(U16) * (MMI_UC_MAX_SUBJECT_LEN + 1));
		/*copy in utf8 format here for MMA*/
		
		if(g_uc_p->srv_msg->msg_header.subject.text)
		{
			kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_msg->msg_header.subject.text);
		}
		g_uc_p->srv_msg->msg_header.subject.text  = (char *)kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(U16) * (SRV_UC_MAX_SUBJECT_ARRAY_LEN + 1));
		memset(g_uc_p->srv_msg->msg_header.subject.text , 0 , sizeof(U16) * (SRV_UC_MAX_SUBJECT_ARRAY_LEN + 1));
		mmi_chset_ucs2_to_utf8_string((U8 *)g_uc_p->srv_msg->msg_header.subject.text,(sizeof(U16) * (SRV_UC_MAX_SUBJECT_ARRAY_LEN + 1)),(U8 *)g_uc_p->srv_msg->subject);
        
		OslMfree(g_uc_p->srv_msg->temp_subject);
        g_uc_p->srv_msg->temp_subject = NULL;
    }

    if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER &&
        (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD || g_uc_p->srv_main->state == MMI_UC_STATE_SEND))
    {
        g_uc_p->srv_msg->msg_size = mma_uc_calc_header_size(
                                        g_uc_p->srv_msg,
                                        srv_uc_get_mms_type(g_uc_p->main.instance)) + g_uc_p->srv_msg->msg_body_size;
    }
    else
    {
        g_uc_p->srv_msg->msg_size = mma_uc_calc_msg_size(g_uc_p->srv_msg, srv_uc_get_mms_type(g_uc_p->main.instance));

    }

    if (srv_uc_check_if_exceed_MMS_size_limitation
        (g_uc_p->main.instance, g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
    {
        memcpy(g_uc_p->srv_msg->subject, temp_subject, sizeof(U16) * (MMI_UC_MAX_SUBJECT_LEN + 1));
		
		if(g_uc_p->srv_msg->msg_header.subject.text)
		{
			kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_msg->msg_header.subject.text);
		}
		g_uc_p->srv_msg->msg_header.subject.text  = (char *)kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(U16) * (SRV_UC_MAX_SUBJECT_ARRAY_LEN + 1));
		memset(g_uc_p->srv_msg->msg_header.subject.text , 0 , sizeof(U16) * (SRV_UC_MAX_SUBJECT_ARRAY_LEN + 1));
		mmi_chset_ucs2_to_utf8_string((U8 *)g_uc_p->srv_msg->msg_header.subject.text,(sizeof(U16) * (SRV_UC_MAX_SUBJECT_ARRAY_LEN + 1)),(U8 *)g_uc_p->srv_msg->subject);

        srv_uc_update_msg_size(g_uc_p->main.instance);
        if (g_uc_p->srv_msg->temp_subject)
        {
            OslMfree(g_uc_p->srv_msg->temp_subject);
            g_uc_p->srv_msg->temp_subject = NULL;
        }
        (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
            mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
        mmi_frm_group_close(g_uc_p->main.editor_cui_id);
        mmi_uc_set_group_id();
    }
    else
    {
        srv_uc_update_msg_size(g_uc_p->main.instance);
        mmi_frm_group_close(g_uc_p->main.editor_cui_id);
        mmi_uc_set_group_id();
        if (mmi_uc_change_msg_type_if_needed())
        {
            pass_sig_check = mmi_uc_insert_signature_check();
        }

        if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
        {
            mmi_uc_sig_setSoftkeyFunction(
                mmi_uc_process_warning_mode_insert_signature,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
            mmi_uc_entry_sig_displayConfirm_generic();
        }
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_restore_subject_after_back_from_edit_subject
 * DESCRIPTION
 *  Back key functionality of editing subject field
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_restore_subject_after_back_from_edit_subject(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_msg->temp_subject)
    {
        OslMfree(g_uc_p->srv_msg->temp_subject);
        g_uc_p->srv_msg->temp_subject = NULL;
    }
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SUBJECT_EDITOR);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_back_to_edit
 * DESCRIPTION
 *  Process back to editor
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_back_to_edit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;

    if (g_uc_p->srv_send_info->new_msg_id)
    {
        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_MMS_PREFER);
    }

    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        {
            U16 next_scrn_id = 0, top_scrn_id = 0;
            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
        }
    }
    else
    {
        MMI_ASSERT(0);
    }
}

#ifdef __MMS_SIZE_CONFIRM_BEFORE_SEND__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
            #if (defined(__OP01__) && defined(__MMI_DUAL_SIM_MASTER__))
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                           #if (MMI_MAX_SIM_NUM >=2)
/* under construction !*/
/* under construction !*/
                          #else      
/* under construction !*/
                          #endif 
/* under construction !*/
            #else
             #if (MMI_MAX_SIM_NUM >=2)
/* under construction !*/
/* under construction !*/
            #else      
/* under construction !*/
            #endif 
           #endif
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
             #if (MMI_MAX_SIM_NUM >=2)
/* under construction !*/
/* under construction !*/
            #else      
/* under construction !*/
            #endif 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* __MMS_SIZE_CONFIRM_BEFORE_SEND__ */ 

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_send
 * DESCRIPTION
 *  Process Send msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_group_id();

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    mmi_uc_remove_empty_recipients();
    if(!mmi_uc_get_recipient_list())
    {
		g_uc_p->main.operation = NULL;
		if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID)
		{
        g_uc_p->main.operation = mmi_uc_process_send;
		}
        return;
    }

    if (g_uc_p->main.phb_search_name_flag)
    {
        mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
        g_uc_p->main.phb_search_name_flag = 0;
        mmi_uc_disply_msg_type_change();
        pass_sig_check = mmi_uc_insert_signature_check();
        if(MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
        {
            mmi_uc_sig_setSoftkeyFunction(
                mmi_uc_process_warning_mode_insert_signature_to_send,
                mmi_uc_process_warning_mode_insert_signature_to_send_back,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
            mmi_uc_entry_sig_displayConfirm_generic();
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_send,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SEND_CONT_ID);
            return;
        }
        else
        {
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_send,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SEND_CONT_ID);
            mmi_uc_entry_displayConfirm_generic();
            return;
        }
    }
    else if(g_uc_p->main.phb_max_recipient_flag)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
        g_uc_p->main.phb_max_recipient_flag = 0;
        return;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode != MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
#endif 
    {
    #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        srv_uc_addr_struct *addr = NULL;

        addr = srv_uc_copy_address(g_uc_p->main.instance, mmi_uc_get_highlighted_addr());
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        srv_uc_remove_duplicate_entries(g_uc_p->main.instance);
    #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        g_uc_p->done.current_addr_index = srv_uc_get_highlighted_index(g_uc_p->main.instance, addr)
            + MMI_UC_ADD_RECIPIENT_TOTAL - mmi_uc_get_number_of_options_omitted();
        srv_uc_free_addr_memory(g_uc_p->main.instance, addr);
        addr = NULL;
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        srv_uc_update_msg_size(g_uc_p->main.instance);
    }

    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
    {
    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
        if (g_uc_p->srv_msg->to_num == 0)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_PLS_ADD_RECIPIENT_ID)), MMI_EVENT_ERROR, NULL);
         #if (MMI_MAX_SIM_NUM >=2)
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIM_OPT);
        #endif 
        #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT);
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        }
    #ifdef __MMI_MMS_2__
        else if (MMI_FALSE == srv_uc_check_number_length_for_sms_in_send_case(g_uc_p->main.instance))
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NUMBER_LENGTH_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
         #if (MMI_MAX_SIM_NUM >=2)
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIM_OPT);
        #endif 
        }
    #endif /* __MMI_MMS_2__ */ /* #ifdef __MMI_MMS_2__ */
        else
        {
        #ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
            MMI_BOOL is_send_save = (MMI_BOOL)0;

         #if (MMI_MAX_SIM_NUM >=2)
            if (g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM2)
            {
                is_send_save = srv_sms_is_save_sent_sms_setting(SRV_SMS_SIM_2);
            }
            #if (MMI_MAX_SIM_NUM >= 3)                     
			else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM3)
			{
			is_send_save = srv_sms_is_save_sent_sms_setting(SRV_SMS_SIM_3);
			}
            #if (MMI_MAX_SIM_NUM == 4)                     
			else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM4)
			{
			is_send_save = srv_sms_is_save_sent_sms_setting(SRV_SMS_SIM_4);
			}
            #endif
            #endif
            else
        #endif /*  #if (MMI_MAX_SIM_NUM >=2) */ 
            {
                is_send_save = srv_sms_is_save_sent_sms_setting(SRV_SMS_SIM_1);
            }
            if (is_send_save == MMI_TRUE)
            {
                g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND_AND_SAVE;
            }
            else
        #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
            {
                g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND;
            }
            g_uc_p->srv_send_info->curr_send_number = 0;
            mmi_uc_send_sms();
        }
    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
        ASSERT(0);
    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
    }
    else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
    {
        if (g_uc_p->srv_msg->to_num == 0)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_PLS_ADD_RECIPIENT_ID)), MMI_EVENT_ERROR, NULL);
         #if (MMI_MAX_SIM_NUM >=2)
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIM_OPT);
        #endif 
        #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT);
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        }
    #ifdef __MMI_MMS_POSTCARD__
        else if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS &&
                 srv_postcard_get_total_recipient_count(g_uc_p->main.instance) == 0)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_PLS_ADD_RECIPIENT_ID)), MMI_EVENT_ERROR, NULL);
         #if (MMI_MAX_SIM_NUM >=2)
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIM_OPT);
        #endif 
        #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT);
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        }
    #endif /* __MMI_MMS_POSTCARD__ */ 
    #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
        else if (MMA_MAX_WAP_CONN_MSG_SIZE < g_uc_p->srv_msg->msg_size &&
    #ifdef WAP_SUPPORT
                 srv_wap_prof_get_active_profile_connection_type((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) >
                 SRV_WAP_PROF_CONN_TYPE_HTTP)
    #else /* WAP_SUPPORT */ 
                 mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) > BRW_PROF_CONN_TYPE_HTTP)
    #endif /* WAP_SUPPORT */ 
    {
        mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
    }
    #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* WAP_SUPPORT */ 
    else
    {
        if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
        {
            if (g_uc_p->srv_msg->msg_size > mms_get_max_msg_size_in_restricted_mode())
            {
                mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS);
                g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                return;
            }
        }
        /* required as edit allowed on big MMS also. */
        if (g_uc_p->srv_mms_info->max_mms_size < g_uc_p->srv_msg->msg_size)
        {
            mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
            return;
        }
    #if (defined(__MMI_MMS_2__) || defined(__MMI_MMS_BGSR_SUPPORT__))
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND_IN_BACKGROUND;
    #else 
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND;
    #endif 

    #ifdef __MMI_MMS_POSTCARD__
        g_uc_p->srv_send_info->curr_send_number = 0;
    #endif 
        mmi_uc_create_mms_lemei();
    }
    }
    else
    {
        MMI_ASSERT(0);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_send_and_save
 * DESCRIPTION
 *  Process Send msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_send_and_save(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* If background sending is enable for sms, this case should not happen */
    mmi_uc_set_group_id();
    
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    mmi_uc_remove_empty_recipients();
    if(!mmi_uc_get_recipient_list())
    {
        g_uc_p->main.operation = NULL;
		if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID)
		{      
        g_uc_p->main.operation = mmi_uc_process_send_and_save;
		}
        return;
    }

    if (g_uc_p->main.phb_search_name_flag)
    {
        mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
        g_uc_p->main.phb_search_name_flag = 0;
        mmi_uc_disply_msg_type_change();
        pass_sig_check = mmi_uc_insert_signature_check();
        if(MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
        {
            mmi_uc_sig_setSoftkeyFunction(
                mmi_uc_process_warning_mode_insert_signature_to_send,
                mmi_uc_process_warning_mode_insert_signature_to_send_back,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
            mmi_uc_entry_sig_displayConfirm_generic();
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_send_and_save,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SEND_CONT_ID);
            return;
        }
        else
        {
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_send_and_save,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SEND_CONT_ID);
            mmi_uc_entry_displayConfirm_generic();
            return;
        }
    }
    else if(g_uc_p->main.phb_max_recipient_flag)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
        g_uc_p->main.phb_max_recipient_flag = 0;
        return;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
    {
        MMI_ASSERT(0);
    }
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 

    /* If background sending is enable for mms, this case should not happen */
#if defined(__MMI_MMS_BGSR_SUPPORT__)
    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
    {
        MMI_ASSERT(0);
    }
#endif /* defined(__MMI_MMS_BGSR_SUPPORT__) */ 
    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
    {
    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
        if (g_uc_p->srv_msg->to_num == 0)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NO_RECIPIENT_ID)), MMI_EVENT_ERROR, NULL);
         #if (MMI_MAX_SIM_NUM >=2)
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIM_OPT);
        #endif 
        }
    #ifdef __MMI_MMS_2__
        else if (MMI_FALSE == srv_uc_check_number_length_for_sms_in_send_case(g_uc_p->main.instance))
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NUMBER_LENGTH_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
         #if (MMI_MAX_SIM_NUM >=2)
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIM_OPT);
        #endif 
        }
    #endif /* __MMI_MMS_2__ */ /* #ifdef __MMI_MMS_2__ */
        else
        {
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND_AND_SAVE;
            g_uc_p->srv_send_info->curr_send_number = 0;
            mmi_uc_send_sms();
        }
    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
        ASSERT(0);
    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
    }
    else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
    {
        if (g_uc_p->srv_msg->to_num == 0)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NO_RECIPIENT_ID)), MMI_EVENT_ERROR, NULL);
        }
    #if (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__))
        else if (MMA_MAX_WAP_CONN_MSG_SIZE < g_uc_p->srv_msg->msg_size &&
    #ifdef WAP_SUPPORT
                 srv_wap_prof_get_active_profile_connection_type((srv_wap_prof_app_id_enum) SRV_WAP_PROF_APPID_MMS) >
                 SRV_WAP_PROF_CONN_TYPE_HTTP)
    #else /* WAP_SUPPORT */ 
                 mmi_brw_prof_get_activated_profile_connection_type(BRW_PROF_MMS_PROFILE) > BRW_PROF_CONN_TYPE_HTTP)
    #endif /* WAP_SUPPORT */ 
    {
        mmi_uc_display_popup(SRV_UC_WAP_CONN_MAX_MSG_SIZE_REACHED);
    }
    #endif /* (defined (__MMI_UC_WAP_CONNECTION_MAX_SIZE_CHECK_SUPPORT__) && defined (__MMI_OP12_MMS_MAX_SIZE_SUPPORT__)) */ 
        else
        {
            if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
            {
                if (g_uc_p->srv_msg->msg_size > mms_get_max_msg_size_in_restricted_mode())
                {
                    mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS);
                    g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                    return;
                }
            }
            /* required as edit allowed on big MMS also. */
            if (g_uc_p->srv_mms_info->max_mms_size < g_uc_p->srv_msg->msg_size)
            {
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                return;
            }
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_SEND_AND_SAVE;
        #ifdef __MMI_MMS_POSTCARD__
            g_uc_p->srv_send_info->curr_send_number = 0;
        #endif 
            mmi_uc_create_mms();
        }
    }
    else
    {
        MMI_ASSERT(0);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_save
 * DESCRIPTION
 *  Process Save msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_save(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_um_msg_box_enum msg_box = mmi_uc_get_current_msg_box_type(g_uc_p->srv_send_info->existed_msg_id);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_group_id();

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if(!mmi_uc_get_recipient_list())
    {
        g_uc_p->main.operation = NULL;
		if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID)
		{
        g_uc_p->main.operation = mmi_uc_process_save;
		}
        return;
    }

    if (g_uc_p->main.phb_search_name_flag)
    {
        mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
        g_uc_p->main.phb_search_name_flag = 0;
        mmi_uc_disply_msg_type_change();
        pass_sig_check = mmi_uc_insert_signature_check();
        if(MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
        {
            mmi_uc_sig_setSoftkeyFunction(
                mmi_uc_process_warning_mode_insert_signature_to_send,
                mmi_uc_process_warning_mode_insert_signature_to_send_back,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
            mmi_uc_entry_sig_displayConfirm_generic();
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_save,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SAVE_CONT_ID);
            return;
        }
        else
        {
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_save,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SAVE_CONT_ID);
            mmi_uc_entry_displayConfirm_generic();
            return;
        }
    }
    else if(g_uc_p->main.phb_max_recipient_flag)
    {
        g_uc_p->main.phb_max_recipient_flag = 0;
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
            return;
        }
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#ifdef __MMI_MMS_2__
    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
    {
    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
        if (g_uc_p->srv_msg->to_num > 0)
        {
            if (MMI_FALSE == srv_uc_check_number_length_for_sms(g_uc_p->main.instance))
            {
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_NUMBER_LENGTH_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
             #if (MMI_MAX_SIM_NUM >=2)
                mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIM_OPT);
            #endif 
                return;
            }
        }
    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
        ASSERT(0);
    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
    }
#endif /* __MMI_MMS_2__ */ /* #ifdef __MMI_MMS_2__ */

    g_uc_p->srv_send_info->action = SRV_UC_ACTION_SAVE;
    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
    {

    #if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
        if (msg_box == SRV_UM_MSG_BOX_DRAFT)
        {
            mmi_uc_set_processing_screen(0, STR_GLOBAL_SAVING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

            mmi_uc_entry_processing_generic();

            /* save msg from SMS to SMS. Delete original one and then save new one. (for more free size) */
            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
            {
                srv_sms_delete_msg(
                    (U16) g_uc_p->srv_send_info->existed_msg_id,
                    mmi_uc_delete_sms_callback, 
                    NULL);
            }
            /* save msg from MMS to SMS. Save new one and then delete original one. */
            else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
            {
                mmi_uc_save_sms_req();
            }
            else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_DEFAULT)
            {
                /*
                 * this flow will happen --> when select sms in draft-->use number -->send sms (edit)-->done
                 * -->done->save, in this case, existed_msg_type= MMI_UC_MSG_TYPE_DEFAULT;
                 */
                mmi_uc_save_sms_req();
            }
            else
            {
                MMI_ASSERT(0);
            }

            /* highlighter need to set by UC */
            g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
        }
        else if (msg_box == SRV_UM_MSG_BOX_UNSENT && g_uc_p->srv_msg->to_num > 0)
        {
            mmi_uc_set_processing_screen(0, STR_GLOBAL_SAVING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

            mmi_uc_entry_processing_generic();

            /* save msg from SMS to SMS. Delete original one and then save new one. */
            if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
            {
                srv_sms_delete_msg(
                    (U16) g_uc_p->srv_send_info->existed_msg_id,
                    mmi_uc_delete_sms_callback, 
                    NULL);
            }
            /* save msg from MMS to SMS. Save new one and then delete original one. */
            else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
            {
                mmi_uc_save_sms_req();
            }
            else if (g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_DEFAULT)
            {
                /*
                 * this flow will happen --> when select sms in draft-->use number -->send sms (edit)-->done
                 * -->done->save, in this case, existed_msg_type= MMI_UC_MSG_TYPE_DEFAULT;
                 */
                mmi_uc_save_sms_req();
            }
            else
            {
                MMI_ASSERT(0);
            }

            /* highlighter need to set by UC */
            g_uc_p->send_info.need_highlight_ind_to_um = TRUE;
        }
        else
        {
            mmi_uc_save_sms();
        }
    #else /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
        ASSERT(0);
    #endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 
    }
    else if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
    {
        if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
        {
            if (g_uc_p->srv_msg->msg_size > mms_get_max_msg_size_in_restricted_mode())
            {
                mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS);
                g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
                return;
            }
        }
        /* required as edit allowed on big MMS also. */
        if (g_uc_p->srv_mms_info->max_mms_size < g_uc_p->srv_msg->msg_size)
        {
            mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
            return;
        }
        /* The original mms msg would be deleted after mms creation if it belongs to draft folder */
        mmi_uc_create_mms();
    }
    else
    {
        MMI_ASSERT(0);
    }
}

#if defined(__MMI_MMS_TEMPLATE_SUPPORT__) || defined(__MMI_OBIGO_Q03C_MMS_USER_DEFINED_TEMPLATES__)


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_save_as_template
 * DESCRIPTION
 *  Process Save as template msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_save_as_template(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_group_id();
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if(!mmi_uc_get_recipient_list())
    {
		g_uc_p->main.operation = NULL;
		if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID)
		{
        g_uc_p->main.operation = mmi_uc_process_save_as_template;
		}
        return;
    }

    if (g_uc_p->main.phb_search_name_flag)
    {
        mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
        g_uc_p->main.phb_search_name_flag = 0;
        mmi_uc_disply_msg_type_change();
        pass_sig_check = mmi_uc_insert_signature_check();
        if(MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
        {
            mmi_uc_sig_setSoftkeyFunction(
                mmi_uc_process_warning_mode_insert_signature_to_send,
                mmi_uc_process_warning_mode_insert_signature_to_send_back,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
            mmi_uc_entry_sig_displayConfirm_generic();
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_save_as_template,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SAVE_CONT_ID);
            return;
        }
        else
        {
            mmi_uc_setSoftkeyFunction(
                mmi_uc_process_save_as_template,
                mmi_frm_scrn_close_active_id,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_SAVE_CONT_ID);
            mmi_uc_entry_displayConfirm_generic();
            return;
        }
    }
    else if(g_uc_p->main.phb_max_recipient_flag)
    {
        g_uc_p->main.phb_max_recipient_flag = 0;
        if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
            return;
        }
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

    if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
    {
        if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED)
        {
            if (g_uc_p->srv_msg->msg_size > mms_get_max_msg_size_in_restricted_mode())
            {
                mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS);
                return;
            }
        }
        /* required as edit allowed on big MMS also. */
        if (g_uc_p->srv_mms_info->max_mms_size < g_uc_p->srv_msg->msg_size)
        {
            mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            return;
        }
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_SAVE_AS_TEMPLATE;
        mmi_uc_create_mms();
    }
    else
    {
        MMI_ASSERT(0);
    }

}
#endif /* defined(__MMI_MMS_2__) || defined(__MMI_OBIGO_Q03C_MMS_USER_DEFINED_TEMPLATES__) */ 

#if !defined(__MMI_MMS_STANDALONE_COMPOSER__)


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_sms
 * DESCRIPTION
 *  Send SMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_sms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
#ifndef __MMI_BASIC_UI_STYLE__
    mmi_uc_set_processing_screen(0, STR_GLOBAL_SENDING, IMG_NEW_SMS_SEND, 0);
#else
    mmi_uc_set_processing_screen(0, STR_GLOBAL_SENDING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
#endif
    mmi_uc_entry_processing_generic();
#else /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
    mmi_uc_entry_sending_sms();
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */ 
    /* When backgournd sending is enabled, the api only handles the first step- save */
    mmi_uc_pre_send_sms_req();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_sms
 * DESCRIPTION
 *  Send SMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_sms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_processing_screen(0, STR_GLOBAL_SAVING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

    mmi_uc_entry_processing_generic();
    mmi_uc_save_sms_req();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_sms_req
 * DESCRIPTION
 *  Send SMS msg
 *  Note: if enable background sending, this api only handle "save", not send
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_sms_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    SMS_HANDLE send_handle;
    U8 ucs2_addr[(SRV_SMS_MAX_ADDR_LEN + 1) * ENCODING_LENGTH];
    U16 addr_len;
    U16 i;
    mmi_uc_addr_struct *addr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    send_handle = srv_sms_get_send_handle();

     #if (MMI_MAX_SIM_NUM >=2)
    if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM2)
    {
        srv_sms_set_sim_id(send_handle, SRV_SMS_SIM_2);
    }
    #if (MMI_MAX_SIM_NUM >= 3)
   else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM3)
    {
        srv_sms_set_sim_id(send_handle, SRV_SMS_SIM_3);
    }
   #if (MMI_MAX_SIM_NUM == 4)
   else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM4)
    {
        srv_sms_set_sim_id(send_handle, SRV_SMS_SIM_4);
    }
#endif
#endif
#endif /* __MMI_DUAL_SIM_MASTER__ */

#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    srv_sms_set_send_type(send_handle, SRV_SMS_BG_SAVE_SEND);
#else
    srv_sms_set_send_type(send_handle, SRV_SMS_FG_SEND);
#endif   

    addr = g_uc_p->srv_msg->to_head;
    for (i = 0; i < g_uc_p->srv_send_info->curr_send_number; i++)
    {
        addr = addr->next;
    }
    addr_len = mmi_asc_n_to_ucs2((S8*)ucs2_addr, (S8*)addr->addr, SRV_SMS_MAX_ADDR_LEN);
    ucs2_addr[addr_len] = '\0';
    ucs2_addr[addr_len + 1] = '\0';
    srv_sms_set_address(send_handle, (S8*)ucs2_addr);

    if (g_uc_p->srv_main->state == MMI_UC_STATE_REPLY &&
        g_uc_p->srv_send_info->existed_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER &&
        !g_uc_p->send_info.change_in_recipient_list)
    {
        srv_sms_set_reply_msg_id(send_handle, g_uc_p->srv_send_info->existed_msg_id);
    }

    if (g_uc_p->srv_send_info->curr_send_number + 1 < g_uc_p->srv_msg->to_num)
    {
        srv_sms_set_mms(send_handle, MMI_TRUE);
    }
    else
    {
        srv_sms_set_mms(send_handle, MMI_FALSE);
    }

    srv_sms_set_content(send_handle, (S8*)g_uc_p->srv_main->text_buffer, g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count * ENCODING_LENGTH);

    g_uc_p->main.send_handle = send_handle;

    srv_sms_send_msg(send_handle, mmi_uc_send_sms_rsp, NULL);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_sms_req
 * DESCRIPTION
 *  Send SMS msg
 * Note: if enable background sending, this api only handle "save", not send
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_sms_edit_sc_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //mma_mms_addr_list_struct* addr;
 #if (MMI_MAX_SIM_NUM >=2)
    srv_sms_sim_enum sim_id;
#endif /*  #if (MMI_MAX_SIM_NUM >=2) */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_create(GRP_ID_ROOT, APP_UNIFIEDCOMPOSER, mmi_uc_cui_event_handler_group_proc, 0);
    mmi_frm_group_enter(APP_UNIFIEDCOMPOSER, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    g_uc_p->main.sms_cui_gid = cui_sms_send_create(APP_UNIFIEDCOMPOSER);

    if(g_uc_p->main.sms_cui_gid != GRP_ID_INVALID)
    {
        mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);

        if(g_uc_p->srv_msg->to_head)
        {
            U8 addr_list[CUI_SMS_MAX_RECIPIENTS_NUM][(SRV_SMS_MAX_ADDR_LEN + 1) * ENCODING_LENGTH];
            U8 asc_num[SRV_SMS_MAX_ADDR_LEN + 1];
            U16 addr_len;
            asc_num[0] = '1';
            asc_num[1] = '1';
            asc_num[2] = '\0';
            addr_len = mmi_asc_n_to_ucs2((S8*)addr_list[0], (S8*)asc_num, SRV_SMS_MAX_ADDR_LEN);
            addr_list[0][addr_len] = '\0';
            addr_list[0][addr_len + 1] = '\0';

            cui_sms_set_send_address(g_uc_p->main.sms_cui_gid, (U16**)addr_list, 1);
        }

         #if (MMI_MAX_SIM_NUM >=2)
            if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM2)
            {
                sim_id = SRV_SMS_SIM_2;
            }
#if (MMI_MAX_SIM_NUM >=3)
else if (g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM3)
            {
                sim_id = SRV_SMS_SIM_3;
            }
#if (MMI_MAX_SIM_NUM ==4)
else if (g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM4)
            {
                sim_id = SRV_SMS_SIM_4;
            }
#endif
#endif
            else
            {
                sim_id = SRV_SMS_SIM_1;
            }
            cui_sms_set_send_sim_id(g_uc_p->main.sms_cui_gid, sim_id); 
        #endif /*  #if (MMI_MAX_SIM_NUM >=2) */

        cui_sms_send_run(g_uc_p->main.sms_cui_gid);
    }
    else
    {
        mmi_frm_group_close(APP_UNIFIEDCOMPOSER);
    }
    g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    mmi_uc_delete_screen(SCR_ID_UC_PROCESSING);
#else
    mmi_uc_delete_screen(SCR_ID_UC_SENDING);
#endif
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_pre_send_sms_req
 * DESCRIPTION
 *  Send SMS msg
 * Note: if enable background sending, this api only handle "save", not send
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_pre_send_sms_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_sms_setting_struct default_setting;
    S8 *sc_number;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef GUI_EDITOR_SHOW_TITLE
    mmi_uc_send_sms_req();
#else
 #if (MMI_MAX_SIM_NUM >=2)
    if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM2)
    {
        memcpy(&default_setting, srv_sms_get_default_setting(SRV_SMS_SIM_2), sizeof(srv_sms_setting_struct));
    }
#if (MMI_MAX_SIM_NUM >= 3)
	else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM3)
		{
        memcpy(&default_setting, srv_sms_get_default_setting(SRV_SMS_SIM_3), sizeof(srv_sms_setting_struct));
        }
#if (MMI_MAX_SIM_NUM == 4)
	else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM4)
		{
        memcpy(&default_setting, srv_sms_get_default_setting(SRV_SMS_SIM_4), sizeof(srv_sms_setting_struct));
        }
#endif
#endif
    else
#endif /*  #if (MMI_MAX_SIM_NUM >=2) */
    {
        memcpy(&default_setting, srv_sms_get_default_setting(SRV_SMS_SIM_1), sizeof(srv_sms_setting_struct));
    }

    sc_number = default_setting.sc_addr;

    if (sc_number[0] == '\0')
    {
        mmi_uc_send_sms_edit_sc_req();
    }
    else
    {
        mmi_uc_send_sms_req();
    }
#endif /* GUI_EDITOR_SHOW_TITLE */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_sms_rsp
 * DESCRIPTION
 *  Send SMS msg response
 * PARAMETERS
 *  number      [?]         
 *  mod         [IN]        
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_sms_rsp(srv_sms_callback_struct* callback_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = callback_data->result;
    U32 cause = (U32)callback_data->cause;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* When background sending is enabled, rsp ok just means first step(save) ok */
    if (result == MMI_TRUE)
    {
        cause = SRV_SMS_CAUSE_NO_ERROR;
    }
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (cause != SRV_SMS_CAUSE_SEND_ABORT)
#else
    if (result == MMI_TRUE)
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    {
        g_uc_p->srv_send_info->curr_send_number++;
        if (g_uc_p->srv_send_info->curr_send_number < g_uc_p->srv_msg->to_num)
        {
            mmi_uc_send_sms_req();
            return;
        }
    }

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if (result != MMI_TRUE && cause != SRV_SMS_CAUSE_SEND_ABORT)
	{
		g_uc_p->srv_send_info->curr_send_number--;
	}
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

    g_uc_p->send_info.send_result = cause;

    mmi_uc_action_fsm(SRV_UC_ACTION_SEND, cause);

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_sms_req
 * DESCRIPTION
 *  save SMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_sms_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    SMS_HANDLE save_handle;
    //mma_mms_addr_list_struct* addr;
    //U8 *handled_buffer = NULL;
    //U16 handled_buffer_size = 0;
 #if (MMI_MAX_SIM_NUM >=2)
    //srv_sms_sim_enum sim_id;
#endif /*  #if (MMI_MAX_SIM_NUM >=2) */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    save_handle = srv_sms_get_save_handle();

    mmi_uc_clear_msg_bearer(MMI_UC_MSG_TYPE_SMS_PREFER);

  #if (MMI_MAX_SIM_NUM >=2)
    if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM2)
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_2);
    }
    #if (MMI_MAX_SIM_NUM >= 3)
	else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM3)
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_3);
    }
    #if (MMI_MAX_SIM_NUM == 4)
	else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM4)
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_4);
    }
#endif
#endif
    else
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_1);
    }
#endif /*  #if (MMI_MAX_SIM_NUM >=2) */

    if(g_uc_p->srv_msg->to_head)
    {
        U8 addr[(SRV_SMS_MAX_ADDR_LEN + 1) * ENCODING_LENGTH];
        U16 addr_len;
   
        addr_len = mmi_asc_n_to_ucs2((S8*)addr, (S8*)g_uc_p->srv_msg->to_head->addr, SRV_SMS_MAX_ADDR_LEN);
        addr[addr_len] = '\0';
        addr[addr_len + 1] = '\0';
   
        srv_sms_set_address(save_handle, (S8*)addr);
    }
   /* Not handled yet
       sendData->status = SMSAL_STO_DRAFT; protocol support. save to draft*/

    srv_sms_set_status(save_handle, SRV_SMS_STATUS_DRAFT);

    srv_sms_set_content(save_handle, (S8*)g_uc_p->srv_main->text_buffer, g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count * ENCODING_LENGTH);

    srv_sms_save_msg(save_handle, mmi_uc_save_sms_rsp, NULL);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_convert_sms_folder_to_um_folder
 * DESCRIPTION
 *  
 * PARAMETERS
 *  folder_id       [IN]        
 *  folderID(?)     [IN]        
 * RETURNS
 *  
 *****************************************************************************/
srv_um_msg_box_enum mmi_uc_convert_sms_folder_to_um_folder(srv_sms_status_enum folder_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (folder_id)
    {
        case SRV_SMS_STATUS_UNSENT:
            return SRV_UM_MSG_BOX_UNSENT;

        case SRV_SMS_STATUS_SENT:
            return SRV_UM_MSG_BOX_SENT;

        case SRV_SMS_STATUS_DRAFT:
        default:
            return SRV_UM_MSG_BOX_DRAFT;
    }
    //return SRV_UM_MSG_BOX_DRAFT;   /* most of the cases only Draft is used */
}

#if !defined(__MMI_MMS_STANDALONE_COMPOSER__)


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_sms_after_send
 * DESCRIPTION
 *  Save sms after send
 * PARAMETERS
 *  status      [IN]        
 *  number      [?]         
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_sms_after_send(U8 status, void *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    SMS_HANDLE save_handle;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    save_handle = srv_sms_get_save_handle();

 #if (MMI_MAX_SIM_NUM >=2)
    if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM2)
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_2);
    }
#if (MMI_MAX_SIM_NUM >=3)
    else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM3)
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_3);
    }
#if (MMI_MAX_SIM_NUM ==4)
    else if(g_uc_p->srv_send_info->send_sim_id == UC_SIM_ID_GSM_SIM4)
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_4);
    }
#endif
#endif
    else
    {
        srv_sms_set_sim_id(save_handle, SRV_SMS_SIM_1);
    }
#endif /*  #if (MMI_MAX_SIM_NUM >=2) */

    if(number)
    {
        S8 addr[(SRV_SMS_MAX_ADDR_LEN + 1) *ENCODING_LENGTH];
        U16 addr_len;

        addr_len = mmi_asc_n_to_ucs2((S8*)addr, (S8*)number, SRV_SMS_MAX_ADDR_LEN);
        addr[addr_len] = '\0';
        addr[addr_len + 1] = '\0';

        srv_sms_set_address(save_handle, (S8*)addr);
    }

    srv_sms_set_status(save_handle, (srv_sms_status_enum)status);

    srv_sms_set_content(save_handle, (S8*)g_uc_p->srv_main->text_buffer, g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count * ENCODING_LENGTH);

    g_uc_p->main.save_handle = save_handle;

    srv_sms_save_msg(save_handle, mmi_uc_save_sms_rsp, NULL);
}
#endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_sms_rsp
 * DESCRIPTION
 *  Save SMS msg response
 * PARAMETERS
 *  status      [?]         
 *  mod         [IN]        
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_sms_rsp(srv_sms_callback_struct* callback_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 *msg_id = (U16*)callback_data->action_data;
    MMI_BOOL result = callback_data->result;
    U32 cause = (U32)callback_data->cause;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (result == MMI_TRUE)
    {
        cause = SRV_SMS_CAUSE_NO_ERROR;
    }

    if(result == MMI_TRUE)
    {
        if (g_uc_p->send_info.need_highlight_ind_to_um == TRUE)
        {
            mmi_um_highlight_msg_ind(SRV_UM_MSG_SMS, mmi_msg_get_um_type_by_msgid(*msg_id), *msg_id);
            g_uc_p->send_info.need_highlight_ind_to_um = FALSE;
        }
        srv_uc_send_um_msg_refresh_ind(g_uc_p->main.instance, mmi_msg_get_um_type_by_msgid(*msg_id), SRV_UM_MSG_SMS);
    }

    g_uc_p->send_info.save_result = cause;
    mmi_uc_action_fsm(SRV_UC_ACTION_SAVE, cause);

    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_sms_callback
 * DESCRIPTION
 *  Delete SMS msg response
 * PARAMETERS
 *  dummy       [?]         
 *  mod         [IN]        
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_delete_sms_callback(srv_sms_callback_struct* callback_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_action_fsm(SRV_UC_ACTION_DELETE, (U32)callback_data->cause);
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    mmi_msg_update_unsent_icon();
#endif 
    srv_uc_send_um_msg_refresh_ind(
        g_uc_p->main.instance,
        SRV_UM_MSG_BOX_DRAFT,
        SRV_UM_MSG_SMS);
    srv_uc_send_um_msg_refresh_ind(
        g_uc_p->main.instance,
        SRV_UM_MSG_BOX_UNSENT,
        SRV_UM_MSG_SMS);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_abort_send_sms
 * DESCRIPTION
 *  Abort sending SMS by RSK
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_abort_send_sms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->send_info.abort = MMI_UC_ABORT_NORMAL;
    mmi_uc_set_processing_screen(0, STR_GLOBAL_CANCELLING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

    mmi_uc_entry_processing_generic();
    srv_sms_abort_send(g_uc_p->main.send_handle);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_abort_send_sms_by_end_key
 * DESCRIPTION
 *  Abort sending SMS by endkey
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_abort_send_sms_by_end_key(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!(srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_ALL, NULL) > 0))
    {
        g_uc_p->send_info.abort = MMI_UC_ABORT_BY_END_KEY;
        mmi_uc_set_processing_screen(0, STR_GLOBAL_CANCELLING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

        mmi_uc_entry_processing_generic();
        //DeleteUptoScrID(IDLE_SCREEN_ID);
		mmi_uc_set_group_id();
        //srv_sms_clear_send_callback(g_uc_p->main.send_handle);
        srv_sms_abort_send(g_uc_p->main.send_handle);

        ClearInputEventHandler(MMI_DEVICE_ALL);
        ClearKeyHandler(KEY_END, KEY_EVENT_UP);
        ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
        ClearKeyHandler(KEY_END, KEY_LONG_PRESS);
        ClearKeyHandler(KEY_END, KEY_REPEAT);
    }
    
}
#endif /* !defined(__MMI_MMS_STANDALONE_COMPOSER__) */ 

#ifdef __MMI_CLAMSHELL__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_clam_shell_close_handling
 * DESCRIPTION
 *  hanlde clamclose event and close UC
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_clam_shell_close_handling(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_uc_is_uc_screen_in_history())
	{
         
		return mmi_uc_on_clam_force_close(evt);
    }
	return MMI_RET_OK;
}
mmi_ret mmi_uc_on_clam_force_close(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (srv_bootup_is_booting())
    {
        /* No data account screen yet */
        return MMI_RET_OK;
    }
    if ((g_uc_p->main.uc_cui_gid != 0) )
    {
        #ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
            if(g_uc_p && g_uc_p->srv_msg_type && (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER) && 
                g_uc_p->send_info.abort != MMI_UC_ABORT_BY_END_KEY && 
                g_uc_p->srv_send_info && (g_uc_p->srv_send_info->action == SRV_UC_ACTION_SEND_AND_SAVE ||
                g_uc_p->srv_send_info->action == SRV_UC_ACTION_SEND))
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_USB_MS_PLUG_IN_HDLR_FG_SEND_CNCL);
                srv_sms_clear_send_callback(g_uc_p->main.send_handle);
                srv_sms_abort_send(g_uc_p->main.send_handle);
                mmi_uc_reset_msg();
                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
		        return MMI_RET_OK;
            }
        #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
            mmi_uc_reset_msg();
    }
    return MMI_RET_OK;
}
#endif /*__MMI_CLAMSHELL__*/


//#ifdef __MMI_OP02_LEMEI__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_create_mms_handler
 * DESCRIPTION
 *  create mms handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_create_mms_handler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
   // S32 result = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	#ifdef __MMI_OP02_LEMEI__
    srv_uc_MMS_edit_mode_enum pre_value; 
	pre_value =g_uc_p->srv_msg_type->MMS_edit_mode;
    #endif
//	result = srv_uc_create_mms_xml_description_file(g_uc_p->main.instance);
	#ifdef __MMI_OP02_LEMEI__

	if(pre_value == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
	{
	g_uc_p->srv_msg_type->MMS_edit_mode=MMI_UC_MMS_EDIT_MODE_LEMEI_MMS;
	}
    #endif
    if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
    {
        mmi_uc_create_mms_req();
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_CREATE_MMS_XML_DESC_FILE_P1, g_uc_p->srv_main->current_text_file_save_result);
        if (g_uc_p->srv_main->current_text_file_save_result == FS_DISK_FULL)
        {
            mmi_popup_display((WCHAR*)(get_string(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
        else
        {
            mmi_popup_display((WCHAR*)(get_string(srv_fmgr_fs_error_get_string(g_uc_p->srv_main->current_text_file_save_result))), MMI_EVENT_FAILURE, NULL);
        }

        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_MSG_PREVIEW);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);	

        /* reset state */
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
    }

}

//#endif

void mmi_uc_create_mms_handler_lemei(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
   // S32 result = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
   #ifdef __MMI_MMS_INSERT_SENDER_ADDR_FROM_SIM__
	srv_uc_get_owner_num(g_uc_p->main.instance,
		#if(MMI_MAX_SIM_NUM >=2)
			mmi_uc_get_owner_number(g_uc_p->srv_send_info->send_sim_id));
		#else
			mmi_uc_get_owner_number(SRV_UC_SIM_ID_GSM_SIM1));
		#endif
   #endif	
//   result = srv_uc_create_mms_xml_description_file(g_uc_p->main.instance);

	if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
    {
        mmi_uc_create_mms_req();
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_CREATE_MMS_XML_DESC_FILE_P1, g_uc_p->srv_main->current_text_file_save_result);
        if (g_uc_p->srv_main->current_text_file_save_result == FS_DISK_FULL)
        {
            mmi_popup_display((WCHAR*)(get_string(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
        else
        {
            mmi_popup_display((WCHAR*)(get_string(srv_fmgr_fs_error_get_string(g_uc_p->srv_main->current_text_file_save_result))), MMI_EVENT_FAILURE, NULL);
        }

        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_MSG_PREVIEW);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);	

        /* reset state */
        g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
    }

}

//#ifdef __MMI_OP02_LEMEI__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_create_mms
 * DESCRIPTION
 *  Create MMS xml file
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_create_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
    mmi_uc_entry_processing_generic();

    mmi_uc_create_mms_handler();

}
//#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_create_mms_lemei
 * DESCRIPTION
 *  Create MMS xml file
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_create_mms_lemei(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
    mmi_uc_entry_processing_generic();

    mmi_uc_create_mms_handler_lemei();

}


#if !defined(__MMI_MMS_BGSR_SUPPORT__)


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_mms
 * DESCRIPTION
 *  Send MMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->send_info.percent = 0;
    g_uc_p->send_info.retry = 0;
    mmi_uc_entry_sending_mms();
    mmi_uc_send_mms_req(FALSE, 0);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_send_and_save_mms
 * DESCRIPTION
 *  Send MMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_send_and_save_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if (defined(__MMI_MMS_BGSR_SUPPORT__) || defined(__MMI_MMS_2__))
    MMI_ASSERT(0);  /* if background send, this case will not happen. */
#endif 
#if !defined(__MMI_MMS_BGSR_SUPPORT__)
    g_uc_p->send_info.percent = 0;
    g_uc_p->send_info.retry = 0;
    mmi_uc_entry_sending_mms();
    mmi_uc_send_mms_req(TRUE, 0);
#endif /* !defined(__MMI_MMS_BGSR_SUPPORT__) */ 
}
#endif /* !defined(__MMI_MMS_BGSR_SUPPORT__) */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_mms
 * DESCRIPTION
 *  Send SMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_processing_screen(0, STR_GLOBAL_SAVING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

    mmi_uc_entry_processing_generic();
    mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, MMA_FOLDER_DRAFT);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_save_mms_to_folder
 * DESCRIPTION
 *  Send SMS msg
 * PARAMETERS
 *  msg_box_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_save_mms_to_folder(U16 msg_box_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_set_processing_screen(0, STR_GLOBAL_SAVING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

    mmi_uc_entry_processing_generic();
    mmi_uc_save_mms_req(g_uc_p->srv_send_info->new_msg_id, msg_box_id);
}

#if !defined(__MMI_MMS_BGSR_SUPPORT__)


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_sending_mms
 * DESCRIPTION
 *  Entry function of sending MMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_sending_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_SENDING_FORGROUND_MMS);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_update_sending_mms_percent_and_retry
 * DESCRIPTION
 *  Update percent of sending MMS msg
 * PARAMETERS
 *  percent     [IN]        
 *  retry       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_update_sending_mms_percent_and_retry(U16 percent, U8 retry)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_UPDATE_SENDING_MMS_PERCENT_AND_RETRY_P2, percent, retry);
    g_uc_p->send_info.percent = percent;
    g_uc_p->send_info.retry = retry;
    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_SENDING)
    {
        if (retry > 0)
        {
            const S8 *pstr1;
            S8 *message;
            U32 temp_string_len = 6;    /* temp_string_len - for percentage wording --ex" 100%" */
            U8 temp_string[6];
            U8 temp_ucs2_string[6 * ENCODING_LENGTH];
            int msg_size = 0;

            pstr1 = GetString(STR_UC_RESEND_ID);
            msg_size = (mmi_ucs2strlen(pstr1) + temp_string_len) * ENCODING_LENGTH;

            message = (S8*) OslMalloc(msg_size);
            memset(message, 0, msg_size);

            sprintf((char*)temp_string, " %d%%", percent);
            mmi_asc_n_to_ucs2((S8*) temp_ucs2_string, (S8*) temp_string, temp_string_len);
            mmi_ucs2cpy((PS8) message, (PS8) pstr1);
            mmi_ucs2cat(message, (S8*) temp_ucs2_string);

            UpdateCategory402Value((U16) percent, (PU8) message);
            OslMfree(message);
        }
        else if (retry == 0)
        {
            UpdateCategory402Value((U16) percent, NULL);
        }
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_abort_send_mms
 * DESCRIPTION
 *  Abort sending MMS by RSK
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_abort_send_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->send_info.abort = MMI_UC_ABORT_NORMAL;
    mmi_uc_set_processing_screen(0, STR_GLOBAL_CANCELLING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

    mmi_uc_entry_processing_generic();
    mmi_uc_abort_send_mms_req(g_uc_p->srv_send_info->new_msg_id);
}
#endif /* !defined(__MMI_MMS_BGSR_SUPPORT__) */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_abort_send_mms_by_end_key
 * DESCRIPTION
 *  Abort sending MMS by endkey
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_abort_send_mms_by_end_key(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Abort MMS sending if not in-call or in csd call for MMS over csd case. */
    if ((srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_ALL, NULL) == 0) ||
        (srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CSD_CALL_TYPE_ALL, NULL) > 0))
    {
        g_uc_p->send_info.abort = MMI_UC_ABORT_BY_END_KEY;
        mmi_uc_set_processing_screen(0, STR_GLOBAL_CANCELLING, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);

        mmi_uc_entry_processing_generic();
        //DeleteUptoScrID(IDLE_SCREEN_ID);
		mmi_uc_set_group_id();

        mmi_uc_abort_send_mms_req(g_uc_p->srv_send_info->new_msg_id);

        ClearInputEventHandler(MMI_DEVICE_ALL);
        ClearKeyHandler(KEY_END, KEY_EVENT_UP);
        ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
        ClearKeyHandler(KEY_END, KEY_LONG_PRESS);
        ClearKeyHandler(KEY_END, KEY_REPEAT);
    }
    else
    {
        MMI_ASSERT(0);  /* if fw new end key mechanism works, shouod not possible to enter this path */
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_clear_msg_bearer
 * DESCRIPTION
 *  
 * PARAMETERS
 *  msg_type        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_clear_msg_bearer(mmi_uc_msg_type_enum msg_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msg_type == MMI_UC_MSG_TYPE_DEFAULT || msg_type == MMI_UC_MSG_TYPE_SMS_PREFER)
    {
        ReleaseEMSEditBuffer();
    }

    if (msg_type == MMI_UC_MSG_TYPE_DEFAULT || msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
    {
        /* Delete MMS temp msg ID */
        mmi_uc_delete_mms_req(g_uc_p->srv_send_info->new_msg_id, g_uc_p->send_info.new_msg_storage);
        g_uc_p->srv_send_info->new_msg_id = 0;  /* tricky! */
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_existed_mms
 * DESCRIPTION
 *  Delete existed MMS msg
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_delete_existed_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_main->file_handle > 0)
    {
        FS_Close(g_uc_p->srv_main->file_handle);
        g_uc_p->srv_main->file_handle = 0;
    }
    mmi_uc_delete_mms_req(g_uc_p->srv_send_info->existed_msg_id, g_uc_p->send_info.existed_msg_storage);
}

#ifdef __MMI_PHB_SAVE_CONTACT_NOTIFY__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_phb_save_contact_notify_check
 * DESCRIPTION
 *  Trigger phb save contact notify mechanism if necessary
 * PARAMETERS
 *  type                    [IN]        
 *  result                  [IN]        
 *  checked_screen_id       [IN]        
 * RETURNS
 *  return how many addresses are added(?)
 *****************************************************************************/
void mmi_uc_phb_save_contact_notify_check(srv_uc_phb_list_type_enum type, U32 result, U16 checked_screen_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 final_added_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* should not popup contact notify for postcard sending */
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == SRV_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        return;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 

    if (!mmi_phb_is_save_contact_notify_on())
    {
        return;
    }
    /* No need to trigger contact notify mechanism in some cases */
    switch (type)
    {
    #ifndef __MMI_MMS_STANDALONE_COMPOSER__
        case (SRV_UC_PHB_LIST_TYPE_SMS):
        {
            if ((g_uc_p->srv_msg->to_num == 0) ||
                (result == SRV_SMS_CAUSE_SEND_ABORT) ||
                (result == SRV_SMS_CAUSE_NUMBER_INVALID) ||
                (result == SRV_SMS_CAUSE_SC_EMPTY))
            {
                return;
            }

            break;
        }
    #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
        case (SRV_UC_PHB_LIST_TYPE_NORMAL_MMS):
        {
            //MMI_ASSERT(result == MMA_RESULT_OK);

            if (g_uc_p->srv_msg->to_num == 0)
            {
                return;
            }

            break;
        }

        case (SRV_UC_PHB_LIST_TYPE_POSTCARD_MMS):
        {
            //MMI_ASSERT(result == MMA_RESULT_OK);
            break;
        }

        default:
        {
            MMI_ASSERT(0);
            break;
        }

    }

    final_added_num = srv_uc_check_and_add_addr_to_phb_notify_list(g_uc_p->main.instance, type);
    if ((final_added_num > 0) && (mmi_phb_get_unsaved_data_num() > 0))
    {
        if (mmi_frm_scrn_get_active_id() == checked_screen_id)
        {
            mmi_phb_pre_entry_unsaved_data_confirm();
        }
        /* means interrupt happens ex. incoming call or a popup */
        /*else if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, checked_screen_id, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            mmi_phb_insert_unsaved_data_confirm_after_assigned_scrn(checked_screen_id);
        }*/
        /* Screen delete with some operation. */
        else
        {
            mmi_phb_add_unsaved_data_confirm_to_history();
        }
    }
    else
    {
        MMI_TRACE(
            MMI_COMMON_TRC_G6_MSG,
            TRC_MMI_UC_PHB_SAVE_CONTACT_NOTIFY_CHECK_P2,
            final_added_num,
            mmi_phb_get_unsaved_data_num());
    }

}
#endif /* __MMI_PHB_SAVE_CONTACT_NOTIFY__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_sms_remaining_char_count
 * DESCRIPTION
 *  Initialize editor
 * PARAMETERS
 *  current_text_info       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_sms_remaining_char_count(wgui_uce_text_info_struct *current_text_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Call to do UC internal operations. */
    mmi_uc_get_message_size_callback(current_text_info, WGUI_UCE_MSG_TYPE_SMS);
    return (U32) srv_sms_get_last_segment_remaining(
                    current_text_info->UCS2_count,
                    current_text_info->char_count,
                    current_text_info->extension_char_count);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_sms_segment_count
 * DESCRIPTION
 *  Initialize editor
 * PARAMETERS
 *  current_text_info       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_sms_segment_count(wgui_uce_text_info_struct *current_text_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 local_value = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    local_value = srv_sms_get_sms_segment_number(
                    current_text_info->UCS2_count,
                    current_text_info->char_count,
                    current_text_info->extension_char_count);
    if (local_value == 0 &&
        srv_sms_get_last_segment_remaining(
            current_text_info->UCS2_count,
            current_text_info->char_count,
            current_text_info->extension_char_count) == 0)
    {
        local_value = (U32) mmi_uc_get_max_mo_sms_segment();
    }
    return local_value;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_max_mo_sms_segment
 * DESCRIPTION
 *  Determine max sms segment supported
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
kal_uint8 mmi_uc_get_max_mo_sms_segment(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __EMS_DYNAMIC_SEG_NUM__
	if (srv_sms_is_long_sms_dynamic_seg_setting(SRV_SMS_SIM_1) == MMI_TRUE)
    {
        return mmi_uc_custom_get_max_mo_sms_segment();
    }
    else
    {
        return (kal_uint8) 1;   /* 1 can be change with any macro value. */
    }
#else /* __EMS_DYNAMIC_SEG_NUM__ */ 
    return mmi_uc_custom_get_max_mo_sms_segment();
#endif /* __EMS_DYNAMIC_SEG_NUM__ */ 

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_display_type_callback
 * DESCRIPTION
 *  Check which display type should be used for mms , display  character or size
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
wgui_uce_display_enum mmi_uc_display_type_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        return WGUI_UCE_DISPLAY_CHARACTER;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 

    return WGUI_UCE_DISPLAY_SIZE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_processing
 * DESCRIPTION
 *  Entry MSG generic processing screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_processing(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 current_screen = mmi_frm_scrn_get_active_id();
    S32 str_len = mmi_ucs2strlen((S8*) GetString(g_uc_p->processing.body_str_id));

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    str_len = (str_len > MMI_UC_MAX_PROCESS_STRING_LEN) ? MMI_UC_MAX_PROCESS_STRING_LEN : str_len;
    memset(g_uc_p->processing.body_str, 0, (MMI_UC_MAX_PROCESS_STRING_LEN + 1) * ENCODING_LENGTH);
    mmi_ucs2ncpy((S8*) g_uc_p->processing.body_str, (S8*) GetString(g_uc_p->processing.body_str_id), str_len);
    if (current_screen == SCR_ID_UC_PROCESSING
    	#ifdef __MMI_FRM_HISTORY__
    	 && !CheckIsBackHistory()
    	#endif
    	 )
    {
        cat66_update_progress_string();
    }
    else
    {
        mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_PROCESSING);
    }
}

#ifdef __MMI_UC_MULTI_SELECT__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_check_valid_address_ext
 * DESCRIPTION
 *  Check valid address
 * PARAMETERS
 *  cnt_IN          [IN]        
 *  PhbIndex_IN     [?]         
 *  num_type_IN     [?]         
 * RETURNS
 * BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_check_valid_address_ext(U16 cnt_IN, U16 *PhbIndex_IN, U8 *num_type_IN)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Not used currently */
    /* Check validity in other callbacks */
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if ((mmi_uc_get_buffer_recipient_count() + cnt_IN) > SRV_UC_MAX_ADDRESS_NUM)
#else
    if ((g_uc_p->srv_msg->to_num + cnt_IN) > SRV_UC_MAX_ADDRESS_NUM)
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
        return MMI_FALSE;
    }
    return MMI_TRUE;
}

extern void mmi_phb_mark_several_for_msg_get_number(U8 *dest, U8 max_dest_len, U16 PhbIndex, U8 num_type);

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_addr_callback
 * DESCRIPTION
 *  Multi address callback
 * PARAMETERS
 *  cnt             [IN]        
 *  PhbIndex        [?]         
 *  num_type        [?]         
 *  is_group        [IN]        
 * RETURNS
 *  void
 * BOOL
 *****************************************************************************/
void mmi_uc_handle_addr_callback(U16 cnt, U16 *PhbIndex, U8 *num_type, MMI_BOOL is_group)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 string_id = 0;
    U32 index = 0, count = 0;
    #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    BOOL result = MMI_TRUE;
    #endif
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
    MMI_BOOL invalid_num = MMI_FALSE, invalid_email = MMI_FALSE, long_num = MMI_FALSE, long_email = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (cnt == 0)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_EMPTY)), MMI_EVENT_ERROR, NULL);

        return;
    }

    for (; index < cnt; index++)
    {
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if (mmi_uc_get_buffer_recipient_count() >= SRV_UC_MAX_ADDRESS_NUM)
#else
        if (g_uc_p->srv_msg->to_num >= SRV_UC_MAX_ADDRESS_NUM)
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        {
            mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_RECIPIENT_NUMBER_EXCEED_ID)), MMI_EVENT_ERROR, NULL);
            if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid,  
                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                        SCR_ID_UC_EDITOR,
                                #else
                                        SCR_ID_UC_OPT_ADD_RECIPIENT,
                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                        MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
            {
                {
                    U16 next_scrn_id = 0, top_scrn_id = 0;
                    top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                    next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid,  
                                                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                                SCR_ID_UC_EDITOR,
                                                        #else
                                                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                                MMI_FRM_NODE_AFTER_FLAG); 
                    mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                }
            }
            return;
        }
        if ((num_type[index] == MMI_PHB_NUMBER_TYPE_NUMBER)
            || (num_type[index] == MMI_PHB_NUMBER_TYPE_HOME_NUMBER)
            || (num_type[index] == MMI_PHB_NUMBER_TYPE_OFFICE_NUMBER)
            || (num_type[index] == MMI_PHB_NUMBER_TYPE_FAX_NUMBER))
        {
            if (!is_group)
            {
                g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_NUMBER;
            }
            else
            {
                g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_NUMBER_GROUP;
            }
            memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
            mmi_phb_mark_several_for_msg_get_number(
                (U8*) g_uc_p->done.to,
                SRV_UC_MAX_PHONE_NUMBER_LEN + 1,
                PhbIndex[index],
                num_type[index]);

            if (!srv_uc_is_phone_number_valid((S8*) g_uc_p->done.to))
            {
                invalid_num = MMI_TRUE;
                count++;
                continue;
            }

        #ifdef __MMI_MMS_2__
            if (mmi_ucs2strlen((S8*) g_uc_p->done.to) > (SRV_UC_MAX_PHONE_NUMBER_LEN))
        #else 
            if (mmi_ucs2strlen((S8*) g_uc_p->done.to) > (SRV_SMS_MAX_ADDR_LEN - 1))
        #endif 
            {
                if (cnt == 1)
                {
                    long_num = MMI_TRUE;
                }
                continue;
            }

            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
            {
                /* Check if the msg size exceeds the MMS limitation */
                U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
                MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

                if (srv_uc_check_if_exceed_MMS_size_limitation
                    (g_uc_p->main.instance, addr_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
                {
                    (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                        mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid,  
                                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                SCR_ID_UC_EDITOR,
                                        #else
                                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                    {
                        {
                            U16 next_scrn_id = 0, top_scrn_id = 0;
                            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid,  
                                                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                                        SCR_ID_UC_EDITOR,
                                                                #else
                                                                        SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                                        MMI_FRM_NODE_AFTER_FLAG); 
                            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                        }
                    }
                    return;
                }
            }
        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        {
            U16 recipient_name[(MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH];
            S32 pos = 0;
            memset(recipient_name, 0, (MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH);
            srv_phb_get_name_by_number((U16 *)g_uc_p->done.to, recipient_name, MMI_UC_MAX_EMAIL_LEN);
            if(mmi_ucs2strlen((S8*) recipient_name) == 0)
            {
                mmi_ucs2ncpy((S8*)recipient_name, (S8*)g_uc_p->done.to, MMI_UC_MAX_EMAIL_LEN);
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                            (UI_string_type)recipient_name, 0, MMI_TRUE, -1);
            }
            else
            {
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                pos = mmi_uc_add_get_recipient_position();
                if(wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                            (UI_string_type)recipient_name, WGUI_UCE_WRAPPING_DELETE_RECIPIENT, 
                                            MMI_TRUE, pos))
                {
                    mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                }
            }
        }
        #else
            result = srv_uc_add_address(
                        g_uc_p->main.instance,
                        g_uc_p->done.to,
                        MMI_UC_ADDRESS_TYPE_PHONE_NUMBER,
                        g_uc_p->done.current_addr_type);
            MMI_ASSERT(result);
            g_uc_p->send_info.change_in_recipient_list = TRUE;
            g_uc_p->done.current_addr_index = g_uc_p->srv_msg->to_num + MMI_UC_ADD_RECIPIENT_TOTAL
                - mmi_uc_get_number_of_options_omitted() - 1; 
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
            {
                result = mmi_uc_replace_screen(
                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                            (mmi_proc_func) mmi_uc_entry_add_recipient,
                            0);

                //MMI_ASSERT(result);
            }
            if (mmi_uc_change_msg_type_if_needed())
            {
                pass_sig_check = mmi_uc_insert_signature_check();
            }
    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

            srv_uc_update_msg_size(g_uc_p->main.instance);
        }
        else if (num_type[index] == MMI_PHB_NUMBER_TYPE_EMAIL_ADDRESS ||
                 num_type[index] == MMI_PHB_NUMBER_TYPE_EMAIL_ADDRESS_2)
        {
            if (!is_group)
            {
                g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_EMAIL;
            }
            else
            {
                g_uc_p->done.state = MMI_UC_DONE_STATE_ADD_EMAIL_GROUP;
            }
            memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
            mmi_phb_mark_several_for_msg_get_number(
                (U8*) g_uc_p->done.to,
                MMI_UC_MAX_EMAIL_LEN + 1,
                PhbIndex[index],
                num_type[index]);

            if (!srv_uc_is_email_addr_valid(g_uc_p->done.to))
            {
                invalid_email = MMI_TRUE;
                count++;
                continue;
            }

            if (mmi_ucs2strlen((S8*) g_uc_p->done.to) > (MMI_UC_MAX_EMAIL_LEN))
            {
                if (cnt == 1)
                {
                    long_email = MMI_TRUE;
                }
                continue;
            }

            if (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_MMS_PREFER)
            {
                /* Check if the msg size exceeds the MMS limitation */
                U32 addr_size = mma_uc_calc_header_attribute_size(MMA_HEADER_ADDRESS, (const kal_wchar*)g_uc_p->done.to);
                MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

                if (srv_uc_check_if_exceed_MMS_size_limitation
                    (g_uc_p->main.instance, addr_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
                {
                    (fail_in_restricted_size_check) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                        mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
                    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, 
                                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                SCR_ID_UC_EDITOR,
                                        #else
                                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                    {
                        {
                            U16 next_scrn_id = 0, top_scrn_id = 0;
                            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, 
                                                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                                        SCR_ID_UC_EDITOR,
                                                                #else
                                                                        SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                                        MMI_FRM_NODE_AFTER_FLAG); 
                            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                        }
                    }
                    return;
                }
            }
        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        {
            U16 recipient_name[(MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH];
            S32 pos = 0;
            memset(recipient_name, 0, (MMI_UC_MAX_EMAIL_LEN + 2) * ENCODING_LENGTH);
            srv_phb_get_name_by_number((U16 *)g_uc_p->done.to, recipient_name, MMI_UC_MAX_EMAIL_LEN);
            if(mmi_ucs2strlen((S8*) recipient_name) == 0)
            {
                mmi_ucs2ncpy((S8*)recipient_name, (S8*)g_uc_p->done.to, MMI_UC_MAX_EMAIL_LEN);
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                            (UI_string_type)recipient_name, 0, MMI_TRUE, -1);
            }
            else
            {
                mmi_ucs2cat((char *) recipient_name, (const char *) ";\0");
                pos = mmi_uc_add_get_recipient_position();
                if(wgui_cat280_add_recipient(mmi_uc_convert_group_to_region(g_uc_p->done.current_addr_type), 
                                            (UI_string_type)recipient_name, WGUI_UCE_WRAPPING_DELETE_RECIPIENT, 
                                            MMI_TRUE, pos))
                {
                    mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                }
            }
        }
        #else
            result = srv_uc_add_address(
                        g_uc_p->main.instance,
                        g_uc_p->done.to,
                        MMI_UC_ADDRESS_TYPE_EMAIL,
                        g_uc_p->done.current_addr_type);

            MMI_ASSERT(result);
            g_uc_p->send_info.change_in_recipient_list = TRUE;
            /* update the highlighted address to the new one */
            g_uc_p->done.current_addr_index = g_uc_p->srv_msg->to_num + MMI_UC_ADD_RECIPIENT_TOTAL
                - mmi_uc_get_number_of_options_omitted() - 1;
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_OPT_ADD_RECIPIENT, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
            {
                result = mmi_uc_replace_screen(
                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                            SCR_ID_UC_OPT_ADD_RECIPIENT,
                            (mmi_proc_func) mmi_uc_entry_add_recipient,
                            0);

                //MMI_ASSERT(result);
            }

            if (mmi_uc_change_msg_type_if_needed())
            {
                pass_sig_check = mmi_uc_insert_signature_check();
            }
    #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

            srv_uc_update_msg_size(g_uc_p->main.instance);
        }
        else
        {
            MMI_ASSERT(0);
        }
    }

    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, 
                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                SCR_ID_UC_EDITOR,
                        #else
                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        {
            U16 next_scrn_id = 0, top_scrn_id = 0;
            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, 
                                                #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                                        SCR_ID_UC_EDITOR,
                                                #else
                                                        SCR_ID_UC_OPT_ADD_RECIPIENT,
                                                #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                                        MMI_FRM_NODE_AFTER_FLAG); 
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
        }
    }
    if (invalid_num && invalid_email)
    {
        string_id = STR_GLOBAL_INVALID_RECIPIENTS;
    }
    else if (invalid_num)
    {
        if (count == 1)
        {
            string_id = STR_GLOBAL_INVALID_NUMBER;
        }
        else
        {
            string_id = STR_GLOBAL_INVALID_NUMBERS;
        }
    }
    else if (invalid_email)
    {
        if (count == 1)
        {
            string_id = STR_GLOBAL_INVALID_EMAIL_ADDRESS;
        }
        else
        {
            string_id = STR_GLOBAL_INVALID_EMAIL_ADDRESSES;
        }
    }
    else if (long_num)
    {
        string_id = STR_UC_NUMBER_LENGTH_EXCEED_ID;
    }
    else if (long_email)
    {
        string_id = STR_UC_ADDR_LENGTH_EXCEED_ID;
    }
    if (string_id)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(string_id)), MMI_EVENT_ERROR, NULL);
    }
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(
            mmi_uc_process_warning_mode_insert_signature,
            mmi_frm_scrn_close_active_id,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_entry_sig_displayConfirm();
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_multi_addr_callback_ext
 * DESCRIPTION
 *  Add address group from phonebook callback
 * PARAMETERS
 *  cnt             [IN]        
 *  PhbIndex        [?]         
 *  num_type        [?]         
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_get_multi_addr_callback_ext(U16 cnt, U16 *PhbIndex, U8 *num_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_handle_addr_callback(cnt, PhbIndex, num_type, (MMI_BOOL)0);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_group_addr_callback_ext
 * DESCRIPTION
 *  Add address group from phonebook callback
 * PARAMETERS
 *  cnt             [IN]        
 *  PhbIndex        [?]         
 *  num_type        [?]         
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_get_group_addr_callback_ext(U16 cnt, U16 *PhbIndex, U8 *num_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_handle_addr_callback(cnt, PhbIndex, num_type, (MMI_BOOL)1);
}
#endif /* __MMI_UC_MULTI_SELECT__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_process_delete_addr
 * DESCRIPTION
 *  Delete current highlighted address
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_process_delete_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_uc_addr_struct *addr = mmi_uc_get_highlighted_addr();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    srv_uc_delete_addr(g_uc_p->main.instance, addr);
    g_uc_p->send_info.change_in_recipient_list = TRUE;
    if (mmi_uc_change_msg_type_if_needed())
    {
        mmi_uc_insert_signature_check();
    }
    srv_uc_update_msg_size(g_uc_p->main.instance);/*MAUI_01914616*/
    //mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_UC_REMOVED_ID)), MMI_EVENT_SUCCESS, NULL);

    mmi_uc_set_group_id();
    if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, 
                        #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                                SCR_ID_UC_EDITOR,
                        #else
                                SCR_ID_UC_OPT_ADD_RECIPIENT,
                        #endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                                MMI_FRM_NODE_ALL_FLAG))
    {
        /* Go back add recipient screen */
    }
    else
    {
        MMI_ASSERT(0);
    }
}

#ifdef __MMI_PHOTOEDITOR__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enter_edit_image
 * DESCRIPTION
 *  Entry function for edit image
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_enter_edit_image(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ori_file_handle = 0;
    S32 result;
    U8 virtual_file_name[(FS_GenVFN_SIZE + 1) * ENCODING_LENGTH];
    MMI_BOOL is_virtual = MMI_FALSE;
    cui_phoedt_run_struct para;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_create(
        GRP_ID_ROOT,
        APP_UNIFIEDCOMPOSER, 
        mmi_uc_entry_edit_image_proc,
        NULL);

    mmi_frm_group_enter(
        APP_UNIFIEDCOMPOSER, 
        MMI_FRM_NODE_SMART_CLOSE_FLAG);

    g_uc_p->main.uc_phart_id = cui_phoedt_create(APP_UNIFIEDCOMPOSER);

    cui_phoedt_struct_init(&para);

    if (g_uc_p->srv_msg->msg_body.curr_slide->img.object->is_virtual_file)
    {

        ori_file_handle = FS_Open(g_uc_p->srv_msg->msg_body.curr_slide->img.object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);
        is_virtual = MMI_TRUE;

        if (ori_file_handle > 0)
        {

            result = FS_GenVirtualFileName(
                        ori_file_handle,
                        (U16*) virtual_file_name,
                        (unsigned int)FS_GenVFN_SIZE,
                        g_uc_p->srv_msg->msg_body.curr_slide->img.object->offset,
                        g_uc_p->srv_msg->msg_body.curr_slide->img.object->size);
            ASSERT(result >= 0);

            mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
            if (srv_uc_get_file_extension(g_uc_p->srv_msg->msg_body.curr_slide->img.object->file_name_ucs) == NULL)
            {
                MMI_ASSERT(0);
            }

            mmi_ucs2ncat(
                (PS8) virtual_file_name,
                (PS8) srv_uc_get_file_extension(g_uc_p->srv_msg->msg_body.curr_slide->img.object->file_name_ucs),
                sizeof(virtual_file_name) / ENCODING_LENGTH);

        }

    }
    if (ori_file_handle <= 0 || result < 0) /* use phiart's error handling, pop up not support */
    {
        //para.is_vitual = is_virtual;
        para.origin_filepath = (WCHAR*) g_uc_p->srv_msg->msg_body.curr_slide->img.object->file_path_ucs;
        //para.result_callback = NULL;
        //para.sourcefile_handle = ori_file_handle;
        
        
        cui_phoedt_run(g_uc_p->main.uc_phart_id, &para);
    }
    else
    {
      //  para.is_vitual = is_virtual;
        para.origin_filepath = (WCHAR*) virtual_file_name;
     //   para.result_callback = NULL;
     //   para.sourcefile_handle = ori_file_handle;

        

        cui_phoedt_run(g_uc_p->main.uc_phart_id, &para);
    }

    /* not close ori_file_handle here, because phoart need this file keep open for accessing VF */

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_edit_image_for_phoart_callback_to_asm
 * DESCRIPTION
 *  Edit image callback for phoart ASM
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_edit_image_for_phoart_callback_to_asm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_enter_edit_image();
}

#endif /* __MMI_PHOTOEDITOR__ */ 

#ifndef __MMI_SLIM_MMS_2__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_msg_detail
 * DESCRIPTION
 *  Entry function for message detail screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_msg_detail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_MSG_DETAIL);
    return;
}
#endif

#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_addr_confirm_popup_group_proc
 * DESCRIPTION
 *  Entry function for delete address
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_delete_addr_confirm_popup_group_proc(mmi_alert_result_evt_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch (evt->result)
        {
        case MMI_ALERT_CNFM_1:
        case MMI_ALERT_CNFM_2:
        case MMI_ALERT_CNFM_3:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_OK:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_YES:
            #ifdef __MMI_MMS_POSTCARD__
                 if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
                 {
                     mmi_postcard_delete_one_recipient();
                 }
                 else
            #endif /* __MMI_MMS_POSTCARD__ */ 
                 {
                     mmi_uc_process_delete_addr();
                 }
            break;
        case MMI_ALERT_CNFM_NO:
            mmi_uc_set_group_id();
            break;
        }
    }
    return MMI_RET_OK;
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_delete_addr
 * DESCRIPTION
 *  Entry function for delete address
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_delete_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	mmi_confirm_property_struct arg;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	mmi_confirm_property_init(&arg, CNFM_TYPE_YESNO);
	arg.callback = (mmi_proc_func)mmi_uc_delete_addr_confirm_popup_group_proc;
	arg.parent_id = g_uc_p->main.uc_cui_gid;
	mmi_confirm_display((WCHAR *)(get_string(STR_UC_DELETE_ASK_ID)), MMI_EVENT_QUERY, &arg);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_all_addr_confirm_popup_group_proc
 * DESCRIPTION
 *  Entry function for delete all address of some group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_delete_all_addr_confirm_popup_group_proc(mmi_alert_result_evt_struct *evt)
{
    if (evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch (evt->result)
        {
        case MMI_ALERT_CNFM_1:
        case MMI_ALERT_CNFM_2:
        case MMI_ALERT_CNFM_3:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_OK:
            // handle softkey event here
            break;
        case MMI_ALERT_CNFM_YES:
            #ifdef __MMI_MMS_POSTCARD__
                if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
                {
                     mmi_postcard_reset_all_recipients();
                }
                else
           #endif /* __MMI_MMS_POSTCARD__ */ 
                {
                     mmi_uc_process_delete_all_addr();
                }
           break;
        case MMI_ALERT_CNFM_NO:
            mmi_uc_set_group_id();
            break;
        }
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_delete_all_addr
 * DESCRIPTION
 *  Entry function for delete all address of some group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_delete_all_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	mmi_confirm_property_struct arg;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	mmi_confirm_property_init(&arg, CNFM_TYPE_YESNO);
	arg.callback = (mmi_proc_func)mmi_uc_delete_all_addr_confirm_popup_group_proc;
	arg.parent_id = g_uc_p->main.uc_cui_gid;
	mmi_confirm_display((WCHAR *)(get_string(STR_UC_DELETE_ALL_ASK_ID)), MMI_EVENT_QUERY, &arg);
}
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_edit_image_callback
 * DESCRIPTION
 *  Entry function for edit image
 * PARAMETERS
 *  result                  [IN]        
 *  new_filepath            [?]         
 *  is_virtual              [IN]        
 *  sourcefile_handle       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_edit_image_callback(MMI_BOOL result, S8 *new_filepath, MMI_BOOL is_virtual, S32 sourcefile_handle)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_insert_check_struct check_result;
    mma_insert_info_struct insert_info;
    mma_mms_slide_struct *slide = g_uc_p->srv_msg->msg_body.curr_slide;
    mma_mms_object_struct *new_object = NULL;
    mma_mms_object_struct *replaced_object = NULL;
    srv_uc_object_type replace_obj_type;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);
    //U32 new_obj_smil_size = 0;
    U32 replaced_obj_smil_size = 0;
    U32 replaced_obj_body_size = 0;
    U32 new_msg_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_EDIT_IMAGE_CALL_BACK_P1, result);

    if (MMI_FALSE == result)
    {
        /* MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ENTRY_EDIT_IMAGE_CB_ERROR); */
        /* because during pic editor, if the src_file is a VF, should keep this file open until the pic editor finish all actions */
        if (is_virtual && sourcefile_handle >= 0)
        {
            FS_Close(sourcefile_handle);
        }
        return;
    }
    else
    {
        U32 flie_path_len = mmi_ucs2strlen((S8*) new_filepath);

        g_uc_p->srv_main->file_path = kal_adm_alloc(g_uc_p->main.mem_pool_id, (flie_path_len + 1) * ENCODING_LENGTH);

        MMI_ASSERT(g_uc_p->srv_main->file_path);
        mmi_ucs2ncpy((S8*) g_uc_p->srv_main->file_path, (S8*) new_filepath, flie_path_len);
    }

    /* Remove progress screen.
    mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
    mmi_uc_entry_processing_generic();*/

    memset(&check_result, 0, sizeof(mma_insert_check_struct));
    MMI_ASSERT(g_uc_p->main.highlighted_object_type == SRV_UC_OBJECT_TYPE_IMAGE);
    replaced_object = srv_uc_get_object_in_slide(slide, g_uc_p->main.highlighted_object_type);
    MMI_ASSERT(replaced_object != NULL);

    replace_obj_type = (srv_uc_object_type)replaced_object->type;

    mma_uc_calc_object_smil_size(mms_type, (kal_wchar*) g_uc_p->srv_main->file_path);
    replaced_obj_smil_size = mma_uc_calc_object_smil_size((mma_insert_type_enum)
                                srv_uc_convert_to_mms_insert_type(replace_obj_type),
                                (const kal_wchar*)replaced_object->file_path_ucs);

    if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_MIXED_MMS)
    {
        //new_obj_smil_size = 0;
        replaced_obj_smil_size = 0;
    }

    if (replaced_object->reference_count == 1)
    {
        if (replaced_object->is_virtual_file)
        {
            U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
            S32 result;
            S32 file_handle;
            U16 virtual_file_name_len = sizeof(virtual_file_name);

            memset(virtual_file_name, 0, virtual_file_name_len);

            file_handle = FS_Open(replaced_object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

            if (file_handle <= 0)
            {
                MMI_ASSERT(0);
				MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
            }

            result = FS_GenVirtualFileName(
                        file_handle,
                        (U16*) virtual_file_name,
                        (unsigned int)FS_GenVFN_SIZE,
                        replaced_object->offset,
                        replaced_object->size);

            if (result < 0)
            {
                MMI_ASSERT(0);
            }

            mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
            if (srv_uc_get_file_extension(replaced_object->file_name_ucs))
            {
                mmi_ucs2ncat(
                    (PS8) virtual_file_name,
                    (PS8) srv_uc_get_file_extension(replaced_object->file_name_ucs),
                    virtual_file_name_len / ENCODING_LENGTH);
            }

            replaced_obj_body_size = mma_uc_calc_object_multipart_size((U16*) virtual_file_name);

            FS_Close(file_handle);
        }
        else
        {
            replaced_obj_body_size = mma_uc_calc_object_multipart_size(replaced_object->file_path_ucs);
        }
    }
    else    /* reference_count != 1 */
    {
        replaced_obj_body_size = 0;
    }

    new_msg_size = g_uc_p->srv_msg->msg_size - replaced_obj_smil_size - replaced_obj_body_size;

    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = new_msg_size;
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = mms_type;
    insert_info.filepath = (kal_wchar*) (g_uc_p->srv_main->file_path);
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_result);

    if (!(check_result.result))
    {
        srv_uc_result uc_result = srv_uc_convert_mms_check_result(&check_result);

        mmi_uc_display_popup(uc_result);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
        return;
    }

    replaced_object->reference_count--;

    if (replaced_object->reference_count == 0)
    {
        srv_uc_delete_object_from_list(g_uc_p->main.instance, replaced_object);
    }
    /* in mmi_uc_insert_object, will re-assign type (maybe some att should be ref) */
    new_object = srv_uc_insert_object(
                    g_uc_p->main.instance,
                    (S8*) g_uc_p->srv_main->file_path,
                    g_uc_p->main.highlighted_object_type);

    srv_uc_insert_object_to_slide(g_uc_p->main.instance, new_object, slide, g_uc_p->main.highlighted_object_type);

    srv_uc_update_msg_size(g_uc_p->main.instance);
    mmi_uc_editor_initialize();
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    mmi_uc_recipient_initialize();
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);

    if (mmi_frm_scrn_get_active_id() == SCR_ID_UC_PROCESSING)
    {
        {
            U16 next_scrn_id = 0, top_scrn_id = 0;
            top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
            next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
            mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
        }
    }
    else
    {
        U16 screen_id = 0;
        screen_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AT_LATEST_FLAG);

        if (screen_id)
        {

            /* if popup happens, the progressing screen will be push to history, and be deleted by fmgr (fmgr_reset_app_select) */
            if (mmi_frm_scrn_is_present(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))//IsScreenPresent(SCR_ID_UC_PROCESSING))
            {
                mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING, 1, 0, screen_id, 1);
            }
            else
            {
                /* because popup will push progressing screen to history and therefore the progessing screen
                   will be removed by fmgr_reset_app_select */
                {
                    U16 next_scrn_id = 0, top_scrn_id = 0;
                    top_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_INVALID, MMI_FRM_NODE_AT_LATEST_FLAG); 
                    next_scrn_id = mmi_frm_scrn_get_neighbor_id(g_uc_p->main.uc_cui_gid, SCR_ID_UC_EDITOR, MMI_FRM_NODE_AFTER_FLAG); 
                    mmi_frm_scrn_multiple_close (g_uc_p->main.uc_cui_gid, top_scrn_id, 1, 0, next_scrn_id, 1);
                }
            }

        }
        else
        {
            /* SCR_ID_UC_EDITOR is the last screen in history */
            /* MMI_ASSERT(0); */
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
        }

    }

    if (g_uc_p->srv_main->file_path)
    {
        kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
        g_uc_p->srv_main->file_path = NULL;
    }
    return;

}

#ifdef __MMI_PHOTOEDITOR__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_edit_image_proc
 * DESCRIPTION
 *  
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_entry_edit_image_proc(mmi_event_struct* evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
   cui_phoedt_event_struct *phoart_evt = (cui_phoedt_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	 switch(phoart_evt->evt_id)
    {
		case EVT_ID_CUI_PHOEDT_RESULT_SUCCESS:
			mmi_uc_entry_edit_image_callback(
				MMI_TRUE,
				(S8*)phoart_evt->file_path,
				0,
				0); 
			break;

		case EVT_ID_CUI_PHOEDT_RESULT_FAILED:
			mmi_uc_entry_edit_image_callback(
				MMI_FALSE,
				(S8*)phoart_evt->file_path,
				0,
				0);
			break;

		case EVT_ID_CUI_PHOEDT_RESULT_CLOSE_ME:
			cui_phoedt_close(g_uc_p->main.uc_phart_id);
			break;

		default:
			break;
	 }
	 return MMI_RET_OK;
}
#endif /* __MMI_PHOTOEDITOR__ */
#ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_prefer_storage
 * DESCRIPTION
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_set_prefer_storage(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_mms_prefer_storage_enum mode;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->main.confirm_str_id == STR_UC_CARD_NOT_PRESENT_CONFIRM ||
        g_uc_p->main.confirm_str_id == STR_UC_MAX_MSG_CARD_CONFIRM)
    {
        mode = E_PREFER_STORAGE_MODE_PHONE;
    }
    else
    {
        mode = E_PREFER_STORAGE_MODE_CARD;
    }
    g_uc_p->main.confirm_str_id = 0;
    srv_mms_set_prefered_storage((U8) mode, MMI_TRUE);
    mmi_uc_create_mms();
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_reset_state
 * DESCRIPTION
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_reset_state(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->srv_send_info->action = SRV_UC_ACTION_IDLE;
    g_uc_p->main.confirm_str_id = 0;
    mmi_frm_scrn_close_active_id();
	mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_MSG_PREVIEW);
}
#endif /* __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_convert_to_editor_layout_type
 * DESCRIPTION
 *  Insert object
 * PARAMETERS
 *  layout_type     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_convert_to_editor_layout_type(mma_slide_layout_enum layout_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (layout_type)
    {
        case MMA_LAYOUT_NONE:
        {
            return WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP;
        }
            

        case MMA_LAYOUT_IMAGE_ON_TOP:
        {
            return WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP;
        }
            

        case MMA_LAYOUT_TEXT_ON_TOP:
        {
            return WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM;
        }
            

        default:
        {
            return WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP;
        }
            
    }

    //return WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_convert_to_editor_object_type
 * DESCRIPTION
 *  Insert object
 * PARAMETERS
 *  object_type     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_convert_to_editor_object_type(srv_uc_object_type object_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (object_type)
    {
        case SRV_UC_OBJECT_TYPE_IMAGE:
        {
            return WGUI_UCE_OBJECT_TYPE_IMAGE;
        }
            

        case SRV_UC_OBJECT_TYPE_AUDIO:
        {
            return WGUI_UCE_OBJECT_TYPE_AUDIO;
        }
            

        case SRV_UC_OBJECT_TYPE_VIDEO:
        {
            return WGUI_UCE_OBJECT_TYPE_VIDEO;
        }
            

        case SRV_UC_OBJECT_TYPE_ATTACHMENT:
        {
            return WGUI_UCE_OBJECT_TYPE_ATTACHMENT;
        }
            

        default:
        {
            MMI_ASSERT(0);
        }
            
    }

    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_convert_to_editor_msg_type
 * DESCRIPTION
 *  Insert object
 * PARAMETERS
 *  msg_type        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
U32 mmi_uc_convert_to_editor_msg_type(srv_uc_msg_type_enum msg_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (msg_type)
    {
        case SRV_UC_MSG_TYPE_SMS_PREFER:
        case SRV_UC_MSG_TYPE_SMS_ONLY:
        {
            return WGUI_UCE_MSG_TYPE_SMS;
        }
        

        case SRV_UC_MSG_TYPE_MMS_PREFER:
        case SRV_UC_MSG_TYPE_MMS_ONLY:
        {
            return WGUI_UCE_MSG_TYPE_MMS;
        }
            

        default:
        {
            MMI_ASSERT(0);
        }
            
    }

    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_editor_add_object
 * DESCRIPTION
 *  Add object to editor
 * PARAMETERS
 *  object          [?]         
 *  object_type     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_editor_add_object(mma_mms_object_struct *object, srv_uc_object_type object_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_object_type_enum uce_object_type = (wgui_uce_object_type_enum)mmi_uc_convert_to_editor_object_type(object_type);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (object_type == SRV_UC_OBJECT_TYPE_IMAGE || object_type == SRV_UC_OBJECT_TYPE_VIDEO)
    {
        /* display default image for thumbnail for all drm files */
        if (object->drm_type == MMA_DRM_NONE
             || object->drm_type == MMA_DRM_SD  )
        {
            if (object->is_virtual_file)
            {
                U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
                S32 result;
                U16 virtual_file_name_len = sizeof(virtual_file_name);

                memset(virtual_file_name, 0, virtual_file_name_len);
                if (g_uc_p->srv_main->file_handle > 0)
                {
                    FS_Close(g_uc_p->srv_main->file_handle);
                    g_uc_p->srv_main->file_handle = 0;
                }

                g_uc_p->srv_main->file_handle = FS_Open((U16 *)object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                if (g_uc_p->srv_main->file_handle <= 0)
                {
                    return;
                    //MMI_ASSERT(0);
                }

                result = FS_GenVirtualFileName(
                            g_uc_p->srv_main->file_handle,
                            (U16*) virtual_file_name,
                            (unsigned int)FS_GenVFN_SIZE,
                            object->offset,
                            object->size);

                if (result < 0)
                {
                    return;
                    //MMI_ASSERT(0);
                }

                mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                if (srv_uc_get_file_extension((U16 *)object->file_name_ucs) == NULL)
                {
                    return;
                    //MMI_ASSERT(0);
                }

                mmi_ucs2ncat(
                    (PS8) virtual_file_name,
                    (PS8) srv_uc_get_file_extension((U16 *)object->file_name_ucs),
                    virtual_file_name_len / ENCODING_LENGTH);

                wgui_uce_add_object(
                    uce_object_type,
                    (U16*) virtual_file_name,
                    0,
                    (wgui_uce_layout_type_enum)mmi_uc_convert_to_editor_layout_type((mma_slide_layout_enum)g_uc_p->srv_msg->msg_body.layout));

            }
            else
            {
                #ifdef __MMI_OP02_LEMEI__
                if(g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
                {
                    if (object_type == SRV_UC_OBJECT_TYPE_IMAGE)
                    {
                        #ifdef __MMI_FTE_SUPPORT__
                        wgui_uce_add_object(
                            uce_object_type,
                            NULL,
                            IMG_UC_FTE_IMAGE_BUTTON_NORMAL_ID,
                            mmi_uc_convert_to_editor_layout_type(g_uc_p->srv_msg->msg_body.layout));
                        #else
                        wgui_uce_add_object(
                            (wgui_uce_object_type_enum)uce_object_type,
                            NULL,
                            IMG_UC_IMAGE_BUTTON_ID,
                            (wgui_uce_layout_type_enum)mmi_uc_convert_to_editor_layout_type(g_uc_p->srv_msg->msg_body.layout));
                        #endif
                    }
                    else
                    {
                        #ifdef __MMI_FTE_SUPPORT__
                        wgui_uce_add_object(
                            (wgui_uce_object_type_enum)uce_object_type,
                            NULL,
                            IMG_UC_FTE_VIDEO_BUTTON_NORMAL_ID,
                            (wgui_uce_layout_type_enum)mmi_uc_convert_to_editor_layout_type(g_uc_p->srv_msg->msg_body.layout));
                        #else
                        wgui_uce_add_object(
                            (wgui_uce_object_type_enum)uce_object_type,
                            NULL,
                            IMG_UC_VIDEO_BUTTON_ID,
                            (wgui_uce_layout_type_enum)mmi_uc_convert_to_editor_layout_type(g_uc_p->srv_msg->msg_body.layout));
                        #endif
                    }
                }
                else
                #endif
                {
                    wgui_uce_add_object(
                        (wgui_uce_object_type_enum)uce_object_type,
                        (U16 *)object->file_path_ucs,
                        0,
                        (wgui_uce_layout_type_enum)mmi_uc_convert_to_editor_layout_type((mma_slide_layout_enum)g_uc_p->srv_msg->msg_body.layout));
                }
            }

        }
        else
        {
            wgui_uce_add_object(
                uce_object_type,
                NULL,
#ifdef __DRM_SUPPORT__
                IMG_UC_DRM_THUMBNAIL_ID,
#else
                0,
#endif
                (wgui_uce_layout_type_enum)mmi_uc_convert_to_editor_layout_type((mma_slide_layout_enum)g_uc_p->srv_msg->msg_body.layout));
        }
    }
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    else if (object_type == SRV_UC_OBJECT_TYPE_AUDIO)
    {
    #ifdef __MMI_FTE_SUPPORT__
        wgui_uce_add_object(uce_object_type, NULL, IMG_UC_FTE_AUDIO_BUTTON_NORMAL_ID, WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM);
    #else
        wgui_uce_add_object(uce_object_type, NULL, IMG_UC_AUDIO_BUTTON_ID, WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM);
    #endif /* __MMI_FTE_SUPPORT__ */
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    else
    {
        wgui_uce_add_object(uce_object_type, NULL, 0,(wgui_uce_layout_type_enum)0);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_text_info_from_slide
 * DESCRIPTION
 *  Set text info from slide
 * PARAMETERS
 *  slide           [?]     
 *  text_info       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_set_text_info_from_slide(mma_mms_slide_struct *slide, wgui_uce_text_info_struct *text_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    text_info->char_count = slide->txt.char_count;
    text_info->UCS2_count = slide->txt.UCS2_count;
    text_info->utf8_msg_len = slide->txt.utf8_msg_len;
    text_info->extension_char_count = slide->txt.extension_char_count;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_text_info_to_slide
 * DESCRIPTION
 *  Set text info to slide
 * PARAMETERS
 *  slide           [?]     
 *  text_info       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_set_text_info_to_slide(mma_mms_slide_struct *slide, wgui_uce_text_info_struct *text_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    slide->txt.char_count = text_info->char_count;
    slide->txt.UCS2_count = text_info->UCS2_count;
    slide->txt.utf8_msg_len = text_info->utf8_msg_len;
    slide->txt.extension_char_count = text_info->extension_char_count;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_editor_info
 * DESCRIPTION
 *  Set editor info
 * PARAMETERS
 *  slide       [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_set_editor_info(mma_mms_slide_struct *slide)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_text_info_struct text_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&text_info, 0, sizeof(wgui_uce_text_info_struct));

    if (slide != NULL)
    {
        if (slide->txt.object)
        {
            mmi_uc_set_text_info_from_slide(slide, &text_info);
            wgui_uce_insert_text(&text_info, g_uc_p->srv_main->text_buffer);
        }

        if (slide->img.object)
        {
            mmi_uc_editor_add_object(slide->img.object, SRV_UC_OBJECT_TYPE_IMAGE);
        }

        if (slide->aud.object)
        {
            mmi_uc_editor_add_object(slide->aud.object, SRV_UC_OBJECT_TYPE_AUDIO);
        }

        if (slide->vid.object)
        {
            mmi_uc_editor_add_object(slide->vid.object, SRV_UC_OBJECT_TYPE_VIDEO);
        }
    }

    if (g_uc_p->srv_msg->msg_body.total_attach_no)
    {
        mmi_uc_editor_add_object(NULL, SRV_UC_OBJECT_TYPE_ATTACHMENT);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_insert_signature_file
 * DESCRIPTION
 *  
 * PARAMETERS
 *  file_path       [?]         
 *  slide           [?]         
 *  type            [IN]        
 * RETURNS
 *  
 *****************************************************************************/
srv_uc_insert_signature_result_enum mmi_uc_insert_signature_file(
                                        U16 *file_path,
                                        mma_mms_slide_struct *slide,
                                        srv_uc_object_type type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_object_struct *object;
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(type);
    mma_insert_check_struct check_result;
    srv_uc_insert_signature_result_enum result = SRV_UC_INSERT_RESULT_FAIL;
    mma_insert_info_struct insert_info;
    MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(type != SRV_UC_OBJECT_TYPE_REF); /* because it's impossbile to insert a attachment to be a signature */
    object = srv_uc_check_duplicate_object(g_uc_p->main.instance, file_path);
    memset(&check_result, 0, sizeof(mma_insert_check_struct));

    if (object && object->type != MMA_MMS_OBJECT_TYPE_ATTACHMENT)
    {
        U32 obj_smil_size = 0;

        if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_SMIL_MMS)
        {
            obj_smil_size = mma_uc_calc_object_smil_size(mms_type, file_path);
        }

        if (srv_uc_check_if_exceed_MMS_size_limitation
            (g_uc_p->main.instance, obj_smil_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FILE_EXCEED_SIZE_P1, object->type);

            result = SRV_UC_INSERT_RESULT_FAIL;
        }
        else
        {
            srv_uc_insert_object_to_slide(g_uc_p->main.instance, object, slide, type);
            result = SRV_UC_INSERT_RESULT_SUCCESS;
        }
    }
    else
    {
        insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
        insert_info.current_msg_size = g_uc_p->srv_msg->msg_size;
        insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
        insert_info.insert_type = mms_type;
        insert_info.filepath = (kal_wchar*) file_path;
        insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

        mma_uc_insert_object_check(&insert_info, &check_result);

        if (!(check_result.result))
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FILE_CHECK_FAIL_P1, g_uc_p->srv_msg->msg_size);

            if (MMA_RESULT_FAIL_FILE_EMPTY == check_result.detail_result ||
                MMA_RESULT_FAIL_FILE_NOT_FOUND == check_result.detail_result ||
                MMA_RESULT_FAIL_FOLDER_NOT_FOUND == check_result.detail_result)
            {
                result = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
            }
            else
            {
                result = SRV_UC_INSERT_RESULT_FAIL;
            }
        }
        else
        {
            if (type == SRV_UC_OBJECT_TYPE_TEXT)
            {
                U8 mmi_uc_text_path[SRV_UC_MAX_TEMP_FILE_LEN];
                FS_HANDLE file_handle;
                U32 file_result = 0;
                U32 read_len = 0;
                U8 *buffer = NULL;
                wgui_uce_text_info_struct text_info;
                U32 file_size = applib_get_file_size((kal_wchar*) file_path);
                U32 buffer_size = (file_size + 1);
                U32 write_len = 0;
                U32 ucs2_buffer_size = SRV_UC_UTF8_TEXT_BUFFER_SIZE;
                U8 *ucs2_buffer = 0;

                file_handle = FS_Open((U16*) file_path, FS_READ_ONLY);
                if (file_handle <= 0)
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIG_FILE_OPEN_ERR_P1, file_handle);
                    return SRV_UC_INSERT_RESULT_FAIL;
                }
                else
                {
                    buffer = kal_adm_alloc(g_uc_p->main.mem_pool_id, buffer_size);

                    if (buffer == NULL)
                    {
                        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIG_FILE_ALLOC_ERR);
                        return SRV_UC_INSERT_RESULT_FAIL;
                    }

                    memset(buffer, 0, buffer_size);

                    file_result = FS_Read(
                                    file_handle,
                                    buffer,
                                    buffer_size - 1,    /* file_size */
                                    &read_len);

                    FS_Close(file_handle);

                    if (file_result != FS_NO_ERROR)
                    {
                        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIG_FILE_READ_ERR_P1, file_result);
                        kal_adm_free(g_uc_p->main.mem_pool_id, buffer);
                        return SRV_UC_INSERT_RESULT_FAIL;
                    }
                }

                memset(mmi_uc_text_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);
                SRV_UC_MAKE_TEXT_FILE_PATH(mmi_uc_text_path, slide->slide_num, g_uc_p->main.instance);

                file_handle = FS_Open((U16*) mmi_uc_text_path, FS_CREATE_ALWAYS | FS_READ_WRITE);
                if (file_handle <= 0)
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIG_FILE_OPEN_UC_ERR_P1, file_handle);
                    kal_adm_free(g_uc_p->main.mem_pool_id, buffer);
                    return SRV_UC_INSERT_RESULT_FAIL;
                }

                file_result = FS_Write(
                            file_handle,
                            buffer,
                            buffer_size - 1,    /* null terminator */
                            &write_len);
                FS_Close(file_handle);

                if (file_result != FS_NO_ERROR)
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIG_FILE_WRITE_UC_ERR_P1, result);
                    kal_adm_free(g_uc_p->main.mem_pool_id, buffer);
                    return SRV_UC_INSERT_RESULT_FAIL;
                }

                ucs2_buffer = applib_mem_screen_alloc(ucs2_buffer_size);
                memset(ucs2_buffer, 0, ucs2_buffer_size);
                mmi_chset_utf8_to_ucs2_string(ucs2_buffer, ucs2_buffer_size - ENCODING_LENGTH, buffer);

                mmi_uc_editor_initialize();
            #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                mmi_uc_recipient_initialize();
            #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                memset(&text_info, 0, sizeof(wgui_uce_text_info_struct));
                wgui_uce_get_text_info_for_buffer(&text_info, ucs2_buffer);

                applib_mem_screen_free(ucs2_buffer);
                mmi_uc_set_text_info_to_slide(slide, &text_info);
                object = srv_uc_insert_object(g_uc_p->main.instance, (S8*) mmi_uc_text_path, SRV_UC_OBJECT_TYPE_TEXT);
                srv_uc_insert_object_to_slide(g_uc_p->main.instance, object, slide, SRV_UC_OBJECT_TYPE_TEXT);
                result = SRV_UC_INSERT_RESULT_SUCCESS;
            }
            else
            {
                object = srv_uc_insert_object(g_uc_p->main.instance, (S8*) file_path, type);
                object->drm_type = check_result.drm_type;
                srv_uc_insert_object_to_slide(g_uc_p->main.instance, object, slide, type);
                result = SRV_UC_INSERT_RESULT_SUCCESS;
            }
        }
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_insert_signature
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_uc_insert_signature(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_slide_struct *slide;
    mma_mms_slide_struct *last_slide;
    U32 i = 1;
    U32 new_slide_size = 0;
    srv_uc_insert_signature_result_enum insert_file_result = SRV_UC_INSERT_RESULT_SUCCESS;
    MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->srv_msg->signature_in_last_slide = MMI_FALSE;

    if (g_uc_p->srv_msg->signature_inserted)
    {
        return MMI_TRUE;
    }

	if(g_uc_p->srv_mms_info->signature.img_file)
	{
		if(!(mmi_uc_is_valid_image(g_uc_p->srv_mms_info->signature.img_file)))
		{
			g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FAIL;
			return MMI_FALSE;
		}
	}

    if (g_uc_p->srv_msg->msg_body.slide_no == SRV_UC_MAX_MMS_SLIDE_NUM)
    {
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FAIL;
        return MMI_FALSE;
    }

    if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_SMIL_MMS)
    {
        new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
    }
    if (srv_uc_check_if_exceed_MMS_size_limitation
        (g_uc_p->main.instance, new_slide_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
    {
        MMI_TRACE(
            MMI_COMMON_TRC_G6_MSG,
            TRC_MMI_UC_INSERT_SIGNATURE_EXCEED_P2,
            new_slide_size,
            g_uc_p->srv_msg->msg_size);
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FAIL;
        return MMI_FALSE;
    }

    for (last_slide = g_uc_p->srv_msg->msg_body.slides; last_slide->next != NULL; last_slide = last_slide->next)
    {
        i++;
    }
    MMI_ASSERT(i == g_uc_p->srv_msg->msg_body.slide_no);

    slide = srv_uc_insert_slide(g_uc_p->main.instance, last_slide);
    srv_uc_update_msg_size(g_uc_p->main.instance);

    if (g_uc_p->srv_mms_info->signature.img_file)
    {
        /* If return value is SRV_UC_INSERT_RESULT_FILE_NOT_EXIST, still continue insert signature */
        insert_file_result = mmi_uc_insert_signature_file(
                                g_uc_p->srv_mms_info->signature.img_file,
                                slide,
                                SRV_UC_OBJECT_TYPE_IMAGE);

        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_IMG);
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            g_uc_p->srv_msg->signature_in_last_slide = MMI_TRUE;
        }
    }

    if (g_uc_p->srv_mms_info->signature.audio_file)
    {
        insert_file_result = mmi_uc_insert_signature_file(
                                g_uc_p->srv_mms_info->signature.audio_file,
                                slide,
                                SRV_UC_OBJECT_TYPE_AUDIO);
        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_AUDIO);
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            g_uc_p->srv_msg->signature_in_last_slide = MMI_TRUE;
        }

    }

    if (g_uc_p->srv_mms_info->signature.video_file)
    {
        insert_file_result = mmi_uc_insert_signature_file(
                                g_uc_p->srv_mms_info->signature.video_file,
                                slide,
                                SRV_UC_OBJECT_TYPE_VIDEO);
        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_VIDEO);
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            g_uc_p->srv_msg->signature_in_last_slide = MMI_TRUE;
        }
    }

    if (g_uc_p->srv_mms_info->signature.text_file)
    {
        insert_file_result = mmi_uc_insert_signature_file(
                                g_uc_p->srv_mms_info->signature.text_file,
                                slide,
                                SRV_UC_OBJECT_TYPE_TEXT);
        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_TEXT);
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            g_uc_p->srv_msg->signature_in_last_slide = MMI_TRUE;
        }
    }
    if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == g_uc_p->srv_msg->fail_to_insert_signature &&
        g_uc_p->srv_msg->signature_in_last_slide == MMI_FALSE)
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_TEXT);
        srv_uc_delete_slide_with_object(g_uc_p->main.instance, slide);
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FAIL;
        srv_uc_update_msg_size(g_uc_p->main.instance);
        g_uc_p->srv_msg->signature_in_last_slide = MMI_FALSE;   /* because the slide is deleted */
        return MMI_FALSE;
    }
    if (g_uc_p->srv_msg->fail_to_insert_signature != SRV_UC_INSERT_RESULT_FILE_NOT_EXIST)
    {
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_SUCCESS;
    }

    g_uc_p->srv_msg->auto_signature_inserted = MMI_TRUE; 
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_match_object_id
 * DESCRIPTION
 *  Match object id after parsing xml file
 * PARAMETERS
 *  void
 *  character(?)        [IN]        
 *  S8 ascii values(?)(?)
 * RETURNS
 *  U8 Decimal value.
 *****************************************************************************/
S32 mmi_uc_match_object_id(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_slide_struct *cur_slide = g_uc_p->srv_msg->msg_body.slides;
    U32 slide_num = 0;
    U32 temp_size = 0;
    S32 fs_status = FS_NO_ERROR;
    mma_mms_object_struct *cur_object = NULL;

#ifdef __MMI_MMS_POSTCARD__
    applib_oppostcard_mem_func_struct *mem_func;

    mem_func = kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(applib_oppostcard_mem_func_struct));
    mem_func->alloc_fn = mmi_uc_srv_alloc_mem_cbk;
    mem_func->free_fn = mmi_uc_srv_free_mem_cbk;
#endif /* __MMI_MMS_POSTCARD__ */ 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (; cur_slide != NULL; cur_slide = cur_slide->next, slide_num++)
    {

        if (cur_slide->txt.id)
        {
            wgui_uce_text_info_struct text_info;
            U8 mmi_uc_text_path[SRV_UC_MAX_TEMP_FILE_LEN];
            U8 virtual_file_name[(FS_GenVFN_SIZE + 1) * ENCODING_LENGTH];
            S32 ori_file_handle;
            S32 result;
            U8 *file_name;

        #ifdef __MMI_MMS_2__
            S32 start_time = cur_slide->txt.begin;
            S32 end_time = cur_slide->txt.end;
        #endif /* __MMI_MMS_2__ */ 
            U32 bg_color = cur_slide->txt.bg_color;
            U32 fg_color = cur_slide->txt.fg_color;
            U16 file_path_len = 0;
            U16 file_name_len = 0;
			U16 msg_char_count = 0 ;

            memset(mmi_uc_text_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);
            SRV_UC_MAKE_TEXT_FILE_PATH(mmi_uc_text_path, cur_slide->slide_num, g_uc_p->main.instance);

            /* the object maybe reomoved because creation mode (reference and removed in previous slide) */
            cur_object = srv_uc_get_object_by_id(g_uc_p->main.instance, cur_slide->txt.id);

            if (cur_object == NULL) /* the object is removed from object list when handling previous page--creation mode */
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_ALREADY_REMOVED_TEXT);
                memset(&(cur_slide->txt), 0, sizeof(mma_mms_slide_object_struct));
                return FS_ERROR_RESERVED;
            }
            else if (cur_object->reference_count > 0)   /* same text obj is refered more than once */
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REF_MORE_TEXT);
                memset(&(cur_slide->txt), 0, sizeof(mma_mms_slide_object_struct));
                return FS_ERROR_RESERVED;
            }
        #ifdef __MMI_MMS_2__
            /* first handled and object exists */
            else if (MMI_FALSE == srv_uc_check_virtual_file_object_for_creation_mode(
                                    g_uc_p->main.instance,
                                    cur_object,
                                    SRV_UC_OBJECT_TYPE_TEXT))
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_FIRST_HANDLED_TEXT);
                srv_uc_delete_object_from_list(g_uc_p->main.instance, cur_object);
                memset(&(cur_slide->txt), 0, sizeof(mma_mms_slide_object_struct));
            }
        #endif /* __MMI_MMS_2__ */ 
            else    /* already handled before and passed creation mode check */
            {

                /* when app trigger UC for postcard mode, will fill correct MMS_edit_mode */
            #ifdef __MMI_MMS_POSTCARD__
                if (g_uc_p->srv_msg_type->MMS_edit_mode == SRV_UC_MMS_EDIT_MODE_POSTCARD_MMS)
                {

                    kal_char *greeting_tmp = NULL;

                    MMI_ASSERT(cur_slide->txt.object->encoding == MMA_CHARSET_UTF8 ||
                               cur_slide->txt.object->encoding == MMA_CHARSET_ASCII);
                    srv_uc_reset_text_buffer(g_uc_p->main.instance);

                    if (cur_slide->txt.object->is_virtual_file)
                    {
                        ori_file_handle = FS_Open(cur_slide->txt.object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                        if (ori_file_handle <= 0)
                        {
                            MMI_ASSERT(0);
                            return ori_file_handle;
                        }

                        result = FS_GenVirtualFileName(
                                    ori_file_handle,
                                    (U16*) virtual_file_name,
                                    (unsigned int)FS_GenVFN_SIZE,
                                    cur_slide->txt.object->offset,
                                    cur_slide->txt.object->size);

                        if (result < 0)
                        {
                            MMI_ASSERT(0);
                            return result;
                        }
                        mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
                        if (srv_uc_get_file_extension(cur_slide->txt.object->file_name_ucs))
                        {
                            mmi_ucs2ncat(
                                (PS8) virtual_file_name,
                                (PS8) srv_uc_get_file_extension(cur_slide->txt.object->file_name_ucs),
                                sizeof(virtual_file_name) / ENCODING_LENGTH);
                        }
                        applib_oppostcard_decode_text_content(
                            mem_func,
                            (const kal_wchar*)virtual_file_name,
                            &greeting_tmp,
                            (void*)&(g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_head));
                        srv_postcard_count_recipients(g_uc_p->main.instance);
                        FS_Close(ori_file_handle);
                    }
                    else
                    {
                        applib_oppostcard_decode_text_content(
                            mem_func,
                            cur_slide->txt.object->file_path_ucs,
                            &greeting_tmp,
                            (void*)&(g_uc_p->srv_msg->msg_body.postcard_recipient_info.recipient_head));
                        srv_postcard_count_recipients(g_uc_p->main.instance);
                    }
                    /* copy buffer by my self */
                    if (mmi_ucs2strlen((S8*) greeting_tmp) * ENCODING_LENGTH < sizeof(g_uc_p->srv_main->text_buffer))
                    {
                        mmi_ucs2cpy((S8*) g_uc_p->srv_main->text_buffer, (S8*) greeting_tmp);
                    }
                    else
                    {
                        mmi_ucs2ncpy(
                            (S8*) g_uc_p->srv_main->text_buffer,
                            (S8*) greeting_tmp,
                            sizeof(g_uc_p->srv_main->text_buffer) / ENCODING_LENGTH);
                    }
                    mem_func->free_fn(greeting_tmp, NULL);
                    kal_adm_free(g_uc_p->main.mem_pool_id, mem_func);
                }
                else
            #endif /* __MMI_MMS_POSTCARD__ */ 
                if (cur_slide->txt.object->is_virtual_file)
                {
                    ori_file_handle = FS_Open(cur_slide->txt.object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);

                    if (ori_file_handle <= 0)
                    {
                        MMI_ASSERT(0);
                        return ori_file_handle;
                    }

                    result = FS_GenVirtualFileName(
                                ori_file_handle,
                                (U16*) virtual_file_name,
                                (unsigned int)FS_GenVFN_SIZE,
                                cur_slide->txt.object->offset,
                                cur_slide->txt.object->size);

                    if (result < 0)
                    {
                        MMI_ASSERT(0);
                        return result;
                    }

                    srv_uc_read_file_to_text_buffer(
                        g_uc_p->main.instance,
                        virtual_file_name,
                        cur_slide->txt.object->encoding);

                    FS_Close(ori_file_handle);

                }
                else
                {
                    srv_uc_read_file_to_text_buffer(g_uc_p->main.instance, (U8*) cur_slide->txt.object->file_path_ucs, 0);
                }
				msg_char_count =  mmi_ucs2strlen((CHAR*)g_uc_p->srv_main->text_buffer) ;

				if(msg_char_count == 0)
				{
					srv_uc_delete_object_from_list(g_uc_p->main.instance, cur_object);
					memset(&(cur_slide->txt), 0, sizeof(mma_mms_slide_object_struct));
				}
				else
				{
					srv_uc_insert_object_to_slide(g_uc_p->main.instance, cur_object, cur_slide, SRV_UC_OBJECT_TYPE_TEXT);
					cur_slide->txt.object->type = SRV_UC_OBJECT_TYPE_TEXT;

					#ifdef __MMI_MMS_2__
					if (start_time != 0 || end_time != 0)
					{
						cur_slide->txt.begin = start_time;
						cur_slide->txt.end = end_time;
					}
					#endif /* __MMI_MMS_2__ */ 

					cur_slide->txt.bg_color = bg_color;
					cur_slide->txt.fg_color = fg_color;

					MMI_ASSERT(cur_slide->txt.object->file_path_ucs);

                memset(&text_info, 0, sizeof(wgui_uce_text_info_struct));
                wgui_uce_get_text_info_for_buffer(&text_info, g_uc_p->srv_main->text_buffer);

                mmi_uc_set_text_info_to_slide(cur_slide, &text_info);

                /* should not return here, or the fle name will not be updated to UC's path. If srv_uc_reset_msg is called
                   will remove mms real body */
                result = srv_uc_save_buffer_to_file(
                            g_uc_p->main.instance,
                            mmi_uc_text_path,
                            g_uc_p->srv_main->text_buffer,
                            text_info.char_count);

                cur_slide->txt.object->encoding = MMA_CHARSET_UTF8;    /* because the text's encode already UTF8 when srv_uc_save_buffer_to_file to file */
                /* file path */
                kal_adm_free(g_uc_p->main.mem_pool_id, cur_slide->txt.object->file_path_ucs);
                file_path_len = mmi_ucs2strlen((S8*) mmi_uc_text_path);
                cur_slide->txt.object->file_path_ucs = kal_adm_alloc(g_uc_p->main.mem_pool_id, (file_path_len + 1) * 2);
                MMI_ASSERT(cur_slide->txt.object->file_path_ucs);
                memset(cur_slide->txt.object->file_path_ucs, 0, (file_path_len + 1) * 2);
                mmi_ucs2ncpy((S8*) cur_slide->txt.object->file_path_ucs, (S8*) mmi_uc_text_path, file_path_len);

                /* file name */
                if (cur_slide->txt.object->file_name_ucs)
                {
                    kal_adm_free(g_uc_p->main.mem_pool_id, cur_slide->txt.object->file_name_ucs);
                }
                file_name = (U8*) srv_uc_get_file_name((U16*) mmi_uc_text_path);
                file_name_len = mmi_ucs2strlen((S8*) file_name);
                cur_slide->txt.object->file_name_ucs = kal_adm_alloc(g_uc_p->main.mem_pool_id, (file_name_len + 1) * 2);
                MMI_ASSERT(cur_slide->txt.object->file_name_ucs);
                memset(cur_slide->txt.object->file_name_ucs, 0, (file_name_len + 1) * 2);
                mmi_ucs2ncpy((S8*) cur_slide->txt.object->file_name_ucs, (S8*) file_name, file_name_len);

                cur_slide->txt.object->offset = 0;
                temp_size = applib_get_file_size((kal_wchar*) cur_slide->txt.object->file_path_ucs);
                if (temp_size < cur_slide->txt.object->size &&
                    text_info.char_count == SRV_UC_MAX_CHAR_NUM_IN_ONE_SLIDE)
                {
                    g_uc_p->srv_send_info->content_truncated_type |= SRV_UC_TRUNCATED_TYPE_TEXT;
                }
                cur_slide->txt.object->size = temp_size;
                cur_slide->txt.object->drm_type = MMA_DRM_NONE;
                cur_slide->txt.object->is_virtual_file = MMI_FALSE;
                if (result != FS_NO_ERROR)
                {
                    fs_status = result;
                }
            }
        }
		}

        if (cur_slide->img.id)
        {
            cur_object = srv_uc_get_object_by_id(g_uc_p->main.instance, cur_slide->img.id);

            if (cur_object != NULL)
            {
            #ifdef __MMI_MMS_2__
                if (MMI_FALSE == srv_uc_check_virtual_file_object_for_creation_mode(
                                    g_uc_p->main.instance,
                                    cur_object,
                                    SRV_UC_OBJECT_TYPE_IMAGE))
                {

                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_IMG);
                    srv_uc_delete_object_from_list(g_uc_p->main.instance, cur_object);
                    memset(&(cur_slide->img), 0, sizeof(mma_mms_slide_object_struct));
                }
                else
            #endif /* __MMI_MMS_2__ */ 
                {
                #ifdef __MMI_MMS_2__
                    S32 start_time = cur_slide->img.begin;
                    S32 end_time = cur_slide->img.end;
                #endif /* __MMI_MMS_2__ */ 

                    srv_uc_insert_object_to_slide(
                        g_uc_p->main.instance,
                        cur_object,
                        cur_slide,
                        SRV_UC_OBJECT_TYPE_IMAGE);
                    cur_slide->img.object->type = SRV_UC_OBJECT_TYPE_IMAGE;

                #ifdef __MMI_MMS_2__
                    if (start_time != 0 || end_time != 0)
                    {
                        cur_slide->img.begin = start_time;
                        cur_slide->img.end = end_time;
                    }
                #endif /* __MMI_MMS_2__ */ 

                }
            }
            else    /* the object is removed from object list when handling previous page--creation mode */
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_BEFORE_IMG);
                memset(&(cur_slide->img), 0, sizeof(mma_mms_slide_object_struct));
            }
        }
        if (cur_slide->aud.id)
        {
            cur_object = srv_uc_get_object_by_id(g_uc_p->main.instance, cur_slide->aud.id);

            if (cur_object != NULL)
            {
            #ifdef __MMI_MMS_2__
                if (MMI_FALSE == srv_uc_check_virtual_file_object_for_creation_mode(
                                    g_uc_p->main.instance,
                                    cur_object,
                                    SRV_UC_OBJECT_TYPE_AUDIO))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_AUDIO);
                    srv_uc_delete_object_from_list(g_uc_p->main.instance, cur_object);
                    memset(&(cur_slide->aud), 0, sizeof(mma_mms_slide_object_struct));
                }
                else
            #endif /* __MMI_MMS_2__ */ 
                {
                #ifdef __MMI_MMS_2__
                    S32 start_time = cur_slide->aud.begin;
                    S32 end_time = cur_slide->aud.end;
                #endif /* __MMI_MMS_2__ */ 

                    srv_uc_insert_object_to_slide(
                        g_uc_p->main.instance,
                        cur_object,
                        cur_slide,
                        SRV_UC_OBJECT_TYPE_AUDIO);
                    cur_slide->aud.object->type = SRV_UC_OBJECT_TYPE_AUDIO;

                #ifdef __MMI_MMS_2__
                    if (start_time != 0 || end_time != 0)
                    {
                        cur_slide->aud.begin = start_time;
                        cur_slide->aud.end = end_time;
                    }
                #endif /* __MMI_MMS_2__ */ 
                }
            }
            else    /* the object is removed from object list when handling previous page--creation mode */
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_AUDIO);
                memset(&(cur_slide->aud), 0, sizeof(mma_mms_slide_object_struct));
            }
        }
        if (cur_slide->vid.id)
        {
            cur_object = srv_uc_get_object_by_id(g_uc_p->main.instance, cur_slide->vid.id);

            if (cur_object != NULL)
            {
            #ifdef __MMI_MMS_2__
                if (MMI_FALSE == srv_uc_check_virtual_file_object_for_creation_mode(
                                    g_uc_p->main.instance,
                                    cur_object,
                                    SRV_UC_OBJECT_TYPE_VIDEO))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_VEDIO);
                    srv_uc_delete_object_from_list(g_uc_p->main.instance, cur_object);
                    memset(&(cur_slide->vid), 0, sizeof(mma_mms_slide_object_struct));
                }
                else
            #endif /* __MMI_MMS_2__ */ 
                {
                #ifdef __MMI_MMS_2__
                    S32 start_time = cur_slide->vid.begin;
                    S32 end_time = cur_slide->vid.end;
                #endif /* __MMI_MMS_2__ */ 

                    srv_uc_insert_object_to_slide(
                        g_uc_p->main.instance,
                        cur_object,
                        cur_slide,
                        SRV_UC_OBJECT_TYPE_VIDEO);
                    cur_slide->vid.object->type = SRV_UC_OBJECT_TYPE_VIDEO;

                #ifdef __MMI_MMS_2__
                    if (start_time != 0 || end_time != 0)
                    {
                        cur_slide->vid.begin = start_time;
                        cur_slide->vid.end = end_time;
                    }
                #endif /* __MMI_MMS_2__ */ 
                }
            }
            else
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_BEFORE_VEDIO);
                memset(&(cur_slide->vid), 0, sizeof(mma_mms_slide_object_struct));
            }
        }

        /* ref */
        {
            mma_mms_slide_ref_object_struct *cur_ref = cur_slide->ref_items;
            mma_mms_slide_ref_object_struct *next_ref = NULL;

            while (cur_ref)
            {
                cur_object = srv_uc_get_object_by_id(g_uc_p->main.instance, cur_ref->id);

                if (cur_object != NULL)
                {
                #ifdef __MMI_MMS_2__
                    /* ref will be treated as attachment */
                    if (MMI_FALSE == srv_uc_check_virtual_file_object_for_creation_mode(
                                        g_uc_p->main.instance,
                                        cur_object,
                                        SRV_UC_OBJECT_TYPE_ATTACHMENT))
                    {
                        /* MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_REF); */
                        /* remove it from object list */
                        srv_uc_delete_object_from_list(g_uc_p->main.instance, cur_object);
                        /* remove it from slide structure */
                        if (cur_slide->ref_items == cur_ref)
                        {
                            cur_slide->ref_items = cur_ref->next;

                            if (cur_ref->next)
                            {
                                cur_ref->next->prev = NULL;
                            }
                            g_uc_p->srv_msg->msg_body.total_attach_no--;
                            next_ref = cur_ref->next;
                            kal_adm_free(g_uc_p->main.mem_pool_id, cur_ref);
                        }
                        else
                        {
                            next_ref = cur_ref->next;
                            srv_uc_delete_ref_obj_info_from_list(g_uc_p->main.instance, cur_ref);
                        }

                    }
                    else
                #endif /* __MMI_MMS_2__ */ 
                    {
                    #ifdef __MMI_MMS_2__
                        S32 start_time = cur_ref->begin;
                        S32 end_time = cur_ref->end;
                    #endif /* __MMI_MMS_2__ */ 
                        /* associate obj(in slide) to obj(in obj list) */
                        cur_ref->object = cur_object;
                        cur_ref->begin = SRV_UC_INVALID_VALUE;
                        cur_ref->end = SRV_UC_INVALID_VALUE;
                        cur_object->reference_count++;
                        cur_ref->object->type = SRV_UC_OBJECT_TYPE_REF;

                    #ifdef __MMI_MMS_2__
                        if (start_time != 0 || end_time != 0)
                        {
                            cur_ref->begin = start_time;
                            cur_ref->end = end_time;
                        }
                    #endif /* __MMI_MMS_2__ */ 
                        next_ref = cur_ref->next;
                    }
                }
                else
                {
                    /* MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_BEFORE_VEDIO); */
                    /* remove it from slide sturture. because can not find the mapping */
                    if (cur_slide->ref_items == cur_ref)
                    {
                        cur_slide->ref_items = cur_ref->next;

                        if (cur_ref->next)
                        {
                            cur_ref->next->prev = NULL;
                        }

                        g_uc_p->srv_msg->msg_body.total_attach_no--;

                        next_ref = cur_ref->next;
                        kal_adm_free(g_uc_p->main.mem_pool_id, cur_ref);
                    }
                    else
                    {
                        next_ref = cur_ref->next;
                        srv_uc_delete_ref_obj_info_from_list(g_uc_p->main.instance, cur_ref);
                    }
                }
                cur_ref = next_ref;
            }

        }   /* ref */

        if (g_uc_p->srv_msg->msg_body.layout == MMA_LAYOUT_NONE)
        {
            if (cur_slide->img.object || cur_slide->vid.object)
            {
                g_uc_p->srv_msg->msg_body.layout = MMA_LAYOUT_IMAGE_ON_TOP;
            }
        }
    }

    MMI_ASSERT(slide_num == g_uc_p->srv_msg->msg_body.slide_no);

#ifdef __MMI_MMS_2__
    {
        mma_mms_attachment_info_struct *cur_attach = g_uc_p->srv_msg->msg_body.attachment;

        for (; cur_attach != NULL; cur_attach = cur_attach->next)
        {
            cur_object = cur_attach->object;
            if (MMI_FALSE == srv_uc_check_virtual_file_object_for_creation_mode(
                                g_uc_p->main.instance,
                                cur_attach->object,
                                SRV_UC_OBJECT_TYPE_ATTACHMENT))
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_MATCH_OBJ_ID_REMOVE_ATTACH);
                srv_uc_delete_object_from_list(g_uc_p->main.instance, cur_object);
                srv_uc_delete_attachment_from_list(g_uc_p->main.instance, cur_attach);
            }
        }
    }
#endif /* __MMI_MMS_2__ */ 
    return fs_status;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_text_info_for_buffer
 * DESCRIPTION
 *  get the text info of buffer
 * PARAMETERS
 *  text_info       [?]     
 *  text_buffer     [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_get_text_info_for_buffer(wgui_uce_text_info_struct *text_info, U8 *text_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_7bit_counter_struct *count_info;
    U32 counter;
    U16 tmp_char;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    text_info->char_count = mmi_ucs2strlen((S8*) text_buffer);
    mmi_7bit_counter_init((U8*) text_buffer);
    count_info = mmi_7bit_counter_get_info();
    text_info->UCS2_count = count_info->ucs2_count;
    text_info->extension_char_count = count_info->gsm_ext_count;

    for (counter = 0; counter < (text_info->char_count * ENCODING_LENGTH); counter += ENCODING_LENGTH)
    {
        tmp_char = ((U16) text_buffer[counter + 1] << 8) | ((U8) text_buffer[counter]);
        text_info->utf8_msg_len += app_unicode_to_utf8_len(tmp_char);
    }
    mmi_7bit_counter_init((U8*) g_uc_p->srv_main->text_buffer);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_check_insert_text
 * DESCRIPTION
 *  check whether text can be inserted into editor or not
 * PARAMETERS
 *  string      [?]     
 * RETURNS
 *  U8
 *****************************************************************************/
MMI_BOOL mmi_uc_check_insert_text(U8 *string)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_text_info_struct text_info, new_text_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&text_info, 0, sizeof(wgui_uce_text_info_struct));
    mmi_uc_get_text_info_for_buffer(&text_info, string);
    new_text_info.char_count = g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count + text_info.char_count;
    new_text_info.UCS2_count = g_uc_p->srv_msg->msg_body.curr_slide->txt.UCS2_count + text_info.UCS2_count;
    new_text_info.extension_char_count =
        g_uc_p->srv_msg->msg_body.curr_slide->txt.extension_char_count + text_info.extension_char_count;
    new_text_info.utf8_msg_len = g_uc_p->srv_msg->msg_body.curr_slide->txt.utf8_msg_len + text_info.utf8_msg_len;

    if (new_text_info.char_count > SRV_UC_MAX_CHAR_NUM_IN_ONE_SLIDE)
    {
        return MMI_FALSE;
    }
#ifdef __MMI_MMS_POSTCARD__
    else if ((g_uc_p->srv_msg_type->MMS_edit_mode == SRV_UC_MMS_EDIT_MODE_POSTCARD_MMS) &&
             (new_text_info.char_count > SRV_POSTCARD_MAX_GREETING))
    {
        return MMI_FALSE;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 
    else
    {
        if (g_uc_p->srv_msg_type->caller_specific_msg_type == SRV_UC_MSG_TYPE_SMS_ONLY)
        {
        #ifndef __MMI_MMS_STANDALONE_COMPOSER__
            if (new_text_info.UCS2_count > 0)
            {
                if (new_text_info.char_count > (srv_sms_get_usable_text_len(SMSAL_UCS2_DCS) / 2))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_CHECK_INSERT_TEXT_UCS2_TEXT_SIZE_EXCEED);
                    return MMI_FALSE;
                }
            }
            else
            {
                if (new_text_info.char_count + new_text_info.extension_char_count >
                    (srv_sms_get_usable_text_len(SMSAL_DEFAULT_DCS) / 2))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_CHECK_INSERT_TEXT_ASCII_TEXT_SIZE_EXCEED);
                    return MMI_FALSE;
                }
            }
        #else /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
            MMI_ASSERT(0);
        #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
        }

        if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count == 0)
            {
                U8 mmi_uc_text_path[SRV_UC_MAX_TEMP_FILE_LEN];
                U32 text_obj_size = 0;

                memset(mmi_uc_text_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);
                SRV_UC_MAKE_TEXT_FILE_PATH(mmi_uc_text_path, g_uc_p->srv_msg->current_slide_num, g_uc_p->main.instance);
                if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_SMIL_MMS)
                {
                    text_obj_size = mma_uc_calc_object_smil_size(MMA_INSERT_TEXT, (U16*) mmi_uc_text_path);
                }
                text_obj_size += mma_uc_calc_object_multipart_size((U16*) mmi_uc_text_path);

                if ((g_uc_p->srv_msg->msg_size + text_obj_size + new_text_info.utf8_msg_len) >
                    g_uc_p->srv_mms_info->max_mms_size)
                {
                    MMI_TRACE(
                        MMI_COMMON_TRC_G6_MSG,
                        TRC_MMI_UC_CHECK_INSERT_TEXT_MMS_SIZE_EXCEED_0_P3,
                        g_uc_p->srv_msg->msg_size,
                        text_obj_size,
                        g_uc_p->srv_msg->msg_body.curr_slide->txt.utf8_msg_len);
                    return MMI_FALSE;
                }
            }
            else
            {
                if ((g_uc_p->srv_msg->msg_size_without_text_buffer + new_text_info.utf8_msg_len +
                     mma_uc_calc_text_uintvar_overhead_size(new_text_info.utf8_msg_len)) >
                    g_uc_p->srv_mms_info->max_mms_size)
                {
                    MMI_TRACE(
                        MMI_COMMON_TRC_G6_MSG,
                        TRC_MMI_UC_CHECK_INSERT_TEXT_MMS_SIZE_EXCEED_P2,
                        g_uc_p->srv_msg->msg_size_without_text_buffer,
                        g_uc_p->srv_msg->msg_body.curr_slide->txt.utf8_msg_len);
                    return MMI_FALSE;
                }
            }
        }
    }
    return MMI_TRUE;
}


#if defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_add_object_selection
 * DESCRIPTION
 *  Entry function of write message for supporting postcard feature.
 * NA
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_entry_add_object_selection(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_exit_write_msg();
    /* srv_uc_update_msg_size(g_uc_p->main.instance); */
    if (g_uc_p->srv_main->current_text_file_save_result == FS_NO_ERROR)
    {
        srv_uc_update_msg_size(g_uc_p->main.instance);
        if (g_uc_p->main.uc_cui_gid != GRP_ID_UNIFIED_COMPOSER_MENU_CUI)
        {
	        g_uc_p->main.parent_grp_id = g_uc_p->main.uc_cui_gid;
	        g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
	                g_uc_p->main.parent_grp_id, GRP_ID_UNIFIED_COMPOSER_MENU_CUI, mmi_uc_add_media_proc, (void*)NULL); 
	        mmi_frm_group_enter(g_uc_p->main.uc_cui_gid , MMI_FRM_NODE_SMART_CLOSE_FLAG);
        }
        mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_ADD_OBJECT);
    }
    else
    {
        if (g_uc_p->srv_main->current_text_file_save_result == FS_DISK_FULL)
        {
            mmi_popup_display((WCHAR*)(get_string(STR_GLOBAL_NOT_ENOUGH_MEMORY)), MMI_EVENT_FAILURE, NULL);
        }
        else
        {
            mmi_popup_display((WCHAR*)(get_string(srv_fmgr_fs_error_get_string(g_uc_p->srv_main->current_text_file_save_result))), MMI_EVENT_FAILURE, NULL);
        }
    }
    return;
}
#endif

#ifndef __MMI_SLIM_MMS_2__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_signature_manually
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_signature_manually(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_process_manual_insert_signature();
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIG_CONFIRM);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_signature_manually_back
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_signature_manually_back(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_SIG_CONFIRM);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_signature
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_signature(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->srv_msg->signature_inserted = MMI_FALSE;
    pass_sig_check = mmi_uc_manual_insert_signature_check();
    if (MMI_UC_INSERT_SIG_RESULT_WARNING == pass_sig_check)
    {
        mmi_uc_sig_setSoftkeyFunction(mmi_uc_add_signature_manually, mmi_uc_add_signature_manually_back, (U8)mmi_get_event_based_sound(MMI_EVENT_QUERY));
        mmi_uc_entry_sig_displayConfirm();
    }
    else
    {
        mmi_uc_add_signature_manually();
    }
	mmi_uc_set_group_id();
}

/*****************************************************************************
* FUNCTION
*  mmi_uc_manual_insert_signature_check
* DESCRIPTION
*  Check if it is needed to insert signature, if need, check if need popup warning mode confirm popup
*  in this API. not insert signature object.
* PARAMETERS
*  void
* RETURNS
*  mmi_uc_insert_sig_result_enum
* MMI_UC_INSERT_SIG_RESULT_WARNING: FALSE means need popup 
* MMI_UC_INSERT_SIG_RESULT_PASS: mean NO need popup confirm, and signature is added successfully
* MMI_UC_INSERT_SIG_RESULT_INSERT_OBJ_FAIL, pass but insert sig fail 
*****************************************************************************/
mmi_uc_insert_sig_result_enum mmi_uc_manual_insert_signature_check(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*aviod similar case like -- forward a sms / add subject / but forward won't add sig/ 
      should not popup warning mode check for sig to avoid user to misunderstand*/
#ifdef __MMI_MMS_POSTCARD__
    /*Won't add signature if the current editing msg is postcard*/
    if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        return MMI_UC_INSERT_SIG_RESULT_PASS;
    }
#endif /*__MMI_MMS_POSTCARD__*/    
    if (MMI_TRUE == srv_uc_signature_pass_warning_mode_content_check(g_uc_p->main.instance))
    {
        if (!mmi_uc_process_manual_insert_signature())
        {
            return MMI_UC_INSERT_SIG_RESULT_INSERT_OBJ_FAIL;
        }
    }
    else 
    {
        return MMI_UC_INSERT_SIG_RESULT_WARNING;
    }
    return MMI_UC_INSERT_SIG_RESULT_PASS;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_manual_insert_signature
 * DESCRIPTION
 *  insert signature
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_manual_insert_signature(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_mms_slide_struct* slide;
    mma_mms_slide_struct* last_slide;
    U32 i = 1;
    U32 new_slide_size = 0;
    srv_uc_insert_signature_result_enum insert_file_result = SRV_UC_INSERT_RESULT_SUCCESS;
    MMI_BOOL fail_in_restricted_size_check = MMI_FALSE;
    MMI_BOOL signature_in_last_slide = MMI_FALSE;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (g_uc_p->srv_msg->signature_inserted)
    {
        return MMI_TRUE;
    }
    
    if (g_uc_p->srv_msg->msg_body.slide_no == SRV_UC_MAX_MMS_SLIDE_NUM)
    {
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FAIL;
        return MMI_FALSE;
    }

    if (srv_uc_get_mms_type(g_uc_p->main.instance) == MMA_MMS_TYPE_SMIL_MMS)
    {
        new_slide_size = mma_uc_calc_slide_smil_size(g_uc_p->srv_msg->slide_timing);
    }
    if (srv_uc_check_if_exceed_MMS_size_limitation(g_uc_p->main.instance, new_slide_size + g_uc_p->srv_msg->msg_size, &fail_in_restricted_size_check))
    {    
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_EXCEED_P2,new_slide_size,g_uc_p->srv_msg->msg_size);
        
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FAIL;
        return MMI_FALSE;
    }
                
    for (last_slide = g_uc_p->srv_msg->msg_body.slides; last_slide->next != NULL ; last_slide = last_slide->next)
    {
        i++;
    }
    MMI_ASSERT( i == g_uc_p->srv_msg->msg_body.slide_no);
    
    slide = srv_uc_insert_slide(g_uc_p->main.instance, last_slide);
    srv_uc_update_msg_size(g_uc_p->main.instance);
    
    if (g_uc_p->srv_mms_info->signature.img_file)
    {
        /* If return value is SRV_UC_INSERT_RESULT_FILE_NOT_EXIST, still continue insert signature*/
        insert_file_result = mmi_uc_insert_signature_file(g_uc_p->srv_mms_info->signature.img_file, 
                                          slide, 
                                          SRV_UC_OBJECT_TYPE_IMAGE) ;

        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_IMG);
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            signature_in_last_slide = MMI_TRUE;
        }
    }

    if (g_uc_p->srv_mms_info->signature.audio_file)
    {
        insert_file_result = mmi_uc_insert_signature_file(g_uc_p->srv_mms_info->signature.audio_file, 
                                          slide, 
                                          SRV_UC_OBJECT_TYPE_AUDIO);
        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_AUDIO);
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }        
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            signature_in_last_slide = MMI_TRUE;
        }

    }
    
    if (g_uc_p->srv_mms_info->signature.video_file)
    {
        insert_file_result = mmi_uc_insert_signature_file(g_uc_p->srv_mms_info->signature.video_file,
                                          slide, 
                                          SRV_UC_OBJECT_TYPE_VIDEO);
        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_VIDEO);
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }        
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            signature_in_last_slide = MMI_TRUE;
        }

    }    

    if (g_uc_p->srv_mms_info->signature.text_file)
    {
        insert_file_result = mmi_uc_insert_signature_file(g_uc_p->srv_mms_info->signature.text_file, 
                                          slide, 
                                          SRV_UC_OBJECT_TYPE_TEXT);
        if (SRV_UC_INSERT_RESULT_FAIL == insert_file_result)
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_TEXT);

            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }        
        else if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == insert_file_result)
        {
            g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FILE_NOT_EXIST;
        }
        else
        {
            srv_uc_update_msg_size(g_uc_p->main.instance);
            signature_in_last_slide = MMI_TRUE;
        }

    }        
    if (SRV_UC_INSERT_RESULT_FILE_NOT_EXIST == g_uc_p->srv_msg->fail_to_insert_signature &&
            signature_in_last_slide == MMI_FALSE)
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_INSERT_SIGNATURE_FAIL_TEXT);
        srv_uc_delete_slide_with_object(g_uc_p->main.instance, slide);
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_FAIL;
        srv_uc_update_msg_size(g_uc_p->main.instance);
        signature_in_last_slide = MMI_FALSE; /*because the slide is deleted*/
        return MMI_FALSE;
    }
    if (g_uc_p->srv_msg->fail_to_insert_signature != SRV_UC_INSERT_RESULT_FILE_NOT_EXIST)
    {
        g_uc_p->srv_msg->fail_to_insert_signature = SRV_UC_INSERT_RESULT_SUCCESS;
    }
    g_uc_p->srv_msg->signature_inserted = MMI_TRUE;
    g_uc_p->srv_msg->auto_signature_inserted = MMI_TRUE; /* To avoid switch to MMS case */
    g_uc_p->srv_msg->signature_in_last_slide = MMI_TRUE;
    return MMI_TRUE;
}

/*****************************************************************************
* FUNCTION
*  mmi_uc_process_manual_insert_signature
* DESCRIPTION
*  insert signature
* PARAMETERS
*  void
* RETURNS
*
*****************************************************************************/
MMI_BOOL mmi_uc_process_manual_insert_signature(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_uc_manual_insert_signature())
    {        
        /* Add signature successfully. Initialize editor. */
        if (g_uc_p->srv_main->mode == SRV_UC_FORWARD_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_FORWARD_WITH_EDIT_MODE;
        }
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if (g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
        {
            g_uc_p->srv_main->mode = SRV_UC_SEND_WITH_EDIT_MODE;
        }
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        mmi_uc_editor_initialize();
    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        mmi_uc_recipient_initialize();
    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
        return MMI_TRUE;
    }
    else 
    {
        return MMI_FALSE;
    }
}



/*****************************************************************************
* FUNCTION
*  mmi_uc_process_warning_mode_manual_insert_signature
* DESCRIPTION
*  process insert signature for warning mode confirm popup
* PARAMETERS
*  void
* RETURNS
*
*****************************************************************************/
void mmi_uc_process_warning_mode_manual_insert_signature(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_process_manual_insert_signature();
    mmi_frm_scrn_close_active_id();
}
#endif /* _MMI_SLIM_MMS_2__ */
#if !defined(__MMI_MMS_STANDALONE_COMPOSER__)
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_sms_msg_del_event
 * DESCRIPTION
 *  
 * PARAMETERS
 *  event_data      [IN]        
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
mmi_ret mmi_uc_handle_sms_msg_del_event(mmi_event_struct *event_data)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	srv_sms_event_struct *sms_event_data = (srv_sms_event_struct *) event_data;
    srv_sms_event_delete_struct *event_info = (srv_sms_event_delete_struct*)sms_event_data->event_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT(event_info);
    if (mmi_uc_is_sms_in_use( event_info->msg_id))
    {
        if (g_uc_p->srv_main->state == MMI_UC_STATE_FORWARD ||
                                        g_uc_p->srv_main->state == MMI_UC_STATE_SEND)
        {
            mmi_uc_delete_all_uc_screens();
        }
        else
        {
            g_uc_p->srv_main->state = MMI_UC_STATE_WRITE_NEW_MSG;
        }
        g_uc_p->srv_send_info->existed_msg_id = 0;
    }
    return MMI_RET_OK;
}
#endif
#ifndef __MMI_SLIM_MMS_2__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_image_object_from_multimedia_app_verification_process
 * DESCRIPTION
 *  Select object from multimedia
 * PARAMETERS
 *  insert_mms_type         [IN]        
 *  mmi_uc_image_path       [IN]        
 *  file_path               [IN]        
 *  filePath(?)             [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_image_object_from_multimedia_app_verification_process(
        mma_insert_type_enum insert_mms_type,
        U8 *mmi_uc_image_path,
        PU16 file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mma_insert_check_struct check_result = {KAL_FALSE, KAL_FALSE, KAL_FALSE, MMA_RESULT_OK, MMA_INSERT_UNKNOWN, MMA_DRM_NONE};
    mma_insert_type_enum mms_type = insert_mms_type;
    mma_insert_info_struct insert_info = {0, 0, MMA_CREATION_MODE_FREE, MMA_INSERT_UNKNOWN, MMA_MMS_TYPE_SMIL_MMS, NULL};
    //S32 flie_path_len = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    insert_info.creation_mode = g_uc_p->srv_mms_info->creation_mode;
    insert_info.current_msg_size = 0;   /* becasue only check warning mode, no need curr size */
    insert_info.max_msg_size = g_uc_p->srv_mms_info->max_mms_size - srv_uc_reserved_size(g_uc_p->main.instance);
    insert_info.insert_type = mms_type;
    insert_info.filepath = (kal_wchar*) mmi_uc_image_path;
    insert_info.mms_type = srv_uc_get_mms_type(g_uc_p->main.instance);

    mma_uc_insert_object_check(&insert_info, &check_result);
    
    if (check_result.result && (MMA_RESULT_OK_WITH_WARNING_CONTENT == check_result.detail_result))
    {
        mmi_uc_setSoftkeyFunction(
            mmi_uc_process_multimedia_app_add_object,
            mmi_uc_goback_history_to_editor_warning_mode_check,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
            (U16) STR_UC_WARNING_MODE_CONFIRM);
        mmi_uc_entry_displayConfirm_generic();
        
        return;
    }
    mmi_uc_post_handler_enter_multimedia_app_add_object(
        insert_mms_type,
        g_uc_p->srv_main->file_path,
        (PU16) g_uc_p->srv_main->file_path);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_image_object_from_multimedia_app_resize_process_before_resolution_verification_to_insert
 * DESCRIPTION
 *  resizing for replacing
 * PARAMETERS
 *  file_path       [?]         
 *  is_short        [IN]        
 *  filePath(?)     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_image_object_from_multimedia_app_resize_process_before_resolution_verification_to_insert(U16 *file_path, BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 mmi_uc_image_path[SRV_UC_MAX_TEMP_FILE_LEN];
    mma_insert_type_enum mms_type = (mma_insert_type_enum)srv_uc_convert_to_mms_insert_type(g_uc_p->main.highlighted_object_type);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(mmi_uc_image_path, 0, SRV_UC_MAX_TEMP_FILE_LEN);

    /* move file path related check to mmi_uc_select_object_from_fm_to_insert_warning_mode_check */
    /* 1. processing screen */
    mmi_uc_set_processing_screen(0, STR_GLOBAL_PLEASE_WAIT, mmi_get_event_based_image(MMI_EVENT_PROGRESS), 0);
    mmi_uc_entry_processing_generic();

#ifdef __MMI_UC_MMS_IMG_RESOLUTION__
    if (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
        !(g_uc_p->srv_mms_info->image_resize.enable))
    {
        mms_get_max_image_resolution_in_restricted_mode(
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.width)),
            (kal_int32*) (&(g_uc_p->srv_mms_info->image_resize.height)));
    }
#endif /* __MMI_UC_MMS_IMG_RESOLUTION__ */ 

    /* 2. for image need resize cases, resize it to get finally file path */
#ifdef __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__

    {
        S32 left_size = 0;
        MMI_BOOL flag_for_restricted_popup = (g_uc_p->srv_mms_info->creation_mode == MMA_CREATION_MODE_RESTRICTED &&
                                              mms_get_max_msg_size_in_restricted_mode() <=
                                              g_uc_p->srv_mms_info->max_mms_size) ? MMI_TRUE : MMI_FALSE;
        U32 max_mms_size =
            (flag_for_restricted_popup) ? mms_get_max_msg_size_in_restricted_mode() : g_uc_p->srv_mms_info->
            max_mms_size;

        /* in case user to select a very big image, and it will taks a lot of time just for resize once */
        if (!mmi_uc_is_valid_image(file_path))
        {
            mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
        /* gdi_image_get_dimension_file here should be return ok, becasue if not ok, already return in previous check */
        gdi_image_get_dimension_file(
            (PS8) file_path,
            (S32*) & (g_uc_p->main.resized_w),
            (S32*) & (g_uc_p->main.resized_h));

        srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);

        /* the orig img file path is already kept by g_uc_p->srv_main->file_path */

        left_size = max_mms_size - g_uc_p->srv_msg->msg_size
            - mma_uc_calc_object_overhead_size(
                MMA_INSERT_IMAGE,
                (PU16) mmi_uc_image_path,
                max_mms_size,
                srv_uc_get_mms_type(g_uc_p->main.instance));

        if (left_size <= 0)
        {
            (flag_for_restricted_popup) ? mmi_uc_display_popup(SRV_UC_CREATION_MODE_SIZE_EXCEEDS) :
                mmi_uc_display_popup(SRV_UC_SIZE_EXCEEDS);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
        g_uc_p->main.post_handler = mmi_uc_image_object_from_multimedia_app_verification_process;
        /* here, file path is = g_uc_p->srv_main->file_path */
        mmi_uc_auto_resize_img_handler(
            g_uc_p->main.post_handler,
            (U8*) file_path,
            mmi_uc_image_path,
            mms_type,
            g_uc_p->main.resized_w,
            g_uc_p->main.resized_h,
            left_size,
            MMI_TRUE);

        return;
    }
#else /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
    {
        S32 resize_result;

        if (!mmi_uc_is_valid_image(file_path))
        {
            mmi_uc_display_resize_result_popup((S32) SRV_UC_RESIZING_FAILED_IN_GDI_FAILED);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }

        srv_uc_make_image_file_path(mmi_uc_image_path, g_uc_p->main.instance);
        resize_result = mmi_uc_resize_image(
                            (U8*) file_path,
                            mmi_uc_image_path,
                            g_uc_p->srv_mms_info->image_resize.width,
                            g_uc_p->srv_mms_info->image_resize.height);

        /* Error ! */
        if (resize_result < 0)
        {
            MMI_TRACE(
                MMI_COMMON_TRC_G6_MSG,
                TRC_MMI_UC_SELECT_OBJECT_FROM_FM_TO_INSERT_RESIZE_P2,
                g_uc_p->srv_mms_info->image_resize.width,
                g_uc_p->srv_mms_info->image_resize.height);

            mmi_uc_display_resize_result_popup((S32) resize_result);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->srv_main->file_path);
            g_uc_p->srv_main->file_path = NULL;
            return;
        }
        /* resized */
        else if (resize_result)
        {
            file_path = (PU16) mmi_uc_image_path;
            srv_uc_update_filepath_with_string(g_uc_p->main.instance, (S8*) mmi_uc_image_path);
        }
        /* resize_result == 0 means no need to resize */
        else    /* SRV_UC_RESIZING_SUCCEED_WITH_UNCHANGED= 0, filepath is still original one */
        {
            /* mmi_uc_display_resize_result_popup((S32)resize_result); */
        }
    }
#endif /* __MMI_UC_AUTO_RESIZE_IMG_BASED_ON_LEFT_MMS_SIZE__ */ 
    mmi_uc_image_object_from_multimedia_app_verification_process(mms_type, (U8*) file_path, (PU16) file_path);
    return;
}
#endif /* _MMI_SLIM_MMS_2__ */

/*****************************************************************************
* FUNCTION
*  mmi_uc_replace_screen
* DESCRIPTION
*  Replace a screen with another one
* PARAMETERS
*  void
* RETURNS
*
*****************************************************************************/
MMI_BOOL mmi_uc_replace_screen(U16 out_scr_id, U16 in_scr_id, mmi_proc_func in_scr_fn, U32 is_small_scr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_frm_node_struct in_screen;
    mmi_ret ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_node_info_init (&in_screen);
    in_screen.id = in_scr_id;
    in_screen.entry_proc = in_scr_fn;

    ret = mmi_frm_scrn_replace(g_uc_p->main.uc_cui_gid, out_scr_id, &in_screen);
    
    if ( ret == MMI_RET_ERR)
    {
        return MMI_FALSE;
    }
    else
    {
        if (is_small_scr)
        {
            mmi_frm_scrn_set_attribute (g_uc_p->main.uc_cui_gid, in_scr_id, MMI_SCRN_ATTRIB_SMALL_SCRN);
        }
        return MMI_TRUE;
    }
}

/*****************************************************************************
* FUNCTION
*  mmi_uc_insert_screen
* DESCRIPTION
*  Replace a screen with another one
* PARAMETERS
*  void
* RETURNS
*
*****************************************************************************/
MMI_BOOL mmi_uc_insert_screen(mmi_id grp_id, U16 in_scr_id, mmi_proc_func in_scr_fn, U32 is_small_scr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_frm_node_struct in_screen;
    mmi_ret ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_node_info_init (&in_screen);
    in_screen.id = in_scr_id;
    in_screen.entry_proc = in_scr_fn;


    ret = mmi_frm_scrn_insert (grp_id, SCR_ID_INVALID, &in_screen, MMI_FRM_NODE_AT_LATEST_FLAG);
    
    if ( ret == MMI_RET_ERR)
    {
        return MMI_FALSE;
    }
    else
    {
        if (is_small_scr)
        {
            mmi_frm_scrn_set_attribute (g_uc_p->main.uc_cui_gid, in_scr_id, MMI_SCRN_ATTRIB_SMALL_SCRN);
        }
        return MMI_TRUE;
    }
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_validation_checks_for_recipient
 * DESCRIPTION
 *  Entry unified composer address validation checks.
 * PARAMETERS
 *  addr            [IN]        
 *  MMI_BOOL(?)     [IN]        
 * RETURNS
 *  U16
 *****************************************************************************/
U16 mmi_uc_entry_validation_checks_for_recipient(srv_uc_addr_struct *addr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 string_id = STR_GLOBAL_OK;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((addr->type == SRV_UC_ADDRESS_TYPE_PHONE_NUMBER) && (mmi_ucs2strlen((S8*) addr->addr) == 0))
    {
        string_id = STR_GLOBAL_NO_NUMBER;
    }
    else if ((addr->type == SRV_UC_ADDRESS_TYPE_PHONE_NUMBER) &&
             srv_uc_is_phone_number_valid((S8*) addr->addr) == KAL_FALSE)
    {
        string_id = STR_ID_UC_INVALID_RECIPIENT;
    }
    else if ((addr->type == SRV_UC_ADDRESS_TYPE_PHONE_NUMBER) &&
             (mmi_ucs2strlen((S8*) addr->addr) > SRV_UC_MAX_PHONE_NUMBER_LEN))
    {
        string_id = STR_UC_NUMBER_LENGTH_EXCEED_ID;
    }
    else if ((addr->type == SRV_UC_ADDRESS_TYPE_EMAIL) &&
             applib_is_valid_email_address_unicode((kal_wchar*) addr->addr) == KAL_FALSE)
    {
        string_id = STR_ID_UC_INVALID_RECIPIENT;
    }
    return string_id;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_file_detail_info
 * DESCRIPTION
 *  get the file info of object -- for detail display (ex. filename (xxKB))
 *  will output to info buffer
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_uc_get_file_detail_info(mma_mms_object_struct *object, U8 *info_out)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FLOAT obj_size;
    U32 temp_string_len = SRV_UC_XML_STR_LEN + 1;
    U8 temp_string[SRV_UC_XML_STR_LEN + 1];
    U8 temp_ucs2_string[(SRV_UC_XML_STR_LEN + 1) * ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (object == NULL || info_out == NULL)
    {
        MMI_ASSERT(0);
        return MMI_FALSE;
    }
    obj_size = (FLOAT) object->size / (FLOAT) 1024.0;   /* KB */
    memset(temp_string, 0, sizeof(temp_string));
    memset(temp_ucs2_string, 0, sizeof(temp_ucs2_string));

    sprintf((char*)temp_string, " (%.1f ", obj_size);
    mmi_asc_n_to_ucs2((S8*) temp_ucs2_string, (S8*) temp_string, temp_string_len - 1);


    /* if the file name exceeds the maximum, it should copy the maximum length */
    if (mmi_ucs2strlen((S8*) object->file_name_ucs) < SRV_FMGR_PATH_MAX_FILE_NAME_LEN)
    {
        mmi_ucs2cat((S8*) info_out, (S8*) object->file_name_ucs);
    }
    else
    {
        mmi_ucs2ncat((S8*) info_out, (S8*) object->file_name_ucs, SRV_FMGR_PATH_MAX_FILE_NAME_LEN);
    }

    mmi_ucs2cat((PS8) info_out, (PS8) temp_ucs2_string);
    mmi_ucs2cat((PS8) info_out, (PS8) GetString(STR_UC_KB_ID));
    mmi_ucs2cat((PS8) info_out, (PS8) L")\n");

    return MMI_TRUE;
}

#ifdef __MMI_UC_SUB_PREFIX_MMS__

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_prefix_already_exist
 * DESCRIPTION
 *  Check if the input string already has prefix
 * PARAMETERS
 *  instance        [IN]        
 *  state           [IN]        
 *  ucs2_string     [?]         
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_is_prefix_already_exist(U32 instance, srv_uc_state_enum state, S8 *ucs2_string)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    const S8 *pPrefixStr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((state != SRV_UC_STATE_FORWARD) && (state != SRV_UC_STATE_REPLY) && (state != SRV_UC_STATE_REPLY_ALL)
        && (g_uc_p->srv_main->mode == SRV_UC_NORMAL_EDIT_MODE))
    {
        MMI_ASSERT(0);
        return MMI_TRUE;
    }

    if (ucs2_string == NULL)
    {
        return MMI_FALSE;
    }

    if (SRV_UC_STATE_FORWARD == state || g_uc_p->srv_main->mode != SRV_UC_NORMAL_EDIT_MODE)
    {
        pPrefixStr = GetString(STR_UC_FW_ID);
    }
    else
    {
        pPrefixStr = GetString(STR_UC_RE_ID);
    }

    if (!mmi_ucs2ncmp(ucs2_string, pPrefixStr, mmi_ucs2strlen(pPrefixStr)))     /* no prefix in ucs2_string */
    {
        return MMI_TRUE;
    }

    return MMI_FALSE;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_prefix_before_subject
 * DESCRIPTION
 *  Add prefix RE: for reply msg and FW: for forward msg
 * PARAMETERS
 *  instance        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_add_prefix_before_subject(U32 instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    const S8 *pSubject_Prefix = NULL;
    U16 subject_buff[SRV_UC_MAX_SUBJECT_LEN + 1];   /* UCS2 */
    int prefix_char_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_ADD_PREFIX_BEFORE_SUBJECT_P1, g_uc_p->srv_main->state);

    if ((SRV_UC_STATE_FORWARD != g_uc_p->srv_main->state) &&
        (SRV_UC_STATE_REPLY != g_uc_p->srv_main->state) &&
        (SRV_UC_STATE_REPLY_ALL != g_uc_p->srv_main->state)
        && g_uc_p->srv_main->mode == SRV_UC_NORMAL_EDIT_MODE)
    {
        return;
    }

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if(g_uc_p->srv_main->mode == SRV_UC_SEND_WITH_EDIT_MODE || 
            g_uc_p->srv_main->mode == SRV_UC_SEND_WITHOUT_EDIT_MODE)
    {
        return;
    }
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

    if (MMI_TRUE == mmi_uc_is_prefix_already_exist(
                        instance,
                        g_uc_p->srv_main->state,
                        (S8*) g_uc_p->srv_msg->subject))
    {
        return;
    }
    /* add prefix */
    memset(subject_buff, 0, sizeof(subject_buff));

    mmi_ucs2ncpy((S8*) subject_buff, (S8*) g_uc_p->srv_msg->subject, SRV_UC_MAX_SUBJECT_LEN);

    memset(g_uc_p->srv_msg->subject, 0, sizeof(g_uc_p->srv_msg->subject));

    if (SRV_UC_STATE_FORWARD == g_uc_p->srv_main->state
        || g_uc_p->srv_main->mode != SRV_UC_NORMAL_EDIT_MODE)
    {
        pSubject_Prefix = GetString(STR_UC_FW_ID);
    }
    else
    {
        pSubject_Prefix = GetString(STR_UC_RE_ID);
    }

    prefix_char_num = mmi_ucs2strlen(pSubject_Prefix);

    mmi_ucs2ncpy((S8*) g_uc_p->srv_msg->subject, pSubject_Prefix, prefix_char_num);

    mmi_ucs2ncat(
        (S8*) g_uc_p->srv_msg->subject,    /* g_uc_p->srv_msg->subject: MMI_UC_MAX_SUBJECT_LEN+1 */
        (const S8*)subject_buff,
        SRV_UC_MAX_SUBJECT_LEN - prefix_char_num);
    return;
}
#endif /* __MMI_UC_SUB_PREFIX_MMS__ */ 

#ifdef __MMI_UC_USE_ASM__
MMI_BOOL mmi_uc_alloc_asm_pool(void)
{
	U32 mem_req_for_phedt = 0;
#ifdef __MMI_PHOTOEDITOR__
	mem_req_for_phedt = mmi_phoedt_get_appmem_requirement();
#endif
	#ifdef __MMI_MMS_2__
	mmi_umms_app_if_uc_request_to_deinit();
    #endif
    if(g_uc_p->main.asm_pool == NULL)
    {
        g_uc_p->main.asm_pool = applib_mem_ap_alloc(
                                    APPLIB_MEM_AP_ID_UNIFIED_COMPOSER,
									(MMI_UC_ADM_MEM_SIZE +( (srv_mms_get_viewer_asm_size() > mem_req_for_phedt) ? srv_mms_get_viewer_asm_size():mem_req_for_phedt)));

        if (g_uc_p->main.asm_pool == NULL)
        {
            mmi_frm_appmem_prompt_to_release_mem(
                APPLIB_MEM_AP_ID_UNIFIED_COMPOSER,
                IMG_UC_ENTRY_SCRN_CAPTION_ID,
                (MMI_UC_ADM_MEM_SIZE +( (srv_mms_get_viewer_asm_size() > mem_req_for_phedt) ? srv_mms_get_viewer_asm_size():mem_req_for_phedt)),
                mmi_uc_asm_success_cb);
            mmi_frm_appmem_set_cancel_callback(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, mmi_uc_asm_cancel_cb);
            return MMI_FALSE;
        }
        applib_mem_ap_free(g_uc_p->main.asm_pool);
        g_uc_p->main.asm_pool = applib_mem_ap_alloc(
                                    APPLIB_MEM_AP_ID_UNIFIED_COMPOSER,
                                    MMI_UC_ADM_MEM_SIZE);
        g_uc_p->main.mem_pool_id = kal_adm_create(g_uc_p->main.asm_pool, MMI_UC_ADM_MEM_SIZE, NULL, KAL_FALSE);
        MMI_ASSERT(g_uc_p->main.mem_pool_id);
		if(!(g_uc_p->main.mem_pool_id))
		{
		MMI_PRINT(MOD_MMI_COMMON_APP,MMI_COMMON_TRC_G6_MSG, TRC_SRV_UC_ASSERT, __LINE__, __FILE__);
		}
    }
    return MMI_TRUE;
}

void mmi_uc_de_alloc_asm_pool(void)
{
    if(g_uc_p->main.mem_pool_id)
    {
        kal_adm_delete(g_uc_p->main.mem_pool_id);
        g_uc_p->main.mem_pool_id = 0;
    }

    if (g_uc_p->main.asm_pool != NULL)
    {
        applib_mem_ap_free(g_uc_p->main.asm_pool);
        g_uc_p->main.asm_pool = NULL;
    }
}


void mmi_uc_asm_success_cb(void)
{
	if (g_uc_p->main.parent_cui_gid != 0)
    {
        g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
                g_uc_p->main.parent_cui_gid, GRP_ID_UNIFIED_COMPOSER, mmi_uc_editor_proc, (void*)NULL); 
        mmi_frm_group_enter(g_uc_p->main.uc_cui_gid, MMI_FRM_NODE_SMART_CLOSE_FLAG);
		g_uc_p->main.parent_cui_gid = 0;
    }
    mmi_uc_process_entry_write_msg();
}


void mmi_uc_asm_cancel_cb(mmi_frm_appmem_evt_struct *cancel_event)
{
    /* Empty body */
}


MMI_BOOL mmi_uc_alloc_asm_pool_with_content(mmi_uc_done_type_enum type, mmi_uc_entry_write_struct *data)
{
	U32 mem_req_for_phedt = 0;
#ifdef __MMI_PHOTOEDITOR__
	mem_req_for_phedt = mmi_phoedt_get_appmem_requirement();
#endif
	#ifdef __MMI_MMS_2__
	mmi_umms_app_if_uc_request_to_deinit();
    #endif
    if(g_uc_p->main.asm_pool == NULL)
    {
        g_uc_p->main.asm_pool = applib_mem_ap_alloc(
                                    APPLIB_MEM_AP_ID_UNIFIED_COMPOSER,
                                    (MMI_UC_ADM_MEM_SIZE +( (srv_mms_get_viewer_asm_size() > mem_req_for_phedt) ? srv_mms_get_viewer_asm_size():mem_req_for_phedt)));

        if (g_uc_p->main.asm_pool == NULL)
        {
           if(mmi_uc_copy_entry_struct(type, data))
           {
            mmi_frm_appmem_prompt_to_release_mem(
                APPLIB_MEM_AP_ID_UNIFIED_COMPOSER,
                IMG_UC_ENTRY_SCRN_CAPTION_ID,
                (MMI_UC_ADM_MEM_SIZE +( (srv_mms_get_viewer_asm_size() > mem_req_for_phedt) ? srv_mms_get_viewer_asm_size():mem_req_for_phedt)),
                mmi_uc_asm_success_cb_with_content);
           }
           else
           {
               mmi_popup_display(
                (WCHAR*) ((UI_string_type) GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY)),
                MMI_EVENT_FAILURE,
                NULL);

            if (data->callback != NULL)
            {
                data->callback((void*)data->callback_para);
            }
            mmi_frm_group_close (g_uc_p->main.uc_cui_gid);
			g_uc_p->main.uc_cui_gid = GRP_ID_INVALID;
           }
            mmi_frm_appmem_set_cancel_callback(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, mmi_uc_asm_cancel_cb_with_content);
            return MMI_FALSE;
        }
        applib_mem_ap_free(g_uc_p->main.asm_pool);
        g_uc_p->main.asm_pool = applib_mem_ap_alloc(
                                    APPLIB_MEM_AP_ID_UNIFIED_COMPOSER,
                                    MMI_UC_ADM_MEM_SIZE);
        g_uc_p->main.mem_pool_id = kal_adm_create(g_uc_p->main.asm_pool, MMI_UC_ADM_MEM_SIZE, NULL, KAL_FALSE);
        MMI_ASSERT(g_uc_p->main.mem_pool_id);
    }
    return MMI_TRUE;
}


void mmi_uc_asm_success_cb_with_content(void)
{
	if (g_uc_p->main.parent_cui_gid != 0)
    {
        g_uc_p->main.uc_cui_gid = mmi_frm_group_create(
                g_uc_p->main.parent_cui_gid, GRP_ID_UNIFIED_COMPOSER, mmi_uc_editor_proc, (void*)NULL); 
        mmi_frm_group_enter(g_uc_p->main.uc_cui_gid, MMI_FRM_NODE_SMART_CLOSE_FLAG);
		g_uc_p->main.parent_cui_gid = 0;
    }
    mmi_uc_entry_write_msg_with_content(g_uc_p->main.entry_struct->type, g_uc_p->main.entry_struct->data);
    mmi_uc_free_entry_struct();
}


void mmi_uc_asm_cancel_cb_with_content(mmi_frm_appmem_evt_struct *cancel_event)
{
    mmi_uc_free_entry_struct();
}


void mmi_uc_asm_stop_cb(void)
{
    if(mmi_uc_need_to_stop_composer())
    {
        mmi_uc_reset_msg();
        mmi_uc_delete_all_uc_screens();
        applib_mem_ap_notify_stop_finished(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, MMI_TRUE);
    }
    else
    {
        applib_mem_ap_notify_stop_finished(APPLIB_MEM_AP_ID_UNIFIED_COMPOSER, MMI_FALSE);
    }
}


MMI_BOOL mmi_uc_copy_entry_struct(mmi_uc_done_type_enum type, mmi_uc_entry_write_struct *data)
{
    U32 addr_num = 0, len;
    S32 result = FS_NO_ERROR;
    mmi_uc_addr_struct *addr = data->addr, *entry_addr = NULL;
    mmi_uc_asm_copy_entry_struct *entry_struct = NULL;

    entry_struct = OslMalloc(sizeof(mmi_uc_asm_copy_entry_struct));
    memset(entry_struct, 0, sizeof(mmi_uc_asm_copy_entry_struct));
    entry_struct->data = OslMalloc(sizeof(mmi_uc_entry_write_struct));
    memset(entry_struct->data, 0, sizeof(mmi_uc_entry_write_struct));

    entry_struct->type = type;
    entry_struct->data->addr_num = data->addr_num;

    for (; addr_num < data->addr_num; addr_num++)
    {
        mmi_uc_addr_struct *addr_node = NULL;

        if (data->get_address_callback)
        {
            kal_int8 *temp_address_string = NULL;
            S32 str_length = 0;
            U16 address_type = 0;

            MMI_ASSERT(addr == NULL);
            addr_node = OslMalloc(sizeof(mmi_uc_addr_struct));
            memset(addr_node, 0, sizeof(mmi_uc_addr_struct));
            temp_address_string = data->get_address_callback((kal_uint16) addr_num, &address_type);
            str_length = mmi_ucs2strlen((S8*) temp_address_string);
            addr_node->addr = OslMalloc((str_length + 1) * ENCODING_LENGTH);
            memset(addr_node->addr, 0, (str_length + 1) * ENCODING_LENGTH);
            memcpy(addr_node->addr, temp_address_string, (str_length + 1) * ENCODING_LENGTH);
            addr_node->type =
                (address_type ==
                 MMI_PHB_ADDRESS_TYPE_NUMBER) ? MMI_UC_ADDRESS_TYPE_PHONE_NUMBER : MMI_UC_ADDRESS_TYPE_EMAIL;
            addr_node->group = MMI_UC_ADDRESS_GROUP_TYPE_TO;
            addr = addr_node;
        }

        MMI_ASSERT(addr);

        if(!entry_addr)
        {
            entry_addr = OslMalloc(sizeof(mmi_uc_addr_struct));
            memset(entry_addr, 0, sizeof(mmi_uc_addr_struct));
            entry_struct->data->addr = entry_addr;
        }
        else
        {
            while(entry_addr->next)
            {
                entry_addr = entry_addr->next;
            }
            entry_addr->next = OslMalloc(sizeof(mmi_uc_addr_struct));
            memset(entry_addr->next, 0, sizeof(mmi_uc_addr_struct));
            entry_addr = entry_addr->next;
        }

        entry_addr->type = addr->type;
        entry_addr->group = addr->group;
        len = mmi_ucs2strlen((S8*) addr->addr);
        if(entry_addr->type == SRV_UC_ADDRESS_TYPE_PHONE_NUMBER)
        {
            if (len > SRV_UC_MAX_PHONE_NUMBER_LEN)
            {
                len = SRV_UC_MAX_PHONE_NUMBER_LEN + 1;
            }
        }
        else
        {
            if (len > SRV_UC_MAX_EMAIL_LEN)
            {
                len = SRV_UC_MAX_EMAIL_LEN + 1;
            }
        }
        entry_addr->addr = OslMalloc((len + 1) * ENCODING_LENGTH);
        MMI_ASSERT(entry_addr->addr);

        memset(entry_addr->addr, 0, (len + 1) * ENCODING_LENGTH);
        memcpy(entry_addr->addr, addr->addr, (len * ENCODING_LENGTH));

        if (addr_num >= SRV_UC_MAX_ADDRESS_NUM)
        {
            /* the recipient limitation is SRV_UC_MAX_ADDRESS_NUM */
            break;
        }
        addr = addr->next;
        if (addr_node)
        {
            OslMfree(addr_node->addr);
            OslMfree(addr_node);
            addr_node = NULL;
        }
    }
    entry_struct->data->msg_type = data->msg_type;
    if(data->file_path)
    {
        len = mmi_ucs2strlen((S8*) data->file_path);
        entry_struct->data->file_path = OslMalloc((len + 1) * ENCODING_LENGTH);
        MMI_ASSERT(entry_struct->data->file_path);
        mmi_ucs2ncpy((S8*) entry_struct->data->file_path, (S8*) data->file_path, len);
    }
    /* Discard the exceeding part */
    if (data->text_num > SRV_UC_MAX_CHAR_NUM_IN_ONE_SLIDE)
    {
        data->text_num = SRV_UC_MAX_CHAR_NUM_IN_ONE_SLIDE;
    }
    if (data->msg_type == MMI_UC_MSG_TYPE_SMS_ONLY && data->text_num > MMI_UC_MAX_SMS_CONTENT)
    {
        data->text_num = MMI_UC_MAX_SMS_CONTENT;
    }
    entry_struct->data->text_num = data->text_num;
    if(data->text_buffer)
    {
        U32 buffer_size = (data->text_num + 1) * ENCODING_LENGTH;

        entry_struct->file_path = OslMalloc((SRV_UC_MAX_TEMP_FILE_LEN + 1) * ENCODING_LENGTH);
        entry_struct->data->text_buffer = applib_mem_screen_alloc(buffer_size);

        MMI_ASSERT(buffer_size <= MMI_UC_UTF8_TEXT_BUFFER_SIZE);

        kal_wsprintf( (kal_uint16 *)entry_struct->file_path, "%c:\\%s%03d\\%s.%s",
            SRV_UC_FOLDER_DRV, SRV_UC_FOLDER_NAME, g_uc_p->main.instance, SRV_UC_ASM_TEXT_FILENAME, SRV_UC_TEXT_FILEEXT );
        memset(entry_struct->data->text_buffer, 0, buffer_size);
        srv_sms_remove_escape_char(
            (S8*) entry_struct->data->text_buffer,
            (S8*) data->text_buffer,
            (U16) data->text_num);
        result = srv_uc_save_buffer_to_file(
            g_uc_p->main.instance,
            entry_struct->file_path,
            entry_struct->data->text_buffer,
            data->text_num);
        applib_mem_screen_free(entry_struct->data->text_buffer);
        entry_struct->data->text_buffer = NULL;
    }
    if (data->subject)
    {
        len = mmi_ucs2strlen((S8*) data->subject);
        entry_struct->data->subject = OslMalloc((len + 1) * ENCODING_LENGTH);
        MMI_ASSERT(entry_struct->data->subject);
        mmi_ucs2ncpy((S8*) entry_struct->data->subject, (S8*) data->subject, len);
    }
    entry_struct->data->info_type = data->info_type;
    if(data->info_type == MMI_UC_INFO_TYPE_SMS && data->info)
    {
        entry_struct->data->info = OslMalloc(sizeof(U16));
        *((U16 *)entry_struct->data->info) = *((U16 *)data->info);
    }
    entry_struct->data->callback = data->callback;
    entry_struct->data->callback_para = data->callback_para;
    entry_struct->data->sim_id = data->sim_id;
    entry_struct->data->get_address_callback = NULL;
    g_uc_p->main.entry_struct = entry_struct;
    entry_struct = NULL;
    if(result == FS_NO_ERROR)
        return MMI_TRUE;
    else
        return MMI_FALSE;
}


void mmi_uc_free_entry_struct(void)
{
    mmi_uc_asm_copy_entry_struct *entry_struct = g_uc_p->main.entry_struct;
    mmi_uc_addr_struct *entry_addr = NULL, *temp_addr;

    if(NULL == entry_struct)
    {
        return;
    }

    if(entry_struct && entry_struct->data)
    {
        entry_addr = entry_struct->data->addr;
    }
    while(entry_addr)
    {
        temp_addr = entry_addr;
        entry_addr = entry_addr->next;
        OslMfree(temp_addr->addr);
        OslMfree(temp_addr);
        temp_addr->addr = NULL;
        temp_addr = NULL;
    }
    if(entry_struct->data->file_path)
    {
        OslMfree(entry_struct->data->file_path);
    }
    if(entry_struct->file_path)
    {
        /* Delete the file */
        FS_Delete((U16*) entry_struct->file_path);
        OslMfree(entry_struct->file_path);
    }
    if (entry_struct->data->subject)
    {
        OslMfree(entry_struct->data->subject);
    }
    if(entry_struct->data->info)
    {
        OslMfree(entry_struct->data->info);
    }
    OslMfree(entry_struct->data);
    OslMfree(entry_struct);
    entry_struct = NULL;
    g_uc_p->main.entry_struct = NULL;
}


MMI_BOOL mmi_uc_need_to_stop_composer(void)
{
    if(g_uc_p->srv_send_info->new_msg_id && g_uc_p->srv_send_info->action == SRV_UC_ACTION_PREVIEW)
    {
        return MMI_FALSE;
    }
    else
    {
        return MMI_TRUE;
    }
}
#endif /* __MMI_UC_USE_ASM__ */

void mmi_uc_copy_reentry_struct(mmi_uc_done_type_enum type, mmi_uc_entry_write_struct *data)
{
    U32 addr_num = 0, len;
    mmi_uc_addr_struct *addr = data->addr, *entry_addr = NULL;
    mmi_uc_asm_copy_reentry_struct *entry_struct = NULL;

    entry_struct = OslMalloc(sizeof(mmi_uc_asm_copy_reentry_struct));
    memset(entry_struct, 0, sizeof(mmi_uc_asm_copy_reentry_struct));
    entry_struct->data = OslMalloc(sizeof(mmi_uc_entry_write_struct));
    memset(entry_struct->data, 0, sizeof(mmi_uc_entry_write_struct));

    entry_struct->type = type;
    entry_struct->data->addr_num = data->addr_num;

    for (; addr_num < data->addr_num; addr_num++)
    {
        mmi_uc_addr_struct *addr_node = NULL;

        if (data->get_address_callback)
        {
            kal_int8 *temp_address_string = NULL;
            S32 str_length = 0;
            U16 address_type = 0;

            MMI_ASSERT(addr == NULL);
            addr_node = OslMalloc(sizeof(mmi_uc_addr_struct));
            memset(addr_node, 0, sizeof(mmi_uc_addr_struct));
            temp_address_string = data->get_address_callback((kal_uint16) addr_num, &address_type);
            str_length = mmi_ucs2strlen((S8*) temp_address_string);
            addr_node->addr = OslMalloc((str_length + 1) * ENCODING_LENGTH);
            memset(addr_node->addr, 0, (str_length + 1) * ENCODING_LENGTH);
            memcpy(addr_node->addr, temp_address_string, (str_length + 1) * ENCODING_LENGTH);
            addr_node->type =
                (address_type ==
                 MMI_PHB_ADDRESS_TYPE_NUMBER) ? MMI_UC_ADDRESS_TYPE_PHONE_NUMBER : MMI_UC_ADDRESS_TYPE_EMAIL;
            addr_node->group = MMI_UC_ADDRESS_GROUP_TYPE_TO;
            addr = addr_node;
        }

        MMI_ASSERT(addr);

        if(!entry_addr)
        {
            entry_addr = OslMalloc(sizeof(mmi_uc_addr_struct));
            memset(entry_addr, 0, sizeof(mmi_uc_addr_struct));
            entry_struct->data->addr = entry_addr;
        }
        else
        {
            while(entry_addr->next)
            {
                entry_addr = entry_addr->next;
            }
            entry_addr->next = OslMalloc(sizeof(mmi_uc_addr_struct));
            memset(entry_addr->next, 0, sizeof(mmi_uc_addr_struct));
            entry_addr = entry_addr->next;
        }

        entry_addr->type = addr->type;
        entry_addr->group = addr->group;
        len = mmi_ucs2strlen((S8*) addr->addr);
        if(entry_addr->type == SRV_UC_ADDRESS_TYPE_PHONE_NUMBER)
        {
            if (len > SRV_UC_MAX_PHONE_NUMBER_LEN)
            {
                len = SRV_UC_MAX_PHONE_NUMBER_LEN + 1;
            }
        }
        else
        {
            if (len > SRV_UC_MAX_EMAIL_LEN)
            {
                len = SRV_UC_MAX_EMAIL_LEN + 1;
            }
        }
        entry_addr->addr = OslMalloc((len + 1) * ENCODING_LENGTH);
        MMI_ASSERT(entry_addr->addr);

        memset(entry_addr->addr, 0, (len + 1) * ENCODING_LENGTH);
        memcpy(entry_addr->addr, addr->addr, (len * ENCODING_LENGTH));

        if (addr_num >= SRV_UC_MAX_ADDRESS_NUM)
        {
            /* the recipient limitation is SRV_UC_MAX_ADDRESS_NUM */
            break;
        }
        addr = addr->next;
        if (addr_node)
        {
            OslMfree(addr_node->addr);
            OslMfree(addr_node);
            addr_node = NULL;
        }
    }
    entry_struct->data->msg_type = data->msg_type;
    if(data->file_path)
    {
        len = mmi_ucs2strlen((S8*) data->file_path);
        entry_struct->data->file_path = OslMalloc((len + 1) * ENCODING_LENGTH);
        MMI_ASSERT(entry_struct->data->file_path);
        mmi_ucs2ncpy((S8*) entry_struct->data->file_path, (S8*) data->file_path, len);
    }
    /* Discard the exceeding part */
    if (data->text_num > SRV_UC_MAX_CHAR_NUM_IN_ONE_SLIDE)
    {
        data->text_num = SRV_UC_MAX_CHAR_NUM_IN_ONE_SLIDE;
    }
    if (data->msg_type == MMI_UC_MSG_TYPE_SMS_ONLY && data->text_num > MMI_UC_MAX_SMS_CONTENT)
    {
        data->text_num = MMI_UC_MAX_SMS_CONTENT;
    }
    entry_struct->data->text_num = data->text_num;
    if(data->text_buffer)
    {
        U32 buffer_size = (data->text_num + 1) * ENCODING_LENGTH;

        entry_struct->file_path = OslMalloc((SRV_UC_MAX_TEMP_FILE_LEN + 1) * ENCODING_LENGTH);
        entry_struct->data->text_buffer = applib_mem_screen_alloc(buffer_size);

        MMI_ASSERT(buffer_size <= MMI_UC_UTF8_TEXT_BUFFER_SIZE);

        kal_wsprintf( (kal_uint16 *)entry_struct->file_path, "%c:\\%s%03d\\%s.%s",
            SRV_UC_FOLDER_DRV, SRV_UC_FOLDER_NAME, g_uc_p->main.instance, SRV_UC_ASM_TEXT_RE_FILENAME, SRV_UC_TEXT_FILEEXT );
        memset(entry_struct->data->text_buffer, 0, buffer_size);
        srv_sms_remove_escape_char(
            (S8*) entry_struct->data->text_buffer,
            (S8*) data->text_buffer,
            (U16) data->text_num);
        srv_uc_save_buffer_to_file(
            g_uc_p->main.instance,
            entry_struct->file_path,
            entry_struct->data->text_buffer,
            data->text_num);
        applib_mem_screen_free(entry_struct->data->text_buffer);
        entry_struct->data->text_buffer = NULL;
    }
    if (data->subject)
    {
        len = mmi_ucs2strlen((S8*) data->subject);
        entry_struct->data->subject = OslMalloc((len + 1) * ENCODING_LENGTH);
        MMI_ASSERT(entry_struct->data->subject);
        mmi_ucs2ncpy((S8*) entry_struct->data->subject, (S8*) data->subject, len);
    }
    entry_struct->data->info_type = data->info_type;
    if(data->info_type == MMI_UC_INFO_TYPE_SMS && data->info)
    {
        entry_struct->data->info = OslMalloc(sizeof(U16));
        *((U16 *)entry_struct->data->info) = *((U16 *)data->info);
    }
    entry_struct->data->callback = data->callback;
    entry_struct->data->callback_para = data->callback_para;
    entry_struct->data->sim_id = data->sim_id;
    entry_struct->data->get_address_callback = NULL;
    g_uc_p->main.reentry_struct = entry_struct;
    entry_struct = NULL;
}


void mmi_uc_free_reentry_struct(void)
{
    mmi_uc_asm_copy_reentry_struct *entry_struct = g_uc_p->main.reentry_struct;
    mmi_uc_addr_struct *entry_addr = NULL, *temp_addr;

    if(entry_struct && entry_struct->data)
    {
        entry_addr = entry_struct->data->addr;
    }
    while(entry_addr)
    {
        temp_addr = entry_addr;
        entry_addr = entry_addr->next;
        OslMfree(temp_addr->addr);
        OslMfree(temp_addr);
        temp_addr->addr = NULL;
        temp_addr = NULL;
    }
    if(entry_struct->data->file_path)
    {
        OslMfree(entry_struct->data->file_path);
    }
    if(entry_struct->file_path)
    {
        /* Delete the file */
        FS_Delete((U16*) entry_struct->file_path);
        OslMfree(entry_struct->file_path);
    }
    if (entry_struct->data->subject)
    {
        OslMfree(entry_struct->data->subject);
    }
    if(entry_struct->data->info)
    {
        OslMfree(entry_struct->data->info);
    }
    OslMfree(entry_struct->data);
    OslMfree(entry_struct);
    entry_struct = NULL;
    g_uc_p->main.reentry_struct = NULL;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_sms_template_group_proc
 * DESCRIPTION
 *  sms template insert handler
 * PARAMETERS
 *  instance        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
#if defined(__MMI_MESSAGES_TEMPLATE__)
static mmi_ret mmi_uc_sms_template_group_proc(mmi_event_struct *evt)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_DEINIT:
            g_uc_p->main.cui_template_gid = GRP_ID_INVALID;
            g_uc_p->main.mmi_sms_template_gid = GRP_ID_INVALID;
            break;

        case EVT_ID_CUI_SMS_TEMPLATE_LIST:
            {
                cui_sms_template_evt_struct *temp_evt = (cui_sms_template_evt_struct*)evt;

                switch (temp_evt->key_pressed)
                {
                    case MMI_LEFT_SOFTKEY:
                        mmi_uc_insert_text_template();
                        break;

                    case MMI_RIGHT_SOFTKEY:
                        cui_sms_template_close(g_uc_p->main.mmi_sms_template_gid);
                        break;
                        
                    default:
                        break;
                }
            }
            break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_entry_sms_template
 * DESCRIPTION
 *  Entry text template list
 * PARAMETERS
 *  instance        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_uc_entry_sms_template(void)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
       g_uc_p->main.cui_template_gid = GRP_ID_INVALID;
       g_uc_p->main.mmi_sms_template_gid = GRP_ID_INVALID;

       g_uc_p->main.mmi_sms_template_gid = mmi_frm_group_create (g_uc_p->main.uc_cui_gid, GRP_ID_AUTO_GEN, mmi_uc_sms_template_group_proc, NULL);
       mmi_frm_group_enter(g_uc_p->main.mmi_sms_template_gid, MMI_FRM_NODE_SMART_CLOSE_FLAG);

       g_uc_p->main.cui_template_gid = cui_sms_template_list_create(g_uc_p->main.mmi_sms_template_gid, MMI_FALSE, CUI_SMS_TEMPLATE_NONE, MMI_TRUE);

       if (g_uc_p->main.cui_template_gid != GRP_ID_INVALID)
       {
           cui_sms_template_list_run(g_uc_p->main.cui_template_gid);
       }
       else if (!mmi_frm_scrn_get_count(g_uc_p->main.mmi_sms_template_gid))
       {
           mmi_frm_group_close(g_uc_p->main.mmi_sms_template_gid);
       }
}

#endif /* defined(__MMI_MESSAGES_TEMPLATE__)*/

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_sim_sel_proc
 * DESCRIPTION
 *  Handler for menu cui
 * PARAMETERS
 *  instance        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
#if(MMI_MAX_SIM_NUM>=3)
#ifndef __MMI_DYNAMIC_SIM_DYNAMIC_UI__ 
mmi_ret mmi_uc_sim_sel_proc(mmi_event_struct *evt)
{

    cui_sim_sel_result_event_struct* sim_sel_evt = NULL;
	switch(evt->evt_id)
    {
		 case EVT_ID_GROUP_DEINIT:
        {
            
        }        
		break;

        /* SIM selector event */
        case EVT_ID_CUI_SIM_SEL_RESULT:
        {

            sim_sel_evt = (cui_sim_sel_result_event_struct*)evt;
            cui_sim_sel_close(g_uc_p->main.uc_sim_cui_id);
            if (sim_sel_evt->result == CUI_SIM_SEL_OK)
            {
                switch (sim_sel_evt->sim_id)
                {
                    case MMI_SIM1:
			g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM1;
                        break;
                    case MMI_SIM2:
                         g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM2;
                        break;
                    case MMI_SIM3:
                        g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM3;
                        break;
               #if(MMI_MAX_SIM_NUM==4)
                    case MMI_SIM4:
                         g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM4;
                        break;
                #endif /* (GEMINI_PLUS == 4) */
                }
           if(g_uc_p->srv_sim_info->valid_sim_id_info & sim_sel_evt->sim_id)               
		         {
				 mmi_uc_process_send();
		         }
		   else
		         {
		         mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_NOT_AVAILABLE)), MMI_EVENT_FAILURE, NULL);
		         }
			}


         //   cui_sim_sel_close(g_uc_p->main.uc_sim_cui_id);
        }
        break;
    
        /* GRP related events */
        default:
        break;
    }
    return MMI_RET_OK;
}
#endif

void mmi_uc_launch_sim(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/     

   if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM1
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM2
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM3
   ||g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM4)
   {
    
	   if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM1)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM1;
       else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM2)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM2;
       else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM3)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM3;
       else if(g_uc_p->srv_sim_info->valid_sim_id_info ==SRV_UC_SIM_ID_GSM_SIM4)
           g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM4;
       else
           g_uc_p->srv_send_info->send_sim_id = SRV_UC_SIM_ID_UNCLASSIFIED;
	   mmi_uc_process_send();
   }
   else
   {
      #ifndef __MMI_DYNAMIC_SIM_DYNAMIC_UI__ 
       g_uc_p->main.cui_sim_gid = mmi_frm_group_create (GRP_ID_ROOT, GRP_ID_AUTO_GEN, mmi_uc_sim_sel_proc, NULL);
       mmi_frm_group_enter(g_uc_p->main.cui_sim_gid, MMI_FRM_NODE_SMART_CLOSE_FLAG);
       g_uc_p->main.uc_sim_cui_id = cui_sim_sel_create(g_uc_p->main.cui_sim_gid, g_uc_p->srv_sim_info->valid_sim_id_info, NULL);
       if (g_uc_p->main.uc_sim_cui_id > 0)
	   {
        cui_sim_sel_run(g_uc_p->main.uc_sim_cui_id);
	   }
	   #endif
   }
}

#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_add_media_proc
 * DESCRIPTION
 *  Handler for menu cui
 * PARAMETERS
 *  instance        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_add_media_proc(mmi_event_struct *evt)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (menu_evt->evt_id)
    {
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            cui_menu_set_currlist_flags(menu_evt->sender_id, CUI_MENU_NORMAL_LIST_WITH_NUMBERED_ICONS);
			switch(menu_evt->parent_menu_id)
			{
				case MENU_ID_UC_OPT:
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
					cui_menu_set_non_leaf_item(menu_evt->sender_id, MENU_ID_UC_OPT_HEADER_OPTIONS, MMI_FALSE);
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
                    cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_GLOBAL_OPTIONS), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					cui_uc_app_set_menu_data_for_uc_editor_option(menu_evt->sender_id);
					break;

#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
				case MENU_ID_UC_OPT_TEXT_OPTIONS:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_TEXT_OPTIONS_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					break;
#endif

				case MENU_ID_UC_OPT_SOUND_OPTIONS:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_SOUND_OPTIONS_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					break;

				case MENU_ID_UC_OPT_VIDEO_OPTIONS:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_VIDEO_OPTIONS_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					break;

				case MENU_ID_UC_OPT_ADD_PICTURE:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_ADD_PICTURE_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					break;

				case MENU_ID_UC_OPT_ADD_SOUND:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_ADD_SOUND_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					break;

#ifdef __MMI_MMS_VIDEO_FEATURE__
				case MENU_ID_UC_OPT_ADD_VIDEO:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_ADD_VIDEO_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					break;
#endif

#if !defined(__MMI_MSG_EDITOR_WITH_RECIPIENT__) || !defined(__MMI_TOUCH_SCREEN__)
				case MENU_ID_UC_OPT_ATTACHMENT_OPTIONS:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_ATTACHMENT_OPTIONS_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					break;
#endif

				case MENU_ID_UC_OPT_ADVANCED:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_ADVANCED_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					cui_uc_app_set_menu_for_opt_advance_options(menu_evt->sender_id);
					break;

				case MENU_ID_UC_OPT_PICTURE_OPTIONS:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_PICTURE_OPTIONS_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					cui_uc_app_set_menu_for_opt_picture_opt(menu_evt->sender_id);
					break;

				case MENU_ID_UC_OPT_SLIDE_OPT:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_UC_SLIDE_OPTION_ID), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					cui_uc_app_set_menu_for_opt_slide_opt(menu_evt->sender_id);
					break;
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
				case MENU_ID_UC_OPT_ADD_RECIPIENT:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_GLOBAL_OPTIONS), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
					cui_uc_app_set_menu_for_opt_add_recipient_opt(menu_evt->sender_id);
					break;
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
			#if defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
				case MENU_ID_UC_OPT_INSERT:
					cui_uc_frm_app_set_data_for_add_object_option_list(menu_evt->sender_id);
					break;
			#endif /* __MMI_FTE_SUPPORT__ */
#ifndef __MMI_FTE_SUPPORT__
				case MENU_ID_UC_EXIT_OPT:
					cui_uc_frm_app_set_data_for_exit_opt(menu_evt->sender_id);
					break;
#endif
                 #if (MMI_MAX_SIM_NUM >=2)
				case MENU_ID_UC_OPT_SEND:
					cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_GLOBAL_SEND), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
                    #ifdef __MMI_DYNAMIC_SIM_DYNAMIC_UI__
                    cui_uc_frm_app_set_data_for_sim_opt(menu_evt->sender_id);
                    #if (MMI_MAX_SIM_NUM >= 3)	
                    mmi_uc_set_menu_for_sim_option(menu_evt->sender_id);
                    #endif
                    #endif
					break;
			    #endif
#ifndef __MMI_MMS_STANDALONE_COMPOSER__
#ifdef __MMI_DYNAMIC_SIM_DYNAMIC_UI__
                 #if (MMI_MAX_SIM_NUM == 2)
                case MENU_ID_UC_OPT_SAVE_SMS:
				{
				    cui_uc_frm_app_set_data_for_sim_opt(menu_evt->sender_id);
				}
					break;
                #endif
#endif
#endif
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
				case MENU_ID_UC_OPT_HEADER_OPTIONS:
                {
				    cui_uc_app_set_menu_for_opt_header_options(menu_evt->sender_id);
//                    mmi_uc_enter_header_field();
                }
                break;
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
#ifndef __MMI_MMS_STANDALONE_COMPOSER__
     #if (MMI_MAX_SIM_NUM >= 3)				
                case MENU_ID_UC_OPT_SAVE_SMS:
				{
                    #ifdef __MMI_DYNAMIC_SIM_DYNAMIC_UI__
                    cui_uc_frm_app_set_data_for_sim_opt(menu_evt->sender_id);
                    #endif
				   mmi_uc_set_menu_for_sim_option(menu_evt->sender_id);
				}
				break;
      #endif			
#endif
				default:
					break;
			} 
            break;

        case EVT_ID_CUI_MENU_ITEM_HILITE:
			switch(menu_evt->highlighted_menu_id)
			{
				case MENU_ID_UC_OPT_INSERT_IMAGE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_IMAGE;
					break;

				case MENU_ID_UC_OPT_INSERT_AUDIO:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_AUDIO;
					break;

			#ifdef __MMI_MMS_VIDEO_FEATURE__
				case MENU_ID_UC_OPT_INSERT_VIDEO:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_VIDEO;
					break;
			#endif

#ifndef __MMI_SLIM_MMS_2__
			#ifdef __MMI_CAMERA__
				case MENU_ID_UC_OPT_INSERT_NEW_IMAGE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_IMAGE;
					break;
			#endif /*__MMI_CAMERA__*/

			#ifdef __MMI_SOUND_RECORDER__
				case MENU_ID_UC_OPT_INSERT_NEW_AUDIO:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_AUDIO;
					break;
			#endif /*__MMI_SOUND_RECORDER__*/

			#ifdef __MMI_MMS_VIDEO_FEATURE__
			#if defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE)
				case MENU_ID_UC_OPT_INSERT_NEW_VIDEO:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_VIDEO;
					break;
			#endif /* defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE)*/
			#endif
#endif
			#if defined(__MMI_MESSAGES_TEMPLATE__)
				case MENU_ID_UC_OPT_INSERT_TEXT_TEMPLATE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_TEXT;
					break;
			#endif /* defined(__MMI_MESSAGES_TEMPLATE__)*/
				case MENU_ID_UC_OPT_INSERT_ATTACHMENT:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_ATTACHMENT;
					break;
#ifndef __MMI_SLIM_MMS_2__
				case MENU_ID_UC_OPT_INSERT_PHB_NUMBER:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_TEXT;
					break;

				case MENU_ID_UC_OPT_INSERT_PHB_NAME:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_TEXT;
					break;
#endif
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__ 
				case MENU_ID_UC_OPT_INSERT_BOOKMARK:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_TEXT;
					break;
#endif
#ifndef __MMI_SLIM_MMS_2__
				case MENU_ID_UC_OPT_INSERT_SIGNATURE:
					break;
#endif
			#ifdef __MMI_PHOTOEDITOR__
				case MENU_ID_UC_OPT_EDIT_IMAGE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_IMAGE;
					break;
			#endif /*__MMI_PHOTOEDITOR__*/

			#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
				case MENU_ID_UC_OPT_SLIDE_OPT_IMAGE_TIMING:
					cui_uc_highlight_slide_opt_image_timing();
					break;
			#endif

				case MENU_ID_UC_OPT_PICTURE_OPT_IMAGE_REMOVE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_IMAGE;
					break;

			#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
				case MENU_ID_UC_OPT_PICTURE_OPT_IMAGE_REPLACE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_IMAGE;
					break;
			#endif

			#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
				case MENU_ID_UC_OPT_SLIDE_OPT_AUDIO_TIMING:
					cui_uc_highlight_slide_opt_audio_timing();
					break;
			#endif

				case MENU_ID_UC_OPT_AUDIO_OPT_AUDIO_REMOVE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_AUDIO;
					break;

			#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
				case MENU_ID_UC_OPT_AUDIO_OPT_AUDIO_REPLACE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_AUDIO;
					break;
			#endif

			#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
				case MENU_ID_UC_OPT_SLIDE_OPT_VIDEO_TIMING:
					cui_uc_highlight_slide_opt_video_timing();
					break;
			#endif

				case MENU_ID_UC_OPT_VIDEO_OPT_VIDEO_REMOVE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_VIDEO;
					break;

			#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
				case MENU_ID_UC_OPT_VIDEO_OPT_VIDEO_REPLACE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_VIDEO;
					break;
			#endif

				case MENU_ID_UC_OPT_ATTACH_OPT_ATTACHMENT_REMOVE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_ATTACHMENT;
					break;

			#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
				case MENU_ID_UC_OPT_ATTACH_OPT_ATTACHMENT_REPLACE:
					g_uc_p->main.highlighted_object_type = SRV_UC_OBJECT_TYPE_ATTACHMENT;
					break;
			#endif

			#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
				case MENU_ID_UC_OPT_SLIDE_OPT_TEXT_TIMING:
					cui_uc_highlight_slide_opt_text_timing();
					break;
			#endif

#ifdef __MMI_MMS_2__
				case MENU_ID_UC_OPT_SLIDE_OPT_TIMING:
					cui_uc_highlight_slide_opt_slide_timing();
					break;
#endif
#ifndef __MMI_FTE_SUPPORT__
				case MENU_ID_UC_EXIT_OPT_SAVE:
					{
					 #if (MMI_MAX_SIM_NUM >=2)
						g_uc_p->srv_sim_info->action = SRV_UC_ACTION_SAVE;
					#endif 
					}
					break;
#endif
 #if (MMI_MAX_SIM_NUM >=2)
				case MENU_ID_UC_OPT_SEND_SIM1:
					g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM1;
					break;

				case MENU_ID_UC_OPT_SEND_SIM2:
					g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM2;
					break;
				
#if (MMI_MAX_SIM_NUM >= 3)			
	case MENU_ID_UC_OPT_SEND_SIM3:
					g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM3;
					break;
#if (MMI_MAX_SIM_NUM == 4)

				case MENU_ID_UC_OPT_SEND_SIM4:
					g_uc_p->srv_send_info->send_sim_id = UC_SIM_ID_GSM_SIM4;
					break;
#endif
#endif
#endif /* __MMI_DUAL_SIM_MASTER__ */

				case MENU_ID_UC_OPT_SEND:
					{
						 #if (MMI_MAX_SIM_NUM >=2)
							g_uc_p->srv_sim_info->action = SRV_UC_ACTION_SEND;
						#endif 
					}
					break;
#ifdef __MMI_MMS_POSTCARD__
				case MENU_ID_UC_WRITE_MESSAGE:
					g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_NORMAL_MMS;
					break;

				case MENU_ID_UC_WRITE_MMS_POSTCARD:
					g_uc_p->srv_msg_type->MMS_edit_mode = MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS;
					break;
#endif /* __MMI_MMS_POSTCARD__ */
				default :
					break;
			}
			break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
        case EVT_ID_CUI_MENU_ITEM_CSK_SELECT:
			switch(menu_evt->highlighted_menu_id)
			{
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
				case MENU_ID_UC_OPT_SEND_TO:
					mmi_uc_entry_add_recipient();
					break;

				case MENU_ID_UC_OPT_ADD_SUBJECT:
				case MENU_ID_UC_OPT_EDIT_SUBJECT:
					mmi_uc_entry_edit_subject_editor_cui();
					break;
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

				case MENU_ID_UC_OPT_PREVIEW:
					mmi_uc_entry_preview();
					break;

#ifndef __MMI_MMS_STANDALONE_COMPOSER__
				case MENU_ID_UC_OPT_MSG_TYPE_CHANGE_TO_SMS:
					mmi_uc_opt_change_msg_type_to_sms();
					break;

				case MENU_ID_UC_OPT_MSG_TYPE_CHANGE_TO_MMS:
					mmi_uc_opt_change_msg_type_to_mms();
					break;
#endif
				case MENU_ID_UC_OPT_SAVE_TO_DRAFT:
					mmi_uc_pre_process_save();
					break;
#ifndef __MMI_MMS_STANDALONE_COMPOSER__
				case MENU_ID_UC_OPT_SAVE_SMS:
                     #if (MMI_MAX_SIM_NUM >=2)
				        cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_GLOBAL_SAVE), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
			        #endif
					mmi_uc_pre_process_save();
					break;
#endif
#ifdef __MMI_MMS_TEMPLATE_SUPPORT__
				case MENU_ID_UC_OPT_SAVE_AS_TEMPLATE:
					mmi_uc_process_save_as_template();
					break;
#endif
#ifndef __MMI_SLIM_MMS_2__
				case MENU_ID_UC_OPT_MSG_DETAIL:
					mmi_uc_entry_msg_detail();
					break;
#endif
				case MENU_ID_UC_OPT_INSERT_IMAGE:
				case MENU_ID_UC_OPT_INSERT_AUDIO:
#ifdef __MMI_MMS_VIDEO_FEATURE__
				case MENU_ID_UC_OPT_INSERT_VIDEO:
#endif
				case MENU_ID_UC_OPT_INSERT_ATTACHMENT:
					{
						g_uc_p->main.select_media_opt = UC_MEDIA_OPT_INSERT;
						mmi_uc_select_fmgr_object();
					}
					break;
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
				case MENU_ID_UC_OPT_HEADER_OPTIONS:
                {
//				    cui_uc_app_set_menu_for_opt_header_options(menu_evt->sender_id);
                    mmi_uc_enter_header_field();
                }
                break;

			    case MENU_ID_UC_OPT_HEADER_OPT_CC:
		        case MENU_ID_UC_OPT_HEADER_OPT_BCC:
			    case MENU_ID_UC_OPT_HEADER_OPT_SUBJECT:
			    {
				    mmi_uc_header_field_select_hdlr(menu_evt);
			    }
                break;
                case MENU_ID_UC_OPT_ADD_RECIPIENT:
                {
                    if(g_uc_p->main.highlight_state == MMI_UC_HIGHLIGHT_BCC_RECIPIENT)
                    {
                        g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_BCC;
                    }
                    else if(g_uc_p->main.highlight_state == MMI_UC_HIGHLIGHT_CC_RECIPIENT)
                    {
                        g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_CC;
                    }
                    else
                    {
                        g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_TO;
                    }
                    mmi_uc_search_phb_recipient();
                }
                break;

#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
#ifndef __MMI_SLIM_MMS_2__
		#ifdef __MMI_CAMERA__
				case MENU_ID_UC_OPT_INSERT_NEW_IMAGE:
					{
					#ifdef __MMI_UCM__
						if (srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
						{
							mmi_ucm_app_entry_error_message();
						}
						else
					#endif /* __MMI_UCM__ */  
						{
							mmi_uc_enter_multimedia_app();
						}
					}
					break;
			#endif /*__MMI_CAMERA__*/
			#ifdef __MMI_SOUND_RECORDER__
				case MENU_ID_UC_OPT_INSERT_NEW_AUDIO:
					{
					#if defined(__MMI_UCM__) && !defined (__MMI_UC_SUPPORT_SOUNDRECORDER_IN_UCM__)
						if (srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
						{
							mmi_ucm_app_entry_error_message();
						}
						else
					#endif /* __MMI_UCM__  && !defined (__MMI_UC_SUPPORT_SOUNDRECORDER_IN_UCM__)  */
						{
							mmi_uc_enter_multimedia_app();
						}
					}
					break;
			#endif /*__MMI_SOUND_RECORDER__*/
			#ifdef __MMI_MMS_VIDEO_FEATURE__
			#if defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE)
				case MENU_ID_UC_OPT_INSERT_NEW_VIDEO:
					{
					#ifdef __MMI_UCM__
						if (srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
						{
							mmi_ucm_app_entry_error_message();
						}
						else
					#endif /* __MMI_UCM__ */  
						{
							mmi_uc_enter_multimedia_app();
						}
					}
					break;
			#endif /* defined(__MMI_VIDEO_RECORDER__) && !defined(MJPG_ENCODE)*/
			#endif
#endif
			#if defined(__MMI_MESSAGES_TEMPLATE__)
				case MENU_ID_UC_OPT_INSERT_TEXT_TEMPLATE:
					mmi_uc_entry_sms_template();
					break;
			#endif /* defined(__MMI_MESSAGES_TEMPLATE__)*/
#ifndef __MMI_SLIM_MMS_2__
				case MENU_ID_UC_OPT_INSERT_PHB_NUMBER:
					mmi_uc_entry_insert_phb_number();
					break;

				case MENU_ID_UC_OPT_INSERT_PHB_NAME:
					mmi_uc_entry_insert_phb_name();
					break;
#endif
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__ 
				case MENU_ID_UC_OPT_INSERT_BOOKMARK:
					mmi_uc_entry_insert_bookmark();
					break;
#endif
#ifndef __MMI_SLIM_MMS_2__
				case MENU_ID_UC_OPT_INSERT_SIGNATURE:
					mmi_uc_add_signature();
					break;
#endif
			#ifdef __MMI_PHOTOEDITOR__
				case MENU_ID_UC_OPT_EDIT_IMAGE:
					mmi_uc_enter_edit_image();
					break;
			#endif /*__MMI_PHOTOEDITOR__*/

#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
				case MENU_ID_UC_OPT_SLIDE_OPT_IMAGE_TIMING:
					mmi_uc_entry_image_timing_inline_cui();
					break;

				case MENU_ID_UC_OPT_SLIDE_OPT_AUDIO_TIMING:
					mmi_uc_entry_audio_timing_inline_cui();
					break;

				case MENU_ID_UC_OPT_SLIDE_OPT_VIDEO_TIMING:
					mmi_uc_entry_video_timing_inline_cui();
					break;
#endif
				case MENU_ID_UC_OPT_PICTURE_OPT_IMAGE_REMOVE:
				case MENU_ID_UC_OPT_AUDIO_OPT_AUDIO_REMOVE:
				case MENU_ID_UC_OPT_VIDEO_OPT_VIDEO_REMOVE:
					mmi_uc_remove_object();
					break;

		#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
				case MENU_ID_UC_OPT_PICTURE_OPT_IMAGE_REPLACE:
				case MENU_ID_UC_OPT_AUDIO_OPT_AUDIO_REPLACE:
				case MENU_ID_UC_OPT_VIDEO_OPT_VIDEO_REPLACE:
					{
						g_uc_p->main.select_media_opt = UC_MEDIA_OPT_REPLACE;
						mmi_uc_select_fmgr_object();
					}
					break;
		#endif
				case MENU_ID_UC_OPT_ATTACH_OPT_ATTACHMENT_REMOVE:
					mmi_uc_opt_attachment_option_remove();
					break;
		#ifdef __MMI_UC_REPLACE_MEDIA_SUPPORT__
				case MENU_ID_UC_OPT_ATTACH_OPT_ATTACHMENT_REPLACE:
					{
						mmi_uc_set_group_id();
						mmi_uc_opt_attachment_option_replace();
					}
					break;
		#endif
#if defined(__MMI_MMS_2__) && !defined(__MMI_SLIM_MMS_2__)
				case MENU_ID_UC_OPT_SLIDE_OPT_TEXT_TIMING:
					mmi_uc_entry_timing_inline_cui();
					break;
#endif
				case MENU_ID_UC_OPT_SLIDE_OPT_INSERT:
					mmi_uc_entry_insert_slide();
					break;

				case MENU_ID_UC_OPT_SLIDE_OPT_INSERT_BEFORE:
					mmi_uc_entry_insert_slide_before();
					break;
#ifdef __MMI_MMS_2__
				case MENU_ID_UC_OPT_SLIDE_OPT_TIMING:
					mmi_uc_entry_slide_timing_editor_cui();
					break;
#endif /* __MMI_MMS_2__ */
				case MENU_ID_UC_OPT_SLIDE_OPT_DELETE:
					mmi_uc_entry_delete_slide();
					break;

				case MENU_ID_UC_OPT_SLIDE_OPT_NEXT:
					mmi_uc_entry_next_slide();
					break;

				case MENU_ID_UC_OPT_SLIDE_OPT_PREVIOUS:
					mmi_uc_entry_previous_slide();
					break;
#ifndef __MMI_FTE_SUPPORT__
				case MENU_ID_UC_EXIT_OPT_SAVE:
					mmi_uc_save_msg_before_exit_write_msg(); 
					break;

				case MENU_ID_UC_EXIT_OPT_EXIT:
					mmi_uc_discard_msg_before_exit_write_msg();  
					break;
#endif
 #if (MMI_MAX_SIM_NUM >=2)
				case MENU_ID_UC_OPT_SEND_SIM1:
				case MENU_ID_UC_OPT_SEND_SIM2:
#if (MMI_MAX_SIM_NUM >= 3)			
	case MENU_ID_UC_OPT_SEND_SIM3:
#if (MMI_MAX_SIM_NUM == 4)
				case MENU_ID_UC_OPT_SEND_SIM4:
#endif
#endif
					{
						if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND_AND_SAVE)
						{
							mmi_uc_process_send_and_save();
						}
						else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SAVE)
						{
							mmi_uc_process_save();
						}
						else if (g_uc_p->srv_sim_info->action == SRV_UC_ACTION_SEND)
						{
							mmi_uc_process_send();
						}
					}
					break;
#endif /*  #if (MMI_MAX_SIM_NUM >=2) */
				case MENU_ID_UC_OPT_SEND:
					{
                    #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
                        mmi_uc_remove_empty_recipients();
                        if(mmi_uc_get_buffer_recipient_count() ==0)
                        {
                            g_uc_p->done.current_addr_type = MMI_UC_ADDRESS_GROUP_TYPE_TO;
                            mmi_uc_search_phb_recipient();
                            break;
                        }
                    #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

					#ifdef __MMS_SIZE_CONFIRM_BEFORE_SEND__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                       #if (defined(__OP01__) && defined(__MMI_DUAL_SIM_MASTER__))
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                           #if(MMI_MAX_SIM_NUM >=2)
                             #if (MMI_MAX_SIM_NUM >=3)
/* under construction !*/
				            #else
/* under construction !*/
/* under construction !*/
                            #endif
						#else /* __MMI_DUAL_SIM_MASTER__ */ 
/* under construction !*/
						#endif /*  #if (MMI_MAX_SIM_NUM >=2) */
/* under construction !*/
                      #else
						 #if (MMI_MAX_SIM_NUM >=2)
                             #if (MMI_MAX_SIM_NUM >=3)
/* under construction !*/
                             #endif
/* under construction !*/
/* under construction !*/
						#else  /* #if (MMI_MAX_SIM_NUM ==2) */ 
/* under construction !*/
						#endif  /* #if (MMI_MAX_SIM_NUM ==2) */
                     #endif
/* under construction !*/
					#else /* __MMS_SIZE_CONFIRM_BEFORE_SEND__ */ 

                      #if (defined(__OP01__) && defined(__MMI_DUAL_SIM_MASTER__))
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                           #if(MMI_MAX_SIM_NUM >=2)
                             #if (MMI_MAX_SIM_NUM >=3)
/* under construction !*/
				            #else
/* under construction !*/
/* under construction !*/
                            #endif
						#else /* __MMI_DUAL_SIM_MASTER__ */ 
/* under construction !*/
						#endif /*  #if (MMI_MAX_SIM_NUM >=2) */
/* under construction !*/
                      #else
						#if(MMI_MAX_SIM_NUM >=2)
                          #if (MMI_MAX_SIM_NUM >=3)
					        mmi_uc_launch_sim();
				          #else
                            cui_menu_set_default_title(menu_evt->sender_id,  (UI_string_type) GetString(STR_GLOBAL_SEND), (UI_image_type) GetImage(IMG_UC_ENTRY_SCRN_CAPTION_ID));
							mmi_uc_pre_entry_sim_option();
                          #endif
						#else /* __MMI_DUAL_SIM_MASTER__ */ 
							mmi_uc_process_send();
						#endif /*  #if (MMI_MAX_SIM_NUM >=2) */ 
                      #endif
					#endif /* __MMS_SIZE_CONFIRM_BEFORE_SEND__ */ 
					}
					break;

				case MENU_ID_UC_OPT_SEND_OPT:
					mmi_uc_entry_send_opt_inline_cui();
					break;
#ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
				case MENU_ID_UC_OPT_EDIT_RECIPIENT:
					{
					#ifdef __MMI_MMS_POSTCARD__
						if (g_uc_p->srv_msg_type->MMS_edit_mode == MMI_UC_MMS_EDIT_MODE_POSTCARD_MMS)
						{
							mmi_postcard_entry_to_option_edit();
						}
						else
					#endif /* __MMI_MMS_POSTCARD__ */ 
						{
							/* use g_uc_p->done.to buffer to store edited address */
							memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);

							mmi_uc_pre_entry_edit_addr();
						}
					}
					break;

				case MENU_ID_UC_OPT_REMOVE_RECIPIENT:
					mmi_uc_entry_delete_addr();
					break;

				case MENU_ID_UC_OPT_REMOVE_ALL_RECIPIENTS:
					mmi_uc_entry_delete_all_addr();
					break;

				case MENU_ID_UC_OPT_CHANGE_TO_TO:
					mmi_uc_recipient_options_change_to_to();
					break;

				case MENU_ID_UC_OPT_CHANGE_TO_CC:
					mmi_uc_recipient_options_change_to_cc();
					break;

				case MENU_ID_UC_OPT_CHANGE_TO_BCC:
					mmi_uc_recipient_options_change_to_bcc();
					break;
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */

#ifdef __MMI_MMS_POSTCARD__
				case MENU_ID_UC_WRITE_MESSAGE:
				case MENU_ID_UC_WRITE_MMS_POSTCARD:
					{
						mmi_group_node_struct node_info;
						mmi_frm_group_get_info (menu_evt->sender_id, &node_info);
						mmi_frm_group_get_info (node_info.parent, &node_info);
						mmi_uc_write_msg_launch(node_info.parent);
					}
					break;
#endif /* __MMI_MMS_POSTCARD__ */

				case MENU_ID_UC_EDITOR_OPTION_DONE:
					mmi_uc_input_method_and_done_go_back_to_option();
					break;

				case MENU_ID_UC_EDITOR_OPTION_CANCEL:
					{
						mmi_uc_restore_subject_after_back_from_edit_subject();
						mmi_uc_set_group_id();
					}
					break;

				default:
					break;
			}
            break;

        case EVT_ID_CUI_MENU_LIST_EXIT:
            
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
               cui_menu_close(menu_evt->sender_id);
            break;
    }
/*general editor menu option not shown in lemei mms*/
#ifdef __MMI_OP02_LEMEI__
    if(g_uc_p->srv_msg_type->MMS_edit_mode != MMI_UC_MMS_EDIT_MODE_LEMEI_MMS)
#endif 
   {
	if(cui_menu_is_menu_event(menu_evt->evt_id))
	{
        mmi_group_node_struct node_info;
        mmi_frm_group_get_info (menu_evt->sender_id, &node_info);
        if(g_uc_p->main.highlight_state != MMI_UC_HIGHLIGHT_THUMBNAIL 
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            && g_uc_p->main.highlight_state != MMI_UC_HIGHLIGHT_AUDIO
#endif
            )
        {
		wgui_inputs_options_menu_handler((mmi_event_struct *)menu_evt, node_info.parent); // app_id is menu cuis parent groupd ID
	}
    }
    }
    return MMI_RET_OK;
}


#if defined(__MMI_UNIFIED_COMPOSER__)

/*****************************************************************************
 * FUNCTION
 *  mmi_sms_pre_entry_uc
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
static void mmi_uc_pre_entry_for_sms_in_uc(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL is_add_num = MMI_TRUE;
    MMI_BOOL is_add_content = MMI_TRUE;
    S8 *ucs2_addr = NULL;
    mmi_uc_entry_write_struct *uc_data = g_uc_p->other_app_temp_uc_info;
    mmi_uc_addr_struct *addr;
    U32 state_type = 0;
    //mmi_id uc_cui_id;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    uc_data->info = &g_uc_p->srv_send_info->existed_msg_id;

    uc_data->msg_type = MMI_UC_MSG_TYPE_DEFAULT;
    uc_data->info_type = MMI_UC_INFO_TYPE_SMS;
 #if (MMI_MAX_SIM_NUM >=2)
    uc_data->sim_id = UC_SIM_ID_UNCLASSIFIED;
#endif  /* #if (MMI_MAX_SIM_NUM ==2) */

    switch (g_uc_p->main.msg_operation)
    {
        case MMI_UC_OPERATION_REPLY:
        {
         #if (MMI_MAX_SIM_NUM >=2)
            srv_sms_sim_enum sms_sim_id;
        #endif  /* #if (MMI_MAX_SIM_NUM ==2) */

            is_add_content = MMI_FALSE;

            state_type = MMI_UC_STATE_REPLY;

         #if (MMI_MAX_SIM_NUM >=2)
            sms_sim_id = srv_sms_get_msg_sim_id(g_uc_p->srv_send_info->existed_msg_id);

            switch (sms_sim_id)
            {
                case SRV_SMS_SIM_1:
                    uc_data->sim_id = UC_SIM_ID_GSM_SIM1;
                    break;

                case SRV_SMS_SIM_2:
                    uc_data->sim_id = UC_SIM_ID_GSM_SIM2;
                    break;
          #if (MMI_MAX_SIM_NUM >= 3)
				case SRV_SMS_SIM_3:
                    uc_data->sim_id = UC_SIM_ID_GSM_SIM3;
                    break;
		  #if (MMI_MAX_SIM_NUM == 4)
                case SRV_SMS_SIM_4:
                    uc_data->sim_id = UC_SIM_ID_GSM_SIM4;
                    break;
          #endif
          #endif
				 default:
                    break;
            }
        #endif  /* #if (MMI_MAX_SIM_NUM ==2) */
            break;
        }
        /*comment :need to check archive reply here */
        case MMI_UC_OPERATION_FORWARD:
        {
            is_add_num = MMI_FALSE;
            state_type = MMI_UC_STATE_FORWARD;
            break;
        }

        case MMI_UC_OPERATION_EDIT_EXISTED_MSG:
        {
            state_type = MMI_UC_STATE_EDIT_EXISTED_MSG;
            break;
        }
            
        default:
        {
            MMI_ASSERT(0);
            break;
        }
    }
    if (is_add_content == MMI_TRUE)
    {
//        uc_data->text_buffer = g_uc_p->main.sms_temp_text_buffer;
        uc_data->text_num = mmi_ucs2strlen((PS8)uc_data->text_buffer);
    }
    else
    {
//        uc_data->text_buffer = NULL;
        uc_data->text_num = 0;
    }
    if (is_add_num == MMI_TRUE)
    {
        ucs2_addr = kal_adm_alloc(g_uc_p->main.mem_pool_id, (SRV_SMS_MAX_ADDR_LEN + 1) * ENCODING_LENGTH);
        addr = kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(mmi_uc_addr_struct));
#ifndef __MMI_SMS_SLIM__
        srv_sms_get_msg_address(g_uc_p->srv_send_info->existed_msg_id, ucs2_addr);
#else
		mmi_sms_get_hilite_msg_addr(ucs2_addr);
#endif
        addr->addr = (kal_uint8 *) ucs2_addr;
        if (mmi_ucs2strlen((PS8)addr->addr) > 0)
        {
            uc_data->addr_num++;
            if (mmi_ucs2chr((PS8)addr->addr, L'@') == NULL)
            {
                addr->type = MMI_UC_ADDRESS_TYPE_PHONE_NUMBER;
            }
            else
            {
                addr->type = MMI_UC_ADDRESS_TYPE_EMAIL;
            }
            addr->group = MMI_UC_ADDRESS_GROUP_TYPE_TO;
            uc_data->addr = addr;
        }
    }
    uc_data->get_address_callback = NULL;

    mmi_uc_entry_write_msg_with_content((mmi_uc_done_type_enum)state_type, uc_data);
/*    if (ucs2_addr != NULL)
    {
        OslMfree(ucs2_addr);
        //uc_data->addr
    }*/
    if(g_uc_p->other_app_temp_uc_info)
    {
        if(g_uc_p->other_app_temp_uc_info->text_buffer)
        {
            kal_adm_free(g_uc_p->main.mem_pool_id, g_uc_p->other_app_temp_uc_info->text_buffer);
            g_uc_p->other_app_temp_uc_info->text_buffer = NULL;
        }
        mmi_uc_free_collected_object_ind_data();
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_msg_operation_trigger_ems_object_yes_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
static void mmi_uc_msg_operation_trigger_ems_object_yes_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (g_uc_p->main.msg_operation)
    {
        case MMI_UC_OPERATION_FORWARD:
        case MMI_UC_OPERATION_EDIT_EXISTED_MSG:
        {
            mmi_uc_pre_entry_for_sms_in_uc();
            break;
        }

        default:
            mmi_uc_pre_entry_for_sms_in_uc();
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_msg_operation_trigger_ems_object_no_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
static void mmi_uc_msg_operation_trigger_ems_object_no_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
   mmi_frm_group_close(g_uc_p->main.uc_cui_gid);
   g_uc_p->main.uc_cui_gid = GRP_ID_INVALID;
}

#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_arch_sms_callback
 * DESCRIPTION
 *  Delete SMS msg response
 * PARAMETERS
 *  dummy       [?]         
 *  mod         [IN]        
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_delete_arch_sms_callback(srv_sms_callback_struct* callback_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (callback_data->result == MMI_TRUE)
    {

    #ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
        mmi_msg_update_unsent_icon();
    #endif 
        srv_uc_send_um_msg_refresh_ind(
            g_uc_p->main.instance,
            SRV_UM_MSG_BOX_ARCHIVE,
            SRV_UM_MSG_SMS);
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_DELETED)), MMI_EVENT_EXPLICITLY_DELETED, NULL);
    }
    else
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);
    }
    mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_CONFIRM);
    return;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_arch_msg_yes_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
static void mmi_uc_delete_arch_msg_yes_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	mmi_uc_enable_csk_for_confirmation_popup();
    srv_sms_delete_msg(
            g_uc_p->srv_send_info->existed_msg_id,
            mmi_uc_delete_arch_sms_callback,
            NULL);
    return;

}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_msg_operation_trigger_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
static void mmi_uc_msg_operation_trigger_callback(srv_sms_callback_struct *callback_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	srv_sms_msg_data_struct * msg_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	msg_data = (srv_sms_msg_data_struct *)(((srv_sms_read_msg_cb_struct*)callback_data->action_data)->msg_data);

    if (callback_data->result)
    {
        if(msg_data->is_with_obj &&
            (g_uc_p->main.msg_operation == MMI_UC_OPERATION_FORWARD ||
            g_uc_p->main.msg_operation == MMI_UC_OPERATION_EDIT_EXISTED_MSG))
        {
            if (msg_data)
	        {
		        OslMfree(msg_data);
		        msg_data = NULL;
	        }
			mmi_uc_enable_csk_for_confirmation_popup();
            mmi_uc_setSoftkeyFunction(
                mmi_uc_msg_operation_trigger_ems_object_yes_callback,
				mmi_uc_msg_operation_trigger_ems_object_no_callback,
                (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
                (U16) STR_UC_REMOVE_EMS_OBJECT_CONFIRM);
            mmi_uc_entry_displayConfirm_generic();
            mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
            return;
        }
        if (msg_data)
	    {
		    OslMfree(msg_data);
		    msg_data = NULL;
	    }
        switch (g_uc_p->main.msg_operation)
        {
            case MMI_UC_OPERATION_FORWARD:
            case MMI_UC_OPERATION_EDIT_EXISTED_MSG:
            {
                mmi_uc_pre_entry_for_sms_in_uc();
                break;
            }

            default:
                mmi_uc_pre_entry_for_sms_in_uc();
                break;
        }
    }
    #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
    else if(callback_data->cause == SRV_SMS_CAUSE_ARCH_FILE_NOT_EXIST)
    {
		mmi_uc_disable_csk_for_confirmation_popup();
        mmi_uc_setSoftkeyFunction(
            mmi_uc_delete_arch_msg_yes_callback,
            mmi_uc_go_back_history_from_confirm,
            (U8) mmi_get_event_based_sound(MMI_EVENT_QUERY),
            (U16) STR_UC_CORRUPT_MSG_DELETE_CONFIRM);
        mmi_uc_entry_displayConfirm_generic();
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
    }
    #endif
    else
    {
        // might require to show any popup.
        if (msg_data)
	    {
		    OslMfree(msg_data);
		    msg_data = NULL;
	    }
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_UNFINISHED)), MMI_EVENT_FAILURE, NULL);    
        mmi_frm_scrn_close(g_uc_p->main.uc_cui_gid, SCR_ID_UC_PROCESSING);
    }
}

MMI_BOOL mmi_uc_sms_msg_operation_trigger(U32 msg_id, mmi_uc_msg_operation_enum operation)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    srv_sms_msg_data_struct * msg_data;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->other_app_temp_uc_info = kal_adm_alloc(g_uc_p->main.mem_pool_id, sizeof(mmi_uc_entry_write_struct));
    if(g_uc_p->other_app_temp_uc_info)
    {
        memset(g_uc_p->other_app_temp_uc_info, 0, sizeof(mmi_uc_entry_write_struct));
    }
    else
    {
        MMI_ASSERT(0);
    }

    g_uc_p->srv_send_info->existed_msg_id = msg_id;
    g_uc_p->main.msg_operation = operation;
    msg_data = (srv_sms_msg_data_struct*)OslMalloc(sizeof(srv_sms_msg_data_struct));

    msg_data->para_flag = SRV_SMS_PARA_CONTENT_BUFF;
    msg_data->content_buff_size = 160 * (MMI_SMS_MAX_MSG_SEG) * ENCODING_LENGTH; //MMI_UC_MAX_SMS_CONTENT  * ENCODING_LENGTH;

    msg_data->content_buff = kal_adm_alloc(g_uc_p->main.mem_pool_id, msg_data->content_buff_size);
    g_uc_p->other_app_temp_uc_info->text_buffer = (kal_uint8 *)msg_data->content_buff;
//    msg_data->content_buff;
    //msg_data->para_flag = SRV_SMS_PARA_CONTENT_BUFF;
    /*  it will read the SMS as text format
    we will skip the EMS's object if exists*/

    //msg_data->content_ems = (EMSData*)GetEMSDataForView(NULL, 1);

#ifdef __MMI_MESSAGES_SMS_EMAIL__
    msg_data->para_flag |= SRV_SMS_PARA_PID;
#endif /* __MMI_MESSAGES_SMS_EMAIL__ */

    srv_sms_read_msg(
        msg_id,
        MMI_FALSE,
        msg_data,
        mmi_uc_msg_operation_trigger_callback,
        (void*)NULL);

    return MMI_TRUE;
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_main_group_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_uc_set_main_group_id(mmi_id group_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.uc_cui_gid = group_id;
	return MMI_TRUE ;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_set_parent_group_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_uc_set_parent_group_id(mmi_id group_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_uc_p->main.parent_cui_gid = group_id;
	return MMI_TRUE ;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enable_csk_for_confirmation_popup
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
void mmi_uc_enable_csk_for_confirmation_popup(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	g_uc_p->main.confirm_flag_onoff = MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enable_csk_for_confirmation_popup
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
void mmi_uc_disable_csk_for_confirmation_popup(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	g_uc_p->main.confirm_flag_onoff = MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enable_csk_for_confirmation_popup
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
void mmi_uc_go_back_history_from_confirm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_uc_enable_csk_for_confirmation_popup();
	mmi_frm_scrn_close_active_id();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_force_close
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
mmi_ret mmi_uc_force_close(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (srv_bootup_is_booting())
    {
        /* No data account screen yet */
        return MMI_RET_OK;
    }
    if ((g_uc_p->main.uc_cui_gid != 0) && mmi_frm_group_is_present(g_uc_p->main.uc_cui_gid))
    {
        #ifndef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
            if(g_uc_p && g_uc_p->srv_msg_type && (g_uc_p->srv_msg_type->curr_msg_type == MMI_UC_MSG_TYPE_SMS_PREFER) && 
                g_uc_p->send_info.abort != MMI_UC_ABORT_BY_END_KEY && 
                g_uc_p->srv_send_info && (g_uc_p->srv_send_info->action == SRV_UC_ACTION_SEND_AND_SAVE ||
                g_uc_p->srv_send_info->action == SRV_UC_ACTION_SEND))
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_USB_MS_PLUG_IN_HDLR_FG_SEND_CNCL);
                srv_sms_clear_send_callback(g_uc_p->main.send_handle);
                srv_sms_abort_send(g_uc_p->main.send_handle);
                mmi_uc_reset_msg();
                srv_reminder_enable(SRV_REMINDER_TYPE_SPOF,  MMI_TRUE);
		        return MMI_RET_OK;
            }
        #endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
            mmi_uc_reset_msg();
    }
    return MMI_RET_OK;
}

#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_enter_header_field
 * DESCRIPTION
 *  highlight handler for advance options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_enter_header_field(void)
{
    mmi_uc_frm_cntrlr_screen_render_start(MMI_UC_FLOW_INSTANCE_ID_OPT_HEADER_FIELDS);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_handle_user_selection_for_screen
 * DESCRIPTION
 *  Handles the user's selection regarding which fields to show on screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_handle_user_selection_for_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //mmi_uc_insert_sig_result_enum pass_sig_check = MMI_UC_INSERT_SIG_RESULT_PASS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!g_uc_p->main.cc_region_flag)
    {
        mmi_uc_delete_recipients_by_region(WGUI_UCE_CC_RECIPIENTS);
    }
    if(!g_uc_p->main.bcc_region_flag)
    {
        mmi_uc_delete_recipients_by_region(WGUI_UCE_BCC_RECIPIENTS);
    }
    if(!g_uc_p->main.subject_region_flag)
    {
        memset(g_uc_p->srv_msg->subject, 0, sizeof(g_uc_p->srv_msg->subject));
    }

/*    if (mmi_uc_change_msg_type_if_needed())
    {
        mmi_uc_disply_msg_type_change();
    }
*/  
    srv_uc_update_msg_size(g_uc_p->main.instance);
    //mmi_uc_switch_slide(g_uc_p->srv_msg->msg_body.curr_slide);
    srv_uc_reset_text_buffer(g_uc_p->main.instance);
    mmi_uc_editor_initialize();
    mmi_uc_recipient_initialize();
    if (g_uc_p->srv_msg->msg_body.curr_slide != NULL && g_uc_p->srv_msg->msg_body.curr_slide->txt.object)
    {
        srv_uc_read_file_to_text_buffer(
            g_uc_p->main.instance,
            (U8*) g_uc_p->srv_msg->msg_body.curr_slide->txt.object->file_path_ucs,
            g_uc_p->srv_msg->msg_body.curr_slide->txt.object->encoding);
    }
    mmi_uc_set_editor_info(g_uc_p->srv_msg->msg_body.curr_slide);
    /* Check whether message type changes */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_delete_recipients_by_region
 * DESCRIPTION
 *  Deletes all the recipients belonging to a certain group
 * PARAMETERS
 *  group [IN]
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_delete_recipients_by_region(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	for(count = 0; count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; count++)
	{
        if(g_uc_p->main.recipient_info[count].region_id == region_id)
        {
            U32 i;
            for (i = count + 1; i < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS; i++)
            {
                U32 length = mmi_ucs2strlen((S8*) g_uc_p->main.recipient_buffer[i]);
                g_uc_p->main.recipient_info[i - 1].is_valid = g_uc_p->main.recipient_info[i].is_valid;
                g_uc_p->main.recipient_info[i - 1].editor_flags = g_uc_p->main.recipient_info[i].editor_flags;
                g_uc_p->main.recipient_info[i - 1].region_id = g_uc_p->main.recipient_info[i].region_id;
                g_uc_p->main.recipient_info[i - 1].app_mapping_index = g_uc_p->main.recipient_info[i].app_mapping_index;
                if(length)
                {
                    mmi_ucs2ncpy((S8*) g_uc_p->main.recipient_buffer[i - 1], (S8*) g_uc_p->main.recipient_buffer[i], length);
                }
                else
                {
                    memset(g_uc_p->main.recipient_buffer[i - 1], 0, (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
                }
            }
            g_uc_p->main.recipient_info[i - 1].is_valid = MMI_FALSE;
            g_uc_p->main.recipient_info[i - 1].region_id = (wgui_uce_region_id_enum)0;
            g_uc_p->main.recipient_info[i - 1].editor_flags = 0;
            g_uc_p->main.recipient_info[i - 1].app_mapping_index = -1;
            memset(g_uc_p->main.recipient_buffer[i - 1], 0, (MMI_UC_CUSTOM_MAX_ADDR_LEN + 2) * ENCODING_LENGTH);
            count--;
        }
    }
}

#ifdef __MMI_IMAGE_VIEWER__
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_img_view_cui_group_proc
 * DESCRIPTION
 *  Image viewer proc function
 * PARAMETERS
 *  evt [IN]
 * RETURNS
 *  mmi_ret
 *****************************************************************************/
mmi_ret mmi_uc_img_view_cui_group_proc(mmi_event_struct* evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(evt->evt_id)
    {
/*
        case EVT_ID_GROUP_ENTER:
            break;
        case EVT_ID_GROUP_ACTIVE:
            break;
        case EVT_ID_GROUP_FOCUSED:
            break;
        case EVT_ID_GROUP_GOBACK:
            break;
        case EVT_ID_GROUP_INACTIVE:
            break;
        case EVT_ID_GROUP_EXIT:
            break;
        case EVT_ID_GROUP_DEINIT:
            break;
*/
        case EVT_ID_IMGVIEW_CLOSE_GID:
        {
            cui_imgview_close(g_uc_p->main.cui_img_view_gid);
            mmi_frm_group_close(g_uc_p->main.uc_img_view_cui_id);
            g_uc_p->main.cui_img_view_gid = GRP_ID_INVALID;
            g_uc_p->main.uc_img_view_cui_id = GRP_ID_INVALID;

            break;
        }
        default:
            break;
    }
    return MMI_RET_OK;
}
#endif /*__MMI_IMAGE_VIEWER__*/

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_play_highlighted_object
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_play_highlighted_object(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 *filepath = NULL;
    mma_mms_object_struct *object = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(g_uc_p->main.highlight_state == MMI_UC_HIGHLIGHT_AUDIO)
    {
        object = g_uc_p->srv_msg->msg_body.curr_slide->aud.object;
    }
    else if(g_uc_p->main.highlight_state == MMI_UC_HIGHLIGHT_THUMBNAIL)
    {
        if(g_uc_p->srv_msg->msg_body.curr_slide->img.object)
        {
            object = g_uc_p->srv_msg->msg_body.curr_slide->img.object;
        }
        else if(g_uc_p->srv_msg->msg_body.curr_slide->vid.object)
        {
            object = g_uc_p->srv_msg->msg_body.curr_slide->vid.object;
        }
    }

    if(object && (object->drm_type == MMA_DRM_NONE || object->drm_type == MMA_DRM_SD))
    {
        if (object->is_virtual_file)
        {
            U8 virtual_file_name[(FS_GenVFN_SIZE + SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH];
            S32 result;
            U16 virtual_file_name_len = sizeof(virtual_file_name);

            memset(virtual_file_name, 0, virtual_file_name_len);
            if (g_uc_p->srv_main->file_handle <= 0)
            {
                g_uc_p->srv_main->file_handle = FS_Open((const WCHAR *)object->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);
            }

            if (g_uc_p->srv_main->file_handle <= 0)
            {
                return;
                //MMI_ASSERT(0);
            }

            result = FS_GenVirtualFileName(
                        g_uc_p->srv_main->file_handle,
                        (U16*) virtual_file_name,
                        (unsigned int)FS_GenVFN_SIZE,
                        object->offset,
                        object->size);

            if (result < 0)
            {
                return;
                //MMI_ASSERT(0);
            }

            mmi_ucs2cat((PS8) virtual_file_name, (PS8) L".");
            if (srv_uc_get_file_extension((U16 *)object->file_name_ucs) == NULL)
            {
                return;
                //MMI_ASSERT(0);
            }

            mmi_ucs2ncat(
                (PS8) virtual_file_name,
                (PS8) srv_uc_get_file_extension((U16 *)object->file_name_ucs),
                virtual_file_name_len / ENCODING_LENGTH);

            filepath = kal_adm_alloc(g_uc_p->main.mem_pool_id, virtual_file_name_len + ENCODING_LENGTH);
            mmi_ucs2ncpy((S8*) filepath, (S8*) virtual_file_name, virtual_file_name_len / ENCODING_LENGTH);

        }
        else
        {
            U16 length = mmi_ucs2strlen((S8*) object->file_path_ucs);
            filepath = kal_adm_alloc(g_uc_p->main.mem_pool_id, (length + 1) * ENCODING_LENGTH);
            mmi_ucs2ncpy((S8*) filepath, (S8*) object->file_path_ucs, length);
        }

        if(g_uc_p->main.highlight_state == MMI_UC_HIGHLIGHT_AUDIO)
        {
            if(g_uc_p->srv_msg->msg_body.curr_slide->aud.object)
            {
                mmi_uc_play_audio_player((U16 *)object->file_name_ucs, filepath);
            }
        }
        else if(g_uc_p->main.highlight_state == MMI_UC_HIGHLIGHT_THUMBNAIL)
        {
            if(g_uc_p->srv_msg->msg_body.curr_slide->img.object)
            {
                mmi_uc_play_image_viewer((U16 *)object->file_name_ucs, filepath);
            }
            else if(g_uc_p->srv_msg->msg_body.curr_slide->vid.object)
            {
                mmi_uc_play_video_player((U16 *)object->file_name_ucs, filepath);
            }
        }
        kal_adm_free(g_uc_p->main.mem_pool_id, filepath);
    }
    else if(object && object->drm_type != MMA_DRM_NONE)
    {
        mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_GLOBAL_DRM_PROHIBITED)), MMI_EVENT_ERROR, NULL);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_play_image_viewer
 * DESCRIPTION
 *  Launch image viewer from composer screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_play_image_viewer(U16* filename, U16 *filepath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IMAGE_VIEWER__
    g_uc_p->main.uc_img_view_cui_id = mmi_frm_group_create(GRP_ID_ROOT, GRP_ID_AUTO_GEN, mmi_uc_img_view_cui_group_proc, 0);
    mmi_frm_group_enter(g_uc_p->main.uc_img_view_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    if ((g_uc_p->main.cui_img_view_gid = cui_imgview_create(g_uc_p->main.uc_img_view_cui_id)) != GRP_ID_INVALID)
    {
        cui_imgview_set_mode_filename(g_uc_p->main.cui_img_view_gid, (S8*) filepath);
        cui_imgview_set_title(g_uc_p->main.cui_img_view_gid, filename, 0);
        cui_imgview_set_ui_direction(g_uc_p->main.cui_img_view_gid, CUI_IMGVIEW_UI_DIRECTION_VERTICAL);
        cui_imgview_set_display_cap(g_uc_p->main.cui_img_view_gid, CUI_IMGVIEW_CAP_ALL, MMI_FALSE);
        cui_imgview_set_display_cap(g_uc_p->main.cui_img_view_gid, CUI_IMGVIEW_CAP_ZOOM, MMI_TRUE);   
        cui_imgview_set_display_cap(g_uc_p->main.cui_img_view_gid, CUI_IMGVIEW_CAP_IMG_ROTATE, MMI_TRUE);   
        cui_imgview_set_display_cap(g_uc_p->main.cui_img_view_gid, CUI_IMGVIEW_CAP_UI_ROTATE, MMI_TRUE);   
        cui_imgview_set_display_cap(g_uc_p->main.cui_img_view_gid, CUI_IMGVIEW_CAP_TITLE, MMI_TRUE);   

        cui_imgview_run(g_uc_p->main.cui_img_view_gid);
    }
    else
    {
        mmi_frm_group_close(g_uc_p->main.uc_img_view_cui_id);
    }
#endif /* __MMI_IMAGE_VIEWER__ */
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_play_video_player
 * DESCRIPTION
 *  Launch video player from composer screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_play_video_player(U16 *filename, U16 *filepath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* TODO : Need to check DRM permission */
#if defined(__MMI_VIDEO_PLAYER__) || defined(__MMI_MEDIA_PLAYER_VIDEO__)

    #ifdef __MMI_VIDEO_STREAM__  
        S32 fmgr_type = srv_fmgr_types_find_type_by_filepath((const WCHAR*)filepath);

        if (fmgr_type == FMGR_TYPE_SDP)
        {
            mmi_media_app_play_stream_from_sdp_file_ext(filepath, FALSE, (S8*)filename);
        }
        else if (fmgr_type == FMGR_TYPE_RAM)
        {
            mmi_media_app_play_stream_from_ram_file(filepath, FALSE);
        }
        else /* other video type */
        {
            mmi_media_app_play_video_ext(filepath, FALSE, (S8*)filename);
        }
    #else
        mmi_media_app_play_video_ext(filepath, FALSE, (S8*)filename);
    #endif /* __MMI_VIDEO_STREAM__ */ 

#endif
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_play_audio_player
 * DESCRIPTION
 *  Launch audio player from composer screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_play_audio_player(U16 *filename, U16 *filepath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* TODO : Need to check DRM permission */
    mmi_media_app_play_audio_with_title(filepath, NULL, 0, (S8*)filename);
}

 #ifdef __MMI_UC_MULTI_SELECT__ 
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_search_name_proc
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_uc_search_name_proc(mmi_event_struct *evt)
{
    switch (evt->evt_id)
    {
        case EVT_ID_PHB_SEARCH_CONTACT_PRE_RUN:
        {
            cui_phb_search_contact_result_struct *result = (cui_phb_search_contact_result_struct*)evt;

            if (result->count > 1   /* match more than one contact, should show mark contact screen */
                || result->count == 1 && result->num_count > 1 /* match one contact, but it has more than one number,
                                                                  should show choose number screen */
                )
            {
                cui_phb_search_contact_run(g_uc_p->main.cui_phb_srch_name_gid);
            }
            else if (result->count == 1 && result->num_count == 1) /* match one contact, and only one number */
            {
                U8 temp[(MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH];
                memset(temp, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
                mmi_ucs2ncpy((S8*)temp, (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);

                cui_phb_search_contact_get_data(
                    g_uc_p->main.cui_phb_srch_name_gid,
                    result->id,
                    result->field_type,
                    (U16 *)g_uc_p->done.to,
                    MMI_UC_CUSTOM_MAX_ADDR_LEN,
                    MMI_FALSE);

                if (mmi_ucs2strlen((S8*) g_uc_p->done.to) == 0)
                {
                    cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
                    mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
					if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                       g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
					{
	             	g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
	            	g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
					}
                    g_uc_p->main.operation = NULL;
                    g_uc_p->main.recipient_count = 0;
                }
                else
                {
                    U8 count=g_uc_p->main.recipient_count;
                    if(mmi_uc_add_recipient())
                    {
                        S32 pos = mmi_uc_add_get_recipient_position();
                        mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                        mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)temp, mmi_ucs2strlen((S8*) temp));
                        mmi_uc_add_phb_entry_to_buffer(pos, g_uc_p->main.recipient_count);
                        mmi_uc_recipient_initialize();
                        g_uc_p->main.recipient_count++;
                        if(mmi_uc_change_msg_type_if_needed())
                        {
                            g_uc_p->main.phb_search_name_flag = 1;
                        }
                    }
                    else
                    {
                        cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
                        mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
						if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                           g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
						{
	                	g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
	                	g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
						}
                        g_uc_p->main.operation = NULL;
                        g_uc_p->main.recipient_info[count].editor_flags = WGUI_UCE_HIGHLIGHT_RECIPIENT;
                        //mmi_uc_recipient_initialize();
                        g_uc_p->main.recipient_count = 0;
                        if(g_uc_p->main.phb_search_name_flag)
                        {
                            g_uc_p->main.phb_search_name_flag = 0;
                        }
                        break;
                    }
                    cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
                    mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
					if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                     g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
					{
	            	g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
	            	g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
					}
                    if(g_uc_p->main.operation)
                    {
                        uc_confirm_func_ptr operation;
                        operation = g_uc_p->main.operation;
                        g_uc_p->main.operation = NULL;
                        operation();
                    }
                    else
                    {
                        ASSERT(0);
                    }
                }
            }
            else
            {
                cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
                mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
				if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                 g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
				{
		         g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
		         g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
				}
                if(g_uc_p->main.operation)
                {
                    g_uc_p->main.operation = NULL;
                }
                mmi_popup_display((WCHAR*)((UI_string_type) GetString(STR_ID_UC_INVALID_RECIPIENT)), MMI_EVENT_ERROR, NULL);
                g_uc_p->main.recipient_info[g_uc_p->main.recipient_count].editor_flags = WGUI_UCE_HIGHLIGHT_RECIPIENT;
                //mmi_uc_recipient_initialize();
                g_uc_p->main.recipient_count = 0;
            }
            break;
        }
        case EVT_ID_PHB_SEARCH_CONTACT:
        {
            U8 temp[(MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH];
            cui_phb_search_contact_result_struct *result = (cui_phb_search_contact_result_struct*)evt;
            memset(temp, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);
            mmi_ucs2ncpy((S8*)temp, (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
            memset(g_uc_p->done.to, 0, (MMI_UC_MAX_EMAIL_LEN + 1) * ENCODING_LENGTH);

            cui_phb_search_contact_get_data(
                g_uc_p->main.cui_phb_srch_name_gid,
                result->id,
                result->field_type,
                (U16 *)g_uc_p->done.to,
                MMI_UC_CUSTOM_MAX_ADDR_LEN,
                (result->count > 0) ? MMI_TRUE : MMI_FALSE);

            if (mmi_ucs2strlen((S8*) g_uc_p->done.to) == 0)
            {
                cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
                mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
                if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                 g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
				{
		         g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
		         g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
				}
                g_uc_p->main.operation = NULL;
                g_uc_p->main.recipient_count = 0;
                if(g_uc_p->main.phb_search_name_flag)
                {
                    g_uc_p->main.phb_search_name_flag = 0;
                    mmi_uc_disply_msg_type_change();
                }
            }
            else
            {
/*                if(result->count > 0)
                {

                    if(mmi_uc_is_valid_recipient() && mmi_uc_shift_recipients_down())
                    {
                        S32 pos = mmi_uc_add_get_recipient_position();
                        mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                        mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)temp, mmi_ucs2strlen((S8*) temp));
                        mmi_uc_add_phb_entry_to_buffer(pos, g_uc_p->main.recipient_count + 1);
                        mmi_uc_recipient_initialize();
                        if(mmi_uc_change_msg_type_if_needed())
                        {
                            g_uc_p->main.phb_search_name_flag = 1;
                        }
                    }
                }
                else
*/
                if(g_uc_p->main.recipient_count < WAP_CUSTOM_CFG_MAX_MMS_ADDRESS)
                {
                     U8 count=g_uc_p->main.recipient_count;
                    if(mmi_uc_add_recipient())
                    {
                        S32 pos = mmi_uc_add_get_recipient_position();
                        mmi_ucs2ncpy((S8*)g_uc_p->main.recipient_value[pos], (S8*)g_uc_p->done.to, mmi_ucs2strlen((S8*) g_uc_p->done.to));
                        mmi_ucs2ncpy((S8*)g_uc_p->done.to, (S8*)temp, mmi_ucs2strlen((S8*) temp));
                        if(result->count > 0)
                        {
                            mmi_uc_shift_recipients_down();
                        }
                        mmi_uc_add_phb_entry_to_buffer(pos, g_uc_p->main.recipient_count);
                        mmi_uc_recipient_initialize();
                        g_uc_p->main.recipient_count++;
                    }
                    else
                    {
                        cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
                        mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
						if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                           g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
						{
		                  g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
		                  g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
						}
                        g_uc_p->main.operation = NULL;
                        g_uc_p->main.recipient_info[ count].editor_flags = WGUI_UCE_HIGHLIGHT_RECIPIENT;
                        //mmi_uc_recipient_initialize();
                        g_uc_p->main.recipient_count = 0;
                        if(g_uc_p->main.phb_search_name_flag)
                        {
                            g_uc_p->main.phb_search_name_flag = 0;
                        }
                        break;
                    }
                }
                else
                {
                    g_uc_p->main.phb_max_recipient_flag = 1;
                }

                if(result->count == 0)
                {
                    if(mmi_uc_change_msg_type_if_needed())
                    {
                        g_uc_p->main.phb_search_name_flag = 1;
                    }
                    cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
                    mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
					if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                    g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
					{
		            g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
		            g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
					}
                    if(g_uc_p->main.operation)
                    {
                        uc_confirm_func_ptr operation;
                        operation = g_uc_p->main.operation;
                        g_uc_p->main.operation = NULL;
                        operation();
                    }
                    else
                    {
                        ASSERT(0);
                    }
                }
            }
            break;
        }
        case EVT_ID_PHB_SEARCH_CONTACT_CANCEL:
            /* close cui */            
            cui_pbh_search_contact_close(g_uc_p->main.cui_phb_srch_name_gid);
            mmi_frm_group_close(g_uc_p->main.uc_phb_srch_name_cui_id);
			if(g_uc_p->main.uc_phb_srch_name_cui_id != GRP_ID_INVALID || 
                 g_uc_p->main.cui_phb_srch_name_gid != GRP_ID_INVALID)
				{
		         g_uc_p->main.uc_phb_srch_name_cui_id = GRP_ID_INVALID;
		         g_uc_p->main.cui_phb_srch_name_gid = GRP_ID_INVALID;
				}
            g_uc_p->main.operation = NULL;
            g_uc_p->main.recipient_count = 0;
            if(g_uc_p->main.phb_search_name_flag)
            {
                g_uc_p->main.phb_search_name_flag = 0;
                mmi_uc_disply_msg_type_change();
            }
            break;
            
        case EVT_ID_PHB_CONTACT_NOT_READY:
            /* DON"T close cui. It'll close by itself */
            g_uc_p->main.operation = NULL;
            g_uc_p->main.recipient_count = 0;
            if(g_uc_p->main.phb_search_name_flag)
            {
                g_uc_p->main.phb_search_name_flag = 0;
                mmi_uc_disply_msg_type_change();
            }
            break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_search_name
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_uc_search_name(void)
{
    cui_phb_search_contact_struct search_data;

    g_uc_p->main.uc_phb_srch_name_cui_id = mmi_frm_group_create(GRP_ID_ROOT, GRP_ID_AUTO_GEN, mmi_uc_search_name_proc, 0);
    mmi_frm_group_enter(g_uc_p->main.uc_phb_srch_name_cui_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    cui_phb_search_contact_init(&search_data);
    search_data.search_data = (U16 *)g_uc_p->done.to;
    search_data.length = mmi_wcslen((const WCHAR *)g_uc_p->done.to);
    if(g_uc_p->srv_msg_type->caller_specific_msg_type == MMI_UC_MSG_TYPE_SMS_ONLY) 
    {
        search_data.get_field = SRV_PHB_ENTRY_FIELD_GSM_NUM;
    }
    else
    {
        search_data.get_field = SRV_PHB_ENTRY_FIELD_GSM_NUM | SRV_PHB_ENTRY_FIELD_EMAIL;
    }

    g_uc_p->main.cui_phb_srch_name_gid = cui_phb_search_contact_create(g_uc_p->main.uc_phb_srch_name_cui_id, &search_data);
    cui_phb_search_contact_pre_run(g_uc_p->main.cui_phb_srch_name_gid);
}
#endif /* #ifdef __MMI_UC_MULTI_SELECT__ */
#endif /* #ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__ */


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_change_msg_type_if_needed
 * DESCRIPTION
 *  Change msg type if needed.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_change_msg_type_if_needed(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    #ifndef __MMI_MMS_STANDALONE_COMPOSER__
    srv_uc_msg_type_enum msg_type;
    #endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(
        MMI_COMMON_TRC_G6_MSG,
        TRC_MMI_UC_CHANGE_MSG_TYPE_IF_NEEDED_P3,
        g_uc_p->srv_msg_type->curr_msg_type,
        g_uc_p->srv_msg_type->caller_specific_msg_type,
        g_uc_p->srv_msg_type->setting_msg_type);

#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == SRV_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        MMI_ASSERT(g_uc_p->srv_msg_type->caller_specific_msg_type == SRV_UC_MSG_TYPE_MMS_ONLY);
        g_uc_p->srv_msg_type->curr_msg_type = SRV_UC_MSG_TYPE_MMS_PREFER;
        return MMI_FALSE;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 
#ifndef __MMI_MMS_STANDALONE_COMPOSER__
    msg_type = mmi_uc_determine_msg_type_by_content();
#endif
    switch (g_uc_p->srv_msg_type->caller_specific_msg_type)
    {
    #ifndef __MMI_MMS_STANDALONE_COMPOSER__
        case SRV_UC_MSG_TYPE_SMS_ONLY:
        {
            MMI_ASSERT(g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_SMS_PREFER);
        }
            break;
    #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
        case SRV_UC_MSG_TYPE_MMS_ONLY:
        {
        #ifdef __MMI_MMS_POSTCARD__
            if (g_uc_p->srv_msg_type->MMS_edit_mode != SRV_UC_MMS_EDIT_MODE_POSTCARD_MMS)
            {
                MMI_ASSERT(g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER);
            }
        #endif /* __MMI_MMS_POSTCARD__ */ 
        }
            break;

        case SRV_UC_MSG_TYPE_DEFAULT:
        {
            if (g_uc_p->srv_msg_type->setting_msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
            {
            #ifndef __MMI_MMS_STANDALONE_COMPOSER__
                if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
                {
                    if (msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
                    {
                        g_uc_p->srv_msg_type->curr_msg_type = SRV_UC_MSG_TYPE_SMS_PREFER;
                        if(g_uc_p->srv_msg->msg_body.curr_slide)
                        {
                        g_uc_p->srv_msg->msg_body.curr_slide->duration = g_uc_p->srv_msg->slide_timing;
                        }
                        /* tricky! allow to insert signature for all case after rechange */
                        g_uc_p->srv_msg->auto_signature_inserted = MMI_FALSE;
                        g_uc_p->srv_msg->signature_inserted = MMI_FALSE;
                        return MMI_TRUE;
                    }
                }
                else if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
                {
                    if (msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
                    {
                        g_uc_p->srv_msg_type->curr_msg_type = SRV_UC_MSG_TYPE_MMS_PREFER;
                        return MMI_TRUE;
                    }
                }
                else
                {
                    MMI_ASSERT(0);
                }
            #else /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
                MMI_ASSERT(0);
            #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 
            }
            else if (g_uc_p->srv_msg_type->setting_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
            {
                if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
                {
                    /* Do nothing. */
                }
                else if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
                {
                    MMI_ASSERT(0);
                }
                else
                {
                    MMI_ASSERT(0);
                }
            }
            else
            {
                MMI_ASSERT(0);
            }
        }
            break;
    #ifndef __MMI_MMS_STANDALONE_COMPOSER__
        case SRV_UC_MSG_TYPE_SMS_PREFER:
        {
            if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
            {
                if (msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
                {
                    g_uc_p->srv_msg_type->curr_msg_type = SRV_UC_MSG_TYPE_SMS_PREFER;
                    if(g_uc_p->srv_msg->msg_body.curr_slide)
                    {
                    g_uc_p->srv_msg->msg_body.curr_slide->duration = g_uc_p->srv_msg->slide_timing;
                    }
                    /* tricky! allow to insert signature for all case after rechange */
                    g_uc_p->srv_msg->auto_signature_inserted = MMI_FALSE;
                    g_uc_p->srv_msg->signature_inserted = MMI_FALSE;
                    return MMI_TRUE;
                }
            }
            else if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
            {
                if (msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
                {
                    g_uc_p->srv_msg_type->curr_msg_type = SRV_UC_MSG_TYPE_MMS_PREFER;
                    return MMI_TRUE;
                }
                /* tricky! allow to insert signature for all case after rechange */
                g_uc_p->srv_msg->auto_signature_inserted = MMI_FALSE;
                g_uc_p->srv_msg->signature_inserted = MMI_FALSE;
            }
            else
            {
                MMI_ASSERT(0);
            }
        }
            break;
    #endif /* __MMI_MMS_STANDALONE_COMPOSER__ */ 

        case SRV_UC_MSG_TYPE_MMS_PREFER:
        {
            if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_MMS_PREFER)
            {
                /* Do nothing. */
            }
            else if (g_uc_p->srv_msg_type->curr_msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
            {
                MMI_ASSERT(0);
            }
            else
            {
                MMI_ASSERT(0);
            }
        }
            break;

        default:
        {
            MMI_ASSERT(0);
        }
    }

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_determine_msg_type_by_content
 * DESCRIPTION
 *  
 * PARAMETERS
 *  instance        [IN]        
 * RETURNS
 *  
 *****************************************************************************/
srv_uc_msg_type_enum mmi_uc_determine_msg_type_by_content(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_uc_addr_struct *addr = g_uc_p->srv_msg->to_head;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
    if(g_uc_p->main.cc_region_flag || g_uc_p->main.bcc_region_flag || g_uc_p->main.subject_region_flag)
    {
        return SRV_UC_MSG_TYPE_MMS_PREFER;
    }

    if(!g_uc_p->main.check_buffer_flag)
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
    {
        while (addr)
        {
            if (addr->group == SRV_UC_ADDRESS_GROUP_TYPE_CC)
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_CC, 0);

                return SRV_UC_MSG_TYPE_MMS_PREFER;
            }
            else if (addr->group == SRV_UC_ADDRESS_GROUP_TYPE_BCC)
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_BCC, 0);

                return SRV_UC_MSG_TYPE_MMS_PREFER;
            }
            addr = addr->next;
        }
    }


    if (mmi_ucs2strlen((S8*) g_uc_p->srv_msg->subject))
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_SUB);

        return SRV_UC_MSG_TYPE_MMS_PREFER;
    }
    else if (g_uc_p->srv_msg->msg_body.slide_no > 1)
    {
        MMI_TRACE(
            MMI_COMMON_TRC_G6_MSG,
            TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_SLIDE,
            g_uc_p->srv_msg->msg_body.slide_no);
        return SRV_UC_MSG_TYPE_MMS_PREFER;
    }
    else if (g_uc_p->srv_msg->msg_body.obj_no > 1)
    {
        MMI_TRACE(
            MMI_COMMON_TRC_G6_MSG,
            TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_OBJ,
            g_uc_p->srv_msg->msg_body.obj_no);
        return SRV_UC_MSG_TYPE_MMS_PREFER;
    }
    else if ((g_uc_p->srv_msg->msg_body.obj_no == 1) &&
             (g_uc_p->srv_msg->msg_body.objects->type != MMA_MMS_OBJECT_TYPE_TEXT))
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_ONE_OBJ);
        return SRV_UC_MSG_TYPE_MMS_PREFER;
    }
    else
    {
#ifdef __MMI_MSG_EDITOR_WITH_RECIPIENT__
        if(g_uc_p->main.check_buffer_flag)
        {
            if(mmi_uc_is_email_recipient_present())
            {
                return SRV_UC_MSG_TYPE_MMS_PREFER;
            }
/*
            else if(g_uc_p->main.phb_search_name_flag)
            {
                addr = g_uc_p->srv_msg->to_head;

                for (; addr != NULL; addr = addr->next)
                {
                    if (addr->type == SRV_UC_ADDRESS_TYPE_EMAIL)
                    {
                        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_EMAIL);
                        g_uc_p->main.phb_search_name_flag = 0;
                        return SRV_UC_MSG_TYPE_MMS_PREFER;
                    }
                }
            }
*/
        }
        else
#endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
        {
            addr = g_uc_p->srv_msg->to_head;

            for (; addr != NULL; addr = addr->next)
            {
                if (addr->type == SRV_UC_ADDRESS_TYPE_EMAIL)
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_EMAIL);
                    return SRV_UC_MSG_TYPE_MMS_PREFER;
                }
            }
        }
        /* Add text object when the UC screen is exited */
        /* MMI_ASSERT(g_uc_p->srv_msg->msg_body.curr_slide->txt.object); */

        if (g_uc_p->srv_msg->msg_body.curr_slide)
        {
            if (srv_sms_get_sms_segment_number(
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.UCS2_count,
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count,
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.extension_char_count) >
                srv_uc_get_max_mo_sms_segment())
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_SEG_EXCEED);
                return SRV_UC_MSG_TYPE_MMS_PREFER;
            }

            if (g_uc_p->srv_msg->msg_body.curr_slide->txt.UCS2_count)
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count >
                    (srv_sms_get_usable_text_len(SMSAL_UCS2_DCS) / 2))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_UCS2_TEXT_EXCEED);
                    return SRV_UC_MSG_TYPE_MMS_PREFER;
                }
            }
            else if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count)
            {
                if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count +
                    g_uc_p->srv_msg->msg_body.curr_slide->txt.extension_char_count >
                    (srv_sms_get_usable_text_len(SMSAL_DEFAULT_DCS) / 2))
                {
                    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_ASCII_TEXT_EXCEED);

                    return SRV_UC_MSG_TYPE_MMS_PREFER;
                }
            }
        }
    }

    MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_DETEMINE_MSG_TYPE_BY_CONTENT_SMS);

    return SRV_UC_MSG_TYPE_SMS_PREFER;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_uc_is_pending_content
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void        
 * BOOL
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_uc_is_pending_content()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_MMS_POSTCARD__
    if (g_uc_p->srv_msg_type->MMS_edit_mode == SRV_UC_MMS_EDIT_MODE_POSTCARD_MMS)
    {
        if (g_uc_p->srv_msg->msg_body.slide_no > 0)
        {
            if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count ||
                g_uc_p->srv_msg->msg_body.slide_no > 1 ||
                g_uc_p->srv_msg->msg_body.objects || srv_postcard_get_total_recipient_count(g_uc_p->main.instance) > 0)
            {
                MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_IS_PENDING_CONTENT_P1, 1);
                return MMI_TRUE;
            }
        }
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_IS_PENDING_CONTENT_P1, 0);
        return MMI_FALSE;
    }
#endif /* __MMI_MMS_POSTCARD__ */ 

    if (g_uc_p->srv_msg->msg_body.slide_no > 0)
    {
        if (g_uc_p->srv_msg->msg_body.curr_slide->txt.char_count ||
            g_uc_p->srv_msg->msg_body.slide_no > 1 ||
            g_uc_p->srv_msg->msg_body.objects ||
        #ifndef __MMI_MSG_EDITOR_WITH_RECIPIENT__
            g_uc_p->srv_msg->to_num > 0 || 
        #endif /* __MMI_MSG_EDITOR_WITH_RECIPIENT__ */
           mmi_ucs2strlen((S8*) g_uc_p->srv_msg->subject))
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_IS_PENDING_CONTENT_P1, 1);
            return MMI_TRUE;
        }
        else
        {
            MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_IS_PENDING_CONTENT_P1, 0);
            return MMI_FALSE;
        }
    }
    else
    {
        MMI_TRACE(MMI_COMMON_TRC_G6_MSG, TRC_MMI_UC_IS_PENDING_CONTENT_P1, 0);
        return MMI_FALSE;
    }
}
#ifdef __MMI_MMS_INSERT_SENDER_ADDR_FROM_SIM__

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_owner_number
 * DESCRIPTION
 *  
 * PARAMETERS
 *  srv_uc_sim_id        
 * BOOL
 * RETURNS
 *  owner_number
 *****************************************************************************/
U16 *mmi_uc_get_owner_number(srv_uc_sim_id sim)
{
  mmi_sim_enum sim_num =srv_uc_convert_ucsim_to_mmisim(sim);
  return ((U16 *)srv_cphs_get_msisdn_number(SRV_CPHS_MSISDN_TYPE_LINE1, sim_num));
}
/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_owner_from_prefered_sim
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void        
 * BOOL
 * RETURNS
 *  void
 *****************************************************************************/
U16 *mmi_uc_get_owner_from_prefered_sim(void)
{
	U16 *owner_num;         
 #if(MMI_MAX_SIM_NUM == 1)
	owner_num = mmi_uc_get_owner_number(UC_SIM_ID_GSM_SIM1);
 #else  /*MMI_MAX_SIM_NUM == 1*/
	if (g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM1)
	     owner_num = mmi_uc_get_owner_number(UC_SIM_ID_GSM_SIM1);
    #if(MMI_MAX_SIM_NUM >=2)
	 else if(g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM2)
		owner_num = mmi_uc_get_owner_number(UC_SIM_ID_GSM_SIM2);
    #if(MMI_MAX_SIM_NUM >=3)
	 else if(g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM3)
		owner_num = mmi_uc_get_owner_number(UC_SIM_ID_GSM_SIM3);
    #if(MMI_MAX_SIM_NUM >=4)
	 else if(g_uc_p->srv_sim_info->valid_sim_id_info & SRV_UC_SIM_ID_GSM_SIM4)
		owner_num = mmi_uc_get_owner_number(UC_SIM_ID_GSM_SIM4);
    #endif/*MMI_MAX_SIM_NUM >=4*/
    #endif/*MMI_MAX_SIM_NUM >=3*/
    #endif/*MMI_MAX_SIM_NUM >=2*/
	 else
        owner_num = mmi_uc_get_owner_number(UC_SIM_ID_GSM_SIM1);
 #endif /*MMI_MAX_SIM_NUM == 1*/
	 return(owner_num);
}
 #endif /*__MMI_MMS_INSERT_SENDER_ADDR_FROM_SIM__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_uc_get_current_msg_box_type
 * DESCRIPTION
 *  
 * PARAMETERS
 *  instance        [IN]        
 *  msg_id          [IN]        
 * RETURNS
 *  srv_um_msg_box_enum
 *****************************************************************************/
srv_um_msg_box_enum mmi_uc_get_current_msg_box_type(U32 msg_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_uc_p->srv_main->state == SRV_UC_STATE_WRITE_NEW_MSG)
    {
        return (srv_um_msg_box_enum)0;
    }
    else if (g_uc_p->srv_send_info->existed_msg_type == SRV_UC_MSG_TYPE_SMS_PREFER)
    {
        return (mmi_msg_get_um_type_by_msgid(msg_id));
    }
    else
    {
        return ((srv_um_msg_box_enum)mma_get_box(msg_id));
    }
}
 void mmi_uc_dummy_api(void)
{

}
#endif /* (defined(__MMI_UNIFIED_COMPOSER__) || defined(__MMI_MMS_STANDALONE_COMPOSER__)) */ 
#endif /* _MMI_UNIFIED_COMPOSER_APP_CORE_C */

#endif /* __MMI_TELEPHONY_SUPPORT__ */
