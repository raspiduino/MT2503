/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 * EmailAppMain.c
 *
 * Project:
 * --------
 * MAUI
 *
 * Description:
 * ------------
 * 
 *
 * Author:
 * -------
 * 
 *
 *==============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *==============================================================================
 *******************************************************************************/
#include "MMI_features.h"

#ifdef __MMI_EMAIL__

#include "CommonScreens.h"
#include "custom_events_notify.h"

#include "Inlinecuigprot.h"
#include "Fseditorcuigprot.h"
#include "Menucuigprot.h"
#include "PhbCuiGprot.h"
#include "Filemgrcuigprot.h"
#ifdef __MMI_IMAGE_VIEWER__
#include "Imageviewcuigprot.h"
#endif /* __MMI_IMAGE_VIEWER__ */
#include "MediaAppGProt.h"
#include "bookmarkcuigprot.h"
#include "UCMGProt.h"
#include "App_usedetails.h"
#include "conversions.h"

#include "SmsAppGprot.h"

#include "fs_gprot.h"

#ifdef BROWSER_SUPPORT
#include "wap_adp.h"
#include "browser_api.h"
#endif

#ifdef __DRM_SUPPORT__
#include "Drm_gprot.h"
#endif /* __DRM_SUPPORT__ */

#include "wgui_categories_util.h"
#include "conversions.h"

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
#include "opera_api.h"
#else /* OPERA_V10_BROWSER */
#include "app_html.h"
#endif
#endif /* #ifdef __MMI_EMAIL_HTML__ */

#include "EmailSrvGprot.h"
#include "EmailAppMem.h"
#include "EmailAppCore.h"
#include "EmailAppProt.h"
#ifdef __MMI_BPP20_SUPPORT__
#include "EmailAppBpp.h"
#endif /* __MMI_BPP20_SUPPORT__ */

#include "MMIDataType.h"
#include "customer_ps_inc.h"
#include "kal_general_types.h"
#include "FileMgrSrvGProt.h"
#include "CbmSrvGprot.h"
#include "fs_type.h"
#include "GlobalResDef.h"
#include "wgui_categories_list.h"
#include "drm_def.h"
#include "mmi_frm_scenario_gprot.h"
#include "mmi_frm_mem_gprot.h"
#include "kal_public_api.h"
#include "Unicodexdcl.h"
#include "string.h"
#include "CustDataRes.h"
#include "mmi_rp_app_email_def.h"
#include "mmi_frm_events_gprot.h"
#include "wgui_categories_popup.h"
#include "GlobalConstants.h"
#include "mmi_frm_input_gprot.h"
#include "fs_func.h"
#include "mmi_frm_timer_gprot.h"
#include "TimerEvents.h"
#include "mmi_inet_app_trc.h"
#include "DebugInitDef_Int.h"
#include "kal_trace.h"
#include "CbmCuiGprot.h"
#include "gui_data_types.h"
#include "mmi_rp_app_uiframework_def.h"
#include "gui_typedef.h"
#include "ps_public_enum.h"
#include "mmi_rp_file_type_def.h"
#include "fs_errcode.h"
#ifdef __MMI_RMGR__
#include "mmi_rp_app_rmgr_def.h"
#endif
#include "mmi_res_range_def.h"
#include "MediaPlayerGProt.h"
#include "UcmSrvGprot.h"

#include "wgui_touch_screen.h"
#include "wgui_categories.h"

#include "EmailAppNetwork.h"
#include "EmailAppLib.h"
#include "EmailAppStateMgr.h"

/************************************************************************/
/*                   defines                                            */
/************************************************************************/

#define EMAIL_READ_EXTRACT_MAX_ADDR                         20

#ifdef __MMI_FTE_SUPPORT__
/* Inbox toolbar */
#define MMI_EMAIL_INBOX_READ_TB_REPLY                           0
#define MMI_EMAIL_INBOX_READ_TB_FORWARD                         1
#define MMI_EMAIL_INBOX_READ_TB_DELETE                          2
#define MMI_EMAIL_INBOX_READ_TB_TOTAL                           3
/* Sent toolbar */
#define MMI_EMAIL_SENT_READ_TB_FORWARD                          0
#define MMI_EMAIL_SENT_READ_TB_DELETE                           1
#define MMI_EMAIL_SENT_READ_TB_TOTAL                            2
/* Drafts toolbar */
#define MMI_EMAIL_DRAFT_READ_TB_EDIT                            0
#define MMI_EMAIL_DRAFT_READ_TB_DELETE                          1
#define MMI_EMAIL_DRAFT_READ_TB_TOTAL                           2
/* Outbox toolbar */
//#define MMI_EMAIL_OUTBOX_READ_TB_SEND                           0
//#define MMI_EMAIL_OUTBOX_READ_TB_EDIT                         1
#define MMI_EMAIL_OUTBOX_READ_TB_DELETE                         0
#define MMI_EMAIL_OUTBOX_READ_TB_TOTAL                          1
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
/* Remote toolbar */
#define MMI_EMAIL_REMOTE_READ_TB_FORWARD                        0
#define MMI_EMAIL_REMOTE_READ_TB_DELETE                         1
#define MMI_EMAIL_REMOTE_READ_TB_TOTAL                          2
#endif /* __MMI_EMAIL_REMOTE_FOLDER__ */
#endif /* __MMI_FTE_SUPPORT__ */

#define MMI_EMAIL_HTML_PARSE_BUFF_LEN                           1024

#define MMI_EMAIL_MAX_CONT_PREFIX_LEN 128
#define MMI_EMAIL_MAX_CONT_POSTFIX_LEN 128

#define EMAIL_APP_HILITE_TYPE_NULL   0
#define EMAIL_APP_HILITE_TYPE_HEAD   1
#define EMAIL_APP_HILITE_TYPE_BODY   2
#define EMAIL_APP_HILITE_TYPE_TAIL   3

#define EMAIL_APP_MORE_TYPE_NULL     0 /* No more link */
#define EMAIL_APP_MORE_TYPE_ALL_MSG  1 /* POP3: Download whole message */
#define EMAIL_APP_MORE_TYPE_ALL_CNT  2 /* IMAP4: Download all content including html */
#define EMAIL_APP_MORE_TYPE_HTML     3 /* IMAP4: Download HTML part, PLAIN TEXT has been downloaded */

typedef struct 
{
    mmi_id parent_id;
    mmi_id grp_id;
    mmi_id inline_id;
    mmi_id option_grp_id;
    mmi_id addr_grp_id;
    mmi_id attach_grp_id;
    mmi_id phb_cui_id;
    mmi_id viewer_cui_id;
    mmi_id fmgr_cui_id;
    mmi_id fseditor_id;
    EMAIL_MSG_ID msg_id;
    EMAIL_FLDR_ID fldr_id;
    EMAIL_ACCT_ID acct_id;
    U8 priority;
    S8 cont_state;
    S8 html_state;
    U32 to_num;
    U32 cc_num;
    U32 bcc_num;
    U32 att_num;
    BOOL entry_from_folder;
    srv_email_addr_struct from_addr;
    WCHAR from_display[MMI_EMAIL_MAX_ADDR_DISP_LEN];
    srv_email_addr_struct addr_list[MMI_EMAIL_MAX_ADDR_NUM];
    WCHAR to_display[MMI_EMAIL_MAX_ADDR_DISP_LEN];
    WCHAR cc_display[MMI_EMAIL_MAX_ADDR_DISP_LEN];
    WCHAR bcc_display[MMI_EMAIL_MAX_ADDR_DISP_LEN];
    WCHAR subj[MMI_EMAIL_MAX_SUBJ_LEN + 1];
    WCHAR total_size_str[16];

    BOOL has_html_link;
    S32  more_link_type;
    S32 whole_msg_size;
    U32 plain_text_size;
    U32 html_text_size;
    U16 default_csk_img;
    S16 curr_hilite_url_idx;

    U32 content_offset1;
    U32 content_offset2;

    WCHAR content[MMI_EMAIL_MAX_CONT_LEN + MMI_EMAIL_MAX_CONT_PREFIX_LEN + MMI_EMAIL_MAX_CONT_POSTFIX_LEN + 1];
    WCHAR attach_display[MMI_EMAIL_MAX_ATT_DISP_LEN + 1];

#ifdef __MMI_EMAIL_HTML__
    WCHAR html_file_path[SRV_FMGR_PATH_MAX_LEN + 1];
    BOOL has_html;
    mmi_chset_enum html_charset;
#endif /* __MMI_EMAIL_HTML__ */

    S32 subj_len;
    S32 cont_len;
    U16 curr_item_id;
    U16 curr_hilit_addr_index;
    U16 curr_hilit_attach_index;
    U16 curr_hilit_pf_index;
    S32 attach_save_job_id;
    S32 state;
    srv_email_fldr_type_enum folder_type;
    srv_email_delete_option_enum del_opt;
} email_app_read_msg_struct;

typedef struct 
{
    U8 file_type;
    BOOL drm_object;
    EMAIL_ATTCH_ID attach_id;
    MMI_BOOL downloaded;
    CHAR cid[SRV_EMAIL_CID_MAX_LEN + 1];
    WCHAR attach_name[EMAIL_ATTCH_FILE_NAME_LEN + 1];
    WCHAR path[SRV_FMGR_PATH_MAX_LEN + 1];
    WCHAR attach_size_str[10];
} email_app_read_attach_item_info_struct;

typedef struct 
{
    EMAIL_MSG_HANDLE msg_handle;
    EMAIL_REQ_ID req_id;
    mmi_id parent_id;
    mmi_id grp_id;
    BOOL is_exit;
    BOOL is_busy;
    mmi_id cbm_id;
    EMAIL_ATTCH_ID attach_id;
    srv_email_retrieve_option_enum ret_opt;
    srv_cbm_bearer_event_type_enum cbm_type;
} email_app_read_partial_fetch_struct;

#ifdef __MMI_EMAIL_HTML__
#ifndef OPERA_V10_BROWSER
typedef struct
{
    S32 in_content_len;
    FS_HANDLE file_h;
    U8 *convert_buffer;
    U32 read_len;
    U32 buff_len;
    U32 read_buff_len;
    BOOL is_last_read;
    U8 *data_temp_ptr;
    U8 *read_temp_ptr;
    U8 *html_data_buff_ptr;
    U32 html_data_buff_len;
    applib_html_plaintext_context_struct plaintext;
} mmi_email_content_parser;
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

typedef enum
{
    MMI_EMAIL_READ_FROM_ITEM_ID = (CUI_INLINE_ITEM_ID_BASE + 0),
    MMI_EMAIL_READ_TO_ITEM_ID,
    MMI_EMAIL_READ_CC_ITEM_ID,
    MMI_EMAIL_READ_BCC_ITEM_ID,
    MMI_EMAIL_READ_SUBJECT_ITEM_ID,
    MMI_EMAIL_READ_ATTACH_ITEM_ID,
    MMI_EMAIL_READ_CONTENT_ITEM_ID
} email_app_read_msg_item_enum;

#ifdef __MMI_EMAIL_HTML__
#ifndef OPERA_V10_BROWSER
typedef enum
{
    EMAIL_CONT_PARSE_NONE = 0,
    EMAIL_CONT_PARSE_START,
    EMAIL_CONT_PARSE_PARSING,
    EMAIL_CONT_PARSE_FINISH,
    EMAIL_CONT_PARSE_END
} email_content_parse_status;
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

#define MMI_EMAIL_READ_TOTAL \
            (MMI_EMAIL_READ_CONTENT_ITEM_ID - MMI_EMAIL_READ_FROM_ITEM_ID + 1)


/************************************************************************/
/*                          Variables                                   */
/************************************************************************/

static cui_inline_item_softkey_struct email_read_softkey_struct = {{
                                        {STR_GLOBAL_OPTIONS, IMG_GLOBAL_OPTIONS},
                                        {STR_GLOBAL_BACK, IMG_GLOBAL_BACK},
                                        {0, CUI_INLINE_SOFTKEY_DEFAULT_VALUE}}};
static cui_inline_set_item_struct email_read_inline_item[MMI_EMAIL_READ_TOTAL] = {0};
static cui_inline_struct read_read_inline_struct = {0};
#ifdef __MMI_FTE_SUPPORT__
static cui_inline_item_display_only_struct email_read_display_only_struct[MMI_EMAIL_READ_TOTAL - 1] = {0};
#else
static cui_inline_item_display_only_struct email_read_display_only_struct = {0};
static cui_inline_item_image_text_struct email_read_image_text_struct[5] = {0};
#endif
static cui_inline_item_multiline_rdonly_struct email_read_multi_rdonly_struct = {0};
static email_app_read_msg_struct email_app_read;
static email_app_read_attach_item_info_struct attach_info_array[MMI_EMAIL_MAX_ATTACH_NUMBER];
static email_app_read_partial_fetch_struct email_read_pf_data;

static WCHAR selected_file_path[SRV_FMGR_PATH_MAX_LEN + 1];
static WCHAR save_attach_name[EMAIL_ATTCH_FILE_NAME_LEN + 1];
static mmi_id email_read_extract_phb_id = 0;
static mmi_id email_read_extract_bmk_id = 0;
static applib_address_node_struct *email_read_extract_addr_list = NULL;
static applib_address_node_struct *email_read_extract_addr_curr = NULL;

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
static OperaApi_MimeInfo html_att_info[MMI_EMAIL_MAX_ATTACH_NUMBER] = {0};
static EMAIL_MSG_HANDLE html_msg_handle = 0;
#else /* OPERA_V10_BROWSER */
static mmi_email_content_parser html_parser;
static email_content_parse_status status;
static CHAR not_converted_string_data[20];
#endif /* OPERA_V10_BROWSER */
#endif /* #ifdef __MMI_EMAIL_HTML__ */

static FuncPtr email_read_get_general_cont_callback = NULL;
static BOOL email_read_msg_not_exist = FALSE;
static BOOL email_read_msg_not_complete = FALSE;
static BOOL email_read_msg_recp_too_many = FALSE;
static BOOL email_read_msg_not_support_charset = FALSE;

#ifdef __MMI_FTE_SUPPORT__
static PU8 email_toolbar_content_icon[MMI_EMAIL_MAX_TB_NUMBER] = {NULL, NULL, NULL};
static PU8 email_toolbar_disabled_content_icon[MMI_EMAIL_MAX_TB_NUMBER] = {NULL, NULL, NULL};
static PU8 email_toolbar_string[MMI_EMAIL_MAX_TB_NUMBER] = {NULL, NULL, NULL};
#endif /* __MMI_FTE_SUPPORT__ */

extern WCHAR email_app_msg_detail_buff[MMI_EMAIL_MAX_DETAIL_LEN + 1];
/* MTK Elvis for R2L characters */
extern BOOL r2lMMIFlag;

#ifdef __DRM_SUPPORT__
extern CHAR rights_issuer[DRM_MAX_URL_LENGTH];
#endif /* __DRM_SUPPORT__ */

static mmi_email_entry_read_struct g_email_read_asm_data;
static BOOL g_is_asm_created_by_others;
static void *g_memory_pool_ptr = NULL;


/************************************************************************/
/*                          Prototypes                                  */
/************************************************************************/

static void mmi_email_read_init_inline_item_struct(
                cui_inline_set_item_struct *p_inline_item,
                U16 item_id,
                U32 item_flag,
                U16 image_id,
                void *item_data);
static void mmi_email_read_hide_menu(void *read_data);
static void mmi_email_read_get_cont_loading(void);

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
static void mmi_email_read_html_convert_to_pt_callback(void *user_data, int result);
#else /* OPERA_V10_BROWSER */
static void mmi_email_read_extract_html(void);
static void mmi_email_read_cont_parser_ind(void);
static void mmi_email_read_cont_parser(void);
static U8 *mmi_email_parse_content_to_ucs2(mmi_email_content_parser *parser, S32 chset, U16 *outLen, U32 *pos);
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */


static mmi_ret mmi_email_read_group_proc(mmi_event_struct *event);


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_read_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


#ifdef __MMI_ICON_BAR_SUPPORT__

static void mmi_email_read_tb_set_info(void);
static void mmi_email_read_inbox_tb_callback(S32 index);
static void mmi_email_read_outbox_tb_callback(S32 index);
static void mmi_email_read_sent_tb_callback(S32 index);
static void mmi_email_read_draft_tb_callback(S32 index);
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
static void mmi_email_read_remote_tb_callback(S32 index);
#endif /* __MMI_EMAIL_REMOTE_FOLDER__ */

#endif /* __MMI_ICON_BAR_SUPPORT__ */

static void mmi_email_read_send_callback(BOOL result, void *user_data);
static void mmi_email_read_inline_notify(cui_event_inline_notify_struct *event);
static void mmi_email_read_inline_setkey(cui_event_inline_set_key_struct *event);
static void mmi_email_read_inline_csk_press(cui_event_inline_csk_press_struct *event);
static void mmi_email_read_option_handler(mmi_menu_id menu_id, void *read_data);
static void mmi_email_read_delete_msg(void);
static void mmi_email_read_move_to_drafts(EMAIL_MSG_ID msg_id, EMAIL_ACCT_ID acct_id, EMAIL_FLDR_ID fldr_id);
/* address */
static void mmi_email_read_goto_addr(void);
static mmi_ret mmi_email_read_addr_opt_proc(mmi_event_struct *evt);
static void mmi_email_entry_read_addr(void);
static mmi_ret mmi_email_read_addr_del_callback(mmi_event_struct *evt);
static void mmi_email_hilite_read_addr_item(S32 index);
static U16 mmi_email_read_get_addr_list(U8 **str_main_list, U8 **str_popup_list);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_read_addr_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static void mmi_email_entry_read_addr_opt(void);
static mmi_ret mmi_email_read_addr_options_handler(mmi_menu_id menu_id);
static void mmi_email_read_addr_save(void);
static void mmi_email_read_addr_send(void);
/* attachment */
static void mmi_email_read_init_attach_info(mmi_id grp_id, EMAIL_MSG_HANDLE msg_handle);
static void mmi_email_read_attach(void);
static mmi_ret mmi_email_read_attach_opt_proc(mmi_event_struct *evt);
static void mmi_email_read_save_attach_select_path_done(void *evt);
static void mmi_email_read_save_attach_input_done(void *evt);
static void mmi_email_read_save_attach_loading(void);
static mmi_ret mmi_email_read_attach_save_del_callback(mmi_event_struct *evt);
static mmi_ret mmi_email_read_attch_copy_callback(mmi_event_struct *param);
static void mmi_email_entry_read_attach(void);
static mmi_ret mmi_email_read_attach_del_callback(mmi_event_struct *evt);
static void mmi_email_hilite_read_attach_item(S32 index);
#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_read_attach_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */
static void mmi_email_entry_read_attach_opt(void);
static void mmi_email_read_attach_hide_menu(mmi_id menu_id);
static mmi_ret mmi_email_read_attach_options_handler(mmi_menu_id menu_id);
static void mmi_email_entry_read_pf(void);
static void mmi_email_read_pf_lsk(void);
static void mmi_email_hilite_read_pf_item(S32 index);
static void mmi_email_read_add_attach_field_to_display(void);
static void mmi_email_read_pf_pre_download(
                mmi_id parent_id,
                EMAIL_ATTCH_ID attach_id,
                srv_email_retrieve_option_enum ret_opt);
static BOOL mmi_email_read_pf_download(void);

static void mmi_email_read_pf_update_cont_callback(void);

static void mmi_email_read_attach_download(void);
static void mmi_email_read_attach_save(void);
static void mmi_email_read_pre_entry_save_attach(void);
static void mmi_email_entry_read_attach_view(void);
static void mmi_email_read_copy_to_view_attach(WCHAR *new_file_path);

static void mmi_email_read_extract_addr_phone_call(void);
static void mmi_email_read_extract_addr_phone_save(void);
static void mmi_email_read_extract_addr_phone_sms(void);
static void mmi_email_read_extract_addr_email_save(void);
static void mmi_email_read_extract_addr_email_send(void);
static void mmi_email_read_extract_addr_url_goto(void);
static void mmi_email_read_extract_addr_url_save(void);

static BOOL mmi_email_read_extract_addr_email_check(WCHAR* addr);

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
static void mmi_email_read_view_html(void);
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

static void mmi_email_read_add_link(void);
static U32 mmi_email_read_util_get_protocol(void);

static void email_app_read_url_hilite(void);
static MMI_BOOL email_app_read_url_action(void);
static U32 email_app_read_url_get_type(S16 idx, applib_address_node_struct **pp);
static void email_app_read_url_menu_hide(mmi_id menu_id);
static void mmi_email_extract_list_limit(void);
static void email_app_read_extract_free_list(void);

static void *mmi_email_read_asm_create(mmi_email_entry_read_struct *read_data);
static void mmi_email_read_asm_destroy(void);
static void mmi_email_read_asm_ready(void);
static BOOL mmi_email_pre_entry_read_ext(mmi_email_entry_read_struct *read_data);

#ifdef __MMI_BACKGROUND_CALL__
static mmi_ret mmi_email_ucm_call_back(mmi_event_struct *arg);
#endif

/************************************************************************/
/*                           Implements                                 */
/************************************************************************/

void mmi_email_reset_curr_read_info(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_RESET_CURR_READ_INFO, __LINE__);

    if (email_app_read.phb_cui_id)
    {
        cui_phb_save_contact_close(email_app_read.phb_cui_id);
        email_app_read.phb_cui_id = 0;
    }

    if (email_app_read.fseditor_id)
    {
        cui_fseditor_close(email_app_read.fseditor_id);
        email_app_read.fseditor_id = 0;
    }

    if (email_app_read.fmgr_cui_id)
    {
        cui_folder_selector_close(email_app_read.fmgr_cui_id);
        email_app_read.fmgr_cui_id = 0;
    }

#ifdef __MMI_IMAGE_VIEWER__
    if (email_app_read.viewer_cui_id)
    {
        cui_imgview_close(email_app_read.viewer_cui_id);
        email_app_read.viewer_cui_id = 0;
    }
#endif /* __MMI_IMAGE_VIEWER__ */

    if (email_app_read.inline_id)
    {
        cui_inline_close(email_app_read.inline_id);
        email_app_read.inline_id = 0;
    }

    mmi_email_exit_save_send();
    mmi_frm_group_close(email_app_read.grp_id);
    email_app_read.msg_id = 0;
}


static void mmi_email_read_init_inline_item_struct(
                cui_inline_set_item_struct *p_inline_item,
                U16 item_id,
                U32 item_flag,
                U16 image_id,
                void *item_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    p_inline_item->item_id = item_id;
    p_inline_item->item_flag = item_flag;
    p_inline_item->image_id = image_id;
    p_inline_item->item_data = item_data;
}


static void mmi_email_read_hide_other_bcc(EMAIL_ACCT_ID acct_id, srv_email_addr_struct *addr_list, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_acct_info_struct *acct_info = NULL;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    U32 index = 0, temp_count = *count;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        return;
    }
    result = srv_email_acct_open(acct_handle, acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        return;
    }
    acct_info = OslMalloc(sizeof(srv_email_acct_info_struct));
    result = srv_email_acct_read(acct_handle, acct_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        OslMfree(acct_info);
        srv_email_acct_destroy(acct_handle);
        return;
    }
    *count = 0;
    for (; index < temp_count; index++)
    {
        if (mmi_wcscmp(acct_info->email_addr.email_addr, addr_list[index].email_addr) == 0)
        {
            memcpy(&addr_list[0], &addr_list[index], sizeof(srv_email_addr_struct));
            *count = 1;
        }
    }
    memset(&addr_list[(*count)], 0, sizeof(srv_email_addr_struct) * (temp_count - (*count)));
    OslMfree(acct_info);
    srv_email_acct_destroy(acct_handle);
    return;
}

static U32 mmi_email_read_util_get_protocol(void)
{
    U32 protocol = SRV_EMAIL_PROT_IMAP4;

    srv_email_acct_info_cache_struct *cache_data = NULL;

    cache_data = OslMalloc(sizeof(srv_email_acct_info_cache_struct));
    srv_email_acct_cache_get(email_app_read.acct_id, cache_data);
    protocol = cache_data->protocol;
    OslMfree(cache_data);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_UE_READMORE_GET_PROTOCOL, protocol);
    return protocol;
}


static void *mmi_email_read_asm_create(mmi_email_entry_read_struct *read_data)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ASM_CREATE, __LINE__);

    g_memory_pool_ptr = mmi_email_app_mem_get_ptr();
    if (g_memory_pool_ptr == NULL)
    {
        g_is_asm_created_by_others = FALSE;
        g_memory_pool_ptr = mmi_email_app_mem_pool_malloc(MMI_EMAIL_MEM_POOL_SIZE);
        if (g_memory_pool_ptr == NULL)
        {
            if (read_data)
            {
                memcpy(&g_email_read_asm_data, read_data, sizeof(mmi_email_entry_read_struct));
            }
            else
            {
                memset(&g_email_read_asm_data, 0, sizeof(mmi_email_entry_read_struct));
            }
            mmi_frm_appmem_prompt_to_release_mem(
                APPLIB_MEM_AP_ID_EMAIL,
                0,
                MMI_EMAIL_MEM_POOL_SIZE,
                mmi_email_read_asm_ready);
            return NULL;
        }
    }
    else
    {
        g_is_asm_created_by_others = TRUE;
    }

    return g_memory_pool_ptr;
}

static void mmi_email_read_asm_destroy(void)
{
    /* Free ASM */
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ASM_DESTROY, g_is_asm_created_by_others);
    if (!g_is_asm_created_by_others)
    {
        mmi_email_app_mem_pool_free(g_memory_pool_ptr);
        g_is_asm_created_by_others = FALSE;
        g_memory_pool_ptr = NULL;
    }
}

void mmi_email_read_asm_stop(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ASM_STOP, email_app_read.grp_id);
    if (email_app_read.grp_id!= 0)
    {
        mmi_frm_group_close(email_app_read.grp_id);
        email_app_read.grp_id = 0;
    }
}

static void mmi_email_read_asm_ready(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ASM_READY, __LINE__);

    // Check T card / SIM removed or USB mode etc
    if (!mmi_email_smgr_network_check())
    {
        return;
    }

    mmi_email_pre_entry_read(&g_email_read_asm_data);
}

BOOL mmi_email_pre_entry_read(mmi_email_entry_read_struct *read_data)
{
    BOOL ret = FALSE;
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ, __LINE__);

    /* Prepare ASM */
    if (mmi_email_read_asm_create(read_data) == NULL)
    {
        return FALSE;
    }
    /* Prepare ASM */

    mmi_email_dummy_refresh_enable(FALSE);
    ret = mmi_email_pre_entry_read_ext(read_data);
    mmi_email_dummy_refresh_enable(TRUE);
    if (ret)
    {
        return TRUE;
    }
    else
    {
        mmi_email_read_asm_destroy();
        return FALSE;
    }
}

static BOOL mmi_email_pre_entry_read_ext(mmi_email_entry_read_struct *read_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_msg_get_basic_info_struct *basic_info = NULL;
    srv_email_msg_get_recipient_struct *recp_info = NULL;
    U32 sub_len = 0, cont_len = 0;
    S32 sub_char = 0, cont_char = 0;
    EMAIL_MSG_HANDLE msg_handle = 0;

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
    WCHAR *filepath_input = NULL;
    WCHAR *filepath_output = NULL;
    WCHAR *filepath_temp = NULL;
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

    BOOL get_general_cont = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 1);

    if (!mmi_email_check_msg_valid(read_data->msg_id))
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        return FALSE;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 2);

    memset(&email_app_read, 0, sizeof(email_app_read_msg_struct));
    memset(&attach_info_array, 0, sizeof(email_app_read_attach_item_info_struct));
    email_read_msg_not_exist = FALSE;
    result = srv_email_msg_create(0, &msg_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 3);
        mmi_email_util_display_error_popup(read_data->parent_id, result);
        return FALSE;
    }

    result = srv_email_msg_open(
                msg_handle,
                read_data->acct_id,
                read_data->fldr_id,
                read_data->msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 4);
        mmi_email_util_display_error_popup(read_data->parent_id, result);
        srv_email_msg_destroy(msg_handle);
        return FALSE;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 5);

    email_app_read.acct_id = read_data->acct_id;
    email_app_read.fldr_id = read_data->fldr_id;
    email_app_read.msg_id = read_data->msg_id;
    result = mmi_email_get_acct_del_opt(read_data->acct_id, 0, &(email_app_read.del_opt));
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 6);
        mmi_email_util_display_error_popup(read_data->parent_id, result);
        srv_email_msg_destroy(msg_handle);
        return FALSE;
    }

    basic_info = OslMalloc(sizeof(srv_email_msg_get_basic_info_struct));
    result = srv_email_msg_get_basic_info(
                msg_handle,
                basic_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 7);

        mmi_email_util_display_error_popup(read_data->parent_id, result);
        OslMfree(basic_info);
        srv_email_msg_destroy(msg_handle);
        return FALSE;
    }

    email_read_msg_not_support_charset = FALSE;

    email_app_read.to_num = basic_info->to_addr_num;
    email_app_read.cc_num = basic_info->cc_addr_num;
    email_app_read.bcc_num = basic_info->bcc_addr_num;
    email_app_read.att_num = basic_info->attach_num;
    email_app_read.priority = (U8)basic_info->priority;
    email_app_read.state = basic_info->state;
    if (basic_info->remain_attach_num)
    {
        email_read_msg_not_complete = TRUE;
    }
    else
    {
        email_read_msg_not_complete = FALSE;
    }
    if (basic_info->remain_to_addr_num ||
        basic_info->remain_cc_addr_num ||
        basic_info->remain_bcc_addr_num)
    {
        email_read_msg_recp_too_many = TRUE;
    }
    else
    {
        email_read_msg_recp_too_many = FALSE;
    }
    email_app_read.whole_msg_size = basic_info->server_size;
    OslMfree(basic_info);

    srv_email_msg_cont_size(msg_handle, &email_app_read.plain_text_size, &email_app_read.html_text_size);

    MMI_TRACE(
        MMI_INET_TRC_G9_EMAIL, 
        MMI_EMAIL_UE_READMORE_BASIC_INFO, 
        email_app_read.state, email_app_read.whole_msg_size, email_app_read.plain_text_size, email_app_read.html_text_size);

    recp_info = OslMalloc(sizeof(srv_email_msg_get_recipient_struct));
    if (email_app_read.to_num)
    {
        recp_info->addr_list = email_app_read.addr_list;
        recp_info->number = email_app_read.to_num;
        recp_info->start_index = 0;
        recp_info->type = SRV_EMAIL_ADDR_TYPE_TO;
        result = srv_email_msg_get_recipient(
                    msg_handle,
                    recp_info);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 8);

            mmi_email_util_display_error_popup(read_data->parent_id, result);
            OslMfree(recp_info);
            srv_email_msg_destroy(msg_handle);
            return FALSE;
        }
        if (recp_info->addr_list[0].disp_name_len)
        {
            kal_wsprintf(
                email_app_read.to_display,
                "%w%w%w%w",
                recp_info->addr_list[0].disp_name,
                g_email_subj_left_op,
                recp_info->addr_list[0].email_addr,
                g_email_subj_right_op);
        }
        else
        {
            mmi_wcscpy(email_app_read.to_display, recp_info->addr_list[0].email_addr);
        }
        if (email_app_read.to_num > 1)
        {
            mmi_wcscat(email_app_read.to_display, g_email_2dots);
        }
    }
    else
    {
        mmi_wcscpy(email_app_read.to_display, (WCHAR*)GetString(STR_EMAIL_TO_ID));
    }
    if (email_app_read.cc_num)
    {
        recp_info->addr_list = &(email_app_read.addr_list[email_app_read.to_num]);
        recp_info->number = email_app_read.cc_num;
        recp_info->start_index = 0;
        recp_info->type = SRV_EMAIL_ADDR_TYPE_CC;
        result = srv_email_msg_get_recipient(
                    msg_handle,
                    recp_info);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 9);

            mmi_email_util_display_error_popup(read_data->parent_id, result);
            OslMfree(recp_info);
            srv_email_msg_destroy(msg_handle);
            return FALSE;
        }
        if (recp_info->addr_list[0].disp_name_len)
        {
            kal_wsprintf(
                email_app_read.cc_display,
                "%w%w%w%w",
                recp_info->addr_list[0].disp_name,
                g_email_subj_left_op,
                recp_info->addr_list[0].email_addr,
                g_email_subj_right_op);
        }
        else
        {
            mmi_wcscpy(email_app_read.cc_display, recp_info->addr_list[0].email_addr);
        }
        if (email_app_read.cc_num > 1)
        {
            mmi_wcscat(email_app_read.cc_display, g_email_2dots);
        }
    }
    if (email_app_read.bcc_num)
    {
        recp_info->addr_list = &(email_app_read.addr_list[email_app_read.to_num + email_app_read.cc_num]);
        recp_info->number = email_app_read.bcc_num;
        recp_info->start_index = 0;
        recp_info->type = SRV_EMAIL_ADDR_TYPE_BCC;
        result = srv_email_msg_get_recipient(
                    msg_handle,
                    recp_info);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 10);

            mmi_email_util_display_error_popup(read_data->parent_id, result);
            OslMfree(recp_info);
            srv_email_msg_destroy(msg_handle);
            return FALSE;
        }
        if (read_data->folder_type == SRV_EMAIL_FLDR_TYPE_INBOX)
        {
            mmi_email_read_hide_other_bcc(read_data->acct_id, recp_info->addr_list, &email_app_read.bcc_num);
        }
        if (email_app_read.bcc_num)
        {
            if (recp_info->addr_list[0].disp_name_len)
            {
                kal_wsprintf(
                    email_app_read.bcc_display,
                    "%w%w%w%w",
                    recp_info->addr_list[0].disp_name,
                    g_email_subj_left_op,
                    recp_info->addr_list[0].email_addr,
                    g_email_subj_right_op);
            }
            else
            {
                mmi_wcscpy(email_app_read.bcc_display, recp_info->addr_list[0].email_addr);
            }
        }
        if (email_app_read.bcc_num > 1)
        {
            mmi_wcscat(email_app_read.bcc_display, g_email_2dots);
        }
    }
    OslMfree(recp_info);
    memset(&email_app_read.from_addr, 0, sizeof(srv_email_addr_struct));
    result = srv_email_msg_get_sender(
                msg_handle,
                &email_app_read.from_addr);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 11);

        mmi_email_util_display_error_popup(read_data->parent_id, result);
        srv_email_msg_destroy(msg_handle);
        return FALSE;
    }
    if (email_app_read.from_addr.disp_name_len)
    {
        kal_wsprintf(
            email_app_read.from_display,
            "%w%w%w%w",
            email_app_read.from_addr.disp_name,
            g_email_subj_left_op,
            email_app_read.from_addr.email_addr,
            g_email_subj_right_op);
    }
    else if (mmi_wcslen(email_app_read.from_addr.email_addr))
    {
        mmi_wcscpy(email_app_read.from_display, email_app_read.from_addr.email_addr);
    }
    else
    {
        mmi_wcscpy(email_app_read.from_display, (WCHAR*)GetString(STR_EMAIL_FROM_ID));
    }
    result = srv_email_msg_get_subject_len(
                msg_handle,
                &sub_len,
                &sub_char);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 12);

        mmi_email_util_display_error_popup(read_data->parent_id, result);
        srv_email_msg_destroy(msg_handle);
        return FALSE;
    }

    if (sub_len)
    {
        if (sub_len > MMI_EMAIL_MAX_SUBJ_LEN)
        {
            email_app_read.subj_len = MMI_EMAIL_MAX_SUBJ_LEN + 1;
        }
        else
        {
            email_app_read.subj_len = sub_len + 1;
        }
        result = srv_email_msg_get_subject(
                    msg_handle,
                    email_app_read.subj,
                    (U32*)&email_app_read.subj_len);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 13);

            mmi_email_util_display_error_popup(read_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return FALSE;
        }
    }
    else
    {
        mmi_wcscpy(email_app_read.subj, (WCHAR*)GetString(STR_EMAIL_COMMON_NO_SUBJECT_ID));
    }

    email_app_read.content[0] = 0;
    email_app_read.cont_len = 0;

    get_general_cont = TRUE;
    email_read_get_general_cont_callback = mmi_email_entry_read;
    result = srv_email_msg_cont_status(
                msg_handle,
                &email_app_read.cont_state,
                &email_app_read.html_state);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 14);

        mmi_email_util_display_error_popup(read_data->parent_id, result);
        srv_email_msg_destroy(msg_handle);
        get_general_cont = FALSE;
        return FALSE;
    }
    if (email_app_read.cont_state & SRV_EMAIL_MSG_CONT_PART_EXIST)
    {
        result = srv_email_msg_get_content_len(
            msg_handle,
            &cont_len,
            &cont_char);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 15);

            mmi_email_util_display_error_popup(read_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return FALSE;
        }
        if (cont_len)
        {
            if (cont_len > MMI_EMAIL_MAX_CONT_LEN)
            {
                email_app_read.cont_len = MMI_EMAIL_MAX_CONT_LEN;
            }
            else
            {
                email_app_read.cont_len = cont_len + 1;
            }
            email_app_read.cont_len += 2;
            result = srv_email_msg_get_content(
                msg_handle,
                MMI_TRUE,
                email_app_read.content,
                (U32*)&email_app_read.cont_len);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 16);

                mmi_email_util_display_error_popup(read_data->parent_id, result);
                srv_email_msg_destroy(msg_handle);
                return FALSE;
            }
            email_app_read.content[email_app_read.cont_len] = 0;
        }
        get_general_cont = TRUE;
    }
    else
    {
        get_general_cont = FALSE;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 17);

#ifdef __MMI_EMAIL_HTML__
    if ((email_app_read.html_state & SRV_EMAIL_MSG_CONT_PART_EXIST) &&
        (email_app_read.html_state & SRV_EMAIL_MSG_CONT_DOWNLOADED))
    {
        CHAR *charset_string = OslMalloc(50+1);
        U32 path_len = SRV_FMGR_PATH_MAX_LEN + 1;

#ifdef OPERA_V10_BROWSER
        result = srv_email_msg_get_html_file(
            msg_handle,
            email_app_read.html_file_path,
            &path_len,
            charset_string,
            MMI_TRUE);
#else /* OPERA_V10_BROWSER */
        result = srv_email_msg_get_html_file(
            msg_handle,
            email_app_read.html_file_path,
            &path_len,
            charset_string,
            MMI_FALSE);
#endif /* OPERA_V10_BROWSER */

        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 18);

            mmi_email_util_display_error_popup(read_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            OslMfree(charset_string);
            return FALSE;
        }
        if (mmi_chset_get_charset_id((const kal_int8 *)charset_string, &email_app_read.html_charset))
        {
            if (email_app_read.html_charset < MMI_CHSET_TOTAL &&
                email_app_read.html_charset > MMI_CHSET_BASE)
            {
                email_read_msg_not_support_charset = FALSE;
                get_general_cont = FALSE;
            }
            else
            {
                email_read_msg_not_support_charset = TRUE;
                get_general_cont = TRUE;
            }
        }
        else
        {
            email_read_msg_not_support_charset = TRUE;
            get_general_cont = TRUE;
        }
        OslMfree(charset_string);
        email_app_read.has_html = TRUE;
    }
    else
    {
        email_app_read.has_html = FALSE;
    }
    if ((email_app_read.cont_state & SRV_EMAIL_MSG_CONT_PART_EXIST))
    {
        get_general_cont = TRUE;
    }
#endif /* __MMI_EMAIL_HTML__ */

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 19);

    memset(email_app_read.attach_display, 0, sizeof(email_app_read.attach_display));
    mmi_email_read_init_attach_info(read_data->parent_id, msg_handle);
    srv_email_msg_set_flag(msg_handle, EMAIL_MSG_FLAG_SEEN, EMAIL_MSG_FLAG_SEEN);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 20);

    email_app_read.parent_id = read_data->parent_id;
    email_app_read.folder_type = read_data->folder_type;
    email_app_read.entry_from_folder = read_data->entry_from_folder;
    email_app_read.grp_id = mmi_frm_group_create(
                                read_data->parent_id,
                                GRP_ID_AUTO_GEN,
                                mmi_email_read_group_proc,
                                NULL);
    if (!read_data->entry_from_folder)
    {
        mmi_email_app_nwk_user_enter(read_data->acct_id);
    }
    
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 21);

    mmi_frm_group_enter(email_app_read.grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 22);

#ifdef __MMI_EMAIL_HTML__
    if (!get_general_cont && email_app_read.has_html)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 23);

        mmi_email_read_get_cont_loading();

#ifdef OPERA_V10_BROWSER
        filepath_input = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        filepath_output = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        filepath_temp = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        mmi_wcs_to_asc((CHAR*)filepath_temp, email_app_read.html_file_path);
        memcpy(filepath_input, filepath_temp, SRV_FMGR_PATH_MAX_LEN + 1);
        kal_wsprintf(
            filepath_output,
            "%s%s",
            srv_email_get_root_path(),
            "html_output");
        mmi_wcs_to_asc((CHAR*)filepath_temp, filepath_output);
        memcpy(filepath_output, filepath_temp, SRV_FMGR_PATH_MAX_LEN + 1);
        OperaApi_Html2Text(
            (char*)filepath_input,
            (char*)filepath_output,
            mmi_email_read_html_convert_to_pt_callback,
            NULL);
        OslMfree(filepath_input);
        OslMfree(filepath_output);
        OslMfree(filepath_temp);
        applib_mem_ap_set_hide(APPLIB_MEM_AP_ID_EMAIL, MMI_TRUE);
#else /* OPERA_V10_BROWSER */
        mmi_email_read_extract_html();
#endif /* OPERA_V10_BROWSER */
    }
    else
#endif /* #ifdef __MMI_EMAIL_HTML__ */
    {
        mmi_email_entry_read();
    }

    srv_email_msg_destroy(msg_handle);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_READ_EXT, 24);
    return TRUE;
}


static void mmi_email_read_get_cont_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GET_CONT_LOADING, 1);

    if (!mmi_frm_scrn_enter(
            email_app_read.grp_id,
            SCR_EMAIL_LOADING_ID,
            NULL,
            mmi_email_read_get_cont_loading,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GET_CONT_LOADING, 2);
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_LOADING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetKeyHandler(NULL, KEY_END, KEY_EVENT_DOWN);
}


#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
void mmi_email_read_html_convert_to_pt_callback(void *user_data, int result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_MSG_HANDLE msg_handle = 0;
    U32 cont_len = 0;
    S32 cont_char = 0;
    FS_HANDLE file_h = 0;
    WCHAR *file_path = NULL;
    U32 file_size = 0;
    U32 read_size = 0, length = 0;
    S32 dots_len = mmi_wcslen(g_email_2dots);
    U32 temp_pos = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //Unhide EMAIL APP from OOM list
    applib_mem_ap_set_hide(APPLIB_MEM_AP_ID_EMAIL, MMI_FALSE);

    if (!mmi_email_smgr_network_check())
    {
        goto PT_CANNT_CONITUE;
    }

    email_app_read.cont_len = 0;
    email_app_read.content[0] = 0;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_UE_READMORE_HTML_CONVERT_CALLBACK, result);
    if (result != OPERA_API_OK)
    {
        result = srv_email_msg_create(0, &msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(email_app_read.grp_id, result);
            goto PT_RET;
        }
        result = srv_email_msg_open(
                    msg_handle,
                    email_app_read.acct_id,
                    email_app_read.fldr_id,
                    email_app_read.msg_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(email_app_read.grp_id, result);
            srv_email_msg_destroy(msg_handle);
            goto PT_RET;
        }
        result = srv_email_msg_get_content_len(
                    msg_handle,
                    &cont_len,
                    &cont_char);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(email_app_read.grp_id, result);
            srv_email_msg_destroy(msg_handle);
            goto PT_RET;
        }
        if (cont_len)
        {
            if (cont_len > MMI_EMAIL_MAX_CONT_LEN)
            {
                email_app_read.cont_len = MMI_EMAIL_MAX_CONT_LEN;
            }
            else
            {
                email_app_read.cont_len = cont_len + 1;
            }
            email_app_read.cont_len += 2;
            result = srv_email_msg_get_content(
                        msg_handle,
                        MMI_TRUE,
                        email_app_read.content,
                        (U32*)&email_app_read.cont_len);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(email_app_read.grp_id, result);
                srv_email_msg_destroy(msg_handle);
                goto PT_RET;
            }
            email_app_read.content[email_app_read.cont_len] = 0;
        }
        srv_email_msg_destroy(msg_handle);
        goto PT_RET;
    }
    else
    {
        file_path = OslMalloc(SRV_FMGR_PATH_MAX_LEN + 1);
        kal_wsprintf(
            file_path,
            "%s%s",
            srv_email_get_root_path(),
            "html_output");
        file_h = FS_Open((U16*)file_path, FS_READ_ONLY | FS_OPEN_SHARED);
        OslMfree(file_path);
        if (file_h > 0)
        {
            FS_GetFileSize(file_h, &file_size);
            if (file_size > MMI_EMAIL_MAX_DETAIL_LEN)
            {
                file_size = MMI_EMAIL_MAX_DETAIL_LEN;
            }
            FS_Read(file_h, email_app_msg_detail_buff, file_size, &read_size);
            FS_Close(file_h);
            ((CHAR*)email_app_msg_detail_buff)[file_size] = L'\0';
            email_app_read.cont_len = 
                (S32)mmi_chset_convert_ex(
                        (mmi_chset_enum)MMI_CHSET_UTF8,
                        MMI_CHSET_UCS2,
                        (char*)email_app_msg_detail_buff,
                        (char*)email_app_read.content,
                        sizeof(WCHAR) * (MMI_EMAIL_MAX_CONT_LEN + 1),
                        &temp_pos);
            if ((temp_pos - (U32)email_app_msg_detail_buff != 0) &&
                (email_app_read.cont_len >= MMI_EMAIL_MAX_CONT_LEN))
            {
                length = MMI_EMAIL_MAX_CONT_LEN - dots_len;
                mmi_wcscpy(email_app_read.content + length, g_email_2dots);
            }
        }
    }
PT_RET:
    if (email_read_get_general_cont_callback)
    {
        (*email_read_get_general_cont_callback)();
    }

PT_CANNT_CONITUE:
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_HTML_CONVERT_TO_PT_CALLBACK, email_app_read.grp_id);
    mmi_frm_scrn_close(email_app_read.grp_id, SCR_EMAIL_LOADING_ID);
}

#else /* OPERA_V10_BROWSER */

static void mmi_email_read_extract_html(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 errorCode = 0;
    U16 parse_buff_len = MMI_EMAIL_HTML_PARSE_BUFF_LEN / 2;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_HTML, __LINE__);

    memset(&html_parser, 0, sizeof(mmi_email_content_parser));
    html_parser.file_h = FS_Open((U16*)email_app_read.html_file_path, FS_READ_ONLY | FS_OPEN_SHARED);
    if (html_parser.file_h > 0)
    {
        status = EMAIL_CONT_PARSE_START;
        FS_GetFileSize(html_parser.file_h, (UINT*)(&html_parser.in_content_len));
        html_parser.convert_buffer = OslMalloc(parse_buff_len);
        if (html_parser.in_content_len < (S32)(parse_buff_len - sizeof(WCHAR)))
        {
            html_parser.read_len = html_parser.in_content_len;
            html_parser.is_last_read = TRUE;
        }
        else
        {
            html_parser.read_len = parse_buff_len - sizeof(WCHAR);
            html_parser.buff_len = 0;
        }
        html_parser.data_temp_ptr = (U8*)email_app_read.content;
        html_parser.read_temp_ptr = html_parser.convert_buffer;
        FS_Read(html_parser.file_h, html_parser.read_temp_ptr, html_parser.read_len, &errorCode);
        html_parser.read_temp_ptr[errorCode] = 0;
        html_parser.read_temp_ptr[errorCode + 1] = 0;
        html_parser.read_buff_len = html_parser.buff_len + errorCode;
        html_parser.in_content_len -= errorCode;
        if (errorCode > 0)
        {
            mmi_email_read_cont_parser_ind();
        }
        else
        {
            OslMfree(html_parser.convert_buffer);
            FS_Close(html_parser.file_h);
            if (html_parser.html_data_buff_ptr)
            {
                OslMfree(html_parser.html_data_buff_ptr);
            }
            status = EMAIL_CONT_PARSE_NONE;
            if (email_read_get_general_cont_callback)
            {
                (*email_read_get_general_cont_callback)();
            }
            mmi_frm_scrn_close(email_app_read.grp_id, SCR_EMAIL_LOADING_ID);
        }
    }
    else
    {
        status = EMAIL_CONT_PARSE_NONE;
        if (email_read_get_general_cont_callback)
        {
            (*email_read_get_general_cont_callback)();
        }
        mmi_frm_scrn_close(email_app_read.grp_id, SCR_EMAIL_LOADING_ID);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_read_cont_parser_ind
 * DESCRIPTION
 *  
 * PARAMETERS
 *
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_read_cont_parser_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_CONT_PARSER_IND, __LINE__);

    mmi_email_read_cont_parser();
    if (status == EMAIL_CONT_PARSE_FINISH)
    {
        OslMfree(html_parser.convert_buffer);
        FS_Close(html_parser.file_h);
        if (html_parser.html_data_buff_ptr)
        {
            OslMfree(html_parser.html_data_buff_ptr);
        }
        if (email_read_get_general_cont_callback)
        {
            (*email_read_get_general_cont_callback)();
        }
        mmi_frm_scrn_close(email_app_read.grp_id, SCR_EMAIL_LOADING_ID);
    }
    else
    {
        StartTimer(
            EMAIL_MMI_CONT_PARSER_TIMER,
            0,
            mmi_email_read_cont_parser_ind);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_read_cont_parser
 * DESCRIPTION
 *  Parse the content data or extract the content from HTML format
 * PARAMETERS
 *  ind         [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_read_cont_parser(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *ret_ptr = NULL;
    U16 convert_len = 0;
    U32 errorCode = 0;
    U32 pos = 0, i = 0, j = 0;
    U16 parse_buff_len = MMI_EMAIL_HTML_PARSE_BUFF_LEN / 2;
    S32 dots_len = mmi_wcslen(g_email_2dots);
    BOOL chset_support = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_CONT_PARSER, __LINE__);

    if (email_app_read.html_charset <= MMI_CHSET_BASE ||
        email_app_read.html_charset >= MMI_CHSET_TOTAL)
    {
        convert_len = html_parser.read_buff_len + ENCODING_LENGTH;
        pos = html_parser.read_buff_len;
        ret_ptr = html_parser.convert_buffer;
    }
    else
    {
        chset_support = TRUE;
        ret_ptr = mmi_email_parse_content_to_ucs2(
                    &html_parser,
                    email_app_read.html_charset,
                    &convert_len,
                    &pos);
    }
    if (convert_len == 0)
    {
        if (ret_ptr && chset_support)
        {
            OslMfree(ret_ptr);
        }
        status = EMAIL_CONT_PARSE_FINISH;
        return;
    }
    else
    {
        if (email_app_read.cont_len * sizeof(WCHAR) + convert_len - sizeof(WCHAR) <= MMI_EMAIL_MAX_CONT_LEN * sizeof(WCHAR))
        {
            memcpy(html_parser.data_temp_ptr, ret_ptr, convert_len - sizeof(WCHAR));
            html_parser.data_temp_ptr += convert_len - sizeof(WCHAR);
            email_app_read.cont_len += convert_len / sizeof(WCHAR) - 1;
            html_parser.data_temp_ptr[0] = 0;
            html_parser.data_temp_ptr[1] = 0;
            if (ret_ptr && chset_support)
            {
                OslMfree(ret_ptr);
            }
        }
        else
        {
            S32 to_copy = (MMI_EMAIL_MAX_CONT_LEN - email_app_read.cont_len) * sizeof(WCHAR);
            if (to_copy > 0)
            {
                memcpy(html_parser.data_temp_ptr, ret_ptr, to_copy);

                html_parser.data_temp_ptr += to_copy;
                email_app_read.cont_len = MMI_EMAIL_MAX_CONT_LEN;
                html_parser.data_temp_ptr[0] = 0;
                html_parser.data_temp_ptr[1] = 0;
            }

            html_parser.data_temp_ptr -= sizeof(WCHAR) * dots_len;
            mmi_wcscpy((WCHAR*)html_parser.data_temp_ptr, g_email_2dots);

            if (ret_ptr && chset_support)
            {
                OslMfree(ret_ptr);
            }
            status = EMAIL_CONT_PARSE_FINISH;
            return;
        }
        if (pos != html_parser.read_buff_len)
        {
            if (html_parser.is_last_read && html_parser.read_len == 0)
            {
                status = EMAIL_CONT_PARSE_FINISH;
                return;
            }
            for (i = pos, j = 0; i < html_parser.read_buff_len; i++, j++)
            {
                html_parser.convert_buffer[j] = html_parser.convert_buffer[i];
            }
            html_parser.convert_buffer[j] = 0;
            html_parser.convert_buffer[j + 1] = 0;
            html_parser.buff_len = html_parser.read_buff_len - pos;
            html_parser.read_temp_ptr = html_parser.convert_buffer + html_parser.buff_len;
        }
        else
        {
            if (html_parser.is_last_read)
            {
                status = EMAIL_CONT_PARSE_FINISH;
                return;
            }
            html_parser.read_temp_ptr = html_parser.convert_buffer;
            html_parser.buff_len = 0;
        }
        if (html_parser.in_content_len <= (S32)(parse_buff_len - html_parser.buff_len - sizeof(WCHAR)))
        {
            if (!html_parser.is_last_read)
            {
                html_parser.read_len = html_parser.in_content_len;
                html_parser.is_last_read = TRUE;
            }
            else
            {
                html_parser.read_len = 0;
            }
        }
        else
        {
            html_parser.read_len = parse_buff_len - html_parser.buff_len - sizeof(WCHAR);
        }
        pos = 0;
    }
    if (html_parser.read_len)
    {
        FS_Read(html_parser.file_h, html_parser.read_temp_ptr, html_parser.read_len, &errorCode);
        html_parser.read_temp_ptr[errorCode] = 0;
        html_parser.read_temp_ptr[errorCode + 1] = 0;
        html_parser.read_buff_len = html_parser.buff_len + errorCode;
        html_parser.in_content_len -= errorCode;
        if (errorCode > 0)
        {
            status = EMAIL_CONT_PARSE_PARSING;
        }
        else
        {
            status = EMAIL_CONT_PARSE_FINISH;
        }
    }
    else
    {
        html_parser.read_buff_len = html_parser.buff_len;
        status = EMAIL_CONT_PARSE_PARSING;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_parse_content_to_ucs2
 * DESCRIPTION
 *  Parse content if HTML and convert the result to UCS2
 * PARAMETERS
 *  data        [IN]            String to be converted.
 *  len         [IN]            Length of the string (in bytes)
 *  chset       [IN]            Charset of source string
 *  outLen      [IN/OUT]        Length of converted string(in bytes)
 * RETURNS
 *  pointer to the result string.
 *****************************************************************************/
static U8 *mmi_email_parse_content_to_ucs2(mmi_email_content_parser *parser, S32 chset, U16 *outLen, U32 *pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *convertedData = NULL, *temp_html_buff_ptr = NULL, *html_convert_ptr = NULL;
    U8 *temp_html_convert_ptr = NULL;
    U32 temp_pos = 0, html_convert_len = 0, html_out_len = 0, html_in_len = 0, temp_out_len = 0;
    U32 i = 0, j = 0;
    BOOL ret = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    *outLen = 0;
    if (parser->html_data_buff_ptr == NULL)
    {
        parser->html_data_buff_ptr = OslMalloc(MMI_EMAIL_HTML_PARSE_BUFF_LEN);
        parser->html_data_buff_len = 0;
        applib_html_extract_plaintext_init(&parser->plaintext);
        memset(not_converted_string_data, 0, 20);
    }
    temp_html_buff_ptr = parser->html_data_buff_ptr + parser->html_data_buff_len;
    if (parser->read_buff_len + parser->html_data_buff_len >= MMI_EMAIL_HTML_PARSE_BUFF_LEN - ENCODING_LENGTH)
    {
        html_in_len = MMI_EMAIL_HTML_PARSE_BUFF_LEN - ENCODING_LENGTH;
        *pos = parser->read_buff_len - parser->html_data_buff_len;
        memcpy(
            temp_html_buff_ptr,
            parser->convert_buffer,
            MMI_EMAIL_HTML_PARSE_BUFF_LEN - parser->html_data_buff_len);
        temp_html_buff_ptr[MMI_EMAIL_HTML_PARSE_BUFF_LEN - parser->html_data_buff_len] = '\0';
    }
    else
    {
        html_in_len = parser->read_buff_len + parser->html_data_buff_len;
        *pos = parser->read_buff_len;
        memcpy(
            temp_html_buff_ptr,
            parser->convert_buffer,
            parser->read_buff_len);
        temp_html_buff_ptr[parser->read_buff_len] = '\0';
    }
    html_convert_ptr = OslMalloc(MMI_EMAIL_HTML_PARSE_BUFF_LEN);
    if (not_converted_string_data[0] != '\0')
    {
        strcpy((CHAR*)html_convert_ptr, not_converted_string_data);
        i = strlen(not_converted_string_data);
        temp_html_convert_ptr = html_convert_ptr + i;
        html_out_len = MMI_EMAIL_HTML_PARSE_BUFF_LEN - i;
        memset(not_converted_string_data, 0, 20);
    }
    else
    {
        temp_html_convert_ptr = html_convert_ptr;
        html_out_len = MMI_EMAIL_HTML_PARSE_BUFF_LEN;
    }
    ret = applib_html_extract_plaintext_parse(
        &parser->plaintext,
        (kal_uint8)parser->is_last_read,
        parser->html_data_buff_ptr,
        html_in_len,
        temp_html_convert_ptr,
        &html_out_len,
        &html_convert_len);
    if (!ret)
    {
        *outLen = 0;
        OslMfree(html_convert_ptr);
        return convertedData;
    }
    temp_html_convert_ptr[html_out_len] = '\0';
    for (i = html_convert_len, j = 0; i < html_in_len; i++, j++)
    {
        parser->html_data_buff_ptr[j] = parser->html_data_buff_ptr[i];
    }
    parser->html_data_buff_ptr[j] = '\0';
    parser->html_data_buff_len = html_in_len - html_convert_len;
    convertedData = OslMalloc(2048);
    *outLen = (U16)mmi_chset_convert_ex(
        MMI_CHSET_UTF8,
        MMI_CHSET_UCS2,
        (char*)html_convert_ptr,
        (char*)convertedData,
        2048,
        &temp_pos);
    temp_pos = temp_pos - (U32)html_convert_ptr;
    i = strlen((CHAR*)html_convert_ptr);
    /* the other case should not happen */
    if ((temp_pos <= i) && (i - temp_pos < 20))
    {
        strcpy(not_converted_string_data, (CHAR*)(html_convert_ptr + temp_pos));
    }
    OslMfree(html_convert_ptr);
    return convertedData;
}
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */


void *mmi_email_get_read_cont_buff_ptr(S32 *cont_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (email_app_read.content_offset1 > MMI_EMAIL_MAX_CONT_PREFIX_LEN)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GET_READ_CONT_BUFF_PTR, 1);
        // Error
        email_app_read.content_offset1 = 0;
    }

    if (email_app_read.content_offset2 < email_app_read.content_offset1)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GET_READ_CONT_BUFF_PTR, 2);
        // Error
        email_app_read.content_offset2 = email_app_read.content_offset1;
    }

    if (email_app_read.content_offset2 - email_app_read.content_offset1 > MMI_EMAIL_MAX_CONT_LEN)
    {
        email_app_read.content_offset2 = email_app_read.content_offset1 + MMI_EMAIL_MAX_CONT_LEN;
    }

    if (cont_len)
    {
        //*cont_len = email_app_read.cont_len;
        *cont_len = email_app_read.content_offset2 - email_app_read.content_offset1;
    }
    email_app_read.content[email_app_read.content_offset2] = 0;
    return email_app_read.content + email_app_read.content_offset1;
}


void mmi_email_msg_del_callback(EMAIL_MSG_ID msg_id)
{
    if (msg_id == email_app_read.msg_id && email_app_read.grp_id != 0)
    {
        email_read_msg_not_exist = TRUE;
        email_app_read.msg_id = 0;

        // Quit read screen directly
        mmi_frm_group_close(email_app_read.grp_id);
    }
}

void mmi_email_ui_close_outboxmsg(EMAIL_ACCT_ID acc_id)
{
    if (email_app_read.acct_id == acc_id && email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_OUTBOX && email_app_read.grp_id != 0)
    {
        // Quit read screen directly
        mmi_frm_group_close(email_app_read.grp_id);
    }
}


static mmi_ret mmi_email_read_group_proc(mmi_event_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (event->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 1);
            mmi_email_set_active_group_id(email_app_read.grp_id);
            break;

        case EVT_ID_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 2);
            if (email_app_read.inline_id)
            {
                cui_inline_close(email_app_read.inline_id);
                email_app_read.inline_id = 0;
            }
            email_app_read_extract_free_list();
            mmi_email_read_asm_destroy();
            email_app_read.grp_id = 0;
            email_read_pf_data.is_busy = MMI_FALSE;

#ifdef __MMI_BACKGROUND_CALL__
            mmi_frm_cb_dereg_event(EVT_ID_SRV_UCM_APP_EXIT_QUERY, mmi_email_ucm_call_back, NULL);
#endif

            if (!email_app_read.entry_from_folder)
            {
                mmi_email_app_nwk_user_leave();
            }
            mmi_email_lib_empty_copy_file_dir();
            break;

        case EVT_ID_CUI_INLINE_MAIN_SCREEN_ACTIVE:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 3);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
            wgui_register_tap_callback(mmi_email_read_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

#ifdef __MMI_ICON_BAR_SUPPORT__
            mmi_email_read_tb_set_info();
#endif /* __MMI_ICON_BAR_SUPPORT__ */
            break;

        case EVT_ID_CUI_INLINE_MAIN_SCREEN_SHOWN:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 4);
            {
                if (email_read_msg_not_exist)
                {
                    mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
                    mmi_frm_group_close(email_app_read.grp_id);
                    break;
                }
                if (email_read_msg_not_complete)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_ATTACH_LARGE_TO_DOWN_ID);
                    email_read_msg_not_complete = FALSE;
                    break;
                }
                if (email_read_msg_recp_too_many)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_RECIPIENT_TOO_MANY_ID);
                    email_read_msg_recp_too_many = FALSE;
                    break;
                }
#ifdef __MMI_EMAIL_HTML__
                if (email_read_msg_not_support_charset)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_RECIPIENT_CHARSET_NOT_SUPPORT_ID);
                    email_read_msg_not_support_charset = FALSE;
                    break;
                }
#endif /* __MMI_EMAIL_HTML__ */
            }
            break;

        case EVT_ID_CUI_INLINE_NOTIFY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 5);
            mmi_email_read_inline_notify((cui_event_inline_notify_struct*)event);
                break;

        case EVT_ID_CUI_INLINE_SET_KEY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 6);
            mmi_email_read_inline_setkey((cui_event_inline_set_key_struct*)event);
            break;

        case EVT_ID_CUI_INLINE_CSK_PRESS:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 7);
            mmi_email_read_inline_csk_press((cui_event_inline_csk_press_struct*)event);
            break;

        case EVT_ID_CUI_MENU_LIST_ENTRY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 8);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                mmi_email_read_hide_menu(menu_evt->app_data);
                break;
            }

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 9);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                mmi_email_read_option_handler(menu_evt->highlighted_menu_id, menu_evt->app_data);
                break;
            }

        case EVT_ID_CUI_INLINE_SUBMIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 10);
            {
                email_app_read.option_grp_id = cui_menu_create(
                                                email_app_read.grp_id,
                                                CUI_MENU_SRC_TYPE_RESOURCE,
                                                CUI_MENU_TYPE_OPTION,
                                                MENU_ID_EMAIL_READ_OPT,
                                                MMI_FALSE,
                                                (void*)(&email_app_read));
                cui_menu_set_default_title(email_app_read.option_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
                cui_menu_run(email_app_read.option_grp_id);
            }
            break;

        case EVT_ID_CUI_INLINE_ABORT:
        case EVT_ID_CUI_INLINE_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GROUP_PROC, 11);
            {
                cui_event_inline_abort_struct *abort_evt = (cui_event_inline_abort_struct*)event;
                cui_inline_close(abort_evt->sender_id);
                email_app_read.inline_id = 0;
#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
                if (html_msg_handle != EMAIL_MSG_INVALID_HANDLE)
                {
                    srv_email_msg_destroy(html_msg_handle);
                    html_msg_handle = EMAIL_MSG_INVALID_HANDLE;
                }
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */
                break;
            }

#ifdef BROWSER_SUPPORT
        case EVT_ID_CUI_BKM_ADD_BKM_CLOSE:
            cui_bkm_add_bkm_close(email_read_extract_bmk_id);
            email_read_extract_bmk_id = 0;
            break;

#endif /* BROWSER_SUPPORT */
        case EVT_ID_PHB_SAVE_CONTACT:
        case EVT_ID_PHB_SAVE_CONTACT_CANCEL:
            cui_phb_save_contact_close(email_read_extract_phb_id);
            email_read_extract_phb_id = 0;
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                cui_menu_close(menu_evt->sender_id);
                break;
            }
        default:
            break;
    }

    return MMI_RET_OK;
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_read_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 item_array[10] = {0}, i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_TAP_CALLBACK, __LINE__);

    if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        item_array[i++] = MMI_EMAIL_READ_FROM_ITEM_ID;
    }
    item_array[i++] = MMI_EMAIL_READ_TO_ITEM_ID;
    if (email_app_read.cc_num)
    {
        item_array[i++] = MMI_EMAIL_READ_CC_ITEM_ID;
    }
    if (email_app_read.bcc_num)
    {
        item_array[i++] = MMI_EMAIL_READ_BCC_ITEM_ID;
    }
    item_array[i++] = MMI_EMAIL_READ_SUBJECT_ITEM_ID;
    if (email_app_read.att_num)
    {
        item_array[i++] = MMI_EMAIL_READ_ATTACH_ITEM_ID;
    }
    item_array[i++] = MMI_EMAIL_READ_CONTENT_ITEM_ID;
    switch (item_array[index])
    {
        case MMI_EMAIL_READ_FROM_ITEM_ID:
        case MMI_EMAIL_READ_TO_ITEM_ID:
        case MMI_EMAIL_READ_CC_ITEM_ID:
        case MMI_EMAIL_READ_BCC_ITEM_ID:
            mmi_email_read_goto_addr();
            break;
        case MMI_EMAIL_READ_SUBJECT_ITEM_ID:
            break;
        case MMI_EMAIL_READ_ATTACH_ITEM_ID:
            mmi_email_read_attach();
            break;
        case MMI_EMAIL_READ_CONTENT_ITEM_ID:
            break;
        default:
            break;
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


#ifdef __MMI_ICON_BAR_SUPPORT__
void mmi_email_read_tb_set_info(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_TB_SET_INFO, __LINE__);
    switch (email_app_read.folder_type)
    {
        case SRV_EMAIL_FLDR_TYPE_INBOX:
            email_toolbar_content_icon[MMI_EMAIL_INBOX_READ_TB_REPLY] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_REPLY_MESSAGE);
            email_toolbar_content_icon[MMI_EMAIL_INBOX_READ_TB_FORWARD] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_FORWARD_MESSAGE);
            email_toolbar_content_icon[MMI_EMAIL_INBOX_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE);
            email_toolbar_disabled_content_icon[MMI_EMAIL_INBOX_READ_TB_REPLY] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_REPLY_MESSAGE_DISABLED);
            email_toolbar_disabled_content_icon[MMI_EMAIL_INBOX_READ_TB_FORWARD] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_FORWARD_MESSAGE_DISABLED);
            email_toolbar_disabled_content_icon[MMI_EMAIL_INBOX_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE_DISABLED);
            email_toolbar_string[MMI_EMAIL_INBOX_READ_TB_REPLY] = (PU8)GetString(STR_GLOBAL_REPLY);
            email_toolbar_string[MMI_EMAIL_INBOX_READ_TB_FORWARD] = (PU8)GetString(STR_GLOBAL_FORWARD);
            email_toolbar_string[MMI_EMAIL_INBOX_READ_TB_DELETE] = (PU8)GetString(STR_GLOBAL_DELETE);
            wgui_icon_bar_setup(
                MMI_EMAIL_INBOX_READ_TB_TOTAL,
                email_toolbar_content_icon,
                email_toolbar_disabled_content_icon,
                email_toolbar_string,
                mmi_email_read_inbox_tb_callback);
            if (!mmi_wcslen(email_app_read.from_addr.email_addr))
            {
                wgui_icon_bar_set_item_enable_state(MMI_EMAIL_INBOX_READ_TB_REPLY, MMI_FALSE);
            }
            else
            {
                wgui_icon_bar_set_item_enable_state(MMI_EMAIL_INBOX_READ_TB_REPLY, MMI_TRUE);
            }
            break;
        case SRV_EMAIL_FLDR_TYPE_SENT:
            email_toolbar_content_icon[MMI_EMAIL_SENT_READ_TB_FORWARD] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_FORWARD_MESSAGE);
            email_toolbar_content_icon[MMI_EMAIL_SENT_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE);
            email_toolbar_disabled_content_icon[MMI_EMAIL_SENT_READ_TB_FORWARD] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_FORWARD_MESSAGE_DISABLED);
            email_toolbar_disabled_content_icon[MMI_EMAIL_SENT_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE_DISABLED);
            email_toolbar_string[MMI_EMAIL_SENT_READ_TB_FORWARD] = (PU8)GetString(STR_GLOBAL_FORWARD);
            email_toolbar_string[MMI_EMAIL_SENT_READ_TB_DELETE] = (PU8)GetString(STR_GLOBAL_DELETE);
            wgui_icon_bar_setup(
                MMI_EMAIL_SENT_READ_TB_TOTAL,
                email_toolbar_content_icon,
                email_toolbar_disabled_content_icon,
                email_toolbar_string,
                mmi_email_read_sent_tb_callback);
            break;
        case SRV_EMAIL_FLDR_TYPE_DRAFT:
            email_toolbar_content_icon[MMI_EMAIL_DRAFT_READ_TB_EDIT] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_EDIT);
            email_toolbar_content_icon[MMI_EMAIL_DRAFT_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE);
            email_toolbar_disabled_content_icon[MMI_EMAIL_DRAFT_READ_TB_EDIT] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_EDIT_DISABLED);
            email_toolbar_disabled_content_icon[MMI_EMAIL_DRAFT_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE_DISABLED);
            email_toolbar_string[MMI_EMAIL_DRAFT_READ_TB_EDIT] = (PU8)GetString(STR_GLOBAL_EDIT);
            email_toolbar_string[MMI_EMAIL_DRAFT_READ_TB_DELETE] = (PU8)GetString(STR_GLOBAL_DELETE);
            wgui_icon_bar_setup(
                MMI_EMAIL_DRAFT_READ_TB_TOTAL,
                email_toolbar_content_icon,
                email_toolbar_disabled_content_icon,
                email_toolbar_string,
                mmi_email_read_draft_tb_callback);
            break;
        case SRV_EMAIL_FLDR_TYPE_OUTBOX:
            //email_toolbar_content_icon[MMI_EMAIL_OUTBOX_READ_TB_SEND] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_SEND_MESSAGE);
            //email_toolbar_content_icon[MMI_EMAIL_OUTBOX_READ_TB_EDIT] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_EDIT);
            email_toolbar_content_icon[MMI_EMAIL_OUTBOX_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE);
            //email_toolbar_disabled_content_icon[MMI_EMAIL_OUTBOX_READ_TB_SEND] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_SEND_MESSAGE_DISABLED);
            //email_toolbar_disabled_content_icon[MMI_EMAIL_OUTBOX_READ_TB_EDIT] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_EDIT_DISABLED);
            email_toolbar_disabled_content_icon[MMI_EMAIL_OUTBOX_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE_DISABLED);
            //email_toolbar_string[MMI_EMAIL_OUTBOX_READ_TB_SEND] = (PU8)GetString(STR_GLOBAL_SEND);
            //email_toolbar_string[MMI_EMAIL_OUTBOX_READ_TB_EDIT] = (PU8)GetString(STR_GLOBAL_EDIT);
            email_toolbar_string[MMI_EMAIL_OUTBOX_READ_TB_DELETE] = (PU8)GetString(STR_GLOBAL_DELETE);
            wgui_icon_bar_setup(
                MMI_EMAIL_OUTBOX_READ_TB_TOTAL,
                email_toolbar_content_icon,
                email_toolbar_disabled_content_icon,
                email_toolbar_string,
                mmi_email_read_outbox_tb_callback);
            break;
        default:    
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
            email_toolbar_content_icon[MMI_EMAIL_REMOTE_READ_TB_FORWARD] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_FORWARD_MESSAGE);
            email_toolbar_content_icon[MMI_EMAIL_REMOTE_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE);
            email_toolbar_disabled_content_icon[MMI_EMAIL_REMOTE_READ_TB_FORWARD] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_FORWARD_MESSAGE_DISABLED);
            email_toolbar_disabled_content_icon[MMI_EMAIL_REMOTE_READ_TB_DELETE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_DELETE_DISABLED);
            email_toolbar_string[MMI_EMAIL_REMOTE_READ_TB_FORWARD] = (PU8)GetString(STR_GLOBAL_FORWARD);
            email_toolbar_string[MMI_EMAIL_REMOTE_READ_TB_DELETE] = (PU8)GetString(STR_GLOBAL_DELETE);
            wgui_icon_bar_setup(
                MMI_EMAIL_REMOTE_READ_TB_TOTAL,
                email_toolbar_content_icon,
                email_toolbar_disabled_content_icon,
                email_toolbar_string,
                mmi_email_read_remote_tb_callback);
#endif    
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_read_inbox_tb_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_read_inbox_tb_callback(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_INBOX_TB_CALLBACK, __LINE__);
    if (index == MMI_EMAIL_INBOX_READ_TB_REPLY)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_REPLY, (void*)&email_app_read);
    }
    else if (index == MMI_EMAIL_INBOX_READ_TB_FORWARD)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_FORWARD, (void*)&email_app_read);
    }
    else /* EMAIL_INBOX_READ_TB_DELETE */
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_DELETE, (void*)&email_app_read);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_read_outbox_tb_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_read_outbox_tb_callback(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_OUTBOX_TB_CALLBACK, __LINE__);
    /*
    if (index == MMI_EMAIL_OUTBOX_READ_TB_SEND)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_SEND_MSG, (void*)&email_app_read);
    }

    else if (index == MMI_EMAIL_OUTBOX_READ_TB_EDIT)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_EDIT, (void*)&email_app_read);
    }

    else 
    */
    /* EMAIL_OUTBOX_READ_TB_DELETE */
    if (index == MMI_EMAIL_OUTBOX_READ_TB_DELETE)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_DELETE, (void*)&email_app_read);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_read_sent_tb_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_read_sent_tb_callback(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_SENT_TB_CALLBACK, __LINE__);

    if (index == MMI_EMAIL_SENT_READ_TB_FORWARD)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_FORWARD, (void*)&email_app_read);
    }
    else /* EMAIL_SENT_READ_TB_DELETE */
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_DELETE, (void*)&email_app_read);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_read_draft_tb_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_read_draft_tb_callback(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_DRAFT_TB_CALLBACK, __LINE__);

    if (index == MMI_EMAIL_DRAFT_READ_TB_EDIT)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_EDIT, (void*)&email_app_read);
    }
    else /* EMAIL_DRAFT_READ_TB_DELETE */
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_DELETE, (void*)&email_app_read);
    }
}


#ifdef __MMI_EMAIL_REMOTE_FOLDER__
/*****************************************************************************
 * FUNCTION
 *  mmi_email_read_remote_tb_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_read_remote_tb_callback(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_REMOTE_TB_CALLBACK, __LINE__);

    if (index == MMI_EMAIL_REMOTE_READ_TB_FORWARD)
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_FORWARD, (void*)&email_app_read);
    }
    else /* EMAIL_REMOTE_READ_TB_DELETE */
    {
        mmi_email_read_option_handler(MENU_ID_EMAIL_DELETE, (void*)&email_app_read);
    }
}
#endif /*__MMI_EMAIL_REMOTE_FOLDER__*/

#endif /* __MMI_ICON_BAR_SUPPORT__ */


void mmi_email_read_hide_menu(void *read_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    email_app_read_msg_struct *app_data = (email_app_read_msg_struct*)read_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_HIDE_MENU, __LINE__);

    if (app_data->folder_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        EMAIL_MSG_HANDLE msg_handle = 0;
        srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
        srv_email_msg_get_basic_info_struct *basic_info = NULL;
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_FORWARD, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_SEND_MSG, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_TRUE);
        if (!mmi_wcslen(app_data->from_addr.email_addr))
        {
            cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
            cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY_ALL, MMI_TRUE);
        }
        else
        {
            cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY, MMI_FALSE);
            if (app_data->to_num || app_data->cc_num || app_data->bcc_num)
            {
                cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY_ALL, MMI_FALSE);
            }
            else
            {
                cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY_ALL, MMI_TRUE);
            }
        }
        if (app_data->state & SRV_EMAIL_MSG_STATE_DOWN_ALL)
        {
            cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_READ_RET_OPT, MMI_TRUE);
        }
        else
        {
            cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_READ_RET_OPT, MMI_FALSE);
        }
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_FALSE);
        result = srv_email_msg_create(0, &msg_handle);
        if (result == SRV_EMAIL_RESULT_SUCC)
        {
            result = srv_email_msg_open(msg_handle, app_data->acct_id, app_data->fldr_id, app_data->msg_id);
            if (result == SRV_EMAIL_RESULT_SUCC)
            {
                basic_info = OslMalloc(sizeof(srv_email_msg_get_basic_info_struct));
                result = srv_email_msg_get_basic_info(msg_handle, basic_info);
                if (result == SRV_EMAIL_RESULT_SUCC)
                {
                    if (!basic_info->flag & EMAIL_MSG_FLAG_SEEN)
                    {
                        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
                    }
                }
                OslMfree(basic_info);
            }
            srv_email_msg_destroy(msg_handle);
        }
    }
    else if (app_data->folder_type == SRV_EMAIL_FLDR_TYPE_DRAFT)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_EDIT, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_SEND_MSG, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY_ALL, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_FORWARD, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_READ_RET_OPT, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
    }
    else if (app_data->folder_type == SRV_EMAIL_FLDR_TYPE_OUTBOX)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_SEND_MSG, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY_ALL, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_FORWARD, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_READ_RET_OPT, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
    }
    else
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_FORWARD, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_SEND_MSG, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_REPLY_ALL, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
        if ((app_data->state & SRV_EMAIL_MSG_STATE_DOWN_ALL) ||
            (app_data->folder_type == SRV_EMAIL_FLDR_TYPE_SENT))
        {
            cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_READ_RET_OPT, MMI_TRUE);
        }
        else
        {
            cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_READ_RET_OPT, MMI_FALSE);
        }
    }

    email_app_read_url_menu_hide(app_data->option_grp_id);

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
    if (email_app_read.has_html &&
        email_app_read.html_charset < MMI_CHSET_TOTAL &&
        email_app_read.html_charset > MMI_CHSET_BASE)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_VIEW_HTML, MMI_FALSE);
    }
    else
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_VIEW_HTML, MMI_TRUE);
    }
#ifdef __MMI_BPP20_SUPPORT__
    cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_PRINT, MMI_FALSE);
#else
    cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_PRINT, MMI_TRUE);
#endif
}


void mmi_email_read_option_handler(mmi_menu_id menu_id, void *read_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    email_app_read_msg_struct *app_data = (email_app_read_msg_struct*)read_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_OPTION_HANDLER, 0);

    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_OPTION_HANDLER, -1);
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return;
    }

    switch (menu_id)
    {
        case MENU_ID_EMAIL_SEND_MSG:
            {
                EMAIL_MSG_HANDLE msg_handle = 0;
                email_app_save_send_proc_struct *info = NULL;
                srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
                result = srv_email_msg_create(0, &msg_handle);
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    mmi_email_util_display_error_popup(email_app_read.grp_id, result);
                    break;
                }
                result = srv_email_msg_open(
                    msg_handle,
                    email_app_read.acct_id,
                    email_app_read.fldr_id,
                    email_app_read.msg_id);
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    srv_email_msg_destroy(msg_handle);
                    mmi_email_util_display_error_popup(email_app_read.grp_id, result);
                    break;
                }
                info = OslMalloc(sizeof(email_app_save_send_proc_struct));
                memset(info, 0, sizeof(email_app_save_send_proc_struct));
                info->dst_acct_id = email_app_read.acct_id;
                info->dst_fldr_id = email_app_read.fldr_id;
                info->opt = MMI_EMAIL_SS_SEND;
                info->save_part = SRV_EMAIL_MSG_SAVE_ALL;
                info->parent_id = email_app_read.parent_id;
                info->msg_handle = msg_handle;
                info->callback = mmi_email_read_send_callback;
                info->user_data = (void*)msg_handle;
                mmi_email_set_ss(info);
                OslMfree(info);
                mmi_email_save_send();
            }
            break;

        case MENU_ID_EMAIL_REPLY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_REPLY_START);
            {
                mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_read.acct_id;
                comp_data->fldr_id = email_app_read.fldr_id;
                comp_data->msg_id = email_app_read.msg_id;
                comp_data->parent_id = email_app_read.grp_id;
                comp_data->is_close_parent = TRUE;
                comp_data->type = EMAIL_PRE_COMP_TYPE_REPLY;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            }
            break;

        case MENU_ID_EMAIL_REPLY_ALL:
            {
                mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_read.acct_id;
                comp_data->fldr_id = email_app_read.fldr_id;
                comp_data->msg_id = email_app_read.msg_id;
                comp_data->parent_id = email_app_read.grp_id;
                comp_data->is_close_parent = TRUE;
                comp_data->type = EMAIL_PRE_COMP_TYPE_REPLY_ALL;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            }
            break;

        case MENU_ID_EMAIL_EDIT:
            {
                mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_read.acct_id;
                comp_data->fldr_id = email_app_read.fldr_id;
                comp_data->msg_id = email_app_read.msg_id;
                comp_data->parent_id = email_app_read.parent_id;
                comp_data->is_close_parent = FALSE;
                if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_OUTBOX)
                {
                    comp_data->edit_from_outbox = TRUE;
                }
                comp_data->type = EMAIL_PRE_COMP_TYPE_EDIT;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
                mmi_frm_group_close(email_app_read.grp_id);
            }
            break;

        case MENU_ID_EMAIL_FORWARD:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_FORWARD_START);
            {
                mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_read.acct_id;
                comp_data->fldr_id = email_app_read.fldr_id;
                comp_data->msg_id = email_app_read.msg_id;
                comp_data->parent_id = email_app_read.grp_id;
                comp_data->is_close_parent = TRUE;
                comp_data->type = EMAIL_PRE_COMP_TYPE_FORWARD;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            }
            break;

        case MENU_ID_EMAIL_DELETE:
            mmi_email_util_display_confirm(
                email_app_read.grp_id,
                mmi_email_read_delete_msg,
                mmi_frm_scrn_close_active_id,
                NULL,
                FALSE,
                GetString(STR_EMAIL_DEL_SEL_MAIL_ID),
                MMI_EVENT_QUERY);
            break;

        case MENU_ID_EMAIL_MOVE_TO_DRAFTS:
            mmi_email_read_move_to_drafts(app_data->msg_id, app_data->acct_id, app_data->fldr_id);
            break;

        case MENU_ID_EMAIL_MARK_UNREAD:
            {
                EMAIL_MSG_HANDLE msg_handle = 0;
                srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
                result = srv_email_msg_create(0, &msg_handle);
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    mmi_email_util_display_error_popup(app_data->grp_id, result);
                    return;
                }
                result = srv_email_msg_open(msg_handle, app_data->acct_id, app_data->fldr_id, app_data->msg_id);
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    srv_email_msg_destroy(msg_handle);
                    mmi_email_util_display_error_popup(app_data->grp_id, result);
                    return;
                }
                result = srv_email_msg_set_flag(msg_handle, EMAIL_MSG_FLAG_SEEN, 0);
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    mmi_email_util_display_error_popup(app_data->grp_id, result);
                }
                srv_email_msg_destroy(msg_handle);
                mmi_frm_group_close(app_data->option_grp_id);
            }
            break;

        case MENU_ID_EMAIL_READ_RET_OPT:
            email_app_read.curr_hilit_pf_index = 0;
            mmi_email_entry_read_pf();
            break;

        case MENU_ID_EMAIL_LINK_OK:
            email_app_read_url_action();
            break;

        case MENU_ID_EMAIL_EXTRACT_ADDR_PHONE_CALL:
            mmi_email_read_extract_addr_phone_call();
            break;
            
        case MENU_ID_EMAIL_EXTRACT_ADDR_PHONE_SAVE:
            mmi_email_read_extract_addr_phone_save();
            break;

        case MENU_ID_EMAIL_EXTRACT_ADDR_PHONE_SMS:
            mmi_email_read_extract_addr_phone_sms();
            break;

        case MENU_ID_EMAIL_EXTRACT_ADDR_EMAIL_SAVE:
            mmi_email_read_extract_addr_email_save();
            break;

        case MENU_ID_EMAIL_EXTRACT_ADDR_EMAIL_SEND:
            mmi_email_read_extract_addr_email_send();
            break;

#ifdef BROWSER_SUPPORT
        case MENU_ID_EMAIL_EXTRACT_ADDR_URL_GOTO:
            mmi_email_read_extract_addr_url_goto();
            break;
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__
        case MENU_ID_EMAIL_EXTRACT_ADDR_URL_SAVE:
            mmi_email_read_extract_addr_url_save();
            break;
#endif /* __MMI_BRW_BKM_INTERFACE_SUPPORT__ */
#endif /* BROWSER_SUPPORT */

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
        case MENU_ID_EMAIL_VIEW_HTML:
            mmi_email_read_view_html();
            break;
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

        case MENU_ID_EMAIL_MESSAGE_DETAIL:
            {
                mmi_email_init_msg_detail_struct(
                    app_data->msg_id,
                    app_data->fldr_id,
                    app_data->acct_id,
                    app_data->grp_id);
                mmi_email_show_msg_detail();
            }
            break;
#ifdef __MMI_BPP20_SUPPORT__
        case MENU_ID_EMAIL_PRINT:
            {
                mmi_email_bpp_mail_struct mail;
                mail.account_id = app_data->acct_id;
                mail.folder_id = app_data->fldr_id;
                mail.msg_id = app_data->msg_id;
                mmi_email_bpp_print(app_data->grp_id, &mail);
            }
            break;
#endif
        default:
            break;
    }
    return;
}


#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
void mmi_email_read_exit_view_browser(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXIT_VIEW_BROWSER, __LINE__);

    if (html_msg_handle != EMAIL_MSG_INVALID_HANDLE)
    {
        srv_email_msg_destroy(html_msg_handle);
        html_msg_handle = EMAIL_MSG_INVALID_HANDLE;
    }
}

static void mmi_email_read_view_html(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    CHAR *filepath_data = NULL, *filepath_temp = NULL;
    U32 i = 0, total = 0;
    char opera_title[20] = {0};
    char *charset;
    applib_mime_type_struct *mime_info = NULL;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    CHAR *charset_string = OslMalloc(50+1);
    U32 path_len = SRV_FMGR_PATH_MAX_LEN + 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_VIEW_HTML, 1);

    if (html_msg_handle != EMAIL_MSG_INVALID_HANDLE)
    {
        srv_email_msg_destroy(html_msg_handle);
        html_msg_handle = EMAIL_MSG_INVALID_HANDLE;
    }
    result = srv_email_msg_create(0, &html_msg_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
        OslMfree(charset_string);
        return;
    }
    result = srv_email_msg_open(
                html_msg_handle,
                email_app_read.acct_id,
                email_app_read.fldr_id,
                email_app_read.msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        if (html_msg_handle != EMAIL_MSG_INVALID_HANDLE)
        {
            srv_email_msg_destroy(html_msg_handle);
            html_msg_handle = EMAIL_MSG_INVALID_HANDLE;
        }
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
        OslMfree(charset_string);
        return;
    }
    result = srv_email_msg_get_html_file(
        html_msg_handle,
        email_app_read.html_file_path,
        &path_len,
        charset_string,
        MMI_FALSE);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_msg_destroy(html_msg_handle);
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
        OslMfree(charset_string);
        return;
    }
    filepath_data = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(CHAR));
    filepath_temp = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(CHAR));
    for (; i < email_app_read.att_num; i++)
    {
        if (!attach_info_array[i].downloaded ||
#ifdef __DRM_SUPPORT__
            attach_info_array[i].drm_object ||
#endif /* __DRM_SUPPORT__ */
            (strlen(attach_info_array[i].cid) == 0))
        {
            continue;
        }
        html_att_info[total].cid = attach_info_array[i].cid;
        html_att_info[total].path = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(CHAR));
        mmi_chset_convert(
            MMI_CHSET_UCS2,
            (mmi_chset_enum)MMI_CHSET_UTF8,
            (char*)attach_info_array[i].path,
            (char*)html_att_info[total].path,
            (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(CHAR));
        html_att_info[total].name = OslMalloc((EMAIL_ATTCH_FILE_NAME_LEN + 1) * sizeof(CHAR));
        mmi_chset_convert(
            MMI_CHSET_UCS2,
            (mmi_chset_enum)MMI_CHSET_UTF8,
            (char*)attach_info_array[i].attach_name,
            (char*)html_att_info[total].name,
            (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(CHAR));
        mime_info = applib_mime_get_file_type((WCHAR*)attach_info_array[i].attach_name);
        if (mime_info == NULL)
        {
            html_att_info[total].mime = NULL;
        }
        else
        {
            html_att_info[total].mime = mime_info->mime_string;
        }
        total++;
    }
    mmi_wcs_to_asc((CHAR*)filepath_temp, email_app_read.html_file_path);
    memcpy(filepath_data, filepath_temp, (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(CHAR));
    mmi_chset_convert(
        (mmi_chset_enum)MMI_CHSET_UCS2,
        MMI_CHSET_UTF8,
        (char*)GetString(STR_GLOBAL_EMAIL),
        (char*)opera_title,
        20);
    //mmi_wcs_to_asc((CHAR*)opera_title, (WCHAR*)GetString(STR_GLOBAL_EMAIL));
    charset = (char*)chset_get_preferred_mime_name(CHSET_UTF8);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_VIEW_HTML, 2);
    OperaApi_ShowEmail(
        (char*)filepath_data,
        (char*)opera_title,
        charset,
        total,
        (OperaApi_MimeInfo*)html_att_info,
        mmi_email_read_exit_view_browser);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_VIEW_HTML, 3);
    for (i = 0; i < total; i++)
    {
        OslMfree(html_att_info[i].path);
        OslMfree(html_att_info[i].name);
    }
    OslMfree(filepath_data);
    OslMfree(filepath_temp);
    OslMfree(charset_string);
}
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */


void mmi_email_entry_read_pf(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 num_items = 1;
    U8 *str_main_list[MMI_EMAIL_MAX_ATTACH_NUMBER + 2];
    U8 *str_popup_list[MMI_EMAIL_MAX_ATTACH_NUMBER + 2];
    U8 *gui_buffer;
    U32 index = 0;
    srv_email_acct_info_cache_struct *cache_data = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_PF, 1);
    if (!mmi_frm_scrn_enter(
            email_app_read.grp_id,
            SCR_ID_EMAIL_READ_RETRIEVE_OPT,
            NULL,
            mmi_email_entry_read_pf,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_PF, 2);
        return;
    }

    kal_wsprintf(
        email_app_read.total_size_str,
        "%d%w",
        ((U32)email_app_read.whole_msg_size + 1023) / 1024,
        g_email_kilobyte);

    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    str_main_list[0] = (U8*)GetString(STR_EMAIL_DOWNLOAD_ID);
    str_popup_list[0] = (U8*)email_app_read.total_size_str;
    cache_data = OslMalloc(sizeof(srv_email_acct_info_cache_struct));
    srv_email_acct_cache_get(email_app_read.acct_id, cache_data);
    if (cache_data->protocol == SRV_EMAIL_PROT_IMAP4)
    {
        //??? get content state and num_items += 1;
        if ((email_app_read.cont_state & SRV_EMAIL_MSG_CONT_PART_EXIST &&
             !(email_app_read.cont_state & SRV_EMAIL_MSG_CONT_DOWNLOADED)) ||
             (email_app_read.state & SRV_EMAIL_MSG_STATE_DOWN_NOT_FINISH) ||
            (email_app_read.html_state & SRV_EMAIL_MSG_CONT_PART_EXIST &&
             !(email_app_read.html_state & SRV_EMAIL_MSG_CONT_DOWNLOADED)))
        {
            str_main_list[num_items] = (U8*)GetString(STR_GLOBAL_CONTENT);
            str_popup_list[num_items] = NULL;
            num_items += 1;
        }
        for (; index < email_app_read.att_num; index++)
        {
            if (!attach_info_array[index].downloaded)
            {
                str_main_list[num_items] = (U8*)attach_info_array[index].attach_name;
                str_popup_list[num_items] = (U8*)attach_info_array[index].attach_size_str;
                num_items += 1;
            }
        }
    }
    OslMfree(cache_data);
    RegisterHighlightHandler(mmi_email_hilite_read_pf_item);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    ShowCategory53Screen(
        STR_EMAIL_RETRIEVE_OPTION_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        num_items,
        str_main_list,
        (U16*)gIndexIconsImageList,
        str_popup_list,
        0,
        email_app_read.curr_hilit_pf_index,
        gui_buffer);
    SetCenterSoftkeyFunction(mmi_email_read_pf_lsk, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_email_read_pf_lsk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
}


void mmi_email_read_pf_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 index = 0, item_index = 0, pre_index = 0;
    BOOL found = FALSE, is_fetch = FALSE, close_screen = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_PF_LSK, __LINE__);
    if (email_app_read.curr_hilit_pf_index == 0)
    {
        mmi_email_read_pf_pre_download(
            email_app_read.grp_id,
            0,
            SRV_EMAIL_RETRIEVE_ALL_PARTS);
        close_screen = mmi_email_read_pf_download();
    }
    else
    {
        //??? content state handler (pre_index)
        if ((email_app_read.cont_state & SRV_EMAIL_MSG_CONT_PART_EXIST &&
             !(email_app_read.cont_state & SRV_EMAIL_MSG_CONT_DOWNLOADED)) ||
              (email_app_read.state & SRV_EMAIL_MSG_STATE_DOWN_NOT_FINISH) ||
            (email_app_read.html_state & SRV_EMAIL_MSG_CONT_PART_EXIST &&
            !(email_app_read.html_state & SRV_EMAIL_MSG_CONT_DOWNLOADED)))
        {
            if (email_app_read.curr_hilit_pf_index == 1)
            {
                mmi_email_read_pf_pre_download(
                    email_app_read.grp_id,
                    0,
                    SRV_EMAIL_RETRIEVE_ALL_CONTENT);
                close_screen = mmi_email_read_pf_download();
                is_fetch = TRUE;
            }
            pre_index++;
        }
        if (!is_fetch)
        {
            do 
            {
                if (!attach_info_array[index].downloaded)
                {
                    if (item_index < email_app_read.curr_hilit_pf_index - pre_index)
                    {
                        item_index += 1;
                    }
                    if (item_index == email_app_read.curr_hilit_pf_index - pre_index)
                    {
                        found = TRUE;
                        break;
                    }
                }
            } while (++index < email_app_read.att_num);
            if (found)
            {
                mmi_email_read_pf_pre_download(
                    email_app_read.grp_id,
                    attach_info_array[index].attach_id,
                    SRV_EMAIL_RETRIEVE_SINGLE_ATTACHMENT);
                close_screen = mmi_email_read_pf_download();
            }
        }
    }
    if (close_screen)
    {
        mmi_frm_scrn_close(email_app_read.grp_id, SCR_ID_EMAIL_READ_RETRIEVE_OPT);
    }
}


void mmi_email_hilite_read_pf_item(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_app_read.curr_hilit_pf_index = index;
}


void mmi_email_read_pf_pre_download(
        mmi_id parent_id,
        EMAIL_ATTCH_ID attach_id,
        srv_email_retrieve_option_enum ret_opt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&email_read_pf_data, 0, sizeof(email_app_read_partial_fetch_struct));
    email_read_pf_data.parent_id = parent_id;
    email_read_pf_data.attach_id = attach_id;
    email_read_pf_data.ret_opt = ret_opt;
}


BOOL mmi_email_read_pf_download(void)
{
    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return TRUE;
    }

    mmi_email_app_nwk_user_download(
        email_app_read.grp_id, 
        email_app_read.acct_id,
        email_app_read.fldr_id,
        email_app_read.msg_id,
        email_read_pf_data.attach_id,
        email_read_pf_data.ret_opt);

    return TRUE;
}


void mmi_email_entry_read_pf_disconnecting(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_frm_scrn_enter(
            email_read_pf_data.grp_id,
            SCR_EMAIL_LOADING_ID,
            NULL,
            mmi_email_entry_read_pf_disconnecting,
            MMI_FRM_FULL_SCRN))
    {
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_DISCONNECTING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetKeyHandler(NULL, KEY_END, KEY_EVENT_DOWN);
}


void mmi_email_read_add_attach_field_to_display(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_inline_set_item_struct item = {0};
#ifdef __MMI_FTE_SUPPORT__
    cui_inline_item_display_only_struct display_only_struct = {0};
#else
    cui_inline_item_image_text_struct image_text_struct = {0};
#endif
    U16 csk_icon_id = 0, pre_id = 0, field = MMI_EMAIL_READ_ATTACH_ITEM_ID;
    WCHAR *display = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ADD_ATTACH_FIELD_TO_DISPLAY, __LINE__);

#ifndef __MMI_FTE_SUPPORT__
    image_text_struct.image1_id = IMG_EMAIL_ATTACHMENT_ID;
    if (!r2lMMIFlag)
    {
        image_text_struct.image2_id = 0;
        image_text_struct.image3_id = RIGHT_RED_ARROW;
    }
    else
    {
        image_text_struct.image2_id = RIGHT_RED_ARROW;
        image_text_struct.image3_id = 0;
    }
    image_text_struct.buffer_size = mmi_wcslen(email_app_read.attach_display);
#endif
    display = email_app_read.attach_display;
    pre_id = MMI_EMAIL_READ_CONTENT_ITEM_ID;
    item.image_id = IMG_EMAIL_ATTACHMENT_ID;
    item.item_id = MMI_EMAIL_READ_ATTACH_ITEM_ID;
#ifdef __MMI_FTE_SUPPORT__
    item.item_flag = CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY;
    item.item_data = (void*)(&display_only_struct);
#else
    item.item_flag = CUI_INLINE_ITEM_TYPE_IMAGE_TEXT | CUI_INLINE_ITEM_DRAW_AS_CONTROL;
    item.item_data = (void*)(&image_text_struct);
#endif
    cui_inline_insert_item(
        email_app_read.inline_id,
        pre_id,
        &item);
    if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        if (mmi_wcslen(email_app_read.from_addr.email_addr))
        {
            csk_icon_id = IMG_GLOBAL_REPLY_MSG_CSK;
        }
        else
        {
            csk_icon_id = IMG_GLOBAL_FORWARD_MSG_CSK;
        }
    }
    else if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_DRAFT)
    {
        csk_icon_id = IMG_GLOBAL_COMMON_CSK;
    }
    else if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_OUTBOX)
    {
        csk_icon_id = IMG_GLOBAL_SEND_MSG_CSK;
    }
    else
    {
        csk_icon_id = IMG_GLOBAL_FORWARD_MSG_CSK;
    }
#ifdef __MMI_FTE_SUPPORT__
    cui_inline_set_item_attributes(
        email_app_read.inline_id,
        field,
        CUI_INLINE_SET_ATTRIBUTE,
        CUI_INLINE_ITEM_DEFAULT_TEXT);
#endif
    cui_inline_set_value(
        email_app_read.inline_id,
        field,
        display);
    cui_inline_set_softkey_icon(
        email_app_read.inline_id,
        field,
        MMI_CENTER_SOFTKEY,
        csk_icon_id);
    cui_inline_set_softkey_text(
        email_app_read.inline_id,
        field,
        MMI_LEFT_SOFTKEY,
        STR_GLOBAL_OPTIONS);
    cui_inline_set_softkey_icon(
        email_app_read.inline_id,
        field,
        MMI_LEFT_SOFTKEY,
        IMG_GLOBAL_OPTIONS);
    cui_inline_set_highlight_item(
        email_app_read.inline_id,
        field);
}


void mmi_email_read_pf_update_cont_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_PF_UPDATE_CONT_CALLBACK, email_app_read.inline_id);

    if (email_app_read.inline_id == 0)
    {
        return;
    }
    
    mmi_email_read_add_link();
}


void mmi_email_read_pf_update_info(EMAIL_MSG_HANDLE msg_handle, S32 major, S32 minor,S32 down_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_msg_get_basic_info_struct *basic_info = NULL;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    U32 cont_len = 0;
    S32 cont_char = 0;
    U32 att_num = email_app_read.att_num;
    BOOL get_content = FALSE;

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
    WCHAR *filepath_input = NULL;
    WCHAR *filepath_output = NULL;
    WCHAR *filepath_temp = NULL;
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_PF_UPDATE_INFO, __LINE__);
    if (email_app_read.inline_id == 0)
    {
        return;
    }

    if (major != 0)
    {
        if (email_read_msg_not_exist
            || minor == SRV_EMAIL_RESULT_MSG_NOT_EXIST
            || minor == SRV_EMAIL_RESULT_INVALID_MSG)
        {
            mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
            mmi_frm_group_close(email_app_read.grp_id);
            return;
        }

        if (minor == SRV_EMAIL_RESULT_MSG_EXCEED_DOWNLOAD_SIZE)
        {
            kal_wsprintf(
                selected_file_path,
                "%w %uKB",
                (WCHAR*)GetString(STR_EMAIL_TOO_LARGE_TO_DOWN_ID),
                (U32)(down_size + 1023) / 1024);
            mmi_email_util_display_popup(
                0,
                (CHAR*)selected_file_path,
                MMI_EVENT_FAILURE);
            return;
        }

        mmi_email_lib_error_popup(mmi_email_util_get_err_code(major, minor));
        // No return here
    }

    if (msg_handle == EMAIL_MSG_INVALID_HANDLE)
    {
        return;
    }

    email_app_read.content[0] = 0;
    email_app_read.cont_len = 0;
    basic_info = OslMalloc(sizeof(srv_email_msg_get_basic_info_struct));
    result = srv_email_msg_get_basic_info(
                msg_handle,
                basic_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
        OslMfree(basic_info);
        return;
    }
    email_app_read.att_num = basic_info->attach_num;
    email_app_read.state = basic_info->state;

    if (basic_info->remain_attach_num)
    {
        email_read_msg_not_complete = TRUE;
    }
    else
    {
        email_read_msg_not_complete = FALSE;
    }
    email_app_read.whole_msg_size = basic_info->server_size;
    OslMfree(basic_info);
    srv_email_msg_cont_size(msg_handle, &email_app_read.plain_text_size, &email_app_read.html_text_size);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_UE_READMORE_BASIC_INFO_PF, 
        email_app_read.state, email_app_read.whole_msg_size, email_app_read.plain_text_size, email_app_read.html_text_size);	

    result = srv_email_msg_get_content_len(
                msg_handle,
                &cont_len,
                &cont_char);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
        return;
    }
    get_content = TRUE;
    email_read_get_general_cont_callback = mmi_email_read_pf_update_cont_callback;
    result = srv_email_msg_cont_status(
                msg_handle,
                &email_app_read.cont_state,
                &email_app_read.html_state);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
#ifdef __MMI_EMAIL_HTML__
        email_app_read.has_html = FALSE;
#endif /* __MMI_EMAIL_HTML__ */
        return;
    }
    if (email_app_read.cont_state & SRV_EMAIL_MSG_CONT_PART_EXIST)
    {
        if (cont_len)
        {
            if (cont_len > MMI_EMAIL_MAX_CONT_LEN)
            {
                email_app_read.cont_len = MMI_EMAIL_MAX_CONT_LEN;
            }
            else
            {
                email_app_read.cont_len = cont_len + 1;
            }
            email_app_read.cont_len += 2;
            result = srv_email_msg_get_content(
                msg_handle,
                MMI_TRUE,
                email_app_read.content,
                (U32*)&email_app_read.cont_len);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(email_app_read.grp_id, result);
                return;
            }
            email_app_read.content[email_app_read.cont_len] = 0;
        }
        get_content = TRUE;
    }
    else
    {
        get_content = FALSE;
    }
#ifdef __MMI_EMAIL_HTML__
    if ((email_app_read.html_state & SRV_EMAIL_MSG_CONT_PART_EXIST) &&
        (email_app_read.html_state & SRV_EMAIL_MSG_CONT_DOWNLOADED))
    {
        CHAR *charset_string = OslMalloc(50+1);
        U32 path_len = SRV_FMGR_PATH_MAX_LEN + 1;
#ifdef OPERA_V10_BROWSER
        result = srv_email_msg_get_html_file(
            msg_handle,
            email_app_read.html_file_path,
            &path_len,
            charset_string,
            MMI_TRUE);
#else /* OPERA_V10_BROWSER */
        result = srv_email_msg_get_html_file(
            msg_handle,
            email_app_read.html_file_path,
            &path_len,
            charset_string,
            MMI_FALSE);
#endif

        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            OslMfree(charset_string);
            return;
        }
        if (mmi_chset_get_charset_id((const kal_int8 *)charset_string, &email_app_read.html_charset))
        {
            if (email_app_read.html_charset < MMI_CHSET_TOTAL &&
                email_app_read.html_charset > MMI_CHSET_BASE)
            {
                email_read_msg_not_support_charset = FALSE;
                get_content = FALSE;
            }
            else
            {
                email_read_msg_not_support_charset = TRUE;
                get_content = TRUE;
            }
        }
        else
        {
            email_read_msg_not_support_charset = TRUE;
            get_content = TRUE;
        }
        OslMfree(charset_string);
        email_app_read.has_html = TRUE;
    }
    else
    {
        email_app_read.has_html = FALSE;
    }

    if (email_app_read.inline_id != 0)
    {
        mmi_email_read_add_link();
    }    

    if ((email_app_read.cont_state & SRV_EMAIL_MSG_CONT_PART_EXIST))
    {
        get_content = TRUE;
    }
    if (!get_content && email_app_read.has_html)
    {
        mmi_email_read_get_cont_loading();

#ifdef OPERA_V10_BROWSER
        filepath_input = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        filepath_output = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        filepath_temp = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        mmi_wcs_to_asc((CHAR*)filepath_temp, email_app_read.html_file_path);
        memcpy(filepath_input, filepath_temp, SRV_FMGR_PATH_MAX_LEN + 1);
        kal_wsprintf(
            filepath_output,
            "%s%s",
            srv_email_get_root_path(),
            "html_output");
        mmi_wcs_to_asc((CHAR*)filepath_temp, filepath_output);
        memcpy(filepath_output, filepath_temp, SRV_FMGR_PATH_MAX_LEN + 1);
        OperaApi_Html2Text(
            (char*)filepath_input,
            (char*)filepath_output,
            mmi_email_read_html_convert_to_pt_callback,
            NULL);
        OslMfree(filepath_input);
        OslMfree(filepath_output);
        OslMfree(filepath_temp);
        // Hide Email from OOM list
        applib_mem_ap_set_hide(APPLIB_MEM_AP_ID_EMAIL, MMI_TRUE);
        
#else /* #ifdef OPERA_V10_BROWSER */
        mmi_email_read_extract_html();
#endif /* #ifdef OPERA_V10_BROWSER */
    }
#else /* __MMI_EMAIL_HTML__ */
    if (email_app_read.inline_id != 0)
    {
        mmi_email_read_add_link();
    }
#endif /* __MMI_EMAIL_HTML__ */

    memset(email_app_read.attach_display, 0, sizeof(email_app_read.attach_display));
    mmi_email_read_init_attach_info(email_app_read.grp_id, msg_handle);
    if (att_num == 0 && email_app_read.att_num != 0)
    {
        mmi_email_read_add_attach_field_to_display();
    }
}


static void mmi_email_read_send_callback(BOOL result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_SEND_CALLBACK, __LINE__);

    srv_email_msg_destroy((EMAIL_MSG_ID)user_data);
    mmi_frm_group_close(email_app_read.grp_id);
}


/*****************************************************************************
* FUNCTION
*  mmi_email_malloc
* DESCRIPTION
*  function to call OslMalloc
* PARAMETERS
*  size        [IN]        size to malloc
* RETURNS
*  address be malloced
*****************************************************************************/
static void* mmi_email_extract_malloc(kal_uint32 size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    void* p;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*
     * the content now is in UCS2 encoding and when extract address,
     * the APPLIB will alloc memory. Because the content size may be
     * larger than 2048 (MAX size of control buffer), the alloc function
     * should handle the case. Return the message detail buffer pointer
     * in this case.
     */
    /*
    if (size > 2048)
    {
        p = (void*)email_app_msg_detail_buff;
    }
    else
    {
        p = OslMalloc(size);
    }
    */

    p = mmi_email_app_mem_malloc(size);
    // USE ASM
    return p;
}

/*****************************************************************************
* FUNCTION
*  mmi_email_free
* DESCRIPTION
*  function to call OslMfree
* PARAMETERS
*  p        [IN]        address to be free
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_extract_free(void* p)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*
     * As the descriptions in alloc function, the free function should
     * also handle the case. If the pointer is message detail buffer
     * pointer, it will return directly.
     */
    /*
    if (p == (void*)email_app_msg_detail_buff)
    {
        return;
    }
    OslMfree(p);
    p = NULL;
    */

    if (p != NULL)
    {
        mmi_email_app_mem_free(p);
    }
}

static kal_bool mmi_email_extract_check_stop(
                    applib_addr_type_enum type,
                    applib_address_node_struct *addr,
                    kal_uint32 num)
{   
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (num >= EMAIL_READ_EXTRACT_MAX_ADDR)
    {
        return KAL_TRUE;
    }
    return KAL_FALSE;    
}

void mmi_email_entry_read(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __MMI_FTE_SUPPORT__
    S32 display_index = 0;
#else
    S32 image_text_index = 0;
#endif
    S32 inline_item_index = 0;
    S32 from_len = 0;
    U16 cap_str_id = 0, csk_icon_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ, __LINE__);

    if (email_app_read.grp_id == 0 || !mmi_email_smgr_network_check())
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ, -1);
        return;
    }

    from_len = mmi_wcslen(email_app_read.from_addr.email_addr);
    if ((email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_INBOX))// && from_len
    {
#ifdef __MMI_FTE_SUPPORT__
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_FROM_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_READ_FROM_ID,
            &email_read_display_only_struct[display_index++]);
#else
        email_read_image_text_struct[image_text_index].image1_id = IMG_EMAIL_READ_FROM_ID;
        if (!r2lMMIFlag)
        {
            email_read_image_text_struct[image_text_index].image2_id = 0;
            email_read_image_text_struct[image_text_index].image3_id = RIGHT_RED_ARROW;
        }
        else
        {
            email_read_image_text_struct[image_text_index].image2_id = RIGHT_RED_ARROW;
            email_read_image_text_struct[image_text_index].image3_id = 0;
        }
        email_read_image_text_struct[image_text_index].buffer_size = mmi_wcslen(email_app_read.from_display) + 1;
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_FROM_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_IMAGE_TEXT | CUI_INLINE_ITEM_DRAW_AS_CONTROL,
            IMG_EMAIL_READ_FROM_ID,
            &email_read_image_text_struct[image_text_index++]);
#endif
        cap_str_id = STR_EMAIL_FROM_ID;
    }

    //if (email_app_read.to_num)
    {
#ifdef __MMI_FTE_SUPPORT__
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_TO_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_TO_ID,
            &email_read_display_only_struct[display_index++]);
#else
        email_read_image_text_struct[image_text_index].image1_id = IMG_EMAIL_TO_ID;
        if (!r2lMMIFlag)
        {
            email_read_image_text_struct[image_text_index].image2_id = 0;
            email_read_image_text_struct[image_text_index].image3_id = RIGHT_RED_ARROW;
        }
        else
        {
            email_read_image_text_struct[image_text_index].image2_id = RIGHT_RED_ARROW;
            email_read_image_text_struct[image_text_index].image3_id = 0;
        }
        email_read_image_text_struct[image_text_index].buffer_size = mmi_wcslen(email_app_read.to_display) + 1;
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_TO_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_IMAGE_TEXT | CUI_INLINE_ITEM_DRAW_AS_CONTROL,
            IMG_EMAIL_TO_ID,
            &email_read_image_text_struct[image_text_index++]);
#endif
        if (!cap_str_id)
        {
            cap_str_id = STR_EMAIL_TO_ID;
        }
    }

    if (email_app_read.cc_num)
    {
#ifdef __MMI_FTE_SUPPORT__
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_CC_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_CC_ID,
            &email_read_display_only_struct[display_index++]);
#else
        email_read_image_text_struct[image_text_index].image1_id = IMG_EMAIL_CC_ID;
        if (!r2lMMIFlag)
        {
            email_read_image_text_struct[image_text_index].image2_id = 0;
            email_read_image_text_struct[image_text_index].image3_id = RIGHT_RED_ARROW;
        }
        else
        {
            email_read_image_text_struct[image_text_index].image2_id = RIGHT_RED_ARROW;
            email_read_image_text_struct[image_text_index].image3_id = 0;
        }
        email_read_image_text_struct[image_text_index].buffer_size = mmi_wcslen(email_app_read.cc_display) + 1;
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_CC_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_IMAGE_TEXT | CUI_INLINE_ITEM_DRAW_AS_CONTROL,
            IMG_EMAIL_CC_ID,
            &email_read_image_text_struct[image_text_index++]);
#endif
        if (!cap_str_id)
        {
            cap_str_id = STR_EMAIL_CC_ID;
        }
    }

    if (email_app_read.bcc_num)
    {
#ifdef __MMI_FTE_SUPPORT__
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_BCC_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_BCC_ID,
            &email_read_display_only_struct[display_index++]);
#else
        email_read_image_text_struct[image_text_index].image1_id = IMG_EMAIL_BCC_ID;
        if (!r2lMMIFlag)
        {
            email_read_image_text_struct[image_text_index].image2_id = 0;
            email_read_image_text_struct[image_text_index].image3_id = RIGHT_RED_ARROW;
        }
        else
        {
            email_read_image_text_struct[image_text_index].image2_id = RIGHT_RED_ARROW;
            email_read_image_text_struct[image_text_index].image3_id = 0;
        }
        email_read_image_text_struct[image_text_index].buffer_size = mmi_wcslen(email_app_read.bcc_display) + 1;
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_BCC_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_IMAGE_TEXT | CUI_INLINE_ITEM_DRAW_AS_CONTROL,
            IMG_EMAIL_BCC_ID,
            &email_read_image_text_struct[image_text_index++]);
#endif
        if (!cap_str_id)
        {
            cap_str_id = STR_EMAIL_BCC_ID;
        }
    }

    /* subject */
#ifdef __MMI_FTE_SUPPORT__
    mmi_email_read_init_inline_item_struct(
        &email_read_inline_item[inline_item_index++],
        MMI_EMAIL_READ_SUBJECT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY | CUI_INLINE_ITEM_DISPLAY_ONLY_SHOW,
        IMG_EMAIL_SUBJECT_ID,
        &email_read_display_only_struct);
#else
    email_read_image_text_struct[image_text_index].image1_id = IMG_EMAIL_SUBJECT_ID;
    email_read_image_text_struct[image_text_index].image2_id = 0;
    email_read_image_text_struct[image_text_index].image3_id = 0;
    email_read_image_text_struct[image_text_index].buffer_size = mmi_wcslen(email_app_read.subj);
    mmi_email_read_init_inline_item_struct(
        &email_read_inline_item[inline_item_index++],
        MMI_EMAIL_READ_SUBJECT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_IMAGE_TEXT | CUI_INLINE_ITEM_DRAW_AS_CONTROL,
        IMG_EMAIL_SUBJECT_ID,
        &email_read_image_text_struct[image_text_index++]);
#endif
    if (!cap_str_id)
    {
        cap_str_id = STR_GLOBAL_SUBJECT;
    }
    /* attachment */
    if (email_app_read.att_num)
    {
#ifdef __MMI_FTE_SUPPORT__
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_ATTACH_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_ATTACHMENT_ID,
            &email_read_display_only_struct[display_index++]);
#else
        email_read_image_text_struct[image_text_index].image1_id = IMG_EMAIL_ATTACHMENT_ID;
        if (!r2lMMIFlag)
        {
            email_read_image_text_struct[image_text_index].image2_id = 0;
            email_read_image_text_struct[image_text_index].image3_id = RIGHT_RED_ARROW;
        }
        else
        {
            email_read_image_text_struct[image_text_index].image2_id = RIGHT_RED_ARROW;
            email_read_image_text_struct[image_text_index].image3_id = 0;
        }
        email_read_image_text_struct[image_text_index].buffer_size = mmi_wcslen(email_app_read.attach_display);
        mmi_email_read_init_inline_item_struct(
            &email_read_inline_item[inline_item_index++],
            MMI_EMAIL_READ_ATTACH_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_IMAGE_TEXT | CUI_INLINE_ITEM_DRAW_AS_CONTROL,
            IMG_EMAIL_ATTACHMENT_ID,
            &email_read_image_text_struct[image_text_index++]);
#endif
        if (!cap_str_id)
        {
            cap_str_id = STR_EMAIL_ATTACHMENT_ID;
        }
    }

#ifdef __MMI_FTE_SUPPORT__
    email_read_multi_rdonly_struct.height_of_item = INLINE_FTE_MULTILINE_READ_ONLY_ROW_COUNT;
#else
    email_read_multi_rdonly_struct.height_of_item = 7;
#endif /* __MMI_FTE_SUPPORT__ */

    mmi_email_read_init_inline_item_struct(
        &email_read_inline_item[inline_item_index++],
        MMI_EMAIL_READ_CONTENT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_MULTILINE_RD_ONLY | CUI_INLINE_ITEM_DISABLE_LIST_HIGHLIGHT,
        0,
        &email_read_multi_rdonly_struct);
    if (!cap_str_id)
    {
        cap_str_id = STR_GLOBAL_CONTENT;
    }
    read_read_inline_struct.items_count = inline_item_index;
    read_read_inline_struct.title = cap_str_id;
    read_read_inline_struct.title_icon = GetRootTitleIcon(MENU_ID_EMAIL_MAIN);
    read_read_inline_struct.screen_flag = CUI_INLINE_SCREEN_LOOP | CUI_INLINE_SCREEN_DISABLE_DONE;
    read_read_inline_struct.softkey = &email_read_softkey_struct;
    read_read_inline_struct.items = email_read_inline_item;

    email_app_read.inline_id = cui_inline_create(email_app_read.grp_id, &read_read_inline_struct);
    if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        if (from_len)
        {
            csk_icon_id = IMG_GLOBAL_REPLY_MSG_CSK;
        }
        else
        {
            csk_icon_id = IMG_GLOBAL_FORWARD_MSG_CSK;
        }
    }
    else if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_DRAFT)
    {
        csk_icon_id = IMG_GLOBAL_COMMON_CSK;
    }
    else if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_OUTBOX)
    {
        csk_icon_id = IMG_GLOBAL_SEND_MSG_CSK;
    }
    else
    {
        csk_icon_id = IMG_GLOBAL_FORWARD_MSG_CSK;
    }

    email_app_read.default_csk_img = csk_icon_id;
    if ((email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_INBOX))// && from_len
    {
        cui_inline_set_value(
            email_app_read.inline_id, 
            MMI_EMAIL_READ_FROM_ITEM_ID, 
            email_app_read.from_display);
        cui_inline_set_softkey_icon(
            email_app_read.inline_id, 
            MMI_EMAIL_READ_FROM_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            csk_icon_id);
    }
    //if (email_app_read.to_num)
    {
        cui_inline_set_value(
            email_app_read.inline_id,
            MMI_EMAIL_READ_TO_ITEM_ID, 
            email_app_read.to_display);
        cui_inline_set_softkey_icon(
            email_app_read.inline_id,
            MMI_EMAIL_READ_TO_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            csk_icon_id);
    }
    if (email_app_read.cc_num)
    {
        cui_inline_set_value(
            email_app_read.inline_id,
            MMI_EMAIL_READ_CC_ITEM_ID,
            email_app_read.cc_display);
        cui_inline_set_softkey_icon(
            email_app_read.inline_id,
            MMI_EMAIL_READ_CC_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            csk_icon_id);
    }
    if (email_app_read.bcc_num)
    {
        cui_inline_set_value(
            email_app_read.inline_id,
            MMI_EMAIL_READ_BCC_ITEM_ID,
            email_app_read.bcc_display);
        cui_inline_set_softkey_icon(
            email_app_read.inline_id,
            MMI_EMAIL_READ_BCC_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            csk_icon_id);
    }
    cui_inline_set_value(
        email_app_read.inline_id,
        MMI_EMAIL_READ_SUBJECT_ITEM_ID,
        email_app_read.subj);
    cui_inline_set_softkey_icon(
        email_app_read.inline_id,
        MMI_EMAIL_READ_SUBJECT_ITEM_ID,
        MMI_CENTER_SOFTKEY,
        csk_icon_id);
    if (email_app_read.att_num)
    {
        cui_inline_set_value(
            email_app_read.inline_id,
            MMI_EMAIL_READ_ATTACH_ITEM_ID,
            email_app_read.attach_display);
        cui_inline_set_softkey_icon(
            email_app_read.inline_id,
            MMI_EMAIL_READ_ATTACH_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            csk_icon_id);
    }

    mmi_email_read_add_link();

    cui_inline_set_softkey_icon(
        email_app_read.inline_id,
        MMI_EMAIL_READ_CONTENT_ITEM_ID,
        MMI_CENTER_SOFTKEY,
        csk_icon_id);
    
    cui_inline_run(email_app_read.inline_id);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_OPEN_DONE);
}

static void mmi_email_extract_list_limit(void)
{
    S32 i = 0;
    applib_address_node_struct *p1, *p2;
    // Keep EMAIL_READ_EXTRACT_MAX_ADDR only

    p1 = email_read_extract_addr_list;
    while (p1 != NULL && i < EMAIL_READ_EXTRACT_MAX_ADDR - 1)
    {
        p1 = p1->next;
        i++;
    }

    if (p1 == NULL)
    {
        return;
    }

    p2 = p1->next;
    p1->next = NULL;
    p1= p2;
    while (p1 != NULL) 
    {
        p2 = p1->next;
        if (p1->data)
        {
            mmi_email_extract_free(p1->data);
        }
        if (p1->data2)
        {
            mmi_email_extract_free(p1->data2);
        }
        mmi_email_extract_free(p1);
        p1 = p2;
    }    
}

static void mmi_email_read_add_link(void)
{
    WCHAR *link;
    cui_inline_hilite_str_struct *item;

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
    U32 len1, len2;
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

    cui_inline_set_multiline_rd_highlight_list_struct hlist;

    U32 remain_ksize = 0;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ADD_LINK, 1);

    if (mmi_email_app_mem_get_ptr() == NULL)
    {
        return;
    }

    link = (WCHAR*)mmi_email_app_mem_malloc(sizeof(WCHAR) * 256);
    if (link == NULL)
    {
        //TODO...
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ADD_LINK, 2);
        return;
    }
    item = (cui_inline_hilite_str_struct*)mmi_email_app_mem_malloc(sizeof(cui_inline_hilite_str_struct) * (4 + EMAIL_READ_EXTRACT_MAX_ADDR));
    if (item == NULL)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ADD_LINK, 3);
        mmi_email_app_mem_free(link);
        return;
    }

    email_app_read.content_offset1 = 0;
    email_app_read.content_offset2 = 0;

    hlist.hilite_list = item;
    hlist.count = 0;
    hlist.curr_hilite_idx = 0;

    item[hlist.count].hilite_type = (EDITOR_HILITE_TYPE)0;
    item[hlist.count].str_offset = 0;
    item[hlist.count].length = 0;
    hlist.count++;

    email_app_read.has_html_link = FALSE;

#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
    if (email_app_read.has_html &&
        email_app_read.html_charset < MMI_CHSET_TOTAL &&
        email_app_read.html_charset > MMI_CHSET_BASE)
    {
        email_app_read.has_html_link = TRUE;

        len1 = mmi_wcslen(email_app_read.content);
        kal_wsprintf(link, "%w\r\n\r\n", (WCHAR*)GetString(STR_EMAIL_LINK_HTML)); //"Message in HTML");

        len2 = mmi_wcslen(link);

        item[hlist.count].hilite_type = (EDITOR_HILITE_TYPE)1;
        item[hlist.count].str_offset = 0;
        item[hlist.count].length = len2 - 4/**/;
        hlist.count++;

        if (len1 > 0)
        {
            /* Move content after link */
            memmove(email_app_read.content +  len2, email_app_read.content, len1 * 2);
        }
        memcpy(email_app_read.content, link, mmi_wcslen(link) * 2);
        email_app_read.content[len1 + len2] = 0;

        email_app_read.content_offset1 = len2;
    }
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */

    email_app_read.content_offset2 = mmi_wcslen(email_app_read.content);
    // Set hightlight

    email_app_read.cont_len = mmi_wcslen(email_app_read.content);
    if (email_app_read.cont_len > 0)
    {
        kal_bool is_stopped = KAL_FALSE;
        applib_address_node_struct *p;
        S32 i = 0;

        email_app_read_extract_free_list();
        email_read_extract_addr_list = mmi_email_emaildata_autofind(
            (CHAR*)email_app_read.content,
            MMI_TRUE,
            email_app_read.cont_len * ENCODING_LENGTH,
            (applib_addr_type_enum)(APPLIB_ADDR_TYPE_EMAIL | 
#ifdef BROWSER_SUPPORT
            APPLIB_ADDR_TYPE_URL | 
#endif
            APPLIB_ADDR_TYPE_PHONENUMBER),
            mmi_email_extract_malloc,
            mmi_email_extract_free,
            mmi_email_extract_check_stop,
            APPLIB_INPUT_DATA_TYPE_UNICODE,
            &is_stopped);
        mmi_email_extract_list_limit();

        i = 0;
        p = email_read_extract_addr_list;
        while (p != NULL && hlist.count < EMAIL_READ_EXTRACT_MAX_ADDR + 2 && i < EMAIL_READ_EXTRACT_MAX_ADDR)
        {
            item[hlist.count].hilite_type = (EDITOR_HILITE_TYPE)1;
            item[hlist.count].str_offset = p->pos;
            item[hlist.count].length = p->length / 2;
            hlist.count++;
            i++;

            p = p->next;
        }
    }

    email_app_read.more_link_type = EMAIL_APP_MORE_TYPE_NULL;
    if (mmi_email_read_util_get_protocol() == SRV_EMAIL_PROT_POP3)
    {
        if (email_app_read.state & SRV_EMAIL_MSG_STATE_DOWN_NOT_FINISH)
        {
            remain_ksize = ((U32)email_app_read.whole_msg_size + 1023) / 1024;
            kal_wsprintf(link, 
                "\r\n\r\n%w %dKB\r\n", 
                (WCHAR*)GetString(STR_EMAIL_LINK_MORE_WHOLE_MSG), 
                remain_ksize);
            email_app_read.more_link_type = EMAIL_APP_MORE_TYPE_ALL_MSG;
        }
    }
    else
    {
        if (email_app_read.state & SRV_EMAIL_MSG_STATE_DOWN_NOT_FINISH)
        {
            remain_ksize = (email_app_read.plain_text_size + email_app_read.html_text_size + 1023) / 1024;
            kal_wsprintf(link, "\r\n\r\n%w %dKB\r\n", 
                (WCHAR*)GetString(STR_EMAIL_LINK_MORE_ALL_CONTENT),
                remain_ksize); 
            email_app_read.more_link_type = EMAIL_APP_MORE_TYPE_ALL_CNT;
        }
        else if ((email_app_read.html_state & SRV_EMAIL_MSG_CONT_PART_EXIST) &&
            !(email_app_read.html_state & SRV_EMAIL_MSG_CONT_DOWNLOADED))
        {
            remain_ksize = (email_app_read.html_text_size + 1023) / 1024;
            //"Download HTML content"
            kal_wsprintf(link, "\r\n\r\n%w %dKB\r\n", 
                (WCHAR*)GetString(STR_EMAIL_LINK_MORE_HTML),
                remain_ksize);
            email_app_read.more_link_type = EMAIL_APP_MORE_TYPE_HTML;
        }
        else
        {
            /* Nothing to do */
        }
    }

    if (email_app_read.more_link_type != EMAIL_APP_MORE_TYPE_NULL)
    {
        item[hlist.count].hilite_type = (EDITOR_HILITE_TYPE)1;
        item[hlist.count].str_offset = (mmi_wcslen(email_app_read.content) + 4) * 2;
        item[hlist.count].length = mmi_wcslen(link) - 6;

        if (email_app_read.content[0] == 0)
        {
            mmi_wcscat(email_app_read.content, link + 4);
            item[hlist.count].str_offset -= (4 * 2);
        }
        else
        {
            U16 content_len = mmi_wcslen(email_app_read.content);
            if (email_app_read.content[content_len - 1] == '\n')
            {
                mmi_wcscat(email_app_read.content, link + 2);
                item[hlist.count].str_offset -= (2 * 2);
            }
            else
            {
                mmi_wcscat(email_app_read.content, link);
            }
        }

        hlist.count++;
    }

    item[hlist.count].hilite_type = (EDITOR_HILITE_TYPE)0;
    item[hlist.count].str_offset = 0;
    item[hlist.count].length = 0;
    hlist.count++;

    cui_inline_set_value(
        email_app_read.inline_id,
        MMI_EMAIL_READ_CONTENT_ITEM_ID,
        email_app_read.content);

    //if (hlist.count > 2)
    {
        cui_inline_set_ml_rdly_set_hilite_list(
            email_app_read.inline_id,
            MMI_EMAIL_READ_CONTENT_ITEM_ID,
            &hlist);
    }

    mmi_email_app_mem_free(link);
    mmi_email_app_mem_free(item);
}

void mmi_email_read_inline_notify(cui_event_inline_notify_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (event->event_type)
    {
    case CUI_INLINE_NOTIFY_HIGHLIGHT_ITEM:
        email_app_read.curr_item_id = event->item_id;
        if (event->item_id == MMI_EMAIL_READ_FROM_ITEM_ID)
        {
            cui_inline_set_title_string(email_app_read.inline_id, get_string(STR_EMAIL_FROM_ID));
        }
        else if (event->item_id == MMI_EMAIL_READ_TO_ITEM_ID)
        {
            cui_inline_set_title_string(email_app_read.inline_id, get_string(STR_EMAIL_TO_ID));
        }
        else if (event->item_id == MMI_EMAIL_READ_CC_ITEM_ID)
        {
            cui_inline_set_title_string(email_app_read.inline_id, get_string(STR_EMAIL_CC_ID));
        }
        else if (event->item_id == MMI_EMAIL_READ_BCC_ITEM_ID)
        {
            cui_inline_set_title_string(email_app_read.inline_id, get_string(STR_EMAIL_BCC_ID));
        }
        else if (event->item_id == MMI_EMAIL_READ_SUBJECT_ITEM_ID)
        {
            cui_inline_set_title_string(email_app_read.inline_id, get_string(STR_GLOBAL_SUBJECT));
        }
        else if (event->item_id == MMI_EMAIL_READ_ATTACH_ITEM_ID)
        {
            cui_inline_set_title_string(email_app_read.inline_id, get_string(STR_EMAIL_ATTACHMENT_ID));
        }
        else if (event->item_id == MMI_EMAIL_READ_CONTENT_ITEM_ID)
        {
            cui_inline_set_title_string(email_app_read.inline_id, get_string(STR_GLOBAL_CONTENT));
        }
        break;

    case CUI_INLINE_NOTIFY_IMAGE_TEXT_PEN_DOWN:
        if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
        {
            mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
            mmi_frm_group_close(email_app_read.grp_id);
            return;
        }
        email_app_read.curr_item_id = event->item_id;
        if (event->item_id == MMI_EMAIL_READ_FROM_ITEM_ID ||
            event->item_id == MMI_EMAIL_READ_TO_ITEM_ID ||
            event->item_id == MMI_EMAIL_READ_CC_ITEM_ID ||
            event->item_id == MMI_EMAIL_READ_BCC_ITEM_ID)
        {
            mmi_email_read_goto_addr();
        }
        else
        {
            mmi_email_read_attach();
        }
        break;

    case CUI_INLINE_NOTIFY_ITEM_ACTIVATED:
        email_app_read.option_grp_id = cui_menu_create(
            email_app_read.grp_id,
            CUI_MENU_SRC_TYPE_RESOURCE,
            CUI_MENU_TYPE_OPTION,
            MENU_ID_EMAIL_READ_OPT,
            MMI_FALSE,
            (void*)(&email_app_read));
        cui_menu_set_default_title(email_app_read.option_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
        cui_menu_run(email_app_read.option_grp_id);
        break;

    case CUI_INLINE_NOTIFY_ML_RDLY_HIGHLIGHT_LIST_CHANGE_INDEX:
        email_app_read.curr_hilite_url_idx = (S16)(event->param);
        email_app_read_url_hilite();
        break;

    case CUI_INLINE_NOTIFY_ML_RDLY_HIGHLIGHT_LIST_CLICK:
        if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
        {
            mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
            mmi_frm_group_close(email_app_read.grp_id);
            return;
        }
        email_app_read.curr_hilite_url_idx = (S16)(event->param);
        email_app_read_url_action();
        break;

    default:
        break;
    }
}


static void email_app_read_url_hilite(void)
{
    U32 type;
    applib_address_node_struct *p = NULL;

    mmi_id gid = email_app_read.inline_id;
    U16 item_id = email_app_read.curr_item_id;

    if (email_app_read.curr_item_id != MMI_EMAIL_READ_CONTENT_ITEM_ID)
    {
        // Set CSK Reply
        cui_inline_set_softkey_icon(gid, MMI_EMAIL_READ_SUBJECT_ITEM_ID, MMI_CENTER_SOFTKEY, email_app_read.default_csk_img);
        return;
    }

    type = email_app_read_url_get_type(email_app_read.curr_hilite_url_idx, &p);
    if (type == EMAIL_APP_HILITE_TYPE_HEAD)
    {
        cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, IMG_GLOBAL_WEB_BROWSER_CSK);
    }
    else if (type == EMAIL_APP_HILITE_TYPE_BODY)
    {
        switch(p->dataType)
        {
        case APPLIB_ADDR_TYPE_EMAIL:
            cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, IMG_GLOBAL_SEND_MSG_CSK);
            break;

        case APPLIB_ADDR_TYPE_URL:
            cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, IMG_GLOBAL_WEB_BROWSER_CSK);
            break;

        case APPLIB_ADDR_TYPE_PHONENUMBER:
            cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, IMG_GLOBAL_CALL_CSK);
            break;

        default:
			cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, IMG_GLOBAL_COMMON_CSK);
            break;
        }
    }
    else if (type == EMAIL_APP_HILITE_TYPE_TAIL)
    {
        if (email_app_read.more_link_type != EMAIL_APP_MORE_TYPE_NULL)
        {
            cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, IMG_GLOBAL_COMMON_CSK);
        }
        else
        {
            cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, email_app_read.default_csk_img);
        }
    }
    else
    {
        email_app_read.curr_hilite_url_idx = -1;
        cui_inline_set_softkey_icon(gid, item_id, MMI_CENTER_SOFTKEY, email_app_read.default_csk_img);
    }
}

static U32 email_app_read_url_get_type(S16 idx, applib_address_node_struct **pp)
{
    applib_address_node_struct *p;

    idx--;
    if (email_app_read.has_html_link)
    {
        if (idx == 0)
        {
            return EMAIL_APP_HILITE_TYPE_HEAD;
        }
        idx--;
    }

    p = email_read_extract_addr_list;
    while(p != NULL)
    {
        if (idx == 0)
        {
            if (pp!= NULL)
            {
                *pp = p;
            }
            email_read_extract_addr_curr = p;
            return EMAIL_APP_HILITE_TYPE_BODY;
        }
        idx--;
        p = p->next;
    }

    if (idx == 0)
    {
        return EMAIL_APP_HILITE_TYPE_TAIL;
    }

    return EMAIL_APP_HILITE_TYPE_NULL;
}

static MMI_BOOL email_app_read_url_action(void)
{
    U32 type;
    applib_address_node_struct *p = NULL;

    if (email_app_read.curr_item_id != MMI_EMAIL_READ_CONTENT_ITEM_ID)
    {
        return MMI_FALSE;
    }

    type = email_app_read_url_get_type(email_app_read.curr_hilite_url_idx, &p);

    if (type == EMAIL_APP_HILITE_TYPE_HEAD)
    {
        // View by browser
#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
        mmi_email_read_view_html();
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */
        return MMI_TRUE;
    }
    else if (type == EMAIL_APP_HILITE_TYPE_BODY)
    {
        switch(p->dataType)
        {
        case APPLIB_ADDR_TYPE_EMAIL:
            mmi_email_read_extract_addr_email_send();
            return MMI_TRUE;

        case APPLIB_ADDR_TYPE_URL:
            mmi_email_read_extract_addr_url_goto();
            return MMI_TRUE;

        case APPLIB_ADDR_TYPE_PHONENUMBER:
            mmi_email_read_extract_addr_phone_call();
            return MMI_TRUE;

        default:
            return MMI_FALSE;
        }
    }
    else if (type == EMAIL_APP_HILITE_TYPE_TAIL)
    {
        srv_email_retrieve_option_enum opt;

        // Partial download content
        switch (email_app_read.more_link_type)
        {
        case EMAIL_APP_MORE_TYPE_ALL_MSG: //POP3
            opt = SRV_EMAIL_RETRIEVE_ALL_PARTS;
            break;

        case EMAIL_APP_MORE_TYPE_ALL_CNT:
            opt = SRV_EMAIL_RETRIEVE_ALL_CONTENT;
            break;

        case EMAIL_APP_MORE_TYPE_HTML:
            opt = SRV_EMAIL_RETRIEVE_HTML_CONTENT;
            break;

        default:
            return MMI_FALSE;
        }

        if (email_app_read.more_link_type != EMAIL_APP_MORE_TYPE_NULL)
        {
            mmi_email_read_pf_pre_download(email_app_read.grp_id, 0, opt);
            mmi_email_read_pf_download();
            return MMI_TRUE;
        }
        return MMI_FALSE;
    }
    else
    {
        return MMI_FALSE;
    }
}

static void email_app_read_url_menu_hide(mmi_id menu_id)
{
    U32 type;
    applib_address_node_struct *p = NULL;

    cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_LINK_OK, MMI_TRUE);
    cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_PHONE, MMI_TRUE);
    cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_EMAIL, MMI_TRUE);
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__
    cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_UEL, MMI_TRUE);
#else
    cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_URL_GOTO, MMI_TRUE);
#endif

    if (email_app_read.curr_item_id != MMI_EMAIL_READ_CONTENT_ITEM_ID)
    {
        return;
    }

    type = email_app_read_url_get_type(email_app_read.curr_hilite_url_idx, &p);
    if (type == EMAIL_APP_HILITE_TYPE_HEAD)
    {
        // View by browser
#ifdef __MMI_EMAIL_HTML__
#ifdef OPERA_V10_BROWSER
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_LINK_OK, MMI_FALSE);
#endif /* OPERA_V10_BROWSER */
#endif /* __MMI_EMAIL_HTML__ */
    }
    else if (type == EMAIL_APP_HILITE_TYPE_BODY)
    {
        switch(p->dataType)
        {
        case APPLIB_ADDR_TYPE_EMAIL:
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_LINK_OK, MMI_FALSE);
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_EMAIL, MMI_FALSE);
            break;

        case APPLIB_ADDR_TYPE_URL:
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_LINK_OK, MMI_FALSE);
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_UEL, MMI_FALSE);
#else
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_URL_GOTO, MMI_FALSE);
#endif
            break;

        case APPLIB_ADDR_TYPE_PHONENUMBER:
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_LINK_OK, MMI_FALSE);
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_EXTRACT_ADDR_PHONE, MMI_FALSE);
            break;
        }
    }
    else if (type == EMAIL_APP_HILITE_TYPE_TAIL)
    {
        switch (email_app_read.more_link_type)
        {
        case EMAIL_APP_MORE_TYPE_ALL_MSG: //POP3
        case EMAIL_APP_MORE_TYPE_ALL_CNT:
        case EMAIL_APP_MORE_TYPE_HTML:
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_LINK_OK, MMI_FALSE);
            break;
        default:
            break;
        }
    }

}

void mmi_email_read_inline_setkey(cui_event_inline_set_key_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (event->item_id == MMI_EMAIL_READ_FROM_ITEM_ID ||
        event->item_id == MMI_EMAIL_READ_TO_ITEM_ID ||
        event->item_id == MMI_EMAIL_READ_CC_ITEM_ID ||
        event->item_id == MMI_EMAIL_READ_BCC_ITEM_ID)
    {
        SetKeyHandler(mmi_email_read_goto_addr, KEY_RIGHT_ARROW, KEY_EVENT_UP);
    }
    else if (event->item_id == MMI_EMAIL_READ_ATTACH_ITEM_ID)
    {
        SetKeyHandler(mmi_email_read_attach, KEY_RIGHT_ARROW, KEY_EVENT_UP);
    }
    else
    {
        ClearKeyHandler(KEY_RIGHT_ARROW, KEY_EVENT_UP);
    }
}


void mmi_email_read_inline_csk_press(cui_event_inline_csk_press_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_INLINE_CSK_PRESS, __LINE__);

    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return;
    }

    if (email_app_read.curr_item_id == MMI_EMAIL_READ_CONTENT_ITEM_ID && 
        email_app_read.curr_hilite_url_idx != -1)
    {
        if (email_app_read_url_action())
        {
            return;
        }
    }

    if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        if (mmi_wcslen(email_app_read.from_addr.email_addr))
        {
            mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));

            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_REPLY_START);

            memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
            comp_data->acct_id = email_app_read.acct_id;
            comp_data->fldr_id = email_app_read.fldr_id;
            comp_data->msg_id = email_app_read.msg_id;
            comp_data->parent_id = email_app_read.grp_id;
            comp_data->is_close_parent = TRUE;
            comp_data->type = EMAIL_PRE_COMP_TYPE_REPLY;
            mmi_email_reset_curr_comp_info();
            mmi_email_prepare_entry_comp(comp_data);
            OslMfree(comp_data);
        }
        else
        {
            mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));

            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_FORWARD_START);
            memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
            comp_data->acct_id = email_app_read.acct_id;
            comp_data->fldr_id = email_app_read.fldr_id;
            comp_data->msg_id = email_app_read.msg_id;
            comp_data->parent_id = email_app_read.grp_id;
            comp_data->is_close_parent = TRUE;
            comp_data->type = EMAIL_PRE_COMP_TYPE_FORWARD;
            mmi_email_reset_curr_comp_info();
            mmi_email_prepare_entry_comp(comp_data);
            OslMfree(comp_data);
        }
    }
    else if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_DRAFT)
    {
        mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
        memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
        comp_data->acct_id = email_app_read.acct_id;
        comp_data->fldr_id = email_app_read.fldr_id;
        comp_data->msg_id = email_app_read.msg_id;
        comp_data->parent_id = email_app_read.parent_id;
        comp_data->is_close_parent = FALSE;
        comp_data->type = EMAIL_PRE_COMP_TYPE_EDIT;
        mmi_email_reset_curr_comp_info();
        mmi_email_prepare_entry_comp(comp_data);
        OslMfree(comp_data);
        mmi_frm_group_close(email_app_read.grp_id);
    }
    else if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_OUTBOX)
    {
        mmi_email_util_display_confirm(
            email_app_read.grp_id,
            mmi_email_read_delete_msg,
            mmi_frm_scrn_close_active_id,
            NULL,
            FALSE,
            GetString(STR_EMAIL_DEL_SEL_MAIL_ID),
            MMI_EVENT_QUERY);
    }
    else
    {
        mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));

        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_FORWARD_START);

        memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
        comp_data->acct_id = email_app_read.acct_id;
        comp_data->fldr_id = email_app_read.fldr_id;
        comp_data->msg_id = email_app_read.msg_id;
        comp_data->parent_id = email_app_read.grp_id;
        comp_data->is_close_parent = TRUE;
        comp_data->type = EMAIL_PRE_COMP_TYPE_FORWARD;
        mmi_email_reset_curr_comp_info();
        mmi_email_prepare_entry_comp(comp_data);
        OslMfree(comp_data);
    }
}


void mmi_email_read_delete_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_MSG_HANDLE msg_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    MMI_BOOL del_header = MMI_FALSE, del_server = MMI_TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_DELETE_MSG, __LINE__);

    if (email_read_msg_not_exist)
    {
        return;
    }

    result = srv_email_msg_create(0, &msg_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
        return;
    }
    result = srv_email_msg_open(msg_handle, email_app_read.acct_id, email_app_read.fldr_id, email_app_read.msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
        srv_email_msg_destroy(msg_handle);
        return;
    }
    if (email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_DRAFT ||
        email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_OUTBOX ||
        email_app_read.folder_type == SRV_EMAIL_FLDR_TYPE_SENT)
    {
        del_header = MMI_TRUE;
    }
    result = srv_email_msg_delete(msg_handle, del_header, del_server);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id, result);
    }

    srv_email_msg_destroy(msg_handle);
    mmi_frm_group_close(email_app_read.grp_id);
}


void mmi_email_read_move_to_drafts(EMAIL_MSG_ID msg_id, EMAIL_ACCT_ID acct_id, EMAIL_FLDR_ID fldr_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_MSG_HANDLE msg_handle = 0;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    S32 folder_id_num = 4;
    EMAIL_FLDR_ID fldr_id_array[4] = {0};
    EMAIL_MSG_ID new_msg_id = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_MOVE_TO_DRAFTS, __LINE__);

    cui_menu_close(email_app_read.option_grp_id);
    result = srv_email_msg_create(0, &msg_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id,result);
        return;
    }
    result = srv_email_msg_open(msg_handle, acct_id, fldr_id, msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        return;
    }
    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        return;
    }
    result = srv_email_acct_open(acct_handle, acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        srv_email_acct_destroy(acct_handle);
        return;
    }
    result = srv_email_acct_get_fldr_id(
                acct_handle,
                SRV_EMAIL_ACCT_FLDR_TYPE_BASIC,
                0,
                &folder_id_num,
                fldr_id_array);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        srv_email_acct_destroy(acct_handle);
        return;
    }
    result = srv_email_msg_move(msg_handle, acct_id, fldr_id_array[SRV_EMAIL_FLDR_TYPE_DRAFT], &new_msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_read.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        srv_email_acct_destroy(acct_handle);
        return;
    }
    //mmi_email_lib_succ_popup(STR_EMAIL_COMMON_SAVE_TO_DRAFT_ID);
    srv_email_msg_destroy(msg_handle);
    srv_email_acct_destroy(acct_handle);
    mmi_frm_group_close(email_app_read.grp_id);
}


void mmi_email_read_goto_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    BOOL is_empty = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_GOTO_ADDR, __LINE__);

    switch (email_app_read.curr_item_id)
    {
        case MMI_EMAIL_READ_FROM_ITEM_ID:
            if (!mmi_wcslen(email_app_read.from_addr.email_addr))
            {
                is_empty = TRUE;
            }
            break;
        case MMI_EMAIL_READ_TO_ITEM_ID:
            if (!email_app_read.to_num)
            {
                is_empty = TRUE;
            }
            break;
        case MMI_EMAIL_READ_CC_ITEM_ID:
            if (!email_app_read.cc_num)
            {
                is_empty = TRUE;
            }
            break;
#ifdef __MMI_EMAIL_BCC__
        case MMI_EMAIL_READ_BCC_ITEM_ID:
            if (!email_app_read.bcc_num)
            {
                is_empty = TRUE;
            }
            break;
#endif /*__MMI_EMAIL_BCC__*/
    }
    if (is_empty)
    {
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
    }
    else
    {
        email_app_read.addr_grp_id = mmi_frm_group_create(
                                        email_app_read.grp_id,
                                        GRP_ID_AUTO_GEN,
                                        mmi_email_read_addr_opt_proc,
                                        NULL);
        mmi_frm_group_enter(email_app_read.addr_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
        email_app_read.curr_hilit_addr_index = 0;
        mmi_email_entry_read_addr();
    }
}


static mmi_ret mmi_email_read_addr_opt_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(email_app_read.addr_grp_id);
            break;

#ifndef __MMI_PHB_OPTIONAL_FIELD__
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_READ_ADDR_SAVE_PHB, TRUE);
            break;
#endif /* #ifndef __MMI_PHB_OPTIONAL_FIELD__ */

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_email_read_addr_options_handler(menu_evt->highlighted_menu_id);
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;

        case EVT_ID_PHB_SAVE_CONTACT:
        case EVT_ID_PHB_SAVE_CONTACT_CANCEL:
            {
                cui_phb_save_contact_result_struct *phb_data = (cui_phb_save_contact_result_struct*)evt;
                cui_phb_save_contact_close(phb_data->sender_id);
                email_app_read.phb_cui_id = 0;
            }
            break;
    }
    return MMI_RET_OK;
}


void mmi_email_entry_read_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 num_items;
    U8 *str_main_list[MMI_EMAIL_MAX_ADDR_NUM];
    U8 *str_popup_list[MMI_EMAIL_MAX_ADDR_NUM];
    U8 *gui_buffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_ADDR, 1);
    if (!mmi_frm_scrn_enter(
            email_app_read.addr_grp_id,
            SCR_ID_EMAIL_READ_ADDR,
            NULL,
            mmi_email_entry_read_addr,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_ADDR, 2);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    num_items = mmi_email_read_get_addr_list(str_main_list, str_popup_list);
    RegisterHighlightHandler(mmi_email_hilite_read_addr_item);
    EnableCenterSoftkey(0, IMG_GLOBAL_SAVE_CSK);
    ShowCategory53Screen(
        STR_EMAIL_ADDRESS_LIST_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OPTIONS,
        IMG_GLOBAL_OPTIONS,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        num_items,
        str_main_list,
        (U16*)gIndexIconsImageList,
        str_popup_list,
        0,
        email_app_read.curr_hilit_addr_index,
        gui_buffer);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_read_addr_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

    SetLeftSoftkeyFunction(mmi_email_entry_read_addr_opt, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);

#ifdef __MMI_PHB_OPTIONAL_FIELD__
    SetCenterSoftkeyFunction(mmi_email_read_addr_save, KEY_EVENT_UP);
#else
    SetCenterSoftkeyFunction(mmi_email_read_addr_send, KEY_EVENT_UP);
#endif

    mmi_frm_scrn_set_leave_proc(
        email_app_read.addr_grp_id,
        SCR_ID_EMAIL_READ_ADDR,
        mmi_email_read_addr_del_callback);
}


mmi_ret mmi_email_read_addr_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ADDR_DEL_CALLBACK, __LINE__);

    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
            if (email_app_read.phb_cui_id && mmi_frm_group_is_present(email_app_read.phb_cui_id))
            {
                cui_phb_save_contact_close(email_app_read.phb_cui_id);
                email_app_read.phb_cui_id = 0;
            }
            break;
    }
    return MMI_RET_OK;
}


void mmi_email_hilite_read_addr_item(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_app_read.curr_hilit_addr_index = index;
}


U16 mmi_email_read_get_addr_list(U8 **str_main_list, U8 **str_popup_list)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (email_app_read.curr_item_id)
    {
        case MMI_EMAIL_READ_FROM_ITEM_ID:
            str_main_list[0] = (U8*)email_app_read.from_addr.email_addr;
            if (email_app_read.from_addr.disp_name_len)
            {
                str_popup_list[0] = (U8*)email_app_read.from_addr.disp_name;
            }
            else
            {
                str_popup_list[0] = NULL;
            }
            return 1;
        case MMI_EMAIL_READ_TO_ITEM_ID:
            for (; index < email_app_read.to_num; index++)
            {
                str_main_list[index] = (U8*)email_app_read.addr_list[index].email_addr;
                if (email_app_read.addr_list[index].disp_name_len)
                {
                    str_popup_list[index] = (U8*)email_app_read.addr_list[index].disp_name;
                }
                else
                {
                    str_popup_list[index] = NULL;
                }
            }
            return email_app_read.to_num;
#ifdef __MMI_EMAIL_BCC__
        case MMI_EMAIL_READ_BCC_ITEM_ID:
            {
                S32 bcc_index = (S32)(email_app_read.to_num + email_app_read.cc_num);
                for (; index < email_app_read.bcc_num; index++)
                {
                    str_main_list[index] = (U8*)email_app_read.addr_list[bcc_index + index].email_addr;
                    if (email_app_read.addr_list[bcc_index + index].disp_name_len)
                    {
                        str_popup_list[index] = (U8*)email_app_read.addr_list[bcc_index + index].disp_name;
                    }
                    else
                    {
                        str_popup_list[index] = NULL;
                    }
                }
                return email_app_read.bcc_num;
            }
#endif /*__MMI_EMAIL_BCC__*/
        default:    /* case MMI_EMAIL_READ_CC_ITEM_ID:   */
            {
                S32 cc_index = (S32)email_app_read.to_num;
                for (; index < email_app_read.cc_num; index++)
                {
                    str_main_list[index] = (U8*)email_app_read.addr_list[cc_index + index].email_addr;
                    if (email_app_read.addr_list[cc_index + index].disp_name_len)
                    {
                        str_popup_list[index] = (U8*)email_app_read.addr_list[cc_index + index].disp_name;
                    }
                    else
                    {
                        str_popup_list[index] = NULL;
                    }
                }
                return email_app_read.cc_num;
            }
    }
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
void mmi_email_read_addr_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        mmi_email_read_addr_save();
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


void mmi_email_entry_read_addr_opt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id opt_grp_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    opt_grp_id = cui_menu_create(
                    email_app_read.addr_grp_id,
                    CUI_MENU_SRC_TYPE_RESOURCE,
                    CUI_MENU_TYPE_OPTION,
                    MENU_ID_EMAIL_READ_ADDR_OPT,
                    MMI_FALSE,
                    NULL);
    cui_menu_set_default_title(opt_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(opt_grp_id);
}


static mmi_ret mmi_email_read_addr_options_handler(mmi_menu_id menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return MMI_RET_OK;
    }

    switch (menu_id)
    {
        case MENU_ID_EMAIL_READ_ADDR_SAVE_PHB:
            mmi_email_read_addr_save();
            break;

        case MENU_ID_EMAIL_READ_ADDR_SEND:
            mmi_email_read_addr_send();
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


static void mmi_email_read_addr_save(void)
{
#ifdef __MMI_PHB_OPTIONAL_FIELD__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 *pMailAddr = NULL;
    U16 *pMailName = NULL;
    U32 index = 0;
    srv_email_addr_struct *addr_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (email_app_read.curr_item_id)
    {
        case MMI_EMAIL_READ_FROM_ITEM_ID:
            addr_ptr = &email_app_read.from_addr;
            break;
        case MMI_EMAIL_READ_TO_ITEM_ID:
            index = email_app_read.curr_hilit_addr_index;
            addr_ptr = &email_app_read.addr_list[index];
            break;
#ifdef __MMI_EMAIL_BCC__
        case MMI_EMAIL_READ_BCC_ITEM_ID:
            index = email_app_read.to_num + email_app_read.cc_num + email_app_read.curr_hilit_addr_index;
            addr_ptr = &email_app_read.addr_list[index];
            break;
#endif /* __MMI_EMAIL_BCC__ */
        default:    
            index = email_app_read.to_num + email_app_read.curr_hilit_addr_index;
            addr_ptr = &email_app_read.addr_list[index];
            break;
    }
    if (mmi_wcslen(addr_ptr->email_addr))
    {
        pMailAddr = (U16*)addr_ptr->email_addr;
    }
    if (addr_ptr->disp_name_len)
    {
        pMailName = (U16*)addr_ptr->disp_name;
    }
    email_app_read.phb_cui_id = cui_phb_save_contact_create(email_app_read.addr_grp_id);
    if (email_app_read.phb_cui_id != GRP_ID_INVALID)
    {
        cui_phb_save_contact_set_name(email_app_read.phb_cui_id, pMailName, NULL);
        cui_phb_save_contact_set_email(email_app_read.phb_cui_id, pMailAddr);
        //cui_phb_save_contact_set_storage(email_app_read.phb_cui_id, PHB_STORAGE_NVRAM);
        cui_phb_save_contact_run(email_app_read.phb_cui_id);
    }
    else
    {
        email_app_read.phb_cui_id = 0;
    }
#endif /* #ifdef __MMI_PHB_OPTIONAL_FIELD__ */
}


void mmi_email_read_addr_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
    WCHAR *temp_addr = NULL, *temp_name = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ADDR_SEND, __LINE__);

    mmi_email_read_recipient_get_sent_addr(&temp_addr, &temp_name);
    if (temp_addr)
    {
        if (!mmi_email_util_chk_addr(temp_addr))
        {
            mmi_email_lib_error_popup(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
            return;
        }
    }
    memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
    comp_data->acct_id = email_app_read.acct_id;
    comp_data->fldr_id = 0;
    comp_data->msg_id = 0;
    comp_data->parent_id = email_app_read.grp_id;
    comp_data->type = EMAIL_PRE_COMP_TYPE_ADDR_SEND;
    mmi_email_reset_curr_comp_info();
    mmi_email_prepare_entry_comp(comp_data);
    OslMfree(comp_data);
}


void mmi_email_read_recipient_get_sent_addr(WCHAR **mail_addr, WCHAR **mail_name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 index = 0;
    srv_email_addr_struct *addr_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    *mail_addr = NULL;
    *mail_name = NULL;
    switch (email_app_read.curr_item_id)
    {
        case MMI_EMAIL_READ_FROM_ITEM_ID:
            addr_ptr = &email_app_read.from_addr;
            break;
        case MMI_EMAIL_READ_TO_ITEM_ID:
            index = email_app_read.curr_hilit_addr_index;
            addr_ptr = &email_app_read.addr_list[index];
            break;
#ifdef __MMI_EMAIL_BCC__
        case MMI_EMAIL_READ_BCC_ITEM_ID:
            index = email_app_read.to_num + email_app_read.cc_num + email_app_read.curr_hilit_addr_index;
            addr_ptr = &email_app_read.addr_list[index];
            break;
#endif /* __MMI_EMAIL_BCC__ */
        default:    
            index = email_app_read.to_num + email_app_read.curr_hilit_addr_index;
            addr_ptr = &email_app_read.addr_list[index];
            break;
    }
    if (mmi_wcslen(addr_ptr->email_addr))
    {
        *mail_addr = addr_ptr->email_addr;
    }
    if (addr_ptr->disp_name_len)
    {
        *mail_name = addr_ptr->disp_name;
    }
}


static void mmi_email_read_init_attach_info(mmi_id grp_id, EMAIL_MSG_HANDLE msg_handle)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_attach_struct *attach_info = NULL;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    S32 get_num = 1;
    U32 index = 0;
    WCHAR *file_path = NULL;
    filetypes_group_type_enum file_type;
    S32 total_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!email_app_read.att_num)
    {
        return;
    }
    attach_info = OslMalloc(sizeof(srv_email_attach_struct));
    file_path = OslMalloc(sizeof(WCHAR) * (SRV_FMGR_PATH_MAX_LEN + 1));
    memset(attach_info, 0, sizeof(srv_email_attach_struct));
    memset(file_path, 0, sizeof(WCHAR) * (SRV_FMGR_PATH_MAX_LEN + 1));
    memset(email_app_read.attach_display, 0, sizeof(email_app_read.attach_display));
    for (; index < email_app_read.att_num; index++)
    {
        result = srv_email_msg_get_attachment_info(
            msg_handle,
            index,
            &get_num,
            attach_info);
        if ((result != SRV_EMAIL_RESULT_SUCC) || !get_num)
        {
            mmi_email_util_display_error_popup(grp_id, result);
            OslMfree(attach_info);
            OslMfree(file_path);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        mmi_wcscpy(attach_info_array[index].attach_name, attach_info->name);
        mmi_wcscpy(attach_info_array[index].path, attach_info->path);
        memcpy(&attach_info_array[index].cid, &attach_info->cid, sizeof(CHAR) * (SRV_EMAIL_CID_MAX_LEN + 1));
        attach_info_array[index].attach_id = attach_info->attach_id;
        attach_info_array[index].drm_object = attach_info->drm_object;
        attach_info_array[index].downloaded = attach_info->downloaded;
        kal_wsprintf(
            attach_info_array[index].attach_size_str,
            "%d%w",
            ((attach_info->size + 1023) / 1024),
            g_email_kilobyte);
        result = srv_email_msg_get_attachment_path(
            msg_handle,
            attach_info->attach_id,
            file_path,
            SRV_FMGR_PATH_MAX_LEN);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(grp_id, result);
            OslMfree(attach_info);
            OslMfree(file_path);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        file_type = srv_fmgr_types_find_group_by_filename_str(file_path);
        attach_info_array[index].file_type = file_type;
        total_size += attach_info->size;
    }
    OslMfree(attach_info);
    OslMfree(file_path);
    if (email_app_read.att_num == 1)
    {
        WCHAR size_str[10];
        S32 size_str_len = 0;
        S32 name_len = 0;
        kal_wsprintf(size_str, " %dKB", (total_size + 1023) / 1024);
        size_str_len = mmi_wcslen(size_str);
        name_len = mmi_wcslen(attach_info_array[0].attach_name);
        if (name_len > MMI_EMAIL_MAX_ATT_DISP_LEN - size_str_len)
        {
            mmi_wcsncpy(
                email_app_read.attach_display,
                attach_info_array[0].attach_name,
                MMI_EMAIL_MAX_ATT_DISP_LEN - size_str_len - 2);
            mmi_wcscat(email_app_read.attach_display, g_email_2dots);
            mmi_wcscat(email_app_read.attach_display, size_str);
        }
        else
        {
            kal_wsprintf(
                email_app_read.attach_display,
                "%w%w",
                attach_info_array[0].attach_name,
                size_str);
        }
    }
    else
    {
        kal_wsprintf(
            email_app_read.attach_display,
            "%w%w%d%w %dKB",
            (WCHAR*)GetString(STR_EMAIL_ATTACHMENT_ID),
            (WCHAR*)GetString(STR_EMAIL_LEFT_PARENTHESIS_ID),
            email_app_read.att_num,
            (WCHAR*)GetString(STR_EMAIL_RIGHT_PARENTHESIS_ID),
            ((total_size + 1023) / 1024));
    }
}


void mmi_email_read_attach(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ATTACH, 1);
    email_app_read.attach_grp_id = mmi_frm_group_create(
        email_app_read.grp_id,
        GRP_ID_AUTO_GEN,
        mmi_email_read_attach_opt_proc,
        NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ATTACH, 2);
    mmi_frm_group_enter(email_app_read.attach_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ATTACH, 3);
    email_app_read.curr_hilit_attach_index = 0;
    mmi_email_entry_read_attach();
}


static mmi_ret mmi_email_read_attach_opt_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(email_app_read.attach_grp_id);
            break;

        case EVT_ID_CUI_MENU_LIST_ENTRY:
            mmi_email_read_attach_hide_menu(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_email_read_attach_options_handler(menu_evt->highlighted_menu_id);
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_FOLDER_SELECTOR_RESULT:
            mmi_email_read_save_attach_select_path_done((void*)evt);
            break;

        case EVT_ID_CUI_FILENAME_EDITOR_RESULT:
            mmi_email_read_save_attach_input_done((void*)evt);
            break;

#ifdef __MMI_IMAGE_VIEWER__
        case EVT_ID_IMGVIEW_CLOSE_GID:
            {
                cui_imgview_close(email_app_read.viewer_cui_id);
                email_app_read.viewer_cui_id = 0;
            }
            break;
#endif /* __MMI_IMAGE_VIEWER__ */

    default:
        break;
    }
    return MMI_RET_OK;
}


void mmi_email_read_save_attach_select_path_done(void *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_folder_selector_result_event_struct *data =
        (cui_folder_selector_result_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_SAVE_ATTACH_SELECT_PATH_DONE, __LINE__);

    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return;
    }

    if (data->result > 0)
    {
        data->result = cui_folder_selector_get_selected_filepath(
                        data->sender_id,
                        NULL,
                        (WCHAR*)selected_file_path,
                        (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        if (data->result == 0)
        {
            mmi_email_read_pre_entry_save_attach();
        }
    }

    if (data->result < 0)
    {
        mmi_email_util_display_popup(
            email_app_read.attach_grp_id,
            GetString((U16)srv_fmgr_fs_error_get_string(data->result)),
            MMI_EVENT_FAILURE);
    }
    cui_folder_selector_close(email_app_read.fmgr_cui_id);
    email_app_read.fmgr_cui_id = 0;
}


void mmi_email_read_save_attach_input_done(void *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_filename_editor_result_event_struct *data =
        (cui_filename_editor_result_event_struct*)evt;
    WCHAR *src_file_path = NULL;
    WCHAR *dst_file_path = NULL;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    EMAIL_MSG_HANDLE msg_handle = 0;
    srv_email_attach_struct *attach_info = NULL;
    S32 get_num = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_SAVE_ATTACH_INPUT_DONE, __LINE__);

    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_SAVE_ATTACH_INPUT_DONE, -1);
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return;
    }

    if (data->result > 0)
    {
        result = srv_email_msg_create(0, &msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(email_app_read.attach_grp_id, result);
            cui_filename_editor_close(email_app_read.fseditor_id);
            email_app_read.fseditor_id = 0;
            return;
        }
        result = srv_email_msg_open(
                    msg_handle,
                    email_app_read.acct_id,
                    email_app_read.fldr_id,
                    email_app_read.msg_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_msg_destroy(msg_handle);
            mmi_email_util_display_error_popup(email_app_read.attach_grp_id, result);
            cui_filename_editor_close(email_app_read.fseditor_id);
            email_app_read.fseditor_id = 0;
            return;
        }
        attach_info = OslMalloc(sizeof(srv_email_attach_struct));
        src_file_path = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        memset(attach_info, 0, sizeof(srv_email_attach_struct));
        memset(src_file_path, 0, (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        result = srv_email_msg_get_attachment_info(
                    msg_handle,
                    email_app_read.curr_hilit_attach_index,
                    &get_num,
                    attach_info);
        if ((result != SRV_EMAIL_RESULT_SUCC) || !get_num)
        {
            mmi_email_util_display_error_popup(email_app_read.attach_grp_id, result);
            OslMfree(attach_info);
            srv_email_msg_destroy(msg_handle);
            cui_filename_editor_close(email_app_read.fseditor_id);
            email_app_read.fseditor_id = 0;
            return;
        }
        result = srv_email_msg_get_attachment_path(
                    msg_handle,
                    attach_info->attach_id,
                    src_file_path,
                    SRV_FMGR_PATH_MAX_LEN);
        OslMfree(attach_info);
        srv_email_msg_destroy(msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(email_app_read.attach_grp_id, result);
            OslMfree(src_file_path);
            cui_filename_editor_close(email_app_read.fseditor_id);
            email_app_read.fseditor_id = 0;
            return;
        }
        dst_file_path = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        if (cui_filename_editor_get_fullpath(
                data->sender_id,
                dst_file_path,
                (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR)) == 0)
        {
            email_app_read.attach_save_job_id =
                srv_fmgr_async_copy(
                    src_file_path,
                    dst_file_path,
                    0,
                    mmi_email_read_attch_copy_callback,
                    NULL);
            if (email_app_read.attach_save_job_id > 0)
            {
                mmi_email_read_save_attach_loading();
            }
        }
        else
        {
            cui_filename_editor_close(email_app_read.fseditor_id);
            email_app_read.fseditor_id = 0;
        }
        OslMfree(src_file_path);
        OslMfree(dst_file_path);
    }
    else if (data->result < 0)
    {
        mmi_email_util_display_popup(
            email_app_read.attach_grp_id,
            GetString((U16)srv_fmgr_fs_error_get_string(data->result)),
            MMI_EVENT_FAILURE);
    }
    else
    {
        cui_filename_editor_close(email_app_read.fseditor_id);
        email_app_read.fseditor_id = 0;
    }
}


void mmi_email_read_save_attach_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_frm_scrn_enter(
            email_app_read.attach_grp_id,
            SCR_ID_EMAIL_READ_ATTCH_SAVE,
            NULL,
            mmi_email_read_save_attach_loading,
            MMI_FRM_FULL_SCRN))
    {
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_SAVING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    mmi_frm_scrn_set_leave_proc(
        email_app_read.attach_grp_id,
        SCR_ID_EMAIL_READ_ATTCH_SAVE,
        mmi_email_read_attach_save_del_callback);
}


mmi_ret mmi_email_read_attach_save_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ATTACH_SAVE_DEL_CALLBACK, __LINE__);

    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
            if (email_app_read.attach_save_job_id)
            {
                srv_fmgr_async_abort(
                    email_app_read.attach_save_job_id,
                    MMI_TRUE);
            }
            email_app_read.attach_save_job_id = 0;
            break;
    }
    return MMI_RET_OK;
}


static mmi_ret mmi_email_read_attch_copy_callback(mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_fmgr_async_done_event_struct *async_evt;
    BOOL is_exit = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ATTCH_COPY_CALLBACK, __LINE__);

    switch (param->evt_id)
    {
        case EVT_ID_SRV_FMGR_ASYNC_DONE:
            {
                async_evt = (srv_fmgr_async_done_event_struct*)param;
                if (mmi_frm_scrn_get_active_id() != SCR_ID_EMAIL_READ_ATTCH_SAVE)
                {
                    if (!mmi_frm_group_is_present(email_app_read.attach_grp_id))
                    {
                        is_exit = TRUE;
                    }
                }
                if (!is_exit)
                {
                    if (async_evt->result == 0 || async_evt->result == FS_DISK_FULL)
                    {
                        cui_filename_editor_close(email_app_read.fseditor_id);
                        email_app_read.fseditor_id = 0;
                    }

                    if (async_evt->result != 0)
                    {
                        mmi_email_util_display_popup(
                            email_app_read.attach_grp_id,
                            GetString((U16)srv_fmgr_fs_error_get_string(async_evt->result)),
                            MMI_EVENT_FAILURE);
                    }

                }
                email_app_read.attach_save_job_id = 0;
                mmi_frm_scrn_close(email_app_read.attach_grp_id, SCR_ID_EMAIL_READ_ATTCH_SAVE);
            }
            break;
    }
    return MMI_RET_OK;
}


void mmi_email_entry_read_attach(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 num_items = email_app_read.att_num;
    U8 *str_main_list[MMI_EMAIL_MAX_ATTACH_NUMBER];
    U8 *str_popup_list[MMI_EMAIL_MAX_ATTACH_NUMBER];
    U8 *gui_buffer;
    U32 index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_ATTACH, 1);
    if (!mmi_frm_scrn_enter(
            email_app_read.attach_grp_id,
            SCR_ID_EMAIL_READ_ATTCH,
            NULL,
            mmi_email_entry_read_attach,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_ATTACH, 2);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    for (; index < email_app_read.att_num; index++)
    {
        str_main_list[index] = (U8*)attach_info_array[index].attach_name;
        str_popup_list[index] = (U8*)attach_info_array[index].attach_size_str;
    }
    RegisterHighlightHandler(mmi_email_hilite_read_attach_item);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    ShowCategory53Screen(
        STR_EMAIL_ATTACHMENT_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OPTIONS,
        IMG_GLOBAL_OPTIONS,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        num_items,
        str_main_list,
        (U16*)gIndexIconsImageList,
        str_popup_list,
        0,
        email_app_read.curr_hilit_attach_index,
        gui_buffer);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_read_attach_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
    mmi_frm_scrn_set_leave_proc(
        email_app_read.attach_grp_id,
        SCR_ID_EMAIL_READ_ATTCH,
        mmi_email_read_attach_del_callback);
}


mmi_ret mmi_email_read_attach_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ATTACH_DEL_CALLBACK, __LINE__);

    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
#ifdef __MMI_IMAGE_VIEWER__
            if (email_app_read.viewer_cui_id && mmi_frm_group_is_present(email_app_read.viewer_cui_id))
            {
                cui_imgview_close(email_app_read.viewer_cui_id);
                email_app_read.viewer_cui_id = 0;
            }
#endif /* __MMI_IMAGE_VIEWER__ */
            if (email_app_read.fmgr_cui_id && mmi_frm_group_is_present(email_app_read.fmgr_cui_id))
            {
                cui_folder_selector_close(email_app_read.fmgr_cui_id);
                email_app_read.fmgr_cui_id = 0;
            }
            if (email_app_read.fseditor_id && mmi_frm_group_is_present(email_app_read.fseditor_id))
            {
                cui_filename_editor_close(email_app_read.fseditor_id);
                email_app_read.fseditor_id = 0;
            }
            break;
    }
    return MMI_RET_OK;
}


void mmi_email_hilite_read_attach_item(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_HILITE_READ_ATTACH_ITEM, __LINE__);

    email_app_read.curr_hilit_attach_index = index;
    if (!attach_info_array[index].downloaded)
    {
        ChangeLeftSoftkey(STR_GLOBAL_DOWNLOAD, IMG_GLOBAL_OK);
        SetLeftSoftkeyFunction(mmi_email_read_attach_download, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_email_read_attach_download, KEY_EVENT_UP);
        return;
    }

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[index].attach_name);
    if (
#ifdef __MMI_IMAGE_VIEWER__
        (fmgr_type == FMGR_GROUP_IMAGE) ||
#endif /* __MMI_IMAGE_VIEWER__ */
        (fmgr_type == FMGR_GROUP_AUDIO) ||
        (fmgr_type == FMGR_GROUP_VIDEO)
        )
    {
        ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, IMG_GLOBAL_OPTIONS);
        SetLeftSoftkeyFunction(mmi_email_entry_read_attach_opt, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_email_entry_read_attach_view, KEY_EVENT_UP);

    }
    else
    {

        ChangeLeftSoftkey(STR_GLOBAL_SAVE, IMG_GLOBAL_OK);
        SetLeftSoftkeyFunction(mmi_email_read_attach_save, KEY_EVENT_UP);
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_email_read_attach_save, KEY_EVENT_UP);
    }
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
void mmi_email_read_attach_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_ATTACH_TAP_CALLBACK, __LINE__);

    if (!attach_info_array[index].downloaded)
    {
        U16 index = email_app_read.curr_hilit_attach_index;
        mmi_email_read_pf_pre_download(
            email_app_read.grp_id,
            attach_info_array[index].attach_id,
            SRV_EMAIL_RETRIEVE_SINGLE_ATTACHMENT);
        mmi_email_read_pf_download();
        return;
    }

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[index].attach_name);
    if (
#ifdef __MMI_IMAGE_VIEWER__
        (fmgr_type == FMGR_GROUP_IMAGE) ||
#endif /* __MMI_IMAGE_VIEWER__ */
        (fmgr_type == FMGR_GROUP_AUDIO) ||
        (fmgr_type == FMGR_GROUP_VIDEO))
    {
        if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
        {
            mmi_email_entry_read_attach_view();
        }
    }
    else
    {
        if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
        {
            mmi_email_read_attach_save();
        }
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


void mmi_email_entry_read_attach_opt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id opt_grp_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    opt_grp_id = cui_menu_create(
                    email_app_read.attach_grp_id,
                    CUI_MENU_SRC_TYPE_RESOURCE,
                    CUI_MENU_TYPE_OPTION,
                    MENU_ID_EMAIL_READ_ATTACH_OPT,
                    MMI_FALSE,
                    NULL);
    cui_menu_set_default_title(opt_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(opt_grp_id);
}


void mmi_email_read_attach_hide_menu(mmi_id menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (attach_info_array[email_app_read.curr_hilit_attach_index].downloaded)
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_DOWN, MMI_TRUE);
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_VIEW, MMI_FALSE);
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_SAVE, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_DOWN, MMI_FALSE);
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_VIEW, MMI_TRUE);
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_SAVE, MMI_TRUE);
        return;
    }
    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[email_app_read.curr_hilit_attach_index].attach_name);
    if (
#ifdef __MMI_IMAGE_VIEWER__
        (fmgr_type == FMGR_GROUP_IMAGE) || 
#endif /* __MMI_IMAGE_VIEWER__ */
        (fmgr_type == FMGR_GROUP_AUDIO) || 
        (fmgr_type == FMGR_GROUP_VIDEO)
        )
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_VIEW, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_READ_ATT_VIEW, MMI_TRUE);
    }
}


static mmi_ret mmi_email_read_attach_options_handler(mmi_menu_id menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return MMI_RET_OK;
    }

    switch (menu_id)
    {
        case MENU_ID_EMAIL_READ_ATT_VIEW:
            mmi_email_entry_read_attach_view();
            break;

        case MENU_ID_EMAIL_READ_ATT_SAVE:
            mmi_email_read_attach_save();
            break;

        case MENU_ID_EMAIL_READ_ATT_DOWN:
            {
                mmi_email_read_attach_download();
            }
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}

void mmi_email_read_attach_download(void)
{
    U16 index = email_app_read.curr_hilit_attach_index;
    mmi_email_read_pf_pre_download(
        email_app_read.grp_id,
        attach_info_array[index].attach_id,
        SRV_EMAIL_RETRIEVE_SINGLE_ATTACHMENT);
    mmi_email_read_pf_download();
}


void mmi_email_read_attach_save(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return;
    }

    email_app_read.fmgr_cui_id = cui_folder_selector_create(
                                    email_app_read.attach_grp_id,
                                    (WCHAR*)L"root",
                                    CUI_FOLDER_SELECTOR_STYLE_WRITE,
                                    0);
    cui_folder_selector_run(email_app_read.fmgr_cui_id);
}


void mmi_email_read_pre_entry_save_attach(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR *name_ext_ptr = NULL;
    S32 name_ext_len = 0, name_len = 0, edit_len = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_PRE_ENTRY_SAVE_ATTACH, __LINE__);

    name_ext_ptr = mmi_email_get_file_ext(attach_info_array[email_app_read.curr_hilit_attach_index].attach_name);
    if (name_ext_ptr != NULL)
    {
        name_ext_len = mmi_wcslen(name_ext_ptr);
        name_len = mmi_wcslen(attach_info_array[email_app_read.curr_hilit_attach_index].attach_name);
        mmi_wcsncpy(save_attach_name, attach_info_array[email_app_read.curr_hilit_attach_index].attach_name, name_len - name_ext_len);
        edit_len = EMAIL_ATTCH_FILE_NAME_LEN/* - name_ext_len*/;
    }
    else
    {
        mmi_wcscpy(save_attach_name, attach_info_array[email_app_read.curr_hilit_attach_index].attach_name);
        edit_len = EMAIL_ATTCH_FILE_NAME_LEN;
    }
    email_app_read.fseditor_id = cui_filename_editor_create(
                                    email_app_read.attach_grp_id,
                                    save_attach_name,
                                    sizeof(save_attach_name),
                                    edit_len,
                                    selected_file_path,
                                    (name_ext_ptr + 1));
    cui_filename_editor_set_title(email_app_read.fseditor_id, STR_GLOBAL_FILENAME, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_filename_editor_run(email_app_read.fseditor_id);
}


void mmi_email_entry_read_attach_view(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = email_app_read.curr_hilit_attach_index;
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;
    WCHAR *file_ext = NULL;

#ifdef __DRM_SUPPORT__    
    U8 permission = DRM_PERMISSION_NONE;
    U8 method = DRM_METHOD_NONE;
    FS_HANDLE fileHandle;
#endif /* __DRM_SUPPORT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_ATTACH_VIEW, __LINE__);

    if (email_read_msg_not_exist || !mmi_email_check_msg_valid(email_app_read.msg_id))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_READ_ATTACH_VIEW, -1);
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        mmi_frm_group_close(email_app_read.grp_id);
        return;
    }

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[item_index].attach_name);

#ifdef __DRM_SUPPORT__
    if (attach_info_array[item_index].drm_object)
    {
        if (fmgr_type == FMGR_GROUP_AUDIO)
        {
            permission = DRM_PERMISSION_PLAY;
        }
        else if (fmgr_type == FMGR_GROUP_VIDEO)
        {
            permission = DRM_PERMISSION_PLAY;
        }
#ifdef __MMI_IMAGE_VIEWER__
        else if (fmgr_type == FMGR_GROUP_IMAGE)
        {
            permission = DRM_PERMISSION_DISPLAY;
        }
#endif /* __MMI_IMAGE_VIEWER__ */

        if ((fileHandle = DRM_open_file(
                            (UI_string_type)attach_info_array[item_index].path, 
                            FS_READ_ONLY | FS_OPEN_SHARED, 
                            permission)) >= FS_NO_ERROR)
        {
            if ((method = DRM_get_object_method(fileHandle, NULL)) != DRM_METHOD_NONE)
            {
                if (DRM_validate_permission(fileHandle, NULL, permission) == MMI_FALSE)
                {
                    if (method & DRM_METHOD_SEPARATE_DELIVERY)
                    {
                        U32 size = sizeof(rights_issuer);
                        /* request rights from server */
                        memset(rights_issuer, 0, sizeof(rights_issuer));
                        if (FS_NO_ERROR <= DRM_get_rights_issuer(fileHandle, rights_issuer, &size))
                        {
#ifdef BROWSER_SUPPORT
                            mmi_email_util_display_confirm(
                                email_app_read.attach_grp_id,
                                mmi_email_request_rights,
                                mmi_frm_scrn_close_active_id,
                                NULL,
                                TRUE,
                                GetString(STR_ID_RMGR_REQ_RIGHTS),
                                MMI_EVENT_QUERY);
#else
                                mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
#endif
                                DRM_close_file(fileHandle);
                                return;
                        }
                    }
                    mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
                    DRM_close_file(fileHandle);
                    return;
                }
            }
            DRM_close_file(fileHandle);
        }
        else
        {
            /* open file fail */
            mmi_email_util_display_popup(
                email_app_read.attach_grp_id,
                GetString(srv_fmgr_fs_error_get_string(fileHandle)),
                MMI_EVENT_FAILURE);
            return;
        }    
    }
#endif /* __DRM_SUPPORT__ */ 

    if (
#ifdef __MMI_IMAGE_VIEWER__
        fmgr_type == FMGR_GROUP_IMAGE ||
#endif /* __MMI_IMAGE_VIEWER__ */
        fmgr_type == FMGR_GROUP_AUDIO ||
        fmgr_type == FMGR_GROUP_VIDEO)
    {
        file_ext = mmi_email_get_file_ext(attach_info_array[item_index].attach_name);
        mmi_email_copy_file_to_view(
            email_app_read.attach_grp_id,
            attach_info_array[item_index].path,
            file_ext,
            mmi_email_read_copy_to_view_attach);
    }
}


void mmi_email_read_copy_to_view_attach(WCHAR *new_file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = email_app_read.curr_hilit_attach_index;
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_COPY_TO_VIEW_ATTACH, __LINE__);

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[item_index].attach_name);
    if (fmgr_type == FMGR_GROUP_AUDIO)
    {
        mmi_media_app_play_audio_with_title(
            (CHAR*)new_file_path,
            NULL,
            (U16)NULL,
            (CHAR*)attach_info_array[item_index].attach_name);
    }
    else if (fmgr_type == FMGR_GROUP_VIDEO)
    {
#ifdef __MMI_VIDEO_STREAM__  
        S32 type = 0;
        type = srv_fmgr_types_find_type_by_filepath(attach_info_array[item_index].attach_name);
        if (type == FMGR_TYPE_SDP)
        {
            mmi_media_app_play_stream_from_sdp_file_ext((CHAR*)new_file_path, FALSE,
                (CHAR*)attach_info_array[item_index].attach_name);
        }
        else if (type == FMGR_TYPE_RAM)
        {
            mmi_media_app_play_stream_from_ram_file((CHAR*)new_file_path, FALSE);
        }
        else /* other video type */
        {
            mmi_media_app_play_video_ext((CHAR*)new_file_path, FALSE,
                (CHAR*)attach_info_array[item_index].attach_name);
        }
#else
        mmi_media_app_play_video_ext((CHAR*)new_file_path, FALSE,
            (CHAR*)attach_info_array[item_index].attach_name);
#endif /* __MMI_VIDEO_STREAM__ */
    }
#ifdef __MMI_IMAGE_VIEWER__
    else if (fmgr_type == FMGR_GROUP_IMAGE)
    {
        if ((email_app_read.viewer_cui_id = cui_imgview_create(email_app_read.attach_grp_id)) != GRP_ID_INVALID)
        {
            cui_imgview_set_mode_filename(email_app_read.viewer_cui_id, (CHAR*)new_file_path);
            cui_imgview_set_app_id(email_app_read.viewer_cui_id, APP_IMAGEVIEWER);
            cui_imgview_set_title(email_app_read.viewer_cui_id, attach_info_array[item_index].attach_name, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
            cui_imgview_set_ui_direction(email_app_read.viewer_cui_id, CUI_IMGVIEW_UI_DIRECTION_VERTICAL);
            cui_imgview_set_display_cap(email_app_read.viewer_cui_id, CUI_IMGVIEW_CAP_ALL, MMI_FALSE);   
            cui_imgview_set_display_cap(email_app_read.viewer_cui_id, CUI_IMGVIEW_CAP_ZOOM, MMI_TRUE);   
            cui_imgview_set_display_cap(email_app_read.viewer_cui_id, CUI_IMGVIEW_CAP_IMG_ROTATE, MMI_TRUE);   
            cui_imgview_set_display_cap(email_app_read.viewer_cui_id, CUI_IMGVIEW_CAP_UI_ROTATE, MMI_TRUE);   
            cui_imgview_set_display_cap(email_app_read.viewer_cui_id, CUI_IMGVIEW_CAP_TITLE, MMI_TRUE);   
            cui_imgview_run(email_app_read.viewer_cui_id);
        }
    }
#endif /* __MMI_IMAGE_VIEWER__ */
}


#ifdef __MMI_BACKGROUND_CALL__
static mmi_ret mmi_email_ucm_call_back(mmi_event_struct *arg)
{
    return SRV_UCM_APP_EXIT_QUERY_RESULT_NO;
}
#endif

/*****************************************************************************
* FUNCTION
*  mmi_email_read_extract_addr_phone_call
* DESCRIPTION
*  Execute Read->Address Extract ->Number List -> Dial
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_read_extract_addr_phone_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    applib_address_node_struct *p = email_read_extract_addr_curr;
    mmi_ucm_make_call_para_struct make_call_para;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_ADDR_PHONE_CALL, __LINE__);

    if (p && p->data2)
    {
#ifdef __MMI_BACKGROUND_CALL__
        mmi_frm_cb_reg_event(EVT_ID_SRV_UCM_APP_EXIT_QUERY, mmi_email_ucm_call_back, NULL);
#endif

        mmi_ucm_init_call_para(&make_call_para);
        make_call_para.ucs2_num_uri = (U16*)p->data2;
        make_call_para.dial_type = SRV_UCM_CALL_TYPE_ALL;
        mmi_ucm_call_launch(0, &make_call_para);
    }
}


/*****************************************************************************
* FUNCTION
*  mmi_email_read_extract_addr_phone_save
* DESCRIPTION
*  Execute Read->Address Extract ->Number List -> Save to phb
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_read_extract_addr_phone_save(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    applib_address_node_struct *p = email_read_extract_addr_curr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_ADDR_PHONE_SAVE, __LINE__);

    if (p)
    {
        email_read_extract_phb_id = cui_phb_save_contact_create(email_app_read.grp_id);
        if (email_read_extract_phb_id != GRP_ID_INVALID)
        {
            cui_phb_save_contact_set_number(email_read_extract_phb_id, (U16*)p->data2);
            cui_phb_save_contact_run(email_read_extract_phb_id);
        }
        else
        {
            email_read_extract_phb_id = 0;
        }
    }
}


#define EMAIL_APP_SMS_LENGTH_MAX 60
/*****************************************************************************
* FUNCTION
*  mmi_email_read_extract_addr_phone_sms
* DESCRIPTION
*  Execute Read->Address Extract ->Number List -> Send SMS
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_read_extract_addr_phone_sms(void)
{
    mmi_sms_write_msg_para_struct para;
    applib_address_node_struct *p = email_read_extract_addr_curr;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_ADDR_PHONE_SMS, __LINE__);

    if (p && p->data2)
    {
        U8 i;
        static U8 num[EMAIL_APP_SMS_LENGTH_MAX];
        memset(&para, 0, sizeof(mmi_sms_write_msg_para_struct));

        for (i = 0; i < EMAIL_APP_SMS_LENGTH_MAX && p->data2[i] != 0; i++)
        {
            num[i] = (U8)(p->data2[i]);
        }
        num[i] = 0;

        para.ascii_addr = num;
        mmi_sms_write_msg_lanch(0, &para);
    }
}

static BOOL mmi_email_read_extract_addr_email_check(WCHAR* addr)
{
    if (addr == NULL || !mmi_email_util_chk_addr(addr) || mmi_wcslen(addr) > SRV_EMAIL_MAX_ADDR_LEN)
    {
        mmi_email_lib_error_popup(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
        return FALSE;
    }

    return TRUE;
}

/*****************************************************************************
* FUNCTION
*  mmi_email_read_extract_addr_email_save
* DESCRIPTION
*  Execute Read->Address Extract ->Email Address -> Save to phb
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_read_extract_addr_email_save(void)
{
#ifdef __MMI_PHB_OPTIONAL_FIELD__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    applib_address_node_struct *p = email_read_extract_addr_curr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_ADDR_EMAIL_SAVE, __LINE__);
    if (p)
    {
        if (!mmi_email_read_extract_addr_email_check((WCHAR*)p->data))
        {
            return;
        }

        email_read_extract_phb_id = cui_phb_save_contact_create(email_app_read.grp_id);
        if (email_read_extract_phb_id != GRP_ID_INVALID)
        {
            cui_phb_save_contact_set_email(email_read_extract_phb_id, (U16*)p->data);
            //cui_phb_save_contact_set_storage(email_read_extract_phb_id, PHB_STORAGE_NVRAM);
            cui_phb_save_contact_run(email_read_extract_phb_id);
        }
        else
        {
            email_read_extract_phb_id = 0;
        }
    }
#endif /* #ifdef __MMI_PHB_OPTIONAL_FIELD__ */
}


/*****************************************************************************
* FUNCTION
*  mmi_email_read_extract_addr_email_send
* DESCRIPTION
*  Execute Read->Address Extract ->Email Address -> Send email
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_read_extract_addr_email_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_prepare_comp_struct *comp_data = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_ADDR_EMAIL_SEND, __LINE__);

    if (email_read_extract_addr_curr == NULL || !mmi_email_read_extract_addr_email_check((WCHAR*)email_read_extract_addr_curr->data))
    {
        return;
    }
    comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));

    memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
    comp_data->acct_id = email_app_read.acct_id;
    comp_data->fldr_id = 0;
    comp_data->msg_id = 0;
    comp_data->parent_id = email_app_read.grp_id;
    comp_data->type = EMAIL_PRE_COMP_TYPE_EXTRACT;
    mmi_email_reset_curr_comp_info();
    mmi_email_prepare_entry_comp(comp_data);
    OslMfree(comp_data);
}


WCHAR *mmi_email_read_extract_get_sent_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    applib_address_node_struct *p = email_read_extract_addr_curr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_GET_SENT_ADDR, __LINE__);

    if (p && p->data)
    {
        return (WCHAR*)p->data;
    }
    else
    {
        return L"";
    }
}


/*****************************************************************************
* FUNCTION
*  mmi_email_read_extract_addr_url_goto
* DESCRIPTION
*  Execute Read->Address Extract ->URL address -> connect
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_read_extract_addr_url_goto(void)
{
#ifdef BROWSER_SUPPORT
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    applib_address_node_struct *p = email_read_extract_addr_curr;

    static WCHAR url[WAP_MAX_URL_LENGTH + 2];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_ADDR_URL_GOTO, __LINE__);
    if (p)
    {
        mmi_wcsncpy(url, (WCHAR*)p->data, WAP_MAX_URL_LENGTH + 1);
        url[WAP_MAX_URL_LENGTH] = 0;
        wap_start_browser(WAP_BROWSER_GOTO_URL, (const kal_uint8*)url);
    }
#endif /*BROWSER_SUPPORT*/
}


/*****************************************************************************
* FUNCTION
*  mmi_email_read_extract_addr_url_save
* DESCRIPTION
*  Execute Read->Address Extract ->URL address -> add to bookmark
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_read_extract_addr_url_save(void)
{
#ifdef BROWSER_SUPPORT
#ifdef __MMI_BRW_BKM_INTERFACE_SUPPORT__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    char *converted_data = NULL;
    applib_address_node_struct *p = email_read_extract_addr_curr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_READ_EXTRACT_ADDR_URL_SAVE, __LINE__);
    if (p)
    {
        converted_data = OslMalloc(2048);
        mmi_chset_convert(
            MMI_CHSET_UCS2,
            (mmi_chset_enum)MMI_CHSET_UTF8,
            (char*)p->data,
            (char*)converted_data,
            2048);
        email_read_extract_bmk_id = cui_bkm_add_bkm_create(email_app_read.grp_id);
        cui_bkm_add_bkm_run(email_read_extract_bmk_id, (const U8*)converted_data);
        OslMfree(converted_data);
    }
#endif /* __MMI_BRW_BKM_INTERFACE_SUPPORT__ */
#endif /*BROWSER_SUPPORT*/
}


static void email_app_read_extract_free_list(void)
{
    applib_address_node_struct *p = email_read_extract_addr_list;
    applib_address_node_struct *node = NULL;
    
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_EMAIL_APP_READ_EXTRACT_FREE_LIST, __LINE__);

    while (p != NULL) 
    {
        node = p->next;
        if (p->data)
        {
            mmi_email_extract_free(p->data);
        }
        if (p->data2)
        {
            mmi_email_extract_free(p->data2);
        }
        mmi_email_extract_free(p);
        p = node;
    }

    if (email_read_extract_phb_id)
    {
        cui_phb_save_contact_close(email_read_extract_phb_id);
        email_read_extract_phb_id = 0;
    }

#ifdef BROWSER_SUPPORT
    if (email_read_extract_bmk_id)
    {
        cui_bkm_add_bkm_close(email_read_extract_bmk_id);
        email_read_extract_bmk_id = 0;
    }
#endif /* BROWSER_SUPPORT */

    email_read_extract_addr_list = NULL;
    email_read_extract_addr_curr = NULL;
}

#endif /* __MMI_EMAIL__ */



